// ==UserScript==
// @name          King Translator AI
// @namespace     https://kingsmanvn.pages.dev
// @version       5.4
// @author        King1x32
// @icon          https://raw.githubusercontent.com/king1x32/King-Translator-AI/refs/heads/main/icon/kings.jpg
// @license       GPL3
// @match         *://*/*
// @match         file:///*
// @inject-into   auto
// @grant         GM_xmlhttpRequest
// @grant         GM_addStyle
// @grant         GM_getValue
// @grant         GM_setValue
// @grant         GM_registerMenuCommand
// @grant         unsafeWindow
// @grant         GM_addElement
// @grant         GM_notification
// @grant         GM_setClipboard
// @grant         window.close
// @grant         window.focus
// @grant         window.onurlchange
// @connect       generativelanguage.googleapis.com
// @connect       api.perplexity.ai
// @connect       api.anthropic.com
// @connect       api.openai.com
// @connect       api.mistral.ai
// @connect       api.deepseek.com
// @connect       raw.githubusercontent.com
// @connect       translate.googleapis.com
// @connect       cdnjs.cloudflare.com
// @connect       translate.google.com
// @connect       texttospeech.googleapis.com
// @connect       github.com
// @connect       fonts.googleapis.com
// @require       https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js
// @require       https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js
// @require       https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js
// @require       https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js
// @homepageURL   https://github.com/king1x32/King-Translator-AI
// @downloadURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/KingTranslatorAI.user.js
// @updateURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/KingTranslatorAI.meta.js
// ==/UserScript==
!function(){"use strict";function t(t){try{return localStorage.getItem(t)}catch(e){return console.warn(`King Translator: Could not access localStorage.getItem for key "${t}". Reason:`,e.message),null}}function e(t,e){try{localStorage.setItem(t,e)}catch(e){console.warn(`King Translator: Could not access localStorage.setItem for key "${t}". Reason:`,e.message)}}function n(t){try{localStorage.removeItem(t)}catch(e){console.warn(`King Translator: Could not access localStorage.removeItem for key "${t}". Reason:`,e.message)}}function a(t){const e=t.trim();try{const t=document.createElement("template");if(t.innerHTML=e,t.content.firstChild)return t.content.firstChild}catch(t){}try{const t=`<svg xmlns="http://www.w3.org/2000/svg"><foreignObject width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml">${e}</div></foreignObject></svg>`,n=(new DOMParser).parseFromString(t,"image/svg+xml").querySelector("foreignObject");if(n&&n.firstChild&&n.firstChild.firstChild)return n.firstChild.firstChild}catch(t){console.error("King Translator: DOMParser with SVG trick also failed.",t)}try{const t=document.createElement("div");return t.innerHTML=e,t.firstChild}catch(t){console.error("King Translator: All methods to create element from HTML failed.",t)}return null}function i(t,e){let n;return function(...a){clearTimeout(n),n=setTimeout(()=>{clearTimeout(n),t(...a)},e)}}function s(t,e){return new Promise(n=>{const a=window.translator,i=a.userSettings._,s=a.userSettings.settings.theme,r=o.THEME[s],l=document.createElement("div");l.style.cssText='\nposition: fixed;\ntop: 0;\nleft: 0;\nwidth: 100vw;\nheight: 100vh;\nbackground: rgba(0,0,0,0.5);\nz-index: 2147483647;\ndisplay: flex;\njustify-content: center;\nalign-items: center;\nfont-family: "GoMono Nerd Font", "Noto Sans", Arial;\n';const c=document.createElement("div");c.style.cssText=`\nbackground: ${r.background};\npadding: 20px;\nborder-radius: 12px;\nbox-shadow: 0 4px 20px rgba(0,0,0,0.2);\ndisplay: flex;\nflex-direction: column;\ngap: 15px;\nmin-width: 300px;\nborder: 1px solid ${r.border};\n`;const d=document.createElement("div");d.style.cssText=`\ncolor: ${r.title};\nfont-size: 16px;\nfont-weight: bold;\ntext-align: center;\nmargin-bottom: 5px;\n`,d.textContent=i("notifications.file_input_title");const p=document.createElement("div");p.style.cssText="\ndisplay: flex;\nflex-direction: column;\ngap: 10px;\nalign-items: center;\n";const h=document.createElement("input");h.type="file",h.accept=t,h.style.cssText=`\npadding: 8px;\nborder-radius: 8px;\nborder: 1px solid ${r.border};\nbackground: ${"dark"===s?"#444":"#fff"};\ncolor: ${r.text};\nwidth: 100%;\ncursor: pointer;\nfont-family: inherit;\nfont-size: 14px;\n`;const g=document.createElement("div");g.style.cssText="\ndisplay: flex;\ngap: 10px;\njustify-content: center;\nmargin-top: 10px;\n";const u=document.createElement("button");u.style.cssText=`\npadding: 8px 16px;\nborder-radius: 8px;\nborder: none;\nbackground: ${r.button.close.background};\ncolor: ${r.button.close.text};\ncursor: pointer;\nfont-size: 14px;\ntransition: all 0.2s ease;\nfont-family: inherit;\n`,u.textContent=i("settings.cancel"),u.onmouseover=()=>{u.style.transform="translateY(-2px)",u.style.boxShadow="0 2px 4px rgba(0,0,0,0.2)"},u.onmouseout=()=>{u.style.transform="none",u.style.boxShadow="none"};const m=document.createElement("button");m.style.cssText=`\npadding: 8px 16px;\nborder-radius: 8px;\nborder: none;\nbackground: ${r.button.translate.background};\ncolor: ${r.button.translate.text};\ncursor: pointer;\nfont-size: 14px;\ntransition: all 0.2s ease;\nopacity: 0.5;\nfont-family: inherit;\n`,m.textContent=i("notifications.translate"),m.disabled=!0,m.onmouseover=()=>{m.disabled||(m.style.transform="translateY(-2px)",m.style.boxShadow="0 2px 4px rgba(0,0,0,0.2)")},m.onmouseout=()=>{m.style.transform="none",m.style.boxShadow="none"};const y=()=>{l.remove(),n()};h.addEventListener("change",t=>{const e=t.target.files?.[0];e?(m.disabled=!1,m.style.opacity="1"):(m.disabled=!0,m.style.opacity="0.5")}),u.addEventListener("click",y),m.addEventListener("click",async()=>{const t=h.files?.[0];if(t){try{m.disabled=!0,m.style.opacity="0.5",m.textContent=i("notifications.processing"),await e(t)}catch(t){console.error("Error processing file:",t)}y()}}),g.appendChild(u),g.appendChild(m),p.appendChild(h),c.appendChild(d),c.appendChild(p),c.appendChild(g),l.appendChild(c),a.uiRoot.getRoot().appendChild(l),l.addEventListener("click",t=>{t.target===l&&y()})})}if(window.kingTranslatorInitialized)return void console.log("King Translator: Already initialized, skipping this execution.");window.kingTranslatorInitialized=!0;const o={API:{providers:{gemini:{baseUrl:"https://generativelanguage.googleapis.com/v1beta/models",uploadUrl:"https://generativelanguage.googleapis.com/upload/v1beta/files",models:{fast:["gemini-2.5-flash-lite","gemini-2.5-flash-lite-preview-06-17","gemini-2.5-flash","gemini-2.5-flash-preview-05-20","gemini-2.0-flash-exp","gemini-2.0-flash","gemini-2.0-flash-001","gemini-2.0-flash-lite","gemini-2.0-flash-lite-001","gemini-1.5-flash","gemini-1.5-flash-8b"],pro:["gemini-2.5-pro","gemini-2.5-pro-preview-06-05","gemini-2.5-pro-preview-05-06","gemini-2.5-pro-exp-03-25","gemini-2.0-pro-exp-02-05","gemini-2.0-pro-exp","gemini-1.5-pro"],think:["gemini-2.0-flash-thinking-exp-1219","gemini-2.0-flash-thinking-exp-01-21","gemini-2.0-flash-thinking-exp"]},limits:{maxDirectSize:15728640,maxUploadSize:{document:2147483648,image:2147483648,video:2147483648,audio:2147483648}},headers:{"Content-Type":"application/json"},createRequestBody:(t,e={})=>({contents:[{parts:Array.isArray(t)?t:[{text:t}]}],generationConfig:e}),createBinaryParts:(t,e,n)=>[{text:t},{inline_data:{mime_type:e,data:n}}],responseParser:t=>{if("string"==typeof t)return t;if(t?.candidates?.[0]?.content?.parts?.[0]?.text)return t.candidates[0].content.parts[0].text;throw new Error(this._("notifications.failed_read_api"))}},perplexity:{baseUrl:"https://api.perplexity.ai/chat/completions",models:{fast:["sonar","sonar-reasoning"],balance:["sonar-deep-research","r1-1776"],pro:["sonar-reasoning-pro","sonar-pro"]},headers:t=>({Authorization:`Bearer ${t}`,"Content-Type":"application/json"}),createRequestBody:(t,e="sonar",n=1,a=.95,i=30)=>({model:e,messages:[{role:"user",content:t}],temperature:n,top_p:a,top_k:i}),createBinaryParts:(t,e,n)=>[{type:"text",text:t},{type:"image_url",image_url:{url:`data:${e};base64,${n}`}}],responseParser:t=>{if("string"==typeof t)return t;if(t?.choices?.[0]?.message?.content)return t.choices[0].message.content;throw new Error(this._("notifications.failed_read_api"))}},claude:{baseUrl:"https://api.anthropic.com/v1/messages",models:{fast:["claude-3-5-haiku-latest","claude-3-5-haiku-20241022","claude-3-haiku-20240307"],balance:["claude-3-7-sonnet-latest","claude-3-7-sonnet-20250219","claude-3-5-sonnet-latest","claude-3-5-sonnet-20241022","claude-3-5-sonnet-20240620","claude-3-sonnet-20240229"],pro:["claude-3-opus-latest","claude-3-opus-20240229"]},headers:t=>({"x-api-key":t,"anthropic-version":"2023-06-01","Content-Type":"application/json"}),createRequestBody:(t,e="claude-3-7-sonnet-latest",n=1,a=.95,i=30)=>({model:e,messages:[{role:"user",content:t}],temperature:n,top_p:a,top_k:i}),createBinaryParts:(t,e,n)=>[{type:"text",text:t},{type:"image",source:{type:"base64",media_type:e,data:n}}],responseParser:t=>{if("string"==typeof t)return t;if(t?.content?.[0]?.text)return t.content[0].text;throw new Error("Invalid response format from Claude API")}},openai:{baseUrl:"https://api.openai.com/v1/responses",models:{fast:["gpt-4.1-nano","gpt-4.1-mini","gpt-4o-mini","gpt-4-turbo","gpt-3.5-turbo"],balance:["gpt-4.1","gpt-4o"],pro:["o1-pro"]},headers:t=>({"Content-Type":"application/json",Authorization:`Bearer ${t}`}),createRequestBody:(t,e="gpt-4.1-nano",n=1,a=.95)=>({model:e,input:[{role:"user",content:t}],temperature:n,top_p:a}),createBinaryParts:(t,e,n)=>[{type:"input_text",text:t},{type:"input_image",image_url:`data:${e};base64,${n}`}],responseParser:t=>{if("string"==typeof t)return t;if(t?.output?.[0]?.content?.[0]?.text)return t.output[0].content[0].text;throw new Error("Invalid response format from OpenAI API")}},mistral:{baseUrl:"https://api.mistral.ai/v1/chat/completions",models:{free:["mistral-small-latest","pixtral-12b-2409"],research:["open-mistral-nemo","open-codestral-mamba"],premier:["codestral-latest","mistral-large-latest","pixtral-large-latest","mistral-saba-latest","ministral-3b-latest","ministral-8b-latest","mistral-moderation-latest","mistral-ocr-latest"]},headers:t=>({Authorization:`Bearer ${t}`,"Content-Type":"application/json"}),createRequestBody:(t,e="mistral-small-latest",n=1,a=.95)=>({model:e,messages:[{role:"user",content:(Array.isArray(t),t)}],temperature:n,top_p:a}),createBinaryParts:(t,e,n)=>[{type:"text",text:t},{type:"image_url",image_url:`data:${e};base64,${n}`}],responseParser:t=>{if("string"==typeof t)return t;if(t?.choices?.[0]?.message?.content)return t.choices[0].message.content;throw new Error(this._("notifications.failed_read_api"))}},deepseek:{baseUrl:"https://api.deepseek.com/chat/completions",models:{fast:["deepseek-chat","deepseek-reasoner"]},headers:t=>({Authorization:`Bearer ${t}`,"Content-Type":"application/json"}),createRequestBody:(t,e="deepseek-chat",n=1,a=.95)=>({model:e,messages:[{role:"user",content:t}],temperature:n,top_p:a}),createBinaryParts:t=>t,responseParser:t=>{if("string"==typeof t)return t;if(t?.choices?.[0]?.message?.content)return t.choices[0].message.content;throw new Error(this._("notifications.failed_read_api"))}},ollama:{models:{},headers:{"Content-Type":"application/json"},createRequestBody:(t,e,n,a,i)=>{let s="",o=[];Array.isArray(t)?t.forEach(t=>{t.text&&(s=t.text),t.images&&Array.isArray(t.images)&&(o=t.images)}):s=t;const r={model:e,prompt:s,stream:!1,think:!1,options:{temperature:n,top_p:a,top_k:i}};return o.length>0&&(r.images=o),console.log("body: ",r),r},createBinaryParts:(t,e,n)=>[{text:t},{images:[n]}],responseParser:t=>{if(console.log("response: ",t),"string"==typeof t)return t;if(t?.response)return t.response;throw new Error("Không thể đọc kết quả từ API Ollama.")}}},currentProvider:"gemini",apiKey:{gemini:[""],perplexity:[""],claude:[""],openai:[""],mistral:[""],deepseek:[""]},currentKeyIndex:{gemini:0,perplexity:0,claude:0,openai:0,mistral:0,deepseek:0},maxRetries:5,retryDelay:1e3},LANG_DATA:{vi:{script_name:"King Translator AI",auto_detect:"Tự động phát hiện",settings:{title:"CÀI ĐẶT",interface_section:"GIAO DIỆN",theme_mode:"Chế độ giao diện:",light:"Sáng",dark:"Tối",ui_language:"Ngôn ngữ giao diện:",api_provider_section:"API PROVIDER",api_model_section:"API MODEL",api_keys_section:"API KEYS",model_type:"Sử dụng loại model:",fast:"Nhanh",balance:"Cân bằng",pro:"Pro",think:"Suy luận",custom:"Tùy chỉnh",model_label:"Model",custom_model_placeholder:"Nhập tên model",add_key:"+ Thêm {provider} Key",input_translation_section:"DỊCH KHI VIẾT",enable_feature:"Bật tính năng:",save_position:"Lưu vị trí khi di chuyển:",tools_section:"TOOLS DỊCH ⚙️",enable_tools:"Bật tính năng:",enable_tools_current_web:"Chỉ bật/tắt ở web này:",page_translation_section:"DỊCH TOÀN TRANG",enable_page_translation:"Bật tính năng dịch trang:",show_initial_button:"Hiện nút dịch 10s đầu:",auto_translate_page:"Tự động dịch trang:",custom_selectors:"Tùy chỉnh Selectors loại trừ:",exclude_selectors:"Selectors loại trừ:",one_selector_per_line:"Hãy nhập mỗi selector một dòng!",default_selectors:"Selectors mặc định:",default_selectors_info:"Đây là danh sách selectors mặc định sẽ được sử dụng khi tắt tùy chỉnh.",combine_with_default:"Kết hợp với mặc định:",combine_with_default_info:"Nếu bật, selectors tùy chỉnh sẽ được thêm vào danh sách mặc định thay vì thay thế hoàn toàn.",temperature:"Temperature:",top_p:"Top P:",top_k:"Top K:",prompt_settings_section:"TÙY CHỈNH PROMPT",use_custom_prompt:"Sử dụng prompt tùy chỉnh:",prompt_normal:"Prompt dịch thường (nhanh + popup):",prompt_normal_chinese:"Prompt dịch thường (nhanh + popup)(Phiên âm):",prompt_advanced:"Prompt dịch nâng cao:",prompt_advanced_chinese:"Prompt dịch nâng cao (Phiên âm):",prompt_ocr:"Prompt OCR:",prompt_ocr_chinese:"Prompt OCR (Phiên âm):",prompt_media:"Prompt Media:",prompt_media_chinese:"Prompt Media (Phiên âm):",prompt_page:"Prompt dịch trang:",prompt_page_chinese:"Prompt dịch trang (Phiên âm):",prompt_file_content:"Prompt dịch File (multimodal):",prompt_file_content_chinese:"Prompt dịch File (multimodal) (Phiên âm):",enable_google_translate_page:"Bật dịch trang với Google Translate:",google_translate_layout:"Kiểu hiển thị của Google Translate:",google_translate_minimal:"Tối giản (chỉ thanh ngữ cảnh)",google_translate_inline:"Nội tuyến (tự động)",google_translate_selected:"Phân tích và dịch",prompt_vars_info:"Các biến có thể sử dụng trong prompt:",prompt_var_text:"Văn bản cần dịch",prompt_var_doc_title:"Tiêu đề trang web",prompt_var_target_lang:"Ngôn ngữ đích",prompt_var_source_lang:"Ngôn ngữ nguồn (nếu có)",prompt_notes:"Lưu ý:",prompt_notes_required:"Tham số bắt buộc phải sử dụng: {text} để có thể thay văn bản cần dịch vào prompt gửi cho AI.",prompt_note_en:"Khi nhập tuỳ chỉnh cho phiên âm hãy yêu cầu nó trả về theo định dạng sau: Bản gốc <|> Phiên âm IPA <|> Bản dịch. Ví dụ: Hello <|> heˈloʊ <|> Xin chào.",prompt_note_zh:"Nếu có từ là tiếng Trung, hãy trả về giá trị phiên âm của từ đó chính là pinyin + số tone (1-4) của từ đó. Ví dụ: 你好 <|> Nǐ3 hǎo3 <|> Xin chào.",ocr_section:"DỊCH VĂN BẢN TRONG ẢNH",enable_ocr:"Bật OCR dịch:",enable_manga_translate_all:"Bật dịch toàn bộ manga (chọn 2 ảnh):",enable_manga_translate_all_site_only:"Ưu tiên bật dịch toàn bộ manga cho trang này:",media_section:"DỊCH MEDIA",enable_media:"Bật dịch Media:",video_streaming_section:"DỊCH PHỤ ĐỀ VIDEO TRỰC TUYẾN",enable_video_streaming:"Bật tính năng:",font_size:"Cỡ chữ:",background_color:"Màu nền:",text_color:"Màu chữ:",display_section:"HIỂN THỊ",display_mode:"Chế độ hiển thị:",translation_only:"Chỉ hiện bản dịch",parallel:"Song song văn bản gốc và bản dịch",language_learning:"Chế độ học ngôn ngữ",show_source:"Hiện bản gốc:",source_language:"Ngôn ngữ nguồn:",target_language:"Ngôn ngữ đích:",web_image_font_size:"Cỡ chữ dịch manga web:",popup_font_size:"Cỡ chữ dịch popup:",min_popup_width:"Độ rộng tối thiểu (popup):",max_popup_width:"Độ rộng tối đa (popup):",tts_section:"TEXT TO SPEECH",enable_tts:"Bật TTS:",tts_source:"Nguồn TTS:",default_voice:"Giọng đọc mặc định:",voice:"Giọng đọc:",speed:"Tốc độ mặc định:",pitch:"Cao độ mặc định:",volume:"Âm lượng mặc định:",context_menu_section:"CONTEXT MENU",enable_context_menu:"Bật Context Menu:",shortcuts_section:"PHÍM TẮT",enable_settings_shortcut:"Bật phím tắt mở cài đặt:",enable_translation_shortcuts:"Bật phím tắt dịch:",ocr_region_shortcut:"Dịch vùng chọn OCR:",ocr_web_image_shortcut:"Dịch ảnh web:",manga_web_shortcut:"Dịch manga web:",page_translate_shortcut:"Dịch trang:",input_translate_shortcut:"Dịch text trong hộp nhập:",quick_translate_shortcut:"Dịch nhanh",popup_translate_shortcut:"Dịch popup",advanced_translate_shortcut:"Dịch nâng cao",button_options_section:"NÚT DỊCH",enable_translation_button:"Bật nút dịch:",single_click:"Nhấp đơn:",double_click:"Nhấp đúp:",hold_button:"Giữ nút:",touch_options_section:"CẢM ỨNG ĐA ĐIỂM",enable_touch:"Bật cảm ứng:",two_fingers:"Hai ngón tay:",three_fingers:"Ba ngón tay:",sensitivity:"Độ nhạy (ms):",rate_limit_section:"RATE LIMIT",max_requests:"Số yêu cầu tối đa:",per_milliseconds:"Thời gian chờ (ms):",cache_section:"CACHE",text_cache:"Text Cache",enable_text_cache:"Bật cache text:",text_cache_max_size:"Kích thước cache text:",text_cache_expiration:"Thời gian cache text (ms):",image_cache:"Image Cache",enable_image_cache:"Bật cache ảnh:",image_cache_max_size:"Kích thước cache ảnh:",image_cache_expiration:"Thời gian cache ảnh (ms):",media_cache:"Media Cache",enable_media_cache:"Bật cache media:",media_cache_max_size:"Media cache entries:",media_cache_expiration:"Thời gian expire (ms):",tts_cache:"TTS Cache",enable_tts_cache:"Bật cache TTS:",tts_cache_max_size:"TTS cache entries:",tts_cache_expiration:"Thời gian expire (ms):",backup_settings_section:"SAO LƯU CÀI ĐẶT",export_settings:"Xuất cài đặt",import_settings:"Nhập cài đặt",cancel:"Hủy",save:"Lưu"},notifications:{export_success:"Export settings thành công",export_error:"Lỗi export settings",invalid_settings_file:"File settings không hợp lệ",invalid_settings_format:"Format settings không hợp lệ",invalid_settings:"Settings không hợp lệ",decompression_error:"Không thể giải nén settings",import_success:"Import settings thành công",import_error:"Lỗi import:",no_api_key_configured:"Không có API key nào được cấu hình",no_api_key_available:"Không có API key khả dụng. Vui lòng kiểm tra lại API key trong cài đặt.",all_keys_failed:"Tất cả API key đều thất bại:\n",invalid_api_key:"API key {key_prefix}... không hợp lệ",rate_limited_api_key:"API key {key_prefix}... đã vượt quá giới hạn",other_api_error:"Lỗi với API key {key_prefix}...: {error_message}",rate_limited_info:"API key {key_prefix}... đang bị giới hạn. Thử lại sau {time_left}s",too_many_requests:"API key {key_prefix}... đang xử lý quá nhiều yêu cầu",network_error:"Lỗi kết nối mạng",api_response_parse_error:"Không thể xử lý phản hồi từ API",unknown_api_error:"Lỗi API không xác định",unsupported_provider:"Provider không hợp lệ:",key_error:"Key {key_prefix}... lỗi: {error_message}",translation_error:"Lỗi dịch:",screen_capture_error:"Lỗi chụp màn hình:",no_content_in_selection:"Vùng được chọn không có nội dung",invalid_image_file:"Không thể tạo ảnh hợp lệ",cannot_identify_region:"Không thể xác định vùng chọn",image_load_error:"Không thể load ảnh",canvas_security_error:"Canvas chứa nội dung từ domain khác không thể được truy cập",cannot_capture_element:"Không thể capture nội dung từ element",cannot_capture_screen:"Không thể chụp màn hình",cannot_generate_valid:"Không thể tạo ảnh hợp lệ",invalid_screenshot:"Ảnh chụp không hợp lệ",screenshot_cancel:"Đã hủy chọn vùng",processing_image:"Đang xử lý ảnh...",checking_cache:"Đang kiểm tra cache...",found_in_cache:"Đã tìm thấy trong cache",detecting_text:"Đang nhận diện text...",completed:"Hoàn thành",unsupported_file_format:"Định dạng file không được hỗ trợ",file_too_large:"File quá lớn.",processing_media:"Đang xử lý media...",processing_audio_video:"Đang xử lý audio/video...",translating:"Đang dịch...",finalizing:"Đang hoàn thiện...",cannot_process_media:"Không thể xử lý media",media_file_error:"Không thể xử lý file:",caption_enable_error:"Lỗi khi bật caption:",cc_button_not_found:"Không tìm thấy nút CC",cc_enabled:"Đã bật CC",cc_error:"Lỗi khi bật CC",caption_menu_opened:"Đã mở menu phụ đề",failed_player_response:"Failed to get playerResponse",no_caption_tracks:"No caption tracks found",no_caption_track_url:"Could not find caption track URL",selected_track:"Selected track:",auto_generated:"(auto-generated)",no_valid_text_extracted:"Transcript events found, but no valid text content could be extracted.",no_video_found:"No video found",no_transcript_found:"No transcript found",process_frame_error:"Lỗi processVideoFrame:",caption_translation_error:"Lỗi dịch caption",chunk_translation_error:"Lỗi dịch chunk:",translating_part:"Đang dịch phần ",upcoming_captions_error:"Lỗi translateUpcomingCaptions:",tried_n_times_original_text:"Đã thử {n} lần, trả về text gốc",live_caption_off:"Tắt dịch phụ đề video",live_caption_on:"Bật dịch phụ đề video",live_caption_off2:"Đã tắt dịch phụ đề video",live_caption_on2:"Đã bật dịch phụ đề video",video_container_not_found:"Không tìm thấy container video phù hợp",page_translation_disabled:"Tính năng dịch trang đang bị tắt",auto_translate_disabled:"Tự động dịch đang tắt",page_already_target_lang:"Trang web đã ở ngôn ngữ",language_detected:"Đã phát hiện ngôn ngữ: {language} (độ tin cậy: {confidence}%)",page_translated_partial:"Đã dịch trang ({failed_count} phần bị lỗi)",page_translated_success:"Đã dịch xong trang",page_reverted_to_original:"Đã chuyển về văn bản gốc",no_content_to_translate:"Không tìm thấy nội dung cần dịch",html_translation_error:"Lỗi dịch HTML:",pdf_translation_error:"Lỗi dịch PDF:",node_update_error:"Node update error:",invalid_selector:"Invalid selector:",dom_update_error:"DOM update error:",response_parse_error:"Lỗi parse response:",request_failed:"Request failed:",no_content_for_lang_detect:"Không tìm thấy nội dung để phát hiện ngôn ngữ",backup_lang_detect_failed:"Backup language detection failed:",file_processing_error:"Lỗi xử lý tệp",json_processing_error:"Lỗi xử lý JSON",subtitle_processing_error:"Lỗi xử lý phụ đề",file_translation_error:"Lỗi dịch file:",copied:"Đã sao chép!",no_text_selected:"Chưa có văn bản nào được chọn",no_target_element:"Không tìm thấy phần tử đích",translator_instance_not_found:"Không tìm thấy đối tượng Translator",browser_tts_not_supported:"Trình duyệt không hỗ trợ TTS",tts_playback_error:"Lỗi phát âm",audio_playback_error:"Lỗi phát âm thanh:",gtranslate_tts_error:"Lỗi Google Translate TTS:",google_tts_api_error:"Lỗi Google TTS API:",openai_tts_error:"Lỗi OpenAI TTS:",invalid_response_format:"Invalid response format",no_response_from_api:"No response from API",text_detection_error:"Text detection error:",no_blob_created:"Không thể tạo blob",page_translate_loading:"Đang dịch trang...",processing_pdf:"Đang xử lý PDF...",html_file_translated_success:"Dịch file HTML thành công",pdf_translated_success:"Dịch PDF thành công",file_translated_success:"Dịch file thành công",file_input_title:"Chọn loại file hoặc url để dịch",processing:"Đang xử lý...",unknown_error:"Lỗi không xác định",rate_limit_wait:"Vui lòng chờ giữa các lần dịch",auth_error:"Lỗi xác thực API",generic_translation_error:"Lỗi dịch thuật:",manga_guide_translate_all_prioritized:"Nhấp vào ảnh để dịch toàn bộ chương (Chế độ ưu tiên)",manga_button_translate_single:"Chỉ dịch ảnh này",ocr_click_guide:"Click vào ảnh để OCR",manga_click_guide:"Click vào ảnh để dịch manga",manga_translate_all_button:"Dịch Toàn Bộ (Chọn 2 ảnh)",manga_select_first_image:"Vui lòng chọn ảnh thứ nhất...",manga_select_last_image:"Đã chọn một ảnh. Vui lòng chọn ảnh thứ hai...",manga_common_parent_not_found:"Không tìm thấy vùng chứa truyện chung. Vui lòng chọn 2 ảnh gần nhau hơn.",manga_image_order_error:"Không thể xác định thứ tự ảnh. Vui lòng thử lại.",manga_font_size_small:"nhỏ",manga_font_size_medium:"trung bình",manga_font_size_large:"lớn",tts_settings:"Cài đặt TTS",tts_lang_no_voice:"Không có giọng đọc cho ngôn ngữ",ui_language:"Ngôn ngữ giao diện:",ui_language_info:"Thay đổi ngôn ngữ của giao diện người dùng userscript.",translation_tool_on:"Đã bật công cụ dịch",translation_tool_off:"Đã tắt công cụ dịch",page_translate_menu_label:"Dịch Trang",ocr_region_menu_label:"Dịch Vùng OCR",web_image_ocr_menu_label:"Dịch Ảnh Web",manga_web_menu_label:"Dịch Manga Web",image_file_menu_label:"Dịch File Ảnh",media_file_menu_label:"Dịch File Media",html_file_menu_label:"Dịch File HTML",pdf_file_menu_label:"Dịch File PDF",generic_file_menu_label:"Dịch File",original_label:"Bản gốc",ipa_label:"Phiên âm",translation_label:"Bản dịch",original:"[GỐC]",ipa:"[IPA]",translation:"[DỊCH]",translate:"Dịch",settings:"Cài đặt King AI",source_trans:"Dịch sang ngôn ngữ nguồn",target_trans:"Dịch sang ngôn ngữ đích",cap_gui:"Chạm và kéo để chọn vùng cần dịch",failed_read_file:"Không thể đọc file",failed_read_api:"Không thể đọc kết quả từ API",found_new_ele:"Tìm thấy video element mới:",stop_cap:"Đã dừng dịch phụ đề",found_video:"Tìm thấy container video:",lang_detect:"Phát hiện ngôn ngữ",reliability:"Độ tin cậy",upl_url:"Không tạo được URL từ tệp đã tải lên",upl_uri:"Không nhận được file URI",upl_fail:"Tải lên thất bại",uns_format:"Định dạng không được hỗ trợ",switch_layout:"Chuyển đổi layout ngang dọc",switch_layout_ver:"Chuyển đổi layout sang dọc",switch_layout_hor:"Chuyển đổi layout sang ngang",device_tts:"TTS của Thiết bị",un_pr_screen:"Không thể xử lý ảnh chụp màn hình",un_cr_screen:"Không thể tạo ảnh chụp màn hình",play_tts:"Đọc văn bản",stop_tts:"Dừng đọc",unsupport_file:"Định dạng file không được hỗ trợ. Chỉ hỗ trợ:",close_popup:"Đóng popup",generic_file_gemini_menu_label:"Dịch VIP",only_gemini:"Tính năng này chỉ hỗ trợ API Gemini. Vui lòng chọn Gemini làm API Provider trong cài đặt.",file_input_url_title:"Nhập URL file để dịch",file_input_url_placeholder:"Dán URL file vào đây",invalid_url_format:"Định dạng URL không hợp lệ. Vui lòng nhập URL hợp lệ (bắt đầu bằng http:// hoặc https://).",processing_url:"Đang xử lý URL...",unsupport_file_url_provider:"API Provider này không hỗ trợ trực tiếp URL file. Vui lòng chọn Gemini.",google_translate_page_menu_label:"Google Dịch (Page)",google_translate_enabled:"Đã bật dịch trang với Google Translate.",google_translate_already_active:"Google Translate đang hoạt động. Vui lòng làm mới trang để tắt.",revert_google_translate_label:"Tắt dịch Google",google_translate_unsupported:"Google Translate không hỗ trợ trên trang này.",reload_page_label:"Tải lại trang",not_find_video:"Không tìm thấy video nào đang phát sau 3 phút",get_transcript_error:"Lỗi khi lấy bản chép lời YouTube:",get_transcript_error_generic:"Không thể lấy được bản chép lời từ YouTube sau nhiều lần thử.",get_transcript_error_suggestion1:"Gợi ý 1: Vui lòng thử tải lại (F5) trang này.",get_transcript_error_suggestion2:"Gợi ý 2: Nếu vẫn lỗi, hãy thử xóa cookie và dữ liệu trang web cho YouTube."},logs:{manga_translate_all_started:"Bắt đầu dịch toàn bộ ảnh...",manga_no_images_found:"Không tìm thấy ảnh hợp lệ trong vùng chọn.",manga_translating_progress:"Đang dịch ảnh {current}/{total}...",manga_translate_image_error:"Lỗi khi dịch ảnh {index}:",manga_translate_all_completed:"Hoàn thành dịch toàn bộ!"}},en:{script_name:"King Translator AI",auto_detect:"Auto-detect",settings:{title:"SETTINGS",interface_section:"INTERFACE",theme_mode:"Theme Mode:",light:"Light",dark:"Dark",ui_language:"Interface Language:",api_provider_section:"API PROVIDER",api_model_section:"API MODEL",api_keys_section:"API KEYS",model_type:"Select Model Type:",fast:"Fast",balance:"Balance",pro:"Pro",think:"Think",custom:"Custom",model_label:"Model",custom_model_placeholder:"Enter custom model name",add_key:"+ Add {provider} Key",input_translation_section:"INPUT TRANSLATION",enable_feature:"Enable Feature:",save_position:"Save position when moved:",tools_section:"TRANSLATOR TOOLS ⚙️",enable_tools:"Enable Tools:",enable_tools_current_web:"Enable/Disable on this website only:",page_translation_section:"PAGE TRANSLATION",enable_page_translation:"Enable Page Translation:",show_initial_button:"Show translate button for 10s:",auto_translate_page:"Auto-translate page:",custom_selectors:"Custom Exclusion Selectors:",exclude_selectors:"Exclusion Selectors:",one_selector_per_line:"Enter each selector on a new line!",default_selectors:"Default Selectors:",default_selectors_info:"These are the default selectors used when custom selectors are disabled.",combine_with_default:"Combine with Default:",combine_with_default_info:"If enabled, custom selectors will be added to the default list instead of replacing them completely.",temperature:"Temperature:",top_p:"Top P:",top_k:"Top K:",prompt_settings_section:"CUSTOM PROMPTS",use_custom_prompt:"Use Custom Prompts:",prompt_normal:"Normal Translation Prompt (quick + popup):",prompt_normal_chinese:"Normal Translation Prompt (quick + popup)(IPA):",prompt_advanced:"Advanced Translation Prompt:",prompt_advanced_chinese:"Advanced Translation Prompt (IPA):",prompt_ocr:"OCR Prompt:",prompt_ocr_chinese:"OCR Prompt (IPA):",prompt_media:"Media Prompt:",prompt_media_chinese:"Media Prompt (IPA):",prompt_page:"Page Translation Prompt:",prompt_page_chinese:"Page Translation Prompt (IPA):",prompt_file_content:"File Translation Prompt (multimodal):",prompt_file_content_chinese:"File Translation Prompt (multimodal) (IPA):",enable_google_translate_page:"Enable Page Translate with Google Translate:",google_translate_layout:"Google Translate Display Layout:",google_translate_minimal:"Minimal (Context Bar Only)",google_translate_inline:"Inline (Automatic)",google_translate_selected:"Analyze and Translate",prompt_vars_info:"Available variables in prompts:",prompt_var_text:"Text to be translated",prompt_var_doc_title:"Document Title",prompt_var_target_lang:"Target Language",prompt_var_source_lang:"Source Language (if available)",prompt_notes:"Note:",prompt_notes_required:"The required parameter must use: {text} to allow the text to be translated to be substituted into the AI prompt.",prompt_note_en:"When providing custom phonetic input, request output in the following format: Original <|> IPA Transcription <|> Translation. For example: Hello <|> heˈloʊ <|> Xin chào.",prompt_note_zh:"For Chinese words, return its phonetic transcription as Pinyin + its tone number (1-4). For example: 你好 <|> Nǐ3 hǎo3 <|> Xin chào.",ocr_section:"IMAGE TEXT TRANSLATION (OCR)",enable_ocr:"Enable OCR Translation:",enable_manga_translate_all:"Enable 'Translate All' for manga (select 2 images):",enable_manga_translate_all_site_only:"Prioritize 'Translate All' for manga on this site:",media_section:"MEDIA TRANSLATION",enable_media:"Enable Media Translation:",video_streaming_section:"LIVE VIDEO SUBTITLE TRANSLATION",enable_video_streaming:"Enable Feature:",font_size:"Font Size:",background_color:"Background Color:",text_color:"Text Color:",display_section:"DISPLAY",display_mode:"Display Mode:",translation_only:"Translation Only",parallel:"Parallel Original and Translated Text",language_learning:"Language Learning Mode",show_source:"Show Original:",source_language:"Source Language:",target_language:"Target Language:",web_image_font_size:"Web Manga Translation Font Size:",popup_font_size:"Popup Font Size:",min_popup_width:"Minimum Popup Width:",max_popup_width:"Maximum Popup Width:",tts_section:"TEXT TO SPEECH",enable_tts:"Enable TTS:",tts_source:"TTS Source:",default_voice:"Default Voice:",voice:"Voice:",speed:"Default Speed:",pitch:"Default Pitch:",volume:"Default Volume:",context_menu_section:"CONTEXT MENU",enable_context_menu:"Enable Context Menu:",shortcuts_section:"SHORTCUTS",enable_settings_shortcut:"Enable Settings Shortcut:",enable_translation_shortcuts:"Enable Translation Shortcuts:",ocr_region_shortcut:"OCR Region Translate:",ocr_web_image_shortcut:"Web Image Translate:",manga_web_shortcut:"Manga Web Translate:",page_translate_shortcut:"Page Translate:",input_translate_shortcut:"Input Text Translate:",quick_translate_shortcut:"Quick Translate",popup_translate_shortcut:"Popup Translate",advanced_translate_shortcut:"Advanced Translate",button_options_section:"TRANSLATION BUTTON",enable_translation_button:"Enable Translation Button:",single_click:"Single Click:",double_click:"Double Click:",hold_button:"Hold Button:",touch_options_section:"MULTI-TOUCH",enable_touch:"Enable Touch:",two_fingers:"Two Fingers:",three_fingers:"Three Fingers:",sensitivity:"Sensitivity (ms):",rate_limit_section:"RATE LIMIT",max_requests:"Max Requests:",per_milliseconds:"Time Period (ms):",cache_section:"CACHE",text_cache:"Text Cache",enable_text_cache:"Enable Text Cache:",text_cache_max_size:"Text Cache Size:",text_cache_expiration:"Text Cache Expiration (ms):",image_cache:"Image Cache",enable_image_cache:"Enable Image Cache:",image_cache_max_size:"Image Cache Size:",image_cache_expiration:"Image Cache Expiration (ms):",media_cache:"Media Cache",enable_media_cache:"Enable Media Cache:",media_cache_max_size:"Media Cache Entries:",media_cache_expiration:"Expiration Time (ms):",tts_cache:"TTS Cache",enable_tts_cache:"Enable TTS Cache:",tts_cache_max_size:"TTS Cache Entries:",tts_cache_expiration:"Expiration Time (ms):",backup_settings_section:"SETTINGS BACKUP",export_settings:"Export Settings",import_settings:"Import Settings",cancel:"Cancel",save:"Save"},notifications:{export_success:"Settings exported successfully",export_error:"Error exporting settings",invalid_settings_file:"Invalid settings file",invalid_settings_format:"Invalid settings format",invalid_settings:"Invalid settings",decompression_error:"Could not decompress settings",import_success:"Settings imported successfully",import_error:"Import error:",no_api_key_configured:"No API key configured",no_api_key_available:"No available API keys. Please check API keys in settings.",all_keys_failed:"All API keys failed:\n",invalid_api_key:"API key {key_prefix}... is invalid",rate_limited_api_key:"API key {key_prefix}... exceeded rate limit",other_api_error:"Error with API key {key_prefix}...: {error_message}",rate_limited_info:"API key {key_prefix}... is rate-limited. Retrying in {time_left}s",too_many_requests:"is handling too many requests",network_error:"Network connection error",api_response_parse_error:"Could not process API response",unknown_api_error:"Unknown API error",unsupported_provider:"Invalid provider:",key_error:"Key {key_prefix}... error: {error_message}",translation_error:"Translation error:",screen_capture_error:"Screen capture error:",no_content_in_selection:"Selected area has no content",invalid_image_file:"Could not create valid image",cannot_identify_region:"Could not identify selection region",image_load_error:"Could not load image",canvas_security_error:"Canvas contains cross-origin content that cannot be accessed",cannot_capture_element:"Could not capture content from element",cannot_capture_screen:"Không thể chụp màn hình: ",cannot_generate_valid:"Failed to generate valid image",invalid_screenshot:"Invalid screenshot",screenshot_cancel:"Selection cancelled",processing_image:"Processing image...",checking_cache:"Checking cache...",found_in_cache:"Found in cache",detecting_text:"Detecting text...",completed:"Completed",unsupported_file_format:"Unsupported file format",file_too_large:"File is too large.",processing_media:"Processing media...",processing_audio_video:"Processing audio/video...",translating:"Translating...",finalizing:"Finalizing...",cannot_process_media:"Could not process media",media_file_error:"Could not process file: {error_message}",caption_enable_error:"Error enabling captions:",cc_button_not_found:"CC button not found",cc_enabled:"CC enabled",cc_error:"Error enabling CC",caption_menu_opened:"Subtitle menu opened",failed_player_response:"Failed to get playerResponse",no_caption_tracks:"No caption tracks found",no_caption_track_url:"Could not find caption track URL",selected_track:"Selected track:",auto_generated:"(auto-generated)",no_valid_text_extracted:"Transcript events found, but no valid text content could be extracted.",no_video_found:"No video found",no_transcript_found:"No transcript found",process_frame_error:"Error processing video frame:",caption_translation_error:"Error translating caption",chunk_translation_error:"Error translating chunk:",translating_part:"Translating part ",upcoming_captions_error:"Error translating upcoming captions:",tried_n_times_original_text:"Tried {n} times, returning original text",live_caption_off:"Turn off translated subtitles",live_caption_on:"Turn on translated subtitles",live_caption_off2:"Video subtitle translation disabled",live_caption_on2:"Video subtitle translation enabled",video_container_not_found:"No suitable video container found",page_translation_disabled:"Page translation feature is disabled",auto_translate_disabled:"Auto-translate is off",page_already_target_lang:"Page is already in",language_detected:"Language detected: {language} (confidence: {confidence}%)",page_translated_partial:"Page translated ({failed_count} parts failed)",page_translated_success:"Page translated successfully",page_reverted_to_original:"Reverted to original text",no_content_to_translate:"No content found to translate",html_translation_error:"HTML file translation error:",pdf_translation_error:"PDF translation error:",node_update_error:"Node update error:",invalid_selector:"Invalid selector:",dom_update_error:"DOM update error:",response_parse_error:"Response parse error:",request_failed:"Request failed:",no_content_for_lang_detect:"No content found for language detection",backup_lang_detect_failed:"Backup language detection failed:",file_processing_error:"File processing error",json_processing_error:"JSON processing error",subtitle_processing_error:"Subtitle processing error",file_translation_error:"File translation error:",copied:"Copied!",no_text_selected:"No text selected",no_target_element:"No target element found",translator_instance_not_found:"Translator instance not found",browser_tts_not_supported:"Browser TTS not supported",tts_playback_error:"Playback error",audio_playback_error:"Audio playback error:",gtranslate_tts_error:"Google Translate TTS error:",google_tts_api_error:"Google TTS API error:",openai_tts_error:"OpenAI TTS error:",invalid_response_format:"Invalid response format",no_response_from_api:"No response from API",text_detection_error:"Text detection error:",no_blob_created:"Could not create blob",page_translate_loading:"Translating page...",processing_pdf:"Processing PDF...",html_file_translated_success:"HTML file translated successfully",pdf_translated_success:"PDF translated successfully",file_translated_success:"File translated successfully",file_input_title:"Select file or url to translate",processing:"Processing...",unknown_error:"Unknown error",rate_limit_wait:"Please wait between translations",auth_error:"API authentication error",generic_translation_error:"Translation error:",manga_guide_translate_all_prioritized:"Click any image to translate the whole chapter (Prioritized Mode)",manga_button_translate_single:"Translate This Image Only",ocr_click_guide:"Click image to OCR",manga_click_guide:"Click image to translate manga",manga_translate_all_button:"Translate All (Select 2 images)",manga_select_first_image:"Please select the first image...",manga_select_last_image:"One image selected. Please select the second image...",manga_common_parent_not_found:"Could not find a common story container. Please select two closer images.",manga_image_order_error:"Could not determine image order. Please try again.",manga_font_size_small:"small",manga_font_size_medium:"medium",manga_font_size_large:"large",tts_settings:"TTS Settings",tts_lang_no_voice:"No voice available for",ui_language:"UI Language:",ui_language_info:"Change the userscript's user interface language.",translation_tool_on:"Translation tool has been turned on",translation_tool_off:"Translation tool has been turned off",page_translate_menu_label:"Webpage Trans",ocr_region_menu_label:"OCR Region Trans",web_image_ocr_menu_label:"Web Image Trans",manga_web_menu_label:"Manga Web Trans",image_file_menu_label:"Image File Trans",media_file_menu_label:"Media File Trans",html_file_menu_label:"HTML File Trans",pdf_file_menu_label:"PDF File Trans",generic_file_menu_label:"File Translate",original_label:"Original",ipa_label:"IPA",translation_label:"Translate",original:"[ORIGIN]",ipa:"[IPA]",translation:"[TRANS]",translate:"Translate",settings:"King AI Settings",source_trans:"Trans to source language",target_trans:"Trans to target language",cap_gui:"Tap and drag to select translation area",failed_read_file:"Failed to read file",failed_read_api:"Failed to read API response",found_new_ele:"Find a new video element:",stop_cap:"Stopped translating subtitles",found_video:"Found video container:",lang_detect:"Language detection",reliability:"confidence",upl_url:"Could not create URL from the uploaded file",upl_uri:"Could not get file URI.",upl_fail:"Upload failed",uns_format:"Unsupported format",switch_layout:"Switch layout orientation",switch_layout_ver:"Switch to vertical layout",switch_layout_hor:"Switch to horizontal layout",device_tts:"Device TTS",un_pr_screen:"Could not process screenshot",un_cr_screen:"Could not create screenshot",play_tts:"Đọc văn bản",stop_tts:"Dừng đọc",unsupport_file:"Unsupported file format. Only supports:",close_popup:"Close popup",generic_file_gemini_menu_label:"Translate VIP",only_gemini:"This feature only supports the Gemini API. Please select Gemini as the API Provider in the settings.",file_input_url_title:"Enter file URL to translate",file_input_url_placeholder:"Paste file URL here",invalid_url_format:"Invalid URL format. Please enter a valid URL (starting with http:// or https://).",processing_url:"Processing URL...",unsupport_file_url_provider:"This API Provider does not support direct file URLs. Please select Gemini.",google_translate_page_menu_label:" Google Trans (Page)",google_translate_enabled:"Google Translate page translation enabled.",google_translate_already_active:"Google Translate is already active. Please refresh page to disable.",revert_google_translate_label:"Disable Google Translate",google_translate_unsupported:"Google Translate is not supported on this page.",reload_page_label:"Reload Page",not_find_video:"Could not find an active video after 3 minutes",get_transcript_error:"Error getting video transcript:",get_transcript_error_generic:"Could not get the transcript from YouTube after multiple attempts.",get_transcript_error_suggestion1:"Suggestion 1: Please try refreshing (F5) this page.",get_transcript_error_suggestion2:"Suggestion 2: If the error persists, try clearing cookies and site data for YouTube."},logs:{manga_translate_all_started:"Starting to translate all images...",manga_no_images_found:"No valid images found in the selection.",manga_translating_progress:"Translating image {current} of {total}...",manga_translate_image_error:"Error translating image {index}:",manga_translate_all_completed:"Finished translating all images!"}}},TTS:{GEMINI:{MODEL:["gemini-2.5-flash-preview-tts","gemini-2.5-pro-preview-tts"],VOICES:["Zephyr","Puck","Charon","Kore","Fenrir","Leda","Orus","Aoede","Callirrhoe","Autonoe","Enceladus","Iapetus","Umbriel","Algieba","Despina","Erinome","Algenib","Rasalgethi","Laomedeia","Achernar","Alnilam","Schedar","Gacrux","Pulcherrima","Achird","Zubenelgenubi","Vindemiatrix","Sadachbia","Sadaltager","Sulafat"]},OPENAI:{MODEL:["tts-1","tts-1-hd","gpt-4o-mini-tts"],VOICES:["alloy","ash","ballad","coral","echo","fable","onyx","nova","sage","shimmer","verse"]},GOOGLE:{VOICES:{vi:[{name:"vi-VN-Standard-A",display:"Google Nữ (Bắc) - Standard"},{name:"vi-VN-Standard-B",display:"Google Nam (Bắc) - Standard"},{name:"vi-VN-Standard-C",display:"Google Nữ (Nam) - Standard"},{name:"vi-VN-Standard-D",display:"Google Nam (Nam) - Standard"},{name:"vi-VN-Wavenet-A",display:"Google Nữ (Bắc) - Wavenet"},{name:"vi-VN-Wavenet-B",display:"Google Nam (Bắc) - Wavenet"},{name:"vi-VN-Wavenet-C",display:"Google Nữ (Nam) - Wavenet"},{name:"vi-VN-Wavenet-D",display:"Google Nam (Nam) - Wavenet"},{name:"vi-VN-Neural2-A",display:"Google Nữ (Bắc) - Neural2"},{name:"vi-VN-Neural2-B",display:"Google Nam (Bắc) - Neural2"},{name:"vi-VN-Neural2-C",display:"Google Nữ (Nam) - Neural2"},{name:"vi-VN-Neural2-D",display:"Google Nam (Nam) - Neural2"}],en:[{name:"en-US-Standard-A",display:"US Female 1 - Standard"},{name:"en-US-Standard-B",display:"US Male 1 - Standard"},{name:"en-US-Standard-C",display:"US Female 2 - Standard"},{name:"en-US-Standard-D",display:"US Male 2 - Standard"},{name:"en-US-Standard-E",display:"US Female 3 - Standard"},{name:"en-US-Standard-F",display:"US Female 4 - Standard"},{name:"en-US-Standard-G",display:"US Female 5 - Standard"},{name:"en-US-Standard-H",display:"US Female 6 - Standard"},{name:"en-US-Standard-I",display:"US Male 3 - Standard"},{name:"en-US-Standard-J",display:"US Male 4 - Standard"},{name:"en-US-Wavenet-A",display:"US Female 1 - Wavenet"},{name:"en-US-Wavenet-B",display:"US Male 1 - Wavenet"},{name:"en-US-Wavenet-C",display:"US Female 2 - Wavenet"},{name:"en-US-Wavenet-D",display:"US Male 2 - Wavenet"},{name:"en-US-Wavenet-E",display:"US Female 3 - Wavenet"},{name:"en-US-Wavenet-F",display:"US Female 4 - Wavenet"},{name:"en-US-Wavenet-G",display:"US Female 5 - Wavenet"},{name:"en-US-Wavenet-H",display:"US Female 6 - Wavenet"},{name:"en-US-Wavenet-I",display:"US Male 3 - Wavenet"},{name:"en-US-Wavenet-J",display:"US Male 4 - Wavenet"},{name:"en-US-Neural2-A",display:"US Female 1 - Neural2"},{name:"en-US-Neural2-B",display:"US Male 1 - Neural2"},{name:"en-US-Neural2-C",display:"US Female 2 - Neural2"},{name:"en-US-Neural2-D",display:"US Male 2 - Neural2"},{name:"en-US-Neural2-E",display:"US Female 3 - Neural2"},{name:"en-US-Neural2-F",display:"US Female 4 - Neural2"},{name:"en-US-Neural2-G",display:"US Female 5 - Neural2"},{name:"en-US-Neural2-H",display:"US Female 6 - Neural2"},{name:"en-US-Neural2-I",display:"US Male 3 - Neural2"},{name:"en-US-Neural2-J",display:"US Male 4 - Neural2"},{name:"en-GB-Standard-A",display:"UK Female 1 - Standard"},{name:"en-GB-Standard-B",display:"UK Male 1 - Standard"},{name:"en-GB-Standard-C",display:"UK Female 2 - Standard"},{name:"en-GB-Standard-D",display:"UK Male 2 - Standard"},{name:"en-GB-Standard-F",display:"UK Female 3 - Standard"},{name:"en-GB-Wavenet-A",display:"UK Female 1 - Wavenet"},{name:"en-GB-Wavenet-B",display:"UK Male 1 - Wavenet"},{name:"en-GB-Wavenet-C",display:"UK Female 2 - Wavenet"},{name:"en-GB-Wavenet-D",display:"UK Male 2 - Wavenet"},{name:"en-GB-Wavenet-F",display:"UK Female 3 - Wavenet"},{name:"en-GB-Neural2-A",display:"UK Female 1 - Neural2"},{name:"en-GB-Neural2-B",display:"UK Male 1 - Neural2"},{name:"en-GB-Neural2-C",display:"UK Female 2 - Neural2"},{name:"en-GB-Neural2-D",display:"UK Male 2 - Neural2"},{name:"en-GB-Neural2-F",display:"UK Female 3 - Neural2"}],zh:[{name:"cmn-CN-Standard-A",display:"CN Female 1 - Standard"},{name:"cmn-CN-Standard-B",display:"CN Male 1 - Standard"},{name:"cmn-CN-Standard-C",display:"CN Male 2 - Standard"},{name:"cmn-CN-Standard-D",display:"CN Female 2 - Standard"},{name:"cmn-CN-Wavenet-A",display:"CN Female 1 - Wavenet"},{name:"cmn-CN-Wavenet-B",display:"CN Male 1 - Wavenet"},{name:"cmn-CN-Wavenet-C",display:"CN Male 2 - Wavenet"},{name:"cmn-CN-Wavenet-D",display:"CN Female 2 - Wavenet"},{name:"cmn-CN-Neural2-A",display:"CN Female 1 - Neural2"},{name:"cmn-CN-Neural2-B",display:"CN Male 1 - Neural2"},{name:"cmn-CN-Neural2-C",display:"CN Male 2 - Neural2"},{name:"cmn-CN-Neural2-D",display:"CN Female 2 - Neural2"},{name:"cmn-TW-Standard-A",display:"TW Female 1 - Standard"},{name:"cmn-TW-Standard-B",display:"TW Male 1 - Standard"},{name:"cmn-TW-Standard-C",display:"TW Male 2 - Standard"},{name:"cmn-TW-Wavenet-A",display:"TW Female 1 - Wavenet"},{name:"cmn-TW-Wavenet-B",display:"TW Male 1 - Wavenet"},{name:"cmn-TW-Wavenet-C",display:"TW Male 2 - Wavenet"},{name:"cmn-TW-Neural2-A",display:"TW Female 1 - Neural2"},{name:"cmn-TW-Neural2-B",display:"TW Male 1 - Neural2"},{name:"cmn-TW-Neural2-C",display:"TW Male 2 - Neural2"}],ja:[{name:"ja-JP-Standard-A",display:"JP Female 1 - Standard"},{name:"ja-JP-Standard-B",display:"JP Female 2 - Standard"},{name:"ja-JP-Standard-C",display:"JP Male 1 - Standard"},{name:"ja-JP-Standard-D",display:"JP Male 2 - Standard"},{name:"ja-JP-Wavenet-A",display:"JP Female 1 - Wavenet"},{name:"ja-JP-Wavenet-B",display:"JP Female 2 - Wavenet"},{name:"ja-JP-Wavenet-C",display:"JP Male 1 - Wavenet"},{name:"ja-JP-Wavenet-D",display:"JP Male 2 - Wavenet"},{name:"ja-JP-Neural2-A",display:"JP Female 1 - Neural2"},{name:"ja-JP-Neural2-B",display:"JP Female 2 - Neural2"},{name:"ja-JP-Neural2-C",display:"JP Male 1 - Neural2"},{name:"ja-JP-Neural2-D",display:"JP Male 2 - Neural2"}],ko:[{name:"ko-KR-Standard-A",display:"KR Female 1 - Standard"},{name:"ko-KR-Standard-B",display:"KR Female 2 - Standard"},{name:"ko-KR-Standard-C",display:"KR Male 1 - Standard"},{name:"ko-KR-Standard-D",display:"KR Male 2 - Standard"},{name:"ko-KR-Wavenet-A",display:"KR Female 1 - Wavenet"},{name:"ko-KR-Wavenet-B",display:"KR Female 2 - Wavenet"},{name:"ko-KR-Wavenet-C",display:"KR Male 1 - Wavenet"},{name:"ko-KR-Wavenet-D",display:"KR Male 2 - Wavenet"},{name:"ko-KR-Neural2-A",display:"KR Female 1 - Neural2"},{name:"ko-KR-Neural2-B",display:"KR Female 2 - Neural2"},{name:"ko-KR-Neural2-C",display:"KR Male 1 - Neural2"},{name:"ko-KR-Neural2-D",display:"KR Male 2 - Neural2"}],fr:[{name:"fr-FR-Standard-A",display:"FR Female 1 - Standard"},{name:"fr-FR-Standard-B",display:"FR Male 1 - Standard"},{name:"fr-FR-Standard-C",display:"FR Female 2 - Standard"},{name:"fr-FR-Standard-D",display:"FR Male 2 - Standard"},{name:"fr-FR-Standard-E",display:"FR Female 3 - Standard"},{name:"fr-FR-Wavenet-A",display:"FR Female 1 - Wavenet"},{name:"fr-FR-Wavenet-B",display:"FR Male 1 - Wavenet"},{name:"fr-FR-Wavenet-C",display:"FR Female 2 - Wavenet"},{name:"fr-FR-Wavenet-D",display:"FR Male 2 - Wavenet"},{name:"fr-FR-Wavenet-E",display:"FR Female 3 - Wavenet"},{name:"fr-FR-Neural2-A",display:"FR Female 1 - Neural2"},{name:"fr-FR-Neural2-B",display:"FR Male 1 - Neural2"},{name:"fr-FR-Neural2-C",display:"FR Female 2 - Neural2"},{name:"fr-FR-Neural2-D",display:"FR Male 2 - Neural2"},{name:"fr-FR-Neural2-E",display:"FR Female 3 - Neural2"}],de:[{name:"de-DE-Standard-A",display:"DE Female 1 - Standard"},{name:"de-DE-Standard-B",display:"DE Male 1 - Standard"},{name:"de-DE-Standard-C",display:"DE Female 2 - Standard"},{name:"de-DE-Standard-D",display:"DE Male 2 - Standard"},{name:"de-DE-Standard-E",display:"DE Male 3 - Standard"},{name:"de-DE-Standard-F",display:"DE Female 3 - Standard"},{name:"de-DE-Wavenet-A",display:"DE Female 1 - Wavenet"},{name:"de-DE-Wavenet-B",display:"DE Male 1 - Wavenet"},{name:"de-DE-Wavenet-C",display:"DE Female 2 - Wavenet"},{name:"de-DE-Wavenet-D",display:"DE Male 2 - Wavenet"},{name:"de-DE-Wavenet-E",display:"DE Male 3 - Wavenet"},{name:"de-DE-Wavenet-F",display:"DE Female 3 - Wavenet"},{name:"de-DE-Neural2-A",display:"DE Female 1 - Neural2"},{name:"de-DE-Neural2-B",display:"DE Male 1 - Neural2"},{name:"de-DE-Neural2-C",display:"DE Female 2 - Neural2"},{name:"de-DE-Neural2-D",display:"DE Male 2 - Neural2"},{name:"de-DE-Neural2-E",display:"DE Male 3 - Neural2"},{name:"de-DE-Neural2-F",display:"DE Female 3 - Neural2"}],es:[{name:"es-ES-Standard-A",display:"ES Female 1 - Standard"},{name:"es-ES-Standard-B",display:"ES Male 1 - Standard"},{name:"es-ES-Standard-C",display:"ES Female 2 - Standard"},{name:"es-ES-Standard-D",display:"ES Male 2 - Standard"},{name:"es-ES-Wavenet-A",display:"ES Female 1 - Wavenet"},{name:"es-ES-Wavenet-B",display:"ES Male 1 - Wavenet"},{name:"es-ES-Wavenet-C",display:"ES Female 2 - Wavenet"},{name:"es-ES-Wavenet-D",display:"ES Male 2 - Wavenet"},{name:"es-ES-Neural2-A",display:"ES Female 1 - Neural2"},{name:"es-ES-Neural2-B",display:"ES Male 1 - Neural2"},{name:"es-ES-Neural2-C",display:"ES Female 2 - Neural2"},{name:"es-ES-Neural2-D",display:"ES Male 2 - Neural2"},{name:"es-US-Standard-A",display:"ES-US Female 1 - Standard"},{name:"es-US-Standard-B",display:"ES-US Male 1 - Standard"},{name:"es-US-Standard-C",display:"ES-US Male 2 - Standard"},{name:"es-US-Wavenet-A",display:"ES-US Female 1 - Wavenet"},{name:"es-US-Wavenet-B",display:"ES-US Male 1 - Wavenet"},{name:"es-US-Wavenet-C",display:"ES-US Male 2 - Wavenet"},{name:"es-US-Neural2-A",display:"ES-US Female 1 - Neural2"},{name:"es-US-Neural2-B",display:"ES-US Male 1 - Neural2"},{name:"es-US-Neural2-C",display:"ES-US Male 2 - Neural2"}],it:[{name:"it-IT-Standard-A",display:"IT Female 1 - Standard"},{name:"it-IT-Standard-B",display:"IT Female 2 - Standard"},{name:"it-IT-Standard-C",display:"IT Male 1 - Standard"},{name:"it-IT-Standard-D",display:"IT Male 2 - Standard"},{name:"it-IT-Wavenet-A",display:"IT Female 1 - Wavenet"},{name:"it-IT-Wavenet-B",display:"IT Female 2 - Wavenet"},{name:"it-IT-Wavenet-C",display:"IT Male 1 - Wavenet"},{name:"it-IT-Wavenet-D",display:"IT Male 2 - Wavenet"},{name:"it-IT-Neural2-A",display:"IT Female 1 - Neural2"},{name:"it-IT-Neural2-B",display:"IT Female 2 - Neural2"},{name:"it-IT-Neural2-C",display:"IT Male 1 - Neural2"},{name:"it-IT-Neural2-D",display:"IT Male 2 - Neural2"}],ru:[{name:"ru-RU-Standard-A",display:"RU Female 1 - Standard"},{name:"ru-RU-Standard-B",display:"RU Male 1 - Standard"},{name:"ru-RU-Standard-C",display:"RU Female 2 - Standard"},{name:"ru-RU-Standard-D",display:"RU Male 2 - Standard"},{name:"ru-RU-Standard-E",display:"RU Female 3 - Standard"},{name:"ru-RU-Wavenet-A",display:"RU Female 1 - Wavenet"},{name:"ru-RU-Wavenet-B",display:"RU Male 1 - Wavenet"},{name:"ru-RU-Wavenet-C",display:"RU Female 2 - Wavenet"},{name:"ru-RU-Wavenet-D",display:"RU Male 2 - Wavenet"},{name:"ru-RU-Wavenet-E",display:"RU Female 3 - Wavenet"}],pt:[{name:"pt-BR-Standard-A",display:"PT-BR Female 1 - Standard"},{name:"pt-BR-Standard-B",display:"PT-BR Male 1 - Standard"},{name:"pt-BR-Standard-C",display:"PT-BR Female 2 - Standard"},{name:"pt-BR-Wavenet-A",display:"PT-BR Female 1 - Wavenet"},{name:"pt-BR-Wavenet-B",display:"PT-BR Male 1 - Wavenet"},{name:"pt-BR-Wavenet-C",display:"PT-BR Female 2 - Wavenet"},{name:"pt-BR-Neural2-A",display:"PT-BR Female 1 - Neural2"},{name:"pt-BR-Neural2-B",display:"PT-BR Male 1 - Neural2"},{name:"pt-BR-Neural2-C",display:"PT-BR Female 2 - Neural2"},{name:"pt-PT-Standard-A",display:"PT-PT Female 1 - Standard"},{name:"pt-PT-Standard-B",display:"PT-PT Male 1 - Standard"},{name:"pt-PT-Standard-C",display:"PT-PT Male 2 - Standard"},{name:"pt-PT-Standard-D",display:"PT-PT Female 2 - Standard"},{name:"pt-PT-Wavenet-A",display:"PT-PT Female 1 - Wavenet"},{name:"pt-PT-Wavenet-B",display:"PT-PT Male 1 - Wavenet"},{name:"pt-PT-Wavenet-C",display:"PT-PT Male 2 - Wavenet"},{name:"pt-PT-Wavenet-D",display:"PT-PT Female 2 - Wavenet"}],nl:[{name:"nl-NL-Standard-A",display:"NL Female 1 - Standard"},{name:"nl-NL-Standard-B",display:"NL Male 1 - Standard"},{name:"nl-NL-Standard-C",display:"NL Male 2 - Standard"},{name:"nl-NL-Standard-D",display:"NL Female 2 - Standard"},{name:"nl-NL-Standard-E",display:"NL Female 3 - Standard"},{name:"nl-NL-Wavenet-A",display:"NL Female 1 - Wavenet"},{name:"nl-NL-Wavenet-B",display:"NL Male 1 - Wavenet"},{name:"nl-NL-Wavenet-C",display:"NL Male 2 - Wavenet"},{name:"nl-NL-Wavenet-D",display:"NL Female 2 - Wavenet"},{name:"nl-NL-Wavenet-E",display:"NL Female 3 - Wavenet"}],pl:[{name:"pl-PL-Standard-A",display:"PL Female 1 - Standard"},{name:"pl-PL-Standard-B",display:"PL Male 1 - Standard"},{name:"pl-PL-Standard-C",display:"PL Male 2 - Standard"},{name:"pl-PL-Standard-D",display:"PL Female 2 - Standard"},{name:"pl-PL-Standard-E",display:"PL Female 3 - Standard"},{name:"pl-PL-Wavenet-A",display:"PL Female 1 - Wavenet"},{name:"pl-PL-Wavenet-B",display:"PL Male 1 - Wavenet"},{name:"pl-PL-Wavenet-C",display:"PL Male 2 - Wavenet"},{name:"pl-PL-Wavenet-D",display:"PL Female 2 - Wavenet"},{name:"pl-PL-Wavenet-E",display:"PL Female 3 - Wavenet"}],tr:[{name:"tr-TR-Standard-A",display:"TR Female 1 - Standard"},{name:"tr-TR-Standard-B",display:"TR Male 1 - Standard"},{name:"tr-TR-Standard-C",display:"TR Female 2 - Standard"},{name:"tr-TR-Standard-D",display:"TR Female 3 - Standard"},{name:"tr-TR-Standard-E",display:"TR Male 2 - Standard"},{name:"tr-TR-Wavenet-A",display:"TR Female 1 - Wavenet"},{name:"tr-TR-Wavenet-B",display:"TR Male 1 - Wavenet"},{name:"tr-TR-Wavenet-C",display:"TR Female 2 - Wavenet"},{name:"tr-TR-Wavenet-D",display:"TR Female 3 - Wavenet"},{name:"tr-TR-Wavenet-E",display:"TR Male 2 - Wavenet"}],ar:[{name:"ar-XA-Standard-A",display:"AR Female 1 - Standard"},{name:"ar-XA-Standard-B",display:"AR Male 1 - Standard"},{name:"ar-XA-Standard-C",display:"AR Male 2 - Standard"},{name:"ar-XA-Standard-D",display:"AR Female 2 - Standard"},{name:"ar-XA-Wavenet-A",display:"AR Female 1 - Wavenet"},{name:"ar-XA-Wavenet-B",display:"AR Male 1 - Wavenet"},{name:"ar-XA-Wavenet-C",display:"AR Male 2 - Wavenet"},{name:"ar-XA-Wavenet-D",display:"AR Female 2 - Wavenet"}],th:[{name:"th-TH-Standard-A",display:"TH Female 1 - Standard"},{name:"th-TH-Neural2-C",display:"TH Female 2 - Neural2"}],hi:[{name:"hi-IN-Standard-A",display:"HI Female 1 - Standard"},{name:"hi-IN-Standard-B",display:"HI Female 2 - Standard"},{name:"hi-IN-Standard-C",display:"HI Male 1 - Standard"},{name:"hi-IN-Standard-D",display:"HI Male 2 - Standard"},{name:"hi-IN-Wavenet-A",display:"HI Female 1 - Wavenet"},{name:"hi-IN-Wavenet-B",display:"HI Female 2 - Wavenet"},{name:"hi-IN-Wavenet-C",display:"HI Male 1 - Wavenet"},{name:"hi-IN-Wavenet-D",display:"HI Male 2 - Wavenet"}],id:[{name:"id-ID-Standard-A",display:"ID Female 1 - Standard"},{name:"id-ID-Standard-B",display:"ID Male 1 - Standard"},{name:"id-ID-Standard-C",display:"ID Male 2 - Standard"},{name:"id-ID-Standard-D",display:"ID Female 2 - Standard"},{name:"id-ID-Wavenet-A",display:"ID Female 1 - Wavenet"},{name:"id-ID-Wavenet-B",display:"ID Male 1 - Wavenet"},{name:"id-ID-Wavenet-C",display:"ID Male 2 - Wavenet"},{name:"id-ID-Wavenet-D",display:"ID Female 2 - Wavenet"}],ms:[{name:"ms-MY-Standard-A",display:"MS Female 1 - Standard"},{name:"ms-MY-Standard-B",display:"MS Male 1 - Standard"},{name:"ms-MY-Standard-C",display:"MS Female 2 - Standard"},{name:"ms-MY-Standard-D",display:"MS Male 2 - Standard"}],fil:[{name:"fil-PH-Standard-A",display:"FIL Female 1 - Standard"},{name:"fil-PH-Standard-B",display:"FIL Female 2 - Standard"},{name:"fil-PH-Standard-C",display:"FIL Male 1 - Standard"},{name:"fil-PH-Standard-D",display:"FIL Male 2 - Standard"},{name:"fil-PH-Wavenet-A",display:"FIL Female 1 - Wavenet"},{name:"fil-PH-Wavenet-B",display:"FIL Female 2 - Wavenet"},{name:"fil-PH-Wavenet-C",display:"FIL Male 1 - Wavenet"},{name:"fil-PH-Wavenet-D",display:"FIL Male 2 - Wavenet"}],cs:[{name:"cs-CZ-Standard-A",display:"CS Female 1 - Standard"},{name:"cs-CZ-Wavenet-A",display:"CS Female 1 - Wavenet"}],el:[{name:"el-GR-Standard-A",display:"EL Female 1 - Standard"},{name:"el-GR-Wavenet-A",display:"EL Female 1 - Wavenet"}],hu:[{name:"hu-HU-Standard-A",display:"HU Female 1 - Standard"},{name:"hu-HU-Wavenet-A",display:"HU Female 1 - Wavenet"}],da:[{name:"da-DK-Standard-A",display:"DA Female 1 - Standard"},{name:"da-DK-Standard-C",display:"DA Male 1 - Standard"},{name:"da-DK-Standard-D",display:"DA Female 2 - Standard"},{name:"da-DK-Standard-E",display:"DA Female 3 - Standard"},{name:"da-DK-Wavenet-A",display:"DA Female 1 - Wavenet"},{name:"da-DK-Wavenet-C",display:"DA Male 1 - Wavenet"},{name:"da-DK-Wavenet-D",display:"DA Female 2 - Wavenet"},{name:"da-DK-Wavenet-E",display:"DA Female 3 - Wavenet"}],fi:[{name:"fi-FI-Standard-A",display:"FI Female 1 - Standard"},{name:"fi-FI-Wavenet-A",display:"FI Female 1 - Wavenet"}],nb:[{name:"nb-NO-Standard-A",display:"NB Female 1 - Standard"},{name:"nb-NO-Standard-B",display:"NB Male 1 - Standard"},{name:"nb-NO-Standard-C",display:"NB Female 2 - Standard"},{name:"nb-NO-Standard-D",display:"NB Male 2 - Standard"},{name:"nb-NO-Standard-E",display:"NB Female 3 - Standard"},{name:"nb-NO-Wavenet-A",display:"NB Female 1 - Wavenet"},{name:"nb-NO-Wavenet-B",display:"NB Male 1 - Wavenet"},{name:"nb-NO-Wavenet-C",display:"NB Female 2 - Wavenet"},{name:"nb-NO-Wavenet-D",display:"NB Male 2 - Wavenet"},{name:"nb-NO-Wavenet-E",display:"NB Female 3 - Wavenet"}],sv:[{name:"sv-SE-Standard-A",display:"SV Female 1 - Standard"},{name:"sv-SE-Standard-B",display:"SV Female 2 - Standard"},{name:"sv-SE-Standard-C",display:"SV Male 1 - Standard"},{name:"sv-SE-Standard-D",display:"SV Male 2 - Standard"},{name:"sv-SE-Standard-E",display:"SV Female 3 - Standard"},{name:"sv-SE-Wavenet-A",display:"SV Female 1 - Wavenet"},{name:"sv-SE-Wavenet-B",display:"SV Female 2 - Wavenet"},{name:"sv-SE-Wavenet-C",display:"SV Male 1 - Wavenet"},{name:"sv-SE-Wavenet-D",display:"SV Male 2 - Wavenet"},{name:"sv-SE-Wavenet-E",display:"SV Female 3 - Wavenet"}]}}},LANGUAGEDISPLAY:{vi:{name:"vi",display:"Tiếng Việt"},en:{name:"en",display:"English"},"en-US":{name:"en-US",display:"English (US)"},"en-GB":{name:"en-GB",display:"English (UK)"},"en-AU":{name:"en-AU",display:"English (Australia)"},zh:{name:"zh",display:"中文"},"zh-CN":{name:"zh-CN",display:"中文 (简体)"},"zh-TW":{name:"zh-TW",display:"中文 (繁體)"},"zh-HK":{name:"zh-HK",display:"中文 (香港)"},ja:{name:"ja",display:"日本語"},ko:{name:"ko",display:"한국어"},fr:{name:"fr",display:"Français"},"fr-FR":{name:"fr-FR",display:"Français (France)"},"fr-CA":{name:"fr-CA",display:"Français (Canada)"},de:{name:"de",display:"Deutsch"},"de-DE":{name:"de-DE",display:"Deutsch (Deutschland)"},"de-AT":{name:"de-AT",display:"Deutsch (Österreich)"},"de-CH":{name:"de-CH",display:"Deutsch (Schweiz)"},es:{name:"es",display:"Español"},"es-ES":{name:"es-ES",display:"Español (España)"},"es-MX":{name:"es-MX",display:"Español (México)"},"es-US":{name:"es-US",display:"Español (Estados Unidos)"},it:{name:"it",display:"Italiano"},ru:{name:"ru",display:"Русский"},pt:{name:"pt",display:"Português"},"pt-BR":{name:"pt-BR",display:"Português (Brasil)"},"pt-PT":{name:"pt-PT",display:"Português (Portugal)"},nl:{name:"nl",display:"Nederlands"},pl:{name:"pl",display:"Polski"},tr:{name:"tr",display:"Türkçe"},ar:{name:"ar",display:"العربية"},th:{name:"th",display:"ไทย"},hi:{name:"hi",display:"हिन्दी"},id:{name:"id",display:"Indonesia"},ms:{name:"ms",display:"Melayu"},fil:{name:"fil",display:"Filipino"},"es-AR":{name:"es-AR",display:"Español (Argentina)"},"es-BO":{name:"es-BO",display:"Español (Bolivia)"},"es-CL":{name:"es-CL",display:"Español (Chile)"},"es-CO":{name:"es-CO",display:"Español (Colombia)"},"es-CR":{name:"es-CR",display:"Español (Costa Rica)"},"es-CU":{name:"es-CU",display:"Español (Cuba)"},"es-DO":{name:"es-DO",display:"Español (República Dominicana)"},"es-EC":{name:"es-EC",display:"Español (Ecuador)"},"es-SV":{name:"es-SV",display:"Español (El Salvador)"},"es-GT":{name:"es-GT",display:"Español (Guatemala)"},"es-HN":{name:"es-HN",display:"Español (Honduras)"},"es-NI":{name:"es-NI",display:"Español (Nicaragua)"},"es-PA":{name:"es-PA",display:"Español (Panamá)"},"es-PY":{name:"es-PY",display:"Español (Paraguay)"},"es-PE":{name:"es-PE",display:"Español (Perú)"},"es-PR":{name:"es-PR",display:"Español (Puerto Rico)"},"es-UY":{name:"es-UY",display:"Español (Uruguay)"},"es-VE":{name:"es-VE",display:"Español (Venezuela)"},"ar-AE":{name:"ar-AE",display:"العربية (الإمارات)"},"ar-BH":{name:"ar-BH",display:"العربية (البحرين)"},"ar-DZ":{name:"ar-DZ",display:"العربية (الجزائر)"},"ar-EG":{name:"ar-EG",display:"العربية (مصر)"},"ar-IQ":{name:"ar-IQ",display:"العربية (العراق)"},"ar-JO":{name:"ar-JO",display:"العربية (الأردن)"},"ar-KW":{name:"ar-KW",display:"العربية (الكويت)"},"ar-LB":{name:"ar-LB",display:"العربية (لبنان)"},"ar-LY":{name:"ar-LY",display:"العربية (ليبيا)"},"ar-MA":{name:"ar-MA",display:"العربية (المغرب)"},"ar-OM":{name:"ar-OM",display:"العربية (عُمان)"},"ar-QA":{name:"ar-QA",display:"العربية (قطر)"},"ar-SA":{name:"ar-SA",display:"العربية (السعودية)"},"ar-SY":{name:"ar-SY",display:"العربية (سوريا)"},"ar-TN":{name:"ar-TN",display:"العربية (تونس)"},"ar-YE":{name:"ar-YE",display:"العربية (اليمن)"},"bn-BD":{name:"bn-BD",display:"বাংলা (বাংলাদেশ)"},"bn-IN":{name:"bn-IN",display:"বাংলা (ভারত)"},gu:{name:"gu",display:"ગુજરાતી"},kn:{name:"kn",display:"ಕನ್ನಡ"},ml:{name:"ml",display:"മലയാളം"},mr:{name:"mr",display:"मराठी"},ne:{name:"ne",display:"नेपाली"},pa:{name:"pa",display:"ਪੰਜਾਬੀ"},si:{name:"si",display:"සිංහල"},ta:{name:"ta",display:"தமிழ்"},te:{name:"te",display:"తెలుగు"},ur:{name:"ur",display:"اردو"},km:{name:"km",display:"ខ្មែរ"},lo:{name:"lo",display:"ລາວ"},my:{name:"my",display:"မြန်မာ"},bg:{name:"bg",display:"Български"},ca:{name:"ca",display:"Català"},hr:{name:"hr",display:"Hrvatski"},is:{name:"is",display:"Íslenska"},lv:{name:"lv",display:"Latviešu"},lt:{name:"lt",display:"Lietuvių"},ro:{name:"ro",display:"Română"},sk:{name:"sk",display:"Slovenčina"},sl:{name:"sl",display:"Slovenščina"},sr:{name:"sr",display:"Српски"},uk:{name:"uk",display:"Українська"},cs:{name:"cs",display:"Čeština"},el:{name:"el",display:"Ελληνικά"},hu:{name:"hu",display:"Magyar"},da:{name:"da",display:"Dansk"},fi:{name:"fi",display:"Suomi"},nb:{name:"nb",display:"Norsk Bokmål"},sv:{name:"sv",display:"Svenska"}},LANGUAGES:{ar:"Arabic",bg:"Bulgarian",bn:"Bengali",ca:"Catalan",cs:"Czech",da:"Danish",de:"German",el:"Greek",en:"English",es:"Spanish",et:"Estonian",fa:"Farsi",fi:"Finnish",fr:"French",gu:"Gujarati",he:"Hebrew",hi:"Hindi",hr:"Croatian",hu:"Hungarian",id:"Indonesian",it:"Italian",ja:"Japanese",kn:"Kannada",ko:"Korean",lt:"Lithuanian",lv:"Latvian",ml:"Malayalam",mr:"Marathi",ms:"Malay",nb:"Norwegian Bokmål",nl:"Dutch",pl:"Polish",pt:"Portuguese",ro:"Romanian",ru:"Russian",sk:"Slovak",sl:"Slovenian",sr:"Serbian",sv:"Swedish",sw:"Swahili",ta:"Tamil",te:"Telugu",th:"Thai",tl:"Tagalog",tr:"Turkish",uk:"Ukrainian",ur:"Urdu",vi:"Vietnamese",zh:"Chinese (Simplified)","zh-TW":"Chinese (Traditional)"},OCR:{generation:{temperature:.6,topP:.8,topK:30},maxFileSize:2147483648,supportedFormats:["image/jpeg","image/png","image/webp","image/heic","image/heif"]},MEDIA:{generation:{temperature:.6,topP:.8,topK:30},audio:{maxSize:2147483648,supportedFormats:["audio/wav","audio/mp3","audio/ogg","audio/m4a","audio/aac","audio/flac","audio/wma","audio/opus","audio/amr","audio/midi","audio/mpa"]},video:{maxSize:2147483648,supportedFormats:["video/mp4","video/webm","video/ogg","video/x-msvideo","video/quicktime","video/x-ms-wmv","video/x-flv","video/3gpp","video/3gpp2","video/x-matroska"]}},VIDEO_STREAMING:{enabled:!0,supportedSites:["youtube.com","udemy.com"],styles:{subtitleContainer:{position:"absolute",bottom:"2%",left:"50%",transform:"translateX(-50%)",textAlign:"center",zIndex:2147483647,padding:"5px 10px",borderRadius:"5px",backgroundColor:"rgba(0,0,0,0.7)",color:"white",fontSize:"clamp(1rem, 1.5cqw, 2.5rem)",fontFamily:"'GoMono Nerd Font', 'Noto Sans', Arial",textShadow:"2px 2px 2px rgba(0,0,0,0.5)",maxWidth:"90%"}}},contextMenu:{enabled:!0},pageTranslation:{enabled:!0,autoTranslate:!1,showInitialButton:!1,buttonTimeout:1e4,enableGoogleTranslate:!1,googleTranslateLayout:"INLINE",useCustomSelectors:!1,customSelectors:[],defaultSelectors:["script","code","style","input","button","textarea",".notranslate",".translator-settings-container",".translator-tools-container",".translator-content",".draggable",".page-translate-button",".translator-tools-dropdown",".translator-notification",".translator-content",".translator-context-menu",".translator-overlay",".translator-guide",".center-translate-status",".no-translate","[data-notranslate]","[translate='no']",".html5-player-chrome",".html5-video-player"],generation:{temperature:.6,topP:.8,topK:30}},promptSettings:{enabled:!0,customPrompts:{normal:"",advanced:"",chinese:"",ocr:"",media:"",page:"",file_content:"",normal_chinese:"",advanced_chinese:"",chinese_chinese:"",ocr_chinese:"",media_chinese:"",page_chinese:"",file_content_chinese:""},useCustom:!1},CACHE:{text:{maxSize:100,expirationTime:3e5},image:{maxSize:50,expirationTime:18e5},media:{maxSize:50,expirationTime:18e5},tts:{maxSize:50,expirationTime:18e5}},RATE_LIMIT:{maxRequests:5,perMilliseconds:1e4},THEME:{mode:"dark",light:{background:"#cccccc",backgroundShadow:"rgba(255, 255, 255, 0.05)",text:"#333333",border:"#bbb",title:"#202020",content:"#555",button:{close:{background:"#ff4444",text:"#ddd"},translate:{background:"#007BFF",text:"#ddd"}}},dark:{background:"#333333",backgroundShadow:"rgba(0, 0, 0, 0.05)",text:"#cccccc",border:"#555",title:"#eeeeee",content:"#bbb",button:{close:{background:"#aa2222",text:"#ddd"},translate:{background:"#004a99",text:"#ddd"}}}},STYLES:{translation:{marginTop:"10px",padding:"10px",backgroundColor:"#f0f0f0",borderLeft:"3px solid #4CAF50",borderRadius:"8px",color:"#333",position:"relative",fontFamily:"'GoMono Nerd Font', 'Noto Sans', Arial",fontSize:"16px",zIndex:"2147483647"},popup:{position:"fixed",border:"1px solid",padding:"20px",zIndex:"2147483647",maxWidth:"90vw",minWidth:"300px",maxHeight:"80vh",boxShadow:"0 0 10px rgba(0, 0, 0, 0.1)",borderRadius:"15px",fontFamily:"'GoMono Nerd Font', 'Noto Sans', Arial",fontSize:"16px",top:window.innerHeight/2+"px",left:window.innerWidth/2+"px",transform:"translate(-50%, -50%)",display:"flex",flexDirection:"column",overflowY:"auto"},button:{position:"fixed",border:"none",borderRadius:"8px",padding:"5px 10px",cursor:"pointer",zIndex:"2147483647",fontSize:"14px"},dragHandle:{padding:"10px",borderBottom:"1px solid",cursor:"move",userSelect:"none",display:"flex",justifyContent:"space-between",alignItems:"center",borderTopLeftRadius:"15px",borderTopRightRadius:"15px",zIndex:"2147483647"}}},r={uiLanguage:"en",theme:o.THEME.mode,apiProvider:o.API.currentProvider,apiKey:{gemini:[""],perplexity:[""],claude:[""],openai:[""],mistral:[""],deepseek:[""]},currentKeyIndex:{gemini:0,perplexity:0,claude:0,openai:0,mistral:0,deepseek:0},geminiOptions:{modelType:"fast",fastModel:"gemini-2.0-flash-lite",proModel:"gemini-2.0-pro-exp-02-05",thinkModel:"gemini-2.0-flash-thinking-exp-01-21",customModel:""},perplexityOptions:{modelType:"fast",fastModel:"sonar",balanceModel:"sonar-deep-research",proModel:"sonar-pro",customModel:""},claudeOptions:{modelType:"balance",fastModel:"claude-3-5-haiku-latest",balanceModel:"claude-3-7-sonnet-latest",proModel:"claude-3-opus-latest",customModel:""},openaiOptions:{modelType:"fast",fastModel:"gpt-4.1-nano",balanceModel:"gpt-4.1",proModel:"o1-pro",customModel:""},mistralOptions:{modelType:"free",freeModel:"mistral-small-latest",researchModel:"open-mistral-nemo",premierModel:"codestral-latest",customModel:""},deepseekOptions:{modelType:"fast",fastModel:"deepseek-chat",customModel:""},ollamaOptions:{endpoint:"http://localhost:11434",model:"llama3"},contextMenu:{enabled:!0},promptSettings:{enabled:!0,customPrompts:{normal:"",advanced:"",chinese:"",ocr:"",media:"",page:"",file_content:"",normal_chinese:"",advanced_chinese:"",chinese_chinese:"",ocr_chinese:"",media_chinese:"",page_chinese:"",file_content_chinese:""},useCustom:!1},inputTranslation:{enabled:!1,savePosition:!0,excludeSelectors:[]},translatorTools:{enabled:!0},pageTranslation:{enabled:!0,autoTranslate:!1,showInitialButton:!1,buttonTimeout:1e4,enableGoogleTranslate:!1,googleTranslateLayout:"INLINE",useCustomSelectors:!1,customSelectors:[],defaultSelectors:o.pageTranslation.defaultSelectors,generation:{temperature:.6,topP:.8,topK:30}},ocrOptions:{enabled:!0,mangaTranslateAll:!0,preferredProvider:o.API.currentProvider,maxFileSize:o.OCR.maxFileSize,temperature:o.OCR.generation.temperature,topP:o.OCR.generation.topP,topK:o.OCR.generation.topK},mediaOptions:{enabled:!0,temperature:o.MEDIA.generation.temperature,topP:o.MEDIA.generation.topP,topK:o.MEDIA.generation.topK,audio:{processingInterval:2e3,bufferSize:16384,format:{sampleRate:44100,numChannels:1,bitsPerSample:16}}},videoStreamingOptions:{enabled:!1,fontSize:"clamp(1rem, 1.5cqw, 2.5rem)",backgroundColor:"rgba(0,0,0,0.7)",textColor:"white"},displayOptions:{fontSize:"1rem",minPopupWidth:"300px",maxPopupWidth:"90vw",webImageTranslation:{fontSize:"auto",minFontSize:"8px",maxFontSize:"24px"},translationMode:"translation_only",sourceLanguage:"auto",targetLanguage:"vi",languageLearning:{showSource:!0}},ttsOptions:{enabled:!0,defaultProvider:"google",defaultGeminiModel:"gemini-2.5-flash-preview-tts",defaultModel:"tts-1",defaultSpeed:1,defaultPitch:1,defaultVolume:1,defaultVoice:{gemini:{voice:"Leda"},openai:{voice:"sage"},google:{vi:{name:"vi-VN-Standard-A",display:"Google Nữ (Bắc) - Standard"},en:{name:"en-US-Standard-A",display:"US Female 1 - Standard"},zh:{name:"cmn-CN-Standard-A",display:"CN Female 1 - Standard"},ja:{name:"ja-JP-Standard-A",display:"JP Female 1 - Standard"},ko:{name:"ko-KR-Standard-A",display:"KR Female 1 - Standard"}}}},shortcuts:{settingsEnabled:!0,enabled:!0,pageTranslate:{key:"f",altKey:!0},inputTranslate:{key:"t",altKey:!0},ocrRegion:{key:"z",altKey:!0},ocrWebImage:{key:"x",altKey:!0},ocrMangaWeb:{key:"c",altKey:!0},quickTranslate:{key:"q",altKey:!0},popupTranslate:{key:"e",altKey:!0},advancedTranslate:{key:"a",altKey:!0}},clickOptions:{enabled:!0,singleClick:{translateType:"popup"},doubleClick:{translateType:"quick"},hold:{translateType:"advanced"}},touchOptions:{enabled:!0,sensitivity:100,twoFingers:{translateType:"popup"},threeFingers:{translateType:"advanced"},fourFingers:{translateType:"quick"}},cacheOptions:{text:{enabled:!0,maxSize:o.CACHE.text.maxSize,expirationTime:o.CACHE.text.expirationTime},image:{enabled:!0,maxSize:o.CACHE.image.maxSize,expirationTime:o.CACHE.image.expirationTime},media:{enabled:!0,maxSize:o.CACHE.media.maxSize,expirationTime:o.CACHE.media.expirationTime},tts:{enabled:!0,maxSize:o.CACHE.tts.maxSize,expirationTime:o.CACHE.tts.expirationTime}},rateLimit:{maxRequests:o.RATE_LIMIT.maxRequests,perMilliseconds:o.RATE_LIMIT.perMilliseconds}};class l{constructor(t){this.ui=t,this.isMobile=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent),this.isMobile&&this.optimizeForMobile()}optimizeForMobile(){this.reduceDOMOperations(),this.optimizeTouchHandling(),this.adjustUIForMobile()}reduceDOMOperations(){new MutationObserver(t=>{requestAnimationFrame(()=>{t.forEach(t=>{"childList"===t.type&&this.optimizeAddedNodes(t.addedNodes)})})}).observe(document.body,{childList:!0,subtree:!0})}optimizeTouchHandling(){let t=0,e=0;document.addEventListener("touchstart",n=>{t=n.touches[0].clientY,e=n.touches[0].clientX},{passive:!0}),document.addEventListener("touchmove",n=>{const a=n.touches[0].clientY,i=n.touches[0].clientX;(Math.abs(a-t)>10||Math.abs(i-e)>10)&&this.ui.removeTranslateButton()},{passive:!0})}adjustUIForMobile(){const t=document.createElement("style");t.textContent="\n.translator-tools-container {\n  bottom: 25px;\n  right: 5px;\n}\n.translator-tools-button {\n  padding: 8px 15px;\n  font-size: 14px;\n}\n.translator-tools-dropdown {\n  min-width: 208px;\n  max-height: 90vh;\n  overflow-y: auto;\n}\n.translator-tools-item {\n  padding: 10px;\n}\n.draggable {\n  max-width: 95vw;\n  max-height: 80vh;\n}\n",this.ui.shadowRoot.appendChild(t)}optimizeAddedNodes(t){t.forEach(t=>{if(t.nodeType===Node.ELEMENT_NODE){const e=t.getElementsByTagName("img");Array.from(e).forEach(t=>{t.loading||(t.loading="lazy")})}})}}class c{constructor(t){if(this.translator=t,this.settings=this.loadSettings(),this.isSettingsUIOpen=!1,this.currentLanguage=o.LANG_DATA[this.settings.uiLanguage],!this.currentLanguage){const t=(navigator.language||navigator.userLanguage).startsWith("vi")?"vi":"en";this.currentLanguage=o.LANG_DATA[t],this.settings.uiLanguage=t,GM_setValue("translatorSettings",JSON.stringify(this.settings))}}_=(t,e={})=>{let n=t.split(".").reduce((t,e)=>t&&t[e],this.currentLanguage);void 0===n&&(console.warn(`Missing translation for key: ${t} in language ${this.settings.uiLanguage}`),n=t);for(const t in e)n=n.replace(`{${t}}`,e[t]);return n};createProviderRadios(t){return`\n  ${this.chunk([["gemini","Gemini"],["perplexity","Perplexity"],["claude","Claude"],["openai","OpenAI"],["mistral","Mistral"],["deepseek","Deepseek"],["ollama","Ollama"]],2).map(e=>`\n    <div class="radio-group">\n      ${e.map(([e,n])=>`\n        <label>\n          <input type="radio" name="apiProvider" value="${e}"\n            ${t.apiProvider===e?"checked":""}>\n          <span class="settings-label">${n}</span>\n        </label>\n      `).join("")}\n    </div>\n  `).join("")}\n`}createApiKeySection(t,e){const n=e.apiKey[t];return`\n  <div id="${t}Keys" style="margin-bottom: 10px;">\n    <h4 class="settings-label" style="margin-bottom: 5px;">${this.capitalize(t)} API Keys</h4>\n    <div class="api-keys-container">\n      ${n.map((e,n)=>`\n        <div class="api-key-entry" style="display: flex; gap: 10px; margin-bottom: 5px;">\n          <input type="text" class="${t}-key" value="${e}"\n            style="flex: 1; width: 100%; border-radius: 6px; margin-left: 5px;">\n          <button class="remove-key" data-provider="${t}" data-index="${n}"\n            style="background-color: #ff4444;">×</button>\n        </div>\n      `).join("")}\n    </div>\n    <button id="add-${t}-key" class="settings-label"\n      style="background-color: #28a745; border-radius: 5px; margin-top: 5px;">+ Add ${this.capitalize(t)} Key</button>\n  </div>\n`}createModelSection(t,e){if("ollama"===t){const t=e.ollamaOptions;return`\n  <div class="ollama-models" style="display: ${"ollama"===e.apiProvider?"":"none"}">\n    <div class="settings-grid">\n      <span class="settings-label">Ollama API Endpoint:</span>\n      <input type="text" id="ollama-endpoint" class="settings-input"\n        value="${t?.endpoint||"http://localhost:11434"}" placeholder="e.g., http://localhost:11434">\n    </div>\n    <div class="settings-grid">\n      <span class="settings-label">Model Name:</span>\n      <input type="text" id="ollama-custom-model" class="settings-input"\n        value="${t?.model||"llama3"}" placeholder="Enter model name (e.g., llama3)">\n    </div>\n     <div class="settings-grid">\n      <span class="settings-label">${this._("settings.temperature")}</span>\n      <input type="number" id="ollama-temperature" class="settings-input"\n        value="${t?.temperature??.6}" min="0" max="2" step="0.1">\n    </div>\n    <div class="settings-grid">\n      <span class="settings-label">${this._("settings.top_p")}</span>\n      <input type="number" id="ollama-top-p" class="settings-input"\n        value="${t?.topP??.8}" min="0" max="1" step="0.1">\n    </div>\n    <div class="settings-grid">\n      <span class="settings-label">${this._("settings.top_k")}</span>\n      <input type="number" id="ollama-top-k" class="settings-input"\n        value="${t?.topK??30}" min="1" max="100" step="1">\n    </div>\n  </div>\n`}const n=e[`${t}Options`],a=this.getModelTypesCss(t),i=o.API.providers[t].models;return`\n  <div class="${t}-models" style="display: ${e.apiProvider===t?"":"none"}">\n    <div class="settings-grid">\n      <span class="settings-label">${this._("settings.model_type")}</span>\n      <select id="${t}ModelType" class="settings-input">\n        ${a.map(([t,e])=>`\n          <option value="${t}" ${n?.modelType===t?"selected":""}>${e}</option>\n        `).join("")}\n      </select>\n    </div>\n    ${a.map(([e])=>"custom"!==e?`\n      <div id="${t}-${e}-container" class="settings-grid"\n        style="display: ${n?.modelType===e?"":"none"}">\n        <span class="settings-label">Model ${this.capitalize(e)}:</span>\n        <select id="${t}-${e}-model" class="settings-input">\n          ${(i[e]||[]).map(t=>`\n            <option value="${t}" ${n?.[`${e}Model`]===t?"selected":""}>\n              ${t}\n            </option>\n          `).join("")}\n        </select>\n      </div>\n    `:`\n      <div id="${t}-custom-container" class="settings-grid"\n        style="display: ${"custom"===n?.modelType?"":"none"}">\n        <span class="settings-label">Model tùy chỉnh:</span>\n        <input type="text" id="${t}-custom-model" class="settings-input"\n          value="${n?.customModel||""}" placeholder="Nhập tên model">\n      </div>\n    `).join("")}\n  </div>\n`}getModelTypesCss(t){const e={gemini:[["fast","Fast"],["pro","Pro"],["think","Thinking"]],mistral:[["free","Free"],["research","Research"],["premier","Premier"]],deepseek:[["fast","Fast"]],default:[["fast","Fast"],["balance","Balance"],["pro","Pro"]]};return[...e[t]||e.default,["custom","Custom"]]}getModelTypes(t){const e={gemini:["fast","pro","think"],mistral:["free","research","premier"],deepseek:["fast"],default:["fast","balance","pro"]};return[...e[t]||e.default,"custom"]}capitalize(t){return"openai"===t?"OpenAI":t.charAt(0).toUpperCase()+t.slice(1)}chunk(t,e){return Array.from({length:Math.ceil(t.length/e)},(n,a)=>t.slice(a*e,a*e+e))}renderSettingsUI(t){return`\n${this.createProviderRadios(t)}\n<div style="margin-bottom: 15px;">\n  <h3>API MODEL</h3>\n  ${["gemini","perplexity","claude","openai","mistral","deepseek","ollama"].map(e=>this.createModelSection(e,t)).join("")}\n</div>\n<div style="margin-bottom: 15px;">\n  <h3>API KEYS</h3>\n  ${["gemini","perplexity","claude","openai","mistral","deepseek"].map(e=>this.createApiKeySection(e,t)).join("")}\n</div>\n`}createSettingsUI(){if(this.isSettingsUIOpen)return;this.isSettingsUIOpen=!0;const e=document.createElement("div"),n="dark"===(this.settings.theme||o.THEME.mode),a=(t,e,n="")=>{const a=this.settings.ttsOptions?.defaultVoice?.[t];return"openai"===t||"gemini"===t?a?.voice?a.voice===e:e===("gemini"===t?"Leda":"sage"):a?.[n]?.name?a[n].name===e:e.endsWith("Wavenet-A")},i=(t,e)=>`\n        <label class="toggle-switch">\n          <input type="checkbox" id="${t}" ${e?"checked":""}>\n          <span class="slider"></span>\n        </label>\n      `,s=document.createElement("style");s.textContent=`\n        :host {\n          --bg-primary: ${n?"#2a2a3e":"#f5f7fa"};\n          --bg-secondary: ${n?"#1e1e2f":"#ffffff"};\n          --bg-tertiary: ${n?"#3c3c54":"#e9ecef"};\n          --text-primary: ${n?"#e0e0e0":"#212529"};\n          --text-secondary: ${n?"#b0b0b0":"#6c757d"};\n          --border-color: ${n?"#4a4a6a":"#dee2e6"};\n          --accent-primary: ${n?"#7f5af0":"#0d6efd"};\n          --accent-secondary: ${n?"#2cb67d":"#198754"};\n          --danger-color: ${n?"#f92672":"#dc3545"};\n          --shadow-color: ${n?"rgba(0,0,0,0.4)":"rgba(0,0,0,0.1)"};\n          --font-family: "GoMono Nerd Font", "Noto Sans", Arial, sans-serif;\n        }\n        * {\n          box-sizing: border-box;\n          font-family: var(--font-family);\n          margin: 0;\n          padding: 0;\n          scrollbar-width: thin;\n          scrollbar-color: var(--bg-tertiary) transparent;\n        }\n        *::-webkit-scrollbar { width: 8px; }\n        *::-webkit-scrollbar-track { background: transparent; }\n        *::-webkit-scrollbar-thumb { background-color: var(--bg-tertiary); border-radius: 4px; border: 2px solid var(--bg-primary); }\n        *::-webkit-scrollbar-thumb:hover { background-color: var(--text-secondary); }\n        .settings-container {\n        }\n        .settings-header {\n            padding: 1rem 1.5rem;\n            border-bottom: 1px solid var(--border-color);\n            flex-shrink: 0; /* Header không co lại */\n        }\n        .settings-wrapper {\n          display: flex;\n          gap: 1.5rem;\n          padding: 1.5rem;\n          flex: 1;\n          min-height: 0;\n          overflow: hidden;\n        }\n        /* --- Sidebar --- */\n        .settings-sidebar {\n          flex: 0 0 220px;\n          padding-right: 1.5rem;\n          border-right: 1px solid var(--border-color);\n          overflow-y: auto;\n          padding-bottom: 1rem;\n        }\n        .sidebar-title {\n          font-size: 1.2rem;\n          font-weight: 600;\n          color: var(--text-primary);\n          padding: 0 0.75rem 1rem;\n          display: flex;\n          align-items: center;\n          gap: 0.5rem;\n        }\n        .sidebar-nav {\n          list-style: none;\n          padding: 0;\n          margin: 0;\n        }\n        .sidebar-link {\n          display: block;\n          padding: 0.75rem;\n          margin-bottom: 0.25rem;\n          border-radius: 8px;\n          text-decoration: none;\n          color: var(--text-secondary);\n          font-weight: 500;\n          cursor: pointer;\n          transition: background-color 0.2s ease, color 0.2s ease;\n        }\n        .sidebar-link:hover {\n          background-color: var(--bg-tertiary);\n          color: var(--text-primary);\n        }\n        .sidebar-link.active {\n          background-color: var(--accent-primary);\n          color: white;\n          font-weight: 600;\n        }\n        /* --- Content Area --- */\n        .settings-content {\n          flex: 1;\n          min-width: 0;\n          overflow-y: auto;\n          padding-right: 1rem;\n          padding-bottom: 1rem;\n        }\n        .settings-section {\n          display: none;\n        }\n        .settings-section.active {\n          display: block;\n        }\n        .section-card {\n          background-color: var(--bg-secondary);\n          border: 1px solid var(--border-color);\n          border-radius: 12px;\n          padding: 1.5rem;\n          margin-bottom: 1.5rem;\n          box-shadow: 0 4px 12px var(--shadow-color);\n        }\n        h2 {\n          font-size: 1.5rem;\n          color: var(--text-primary);\n          margin-bottom: 1.5rem;\n          border-bottom: 1px solid var(--border-color);\n          padding-bottom: 1rem;\n        }\n        h3 {\n          font-size: 1.1rem;\n          font-weight: 600;\n          color: var(--text-primary);\n          margin: 1.5rem 0 1rem;\n        }\n        h3:first-child {\n          margin-top: 0;\n        }\n        /* --- Form Elements --- */\n        .settings-grid {\n          display: grid;\n          grid-template-columns: minmax(180px, 1fr) 2fr;\n          align-items: center;\n          gap: 1rem;\n          margin-bottom: 1rem;\n        }\n        .settings-label, .settings-grid > span {\n          color: var(--text-primary);\n          font-weight: 500;\n          justify-self: start;\n        }\n        .settings-input, input[type="text"], input[type="number"], select, textarea {\n          width: 100%;\n          padding: 0.6rem 0.8rem;\n          border-radius: 8px;\n          border: 1px solid var(--border-color);\n          background-color: var(--bg-primary);\n          color: var(--text-primary);\n          font-size: 0.9rem;\n          transition: border-color 0.2s ease, box-shadow 0.2s ease;\n        }\n        .settings-input:focus, input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus {\n          outline: none;\n          border-color: var(--accent-primary);\n          box-shadow: 0 0 0 3px ${n?"rgba(127, 90, 240, 0.3)":"rgba(13, 110, 253, 0.3)"};\n        }\n        textarea.prompt-textarea {\n          min-height: 120px;\n          resize: vertical;\n          font-family: monospace;\n        }\n        /* --- Toggle Switch --- */\n        .toggle-switch {\n          position: relative;\n          display: inline-block;\n          width: 44px;\n          height: 24px;\n          justify-self: start;\n        }\n        .toggle-switch input {\n          opacity: 0;\n          width: 0;\n          height: 0;\n        }\n        .slider {\n          position: absolute;\n          cursor: pointer;\n          top: 0;\n          left: 0;\n          right: 0;\n          bottom: 0;\n          background-color: var(--bg-tertiary);\n          transition: .3s;\n          border-radius: 24px;\n        }\n        .slider:before {\n          position: absolute;\n          content: "";\n          height: 18px;\n          width: 18px;\n          left: 3px;\n          bottom: 3px;\n          background-color: white;\n          transition: .3s;\n          border-radius: 50%;\n        }\n        input:checked + .slider {\n          background-color: var(--accent-primary);\n        }\n        input:checked + .slider:before {\n          transform: translateX(20px);\n        }\n        /* Radio buttons */\n        .radio-group {\n          display: flex;\n          gap: 1rem;\n          align-items: center;\n        }\n        input[type="radio"] {\n          accent-color: var(--accent-primary);\n          width: 1.1em;\n          height: 1.1em;\n        }\n        /* API Keys */\n        .api-keys-container {\n          display: flex;\n          flex-direction: column;\n          gap: 0.5rem;\n        }\n        .api-key-entry {\n          display: flex;\n          align-items: center;\n          gap: 0.5rem;\n        }\n        .api-key-entry input {\n          flex-grow: 1;\n        }\n        .remove-key, .add-key-btn {\n          padding: 0.5rem;\n          font-size: 1rem;\n          line-height: 1;\n          border-radius: 6px;\n          cursor: pointer;\n          transition: background-color 0.2s ease;\n        }\n        .remove-key {\n          background-color: var(--danger-color);\n          color: white;\n          border: none;\n        }\n        .remove-key:hover { background-color: ${n?"#ff498f":"#a82836"}; }\n        .add-key-btn {\n          background-color: var(--accent-secondary);\n          color: white;\n          border: none;\n          padding: 0.6rem 1rem;\n        }\n        .add-key-btn:hover { background-color: ${n?"#36d393":"#13653f"}; }\n        /* Buttons */\n        .btn {\n          padding: 0.75rem 1.5rem;\n          font-size: 0.9rem;\n          font-weight: 600;\n          border-radius: 8px;\n          border: none;\n          cursor: pointer;\n          transition: all 0.2s ease;\n        }\n        .btn-primary { background-color: var(--accent-primary); color: white; }\n        .btn-primary:hover { background-color: ${n?"#916cff":"#0b5ed7"}; }\n        .btn-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); }\n        .btn-secondary:hover { background-color: ${n?"#4a4a6a":"#d3d9df"}; }\n        /* --- Footer --- */\n        .settings-footer {\n          flex-shrink: 0;\n          background-color: var(--bg-secondary);\n          padding: 1rem 1.5rem;\n          border-top: 1px solid var(--border-color);\n          display: flex;\n          justify-content: flex-end;\n          gap: 0.75rem;\n          box-shadow: 0 -4px 12px var(--shadow-color);\n        }\n        /* Responsive */\n        @media (max-width: 992px) {\n          .settings-wrapper {\n            flex-direction: column;\n            padding: 1rem;\n          }\n          .settings-sidebar {\n            flex: 0 0 auto;\n            border-right: none;\n            border-bottom: 1px solid var(--border-color);\n            padding-right: 0;\n            padding-bottom: 1rem;\n            overflow-y: visible;\n          }\n          .sidebar-nav {\n            display: flex;\n            flex-wrap: nowrap;\n            overflow-x: auto;\n            gap: 0.5rem;\n            padding-bottom: 8px;\n            margin-bottom: -8px;\n            /* Ẩn thanh cuộn để giao diện gọn gàng hơn trên di động */\n            -ms-overflow-style: none;  /* IE and Edge */\n            scrollbar-width: none;  /* Firefox */\n          }\n          .sidebar-nav::-webkit-scrollbar {\n            display: none; /* Chrome, Safari, and Opera */\n          }\n          .sidebar-link {\n              /* Đảm bảo các mục menu không bị co lại khi không đủ không gian */\n              flex-shrink: 0;\n          }\n          .settings-content {\n            padding-right: 0;\n          }\n          .settings-grid {\n            grid-template-columns: 1fr;\n            gap: 0.5rem;\n          }\n          .settings-label, .settings-grid > span {\n            margin-bottom: 0;\n          }\n        }\n      `,e.innerHTML=`\n        <div class="settings-container">\n          <div class="settings-wrapper">\n            <aside class="settings-sidebar">\n              <h2 class="sidebar-title">\n                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>\n                ${this._("settings.title")}\n              </h2>\n              <nav class="sidebar-nav"></nav>\n            </aside>\n            <main class="settings-content"></main>\n          </div>\n          <div class="settings-footer">\n            <button id="importSettings" class="btn btn-secondary">${this._("settings.import_settings")}</button>\n            <input type="file" id="importInput" accept=".json" style="display: none;">\n            <button id="exportSettings" class="btn btn-secondary">${this._("settings.export_settings")}</button>\n            <button id="cancelSettings" class="btn btn-secondary">${this._("settings.cancel")}</button>\n            <button id="saveSettings" class="btn btn-primary">${this._("settings.save")}</button>\n          </div>\n        </div>\n      `;const r=e.querySelector(".settings-content"),l=e.querySelector(".sidebar-nav"),c={interface:{title:this._("settings.interface_section"),icon:"🎨"},api:{title:this._("settings.api_provider_section"),icon:"🔑"},input:{title:this._("settings.input_translation_section"),icon:"⌨️"},tools:{title:this._("settings.tools_section"),icon:"⚙️"},page:{title:this._("settings.page_translation_section"),icon:"📄"},prompts:{title:this._("settings.prompt_settings_section"),icon:"✍️"},ocr:{title:this._("settings.ocr_section"),icon:"📷"},media:{title:this._("settings.media_section"),icon:"🎵"},video:{title:this._("settings.video_streaming_section"),icon:"📺"},display:{title:this._("settings.display_section"),icon:"🖼️"},tts:{title:this._("settings.tts_section"),icon:"🔊"},context:{title:this._("settings.context_menu_section"),icon:"🖱️"},shortcuts:{title:this._("settings.shortcuts_section"),icon:"⚡"},button:{title:this._("settings.button_options_section"),icon:"🔘"},touch:{title:this._("settings.touch_options_section"),icon:"🖐️"},rate:{title:this._("settings.rate_limit_section"),icon:"⏱️"},cache:{title:this._("settings.cache_section"),icon:"💾"}};for(const[t,{title:e,icon:n}]of Object.entries(c)){const a=document.createElement("a");a.className="sidebar-link",a.dataset.target=`section-${t}`,a.innerHTML=`${n} ${e}`,l.appendChild(a);const i=document.createElement("div");i.id=`section-${t}`,i.className="settings-section",i.innerHTML=`<div class="section-card"><h2>${n} ${e}</h2><div class="section-content-wrapper"></div></div>`,r.appendChild(i)}e.querySelector("#section-interface .section-content-wrapper").innerHTML=`\n        <div class="settings-grid">\n          <span class="settings-label">${this._("settings.theme_mode")}</span>\n          <div class="radio-group">\n            <label><input type="radio" name="theme" value="light" ${n?"":"checked"}> ${this._("settings.light")}</label>\n            <label><input type="radio" name="theme" value="dark" ${n?"checked":""}> ${this._("settings.dark")}</label>\n          </div>\n        </div>\n        <div class="settings-grid">\n          <span class="settings-label">${this._("settings.ui_language")}</span>\n          <div class="radio-group">\n            <label><input type="radio" name="uiLanguage" value="en" ${"en"===this.settings.uiLanguage?"checked":""}> English</label>\n            <label><input type="radio" name="uiLanguage" value="vi" ${"vi"===this.settings.uiLanguage?"checked":""}> Tiếng Việt</label>\n          </div>\n        </div>\n      `,e.querySelector("#section-api .section-content-wrapper").innerHTML=`\n        <h3>API PROVIDER</h3>\n        ${this.createProviderRadios(this.settings)}\n        <h3>API MODEL</h3>\n        <div class="api-model-settings">\n          ${["gemini","perplexity","claude","openai","mistral","deepseek","ollama"].map(t=>this.createModelSection(t,this.settings)).join("")}\n        </div>\n        <h3>API KEYS</h3>\n        <div class="api-keys-settings">\n          ${["gemini","perplexity","claude","openai","mistral","deepseek"].map(t=>this.createApiKeySection(t,this.settings)).join("")}\n        </div>\n      `,e.querySelector("#section-input .section-content-wrapper").innerHTML=`\n        <div class="settings-grid">\n          <label class="settings-label" for="inputTranslationEnabled">${this._("settings.enable_feature")}</label>\n          ${i("inputTranslationEnabled",this.settings.inputTranslation?.enabled)}\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="inputTranslationSavePosition">${this._("settings.save_position")}</label>\n          ${i("inputTranslationSavePosition",this.settings.inputTranslation?.savePosition)}\n        </div>\n      `,e.querySelector("#section-tools .section-content-wrapper").innerHTML=`\n        <div class="settings-grid">\n          <label class="settings-label" for="ToolsEnabled">${this._("settings.enable_tools")}</label>\n          ${i("ToolsEnabled",this.settings.translatorTools?.enabled)}\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="showTranslatorTools">${this._("settings.enable_tools_current_web")}</label>\n          ${i("showTranslatorTools","true"===t("translatorToolsEnabled"))}\n        </div>\n      `,e.querySelector("#section-page .section-content-wrapper").innerHTML=`\n        <div class="settings-grid">\n          <label class="settings-label" for="pageTranslationEnabled">${this._("settings.enable_page_translation")}</label>\n          ${i("pageTranslationEnabled",this.settings.pageTranslation?.enabled)}\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="showInitialButton">${this._("settings.show_initial_button")}</label>\n          ${i("showInitialButton",this.settings.pageTranslation?.showInitialButton)}\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="autoTranslatePage">${this._("settings.auto_translate_page")}</label>\n          ${i("autoTranslatePage",this.settings.pageTranslation?.autoTranslate)}\n        </div>\n        <h3>Google Translate</h3>\n        <div class="settings-grid">\n          <label class="settings-label" for="enableGoogleTranslate">${this._("settings.enable_google_translate_page")}</label>\n          ${i("enableGoogleTranslate",this.settings.pageTranslation?.enableGoogleTranslate)}\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="googleTranslateLayout">${this._("settings.google_translate_layout")}</label>\n          <select id="googleTranslateLayout" class="settings-input">\n            <option value="SIMPLE" ${"SIMPLE"===this.settings.pageTranslation?.googleTranslateLayout?"selected":""}>${this._("settings.google_translate_minimal")}</option>\n            <option value="INLINE" ${"INLINE"===this.settings.pageTranslation?.googleTranslateLayout?"selected":""}>${this._("settings.google_translate_inline")}</option>\n            <option value="OVERLAY" ${"OVERLAY"===this.settings.pageTranslation?.googleTranslateLayout?"selected":""}>${this._("settings.google_translate_selected")}</option>\n          </select>\n        </div>\n        <h3>Selectors loại trừ</h3>\n        <div class="settings-grid">\n            <label class="settings-label" for="useCustomSelectors">${this._("settings.custom_selectors")}</label>\n            ${i("useCustomSelectors",this.settings.pageTranslation?.useCustomSelectors)}\n        </div>\n        <div id="selectorsSettings" style="display: ${this.settings.pageTranslation?.useCustomSelectors?"block":"none"}">\n          <div class="settings-grid" style="align-items: start;">\n            <label class="settings-label" for="customSelectors">${this._("settings.exclude_selectors")}</label>\n            <div>\n              <textarea id="customSelectors" class="prompt-textarea">${this.settings.pageTranslation?.customSelectors?.join("\n")||""}</textarea>\n              <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">${this._("settings.one_selector_per_line")}</div>\n            </div>\n          </div>\n          <div class="settings-grid">\n            <label class="settings-label" for="combineWithDefault">${this._("settings.combine_with_default")}</label>\n            <div>\n              ${i("combineWithDefault",this.settings.pageTranslation?.combineWithDefault)}\n              <span style="font-size: 0.8rem; color: var(--text-secondary);">${this._("settings.combine_with_default_info")}</span>\n            </div>\n          </div>\n        </div>\n        <h3>Thông số AI</h3>\n        <div class="settings-grid">\n          <label class="settings-label" for="pageTranslationTemperature">${this._("settings.temperature")}</label>\n          <input type="number" id="pageTranslationTemperature" class="settings-input" value="${this.settings.pageTranslation.generation.temperature}" min="0" max="1" step="0.1">\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="pageTranslationTopP">${this._("settings.top_p")}</label>\n          <input type="number" id="pageTranslationTopP" class="settings-input" value="${this.settings.pageTranslation.generation.topP}" min="0" max="1" step="0.1">\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="pageTranslationTopK">${this._("settings.top_k")}</label>\n          <input type="number" id="pageTranslationTopK" class="settings-input" value="${this.settings.pageTranslation.generation.topK}" min="1" max="100" step="1">\n        </div>\n      `,e.querySelector("#section-prompts .section-content-wrapper").innerHTML=`\n        <div class="settings-grid">\n          <label class="settings-label" for="useCustomPrompt">${this._("settings.use_custom_prompt")}</label>\n          ${i("useCustomPrompt",this.settings.promptSettings?.useCustom)}\n        </div>\n        <div id="promptSettings" style="display: ${this.settings.promptSettings?.useCustom?"block":"none"}">\n          \x3c!-- Normal prompts --\x3e\n          <div class="settings-grid" style="align-items: start;">\n            <span class="settings-label">${this._("settings.prompt_normal")}</span>\n            <textarea id="normalPrompt" class="prompt-textarea" placeholder="${this._("settings.prompt_normal")}">${this.settings.promptSettings?.customPrompts?.normal||""}</textarea>\n          </div>\n          <div class="settings-grid" style="align-items: start;">\n            <span class="settings-label">${this._("settings.prompt_normal_chinese")}</span>\n            <textarea id="normalPrompt_chinese" class="prompt-textarea" placeholder="${this._("settings.prompt_normal_chinese")}">${this.settings.promptSettings?.customPrompts?.normal_chinese||""}</textarea>\n          </div>\n          \x3c!-- Advanced prompts --\x3e\n          <div class="settings-grid" style="align-items: start;">\n            <span class="settings-label">${this._("settings.prompt_advanced")}</span>\n            <textarea id="advancedPrompt" class="prompt-textarea" placeholder="${this._("settings.prompt_advanced")}">${this.settings.promptSettings?.customPrompts?.advanced||""}</textarea>\n          </div>\n          <div class="settings-grid" style="align-items: start;">\n            <span class="settings-label">${this._("settings.prompt_advanced_chinese")}</span>\n            <textarea id="advancedPrompt_chinese" class="prompt-textarea" placeholder="${this._("settings.prompt_advanced_chinese")}">${this.settings.promptSettings?.customPrompts?.advanced_chinese||""}</textarea>\n          </div>\n          \x3c!-- OCR prompts --\x3e\n          <div class="settings-grid" style="align-items: start;">\n            <span class="settings-label">${this._("settings.prompt_ocr")}</span>\n            <textarea id="ocrPrompt" class="prompt-textarea" placeholder="${this._("settings.prompt_ocr")}">${this.settings.promptSettings?.customPrompts?.ocr||""}</textarea>\n          </div>\n          <div class="settings-grid" style="align-items: start;">\n            <span class="settings-label">${this._("settings.prompt_ocr_chinese")}</span>\n            <textarea id="ocrPrompt_chinese" class="prompt-textarea" placeholder="${this._("settings.prompt_ocr_chinese")}">${this.settings.promptSettings?.customPrompts?.ocr_chinese||""}</textarea>\n          </div>\n          \x3c!-- Media prompts --\x3e\n          <div class="settings-grid" style="align-items: start;">\n            <span class="settings-label">${this._("settings.prompt_media")}</span>\n            <textarea id="mediaPrompt" class="prompt-textarea" placeholder="${this._("settings.prompt_media")}">${this.settings.promptSettings?.customPrompts?.media||""}</textarea>\n          </div>\n          <div class="settings-grid" style="align-items: start;">\n            <span class="settings-label">${this._("settings.prompt_media_chinese")}</span>\n            <textarea id="mediaPrompt_chinese" class="prompt-textarea" placeholder="${this._("settings.prompt_media_chinese")}">${this.settings.promptSettings?.customPrompts?.media_chinese||""}</textarea>\n          </div>\n          \x3c!-- Page prompts --\x3e\n          <div class="settings-grid" style="align-items: start;">\n            <span class="settings-label">${this._("settings.prompt_page")}</span>\n            <textarea id="pagePrompt" class="prompt-textarea" placeholder="${this._("settings.prompt_page")}">${this.settings.promptSettings?.customPrompts?.page||""}</textarea>\n          </div>\n          <div class="settings-grid" style="align-items: start;">\n            <span class="settings-label">${this._("settings.prompt_page_chinese")}</span>\n            <textarea id="pagePrompt_chinese" class="prompt-textarea" placeholder="${this._("settings.prompt_page_chinese")}">${this.settings.promptSettings?.customPrompts?.page_chinese||""}</textarea>\n          </div>\n          \x3c!-- File Content prompts --\x3e\n          <div class="settings-grid" style="align-items: start;">\n            <span class="settings-label">${this._("settings.prompt_file_content")}</span>\n            <textarea id="fileContentPrompt" class="prompt-textarea" placeholder="${this._("settings.prompt_file_content")}">${this.settings.promptSettings?.customPrompts?.file_content||""}</textarea>\n          </div>\n          <div class="settings-grid" style="align-items: start;">\n            <span class="settings-label">${this._("settings.prompt_file_content_chinese")}</span>\n            <textarea id="fileContentPrompt_chinese" class="prompt-textarea" placeholder="${this._("settings.prompt_file_content_chinese")}">${this.settings.promptSettings?.customPrompts?.file_content_chinese||""}</textarea>\n          </div>\n          <div style="margin-top: 1rem; font-size: 0.8rem; color: var(--text-secondary);">\n            <b>${this._("settings.prompt_vars_info")}</b>\n            <ul style="margin-left: 1.5rem; margin-top: 0.5rem; list-style-type: disc;">\n              <li><code>{text}</code> - ${this._("settings.prompt_var_text")}</li>\n              <li><code>{docTitle}</code> - ${this._("settings.prompt_var_doc_title")}</li>\n              <li><code>{targetLang}</code> - ${this._("settings.prompt_var_target_lang")}</li>\n              <li><code>{sourceLang}</code> - ${this._("settings.prompt_var_source_lang")}</li>\n            </ul>\n            <b style="display: block; margin-top: 1rem;">${this._("settings.prompt_notes")}</b>\n            <ul style="margin-left: 1.5rem; margin-top: 0.5rem; list-style-type: disc;">\n              <li>${this._("settings.prompt_notes_required")}</li>\n              <li>${this._("settings.prompt_note_en")}</li>\n              <li>${this._("settings.prompt_note_zh")}</li>\n            </ul>\n          </div>\n        </div>\n      `,e.querySelector("#section-ocr .section-content-wrapper").innerHTML=`\n        <div class="settings-grid">\n          <label class="settings-label" for="ocrEnabled">${this._("settings.enable_ocr")}</label>\n          ${i("ocrEnabled",this.settings.ocrOptions?.enabled)}\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="mangaTranslateAll">${this._("settings.enable_manga_translate_all")}</label>\n          ${i("mangaTranslateAll",this.settings.ocrOptions?.mangaTranslateAll)}\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="mangaTranslateAllSiteOnly">${this._("settings.enable_manga_translate_all_site_only")}</label>\n          ${i("mangaTranslateAllSiteOnly","true"===t("kingtranslator_manga_all_for_site")||!0)}\n        </div>\n        <h3>Thông số AI</h3>\n        <div class="settings-grid">\n          <label class="settings-label" for="ocrTemperature">${this._("settings.temperature")}</label>\n          <input type="number" id="ocrTemperature" class="settings-input" value="${this.settings.ocrOptions.temperature}" min="0" max="1" step="0.1">\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="ocrTopP">${this._("settings.top_p")}</label>\n          <input type="number" id="ocrTopP" class="settings-input" value="${this.settings.ocrOptions.topP}" min="0" max="1" step="0.1">\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="ocrTopK">${this._("settings.top_k")}</label>\n          <input type="number" id="ocrTopK" class="settings-input" value="${this.settings.ocrOptions.topK}" min="1" max="100" step="1">\n        </div>\n      `,e.querySelector("#section-media .section-content-wrapper").innerHTML=`\n        <div class="settings-grid">\n          <label class="settings-label" for="mediaEnabled">${this._("settings.enable_media")}</label>\n          ${i("mediaEnabled",this.settings.mediaOptions.enabled)}\n        </div>\n        <h3>Thông số AI</h3>\n        <div class="settings-grid">\n          <label class="settings-label" for="mediaTemperature">${this._("settings.temperature")}</label>\n          <input type="number" id="mediaTemperature" class="settings-input" value="${this.settings.mediaOptions.temperature}" min="0" max="1" step="0.1">\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="mediaTopP">${this._("settings.top_p")}</label>\n          <input type="number" id="mediaTopP" class="settings-input" value="${this.settings.mediaOptions.topP}" min="0" max="1" step="0.1">\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="mediaTopK">${this._("settings.top_k")}</label>\n          <input type="number" id="mediaTopK" class="settings-input" value="${this.settings.mediaOptions.topK}" min="1" max="100" step="1">\n        </div>\n      `,e.querySelector("#section-video .section-content-wrapper").innerHTML=`\n        <div class="settings-grid">\n          <label class="settings-label" for="videoStreamingEnabled">${this._("settings.enable_feature")}</label>\n          ${i("videoStreamingEnabled",this.settings.videoStreamingOptions?.enabled)}\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="videoStreamingFontSize">${this._("settings.font_size")}</label>\n          <input type="text" id="videoStreamingFontSize" class="settings-input" placeholder="clamp(1rem, 1.5cqw, 2.5rem)" value="${this.settings.videoStreamingOptions?.fontSize}">\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="videoStreamingBgColor">${this._("settings.background_color")}</label>\n          <input type="text" id="videoStreamingBgColor" class="settings-input" placeholder="rgba(0,0,0,0.7)" value="${this.settings.videoStreamingOptions?.backgroundColor}">\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="videoStreamingTextColor">${this._("settings.text_color")}</label>\n          <input type="text" id="videoStreamingTextColor" class="settings-input" placeholder="white" value="${this.settings.videoStreamingOptions?.textColor}">\n        </div>\n      `,e.querySelector("#section-display .section-content-wrapper").innerHTML=`\n        <div class="settings-grid">\n          <label class="settings-label" for="displayMode">${this._("settings.display_mode")}</label>\n          <select id="displayMode" class="settings-input">\n            <option value="translation_only" ${"translation_only"===this.settings.displayOptions.translationMode?"selected":""}>${this._("settings.translation_only")}</option>\n            <option value="parallel" ${"parallel"===this.settings.displayOptions.translationMode?"selected":""}>${this._("settings.parallel")}</option>\n            <option value="language_learning" ${"language_learning"===this.settings.displayOptions.translationMode?"selected":""}>${this._("settings.language_learning")}</option>\n          </select>\n        </div>\n        <div id="languageLearningOptions" style="display: ${"language_learning"===this.settings.displayOptions.translationMode?"block":"none"}">\n          <div class="settings-grid">\n            <label class="settings-label" for="showSource">${this._("settings.show_source")}</label>\n            ${i("showSource",this.settings.displayOptions.languageLearning.showSource)}\n          </div>\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="sourceLanguage">${this._("settings.source_language")}</label>\n          <select id="sourceLanguage" class="settings-input">\n            <option value="auto" ${"auto"===this.settings.displayOptions.sourceLanguage?"selected":""}>${this._("auto_detect")}</option>\n            ${Object.entries(o.LANGUAGES).map(([t,e])=>`<option value="${t}" ${this.settings.displayOptions.sourceLanguage===t?"selected":""}>${e}</option>`).join("")}\n          </select>\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="targetLanguage">${this._("settings.target_language")}</label>\n          <select id="targetLanguage" class="settings-input">\n            ${Object.entries(o.LANGUAGES).map(([t,e])=>`<option value="${t}" ${this.settings.displayOptions.targetLanguage===t?"selected":""}>${e}</option>`).join("")}\n          </select>\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="webImageFontSize">${this._("settings.web_image_font_size")}</label>\n          <input type="text" id="webImageFontSize" class="settings-input" placeholder="auto" value="${this.settings.displayOptions?.webImageTranslation?.fontSize}">\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="fontSize">${this._("settings.popup_font_size")}</label>\n          <input type="text" id="fontSize" class="settings-input" placeholder="1rem" value="${this.settings.displayOptions?.fontSize}">\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="minPopupWidth">${this._("settings.min_popup_width")}</label>\n          <input type="text" id="minPopupWidth" class="settings-input" placeholder="330px" value="${this.settings.displayOptions?.minPopupWidth}">\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="maxPopupWidth">${this._("settings.max_popup_width")}</label>\n          <input type="text" id="maxPopupWidth" class="settings-input" placeholder="50vw" value="${this.settings.displayOptions?.maxPopupWidth}">\n        </div>\n      `,e.querySelector("#section-tts .section-content-wrapper").innerHTML=`\n        <div class="settings-grid">\n          <label class="settings-label" for="ttsEnabled">${this._("settings.enable_tts")}</label>\n          ${i("ttsEnabled",this.settings.ttsOptions?.enabled)}\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="tts-provider">${this._("settings.tts_source")}</label>\n          <select id="tts-provider" class="settings-input">\n            <option value="google" ${"google"===this.settings.ttsOptions?.defaultProvider?"selected":""}>Google Cloud TTS</option>\n            <option value="google_translate" ${"google_translate"===this.settings.ttsOptions?.defaultProvider?"selected":""}>Google Translate TTS</option>\n            <option value="gemini" ${"gemini"===this.settings.ttsOptions?.defaultProvider?"selected":""}>Gemini AI TTS</option>\n            <option value="openai" ${"openai"===this.settings.ttsOptions?.defaultProvider?"selected":""}>OpenAI TTS</option>\n            <option value="local" ${"local"===this.settings.ttsOptions?.defaultProvider?"selected":""}>TTS Thiết bị</option>\n          </select>\n        </div>\n        <div id="tts-gemini-container" style="display: ${"gemini"===this.settings.ttsOptions?.defaultProvider?"block":"none"}">\n          <div class="settings-grid">\n            <label class="settings-label" for="tts-gemini-model">${this._("settings.model_label")} TTS:</label>\n            <select id="tts-gemini-model" class="settings-input">${o.TTS.GEMINI.MODEL.map(t=>`<option value="${t}" ${this.settings.ttsOptions?.defaultGeminiModel===t?"selected":""}>${t}</option>`).join("")}</select>\n          </div>\n          <div class="settings-grid">\n            <label class="settings-label" for="tts-gemini-select">${this._("settings.voice")}:</label>\n            <select id="tts-gemini-select" class="settings-input">${o.TTS.GEMINI.VOICES.map(t=>`<option value="${t}" ${a("gemini",t)?"selected":""}>${t}</option>`).join("")}</select>\n          </div>\n        </div>\n        <div id="tts-openai-container" style="display: ${"openai"===this.settings.ttsOptions?.defaultProvider?"block":"none"}">\n          <div class="settings-grid">\n            <label class="settings-label" for="tts-openai-model">${this._("settings.model_label")} TTS:</label>\n            <select id="tts-openai-model" class="settings-input">${o.TTS.OPENAI.MODEL.map(t=>`<option value="${t}" ${this.settings.ttsOptions?.defaultModel===t?"selected":""}>${t}</option>`).join("")}</select>\n          </div>\n          <div class="settings-grid">\n            <label class="settings-label" for="tts-openai-select">${this._("settings.voice")}:</label>\n            <select id="tts-openai-select" class="settings-input">${o.TTS.OPENAI.VOICES.map(t=>`<option value="${t}" ${a("openai",t)?"selected":""}>${t}</option>`).join("")}</select>\n          </div>\n        </div>\n        <div id="tts-google-container" style="display: ${"google"===this.settings.ttsOptions?.defaultProvider?"block":"none"}">\n          <h3>${this._("settings.default_voice")}</h3>\n          ${Object.entries(o.TTS.GOOGLE.VOICES).map(([t,e])=>`\n            <div class="settings-grid">\n              <label class="settings-label">${o.LANGUAGEDISPLAY[t].display}:</label>\n              <select class="settings-input" id="tts-google-select" data-lang="${t}">\n                ${e.map(e=>`<option value="${e.name}" ${a("google",e.name,t)?"selected":""}>${e.display}</option>`).join("")}\n              </select>\n            </div>\n          `).join("")}\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label">${this._("settings.speed")}</label>\n          <div style="display:flex;align-items:center;gap:8px"><input type="range" id="ttsDefaultSpeed" style="flex:1" value="${this.settings.ttsOptions?.defaultSpeed||1}" min="0.1" max="2" step="0.1"><span style="min-width:36px;text-align:right">${this.settings.ttsOptions?.defaultSpeed||1}</span></div>\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label">${this._("settings.pitch")}</label>\n          <div style="display:flex;align-items:center;gap:8px"><input type="range" id="ttsDefaultPitch" style="flex:1" value="${this.settings.ttsOptions?.defaultPitch||1}" min="0" max="2" step="0.1"><span style="min-width:36px;text-align:right">${this.settings.ttsOptions?.defaultPitch||1}</span></div>\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label">${this._("settings.volume")}</label>\n          <div style="display:flex;align-items:center;gap:8px"><input type="range" id="ttsDefaultVolume" style="flex:1" value="${this.settings.ttsOptions?.defaultVolume||1}" min="0" max="1" step="0.1"><span style="min-width:36px;text-align:right">${this.settings.ttsOptions?.defaultVolume||1}</span></div>\n        </div>\n      `,e.querySelector("#section-context .section-content-wrapper").innerHTML=`\n        <div class="settings-grid">\n          <label class="settings-label" for="contextMenuEnabled">${this._("settings.enable_context_menu")}</label>\n          ${i("contextMenuEnabled",this.settings.contextMenu?.enabled)}\n        </div>\n      `,e.querySelector("#section-shortcuts .section-content-wrapper").innerHTML=`\n        <div class="settings-grid">\n          <label class="settings-label" for="settingsShortcutEnabled">${this._("settings.enable_settings_shortcut")}</label>\n          ${i("settingsShortcutEnabled",this.settings.shortcuts?.settingsEnabled)}\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="shortcutsEnabled">${this._("settings.enable_translation_shortcuts")}</label>\n          ${i("shortcutsEnabled",this.settings.shortcuts?.enabled)}\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label">${this._("settings.ocr_region_shortcut")}</label>\n          <div class="shortcut-container"><span class="shortcut-prefix">Cmd/Alt +</span><input type="text" id="ocrRegionKey" class="shortcut-input settings-input" value="${this.settings.shortcuts.ocrRegion.key}"></div>\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label">${this._("settings.ocr_web_image_shortcut")}</label>\n          <div class="shortcut-container"><span class="shortcut-prefix">Cmd/Alt +</span><input type="text" id="ocrWebImageKey" class="shortcut-input settings-input" value="${this.settings.shortcuts.ocrWebImage.key}"></div>\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label">${this._("settings.manga_web_shortcut")}</label>\n          <div class="shortcut-container"><span class="shortcut-prefix">Cmd/Alt +</span><input type="text" id="ocrMangaWebKey" class="shortcut-input settings-input" value="${this.settings.shortcuts.ocrMangaWeb.key}"></div>\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label">${this._("settings.page_translate_shortcut")}</label>\n          <div class="shortcut-container"><span class="shortcut-prefix">Cmd/Alt +</span><input type="text" id="pageTranslateKey" class="shortcut-input settings-input" value="${this.settings.shortcuts.pageTranslate.key}"></div>\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label">${this._("settings.input_translate_shortcut")}</label>\n          <div class="shortcut-container"><span class="shortcut-prefix">Cmd/Alt +</span><input type="text" id="inputTranslationKey" class="shortcut-input settings-input" value="${this.settings.shortcuts.inputTranslate.key}"></div>\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label">${this._("settings.quick_translate_shortcut")}</label>\n          <div class="shortcut-container"><span class="shortcut-prefix">Cmd/Alt +</span><input type="text" id="quickKey" class="shortcut-input settings-input" value="${this.settings.shortcuts.quickTranslate.key}"></div>\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label">${this._("settings.popup_translate_shortcut")}</label>\n          <div class="shortcut-container"><span class="shortcut-prefix">Cmd/Alt +</span><input type="text" id="popupKey" class="shortcut-input settings-input" value="${this.settings.shortcuts.popupTranslate.key}"></div>\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label">${this._("settings.advanced_translate_shortcut")}</label>\n          <div class="shortcut-container"><span class="shortcut-prefix">Cmd/Alt +</span><input type="text" id="advancedKey" class="shortcut-input settings-input" value="${this.settings.shortcuts.advancedTranslate.key}"></div>\n        </div>\n      `,e.querySelector("#section-button .section-content-wrapper").innerHTML=`\n        <div class="settings-grid">\n          <label class="settings-label" for="translationButtonEnabled">${this._("settings.enable_translation_button")}</label>\n          ${i("translationButtonEnabled",this.settings.clickOptions?.enabled)}\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="singleClickSelect">${this._("settings.single_click")}</label>\n          <select id="singleClickSelect" class="settings-input">\n            <option value="quick" ${"quick"===this.settings.clickOptions.singleClick.translateType?"selected":""}>${this._("settings.quick_translate_shortcut")}</option>\n            <option value="popup" ${"popup"===this.settings.clickOptions.singleClick.translateType?"selected":""}>${this._("settings.popup_translate_shortcut")}</option>\n            <option value="advanced" ${"advanced"===this.settings.clickOptions.singleClick.translateType?"selected":""}>${this._("settings.advanced_translate_shortcut")}</option>\n          </select>\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="doubleClickSelect">${this._("settings.double_click")}</label>\n          <select id="doubleClickSelect" class="settings-input">\n            <option value="quick" ${"quick"===this.settings.clickOptions.doubleClick.translateType?"selected":""}>${this._("settings.quick_translate_shortcut")}</option>\n            <option value="popup" ${"popup"===this.settings.clickOptions.doubleClick.translateType?"selected":""}>${this._("settings.popup_translate_shortcut")}</option>\n            <option value="advanced" ${"advanced"===this.settings.clickOptions.doubleClick.translateType?"selected":""}>${this._("settings.advanced_translate_shortcut")}</option>\n          </select>\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="holdSelect">${this._("settings.hold_button")}</label>\n          <select id="holdSelect" class="settings-input">\n            <option value="quick" ${"quick"===this.settings.clickOptions.hold.translateType?"selected":""}>${this._("settings.quick_translate_shortcut")}</option>\n            <option value="popup" ${"popup"===this.settings.clickOptions.hold.translateType?"selected":""}>${this._("settings.popup_translate_shortcut")}</option>\n            <option value="advanced" ${"advanced"===this.settings.clickOptions.hold.translateType?"selected":""}>${this._("settings.advanced_translate_shortcut")}</option>\n          </select>\n        </div>\n      `,e.querySelector("#section-touch .section-content-wrapper").innerHTML=`\n        <div class="settings-grid">\n          <label class="settings-label" for="touchEnabled">${this._("settings.enable_touch")}</label>\n          ${i("touchEnabled",this.settings.touchOptions?.enabled)}\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="twoFingersSelect">${this._("settings.two_fingers")}</label>\n          <select id="twoFingersSelect" class="settings-input">\n            <option value="quick" ${"quick"===this.settings.touchOptions?.twoFingers?.translateType?"selected":""}>${this._("settings.quick_translate_shortcut")}</option>\n            <option value="popup" ${"popup"===this.settings.touchOptions?.twoFingers?.translateType?"selected":""}>${this._("settings.popup_translate_shortcut")}</option>\n            <option value="advanced" ${"advanced"===this.settings.touchOptions?.twoFingers?.translateType?"selected":""}>${this._("settings.advanced_translate_shortcut")}</option>\n          </select>\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="threeFingersSelect">${this._("settings.three_fingers")}</label>\n          <select id="threeFingersSelect" class="settings-input">\n            <option value="quick" ${"quick"===this.settings.touchOptions?.threeFingers?.translateType?"selected":""}>${this._("settings.quick_translate_shortcut")}</option>\n            <option value="popup" ${"popup"===this.settings.touchOptions?.threeFingers?.translateType?"selected":""}>${this._("settings.popup_translate_shortcut")}</option>\n            <option value="advanced" ${"advanced"===this.settings.touchOptions?.threeFingers?.translateType?"selected":""}>${this._("settings.advanced_translate_shortcut")}</option>\n          </select>\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="touchSensitivity">${this._("settings.sensitivity")}</label>\n          <input type="number" id="touchSensitivity" class="settings-input" value="${this.settings.touchOptions?.sensitivity||100}" min="50" max="350" step="50">\n        </div>\n      `,e.querySelector("#section-rate .section-content-wrapper").innerHTML=`\n        <div class="settings-grid">\n          <label class="settings-label" for="maxRequests">${this._("settings.max_requests")}</label>\n          <input type="number" id="maxRequests" class="settings-input" value="${this.settings.rateLimit?.maxRequests||o.RATE_LIMIT.maxRequests}" min="1" max="50" step="1">\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="perMilliseconds">${this._("settings.per_milliseconds")}</label>\n          <input type="number" id="perMilliseconds" class="settings-input" value="${this.settings.rateLimit?.perMilliseconds||o.RATE_LIMIT.perMilliseconds}" min="1000" step="1000">\n        </div>\n      `,e.querySelector("#section-cache .section-content-wrapper").innerHTML=`\n        <h3>${this._("settings.text_cache")}</h3>\n        <div class="settings-grid">\n          <label class="settings-label" for="textCacheEnabled">${this._("settings.enable_text_cache")}</label>\n          ${i("textCacheEnabled",this.settings.cacheOptions?.text?.enabled)}\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="textCacheMaxSize">${this._("settings.text_cache_max_size")}</label>\n          <input type="number" id="textCacheMaxSize" class="settings-input" value="${this.settings.cacheOptions?.text?.maxSize||o.CACHE.text.maxSize}" min="10" max="1000">\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="textCacheExpiration">${this._("settings.text_cache_expiration")}</label>\n          <input type="number" id="textCacheExpiration" class="settings-input" value="${this.settings.cacheOptions?.text?.expirationTime||o.CACHE.text.expirationTime}" min="60000" step="60000">\n        </div>\n        <h3>${this._("settings.image_cache")}</h3>\n        <div class="settings-grid">\n          <label class="settings-label" for="imageCacheEnabled">${this._("settings.enable_image_cache")}</label>\n          ${i("imageCacheEnabled",this.settings.cacheOptions?.image?.enabled)}\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="imageCacheMaxSize">${this._("settings.image_cache_max_size")}</label>\n          <input type="number" id="imageCacheMaxSize" class="settings-input" value="${this.settings.cacheOptions?.image?.maxSize||o.CACHE.image.maxSize}" min="10" max="100">\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="imageCacheExpiration">${this._("settings.image_cache_expiration")}</label>\n          <input type="number" id="imageCacheExpiration" class="settings-input" value="${this.settings.cacheOptions?.image?.expirationTime||o.CACHE.image.expirationTime}" min="60000" step="60000">\n        </div>\n        <h3>${this._("settings.media_cache")}</h3>\n        <div class="settings-grid">\n          <label class="settings-label" for="mediaCacheEnabled">${this._("settings.enable_media_cache")}</label>\n          ${i("mediaCacheEnabled",this.settings.cacheOptions.media?.enabled)}\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="mediaCacheMaxSize">${this._("settings.media_cache_max_size")}</label>\n          <input type="number" id="mediaCacheMaxSize" class="settings-input" value="${this.settings.cacheOptions.media?.maxSize||o.CACHE.media.maxSize}" min="5" max="100">\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="mediaCacheExpiration">${this._("settings.media_cache_expiration")}</label>\n          <input type="number" id="mediaCacheExpiration" class="settings-input" value="${this.settings.cacheOptions.media?.expirationTime||o.CACHE.media.expirationTime}" min="60000" step="60000">\n        </div>\n        <h3>${this._("settings.tts_cache")}</h3>\n        <div class="settings-grid">\n          <label class="settings-label" for="ttsCacheEnabled">${this._("settings.enable_tts_cache")}</label>\n          ${i("ttsCacheEnabled",this.settings.cacheOptions.tts?.enabled)}\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="ttsCacheMaxSize">${this._("settings.tts_cache_max_size")}</label>\n          <input type="number" id="ttsCacheMaxSize" class="settings-input" value="${this.settings.cacheOptions.tts?.maxSize||o.CACHE.tts.maxSize}" min="5" max="100">\n        </div>\n        <div class="settings-grid">\n          <label class="settings-label" for="ttsCacheExpiration">${this._("settings.tts_cache_expiration")}</label>\n          <input type="number" id="ttsCacheExpiration" class="settings-input" value="${this.settings.cacheOptions.tts?.expirationTime||o.CACHE.tts.expirationTime}" min="60000" step="60000">\n        </div>\n      `,this.translator.ui.shadowRoot.appendChild(s),this.translator.ui.shadowRoot.appendChild(e);const d=e.querySelector(".settings-container");Object.assign(d.style,{position:"fixed",backgroundColor:"var(--bg-primary)",color:"var(--text-primary)",borderRadius:"16px",boxShadow:"0 8px 32px var(--shadow-color)",width:"clamp(320px, 95vw, 1200px)",height:"clamp(400px, 90vh, 800px)",overflow:"hidden",top:"50%",left:"50%",transform:"translate(-50%, -50%)",display:"flex",flexDirection:"column"});const p=e.querySelectorAll(".sidebar-link"),h=e.querySelectorAll(".settings-section");p.forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.target;p.forEach(t=>t.classList.remove("active")),t.classList.add("active"),h.forEach(t=>{t.classList.remove("active"),t.id===e&&t.classList.add("active")})})}),p.length>0&&p[0].click();const g=["gemini","perplexity","claude","openai","mistral","deepseek","ollama"];e.querySelectorAll('input[name="apiProvider"]').forEach(t=>{t.addEventListener("change",t=>{const n=t.target.value;g.forEach(t=>{const a=e.querySelector(`.${t}-models`),i=e.querySelector(`#${t}Keys`);a&&(a.style.display=t===n?"":"none"),i&&(i.style.display=t===n?"":"none")})})}),g.forEach(t=>{const n=e.querySelector(`#${t}ModelType`),a=this.getModelTypes(t);n&&n.addEventListener("change",n=>{const i=n.target.value;a.forEach(n=>{const a=e.querySelector(`#${t}-${n}-container`);a&&(a.style.display=i===n?"":"none")})})}),["gemini","perplexity","claude","openai","mistral","deepseek"].forEach(t=>{const n=e.querySelector(`#add-${t}-key`);if(!n)return;const a=e.querySelector(`#${t}Keys .api-keys-container`);n.addEventListener("click",()=>{const e=document.createElement("div");e.className="api-key-entry";const n=a.children.length;e.innerHTML=`\n            <input type="text" class="${t}-key" value="">\n            <button class="remove-key" data-provider="${t}" data-index="${n}">×</button>\n          `,a.appendChild(e)})}),e.addEventListener("click",t=>{t.target.classList.contains("remove-key")&&t.target.parentElement.remove()}),e.querySelector("#tts-provider").addEventListener("change",t=>{const n=t.target.value;["google","openai","gemini"].forEach(t=>{const a=e?.querySelector(`#tts-${t}-container`);a&&(a.style.display=t===n?"":"none")})});const u=e.querySelector("#useCustomSelectors"),m=e.querySelector("#selectorsSettings");u.addEventListener("change",t=>{m.style.display=t.target.checked?"block":"none"});const y=e.querySelector("#useCustomPrompt"),f=e.querySelector("#promptSettings");y&&f&&y.addEventListener("change",t=>{f.style.display=t.target.checked?"block":"none"});const v=e.querySelector("#displayMode");v&&v.addEventListener("change",t=>{e.querySelector("#languageLearningOptions").style.display="language_learning"===t.target.value?"block":"none"}),["Speed","Pitch","Volume"].forEach(t=>{const n=e.querySelector(`#ttsDefault${t}`);n.addEventListener("input",()=>{n.nextElementSibling.textContent=parseFloat(n.value).toFixed(1)})});const b=t=>{"Escape"===t.key&&(document.removeEventListener("keydown",b),e&&e.parentNode&&e.parentNode.removeChild(e))};document.addEventListener("keydown",b);const _=e.querySelector("#exportSettings"),x=e.querySelector("#importSettings"),S=e.querySelector("#importInput");return _.addEventListener("click",()=>this.exportSettings()),x.addEventListener("click",()=>S.click()),S.addEventListener("change",async t=>{const e=t.target.files[0];if(e)try{await this.importSettings(e),this.showNotification(this._("notifications.import_success")),setTimeout(()=>location.reload(),1500)}catch(t){this.showNotification(t.message,"error")}}),e.querySelector("#cancelSettings").addEventListener("click",()=>{this.translator.ui.shadowRoot.querySelector(".settings-container").remove(),this.isSettingsUIOpen=!1}),e.querySelector("#saveSettings").addEventListener("click",()=>{this.saveSettings(e),this.translator.ui.shadowRoot.querySelector(".settings-container").remove(),this.isSettingsUIOpen=!1,location.reload()}),e}getScriptVersion(){try{return GM_info.script.version||"unknown"}catch(t){return console.warn("Không thể lấy version từ metadata:",t),"unknown"}}async exportSettings(){try{const t=this.settings,e=(new Date).toISOString().replace(/[:.]/g,"-"),n=this.getScriptVersion(),a=`king1x32-translator-settings-v${n}-${e}.json`,i=LZString.compressToBase64(JSON.stringify(t)),s={version:n,timestamp:Date.now(),compressed:!0,data:i},o=new Blob([JSON.stringify(s,null,2)],{type:"application/json"}),r=URL.createObjectURL(o),l=document.createElement("a");l.href=r,l.download=a,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(r)}catch(t){throw console.error("Export error:",t),new Error(this._("notifications.export_error"))}}async importSettings(t){try{const e=await new Promise((e,n)=>{const a=new FileReader;a.onload=()=>e(a.result),a.onerror=()=>n(new Error(this._("notifications.failed_read_file"))),a.readAsText(t)});let n,a;try{n=JSON.parse(e)}catch(t){throw new Error(this._("notifications.invalid_settings_file"))}if(!this.validateImportFormat(n))throw new Error(this._("notifications.invalid_settings_format"));if(n.compressed)try{a=JSON.parse(LZString.decompressFromBase64(n.data))}catch(t){throw new Error(this._("notifications.decompression_error"))}else a=n.data||n;if(!this.validateImportedSettings(a))throw new Error(this._("notifications.invalid_settings"));const i=this.mergeWithDefaults(a);return GM_setValue("translatorSettings",JSON.stringify(i)),!0}catch(t){throw console.error("Import error:",t),new Error(this._("notifications.import_error")+` ${t.message}`)}}validateImportFormat(t){return!!t&&(t.compressed?"string"==typeof t.version&&"number"==typeof t.timestamp&&"string"==typeof t.data:this.validateImportedSettings(t))}validateImportedSettings(t){return["theme","apiProvider","apiKey","ocrOptions","mediaOptions","displayOptions","shortcuts","cacheOptions","rateLimit"].every(e=>t.hasOwnProperty(e))}showNotification(t,e="info"){const n=document.createElement("div");n.className="translator-notification";const a={info:"#4a90e2",success:"#28a745",warning:"#ffc107",error:"#dc3545"},i=a[e]||a.info,s="warning"===e?"#000":"#fff";Object.assign(n.style,{position:"fixed",top:"20px",left:window.innerWidth/2+"px",transform:"translateX(-50%)",backgroundColor:i,color:s,padding:"10px 20px",borderRadius:"8px",zIndex:"2147483647",animation:"fadeInOut 2s ease",fontFamily:"'GoMono Nerd Font', 'Noto Sans', Arial",fontSize:"14px",boxShadow:"0 2px 10px rgba(0,0,0,0.2)"}),n.innerText=t,document.body.appendChild(n),setTimeout(()=>n.remove(),5e3)}loadSettings(){const t=GM_getValue("translatorSettings");return t?this.mergeWithDefaults(JSON.parse(t)):r}mergeWithDefaults(t){return{...r,...t,geminiOptions:{...r.geminiOptions,...t?.geminiOptions||{}},perplexityOptions:{...r.perplexityOptions,...t?.perplexityOptions||{}},claudeOptions:{...r.claudeOptions,...t?.claudeOptions||{}},openaiOptions:{...r.openaiOptions,...t?.openaiOptions||{}},mistralOptions:{...r.mistralOptions,...t?.mistralOptions||{}},deepseekOptions:{...r.deepseekOptions,...t?.deepseekOptions||{}},ollamaOptions:{...r.ollamaOptions,...t?.ollamaOptions||{}},apiKey:{gemini:[...t?.apiKey?.gemini||r.apiKey.gemini],perplexity:[...t?.apiKey?.perplexity||r.apiKey.perplexity],claude:[...t?.apiKey?.claude||r.apiKey.claude],openai:[...t?.apiKey?.openai||r.apiKey.openai],mistral:[...t?.apiKey?.mistral||r.apiKey.mistral],deepseek:[...t?.apiKey?.deepseek||r.apiKey.deepseek]},currentKeyIndex:{...r.currentKeyIndex,...t?.currentKeyIndex||{}},contextMenu:{...r.contextMenu,...t?.contextMenu||{}},promptSettings:{...r.promptSettings,...t?.promptSettings||{}},inputTranslation:{...r.inputTranslation,...t?.inputTranslation||{}},translatorTools:{...r.translatorTools,...t?.translatorTools||{}},pageTranslation:{...r.pageTranslation,...t?.pageTranslation||{}},ocrOptions:{...r.ocrOptions,...t?.ocrOptions||{}},mediaOptions:{...r.mediaOptions,...t?.mediaOptions||{}},videoStreamingOptions:{...r.videoStreamingOptions,...t?.videoStreamingOptions||{}},displayOptions:{...r.displayOptions,...t?.displayOptions||{}},ttsOptions:{...r.ttsOptions,...t?.ttsOptions||{}},shortcuts:{...r.shortcuts,...t?.shortcuts||{}},clickOptions:{...r.clickOptions,...t?.clickOptions||{}},touchOptions:{...r.touchOptions,...t?.touchOptions||{}},cacheOptions:{text:{...r.cacheOptions.text,...t?.cacheOptions?.text||{}},image:{...r.cacheOptions.image,...t?.cacheOptions?.image||{}},media:{...r.cacheOptions.media,...t?.cacheOptions?.media||{}},tts:{...r.cacheOptions.tts,...t?.cacheOptions?.tts||{}}},rateLimit:{...r.rateLimit,...t?.rateLimit||{}}}}saveSettings(t){const n=Array.from(t.querySelectorAll(".gemini-key")).map(t=>t.value.trim()).filter(t=>""!==t),a=Array.from(t.querySelectorAll(".perplexity-key")).map(t=>t.value.trim()).filter(t=>""!==t),i=Array.from(t.querySelectorAll(".claude-key")).map(t=>t.value.trim()).filter(t=>""!==t),s=Array.from(t.querySelectorAll(".openai-key")).map(t=>t.value.trim()).filter(t=>""!==t),l=Array.from(t.querySelectorAll(".mistral-key")).map(t=>t.value.trim()).filter(t=>""!==t),c=Array.from(t.querySelectorAll(".deepseek-key")).map(t=>t.value.trim()).filter(t=>""!==t),d=t.querySelector("#useCustomSelectors").checked,p=t.querySelector("#customSelectors").value.split("\n").map(t=>t.trim()).filter(t=>t&&t.length>0),h=t.querySelector("#combineWithDefault").checked,g=t.querySelector("#maxPopupWidth").value,u=window.innerWidth*parseInt(g)/100,m=parseInt(t.querySelector("#minPopupWidth").value)>u?g:t.querySelector("#minPopupWidth").value,y={theme:t.querySelector('input[name="theme"]:checked').value,uiLanguage:t.querySelector('input[name="uiLanguage"]:checked').value,apiProvider:t.querySelector('input[name="apiProvider"]:checked').value,apiKey:{gemini:n.length>0?n:[r.apiKey.gemini[0]],perplexity:a.length>0?a:[r.apiKey.perplexity[0]],claude:i.length>0?i:[r.apiKey.claude[0]],openai:s.length>0?s:[r.apiKey.openai[0]],mistral:l.length>0?l:[r.apiKey.mistral[0]],deepseek:c.length>0?c:[r.apiKey.deepseek[0]]},currentKeyIndex:{gemini:0,perplexity:0,claude:0,openai:0,mistral:0,deepseek:0},geminiOptions:{modelType:t.querySelector("#geminiModelType")?.value,fastModel:t.querySelector("#gemini-fast-model")?.value,proModel:t.querySelector("#gemini-pro-model")?.value,thinkModel:t.querySelector("#gemini-think-model")?.value,customModel:t.querySelector("#gemini-custom-model")?.value},perplexityOptions:{modelType:t.querySelector("#perplexityModelType")?.value,fastModel:t.querySelector("#perplexity-fast-model")?.value,balanceModel:t.querySelector("#perplexity-balance-model")?.value,proModel:t.querySelector("#perplexity-pro-model")?.value,customModel:t.querySelector("#perplexity-custom-model")?.value},claudeOptions:{modelType:t.querySelector("#claudeModelType")?.value,fastModel:t.querySelector("#claude-fast-model")?.value,balanceModel:t.querySelector("#claude-balance-model")?.value,proModel:t.querySelector("#claude-pro-model")?.value,customModel:t.querySelector("#claude-custom-model")?.value},openaiOptions:{modelType:t.querySelector("#openaiModelType")?.value,fastModel:t.querySelector("#openai-fast-model")?.value,balanceModel:t.querySelector("#openai-balance-model")?.value,proModel:t.querySelector("#openai-pro-model")?.value,customModel:t.querySelector("#openai-custom-model")?.value},mistralOptions:{modelType:t.querySelector("#mistralModelType")?.value,freeModel:t.querySelector("#mistral-free-model")?.value,researchModel:t.querySelector("#mistral-research-model")?.value,premierModel:t.querySelector("#mistral-premier-model")?.value,customModel:t.querySelector("#mistral-custom-model")?.value},deepseekOptions:{modelType:t.querySelector("#deepseekModelType")?.value,fastModel:t.querySelector("#deepseek-fast-model")?.value,customModel:t.querySelector("#deepseek-custom-model")?.value},ollamaOptions:{endpoint:t.querySelector("#ollama-endpoint")?.value.trim(),model:t.querySelector("#ollama-custom-model")?.value.trim(),temperature:parseFloat(t.querySelector("#ollama-temperature")?.value),topP:parseFloat(t.querySelector("#ollama-top-p")?.value),topK:parseInt(t.querySelector("#ollama-top-k")?.value,10)},contextMenu:{enabled:t.querySelector("#contextMenuEnabled").checked},inputTranslation:{enabled:t.querySelector("#inputTranslationEnabled").checked,savePosition:t.querySelector("#inputTranslationSavePosition").checked},translatorTools:{enabled:t.querySelector("#ToolsEnabled").checked},promptSettings:{enabled:!0,useCustom:t.querySelector("#useCustomPrompt").checked,customPrompts:{normal:t.querySelector("#normalPrompt").value.trim(),normal_chinese:t.querySelector("#normalPrompt_chinese").value.trim(),advanced:t.querySelector("#advancedPrompt").value.trim(),advanced_chinese:t.querySelector("#advancedPrompt_chinese").value.trim(),ocr:t.querySelector("#ocrPrompt").value.trim(),ocr_chinese:t.querySelector("#ocrPrompt_chinese").value.trim(),media:t.querySelector("#mediaPrompt").value.trim(),media_chinese:t.querySelector("#mediaPrompt_chinese").value.trim(),page:t.querySelector("#pagePrompt").value.trim(),page_chinese:t.querySelector("#pagePrompt_chinese").value.trim(),file_content:t.querySelector("#fileContentPrompt").value.trim(),file_content_chinese:t.querySelector("#fileContentPrompt_chinese").value.trim()}},pageTranslation:{enabled:t.querySelector("#pageTranslationEnabled").checked,autoTranslate:t.querySelector("#autoTranslatePage").checked,showInitialButton:t.querySelector("#showInitialButton").checked,buttonTimeout:r.pageTranslation.buttonTimeout,enableGoogleTranslate:t.querySelector("#enableGoogleTranslate").checked,googleTranslateLayout:t.querySelector("#googleTranslateLayout").value,useCustomSelectors:d,customSelectors:p,combineWithDefault:h,defaultSelectors:r.pageTranslation.defaultSelectors,excludeSelectors:d?h?[...new Set([...r.pageTranslation.defaultSelectors,...p])]:p:r.pageTranslation.defaultSelectors,generation:{temperature:parseFloat(t.querySelector("#pageTranslationTemperature").value),topP:parseFloat(t.querySelector("#pageTranslationTopP").value),topK:parseInt(t.querySelector("#pageTranslationTopK").value)}},ocrOptions:{enabled:t.querySelector("#ocrEnabled").checked,mangaTranslateAll:t.querySelector("#mangaTranslateAll").checked,preferredProvider:t.querySelector('input[name="apiProvider"]:checked').value,maxFileSize:o.OCR.maxFileSize,temperature:parseFloat(t.querySelector("#ocrTemperature").value),topP:parseFloat(t.querySelector("#ocrTopP").value),topK:parseInt(t.querySelector("#ocrTopK").value)},mediaOptions:{enabled:t.querySelector("#mediaEnabled").checked,temperature:parseFloat(t.querySelector("#mediaTemperature").value),topP:parseFloat(t.querySelector("#mediaTopP").value),topK:parseInt(t.querySelector("#mediaTopK").value)},videoStreamingOptions:{enabled:t.querySelector("#videoStreamingEnabled").checked,fontSize:t.querySelector("#videoStreamingFontSize").value,backgroundColor:t.querySelector("#videoStreamingBgColor").value,textColor:t.querySelector("#videoStreamingTextColor").value},displayOptions:{fontSize:t.querySelector("#fontSize").value,minPopupWidth:m,maxPopupWidth:g,webImageTranslation:{fontSize:t.querySelector("#webImageFontSize").value},translationMode:t.querySelector("#displayMode").value,targetLanguage:t.querySelector("#targetLanguage").value,sourceLanguage:t.querySelector("#sourceLanguage").value,languageLearning:{enabled:"language_learning"===t.querySelector("#displayMode").value,showSource:t.querySelector("#showSource").checked}},ttsOptions:{enabled:t.querySelector("#ttsEnabled").checked,defaultGeminiModel:t.querySelector("#tts-gemini-model").value,defaultProvider:t.querySelector("#tts-provider").value,defaultModel:t.querySelector("#tts-openai-model").value,defaultSpeed:parseFloat(t.querySelector("#ttsDefaultSpeed").value),defaultPitch:parseFloat(t.querySelector("#ttsDefaultPitch").value),defaultVolume:parseFloat(t.querySelector("#ttsDefaultVolume").value)},shortcuts:{settingsEnabled:t.querySelector("#settingsShortcutEnabled").checked,enabled:t.querySelector("#shortcutsEnabled").checked,ocrRegion:{key:t.querySelector("#ocrRegionKey").value,altKey:!0},ocrWebImage:{key:t.querySelector("#ocrWebImageKey").value,altKey:!0},ocrMangaWeb:{key:t.querySelector("#ocrMangaWebKey").value,altKey:!0},pageTranslate:{key:t.querySelector("#pageTranslateKey").value,altKey:!0},inputTranslate:{key:t.querySelector("#inputTranslationKey").value,altKey:!0},quickTranslate:{key:t.querySelector("#quickKey").value,altKey:!0},popupTranslate:{key:t.querySelector("#popupKey").value,altKey:!0},advancedTranslate:{key:t.querySelector("#advancedKey").value,altKey:!0}},clickOptions:{enabled:t.querySelector("#translationButtonEnabled").checked,singleClick:{translateType:t.querySelector("#singleClickSelect").value},doubleClick:{translateType:t.querySelector("#doubleClickSelect").value},hold:{translateType:t.querySelector("#holdSelect").value}},touchOptions:{enabled:t.querySelector("#touchEnabled").checked,sensitivity:parseInt(t.querySelector("#touchSensitivity").value),twoFingers:{translateType:t.querySelector("#twoFingersSelect").value},threeFingers:{translateType:t.querySelector("#threeFingersSelect").value}},cacheOptions:{text:{enabled:t.querySelector("#textCacheEnabled").checked,maxSize:parseInt(t.querySelector("#textCacheMaxSize").value),expirationTime:parseInt(t.querySelector("#textCacheExpiration").value)},image:{enabled:t.querySelector("#imageCacheEnabled").checked,maxSize:parseInt(t.querySelector("#imageCacheMaxSize").value),expirationTime:parseInt(t.querySelector("#imageCacheExpiration").value)},media:{enabled:t.querySelector("#mediaCacheEnabled").checked,maxSize:parseInt(t.querySelector("#mediaCacheMaxSize").value),expirationTime:parseInt(t.querySelector("#mediaCacheExpiration").value)},tts:{enabled:t.querySelector("#ttsCacheEnabled").checked,maxSize:parseInt(t.querySelector("#ttsCacheMaxSize").value),expirationTime:parseInt(t.querySelector("#ttsCacheExpiration").value)}},rateLimit:{maxRequests:parseInt(t.querySelector("#maxRequests").value),perMilliseconds:parseInt(t.querySelector("#perMilliseconds").value)}},f=t.querySelector("#tts-provider").value,v=this.settings.ttsOptions?.defaultVoice;if("gemini"===f){const e=t.querySelector("#tts-gemini-select").value;y.ttsOptions.defaultVoice={...v,gemini:{}},y.ttsOptions.defaultVoice.gemini.voice=e}else if("openai"===f){const e=t.querySelector("#tts-openai-select").value;y.ttsOptions.defaultVoice={...v,openai:{}},y.ttsOptions.defaultVoice.openai.voice=e}else"google"===f&&(y.ttsOptions.defaultVoice={...v,google:{}},Object.keys(o.TTS.GOOGLE.VOICES).forEach(e=>{const n=t.querySelector(`#tts-google-select[data-lang="${e}"]`).value;y.ttsOptions.defaultVoice.google[e]={name:n,display:o.TTS.GOOGLE.VOICES[e].find(t=>t.name===n).display}}));const b=t.querySelector("#showTranslatorTools").checked;e("translatorToolsEnabled",b.toString()),e("kingtranslator_manga_all_for_site",t.querySelector("#mangaTranslateAllSiteOnly").checked.toString()),this.translator.ui.removeToolsContainer(),this.translator.ui.resetState(),this.settings.translatorTools?.enabled&&b&&this.translator.ui.setupTranslatorTools(),this.currentLanguage=o.LANG_DATA[y.uiLanguage];const _=this.mergeWithDefaults(y);GM_setValue("translatorSettings",JSON.stringify(_)),this.settings=_;const x=new CustomEvent("settingsChanged",{detail:_});return document.dispatchEvent(x),_}getSetting(t){return t.split(".").reduce((t,e)=>t?.[e],this.settings)}}class d{constructor(t,e){this.settings=t,this._=e,this.failedKeys=new Map,this.activeKeys=new Map,this.keyStats=new Map,this.rateLimitedKeys=new Map,this.keyRotationInterval=1e4,this.maxConcurrentRequests=5,this.retryDelays=[1e3,2e3,4e3],this.successRateThreshold=.7,this.lastSuccessfulIndex=null,this.setupKeyRotation()}markKeyAsRateLimited(t){const e=Date.now();this.rateLimitedKeys.set(t,{timestamp:e,retryAfter:e+this.settings.rateLimit.perMilliseconds})}getAvailableKeys(t){const e=this.settings.apiKey[t];if(!e||0===e.length)throw new Error(this._("notifications.no_api_key_configured"));const n=Date.now(),a=e.filter(t=>{if(!t)return!1;const e=this.failedKeys.get(t),a=this.activeKeys.get(t),i=this.rateLimitedKeys.get(t),s=this.keyStats.get(t),o=e&&n-e.timestamp<6e4,r=a&&a.requests>=this.maxConcurrentRequests,l=i&&n<i.retryAfter,c=s&&s.total>10&&s.success/s.total<this.successRateThreshold;return!(o||r||l||c)});if(null!==this.lastSuccessfulIndex&&a.length>1){const t=e[this.lastSuccessfulIndex];if(a.includes(t)){const e=a.indexOf(t);-1!==e&&(a.splice(e,1),a.push(t))}}return a}async executeWithMultipleKeys(t,e,n=3){const a=this.getAvailableKeys(e);if(!a||0===a.length)throw new Error(this._("notifications.no_api_key_available"));const i=[],s=[];let o=0;const r=async()=>{if(o>=a.length)return null;const e=a[++o];try{const n=await this.useKey(e,()=>t(e));if(n)return this.updateKeyStats(e,!0),{status:"fulfilled",value:n}}catch(t){return this.updateKeyStats(e,!1),401===t.status?(this.markKeyAsFailed(e),i.push(`API key ${e.slice(0,8)}... invalid`)):429===t.status?(this.markKeyAsRateLimited(e),i.push(`API key ${e.slice(0,8)}... is rate-limitd`)):i.push(`API key ${e.slice(0,8)}... : ${t.message}`),o<a.length?r():{status:"rejected",reason:t}}},l=Math.min(n,a.length);for(let t=0;t<l;t++)s.push(r());const c=(await Promise.all(s)).filter(t=>t&&"fulfilled"===t.status).map(t=>t.value);if(c.length>0)return c;const d={invalid:i.filter(t=>t.includes("invalid")),rateLimit:i.filter(t=>t.includes("rate-limitd")),other:i.filter(t=>!t.includes("invalid")&&!t.includes("rate-limitd"))};let p=this._("notifications.all_keys_failed");throw d.invalid.length>0&&(p+="\nInvalid API key:\n"+d.invalid.join("\n")),d.rateLimit.length>0&&(p+="\nAPI key rate limited:\n"+d.rateLimit.join("\n")),d.other.length>0&&(p+="\nOther errors:\n"+d.other.join("\n")),new Error(p)}async useKey(t,e){let n=this.activeKeys.get(t)||{requests:0,timestamp:Date.now()};const a=this.rateLimitedKeys.get(t);if(a&&Date.now()<a.retryAfter)throw new Error(`API key ${t.slice(0,8)}... is rate-limited. Retrying in ${Math.ceil((a.retryAfter-Date.now())/1e3)}s`);if(n.requests>=this.maxConcurrentRequests)throw new Error(`API key ${t.slice(0,8)}... `+this._("notifications.too_many_requests"));n.requests++,this.activeKeys.set(t,n);try{return await e()}catch(e){if(429===e.status){const n=Date.now()+(1e3*parseInt(e.headers?.["retry-after"])||6e4);throw this.rateLimitedKeys.set(t,{retryAfter:n}),new Error(`Rate limitd: ${e.message}`)}throw e}finally{n=this.activeKeys.get(t),n&&(n.requests--,n.requests<=0?this.activeKeys.delete(t):this.activeKeys.set(t,n))}}markKeyAsFailed(t){if(!t)return;const e=this.failedKeys.get(t)||{failures:0};e.failures++,e.timestamp=Date.now(),this.failedKeys.set(t,e),this.activeKeys.has(t)&&this.activeKeys.delete(t),this.updateKeyStats(t,!1),console.log(`Marked key as failed: ${t.slice(0,8)}... (${e.failures} failures)`)}updateKeyStats(t,e){const n=this.keyStats.get(t)||{success:0,fails:0,total:0,lastUsed:0,avgResponseTime:0};n.total++,e?n.success++:n.fails++,n.lastUsed=Date.now(),this.keyStats.set(t,n)}setupKeyRotation(){setInterval(()=>{const t=Date.now();for(const[e,n]of this.rateLimitedKeys.entries())t>=n.retryAfter&&this.rateLimitedKeys.delete(e);for(const[e,n]of this.failedKeys.entries())t-n.timestamp>=6e4&&this.failedKeys.delete(e);for(const[e,n]of this.activeKeys.entries())t-n.timestamp>=3e4&&(n.requests=0,this.activeKeys.set(e,n));for(const[e,n]of this.keyStats.entries())t-n.lastUsed>36e5&&(n.success=Math.floor(.9*n.success),n.total=Math.floor(.9*n.total),this.keyStats.set(e,n))},this.keyRotationInterval)}}class p{constructor(t,e,n){this.config=t,this.getSettings=e,this._=n,this.keyManager=new d(e(),n),this.currentProvider=e().apiProvider}async request(t,e="normal",n=null){if(!this.config.providers[this.currentProvider])throw new Error(`Provider ${this.currentProvider} not found`);try{if("ollama"===this.currentProvider)return await this.makeApiRequest(null,t,e);const a=this.getSettings();let i=[];if(i=n?[n]:this.keyManager.getAvailableKeys(a.apiProvider),!i||0===i.length)throw new Error(this._("notifications.no_api_key_available"));const s=[];for(let a=0;a<i.length;a++){const o=i[a];try{const n=await this.keyManager.useKey(o,()=>this.makeApiRequest(o,t,e));if(n)return this.keyManager.updateKeyStats(o,!0),n}catch(t){this.keyManager.updateKeyStats(o,!1);const e=o.slice(0,8);if(401===t.status||403===t.status?(this.keyManager.markKeyAsFailed(o),s.push(`API Key ${e}... invalid`)):429===t.status?(this.keyManager.markKeyAsRateLimited(o),s.push(`API Key ${e}... is rate-limited`)):s.push(`API Key ${e}... : ${t.message}`),n||a===i.length-1||401===t.status||403===t.status)throw new Error(this._("notifications.all_keys_failed")+` ${s.join("\n")}`);await new Promise(t=>setTimeout(t,100))}}throw new Error(this._("notifications.unknown_api_error"))}catch(t){throw console.error("Request failed:",t),t}}async makeApiRequest(t,e,n="normal"){const a=this.getAPIConfig(t,e,n);return new Promise((t,e)=>{GM_xmlhttpRequest({method:"POST",url:a.url,headers:a.headers,data:JSON.stringify(a.body),responseType:"json",onload:n=>{if(n.status>=200&&n.status<300)try{const e=a.responseParser(n.response);t(e)}catch(t){e({status:n.status,message:this._("notifications.api_response_parse_error")})}else e({status:n.status,message:n.response?.error?.message||this._("notifications.unknown_api_error")})},onerror:()=>{e({status:0,message:this._("notifications.network_error")})}})})}getAPIConfig(t,e,n="normal"){const a=this.getSettings(),i=a.apiProvider,s=this.config.providers[i],o=this.getGenerationConfig(n);switch(i){case"gemini":const n=this.getGeminiModel();return{url:`${s.baseUrl}/${n}:generateContent?key=${t}`,headers:s.headers,body:s.createRequestBody(e,o),responseParser:s.responseParser};case"perplexity":case"claude":case"openai":case"mistral":case"deepseek":const r=this.getModel();let l=s.createRequestBody(e,r,o.temperature,o.topP);return"perplexity"!==i&&"claude"!==i&&"mistral"!==i||void 0!==o.topK&&(l.top_k=o.topK),{url:s.baseUrl,headers:s.headers(t),body:l,responseParser:s.responseParser};case"ollama":const c=this.getModel(),d=a.ollamaOptions.endpoint,{temperature:p,topP:h,topK:g}=a.ollamaOptions;return{url:`${d}/api/generate`,headers:s.headers,body:s.createRequestBody(e,c,p,h,g),responseParser:s.responseParser};default:throw new Error(this._("notifications.unsupported_provider")+` ${i}`)}}getGenerationConfig(t){const e=this.getSettings();switch(t){case"ocr":return{temperature:e.ocrOptions.temperature,topP:e.ocrOptions.topP,topK:e.ocrOptions.topK};case"media":return{temperature:e.mediaOptions.temperature,topP:e.mediaOptions.topP,topK:e.mediaOptions.topK};default:return{temperature:e.pageTranslation.generation.temperature,topP:e.pageTranslation.generation.topP,topK:e.pageTranslation.generation.topK}}}getModel(){const t=this.getSettings(),e=t.apiProvider;if("gemini"===e)return this.getGeminiModel();if("mistral"===e)return this.getMistralModel();if("deepseek"===e)return this.getDeepseekModel();if("ollama"===e)return t.ollamaOptions.model||"llama3";const n=t[`${e}Options`],a=this.config.providers[e];switch(n.modelType){case"fast":return n.fastModel;case"balance":return n.balanceModel;case"pro":return n.proModel;case"custom":return n.customModel||a.models.fast[0];default:return a.models.fast[0]}}getGeminiModel(){const t=this.getSettings().geminiOptions;switch(t.modelType){case"fast":return t.fastModel;case"pro":return t.proModel;case"think":return t.thinkModel;case"custom":return t.customModel||"gemini-2.0-flash-lite";default:return"gemini-2.0-flash-lite"}}getMistralModel(){const t=this.getSettings().mistralOptions;switch(t.modelType){case"free":return t.freeModel;case"research":return t.researchModel;case"premier":return t.premierModel;case"custom":return t.customModel||"mistral-small-latest";default:return"mistral-small-latest"}}getDeepseekModel(){const t=this.getSettings().deepseekOptions;switch(t.modelType){case"fast":return t.fastModel;case"custom":return t.customModel||"deepseek-chat";default:return"deepseek-chat"}}}class h{constructor(t){this.translator=t,this.settings=this.translator.userSettings.settings,this._=this.translator.userSettings._,this.isSelectOpen=!1,this.isTranslating=!1,this.activeButtons=new Map,this._focusinHandler=this.handleFocusIn.bind(this),this._focusoutHandler=this.handleFocusOut.bind(this),this._inputHandler=this.handleInput.bind(this),this.setupObservers(),this.setupEventListeners(),this.initializeExistingEditors()}setupObservers(){const t=this.settings;t.inputTranslation?.enabled&&(this.mutationObserver=new MutationObserver(t=>{t.forEach(t=>{t.addedNodes.forEach(t=>{1===t.nodeType&&this.handleNewNode(t)}),t.removedNodes.forEach(t=>{1===t.nodeType&&this.handleRemovedNode(t)})})}),this.resizeObserver=new ResizeObserver(i(t=>{t.forEach(t=>{const e=this.findParentEditor(t.target);e&&this.updateButtonPosition(e)})},100)),this.mutationObserver.observe(document.body,{childList:!0,subtree:!0}))}getEditorSelectors(){return[".fr-element.fr-view",".message-editable",".js-editor",".xenForm textarea",'[contenteditable="true"]','[role="textbox"]',"textarea",'input[type="text"]'].join(",")}isValidEditor(t){const e=this.settings;if(!e.inputTranslation?.enabled&&!e.shortcuts?.enabled)return;if(!t)return!1;const n=window.getComputedStyle(t);if("none"===n.display||"hidden"===n.visibility)return!1;const a=t.getBoundingClientRect();return 0!==a.width&&0!==a.height&&t.matches(this.getEditorSelectors())}findParentEditor(t){for(;t&&t!==document.body;){if(this.isValidEditor(t))return t;if("IFRAME"===t.tagName)try{const e=t.contentDocument;if(e&&this.isValidEditor(e.body))return e.body}catch(t){}t=t.parentElement}return null}setupEventListeners(){const t=this.settings;t.inputTranslation?.enabled&&(document.addEventListener("focusin",this._focusinHandler),document.addEventListener("focusout",this._focusoutHandler),document.addEventListener("input",this._inputHandler))}handleFocusIn(t){const e=this.findParentEditor(t.target);e&&(this.addTranslateButton(e),this.updateButtonVisibility(e))}handleFocusOut(t){const e=this.findParentEditor(t.target);e&&setTimeout(()=>{if(this.isSelectOpen)return;const t=document.activeElement,n=this.activeButtons.get(e),a=n&&(n===t||n.contains(t)),i=e===t||e.contains(t);a||i||this.removeTranslateButton(e)},100)}handleInput(t){const e=this.findParentEditor(t.target);e&&(this.activeButtons.has(e)||this.addTranslateButton(e),this.updateButtonVisibility(e))}updateButtonVisibility(t){const e=this.activeButtons.get(t);if(e){const n=this.getEditorContent(t);e.style.display=n?"":"none"}}getEditorContent(t){const e=this.settings;if(!e.inputTranslation?.enabled&&!e.shortcuts?.enabled)return;let n="";return void 0!==t.value?n=t.value:void 0!==t.textContent?n=t.textContent:void 0!==t.innerText&&(n=t.innerText),n.trim()}setEditorContent(t,e){t.matches(".fr-element.fr-view")?t.innerHTML=e:void 0!==t.value?t.value=e:t.innerHTML=e,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0}))}createButton(t,e){const n=document.createElement("button");n.className="input-translate-button",n.innerHTML=t,n.title=e;const a=this.getCurrentTheme();return n.style.cssText=`\nbackground-color: ${a.backgroundColor};\ncolor: ${a.text};\nborder: none;\nborder-radius: 8px;\npadding: 4px;\nfont-size: 16px;\ncursor: pointer;\ndisplay: flex;\nalign-items: center;\njustify-content: center;\nmin-width: 28px;\nheight: 28px;\ntransition: all 0.15s ease;\nmargin: 0;\noutline: none;\n`,n.onmouseover=()=>{n.style.background=a.hoverBg,n.style.color=a.hoverText},n.onmouseout=()=>{n.style.background="transparent",n.style.color=a.text},n}createButtonContainer(){const t=document.createElement("div");t.className="input-translate-button-container";const e=this.getCurrentTheme();return t.style.cssText=`\nposition: absolute;\ndisplay: flex;\nflex-direction: column;\ngap: 5px;\nz-index: 2147483647;\npointer-events: auto;\nbackground-color: rgba(0,74,153,0.5);\nborder-radius: 8px;\npadding: 5px;\nbox-shadow: 0 2px 5px rgba(0,0,0,0.3);\nborder: 1px solid ${e.border};\n`,t}addTranslateButton(a){if(this.activeButtons.has(a))return void this.updateButtonVisibility(a);const i=this.createButtonContainer(),s=this.settings.displayOptions;let r,l,c,d,p=!1,h=0,g=0;const u=document.createElement("div");u.className="translate-drag-handle",u.textContent="⋮King1x32⋮",Object.assign(u.style,{padding:"2px 5px",cursor:"grab",color:"#999",fontSize:"12px",userSelect:"none",display:"flex",alignItems:"center",justifyContent:"center",borderRadius:"4px",marginRight:"5px"}),i.insertBefore(u,i.firstChild);const m=t=>t.type.startsWith("touch")?{x:t.touches[0].clientX,y:t.touches[0].clientY}:{x:t.clientX,y:t.clientY},y=(t,e,n)=>{n.style.transform=`translate(${t}px, ${e}px)`},f=t=>{const e=m(t);e&&(c=e.x-h,d=e.y-g,t.target===u&&(p=!0,i.style.cursor="grabbing"),"touchstart"===t.type&&t.preventDefault())},v=t=>{if(!p)return;t.preventDefault();const e=m(t);e&&(r=e.x-c,l=e.y-d,h=r,g=l,y(h,g,i),"touchmove"===t.type&&t.preventDefault())},b=()=>{if(p&&(p=!1,i.style.cursor="grab",this.settings.inputTranslation.savePosition)){const t={x:h,y:g};e("translatorButtonPosition",JSON.stringify(t))}};if(this.settings.inputTranslation.savePosition){const e=t("translatorButtonPosition");if(e)try{const t=JSON.parse(e);h=t.x,g=t.y,y(h,g,i)}catch(t){console.error("Error restoring position:",t)}}const _=document.createElement("button");_.textContent="↺",_.title="Reset vị trí",Object.assign(_.style,{position:"absolute",top:"-8px",right:"-8px",width:"20px",height:"20px",padding:"0",border:"none",borderRadius:"50%",backgroundColor:"#ff4444",color:"white",cursor:"pointer",display:"none",alignItems:"center",justifyContent:"center",fontSize:"12px",zIndex:"2147483647"}),_.onclick=()=>{h=0,g=0,y(0,0,i),n("translatorButtonPosition")},i.appendChild(_),i.addEventListener("mouseenter",()=>{0===h&&0===g||(_.style.display="flex")}),i.addEventListener("mouseleave",()=>{_.style.display="none"}),u.addEventListener("mousedown",f,!1),u.addEventListener("touchstart",f,!1),document.addEventListener("mousemove",v,!1),document.addEventListener("mouseup",b,!1),document.addEventListener("touchmove",v,!1),document.addEventListener("touchend",b,!1),i.cleanup=()=>{u.removeEventListener("mousedown",f),u.removeEventListener("touchstart",f),document.removeEventListener("mousemove",v),document.removeEventListener("mouseup",b),document.removeEventListener("touchmove",v),document.removeEventListener("touchend",b)};const x=document.createElement("div");x.style.cssText="\ndisplay: flex;\nalign-items: center;\ngap: 5px;\n";const S=this.createButton("🌐",this._("notifications.source_trans")),w=document.createElement("select"),T=this.getCurrentTheme();w.style.cssText=`\nbackground-color: ${T.backgroundColor};\ncolor: ${T.text};\ntransition: all 0.15s ease;\npadding: 4px;\nborder-radius: 6px;\nborder: none;\nmargin-left: 5px;\nfont-size: 14px;\nmax-height: 32px;\nwidth: auto;\nmin-width: 75px;\nmax-width: 100px;\n`;const k={auto:"Auto-detect",...o.LANGUAGES};for(const[t,e]of Object.entries(k)){const n=document.createElement("option");n.value=t,n.text=e,n.selected=t===s.sourceLanguage,w.appendChild(n)}w.addEventListener("mousedown",()=>{this.isSelectOpen=!0}),w.addEventListener("blur",()=>{setTimeout(()=>{this.isSelectOpen=!1},200)}),w.addEventListener("change",()=>{setTimeout(()=>{a.focus(),this.isSelectOpen=!1},200)}),S.onclick=async t=>{t.preventDefault(),t.stopPropagation();const e=w.value;await this.translateEditor(a,!0,e)},x.appendChild(S),x.appendChild(w);const E=document.createElement("div");E.style.cssText="\ndisplay: flex;\nalign-items: center;\ngap: 5px;\nmargin-top: 5px;\n";const C=this.createButton("🔄",this._("notifications.target_trans")),A=document.createElement("select");A.style.cssText=w.style.cssText;for(const[t,e]of Object.entries(k))if("auto"!==t){const n=document.createElement("option");n.value=t,n.text=e,n.selected=t===s.targetLanguage,A.appendChild(n)}A.addEventListener("mousedown",()=>{this.isSelectOpen=!0}),A.addEventListener("blur",()=>{setTimeout(()=>{this.isSelectOpen=!1},200)}),A.addEventListener("change",()=>{setTimeout(()=>{a.focus(),this.isSelectOpen=!1},200)}),C.onclick=async t=>{t.preventDefault(),t.stopPropagation();const e=A.value;await this.translateEditor(a,!1,e)},E.appendChild(C),E.appendChild(A),i.appendChild(x),i.appendChild(E),this.positionButtonContainer(i,a),this.translator.uiRoot.getRoot().appendChild(i),this.activeButtons.set(a,i),i.addEventListener("mousedown",t=>{"SELECT"!==t.target.tagName&&t.preventDefault()}),this.updateButtonVisibility(a),this.resizeObserver.observe(a)}async translateEditor(t,e,n){if(this.isTranslating)return;this.isTranslating=!0;const a=this.activeButtons.get(t),i=e?a.querySelector("button:first-of-type"):a.querySelector("button:last-of-type"),s=i.innerHTML;try{const a=this.getEditorContent(t);if(!a)return;i.textContent="⌛",i.style.opacity="0.7";const s=e&&"auto"===n?this.translator.page.languageCode:n,o=await this.translator.translate(a,null,!1,!1,s);if("translation_only"===this.settings.displayOptions.translationMode)this.setEditorContent(t,o);else{const e=o.split("\n");let n="";for(const t of e)n+=(t.split("<|>")[2]||t.replace("<|>",""))+"\n";this.setEditorContent(t,n)}}catch(t){console.error("Translation error:",t),this.translator.ui.showNotification(this.translator.userSettings._("notifications.translation_error")+t.message,"error")}finally{this.isTranslating=!1,i&&(i.innerHTML=s,i.style.opacity="1")}}positionButtonContainer(t,e){const n=e.getBoundingClientRect(),a=this.findEditorToolbar(e);if(a){const e=a.getBoundingClientRect();t.style.top=`${e.top+window.scrollY}px`,t.style.left=`${e.right+5}px`}else t.style.top=`${n.top+window.scrollY}px`,t.style.left=`${n.right+5}px`}findEditorToolbar(t){return t.closest(".fr-box")?.querySelector(".fr-toolbar")||t.closest(".xenForm")?.querySelector(".buttonGroup")}updateButtonPosition(t){const e=this.activeButtons.get(t);e&&this.positionButtonContainer(e,t)}getCurrentTheme(){const t=this.settings.theme,e="dark"===t;return{backgroundColor:e?"rgba(0,0,0,0.5)":"rgba(255,255,255,0.5)",text:e?"#fff":"#000",border:o.THEME[t].border,hoverBg:e?"#555":"#eee",hoverText:e?"#eee":"#555"}}updateAllButtonStyles(){const t=this.getCurrentTheme();this.activeButtons.forEach(e=>{e.style.background=t.background,e.style.borderColor=t.border,e.querySelectorAll(".input-translate-button").forEach(e=>{e.style.color=t.text})})}handleNewNode(t){this.isValidEditor(t)&&this.addTranslateButton(t),t.querySelectorAll(this.getEditorSelectors()).forEach(t=>{this.isValidEditor(t)&&this.addTranslateButton(t)})}handleRemovedNode(t){this.activeButtons.has(t)&&this.removeTranslateButton(t),t.querySelectorAll(this.getEditorSelectors()).forEach(t=>{this.activeButtons.has(t)&&this.removeTranslateButton(t)})}handleEditorFocus(t){this.getEditorContent(t)&&this.addTranslateButton(t)}handleEditorClick(t){this.getEditorContent(t)&&this.addTranslateButton(t)}removeTranslateButton(t){const e=this.activeButtons.get(t);e&&(e.cleanup(),e.remove(),this.activeButtons.delete(t),this.resizeObserver.unobserve(t))}initializeExistingEditors(){const t=this.settings;t.inputTranslation?.enabled&&document.querySelectorAll(this.getEditorSelectors()).forEach(t=>{this.isValidEditor(t)&&this.getEditorContent(t)&&this.addTranslateButton(t)})}cleanup(){this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),document.removeEventListener("focusin",this._focusinHandler),document.removeEventListener("focusout",this._focusoutHandler),document.removeEventListener("input",this._inputHandler),this.activeButtons.forEach(t=>{t.cleanup&&t.cleanup(),t.remove()}),this.activeButtons.clear()}}class g{constructor(t){if(!t)throw new Error("Translator instance is required for OCRManager");this.translator=t,this.isProcessing=!1,this._=this.translator.userSettings._}async captureScreen(){try{const t=this.translator.ui.$$(".translator-tools-container, .translator-notification, .center-translate-status");t.forEach(t=>{t&&(t.style.visibility="hidden")});try{const e=document.createElement("style");e.textContent='\n        .screenshot-overlay {\n          position: fixed;\n          top: 0;\n          left: 0;\n          width: 100%;\n          height: 100%;\n          background: rgba(0,0,0,0.3);\n          cursor: crosshair;\n          z-index: 2147483647;\n          touch-action: none;\n        }\n        .screenshot-guide {\n          position: fixed;\n          top: 20px;\n          left: 50%;\n          transform: translateX(-50%);\n          background: rgba(0,0,0,0.8);\n          color: white;\n          padding: 10px 20px;\n          border-radius: 8px;\n          z-index: 2147483648;\n          font-family: "GoMono Nerd Font", "Noto Sans", Arial;\n          font-size: 14px;\n          text-align: center;\n          white-space: nowrap;\n        }\n        .screenshot-cancel {\n          position: fixed;\n          top: 20px;\n          right: 20px;\n          background-color: #ff4444;\n          color: white;\n          border: none;\n          border-radius: 50%;\n          width: 30px;\n          height: 30px;\n          font-size: 16px;\n          cursor: pointer;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          z-index: 2147483647;\n          pointer-events: auto;\n        }\n        .screenshot-selection {\n          position: fixed;\n          border: 2px solid #4a90e2;\n          background: rgba(74,144,226,0.1);\n          z-index: 2147483647;\n        }',this.translator.uiRoot.getRoot().appendChild(e);const n=document.createElement("div");n.className="screenshot-overlay";const a=document.createElement("div");a.className="screenshot-guide",a.textContent=this._("notifications.cap_gui");const s=document.createElement("button");return s.className="screenshot-cancel",s.textContent="✕",this.translator.uiRoot.getRoot().appendChild(n),this.translator.uiRoot.getRoot().appendChild(a),this.translator.uiRoot.getRoot().appendChild(s),new Promise((o,r)=>{let l,c,d=null,p=!1;const h=t=>t.touches?{x:t.touches[0].clientX,y:t.touches[0].clientY}:{x:t.clientX,y:t.clientY},g=t=>{t.preventDefault();const e=h(t);l=e.x,c=e.y,p=!0,d&&d.remove(),d=document.createElement("div"),d.className="screenshot-selection",this.translator.uiRoot.getRoot().appendChild(d)},u=i(t=>{if(!p||!d)return;t.preventDefault();const e=h(t),n=e.x,a=e.y,i=Math.min(l,n),s=Math.min(c,a),o=Math.abs(n-l),r=Math.abs(a-c);o<10||r<10||requestAnimationFrame(()=>{d.style.left=i+"px",d.style.top=s+"px",d.style.width=o+"px",d.style.height=r+"px"})},16),m=i(async t=>{if(p&&d){t.preventDefault(),p=!1;try{this.translator.ui.showProcessingStatus("Capturing screenshot...");const t=d.getBoundingClientRect();if(t.width<10||t.height<10)return void d.remove();const e=document.createElement("video");e.style.cssText="position: fixed; top: -9999px; left: -9999px;",document.body.appendChild(e);const n=await navigator.mediaDevices.getDisplayMedia({preferCurrentTab:!0,video:{width:window.innerWidth,height:window.innerHeight}});e.srcObject=n,await e.play();const a=document.createElement("canvas"),i=a.getContext("2d");a.width=t.width,a.height=t.height,i.drawImage(e,t.left,t.top,t.width,t.height,0,0,t.width,t.height),n.getTracks().forEach(t=>t.stop()),e.remove();const s=i.getImageData(0,0,a.width,a.height).data;let r=!0;const l={r:s[0],g:s[1],b:s[2],a:s[3]};for(let t=4;t<s.length;t+=4)if(s[t]!==l.r||s[t+1]!==l.g||s[t+2]!==l.b||s[t+3]!==l.a){r=!1;break}const c=255===l.r&&255===l.g&&255===l.b||0===l.a;if(r&&c)throw new Error(this._("notifications.no_content_in_selection"));const p=await new Promise(t=>{a.toBlob(t,"image/png",1)});if(!p||p.size<100)throw new Error(this._("notifications.invalid_image_file"));const h=new File([p],"screenshot.png",{type:"image/png"});o(h)}catch(t){console.log("Primary method failed, switching to backup:",t);try{const t=d.getBoundingClientRect(),e=document.elementsFromPoint(t.left+t.width/2,t.top+t.height/2).find(t=>{const e=t.classList?Array.from(t.classList):[];return!(t.id||"").includes("translator")&&!e.some(t=>t.includes("translator"))&&!e.some(t=>t.includes("screenshot"))});if(!e)throw new Error(this._("notifications.cannot_identify_region"));if("IMG"===e.tagName||"CANVAS"===e.tagName){const n=document.createElement("canvas"),a=n.getContext("2d",{willReadFrequently:!0});if(n.width=t.width,n.height=t.height,"IMG"===e.tagName){const n=e.crossOrigin;e.crossOrigin="anonymous",await new Promise((t,a)=>{const i=()=>{e.removeEventListener("load",i),e.removeEventListener("error",s),t()},s=()=>{e.removeEventListener("load",i),e.removeEventListener("error",s),e.crossOrigin=n,a(new Error(this._("notifications.image_load_error")))};e.complete?t():(e.addEventListener("load",i),e.addEventListener("error",s))});const i=e.getBoundingClientRect(),s=t.left-i.left,o=t.top-i.top,r=e.naturalWidth/i.width,l=e.naturalHeight/i.height;a.drawImage(e,s*r,o*l,t.width*r,t.height*l,0,0,t.width,t.height),e.crossOrigin=n}else if("CANVAS"===e.tagName){const i=e.getContext("2d",{willReadFrequently:!0}),s=e.getBoundingClientRect(),o=t.left-s.left,r=t.top-s.top,l=e.width/s.width,c=e.height/s.height;try{const e=i.getImageData(o*l,r*c,t.width*l,t.height*c);n.width=e.width,n.height=e.height,a.putImageData(e,0,0)}catch(t){if("SecurityError"===t.name)throw new Error(this._("notifications.canvas_security_error"));throw t}}if(!a.getImageData(0,0,n.width,n.height).data.some(t=>0!==t))throw new Error(this._("notifications.cannot_capture_element"));const i=await new Promise((t,e)=>{n.toBlob(n=>{!n||n.size<100?e(new Error(this._("notifications.cannot_generate_valid"))):t(new File([n],"screenshot.png",{type:"image/png"}))},"image/png",1)});o(i)}else{const n=await html2canvas(e,{width:t.width,height:t.height,x:t.left-e.getBoundingClientRect().left,y:t.top-e.getBoundingClientRect().top,scale:2,logging:!1,useCORS:!0,allowTaint:!0,backgroundColor:"#ffffff",foreignObjectRendering:!0,removeContainer:!0,ignoreElements:t=>{const e=t.classList?Array.from(t.classList):[];return(t.id||"").includes("translator")||e.some(t=>t.includes("translator"))||e.some(t=>t.includes("screenshot"))},onclone:t=>{t.querySelectorAll('[id*="translator"], [class*="translator"], [class*="screenshot"]').forEach(t=>t.remove())}}),a=await new Promise((t,e)=>{n.toBlob(n=>{!n||n.size<100?e(new Error(this._("notifications.invalid_screenshot"))):t(new File([n],"screenshot.png",{type:"image/png"}))},"image/png",1)});o(a)}}catch(t){console.error("Backup method failed:",t),r(new Error(this._("notifications.cannot_capture_screen")+t.message))}}finally{y()}}},100),y=()=>{setTimeout(()=>this.translator.ui.removeProcessingStatus(),1e3),n.remove(),a.remove(),s.remove(),d&&d.remove(),e.remove(),t.forEach(t=>{t&&(t.style.visibility="")}),n.removeEventListener("mousedown",g),document.removeEventListener("mousemove",u),document.removeEventListener("mouseup",m),n.removeEventListener("touchstart",g),document.removeEventListener("touchmove",u),document.removeEventListener("touchend",m),document.removeEventListener("touchcancel",y)};n.addEventListener("mousedown",g),document.addEventListener("mousemove",u),document.addEventListener("mouseup",m),n.addEventListener("touchstart",g,{passive:!1}),document.addEventListener("touchmove",u,{passive:!1}),document.addEventListener("touchend",m),document.addEventListener("touchcancel",y),s.addEventListener("click",()=>{y(),r(new Error("Đã hủy chọn vùng"))}),document.addEventListener("keydown",t=>{"Escape"===t.key&&(y(),r(new Error("Đã hủy chọn vùng")))})})}catch(t){throw console.error("Screen capture error:",t),this.translator.ui.$$(".translator-tools-container, .translator-notification, .center-translate-status").forEach(t=>{t&&(t.style.visibility="")}),t}}catch(t){throw console.error("Screen capture error:",t),this.translator.ui.$$(".translator-tools-container, .translator-notification, .center-translate-status").forEach(t=>{t&&(t.style.visibility="")}),t}}async processImage(t,e,n=!1){try{const a=this.translator.userSettings.settings;this.isProcessing=!0,n||this.translator.ui.showProcessingStatus(this._("notifications.processing_image"));const i=await this.optimizeImage(t),s=await this.fileToBase64(i);n||this.translator.ui.updateProcessingStatus(this._("notifications.checking_cache"),20);let o=null;if(this.translator.imageCache&&a.cacheOptions.image.enabled){const t=await crypto.subtle.digest("SHA-256",(new TextEncoder).encode(s));o=Array.from(new Uint8Array(t)).map(t=>t.toString(16).padStart(2,"0")).join("");const e=await this.translator.imageCache.get(o);if(e)return n||this.translator.ui.updateProcessingStatus(this._("notifications.found_in_cache"),100),this.isProcessing=!1,n||setTimeout(()=>this.translator.ui.removeProcessingStatus(),1e3),e}n||this.translator.ui.updateProcessingStatus(this._("notifications.detecting_text"),40);const r=e||this.translator.createPrompt("ocr","ocr"),l=await this.translator.fileProcess.processFile(t,r),c=await this.translator.api.request(l.content,"ocr",l.key);return o&&this.translator.imageCache&&a.cacheOptions.image.enabled&&await this.translator.imageCache.set(o,c),n||this.translator.ui.updateProcessingStatus(this._("notifications.completed"),100),c}catch(t){throw console.error("OCR processing error:",t),t}finally{this.isProcessing=!1,n||setTimeout(()=>this.translator.ui.removeProcessingStatus(),1e3)}}async optimizeImage(t){const e=await createImageBitmap(t),n=2560;let a=e.width,i=e.height;(e.width>n||e.height>n)&&(e.width>e.height?(a=n,i=Math.floor(e.height*(n/e.width))):(i=n,a=Math.floor(e.width*(n/e.height))));const s=document.createElement("canvas"),o=s.getContext("2d",{willReadFrequently:!0,alpha:!0});s.width=a,s.height=i,o.imageSmoothingEnabled=!0,o.imageSmoothingQuality="medium",o.filter="contrast(1.1) brightness(1.05)",o.drawImage(e,0,0,a,i);try{const e=await new Promise(t=>{s.toBlob(t,"image/webp",.92)});if(e)return new File([e],t.name,{type:"image/webp",lastModified:Date.now()})}catch(t){console.log("WebP not supported, falling back to JPEG")}const r=await new Promise(t=>{s.toBlob(t,"image/jpeg",.92)});return new File([r],t.name,{type:"image/jpeg",lastModified:Date.now()})}async reduceImageSize(t){const e=await createImageBitmap(t),n=document.createElement("canvas"),a=n.getContext("2d",{willReadFrequently:!0});n.width=Math.floor(.75*e.width),n.height=Math.floor(.75*e.height),a.drawImage(e,0,0,n.width,n.height);const i=await new Promise(t=>{n.toBlob(t,"image/jpeg",.85)});return new File([i],t.name,{type:"image/jpeg"})}fileToBase64(t){return new Promise((e,n)=>{const a=new FileReader;a.onload=()=>e(a.result.split(",")[1]),a.onerror=()=>n(new Error(this._("notifications.failed_read_file"))),a.readAsDataURL(t)})}}class u{constructor(t){this.translator=t,this.isProcessing=!1,this._=this.translator.userSettings._}async processMediaFile(t){try{if(!this.isValidFormat(t))throw new Error(this._("notifications.unsupported_file_format"));if(!this.isValidSize(t))throw new Error(this._("notifications.file_too_large")+` Kích thước tối đa: ${this.getMaxSizeInMB(t)}MB`);this.isProcessing=!0,this.translator.ui.showProcessingStatus(this._("notifications.processing_media"));const e=await this.fileToBase64(t);this.translator.ui.updateProcessingStatus(this._("notifications.checking_cache"),20);let n=null;const a=this.translator.userSettings.settings.cacheOptions.media?.enabled;if(a&&this.translator.mediaCache){const t=await crypto.subtle.digest("SHA-256",(new TextEncoder).encode(e));n=Array.from(new Uint8Array(t)).map(t=>t.toString(16).padStart(2,"0")).join("");const a=await this.translator.mediaCache.get(n);if(a)return this.translator.ui.updateProcessingStatus(this._("notifications.found_in_cache"),100),this.translator.ui.displayPopup(a,"","Bản dịch"),this.isProcessing=!1,void setTimeout(()=>this.translator.ui.removeProcessingStatus(),1e3)}this.translator.ui.updateProcessingStatus(this._("notifications.processing_audio_video"),40);const i=this.translator.createPrompt("media","media");console.log("prompt: ",i);const s=await this.translator.fileProcess.processFile(t,i);this.translator.ui.updateProcessingStatus(this._("notifications.translating"),60);const o=await this.translator.api.request(s.content,"media",s.key);if(this.translator.ui.updateProcessingStatus(this._("notifications.finalizing"),80),!o||0===o.length)throw new Error(this._("notifications.cannot_process_media"));n&&a&&this.translator.mediaCache&&await this.translator.mediaCache.set(n,o),this.translator.ui.updateProcessingStatus(this._("notifications.completed"),100),this.translator.ui.displayPopup(o,"",this._("notifications.translation_label"))}catch(t){throw console.error("Media processing error:",t),new Error(this._("notifications.media_file_error")+` ${t.message}`)}finally{this.isProcessing=!1,setTimeout(()=>this.translator.ui.removeProcessingStatus(),1e3)}}isValidFormat(t){const e={mp3:"audio/mp3",wav:"audio/wav",ogg:"audio/ogg",m4a:"audio/m4a",aac:"audio/aac",flac:"audio/flac",wma:"audio/wma",opus:"audio/opus",amr:"audio/amr",midi:"audio/midi",mid:"audio/midi",mp4:"video/mp4",webm:"video/webm",ogv:"video/ogg",avi:"video/x-msvideo",mov:"video/quicktime",wmv:"video/x-ms-wmv",flv:"video/x-flv","3gp":"video/3gpp","3g2":"video/3gpp2",mkv:"video/x-matroska"}[t.name.split(".").pop().toLowerCase()];return e?.startsWith("audio/")?o.MEDIA.audio.supportedFormats.includes(e):!!e?.startsWith("video/")&&o.MEDIA.video.supportedFormats.includes(e)}isValidSize(t){const e=t.type.startsWith("audio/")?o.MEDIA.audio.maxSize:o.MEDIA.video.maxSize;return t.size<=e}getMaxSizeInMB(t){const e=t.type.startsWith("audio/")?o.MEDIA.audio.maxSize:o.MEDIA.video.maxSize;return Math.floor(e/1048576)}fileToBase64(t){return new Promise((e,n)=>{const a=new FileReader;a.onload=()=>e(a.result.split(",")[1]),a.onerror=()=>n(new Error(this._("notifications.failed_read_file"))),a.readAsDataURL(t)})}cleanup(){try{this.audioCtx&&(this.audioCtx.close(),this.audioCtx=null),this.processor&&(this.processor.disconnect(),this.processor=null),this.container&&(this.container.remove(),this.container=null),this.mediaElement=null,this.audioBuffer=null}catch(t){console.error("Error during cleanup:",t)}}}class m{constructor(t){this.translator=t,this.settings=this.translator.userSettings.settings,this._=this.translator.userSettings._,this.defaultLang=this.settings.displayOptions.targetLanguage,this.isEnabled=!1,this.isPlaying=!1,this.hasCaptions=!1,this.initialized=!1,this.isFetchingTranscript=!1,this.isTranslatingChunk=!1,this.isSeeking=!1,this.lastCurrentTime=-1,this.fullTranscriptTranslated=!1,this.isNotify=!1,this.activeVideoId=null,this.currentVideo=null,this.videoTrackingInterval=null,this.translatedTranscript=null,this.subtitleContainer=null,this.lastCaption="",this.lastTranslatedIndex=-1,this.translatingIndexes=new Set,this.subtitleCache=new Map,this.keyIndex=null,this.rateLimitedKeys=new Map,this.retryDelay=100,this.captionObserver=null,this.platformInfo=this.detectPlatform(),this.settings.videoStreamingOptions?.enabled&&this.platformInfo&&setTimeout(()=>this.start(),2e3)}detectPlatform(){this.platformConfigs={youtube:{videoSelector:["video","video.html5-main-video",".html5-video-container video","#movie_player video"],controlsContainer:[".ytp-subtitles-button",".ytp-settings-button","ytm-closed-captioning-button"],videoContainer:["#movie_player","#player",".html5-video-container"]},udemy:{videoSelector:["video",'[class*="video-player--video-player"] video'],controlsContainer:['[data-purpose="transcript-toggle"]','[id="popper-trigger--131"]'],videoContainer:['[class*="video-player--mock-vjs-tech"]','[id*="video-container"]']}};const t=window.location.hostname;for(const[e,n]of Object.entries(this.platformConfigs))if(t.includes(e))return{platform:e,config:n};return null}setupVideoListeners(){if(this.currentVideo&&!this.initialized){if(this.activeVideoId=Math.random().toString(36).substring(7),this.currentVideo.dataset.translatorVideoId=this.activeVideoId,["play","playing","seeking","seeked","pause","ended"].forEach(t=>{const e=async()=>{if(this.currentVideo?.dataset.translatorVideoId===this.activeVideoId)switch(t){case"play":case"playing":this.isPlaying=!0;break;case"seeking":this.isSeeking=!0;break;case"seeked":this.isSeeking=!1,this.isTranslatingChunk=!1,this.processVideoFrame();break;case"pause":this.isPlaying=!1;break;case"ended":this.isPlaying=!1,this.cleanupVideo()}};this.currentVideo.addEventListener(t,e),this.currentVideo[`${t}Handler`]=e}),this.currentVideo){let t=0,e=null,n=null,a=null;const s=i(i=>{if(i!==t&&(t=i,e||(e=document.querySelector(".translated-caption")),n||(n=document.querySelector(".original-text")||null),a||(a=document.querySelector(".translated-text")),a)){let t,s,o;i<=480?(t="98%",s="0.65em",o="0.7em"):i<=962?(t="95%",s="0.75em",o="0.8em"):i<=1366?(t="90%",s="0.85em",o="0.9em"):(t="90%",s="0.95em",o="1em"),e&&(e.style.maxWidth=t),n&&(n.style.fontSize=s),a.style.fontSize=o}},100),o=i(()=>{if(!this.subtitleContainer||!this.currentVideo)return;const t=this.currentVideo.getBoundingClientRect(),e=this.subtitleContainer.getBoundingClientRect();e.bottom>t.bottom&&(this.subtitleContainer.style.bottom="5%"),e.width>.9*t.width&&(this.subtitleContainer.style.maxWidth="90%")},100);new ResizeObserver(t=>{const e=t[0].contentRect.width;s(e),o()}).observe(this.currentVideo)}this.initialized=!0}}parseTimestampToSeconds(t){if(!t)return 0;const e=t.split(":").map(Number);let n=0;return 3===e.length?n=3600*e[0]+60*e[1]+e[2]:2===e.length?n=60*e[0]+e[1]:1===e.length&&(n=e[0]),n}async getTranscriptFromDOM(){let t,e;console.log("[King_DEBUG] Attempting to get transcript from DOM."),t=document.querySelector("button[aria-label*=cookies]"),t&&t.click(),await new Promise(t=>{const e=()=>{const n=document.querySelector("ytd-video-description-transcript-section-renderer button")||document.querySelector('button[title="Transcript"]');n?(n.click(),t()):setTimeout(e,500)};e()}),e=await new Promise(t=>{const e=()=>{const n=document.querySelector("#segments-container")||document.querySelector("#transcript-scrollbox");n?t(n):setTimeout(e,500)};e()});const n=["ytd-transcript-segment-renderer",".caption-line"];for(const t of n){const n=e.querySelectorAll(t);if(n&&n.length>0){console.log(n);const t=[];for(let e=0;e<n.length;e++){const a=n[e],i=a.querySelector(".segment-timestamp")||a.querySelector(".caption-line-time"),s=a.querySelector(".segment-text")||a.querySelector(".caption-line-text");if(i&&s){const a=this.cleanTranscriptText(s.textContent||"");if(a){const s=this.parseTimestampToSeconds(i.textContent.trim());let o=5;if(e+1<n.length){const t=n[e+1].querySelector(".segment-timestamp")||n[e+1].querySelector(".caption-line-time");t&&(o=this.parseTimestampToSeconds(t.textContent.trim())-s)}t.push({text:a,start:s,duration:o})}}}return console.log(`[King_DEBUG] DOM method successful. Extracted ${t.length} timed captions.`),t.length>0?t:null}}}async waitForElement(t,e=15e3,n=500){const a=Date.now();return new Promise(i=>{const s=()=>{const o=document.querySelector(t);o?i(o):Date.now()-a>e?i(null):setTimeout(s,n)};s()})}async setupUdemyObserver(){console.log("[King_DEBUG] Setting up observer for Udemy with multi-layered translation.");const t=await this.waitForElement('button[data-purpose="transcript-toggle"]');if(!t)return console.error("Udemy transcript button not found.");"true"!==t.getAttribute("aria-expanded")&&(t.click(),await new Promise(t=>setTimeout(t,1e3)));const e=await this.waitForElement('[data-purpose="transcript-panel"]');if(!e)return console.error("Could not find Udemy transcript panel to observe.");const n=async t=>{const e=t?.querySelector('[data-purpose="cue-text"]')?.textContent?.trim();if(e&&!this.subtitleCache.has(e))try{this.subtitleCache.set(e,"translating...");const t=await this.translator.api.request(this.createLiveCaptionPrompt(e),"media");this.subtitleCache.set(e,t||e)}catch(t){console.error("Background cue translation failed:",t),this.subtitleCache.set(e,e)}},a=async t=>{const e=t?.querySelector('[data-purpose="cue-text"]')?.textContent?.trim();if(e&&e!==this.lastCaption){this.lastCaption=e;const a=this.subtitleCache.get(e);if(a&&"translating..."!==a)this.updateSubtitles({original:e,translation:a});else{this.updateSubtitles({original:e,translation:"..."});const t=await this.translator.api.request(this.createLiveCaptionPrompt(e),"media");this.lastCaption===e&&this.updateSubtitles({original:e,translation:t||e}),t&&this.subtitleCache.set(e,t)}const i=[];let s=t.parentElement;for(let t=0;t<10&&s;t++)if(s=s.nextElementSibling,s){const t=s.querySelector('[data-purpose="transcript-cue"]');t&&i.push(t)}if(console.log(`[King_DEBUG] Found ${i.length} upcoming cues to pre-translate.`),i.length>0){const t=i.map(t=>n(t));Promise.allSettled(t)}}},i=new MutationObserver(t=>{for(const e of t)if("transcript-cue-active"===e.target?.getAttribute("data-purpose"))return void a(e.target)});i.observe(e,{attributes:!0,subtree:!0,attributeFilter:["data-purpose"]}),this.captionObserver=i;const s=e.querySelector('[data-purpose="transcript-cue-active"]');s&&a(s),this.fullTranscriptTranslated||this.translateFullUdemyTranscript(e)}async getVideoTranscript(){if("udemy"===this.platformInfo.platform)return console.log("[King_DEBUG] Skipping timestamp-based transcript fetch for Udemy."),null;if(this.videoTranscript)return this.videoTranscript;if(this.isFetchingTranscript)return null;this.isFetchingTranscript=!0,console.log("[KING_DEBUG] getVideoTranscript: Starting to fetch transcript...");try{let t=null;if(t=await this.getTranscriptFromDOM(),t&&t.length>0)return this.videoTranscript=t,this.translatedTranscript=new Array(this.videoTranscript.length).fill(null),console.log("[KING_DEBUG] getVideoTranscript: Success! Parsed",this.videoTranscript.length,"captions."),this.translateFullTranscriptInBackground(),this.videoTranscript;const e=this._("notifications.get_transcript_error_generic")+"\n\n"+this._("notifications.get_transcript_error_suggestion1")+"\n"+this._("notifications.get_transcript_error_suggestion2");throw console.error("[King_DEBUG] All methods failed to get transcript."),this.isNotify||this.translator.ui.showNotification(e,"error"),this.isNotify=!0,new Error(e)}catch(t){return console.error("[KING_DEBUG] Error in getVideoTranscript:",t),this.isNotify||this.translator.ui.showNotification(t.message,"error"),this.isNotify=!0,null}finally{this.isFetchingTranscript=!1}}cleanTranscriptText(t){return t.replace(/\n/g," ").replace(/♪|'|"|\.{2,}|\<[\s\S]*?\>|\{[\s\S]*?\}|\[[\s\S]*?\]/g,"").replace(/\s+/g," ").trim()}formatMilliseconds(t){const e=Math.floor(t/1e3),n=Math.floor(e/3600),a=Math.floor(e%3600/60),i=String(e%60).padStart(2,"0"),s=String(a).padStart(2,"0");return n>0?`${String(n).padStart(2,"0")}:${s}:${i}`:`${s}:${i}`}async translateFullTranscriptInBackground(){if(this.videoTranscript&&!this.fullTranscriptTranslated){console.log("[KING_DEBUG] Starting full transcript translation for YouTube...");try{const t=this.videoTranscript.map((t,e)=>({...t,originalIndex:e})).filter(t=>!this.translatedTranscript[t.originalIndex]);if(0===t.length)return console.log("[King_DEBUG] All YouTube transcript cues are already translated."),void(this.fullTranscriptTranslated=!0);const e=100,n=[];for(let a=0;a<t.length;a+=e)n.push(t.slice(a,a+e));console.log(`[KING_DEBUG] Splitting YouTube transcript into ${n.length} chunks of size ~${e}.`);const a=document.title?`and the title "${document.title}"`:"",i=this.settings.displayOptions.targetLanguage,s=n.map(async t=>{const e=t.map(t=>({id:t.originalIndex,text:t.text})),n=JSON.stringify(e,null,2),s=`You are an expert subtitle translator. Your task is to translate the 'text' field for each object in the following JSON array to '${i}'.\n- Target language: '${i}'.\n- Use the context of ${a} to determine the translation style.\n- The translation must strictly adhere to the context and tone of the original text.\n- Ensure fluency and naturalness as a native speaker would.\n- Do not add any explanations or interpretations beyond the translation.\n- Preserve terminology and proper nouns on a 1:1 basis.\n- You MUST return a valid JSON array.\n- For EACH object you translate, you MUST include the original 'id' from the input.\n- Each object in the output array must contain exactly two fields: "id" (the original integer ID) and "translation" (the translated text).\n- Do NOT add, merge, or skip any objects. The output array should ideally have the same number of objects as the input.\n- Do NOT add any extra text, comments, or markdown formatting (DO NOT like \`\`\`json). The output must be raw, valid JSON.\n- CRITICAL: Properly escape all special characters within the "translation" strings, especially double quotes (").\n\nInput JSON:\n\`\`\`\n${n}\n\`\`\`\n\nExpected Output JSON format:\n[\n  { "id": 0, "translation": "Translated text for object with id 0..." },\n  { "id": 1, "translation": "Translated text for object with id 1..." },\n  ...\n]\n`;try{const t=await this.translator.api.request(s,"media");if(console.log("rawResponse:\n",t),!t)return;const e=this.parseFaultyJSON(t);Array.isArray(e)&&e.forEach(t=>{const e=t.id,n=t.translation||t.vi;"number"==typeof e&&this.videoTranscript[e]&&n&&(this.translatedTranscript[e]={original:this.videoTranscript[e].text,translation:n})})}catch(t){console.error("[King_DEBUG] Failed to translate a YouTube chunk:",t)}});await Promise.allSettled(s),this.fullTranscriptTranslated=!0,console.log("[KING_DEBUG] All YouTube transcript chunks have been processed.")}catch(t){console.error("[KING_DEBUG] Error during full YouTube transcript translation:",t)}}}async translateFullUdemyTranscript(t){if(!this.fullTranscriptTranslated){console.log("[King_DEBUG] Starting full transcript translation for Udemy...");try{const e=t.querySelectorAll('[data-purpose="transcript-cue"]');if(!e||0===e.length)return;const n=Array.from(e).map((t,e)=>{const n=t.querySelector('[data-purpose="cue-text"]')?.textContent?.trim();return n&&!this.subtitleCache.has(n)?{id:e,text:n}:null}).filter(Boolean);if(0===n.length)return console.log("[King_DEBUG] All transcript cues are already cached."),void(this.fullTranscriptTranslated=!0);const a=100,i=[];for(let t=0;t<n.length;t+=a)i.push(n.slice(t,t+a));console.log(`[King_DEBUG] Splitting full transcript into ${i.length} chunks of size ~${a}.`);const s=document.title?`từ video có tiêu đề "${document.title}"`:"",o=this.settings.displayOptions.targetLanguage,r=i.map(async t=>{const e=JSON.stringify(t,null,2),n=`You are an expert subtitle translator. Your task is to translate the 'text' field for each object in the following JSON array to '${o}'.\n- Target language: '${o}'.\n- Use the context of ${s} to determine the translation style.\n- The translation must strictly adhere to the context and tone of the original text.\n- Ensure fluency and naturalness as a native speaker would.\n- Do not add any explanations or interpretations beyond the translation.\n- Preserve terminology and proper nouns on a 1:1 basis.\n- You MUST return a valid JSON array.\n- For EACH object you translate, you MUST include the original 'id' from the input.\n- Each object in the output array must contain exactly two fields: "id" (the original integer ID) and "translation" (the translated text).\n- Do NOT add, merge, or skip any objects. The output array should ideally have the same number of objects as the input.\n- Do NOT add any extra text, comments, or markdown formatting (DO NOT like \`\`\`json). The output must be raw, valid JSON.\n- CRITICAL: Properly escape all special characters within the "translation" strings, especially double quotes (").\n\nInput JSON:\n\`\`\`\n${e}\n\`\`\`\n\nExpected Output JSON format:\n[\n  { "id": 0, "translation": "Translated text for object with id 0..." },\n  { "id": 1, "translation": "Translated text for object with id 1..." },\n  ...\n]\n`;try{const e=await this.translator.api.request(n,"media");if(!e)return;const a=this.parseFaultyJSON(e);if(Array.isArray(a)){const e=new Map(t.map(t=>[t.id,t.text]));a.forEach(t=>{const n=e.get(t.id),a=t.translation||t.vi;n&&a&&this.subtitleCache.set(n,a)})}}catch(t){console.error("[King_DEBUG] Failed to translate a chunk:",t)}});await Promise.allSettled(r),this.fullTranscriptTranslated=!0,console.log("[King_DEBUG] All transcript chunks have been processed.")}catch(t){console.error("[KING_DEBUG] Error during full Udemy transcript translation:",t)}}}parseFaultyJSON(t){let e=t.trim();const n=e.match(/```json\s*([\s\S]*?)\s*```/);n&&n[1]&&(e=n[1].trim());try{const t=JSON.parse(e);if(Array.isArray(t))return t}catch(t){console.warn("Could not parse the whole JSON string, attempting to parse line by line.",t.message)}const a=[],i=e.split("\n");let s="";return i.forEach(t=>{s+=t;try{if(t.trim().endsWith("},")||t.trim().endsWith("}")){const t=s.trim().endsWith(",")?s.trim().slice(0,-1):s.trim(),e=JSON.parse(t);"number"==typeof e.id&&(e.translation||e.vi)&&a.push(e),s=""}}catch(t){}}),a}getCurrentCaption(t,e){return t&&Array.isArray(t)&&t.find(t=>{const n=t.start,a=n+(t.duration||0);return e>=n&&e<a})||null}async processVideoFrame(){if("udemy"!==this.platformInfo.platform&&this.isEnabled&&this.currentVideo&&!this.isSeeking)try{if(this.videoTranscript||this.isFetchingTranscript||await this.getVideoTranscript(),!this.videoTranscript)return;const t=this.currentVideo.currentTime,e=this.videoTranscript.findIndex(e=>{const n=e.start,a=n+(e.duration||5);return t>=n&&t<a});if(-1===e)return this.subtitleContainer&&(this.subtitleContainer.innerText=""),void(this.lastCaption="");const n=this.settings.displayOptions?.translationMode;let a="\n";("parallel"===n||"language_learning"===n&&this.settings.displayOptions.languageLearning?.showSource)&&(a=" ");const i=this.videoTranscript[e],s=this.translatedTranscript[e],o=this.videoTranscript[e+1],r=this.translatedTranscript[e+1];let l=i.text,c=s?s.translation:"...";o&&(l+=`${a}${o.text}`,c+=r?`${a}${r.translation}`:`${a}...`);const d={original:l,translation:c};d.translation!==this.lastCaption&&(this.lastCaption=d.translation,this.updateSubtitles(d)),!this.isTranslatingChunk&&this.checkNeedsTranslation(e)&&this.translateUpcomingCaptions(e)}catch(t){console.error("[KING_DEBUG] Error in processVideoFrame:",t)}}checkNeedsTranslation(t){const e=Math.min(t+10,this.videoTranscript.length);for(let n=t+1;n<e;n++)if(!this.translatedTranscript[n]&&!this.translatingIndexes.has(n))return!0;return!1}async translateUpcomingCaptions(t){if(!this.isTranslatingChunk&&this.videoTranscript&&!this.fullTranscriptTranslated){this.isTranslatingChunk=!0;try{const e=10,n=[];for(let a=t;a<this.videoTranscript.length&&n.length<e;a++)this.translatedTranscript[a]||this.translatingIndexes.has(a)||(n.push({text:this.videoTranscript[a].text,index:a}),this.translatingIndexes.add(a));if(0===n.length)return void(this.isTranslatingChunk=!1);console.log(`[King_DEBUG] Pre-translating ${n.length} upcoming captions in parallel.`);const a=n.map(t=>this.translator.api.request(this.createLiveCaptionPrompt(t.text),"media").then(e=>({...t,translation:e||t.text,success:!!e})).catch(e=>(console.error(`Error translating upcoming caption: "${t.text}"`,e),{...t,translation:t.text,success:!1})));(await Promise.allSettled(a)).forEach(t=>{if("fulfilled"===t.status){const{index:e,text:n,translation:a}=t.value;this.translatedTranscript[e]={original:n,translation:a},this.translatingIndexes.delete(e)}})}catch(t){console.error(this._("notifications.upcoming_captions_error"),t)}finally{this.isTranslatingChunk=!1}}}createLiveCaptionPrompt(t,e=!1){const n=`và tiêu đề "${document.title}"`||"",a=this.settings.displayOptions.targetLanguage;return`  Bạn là một người dịch phụ đề video chuyên nghiệp, chuyên tạo bản dịch chính xác và tự nhiên. Bạn cần dịch phụ đề video ở dưới đây sang "${a}".\n  Lưu ý:\n    - Ngôn ngữ đích: '${a}'.\n    - Dựa vào ngữ cảnh, bối cảnh ${e?"":n} để xác định phong cách dịch.\n    - Bảo toàn các thuật ngữ và danh từ riêng với tỷ lệ 1:1.\n    - KHÔNG thêm bất kỳ văn bản, bình luận, hay định dạng markdown nào khác (KHÔNG dùng định dạng kiểu \`\`\`).\n    - Chỉ trả về bản dịch là văn bản thô hợp lệ và không giải thích gì thêm.\n  Văn bản cần dịch:\n\`\`\`\n${t}\n\`\`\`\n`}setupVideoWatcher(){if(this.videoWatcherObserver)return;const t=i(async()=>{const t=Array.from(document.querySelectorAll("video")).find(t=>t.src&&t.offsetHeight>0);t&&t.src!==this.currentVideo?.src&&(console.log("[King_DEBUG] New video source detected. Re-initializing translator..."),this.cleanup(),await new Promise(t=>setTimeout(t,1500)),this.start())},1e3),e=new MutationObserver(t);e.observe(document.body,{childList:!0,attributes:!0,subtree:!0,attributeFilter:["src"]}),this.videoWatcherObserver=e}startVideoTracking(){this.videoTrackingInterval&&clearInterval(this.videoTrackingInterval),this.videoTrackingInterval=setInterval(()=>{this.processVideoFrame()},250),console.log("[KING_DEBUG] Video tracking started with 250ms interval.")}async start(){if(this.isEnabled)return void console.log("[KING_DEBUG] Feature is already enabled.");this.isEnabled=!0,console.log("[KING_DEBUG] start() called. Waiting for active video...");const t=()=>{const t=this.platformInfo.config.videoSelector;for(const e of t){const t=document.querySelectorAll(e);for(const e of t)if(e.src&&e.readyState>2&&!e.paused&&e.videoHeight>0)return e}for(const e of t){const t=document.querySelectorAll(e);for(const e of t)if(e.currentTime>.1)return e}return null};let e=null;for(let n=0;n<900;n++){if(!this.isEnabled)return void console.log("[KING_DEBUG] Start process cancelled by user.");if(e=t(),e){console.log("[KING_DEBUG] Active video found after",200*n+"ms",e);break}await new Promise(t=>setTimeout(t,200))}if(!e)return console.error("[KING_DEBUG] Could not find an active video after 3 minutes. Aborting."),this.translator.ui.showNotification(this._("notifications.not_find_video"),"error"),void(this.isEnabled=!1);this.currentVideo=e,this.setupVideoListeners(),this.createVideoControls(),this.createSubtitleContainer(),"udemy"===this.platformInfo.platform?this.setupUdemyObserver():this.startVideoTracking(),this.setupVideoWatcher()}stop(){this.isEnabled=!1,this.isPlaying=!1,this.cleanupVideo(),this.videoTrackingInterval&&clearInterval(this.videoTrackingInterval),this.captionObserver&&this.captionObserver.disconnect(),this.controlsContainer&&this.controlsContainer.remove(),this.subtitleContainer&&this.subtitleContainer.remove(),this.videoWatcherObserver=null,this.captionObserver=null,this.controlsContainer=null,this.subtitleContainer=null,this.currentVideo=null,this.lastOriginalText="",this.subtitleCache.clear(),this.isNotify=!1,this.rateLimitedKeys.clear(),this.keyIndex=null,this.videoTranscript=null,this.translatedTranscript=null,console.log(this._("notifications.stop_cap"))}cleanup(){this.fullTranscriptTranslated=!1,this.videoWatcherObserver&&this.videoWatcherObserver.disconnect(),this.subtitleCache.clear(),this.stop()}cleanupVideo(){this.currentVideo&&(delete this.currentVideo.dataset.translatorVideoId,["play","playing","seeking","seeked","pause","ended"].forEach(t=>{const e=this.currentVideo[`${t}Handler`];e&&(this.currentVideo.removeEventListener(t,e),delete this.currentVideo[`${t}Handler`])})),this.initialized=!1,this.hasCaptions=!1,this.lastCaption=""}createVideoControls(){if(this.controlsContainer)return;console.log("[KING_DEBUG] Creating video controls.");const t=document.createElement("button");let e=null,n=null;const a=this.platformInfo.config.controlsContainer;for(const i of a)if(n=document.querySelector(i),n){e=n.parentElement,t.className=n.className,console.log(`[KING_DEBUG] Found controls container with selector: ${i}`);break}e?(t.classList.add("video-translation-controls"),t.title=this.isEnabled?this._("notifications.live_caption_off"):this._("notifications.live_caption_on"),t.setAttribute("role","button"),t.setAttribute("tabindex","6200"),t.innerHTML='<img src="https://raw.githubusercontent.com/king1x32/King-Translator-AI/refs/heads/main/icon/kings.jpg" style="width: 65%; height: 65%; padding: 20%;">',t.onclick=t=>{t.stopPropagation(),this.isEnabled?(this.stop(),this.translator.ui.showNotification(this._("notifications.live_caption_off2"),"info"),this.controlsContainer.title=this._("notifications.live_caption_on")):(this.start(),this.translator.ui.showNotification(this._("notifications.live_caption_on2"),"success"),this.controlsContainer.title=this._("notifications.live_caption_off"))},n?e.insertBefore(t,n.nextSibling):e.prepend(t),console.log("[KING_DEBUG] Video translation button successfully inserted before the anchor button."),this.controlsContainer=t):console.error("[KING_DEBUG] Failed to find any suitable container for controls.")}findVideoContainer(){const t=this.platformInfo.config.videoContainer;for(const e of t){const t=this.currentVideo.closest(e);if(t)return console.log(`[KING_DEBUG] Found video container with selector: ${e}`),t}return console.warn("[KING_DEBUG] Could not find specific video container, falling back to video's parent element."),this.currentVideo.parentElement}createSubtitleContainer(){if(this.subtitleContainer)return;this.subtitleContainer=document.createElement("div"),this.subtitleContainer.className="live-caption-container translated-caption";const t=this.findVideoContainer()||this.currentVideo;if(console.log("videoContainer",t),t){console.log(this._("notifications.found_video"),t),"static"===getComputedStyle(t).position&&(t.style.position="relative");const e=this.settings.videoStreamingOptions;Object.assign(this.subtitleContainer.style,{zIndex:"2147483647",display:"block",visibility:"visible",opacity:"1",position:"absolute",left:"50%",bottom:"2%",transform:"translateX(-50%)",zIndex:"2147483647",fontSize:e.fontSize,color:e.textColor,backgroundColor:e.backgroundColor,padding:"5px 10px",borderRadius:"4px",fontFamily:"'GoMono Nerd Font', 'Noto Sans', Arial",textAlign:"center",maxWidth:"90%",width:"auto",pointerEvents:"none",textShadow:"0px 1px 2px rgba(0, 0, 0, 0.8)",whiteSpace:"pre-wrap",lineHeight:"1.2"}),t.appendChild(this.subtitleContainer)}else console.error(this._("notifications.video_container_not_found"))}updateSubtitles(t){if(this.subtitleContainer||this.createSubtitleContainer(),!this.subtitleContainer)return;const e=this.settings.displayOptions.translationMode,{original:n,translation:a}=t;this.subtitleContainer.innerText="";const i=this.currentVideo.offsetWidth;let s,o,r;i<=480?(s="98%",o="0.65em",r="0.7em"):i<=962?(s="95%",o="0.75em",r="0.8em"):i<=1366?(s="90%",o="0.85em",r="0.9em"):(s="90%",o="0.95em",r="1em"),this.subtitleContainer.style.maxWidth=s;const l=(t,e,n={})=>{const a=document.createElement("span");return a.className=e,a.innerText=t,Object.assign(a.style,n,{display:"block"}),a};("parallel"===e||"language_learning"===e&&this.settings.displayOptions.languageLearning?.showSource)&&this.subtitleContainer.appendChild(l(n,"original-text",{fontSize:o,color:"#eeeeee",opacity:"0.9",marginBottom:"6px"})),this.subtitleContainer.appendChild(l(a,"translated-text",{fontSize:r,marginBottom:"2px"}))}}class y{constructor(t){this.translator=t,this.settings=this.translator.userSettings.settings,this._=this.translator.userSettings._,this.MIN_TEXT_LENGTH=100,this.originalTexts=new Map,this.isTranslated=!1,this.languageCode=this.detectLanguage().languageCode,this.pageCache=new Map,this.pdfLoaded=!0,this.pageObserver=null,this.sentinelContainer=null,this.allTextNodes=[]}parseFaultyJSON(t){let e=t.trim();const n=e.match(/```json\s*([\s\S]*?)\s*```/);n&&n[1]&&(e=n[1].trim());try{const t=JSON.parse(e);if(Array.isArray(t))return t}catch(t){console.warn("Could not parse the whole JSON string, attempting to parse line by line.",t.message)}const a=[],i=e.split("\n");let s="";return i.forEach(t=>{s+=t;try{if(t.trim().endsWith("},")||t.trim().endsWith("}")){const t=s.trim().endsWith(",")?s.trim().slice(0,-1):s.trim(),e=JSON.parse(t);"number"==typeof e.id&&(e.translation||e.vi)&&a.push(e),s=""}}catch(t){}}),a}async translatePage(){try{if(this.isTranslated)return this.pageObserver&&this.pageObserver.disconnect(),this.sentinelContainer&&this.sentinelContainer.remove(),this.domObserver&&this.domObserver.disconnect(),this.pageObserver=this.sentinelContainer=this.domObserver=null,await Promise.all(Array.from(this.originalTexts.entries()).map(async([t,e])=>{t&&(t.parentNode||document.contains(t))&&(t.textContent=e)})),this.originalTexts.clear(),this.allTextNodes=[],this.isTranslated=!1,{success:!0,message:this._("notifications.page_reverted_to_original")};if(this.pageObserver&&this.pageObserver.disconnect(),this.allTextNodes=this.collectTextNodes(),0===this.allTextNodes.length)return{success:!1,message:this._("notifications.no_content_to_translate")};this.translator.ui.showNotification(this._("notifications.page_translate_loading"),"info");const t=document.documentElement.scrollHeight,e=Math.max(10,Math.min(50,Math.floor(t/800))),n=t/e;this.sentinelContainer&&this.sentinelContainer.remove(),this.sentinelContainer=document.createElement("div"),this.sentinelContainer.style.cssText="position: absolute; top: 0; left: 0; width: 1px; height: 100%; pointer-events: none; z-index: -1;",document.body.appendChild(this.sentinelContainer);const a=[];for(let t=0;t<e;t++){const e=document.createElement("div");e.style.cssText=`position: absolute; top: ${t*n}px; height: 1px; width: 1px;`,e.dataset.sectionIndex=t,this.sentinelContainer.appendChild(e),a.push(e)}let i=new Set;const s=async()=>{this.pageObserver&&(this.pageObserver.disconnect(),this.pageObserver=null);const t=this.allTextNodes.filter(t=>!this.originalTexts.has(t));if(t.length>0){console.log(`[Final Sweep] Found ${t.length} remaining text nodes to translate.`);const e=this.createChunks(t,2e3);await Promise.all(e.map(t=>this.translateChunkWithRetries(t))).catch(t=>console.error("Error during final sweep translation:",t))}this.translator.ui.showNotification(this._("notifications.page_translated_success"),"success"),this.domObserver||this.setupDOMObserver()};return this.pageObserver=new IntersectionObserver(t=>{let a=!1;for(const s of t){if(s.isIntersecting){const t=s.target,a=parseInt(t.dataset.sectionIndex,10);if(i.has(a))continue;this.pageObserver.unobserve(t),i.add(a);const o=a*n,r=a===e-1?1/0:o+n,l=this.allTextNodes.filter(t=>{if(!t.parentElement||this.originalTexts.has(t))return!1;const e=t.parentElement.getBoundingClientRect().top+window.scrollY;return e>=o&&e<r});if(l.length>0){const t=this.createChunks(l,2e3);Promise.all(t.map(t=>this.translateChunkWithRetries(t))).catch(t=>console.error("Error translating chunk in observer:",t))}}i.size>=e&&(a=!0)}a&&s()},{rootMargin:"120% 0px",threshold:.01}),a.forEach(t=>this.pageObserver.observe(t)),this.isTranslated=!0,{success:!0,message:this._("notifications.translating")}}catch(t){return console.error("Page translation error:",t),this.isTranslated=!1,{success:!1,message:t.message}}}getExcludeSelectors(){const t=this.settings.pageTranslation;return t.useCustomSelectors?t.combineWithDefault?[...new Set([...t.defaultSelectors,...t.customSelectors])]:t.customSelectors:t.defaultSelectors}async makeTranslationRequest(t){const e=this.settings,n=e.apiKey[e.apiProvider],a=n[Math.floor(Math.random()*n.length)],i="Detect language of this text and return only ISO code (e.g. 'en', 'vi'): \n"+t;return await this.translator.api.makeApiRequest(a,i,"page")}async detectLanguageBackup(t){try{return(await this.makeTranslationRequest(t)).trim().toLowerCase()}catch(t){return console.error("Backup language detection failed:",t),"auto"}}async detectLanguage(){let t="";try{if(document.body.innerText&&(t=document.body.innerText),t||document.querySelectorAll("p").forEach(e=>{t+=e.textContent+" "}),t||document.querySelectorAll("h1, h2, h3").forEach(e=>{t+=e.textContent+" "}),t||(t=document.title),t=t.slice(0,1e3).trim(),!t.trim())throw new Error(this._("notifications.no_content_for_lang_detect"));const e=await new Promise((e,n)=>{GM_xmlhttpRequest({method:"GET",url:`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=en&dt=t&q=${encodeURIComponent(t)}`,headers:{Accept:"application/json"},onload:function(t){try{const n=JSON.parse(t.responseText);e(n)}catch(t){n(new Error("Failed to parse response: "+t.message))}},onerror:function(t){n(new Error("Request failed: "+t.error))}})}),n=e[2]||e[8][0]||e[8][3],a=e[6]||e[8][2]||0;if(!n||a<.5)return await this.detectLanguageBackup(t);this.languageCode=n,console.log(`${this._("notifications.lang_detect")}: ${this.languageCode} (${this._("notifications.reliability")}: ${Math.round(100*a)}%)`);const i=this.settings.displayOptions.targetLanguage;return this.languageCode===i?{isTargetLanguage:!0,languageCode:this.languageCode,confidence:a,message:`${this._("notifications.page_already_target_lang")}: ${i} (${this._("notifications.reliability")}: ${Math.round(100*a)}%)`}:{isTargetLanguage:!1,languageCode:this.languageCode,confidence:a,message:`${this._("notifications.lang_detect")}: ${this.languageCode} (${this._("notifications.reliability")}: ${Math.round(100*a)}%)`}}catch(e){return console.error("Language detection error:",e),await this.detectLanguageBackup(t)}}async checkAndTranslate(){try{if(!this.settings.pageTranslation.autoTranslate)return{success:!1,message:this._("notifications.auto_translate_disabled")};const t=await this.detectLanguage();if(t.isVietnamese)return{success:!1,message:t.message};const e=await this.translatePage();if(e.success){const t=this.translator.ui.$(".translator-tools-container");if(t){const e=t.querySelector('[data-type="pageTranslate"]');if(e){const t=e.querySelector(".item-text");t&&(t.textContent=this.isTranslated?this._("notifications.original_label"):this._("notifications.page_translate_menu_label"))}}const e=this.translator.ui.$(".page-translate-button");e&&(e.textContent=this.isTranslated?`📄 ${this._("notifications.original_label")}`:`📄 ${this._("notifications.page_translate_menu_label")}`)}else this.translator.ui.showNotification(e.message,"warning");return e}catch(t){return console.error("Translation check error:",t),{success:!1,message:t.message}}}async updateNode(t,e){if(!t||!t.parentNode||!document.contains(t))return!1;try{return t.textContent=e,!0}catch(t){return console.error("Node update failed:",t),!1}}createChunks(t,e=2e3){const n=[];let a=[],i=0;const s=t=>/[.!?。！？]$/.test(t.trim()),o=t=>/[,;，；、]$/.test(t.trim()),r=t=>{const e=t.parentElement?.tagName?.toLowerCase();return["p","div","h1","h2","h3","li"].includes(e)};for(const l of t){const c=l.textContent.trim();if(i+c.length>e&&a.length>0){let t=a.length-1;for(;t>0&&!r(a[t]);)t--;if(0===t)for(t=a.length-1;t>0&&!s(a[t].textContent);)t--;if(0===t)for(t=a.length-1;t>0&&!o(a[t].textContent);)t--;const e=a.splice(++t);n.push(a),a=e,i=a.reduce((t,e)=>t+e.textContent.trim().length,0)}a.push(l),i+=c.length;const d=t.indexOf(l)===t.length-1,p=r(l);(d||p)&&a.length>0&&(n.push(a),a=[],i=0)}a.length>0&&n.push(a);const l=[];let c=null;for(const t of n){const n=t.reduce((t,e)=>t+e.textContent.trim().length,0);n<.3*e&&c&&c.reduce((t,e)=>t+e.textContent.trim().length,0)+n<=e?c.push(...t):(l.push(t),c=t)}return l}async translateChunkWithRetries(t,e=5,n=1500){const a=t.filter(t=>t.textContent.trim().length>0);if(0===a.length)return{success:!0,nodes:t};const i=this.translator.userSettings.settings,s="translation_only"!==i.displayOptions.translationMode,o=a.map((t,e)=>(this.originalTexts.has(t)||this.originalTexts.set(t,t.textContent),{id:e,text:this.originalTexts.get(t).trim()})),r=JSON.stringify(o,null,2);if(s){const s=this.translator.createPrompt(r,"page","",!0);for(let r=1;r<=e;r++)try{const e=await this.translator.api.request(s,"page"),n=this.parseFaultyJSON(e);if(Array.isArray(n)){const e=new Map(n.map(t=>[t.id,t])),s=[];if(a.forEach((t,n)=>{if(e.has(n)){const a=e.get(n),s=`${a.original||o[n].text} <|> ${a.ipa} <|> ${a.translation}`,r=this.translator.page.formatTranslation(a.original,s,i.displayOptions.translationMode,i.displayOptions);t.parentNode&&document.contains(t)&&this.updateNode(t,r)}else s.push({node:t,index:n})}),s.length>0){console.warn(`[Pinyin Mode] Batch translation missed ${s.length} items. Initiating fallback...`);const t=s.map(async t=>{try{const e=this.originalTexts.get(t.node).trim(),n=this.translator.createPrompt(e,"page_fallback","",!0),a=await this.translator.api.request(n,"page");if(a&&t.node.parentNode&&document.contains(t.node)){const n=this.translator.page.formatTranslation(e,a,i.displayOptions.translationMode,i.displayOptions);await this.updateNode(t.node,n)}}catch(e){console.error(`[Pinyin Mode] Fallback failed for item id ${t.index}:`,e)}});await Promise.allSettled(t)}return{success:!0,nodes:t}}throw new Error("[Pinyin Mode] API response was not a valid JSON array.")}catch(a){if(console.warn(`[Pinyin Mode] Attempt ${r}/${e} failed:`,a.message),r===e)return{success:!1,nodes:t,error:a};await new Promise(t=>setTimeout(t,n*Math.pow(2,r-1)))}}else{const s=this.translator.createPrompt(r,"page");for(let o=1;o<=e;o++)try{const e=await this.translator.api.request(s,"page"),n=this.parseFaultyJSON(e);if(Array.isArray(n)){const e=new Map(n.map(t=>[t.id,t.translation])),s=[];if(a.forEach((t,n)=>{if(e.has(n)){const a=e.get(n),s=this.translator.page.formatTranslation(this.originalTexts.get(t),a,i.displayOptions.translationMode,i.displayOptions);t.parentNode&&document.contains(t)&&this.updateNode(t,s)}else s.push({node:t,index:n})}),s.length>0){console.warn(`[Normal Mode] Batch translation missed ${s.length} items. Initiating fallback...`);const t=s.map(async t=>{try{const e=this.originalTexts.get(t.node).trim(),n=this.translator.createPrompt(e,"page_fallback"),a=await this.translator.api.request(n,"page");if(a&&t.node.parentNode&&document.contains(t.node)){const n=this.translator.page.formatTranslation(e,a,i.displayOptions.translationMode,i.displayOptions);await this.updateNode(t.node,n)}}catch(e){console.error(`[Normal Mode] Fallback failed for item id ${t.index}:`,e)}});await Promise.allSettled(t)}return{success:!0,nodes:t}}throw new Error("[Normal Mode] API response was not a valid JSON array.")}catch(a){if(console.warn(`[Normal Mode] Attempt ${o}/${e} failed:`,a.message),o===e)return{success:!1,nodes:t,error:a};await new Promise(t=>setTimeout(t,n*Math.pow(2,o-1)))}}}async translateHTML(t){try{const e=(new DOMParser).parseFromString(t,"text/html"),n=e.getElementsByTagName("script"),a=e.getElementsByTagName("style");[...n,...a].forEach(t=>t.remove());const i=this.getTranslatableHTMLNodes(e.body),s=this.createChunks(i,2e3);return this.translator.ui.showTranslatingStatus(),await Promise.all(s.map(async(t,e)=>{try{const n=(await Promise.all(t.map(t=>t.textContent.trim()))).filter(t=>t.length>0);if(0===n.length)return;const a=n.join(" <> "),i=this.translator.createPrompt(a,"page");console.log("prompt: ",i);const o=await this.translator.api.request(i,"page");if(!o)return;const r=o.split(" <> ");await Promise.all(t.map(async(t,e)=>{if(!(e>=r.length)&&t.textContent.trim().length>0&&t.parentNode)try{t.isAttribute?t.ownerElement.setAttribute(t.attributeName,r[e]):t.textContent=r[e]}catch(t){console.error("DOM update error:",t)}})),this.translator.ui.updateProcessingStatus(this._("notifications.translating_part")+`${e+1}/${s.length}`,Math.round((e+1)/s.length*100))}catch(t){console.error("Chunk translation error:",t)}})),e.documentElement.outerHTML}catch(t){throw console.error("HTML translation error:",t),t}finally{this.translator.ui.removeTranslatingStatus()}}getTranslatableHTMLNodes(t){const e=[],n=this.getExcludeSelectors(),a=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,{acceptNode:t=>{const e=t.parentElement;return e?n.some(t=>e.matches?.(t))?NodeFilter.FILTER_REJECT:t.textContent.trim()?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT:NodeFilter.FILTER_REJECT}});let i;for(;i=a.nextNode();)e.push(i);const s=t.getElementsByTagName("*"),o=["title","alt","placeholder"];for(const t of s)for(const n of o)if(t.hasAttribute(n)){const a=t.getAttribute(n);if(a&&a.trim()){const i=document.createTextNode(a);i.isAttribute=!0,i.attributeName=n,i.ownerElement=t,e.push(i)}}return e}async loadPDFJS(){this.pdfLoaded||(pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js",this.pdfLoaded=!0)}async translatePDF(t){try{await this.loadPDFJS();const e=await t.arrayBuffer(),n=await pdfjsLib.getDocument({data:e}).promise;let a=[];const i=n.numPages,s=document.createElement("canvas"),o=s.getContext("2d"),{translationMode:r}=this.settings.displayOptions,l="language_learning"===r&&this.settings.displayOptions.languageLearning.showSource;for(let t=1;t<=i;t++){const e=await n.getPage(t),c=e.getViewport({scale:2});s.height=c.height,s.width=c.width,await e.render({canvasContext:o,viewport:c}).promise;const d=await new Promise(t=>s.toBlob(t,"image/png")),p=new File([d],"page.png",{type:"image/png"});try{const e=await this.translator.ocr.processImage(p);if(!e)throw new Error(`Failed to process page ${t}`);let n;n="translation_only"===this.settings.displayOptions.translationMode?[this.formatTranslationPDF(e,r,l)]:e.toString().split("\n").map(t=>this.formatTranslationPDF(t,r,l)),a.push({pageNum:t,original:e,translations:n,displayMode:r,showSource:l})}catch(e){console.error(`Error processing page ${t}:`,e),a.push({pageNum:t,original:`[Error on page ${t}: ${e.message}]`,translations:[{original:"",translation:`[Translation Error: ${e.message}]`}],displayMode:r,showSource:l})}this.translator.ui.updateProgress(this._("notifications.processing_pdf"),Math.round(t/i*100)),o.clearRect(0,0,s.width,s.height)}return s.remove(),this.generateEnhancedTranslatedPDF(a)}catch(t){throw console.error("PDF translation error:",t),t}}formatTranslationPDF(t,e,n){if(!t)return"";switch(e){case"translation_only":return t.split("<|>")[0]||t;case"parallel":return`${this._("notifications.original")}: ${t.split("<|>")[0]||""}  ${this._("notifications.translation")}: ${t.split("<|>")[2]||t}`;case"language_learning":let e=[];n&&e.push(`${this._("notifications.original")}: ${t.split("<|>")[0]||""}`);const a=t.split("<|>")[1];a&&e.push(`${this._("notifications.ipa")}: ${a}`);const i=t.split("<|>")[2]||t;return e.push(`${this._("notifications.translation")}: ${i}`),e.join("  ");default:return t}}generateEnhancedTranslatedPDF(t){const e=`\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset="UTF-8">\n  <style>\n    body {\n      font-family: "GoMono Nerd Font", "Noto Sans", Arial;\n      line-height: 1.6;\n      max-width: 900px;\n      margin: 0 auto;\n      padding: 20px;\n    }\n    .page {\n      margin-bottom: 40px;\n      padding: 20px;\n      border: 1px solid #ddd;\n      border-radius: 8px;\n      page-break-after: always;\n    }\n    .page-number {\n      font-size: 18px;\n      font-weight: bold;\n      margin-bottom: 20px;\n      color: #666;\n    }\n    .content {\n      margin-bottom: 20px;\n    }\n    .section {\n      margin-bottom: 15px;\n      padding: 15px;\n      background-color: #fff;\n      border: 1px solid #eee;\n      border-radius: 8px;\n      white-space: pre-wrap;\n    }\n    .section-title {\n      font-weight: bold;\n      color: #333;\n      margin-bottom: 10px;\n    }\n    .section-content {\n      white-space: pre-wrap;\n      line-height: 1.5;\n    }\n    h3 {\n      color: #333;\n      margin: 10px 0;\n    }\n    @media print {\n      .page {\n        page-break-after: always;\n      }\n    }\n  </style>\n</head>\n<body>\n  ${t.map(t=>`\n    <div class="page">\n      <div class="page-number">${t.pageNum}</div>\n      <div class="content">\n        ${"translation_only"===t.displayMode?`\n          <div class="section">\n            <div class="section-title">${this._("notifications.original_label")}:</div>\n            <div class="section-content">${this.formatTranslationContent(t.translations.join("\n"))}</div>\n          </div>\n        `:"parallel"===t.displayMode?`\n          <div class="section">\n            <div class="section-content">${this.formatTranslationContent(t.translations.join("\n"))}</div>\n          </div>\n        `:`\n          ${t.showSource?`\n            <div class="section">\n              <div class="section-title">${this._("notifications.original_label")}:</div>\n              <div class="section-content">${this.formatTranslationContent(t.original)}</div>\n            </div>\n          `:""}\n          ${t.translations.some(t=>t.includes(`${this._("notifications.ipa")}:`))?`\n            <div class="section">\n              <div class="section-title">${this._("notifications.ipa")}:</div>\n              <div class="section-content">${this.formatTranslationContent(t.translations.map(t=>t.split(`${this._("notifications.ipa")}:`)[1]?.split(`${this._("notifications.translation_label")}:`)[0]).filter(Boolean).join("\n"))}</div>\n            </div>\n          `:""}\n          <div class="section">\n            <div class="section-title">${this._("notifications.translation_label")}:</div>\n            <div class="section-content">${this.formatTranslationContent(t.translations.map(t=>t.split(`${this._("notifications.translation_label")}:`)[1]).filter(Boolean).join("\n"))}</div>\n          </div>\n        `}\n      </div>\n    </div>\n  `).join("")}\n</body>\n</html>\n`;return new Blob([e],{type:"text/html"})}formatTranslationContent(t){return t?t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/\n/g,"<br>"):""}collectTextNodes(){const t=this.getExcludeSelectors(),e=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:e=>{if(!e.textContent.trim())return NodeFilter.FILTER_REJECT;if(!e.parentNode)return NodeFilter.FILTER_REJECT;let n=e.parentElement;for(;n;){for(const e of t)try{if(n.matches&&n.matches(e))return NodeFilter.FILTER_REJECT}catch(t){console.warn(`Invalid selector: ${e}`,t)}if("no"===n.getAttribute("translate")||n.getAttribute("class")?.includes("notranslate")||n.getAttribute("class")?.includes("no-translate"))return NodeFilter.FILTER_REJECT;n=n.parentElement}return NodeFilter.FILTER_ACCEPT}}),n=[];let a;for(;a=e.nextNode();)n.push(a);return n}setupDOMObserver(){this.domObserver&&(this.domObserver.disconnect(),this.domObserver=null),this.domObserver=new MutationObserver(t=>{const e=[];for(const n of t)if("childList"===n.type&&n.addedNodes.length>0){const t=this.getTextNodesFromNodeList(n.addedNodes);t.length>0&&e.push(...t)}if(e.length>0){const t=this.createChunks(e);Promise.all(t.map(t=>this.translateChunkParallel(t).catch(t=>{console.error("Translation error for chunk:",t)})))}}),this.domObserver.observe(document.body,{childList:!0,subtree:!0,characterData:!0})}getTextNodesFromNodeList(t){const e=this.getExcludeSelectors(),n=[],a=t=>{if(!t)return!0;let n=t;for(;n;){if(n.getAttribute&&("no"===n.getAttribute("translate")||n.getAttribute("data-notranslate")||n.classList?.contains("notranslate")||n.classList?.contains("no-translate")))return!0;for(const t of e)try{if(n.matches&&n.matches(t))return!0}catch(e){console.warn(`Invalid selector: ${t}`,e)}n=n.parentElement}return!1};return t.forEach(t=>{if(t.nodeType===Node.TEXT_NODE)t.textContent.trim()&&!a(t.parentElement)&&n.push(t);else if(t.nodeType===Node.ELEMENT_NODE&&!a(t)){const e=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,{acceptNode:t=>t.textContent.trim()&&!a(t.parentElement)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT});let i;for(;i=e.nextNode();)n.push(i)}}),n}async translateChunkParallel(t){try{const e=t.map(t=>t.textContent.trim()).filter(t=>t.length>0).join(" <-> ");if(!e)return;const n=this.translator.createPrompt(e,"page");console.log("prompt: ",n);const a=await this.translator.api.request(n,"page");if(a){const e=a.split("<->");await Promise.all(t.map(async(t,n)=>{const a=t.textContent.trim();if(a.length>0&&t.parentNode&&document.contains(t))try{if(this.originalTexts.set(t,t.textContent),n<e.length){const i=e[n],s=this.settings.displayOptions.translationMode;let o=this.formatTranslation(a,i,s,this.settings.displayOptions);t.textContent=o}}catch(t){console.error("DOM update error:",t)}}))}}catch(t){throw console.error("Chunk translation error:",t),t}}formatTranslation(t,e,n,a){const i=a.languageLearning.showSource;switch(n){case"translation_only":default:return e;case"parallel":return`${this._("notifications.original")}: ${t}  ${this._("notifications.translation")}: ${e.split("<|>")[2]||e}   `;case"language_learning":let n=[];i&&n.push(`${this._("notifications.original")}: ${t}`);const a=e.split("<|>")[1];a&&n.push(`${this._("notifications.ipa")}: ${a}`);const s=e.split("<|>")[2]||e;return n.push(`${this._("notifications.translation")}: ${s}   `),n.join("  ")}}}class f{constructor(t,e,n){this.storageKey=t,this.maxSize=e,this.expirationTime=n,this.cache=new Map,this.accessOrder=[],this.isInitialized=!1}async init(){if(this.isInitialized)return;const t=await GM_getValue(this.storageKey);if(t)try{const e=JSON.parse(t),n=new Map(Object.entries(e.cache||{})),a=e.accessOrder||[],i=new Map,s=[],o=Date.now();let r=!1;for(const t of a){const e=n.get(t);if(e)try{o-JSON.parse(LZString.decompressFromUTF16(e)).timestamp<=this.expirationTime?(i.set(t,e),s.push(t)):r=!0}catch(e){r=!0,console.warn(`Could not decompress cache item for key "${t}", removing it.`)}}this.cache=i,this.accessOrder=s,r&&(console.log(`Cache "${this.storageKey}": Purged expired items.`),await this._saveToStorage()),console.log(`Cache "${this.storageKey}" loaded with ${this.cache.size} valid items.`)}catch(t){console.error(`Failed to load or clean cache "${this.storageKey}":`,t),this.cache=new Map,this.accessOrder=[]}this.isInitialized=!0}async _saveToStorage(){const t={cache:Object.fromEntries(this.cache),accessOrder:this.accessOrder};await GM_setValue(this.storageKey,JSON.stringify(t))}async set(t,e){if(this.isInitialized||await this.init(),this.cache.has(t)){const e=this.accessOrder.indexOf(t);e>-1&&this.accessOrder.splice(e,1)}else if(this.cache.size>=this.maxSize){const t=this.accessOrder.shift();t&&this.cache.delete(t)}this.accessOrder.push(t);const n=LZString.compressToUTF16(JSON.stringify({value:e,timestamp:Date.now()}));this.cache.set(t,n),await this._saveToStorage()}async get(t){this.isInitialized||await this.init();const e=this.cache.get(t);if(!e)return null;let n;try{n=JSON.parse(LZString.decompressFromUTF16(e))}catch(e){console.warn(`Could not decompress cache item for key "${t}", removing it.`),this.cache.delete(t);const n=this.accessOrder.indexOf(t);return n>-1&&this.accessOrder.splice(n,1),await this._saveToStorage(),null}if(Date.now()-n.timestamp>this.expirationTime){this.cache.delete(t);const e=this.accessOrder.indexOf(t);return e>-1&&this.accessOrder.splice(e,1),await this._saveToStorage(),null}const a=this.accessOrder.indexOf(t);return a>-1&&this.accessOrder.splice(a,1),this.accessOrder.push(t),await this._saveToStorage(),n.value}static arrayBufferToBase64(t){let e="";const n=new Uint8Array(t);for(let t=0;t<n.byteLength;t++)e+=String.fromCharCode(n[t]);return window.btoa(e)}static base64ToArrayBuffer(t){const e=window.atob(t),n=e.length,a=new Uint8Array(n);for(let t=0;t<n;t++)a[t]=e.charCodeAt(t);return a.buffer}async clear(){this.cache.clear(),this.accessOrder=[],await GM_deleteValue(this.storageKey)}}class v{constructor(t){this.settings=t.settings,this._=t._}async getUploadUrl(t){const e=this.settings.apiKey[this.settings.apiProvider],n=[];let a=Math.floor(Math.random()*e.length);for(let i=0;i<e.length;i++){const s=e[(a+i)%e.length];try{return new Promise((e,n)=>{GM_xmlhttpRequest({method:"POST",url:`${o.API.providers.gemini.uploadUrl}?key=${s}`,headers:{"X-Goog-Upload-Protocol":"resumable","X-Goog-Upload-Command":"start","X-Goog-Upload-Header-Content-Length":t.size,"X-Goog-Upload-Header-Content-Type":t.type,"Content-Type":"application/json"},data:JSON.stringify({file:{display_name:t.name}}),onload:t=>{const a=t.responseHeaders.match(/x-goog-upload-url: (.*)/i)?.[1];a||n(new Error(this._("notifications.upl_url"))),e({url:a,key:s})},onerror:t=>n(t)})})}catch(t){n.push(`Key ${s.slice(0,8)}... : ${t.message}`),await new Promise(t=>setTimeout(t,100));continue}}if(n.length>0)throw new Error(this._("notifications.all_keys_failed")+`${n.join("\n")}`)}async uploadFile(t,e){return new Promise((n,a)=>{GM_xmlhttpRequest({method:"POST",url:t.url,headers:{"Content-Length":e.size,"X-Goog-Upload-Offset":"0","X-Goog-Upload-Command":"upload, finalize"},data:e,onload:e=>{const i=JSON.parse(e.responseText);i.file?.uri||a(new Error(this._("notifications.upl_uri"))),n({uri:i.file.uri,key:t.key})},onerror:t=>a(t)})})}async uploadLargeFile(t){try{const e=await this.getUploadUrl(t);return await this.uploadFile(e,t)}catch(t){throw console.error("Upload failed:",t),new Error(this._("notifications.upl_fail"))}}}class b{constructor(t){this.translator=t,this.uploader=new v(this.translator.userSettings),this.settings=this.translator.userSettings.settings,this._=this.translator.userSettings._}checkFileSizeLimit(t,e){let n="document";e.startsWith("image/")?n="image":e.startsWith("video/")?n="video":e.startsWith("audio/")&&(n="audio");const a=o.API.providers.gemini.limits.maxUploadSize[n];if(t.size>a)throw new Error(this._("notifications.file_too_large")+` ${n}: ${a/1048576}MB`)}async fileToBase64(t){return new Promise((e,n)=>{const a=new FileReader;a.onload=()=>e(a.result.split(",")[1]),a.onerror=()=>n(new Error(this._("notifications.failed_read_file"))),a.readAsDataURL(t)})}async fetchUrlAsFile(t,e,n="king1x32_file_from_url"){return new Promise((a,i)=>{GM_xmlhttpRequest({method:"GET",url:t,responseType:"arraybuffer",anonymous:!0,onload:t=>{if(t.status>=200&&t.status<300){const i=new Blob([t.response],{type:e});a(new File([i],n,{type:e,lastModified:Date.now()}))}else i(new Error(`${this._("notifications.request_failed")} ${t.status} ${t.statusText}`))},onerror:t=>{i(new Error(`${this._("notifications.network_error")}: ${t.message||"Unknown network error"}`))}})})}async processFile(t,e){const n=this.settings.apiProvider,a=o.API.providers[n];let i=null,s="king1x32_file";if("string"==typeof t){const e=t;let n="application/octet-stream";try{const t=(await new Promise((t,n)=>{GM_xmlhttpRequest({method:"HEAD",url:e,onload:e=>t(e),onerror:t=>n(t),anonymous:!0,nocache:!0})})).responseHeaders.match(/content-type: (.*?)(?:\r\n|$)/i);t&&(n=t[1].split(";")[0].trim());const a=e.split("/");s=a[a.length-1].split("?")[0].split("#")[0]||"file_from_url"}catch(t){console.warn(`Không thể lấy MIME type cho URL ${e}, đang suy luận từ phần mở rộng. Lỗi:`,t);const a=e.split(".");a.length>1&&(n={jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",mp4:"video/mp4",webm:"video/webm",mov:"video/quicktime",mp3:"audio/mp3",wav:"audio/wav",ogg:"audio/ogg",m4a:"audio/mp4",pdf:"application/pdf",txt:"text/plain",html:"text/html",json:"application/json",xml:"application/xml",csv:"text/csv",md:"text/markdown",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",xls:"application/vnd.ms-excel",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",ppt:"application/vnd.ms-powerpoint",pptx:"application/vnd.openxmlformats-officedocument.presentationml.presentation"}[a.pop().toLowerCase()]||"application/octet-stream")}this.translator.ui.showProcessingStatus(this._("notifications.processing_url"));try{i=await this.fetchUrlAsFile(e,n,s)}catch(t){throw new Error(`${this._("notifications.failed_read_file")}: ${t.message}`)}finally{setTimeout(()=>this.translator.ui.removeProcessingStatus(),1e3)}}else i=t,s=t.name;if(!i)throw new Error("Không có nội dung file để xử lý sau khi đọc.");const r=i.type;if("gemini"===n){if(this.checkFileSizeLimit(i,r),i.size<=a.limits.maxDirectSize)return{content:[{text:e},{inline_data:{mime_type:r,data:await this.fileToBase64(i)}}]};{const t=await this.uploader.uploadLargeFile(i);return{content:[{text:e},{file_data:{mime_type:r,file_uri:t.uri}}],key:t.key}}}{const t=await this.fileToBase64(i);return{content:a.createBinaryParts(e,r,t)}}}}const _={text:{maxSize:10485760,formats:[{ext:"txt",mime:"text/plain"},{ext:"srt",mime:"application/x-subrip"},{ext:"vtt",mime:"text/vtt"},{ext:"pdf",mime:"application/pdf"},{ext:"html",mime:"text/html"},{ext:"md",mime:"text/markdown"},{ext:"json",mime:"application/json"}]}};class x{constructor(t){this.translator=t,this._=t.userSettings._,this.supportedFormats=_}isValidFormat(t){const e=t.name.split(".").pop().toLowerCase(),n=t.type;return _.text.formats.some(t=>t.ext===e||t.mime===n)}isValidSize(t){return t.size<=_.text.maxSize}async processFile(t){try{const e=await this.readFileContent(t);switch(t.name.split(".").pop().toLowerCase()){case"txt":case"md":return await this.translator.translate(e);case"json":return await this.processJSON(e);case"html":return await this.translator.page.translateHTML(e);case"pdf":return await this.translator.page.translatePDF(t);case"srt":case"vtt":return await this.processSubtitle(e);default:throw new Error(this._("notifications.uns_format"))}}catch(t){throw new Error(this._("notifications.file_processing_error")+`: ${t.message}`)}}async processJSON(t){try{const e=JSON.parse(t),n=await this.translateObject(e);return JSON.stringify(n,null,2)}catch(t){throw new Error(this._("notifications.json_processing_error"))}}parseFaultyJSON(t){let e=t.trim();const n=e.match(/```json\s*([\s\S]*?)\s*```/);n&&n[1]&&(e=n[1].trim());try{const t=JSON.parse(e);if(Array.isArray(t))return t}catch(t){console.warn("Could not parse the whole JSON string, attempting to parse line by line.",t.message)}const a=[],i=e.split("\n");let s="";if(i.forEach(t=>{s+=t;try{if(t.trim().endsWith("},")||t.trim().endsWith("}")){const t=s.trim().endsWith(",")?s.trim().slice(0,-1):s.trim(),e=JSON.parse(t);"number"==typeof e.id&&(e.translation||e.text)&&a.push(e),s=""}}catch(t){}}),a.length>0)return console.warn("Fallback JSON parsing succeeded with",a.length,"objects."),a;throw new Error(this._("notifications.response_parse_error"))}async processSubtitle(t){try{const e=this.translator.userSettings.settings,n=e.displayOptions.translationMode,a="language_learning"===n&&e.displayOptions.languageLearning.showSource,i=t.split(/\r?\n\r?\n/).map((t,e)=>{if(""===t.trim())return null;const n=t.split(/\r?\n/);if(n.length<2)return null;const a=n[0],i=n[1],s=n.slice(2).join("\n");return/^\d+$/.test(a.trim())&&i.includes("--\x3e")?{originalIndex:e,index:a,timing:i,originalText:s}:null}).filter(Boolean);if(0===i.length)return t;const s=100,o=[];for(let t=0;t<i.length;t+=s)o.push(i.slice(t,t+s));const r=new Map,l=document.title?`từ video có tiêu đề "${document.title}"`:"",c=e.displayOptions.targetLanguage;return await Promise.all(o.map(async t=>{const e=t.filter(t=>""!==t.originalText.trim());if(0===e.length)return;const n=e.map(t=>({id:t.originalIndex,text:t.originalText})),a=`You are an expert subtitle translator. Your task is to translate the 'text' field for each object in the following JSON array to '${c}'.\n- Target language: '${c}'.\n- Use the context of ${l} to determine the translation style.\n- The translation must strictly adhere to the context and tone of the original text.\n- Ensure fluency and naturalness as a native speaker would.\n- Do not add any explanations or interpretations beyond the translation.\n- Preserve terminology and proper nouns on a 1:1 basis.\n- You MUST return a valid JSON array.\n- For EACH object you translate, you MUST include the original 'id' from the input.\n- Each object in the output array must contain exactly two fields: "id" (the original integer ID) and "translation" (the translated text).\n- Do NOT add, merge, or skip any objects. The output array should ideally have the same number of objects as the input.\n- Do NOT add any extra text, comments, or markdown formatting (DO NOT like \`\`\`json). The output must be raw, valid JSON.\n- CRITICAL: Properly escape all special characters within the "translation" strings, especially double quotes (").\n\nInput JSON:\n\`\`\`\n${JSON.stringify(n,null,2)}\n\`\`\`\n\nExpected Output JSON format:\n[\n  { "id": 0, "translation": "Translated text for object with id 0..." },\n  { "id": 1, "translation": "Translated text for object with id 1..." },\n  ...\n]\n`,i=await this.translator.api.request(a,"page");if(!i)return;const s=this.parseFaultyJSON(i);Array.isArray(s)&&s.forEach(t=>{const e=t.translation||t.text;void 0!==t.id&&e&&r.set(t.id,e)})})),i.map(t=>{const e=r.get(t.originalIndex);if(!e||""===t.originalText.trim())return`${t.index}\n${t.timing}\n${t.originalText}`;let i;return i="parallel"===n||"language_learning"===n&&a?`${t.originalText}\n${e}`:e,`${t.index}\n${t.timing}\n${i}`}).join("\n\n")}catch(t){throw console.error("Subtitle processing error:",t),new Error(this._("notifications.subtitle_processing_error")+`: ${t.message}`)}}async translateObject(t){const e={};for(const n in t)"string"==typeof t[n]?e[n]=await this.translator.translate(t[n]):"object"==typeof t[n]&&null!==t[n]?e[n]=await this.translateObject(t[n]):e[n]=t[n];return e}readFileContent(t){return new Promise((e,n)=>{const a=new FileReader;a.onload=()=>e(a.result),a.onerror=()=>n(new Error(this._("notifications.failed_read_file"))),a.readAsText(t)})}}class S{constructor(t){this.translator=t,this.settings=this.translator.userSettings.settings;const e=this.settings.theme,n=o.THEME[e],a="dark"===e;let i=document.querySelector("#king-translator-root");if(i&&i.remove(),this.container=document.createElement("div"),this.container.id="king-translator-root",this.container.style.cssText="z-index: 2147483647;",this.container.attachShadow)try{this.shadowRoot=this.container.attachShadow({mode:"closed"})}catch(t){console.error("King Translator: Error attaching Shadow DOM:",t),console.warn("King Translator: Could not attach Shadow DOM, falling back to direct injection."),this.shadowRoot=this.container}else console.warn("King Translator: attachShadow is not supported, falling back to direct injection."),this.shadowRoot=this.container;const s=document.createElement("style");s.textContent=`\n.translator-settings-container {\n  z-index: 2147483647;\n  position: fixed;\n  background-color: ${n.background};\n  color: ${n.text};\n  padding: 20px;\n  border-radius: 15px;\n  box-shadow: 0 2px 10px rgba(0,0,0,0.3);\n  width: auto;\n  min-width: 320px;\n  max-width: 90vw;\n  max-height: 90vh;\n  overflow-y: auto;\n  top: ${window.innerHeight/2}px;\n  left: ${window.innerWidth/2}px;\n  transform: translate(-50%, -50%);\n  display: block;\n  visibility: visible;\n  opacity: 1;\n  font-size: 14px;\n  line-height: 1.4;\n}\n.translator-settings-container * {\n  font-family: "GoMono Nerd Font", "Noto Sans", Arial;\n  box-sizing: border-box;\n}\n.translator-settings-container input[type="checkbox"],\n.translator-settings-container input[type="radio"] {\n  appearance: auto;\n  -webkit-appearance: auto;\n  -moz-appearance: auto;\n  position: relative;\n  width: 16px;\n  height: 16px;\n  margin: 3px 5px;\n  padding: 0;\n  accent-color: #0000aa;\n  border: 1px solid ${n.border};\n  opacity: 1;\n  visibility: visible;\n  cursor: pointer;\n}\n.radio-group {\n  display: flex;\n  gap: 15px;\n  align-items: center;\n}\n.radio-group label {\n  align-items: center;\n  justify-content: center;\n  padding: 5px;\n  gap: 5px;\n}\n.radio-group input[type="radio"] {\n  margin: 0;\n  position: relative;\n  top: 0;\n}\n.translator-settings-container input[type="radio"] {\n  border-radius: 50%;\n}\n.translator-settings-container input[type="checkbox"] {\n  display: flex;\n  position: relative;\n  margin: 5px 50% 5px 50%;\n  align-items: center;\n  justify-content: center;\n}\n.settings-grid input[type="text"],\n.settings-grid input[type="number"],\n.settings-grid select {\n  appearance: auto;\n  -webkit-appearance: auto;\n  -moz-appearance: auto;\n  background-color: ${a?"#202020":"#eeeeee"};\n  color: ${n.text};\n  border: 1px solid ${n.border};\n  border-radius: 8px;\n  padding: 7px 10px;\n  margin: 5px;\n  font-size: 14px;\n  line-height: normal;\n  height: auto;\n  width: auto;\n  min-width: 100px;\n  display: inline-block;\n  visibility: visible;\n  opacity: 1;\n}\n.settings-grid select {\n  padding-right: 20px;\n}\n.settings-grid label {\n  display: inline-flex;\n  align-items: center;\n  margin: 3px 10px;\n  color: ${n.text};\n  cursor: pointer;\n  user-select: none;\n}\n.settings-grid input:not([type="hidden"]),\n.settings-grid select,\n.settings-grid textarea {\n  display: inline-block;\n  opacity: 1;\n  visibility: visible;\n  position: static;\n}\n.settings-grid input:disabled,\n.settings-grid select:disabled {\n  opacity: 0.5;\n  cursor: not-allowed;\n}\n.translator-settings-container input[type="checkbox"]:hover,\n.translator-settings-container input[type="radio"]:hover {\n  border-color: ${"dark"===n.mode?"#777":"#444"};\n}\n.settings-grid input:focus,\n.settings-grid select:focus {\n  outline: 2px solid rgba(74, 144, 226, 0.5);\n  outline-offset: 1px;\n}\n.settings-grid input::before,\n.settings-grid input::after {\n  content: none;\n  display: none;\n}\n.translator-settings-container button {\n  display: inline-flex;\n  align-items: center;\n  justify-content: center;\n  gap: 8px;\n  line-height: 1;\n}\n.translator-settings-container .api-key-entry input[type="text"] {\n  padding: 8px 10px;\n  margin: 0px 3px 3px 15px;\n  appearance: auto;\n  -webkit-appearance: auto;\n  -moz-appearance: auto;\n  font-size: 14px;\n  line-height: normal;\n  width: auto;\n  min-width: 100px;\n  display: inline-block;\n  visibility: visible;\n  opacity: 1;\n  border: 1px solid ${n.border};\n  border-radius: 10px;\n  box-sizing: border-box;\n  font-family: "GoMono Nerd Font", "Noto Sans", Arial;\n  text-align: left;\n  vertical-align: middle;\n  background-color: ${a?"#202020":"#eeeeee"};\n  color: ${n.text};\n}\n.translator-settings-container .api-key-entry input[type="text"]:focus {\n  outline: 3px solid rgba(74, 144, 226, 0.5);\n  outline-offset: 1px;\n  box-shadow: none;\n}\n.translator-settings-container .api-key-entry {\n  display: flex;\n  gap: 10px;\n  align-items: center;\n}\n.remove-key {\n  display: inline-flex;\n  align-items: center;\n  justify-content: center;\n  width: 24px;\n  height: 24px;\n  padding: 0;\n  line-height: 1;\n}\n.translator-settings-container::-webkit-scrollbar {\n  width: 8px;\n}\n.translator-settings-container::-webkit-scrollbar-track {\n  background-color: ${"dark"===n.mode?"#222":"#eeeeee"};\n  border-radius: 8px;\n}\n.translator-settings-container::-webkit-scrollbar-thumb {\n  background-color: ${"dark"===n.mode?"#666":"#888"};\n  border-radius: 8px;\n}\n.translator-tools-container {\n  position: fixed;\n  bottom: 40px;\n  right: 20px;\n  color: ${n.text};\n  border-radius: 10px;\n  z-index: 2147483647;\n  display: block;\n  visibility: visible;\n  opacity: 1;\n}\n.translator-tools-container * {\n  font-family: "GoMono Nerd Font", "Noto Sans", Arial;\n  box-sizing: border-box;\n}\n.translator-tools-button {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  padding: 8px 11px;\n  border: none;\n  border-radius: 9px;\n  background-color: rgba(74,144,226,0.3);\n  color: white;\n  cursor: pointer;\n  transition: all 0.3s ease;\n  box-shadow: 0 2px 10px rgba(0,0,0,0.2);\n  font-size: 15px;\n  line-height: 1;\n  visibility: visible;\n  opacity: 1;\n}\n.translator-tools-dropdown {\n  display: none;\n  position: absolute;\n  bottom: 100%;\n  right: 0;\n  margin-bottom: 10px;\n  background-color: ${n.background};\n  color: ${n.text};\n  border-radius: 15px;\n  box-shadow: 0 2px 10px rgba(0,0,0,0.15);\n  padding: 15px 12px 9px 12px;\n  min-width: 225px;\n  overflow-y: auto;\n  z-index: 2147483647;\n  visibility: visible;\n  opacity: 1;\n}\n.translator-tools-item {\n  display: flex;\n  align-items: center;\n  gap: 10px;\n  padding: 10px;\n  margin-bottom: 5px;\n  cursor: pointer;\n  transition: all 0.2s ease;\n  border-radius: 10px;\n  background-color: ${n.backgroundShadow};\n  color: ${n.text};\n  border: 1px solid ${n.border};\n  visibility: visible;\n  opacity: 1;\n}\n.item-icon, .item-text {\n  font-family: "GoMono Nerd Font", "Noto Sans", Arial;\n  visibility: visible;\n  opacity: 1;\n}\n.item-icon {\n  font-size: 18px;\n}\n.item-text {\n  font-size: 14px;\n}\n.translator-tools-item:hover {\n  background-color: ${n.button.translate.background};\n  color: ${n.button.translate.text};\n}\n.translator-tools-item:active {\n  transform: scale(0.98);\n}\n.translator-tools-button:hover {\n  transform: translateY(-2px);\n  background-color: #357abd;\n}\n.translator-tools-button:disabled {\n  opacity: 0.7;\n  cursor: not-allowed;\n}\n.translator-overlay {\n  position: fixed;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  background-color: rgba(0,0,0,0.3);\n  z-index: 2147483647;\n  cursor: crosshair;\n}\n.translator-guide {\n  position: fixed;\n  top: 20px;\n  left: ${window.innerWidth/2}px;\n  transform: translateX(-50%);\n  background-color: rgba(0,0,0,0.8);\n  color: white;\n  padding: 10px 20px;\n  border-radius: 8px;\n  font-size: 14px;\n  z-index: 2147483647;\n}\n.translator-cancel {\n  position: fixed;\n  top: 20px;\n  right: 20px;\n  background-color: #ff4444;\n  color: white;\n  border: none;\n  border-radius: 50%;\n  width: 30px;\n  height: 30px;\n  font-size: 16px;\n  cursor: pointer;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  z-index: 2147483647;\n  transition: all 0.3s ease;\n}\n.translator-cancel:hover {\n  background-color: #ff0000;\n  transform: scale(1.1);\n}\n/* Animation */\n@keyframes fadeIn {\n  from {\n    opacity: 0;\n    transform: translateY(10px);\n  }\n  to {\n    opacity: 1;\n    transform: translateY(0);\n  }\n}\n.translator-tools-container {\n  animation: fadeIn 0.3s ease;\n}\n.translator-tools-dropdown {\n  animation: fadeIn 0.2s ease;\n}\n.translator-tools-container.hidden,\n.translator-notification.hidden,\n.center-translate-status.hidden {\n  visibility: hidden;\n}\n.settings-label,\n.settings-section-title,\n.shortcut-prefix,\n.item-text,\n.translator-settings-container label {\n  color: ${n.text};\n  margin: 2px 10px;\n}\n.translator-settings-container input[type="text"],\n.translator-settings-container input[type="number"],\n.translator-settings-container select {\n  background-color: ${a?"#202020":"#eeeeee"};\n  color: ${n.text};\n}\n/* Đảm bảo input không ghi đè lên label */\n.translator-settings-container input {\n  color: inherit;\n}\n@keyframes spin {\n  0% { transform: rotate(0deg); }\n  100% { transform: rotate(360deg); }\n}\n.processing-spinner {\n  width: 30px;\n  height: 30px;\n  color: white;\n  border: 3px solid rgba(255,255,255,0.3);\n  border-radius: 50%;\n  border-top-color: white;\n  animation: spin 1s ease-in-out infinite;\n  margin: 0 auto 10px auto;\n}\n.processing-message {\n  margin-bottom: 10px;\n  font-size: 14px;\n}\n.processing-progress {\n  font-size: 12px;\n  opacity: 0.8;\n}\n.translator-content p {\n  margin: 5px 0;\n}\n.translator-content strong {\n  font-weight: bold;\n}\n.translator-context-menu {\n  position: fixed;\n  color: ${n.text};\n  background-color: ${n.background};\n  border-radius: 8px;\n  padding: 8px 8px 5px 8px;\n  min-width: 150px;\n  box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n  z-index: 2147483647;\n  font-family: "GoMono Nerd Font", "Noto Sans", Arial;\n  font-size: 14px;\n  opacity: 0;\n  transform: scale(0.95);\n  transition: all 0.1s ease-out;\n  animation: menuAppear 0.15s ease-out forwards;\n}\n@keyframes menuAppear {\n  from {\n    opacity: 0;\n    transform: scale(0.95);\n  }\n  to {\n    opacity: 1;\n    transform: scale(1);\n  }\n}\n.translator-context-menu-item {\n  padding: 5px;\n  margin-bottom: 3px;\n  cursor: pointer;\n  color: ${n.text};\n  background-color: ${n.backgroundShadow};\n  border: 1px solid ${n.border};\n  border-radius: 7px;\n  transition: all 0.2s ease;\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  white-space: nowrap;\n  z-index: 2147483647;\n}\n.translator-context-menu-item:hover {\n  background-color: ${n.button.translate.background};\n  color: ${n.button.translate.text};\n}\n.translator-context-menu-item:active {\n  transform: scale(0.98);\n}\n.input-translate-button-container {\n  font-family: "GoMono Nerd Font", "Noto Sans", Arial;\n}\n.input-translate-button {\n  font-family: inherit;\n}\n.translator-notification {\n  position: fixed;\n  top: 20px;\n  left: ${window.innerWidth/2}px;\n  transform: translateX(-50%);\n  z-index: 2147483647;\n  animation: fadeInOut 2s ease;\n}\n/* Styles cho loading/processing status */\n.center-translate-status {\n  position: fixed;\n  top: ${window.innerHeight/2}px;\n  left: ${window.innerWidth/2}px;\n  transform: translate(-50%, -50%);\n  background-color: rgba(0, 0, 0, 0.8);\n  color: white;\n  padding: 15px 25px;\n  border-radius: 8px;\n  z-index: 2147483647;\n}\n/* Styles cho translate button */\n.translator-button {\n  position: fixed;\n  border: none;\n  border-radius: 8px;\n  padding: 5px 10px;\n  cursor: pointer;\n  z-index: 2147483647;\n  font-size: 14px;\n}\n/* Styles cho popup */\n.draggable {\n  position: fixed;\n  background-color: ${n.background};\n  color: ${n.text};\n  border-radius: 12px;\n  box-shadow: 0 2px 10px rgba(0,0,0,0.3);\n  z-index: 2147483647;\n}\n.tts-controls {\n  visibility: hidden;\n  opacity: 0;\n  transition: all 0.2s ease;\n}\n.tts-button:hover .tts-controls,\n.tts-controls:hover {\n  visibility: visible;\n  opacity: 1;\n}\n.tts-controls input[type="range"] {\n  width: 100%;\n  height: 4px;\n  -webkit-appearance: none;\n  background: ${a?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)"};\n  border-radius: 2px;\n  outline: none;\n}\n.tts-controls input[type="range"]::-webkit-slider-thumb {\n  -webkit-appearance: none;\n  width: 12px;\n  height: 12px;\n  background: ${n.button.translate.background};\n  border-radius: 50%;\n  cursor: pointer;\n}\n/* Styles cho manga translation */\n.manga-translation-container {\n  position: absolute;\n  top: 0;\n  left: 0;\n  pointer-events: none;\n  z-index: 2147483647;\n}\n/* Animations */\n@keyframes fadeIn {\n  from { opacity: 0; transform: translateY(10px); }\n  to { opacity: 1; transform: translateY(0); }\n}\n@keyframes fadeInOut {\n  0% { opacity: 0; transform: translateX(-50%) translateY(-10px); }\n  10% { opacity: 1; transform: translateX(-50%) translateY(0); }\n  90% { opacity: 1; transform: translateX(-50%) translateY(0); }\n  100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }\n}\n@keyframes spin {\n  0% { transform: rotate(0deg); }\n  100% { transform: rotate(360deg); }\n}\n`,this.shadowRoot.appendChild(s),document.body.appendChild(this.container)}getRoot(){return this.shadowRoot}getContainer(){return this.container}cleanup(){this.container&&this.container.parentNode&&this.container.remove(),this.container=null,this.shadowRoot=null}}class w{constructor(n){if(!n)throw new Error("Translator instance is required");this.translator=n,this.settings=this.translator.userSettings.settings,this._=this.translator.userSettings._,this.translatingStatus=null,this.ignoreNextSelectionChange=!1,this.touchCount=0,this.currentTranslateButton=null,this.isProcessing=!1,this.touchEndProcessed=!1,this.currentOverlay=null,this.currentSelectionBox=null,this.currentStatusContainer=null,this.currentGuide=null,this.currentCancelBtn=null,this.currentStyle=null,this.voiceStorage={},this.selectSource=null,this.selectVoice=null,this.isTTSSpeaking=!1,this.currentTTSAudio=null,this.translationButtonEnabled=!0,this.translationTapEnabled=!0,this.mediaElement=null,this.googleTranslateActive=!1,this.googleTranslateAttempts=0,this.container=this.translator.uiRoot.getContainer(),this.shadowRoot=this.translator.uiRoot.getRoot(),this.settings.translatorTools?.enabled&&null===t("translatorToolsEnabled")&&e("translatorToolsEnabled","true"),this.mobileOptimizer=new l(this),this.page=this.translator.page,this.ocr=new g(n),this.media=new u(n),this.handleSettingsShortcut=this.handleSettingsShortcut.bind(this),this.handleTranslationShortcuts=this.handleTranslationShortcuts.bind(this),this.handleTranslateButtonClick=this.handleTranslateButtonClick.bind(this),this.setupClickHandlers=this.setupClickHandlers.bind(this),this.setupSelectionHandlers=this.setupSelectionHandlers.bind(this),this.showTranslatingStatus=this.showTranslatingStatus.bind(this),this.removeTranslatingStatus=this.removeTranslatingStatus.bind(this),this.resetState=this.resetState.bind(this),this.settingsShortcutListener=this.handleSettingsShortcut,this.translationShortcutListener=this.handleTranslationShortcuts,this.handleGeminiFileOrUrlTranslation=this.handleGeminiFileOrUrlTranslation.bind(this),this.setupEventListeners(),"complete"===document.readyState?(this.settings.pageTranslation.autoTranslate&&this.page.checkAndTranslate(),this.settings.pageTranslation.showInitialButton&&this.setupQuickTranslateButton()):window.addEventListener("load",()=>{this.settings.pageTranslation.autoTranslate&&this.page.checkAndTranslate(),this.settings.pageTranslation.showInitialButton&&this.setupQuickTranslateButton()}),setTimeout(()=>{if(!this.$(".translator-tools-container")){let e=!1;null===t("translatorToolsEnabled")&&t("translatorToolsEnabled"),"true"===t("translatorToolsEnabled")&&(e=!0),this.settings.translatorTools?.enabled&&e&&this.setupTranslatorTools()}},5e3),this.debouncedCreateButton=i((t,e,n)=>{this.createTranslateButton(t,e,n)},100)}$(t){return this.shadowRoot.querySelector(t)}$$(t){return this.shadowRoot.querySelectorAll(t)}createCloseButton(){const t=document.createElement("span");return t.textContent="x",Object.assign(t.style,{position:"absolute",top:"0px",right:"0px",cursor:"pointer",color:"black",fontSize:"14px",fontWeight:"bold",padding:"4px 8px",lineHeight:"14px"}),t.onclick=()=>t.parentElement.remove(),t}showTranslationBelow(t,e,n){if(e.nextElementSibling?.classList.contains("translator-content"))return;const a=this.settings.displayOptions,i=a.translationMode,s=a.languageLearning.showSource;let r="";if("translation_only"===i)r=t;else if("parallel"===i)r=`<div style="margin-bottom: 8px">${this._("original_label")}: ${n}</div>\n<div>${this._("translation_label")}: ${t.split("<|>")[2]||t}</div>`;else if("language_learning"===i){let e="";s&&(e=`<div style="margin-bottom: 8px">[${this._("original_label")}]: ${n}</div>`),r=`${e}\n<div>[${this._("pinyin_label")}]: ${t.split("<|>")[1]||""}</div>\n<div>[${this._("translation_label")}]: ${t.split("<|>")[2]||t}</div>`}const l=document.createElement("div");l.classList.add("translator-content"),Object.assign(l.style,{...o.STYLES.translation,fontSize:a.fontSize}),l.innerHTML=r;const c=this.settings.theme,d=o.THEME[c];l.appendChild(this.createCloseButton()),e.insertAdjacentElement("afterend",l),l.style.cssText=`\ndisplay: block; /* Giữ cho phần dịch không bị kéo dài hết chiều ngang */\nmax-width: fit-content; /* Giới hạn chiều rộng */\nwidth: auto; /* Để nó co giãn theo nội dung */\nmin-width: 150px;\ncolor: ${d.text};\nbackground-color: ${d.background};\npadding: 10px 20px 10px 10px;\nmargin-top: 10px;\nborder-radius: 8px;\nposition: relative;\nz-index: 2147483647;\nborder: 1px solid ${d.border};\nwhite-space: normal; /* Cho phép xuống dòng nếu quá dài */\noverflow-wrap: break-word; /* Ngắt từ nếu quá dài */\n`;const p=()=>{document.removeEventListener("keydown",g),document.removeEventListener("click",h),l.style.opacity="0",l.style.display="none",l.style.animation="popupEntrance 0.3s cubic-bezier(0.4, 0, 0.6, 1) reverse",setTimeout(()=>l.remove(),300)};l.addEventListener("click",t=>t.stopPropagation());const h=t=>{l&&!l.contains(t.target)&&p()};document.addEventListener("click",h);const g=t=>{"Escape"===t.key&&p()};document.removeEventListener("keydown",g),document.addEventListener("keydown",g)}displayPopup(t,e,n="Bản dịch",i=""){console.log("ori:"+e,"\nipa:"+i,"\ntrans:"+t),this.removeTranslateButton();const s=this.settings,r=s.theme,l=o.THEME[r],c="dark"===r,d=s.displayOptions,p="auto"===d.sourceLanguage?this.page.languageCode:d.sourceLanguage,h=d.fontSize||"14px",g=d.minPopupWidth||"300px",u=d.maxPopupWidth||"90vw",m="parallel"===d.translationMode,y=(t,e=!1)=>{if("number"==typeof t)return t;if("string"!=typeof t)return e?14:300;const n=parseFloat(t),a=t.replace(n.toString(),"").trim().toLowerCase(),i=document.createElement("div");let s;i.style.position="absolute",i.style.visibility="hidden",i.style.top="-9999px",document.body.appendChild(i);try{switch(a){case"px":s=n;break;case"%":s=e?n/100*16:n/100*window.innerWidth;break;case"vw":s=n/100*window.innerWidth;break;case"vh":s=n/100*window.innerHeight;break;case"vmin":s=n/100*Math.min(window.innerWidth,window.innerHeight);break;case"vmax":s=n/100*Math.max(window.innerWidth,window.innerHeight);break;case"rem":i.style.fontSize="1rem",s=n*parseFloat(getComputedStyle(i).fontSize);break;case"em":i.style.fontSize="1em",s=n*parseFloat(getComputedStyle(i).fontSize);break;case"pt":s=1.333*n;break;case"pc":s=16*n;break;case"in":s=96*n;break;case"cm":s=37.8*n;break;case"mm":s=3.78*n;break;case"ex":i.style.height="1ex",s=n*parseFloat(getComputedStyle(i).height);break;case"ch":i.style.width="1ch",i.textContent="0",s=n*parseFloat(getComputedStyle(i).width);break;default:s=n||(e?14:300)}}catch(n){console.warn(`Cannot convert ${t} to pixels:`,n),s=e?14:300}finally{document.body.removeChild(i)}return Math.max(s,e?8:100)},f=y(h,!0),v=y(g),b=y(u),_=document.createElement("style");_.textContent=`\n@keyframes popupEntrance {\n  0% {\n    opacity: 0;\n    transform: translate(-50%, -50%) scale(0.8) rotateY(-15deg);\n  }\n  100% {\n    opacity: 1;\n    transform: translate(-50%, -50%) scale(1) rotateY(0deg);\n  }\n}\n@keyframes ripple {\n  to {\n    transform: scale(4);\n    opacity: 0;\n  }\n}\n@keyframes shimmer {\n  0% { background-position: -200% 0; }\n  100% { background-position: 200% 0; }\n}\n@keyframes float {\n  0%, 100% { transform: translateY(0px); }\n  50% { transform: translateY(-2px); }\n}\n.translator-popup {\n  backdrop-filter: blur(20px);\n  -webkit-backdrop-filter: blur(20px);\n  background: ${c?"linear-gradient(135deg, rgba(26,32,46,0.95) 0%, rgba(31,41,55,0.95) 50%, rgba(17,24,39,0.95) 100%)":"linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.95) 50%, rgba(241,245,249,0.95) 100%)"};\n  border: 1px solid ${c?"rgba(99,102,241,0.4)":"rgba(59,130,246,0.4)"};\n  box-shadow: ${c?"0 25px 60px rgba(0,0,0,0.6)":"0 25px 60px rgba(0,0,0,0.25)"}, inset 0 1px 0 ${c?"rgba(255,255,255,0.1)":"rgba(255,255,255,0.8)"};\n  animation: popupEntrance 0.4s cubic-bezier(0.34, 1.2, 0.64, 1);\n  font-size: ${h};\n  min-width: ${m?`max(${v}px, 700px)`:g};\n  max-width: ${m?`min(${b}px, 90vw)`:u};\n}\n.translator-content::-webkit-scrollbar {\n  width: 6px;\n}\n.translator-content::-webkit-scrollbar-track {\n  background: transparent;\n}\n.translator-content::-webkit-scrollbar-thumb {\n  background: ${c?"rgba(99,102,241,0.3)":"rgba(59,130,246,0.3)"};\n  border-radius: 3px;\n  transition: all 0.3s ease;\n}\n.translator-content::-webkit-scrollbar-thumb:hover {\n  background: ${c?"rgba(99,102,241,0.5)":"rgba(59,130,246,0.5)"};\n}\n.container-hover {\n  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n  position: relative;\n  overflow-x: hidden;\n  overflow-y: auto;\n}\n.container-hover::before {\n  content: '';\n  position: absolute;\n  top: 0;\n  left: -100%;\n  width: 100%;\n  height: 100%;\n  background: linear-gradient(90deg,\n    transparent,\n    ${c?"rgba(99,102,241,0.1)":"rgba(59,130,246,0.1)"},\n    transparent\n  );\n  transition: left 0.5s ease;\n}\n.container-hover:hover::before {\n  left: 100%;\n}\n.container-hover:hover {\n  transform: translateY(-3px);\n  box-shadow:\n    ${c?"0 15px 35px rgba(99,102,241,0.2)":"0 15px 35px rgba(59,130,246,0.2)"},\n    ${c?"0 5px 15px rgba(0,0,0,0.3)":"0 5px 15px rgba(0,0,0,0.1)"};\n  border-color: ${c?"rgba(99,102,241,0.4)":"rgba(59,130,246,0.4)"};\n}\n.drag-handle {\n  background: ${c?"linear-gradient(135deg, rgba(99,102,241,0.8) 0%, rgba(139,92,246,0.8) 100%)":"linear-gradient(135deg, rgba(59,130,246,0.9) 0%, rgba(99,102,241,0.9) 100%)"};\n  position: relative;\n  overflow: hidden;\n}\n.drag-handle::before {\n  content: '';\n  position: absolute;\n  top: 0;\n  left: -100%;\n  width: 100%;\n  height: 100%;\n  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);\n  animation: shimmer 3s infinite;\n}\n.glass-button {\n  backdrop-filter: blur(10px);\n  -webkit-backdrop-filter: blur(10px);\n  background: ${c?"rgba(255,255,255,0.1)":"rgba(255,255,255,0.2)"};\n  border: 1px solid ${c?"rgba(255,255,255,0.2)":"rgba(255,255,255,0.3)"};\n  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n  position: relative;\n  overflow: hidden;\n}\n.glass-button:hover {\n  background: ${c?"rgba(255,255,255,0.15)":"rgba(255,255,255,0.3)"};\n  transform: translateY(-1px);\n  box-shadow: 0 8px 25px ${c?"rgba(0,0,0,0.3)":"rgba(0,0,0,0.15)"};\n}\n.glass-button:active {\n  transform: translateY(0px);\n}\n.floating-icon {\n  animation: float 3s ease-in-out infinite;\n}\n.section-divider {\n  height: 1px;\n  background: ${c?"linear-gradient(90deg, transparent, rgba(99,102,241,0.5), transparent)":"linear-gradient(90deg, transparent, rgba(59,130,246,0.5), transparent)"};\n  margin: 16px 0;\n}\n/* Responsive design */\n@media (max-width: 768px) {\n  .translator-popup {\n    min-width: min(${v}px, 90vw) !important;\n    max-width: min(${b}px, 95vw) !important;\n    max-height: 90vh !important;\n  }\n}\n@media (max-width: 480px) {\n  .translator-popup {\n    min-width: min(${v}px, 95vw) !important;\n    max-width: min(${b}px, 98vw) !important;\n    font-size: max(${f-2}px, 12px) !important;\n  }\n}\n/* Parallel Layout Styles */\n.parallel-layout {\n  display: grid;\n  grid-template-columns: 1fr 1fr;\n  gap: 16px;\n  height: 100%;\n  position: relative;\n  max-height: calc(60vh - 40px);\n  padding-bottom: 8px;\n}\n.parallel-section {\n  height: 100%;\n  display: flex;\n  flex-direction: column;\n  min-height: 0;\n}\n.parallel-section:first-child { animation: slideInLeft 0.5s ease; }\n.parallel-section:last-child { animation: slideInRight 0.5s ease; }\n@keyframes slideInLeft {\n  0% { opacity: 0; transform: translateX(-30px); }\n  100% { opacity: 1; transform: translateX(0); }\n}\n@keyframes slideInRight {\n  0% { opacity: 0; transform: translateX(30px); }\n  100% { opacity: 1; transform: translateX(0); }\n}\n.vertical-divider {\n  position: absolute;\n  left: 50%;\n  top: 8px;\n  bottom: 8px;\n  width: 1px;\n  background: ${c?"linear-gradient(180deg, transparent, rgba(99,102,241,0.5), transparent)":"linear-gradient(180deg, transparent, rgba(59,130,246,0.5), transparent)"};\n  transform: translateX(-50%);\n  z-index: 1;\n}\n.parallel-content {\n  flex: 1;\n  overflow-x: hidden;\n  overflow-y: auto;\n  padding-right: 8px;\n  padding-bottom: 16px;\n  min-height: 0;\n  max-height: calc(50vh - 60px);\n}\n.translator-content {\n  padding-bottom: 20px !important;\n  margin-bottom: 4px;\n}\n.vertical-layout {\n  display: flex;\n  flex-direction: column;\n  gap: 20px;\n}\n`,this.shadowRoot.appendChild(_);const x=document.createElement("div");x.className="draggable translator-popup",Object.assign(x.style,{position:"fixed",borderRadius:"20px",minWidth:m?`max(${g}, 700px)`:g,maxWidth:m?`min(${u}, 90vw)`:u,fontSize:h,padding:"0",overflow:"hidden",display:"flex",flexDirection:"column",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:2147483647,userSelect:"text"});const S=()=>{const t=window.innerWidth,e=window.innerHeight,n=y(g),a=y(u),i=y(h,!0);if(m){const i=Math.max(n,700),s=Math.min(a,.9*t);x.style.minWidth=Math.min(i,.9*t)+"px",x.style.maxWidth=s+"px",x.style.maxHeight=t<=1024?Math.min(.8*e,700)+"px":Math.min(.75*e,650)+"px"}else t<=768?(x.style.minWidth=Math.min(n,.9*t)+"px",x.style.maxWidth=Math.min(a,.95*t)+"px",t<=480&&(x.style.fontSize=Math.max(i-2,12)+"px")):(x.style.minWidth=g,x.style.maxWidth=u,x.style.fontSize=h),x.style.maxHeight=Math.min(.9*e,800)+"px"};S();const w=()=>S();window.addEventListener("resize",w);const T=document.createElement("div");T.className="drag-handle",Object.assign(T.style,{color:"#ffffff",padding:"20px 24px",borderTopLeftRadius:"19px",borderTopRightRadius:"19px",display:"flex",alignItems:"center",justifyContent:"space-between",cursor:"move",userSelect:"none",minHeight:"60px"});const k=document.createElement("span"),E=a('\n<svg width="18" height="18" style="margin-right: 8px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/>\n</svg>'),C=document.createElement("span");C.style.cssText=`font-size: calc(${h} + 2px); font-weight: 600; letter-spacing: 0.5px;`,C.textContent=n,k.appendChild(E),k.appendChild(C),Object.assign(k.style,{display:"flex",alignItems:"center"});const A=document.createElement("button");m&&(A.className="glass-button",A.innerHTML='\n<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n  <rect x="3" y="3" width="7" height="18"/>\n  <rect x="14" y="3" width="7" height="18"/>\n</svg>\n',Object.assign(A.style,{border:"none",color:"#fff",cursor:"pointer",borderRadius:"8px",width:"36px",height:"36px",display:"flex",alignItems:"center",justifyContent:"center",marginRight:"10px"}),A.title=this._("notifications.switch_layout"),this.addRippleEffect(A));const L=document.createElement("button");L.className="glass-button",L.innerHTML='\n<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n  <line x1="18" y1="6" x2="6" y2="18"></line>\n  <line x1="6" y1="6" x2="18" y2="18"></line>\n</svg>\n',Object.assign(L.style,{border:"none",color:"#fff",cursor:"pointer",borderRadius:"12px",width:"40px",height:"40px",display:"flex",alignItems:"center",justifyContent:"center"}),L.title=this._("notifications.close_popup"),this.addRippleEffect(L);const M=document.createElement("div");M.style.display="flex",M.style.alignItems="center",m&&M.appendChild(A),M.appendChild(L),T.appendChild(k),T.appendChild(M);const N=document.createElement("div");N.className="translator-content",Object.assign(N.style,{padding:m?"16px":"24px",maxHeight:m?"calc(75vh - 120px)":"calc(90vh - 120px)",overflowX:"hidden",overflowY:"auto",fontSize:h,position:"relative",paddingBottom:m?"20px":"24px"});const $=document.createElement("div");Object.assign($.style,{display:"flex",flexDirection:"column",gap:"20px"});const O=(t,e,n,a=null)=>{const i=document.createElement("div");i.className="container-hover",Object.assign(i.style,{background:c?"linear-gradient(135deg, rgba(30,41,59,0.4) 0%, rgba(51,65,85,0.4) 100%)":"linear-gradient(135deg, rgba(248,250,252,0.6) 0%, rgba(255,255,255,0.6) 100%)",borderRadius:"16px",padding:"20px",border:"1px solid "+(c?"rgba(75,85,99,0.3)":"rgba(229,231,235,0.6)"),position:"relative",backdropFilter:"blur(10px)"});const s=document.createElement("div");Object.assign(s.style,{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"16px"});const o=document.createElement("div");o.innerHTML=`${n}<span style="margin-left: 8px; font-weight: 600; font-size: calc(${h} + 1px);">${t}</span>`,Object.assign(o.style,{color:l.title,display:"flex",alignItems:"center"});const r=document.createElement("div");Object.assign(r.style,{display:"flex",gap:"10px",alignItems:"center"});const d=this.createTTSButton(l,c,e,a),p=this.createCopyButton(l,c,e,h);d&&r.appendChild(d),r.appendChild(p),s.appendChild(o),s.appendChild(r);const g=document.createElement("div");Object.assign(g.style,{lineHeight:"1.7",color:l.text,fontSize:h,whiteSpace:"pre-wrap",wordBreak:"break-word"});const u=t===this._("notifications.translation_label")?e.replace(/(\*\*)(.*?)\1/g,`<span style="color: ${c?"#60A5FA":"#2563EB"}; font-weight: 600; background: ${c?"rgba(96,165,250,0.1)":"rgba(37,99,235,0.1)"}; padding: 2px 6px; border-radius: 6px;">$2</span>`):e;g.innerHTML=this.formatTranslation(u,l,c,h),i.appendChild(s);const m=document.createElement("div");return m.className="section-divider",i.appendChild(m),i.appendChild(g),{container:i}},P=(t,e,n,a=null)=>{const i=document.createElement("div");i.className="container-hover parallel-section",Object.assign(i.style,{background:c?"linear-gradient(135deg, rgba(30,41,59,0.4) 0%, rgba(51,65,85,0.4) 100%)":"linear-gradient(135deg, rgba(248,250,252,0.6) 0%, rgba(255,255,255,0.6) 100%)",borderRadius:"12px",padding:"12px",paddingBottom:"5px",border:"1px solid "+(c?"rgba(75,85,99,0.3)":"rgba(229,231,235,0.6)"),position:"relative",backdropFilter:"blur(10px)",height:"100%",minHeight:"0",marginBottom:"4px"});const s=document.createElement("div");Object.assign(s.style,{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"8px",flexShrink:"0"});const o=document.createElement("div");o.innerHTML=`${n}<span style="margin-left: 8px; font-weight: 600; font-size: calc(${h} + 1px);">${t}</span>`,Object.assign(o.style,{color:l.title,display:"flex",alignItems:"center"});const r=document.createElement("div");Object.assign(r.style,{display:"flex",gap:"8px",alignItems:"center"});const d=this.createTTSButton(l,c,e,a),p=this.createCopyButton(l,c,e,h);d&&r.appendChild(d),r.appendChild(p),s.appendChild(o),s.appendChild(r);const g=document.createElement("div");g.className="parallel-content",Object.assign(g.style,{lineHeight:"1.6",color:l.text,fontSize:h,whiteSpace:"pre-wrap",wordBreak:"break-word",flex:"1",overflowX:"hidden",overflowY:"auto",paddingRight:"8px"});const u=t===this._("notifications.translation_label")?e.replace(/(\*\*)(.*?)\1/g,`<span style="color: ${c?"#60A5FA":"#2563EB"}; font-weight: 600; background: ${c?"rgba(96,165,250,0.1)":"rgba(37,99,235,0.1)"}; padding: 2px 6px; border-radius: 6px;">$2</span>`):e;g.innerHTML=this.formatTranslation(u,l,c,h),i.appendChild(s);const m=document.createElement("div");return m.className="section-divider",i.appendChild(m),i.appendChild(g),i},I=()=>{const n=document.createElement("div");n.className="parallel-layout";const a=document.createElement("div");a.className="vertical-divider",n.appendChild(a);const i=P(this._("notifications.original_label"),e,'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>',p),s=P(this._("notifications.translation_label"),t,'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>',d.targetLanguage);return n.appendChild(i),n.appendChild(s),n},R=()=>{const n=document.createElement("div");if(Object.assign(n.style,{display:"flex",flexDirection:"column",gap:"20px"}),m||"language_learning"===d.translationMode&&!0===d.languageLearning.showSource){const{container:t}=O(this._("notifications.original_label"),e,'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>\n            </svg>',p);n.appendChild(t)}if("language_learning"===d.translationMode&&i){const{container:t}=O(this._("notifications.ipa_label"),i,'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>\n            </svg>',p);n.appendChild(t)}const{container:a}=O(this._("notifications.translation_label"),t,'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/>\n          </svg>',d.targetLanguage);return n.appendChild(a),n};if(m){let t=window.innerWidth<=1024?"vertical":"parallel";const e=()=>{"parallel"===t?(A.innerHTML='\n<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n  <rect x="3" y="3" width="7" height="18"/>\n  <rect x="14" y="3" width="7" height="18"/>\n</svg>\n',A.title=this._("notifications.switch_layout_ver")):(A.innerHTML='\n<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n  <rect x="3" y="3" width="18" height="7"/>\n  <rect x="3" y="14" width="18" height="7"/>\n</svg>\n',A.title=this._("notifications.switch_layout_hor"))};e();const n=()=>{for(;N.firstChild;)N.removeChild(N.firstChild);Object.assign(N.style,{padding:"parallel"===t?"16px":"24px",maxHeight:"calc(75vh - 120px)",overflowY:"auto",overflowX:"hidden",fontSize:h,position:"relative",paddingBottom:"parallel"===t?"20px":"24px"})},a=()=>{n(),requestAnimationFrame(()=>{"vertical"===t?N.appendChild(R()):N.appendChild(I()),e(),S()})};A.onclick=e=>{e.preventDefault(),e.stopPropagation(),A.disabled=!0,A.style.opacity="0.6",t="parallel"===t?"vertical":"parallel",a(),setTimeout(()=>{A.disabled=!1,A.style.opacity="1"},300)}}N.appendChild((()=>{const t=window.innerWidth;return m?t<=1024?R():I():R()})()),x.appendChild(T),x.appendChild(N),this.shadowRoot.appendChild(x);const F=()=>{speechSynthesis.cancel(),this.voiceStorage={},this.selectSource=null,this.selectVoice=null,window.removeEventListener("resize",w),document.removeEventListener("keydown",D),document.removeEventListener("click",B),x.style.opacity="0",x.style.display="none",x.style.transform="translate(-50%, -50%) scale(0.8)",x.style.animation="popupEntrance 0.3s cubic-bezier(0.4, 0, 0.6, 1) reverse",setTimeout(()=>x.remove(),300)};L.onclick=F,this.makeDraggable(x,T),x.addEventListener("click",t=>t.stopPropagation());const B=t=>{x&&!x.contains(t.target)&&F()};document.addEventListener("click",B);const D=t=>{"Escape"===t.key&&F()};document.removeEventListener("keydown",D),document.addEventListener("keydown",D)}async playTTS(t,e,n,a,i=null,s=!1,o=null){if(this.isTTSSpeaking)this.stopTTS();else{this.isTTSSpeaking=!0,i&&this.updateButtonState(i,s),o&&this.onSpeechEndCallback(o);try{const r=this.selectSource;if("local"===r)return void(this.currentTTSAudio=await this.playLocalTTS(t,e,a,i,s,o));const l=this.translator.userSettings.settings.cacheOptions.tts.enabled,c=`${a.speedValue}-${a.pitchValue}-${a.volumeValue}`,d=`${r}_${e||n}_${c}_${t}`;let p=null;if(l){const t=await this.translator.ttsCache.get(d);t&&(console.log("TTS found in persistent cache."),p=f.base64ToArrayBuffer(t))}if(!p){console.log("TTS not in cache, fetching from API.");const i={google_translate:()=>this.fetchGoogleTranslateTTS(t,n),google:()=>this.fetchGoogleTTS(t,e,n,a),gemini:()=>this.fetchGeminiTTS(t,e),openai:()=>this.fetchOpenAITTS(t,e,a)};if(!i[r])throw new Error(`TTS provider "${r}" is not supported for caching.`);if(p=await i[r](),!p)throw new Error("Received no audio data from the API.");if(l){const t=f.arrayBufferToBase64(p);await this.translator.ttsCache.set(d,t)}}this.currentTTSAudio=await this.playAudio(p,a.volumeValue,i,s,o)}catch(t){console.error("TTS Playback Error:",t),this.showNotification(this._("notifications.tts_playback_error")+": "+t.message,"error"),this.isTTSSpeaking=!1,i&&this.updateButtonState(i,s),o&&this.onSpeechEndCallback(o)}}}stopTTS(){this.currentTTSAudio&&(this.currentTTSAudio?.stop&&this.currentTTSAudio.stop(),this.currentTTSAudio?.disconnect&&this.currentTTSAudio.disconnect(),this.currentTTSAudio?.pause&&this.currentTTSAudio.pause(),this.isTTSSpeaking=!1,this.currentTTSAudio=null),speechSynthesis.cancel()}updateButtonState(t,e){t.innerHTML=this.isTTSSpeaking?'<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16" rx="1"/><rect x="14" y="4" width="4" height="16" rx="1"/></svg>':'<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>',t.title=this.isTTSSpeaking?this._("notifications.stop_tts"):this._("notifications.play_tts"),t.style.backgroundColor=this.isTTSSpeaking?e?"rgba(255,255,255,0.2)":"rgba(0,0,0,0.2)":"transparent"}async playLocalTTS(t,e,n,a,i,s){return new Promise((o,r)=>{if(!window.speechSynthesis)return void r(new Error(this._("notifications.browser_tts_not_supported")));speechSynthesis.cancel();const l=new SpeechSynthesisUtterance(t),c=speechSynthesis.getVoices().find(t=>t.name===e);c&&(l.voice=c),l.rate=parseFloat(n.speedValue),l.pitch=parseFloat(n.pitchValue),l.volume=parseFloat(n.volumeValue),l.onend=()=>{this.isTTSSpeaking=!1,a&&this.updateButtonState(a,i),s&&this.onSpeechEndCallback(s),o()},l.onerror=t=>{console.error("TTS Error:",t),this.isTTSSpeaking=!1,a&&this.updateButtonState(a,i),s&&this.onSpeechEndCallback(s),r(new Error(this._("notifications.tts_playback_error")))},speechSynthesis.speak(l)})}createWavBlob(t,e){const n=2*e,a=t.byteLength,i=36+a,s=new ArrayBuffer(44+a),o=new DataView(s);o.setUint32(0,1380533830,!1),o.setUint32(4,i,!0),o.setUint32(8,1463899717,!1),o.setUint32(12,1718449184,!1),o.setUint32(16,16,!0),o.setUint16(20,1,!0),o.setUint16(22,1,!0),o.setUint32(24,e,!0),o.setUint32(28,n,!0),o.setUint16(32,2,!0),o.setUint16(34,16,!0),o.setUint32(36,1684108385,!1),o.setUint32(40,a,!0);const r=new Uint8Array(t),l=new Uint8Array(s);return l.set(r,44),new Blob([l],{type:"audio/wav"})}async playAudio(t,e,n,a,i){try{const s=new(window.AudioContext||window.webkitAudioContext),o=await s.decodeAudioData(t),r=s.createBufferSource();r.buffer=o;const l=s.createGain();return l.gain.value=parseFloat(e),r.connect(l),l.connect(s.destination),r.onended=()=>{this.isTTSSpeaking=!1,n&&this.updateButtonState(n,a),i&&this.onSpeechEndCallback(i),s.close()},r.start(0),r}catch(t){throw console.error("Audio playback error:",t),t}}async fetchGoogleTranslateTTS(t,e){try{const n=t.match(/.{1,200}(?:\s|$)/g)||[],a=[];for(const t of n){const n=await new Promise((n,a)=>{GM_xmlhttpRequest({method:"GET",url:`https://translate.google.com/translate_tts?ie=UTF-8&tl=${e}&client=tw-ob&q=${encodeURIComponent(t)}`,responseType:"arraybuffer",headers:{Referer:"https://translate.google.com/","User-Agent":"Mozilla/5.0"},onload:t=>200===t.status?n(t.response):a(new Error(`Google Translate TTS error: ${t.status}`)),onerror:a})});a.push(n),await new Promise(t=>setTimeout(t,50))}const i=a.reduce((t,e)=>t+e.byteLength,0),s=new ArrayBuffer(i),o=new Uint8Array(s);let r=0;for(const t of a)o.set(new Uint8Array(t),r),r+=t.byteLength;return s}catch(t){throw console.error("Google Translate TTS fetch error:",t),t}}async fetchGoogleTTS(t,e,n,a){try{const i=t.match(/.{1,200}(?:\s|$)/g)||[],s=[];for(const t of i){const i=await new Promise((i,s)=>{GM_xmlhttpRequest({method:"POST",url:"https://texttospeech.googleapis.com/v1beta1/text:synthesize?key=AIzaSyBOti4mM-6x9WDnZIjIeyEU21OpBXqWBgw",headers:{"Content-Type":"application/json"},data:JSON.stringify({audioConfig:{audioEncoding:"MP3",pitch:parseFloat(a.pitchValue)-1,speakingRate:parseFloat(a.speedValue)},input:{text:t},voice:{languageCode:n,name:e}}),responseType:"json",onload:t=>200===t.status?i(t.response?.audioContent):s(new Error(`Google TTS API error: ${t.status}`)),onerror:s})});if(i){const t=atob(i),e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=t.charCodeAt(n);s.push(e.buffer)}}if(0===s.length)throw new Error("No audio data received from Google TTS.");const o=s.reduce((t,e)=>t+e.byteLength,0),r=new ArrayBuffer(o),l=new Uint8Array(r);let c=0;for(const t of s)l.set(new Uint8Array(t),c),c+=t.byteLength;return r}catch(t){throw console.error("Google TTS fetch error:",t),t}}async fetchGeminiTTS(t,e){try{const n=this.settings.apiKey.gemini;if(!n||!n[0])throw new Error(this._("notifications.no_api_key_configured")+" for Gemini.");const a=n[Math.floor(Math.random()*n.length)],i=this.settings.ttsOptions.defaultGeminiModel,s={contents:[{parts:[{text:t}]}],generationConfig:{responseModalities:["AUDIO"],speechConfig:{voiceConfig:{prebuiltVoiceConfig:{voiceName:e}}}},model:i},o=await new Promise((t,e)=>{GM_xmlhttpRequest({method:"POST",url:`https://generativelanguage.googleapis.com/v1beta/models/${i}:generateContent?key=${a}`,headers:{"Content-Type":"application/json"},data:JSON.stringify(s),responseType:"json",onload:n=>{n.status>=200&&n.status<300?t(n.response):e(new Error(`Request failed with status ${n.status}: ${n.statusText||n.responseText}`))},onerror:t=>e(t),ontimeout:()=>e(new Error("Request timed out."))})}),r=o?.candidates?.[0]?.content?.parts?.[0],l=r?.inlineData?.data;if(!l)throw new Error(r?.text||"Invalid response structure from Gemini TTS.");const c=atob(l),d=new Uint8Array(c.length);for(let t=0;t<c.length;t++)d[t]=c.charCodeAt(t);const p=r.inlineData.mimeType||"audio/L16;codec=pcm;rate=24000",h=parseInt(p.match(/rate=(\d+)/)?.[1]||"24000",10),g=this.createWavBlob(d.buffer,h);return await g.arrayBuffer()}catch(t){throw console.error("Gemini TTS fetch error:",t),t}}async fetchOpenAITTS(t,e,n){try{const a=this.settings.apiKey.openai,i=a[Math.floor(Math.random()*a.length)],s=this.settings.ttsOptions.defaultModel;return await new Promise((a,o)=>{GM_xmlhttpRequest({method:"POST",url:"https://api.openai.com/v1/audio/speech",headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"},data:JSON.stringify({model:s,input:t,voice:e,speed:parseFloat(n.speedValue),response_format:"wav"}),responseType:"arraybuffer",onload:t=>200===t.status?a(t.response):o(new Error(`Request failed with status ${t.status}`)),onerror:t=>o(t)})})}catch(t){throw console.error("OpenAI TTS fetch error:",t),t}}createTTSButton(t,e,n,a){if(!this.settings.ttsOptions?.enabled)return null;const i=document.createElement("div");Object.assign(i.style,{position:"relative",display:"inline-flex",alignItems:"center",gap:"2px"});const s=document.createElement("button");Object.assign(s.style,{background:"none",border:"none",padding:"8px",cursor:"pointer",color:t.text,opacity:"0",visibility:"hidden",borderRadius:"50%",transition:"all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1)",display:"flex",alignItems:"center",justifyContent:"center",transform:"scale(0.8)",marginRight:"-8px"}),s.innerHTML='\n<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n  <path d="M12 15a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>\n  <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>\n</svg>\n',s.title=this._("notifications.tts_settings");const r=document.createElement("button");Object.assign(r.style,{background:"none",border:"none",padding:"8px",cursor:"pointer",color:t.text,opacity:"0.7",borderRadius:"50%",transition:"all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1)",display:"flex",alignItems:"center",justifyContent:"center"});const l=document.createElement("div");Object.assign(l.style,{position:"absolute",top:"100%",right:"0",background:t.background,padding:"12px",borderRadius:"8px",boxShadow:"0 2px 10px rgba(0,0,0,0.2)",display:"none",gap:"10px",flexDirection:"column",zIndex:"2147483648",marginTop:"8px",border:`1px solid ${t.border}`,minWidth:"250px",fontSize:"13px"});const c=document.createElement("div");c.textContent=this._("settings.tts_source"),c.style.color=t.text,c.style.marginBottom="4px";const d=document.createElement("select");Object.assign(d.style,{width:"100%",padding:"6px",borderRadius:"4px",border:`1px solid ${t.border}`,background:e?"#444":"#fff",color:t.text,marginTop:"4px"}),this.selectSource=this.settings.ttsOptions?.defaultProvider||"google","openai"===this.selectSource?(this.selectVoice=this.settings.ttsOptions?.defaultVoice?.[this.selectSource]?.voice||"sage",this.selectVoice={name:this.selectVoice}):"google"===this.selectSource?this.selectVoice=this.settings.ttsOptions?.defaultVoice?.[this.selectSource]?.[a]||null:this.selectVoice=null,this.voiceStorage[this.selectSource]={voice:this.selectVoice},[{value:"google",text:"Google Cloud TTS"},{value:"google_translate",text:"Google Translate TTS"},{value:"gemini",text:"Gemini AI TTS"},{value:"openai",text:"OpenAI TTS"},{value:"local",text:this._("notifications.device_tts")}].forEach(t=>{const e=document.createElement("option");e.value=t.value,e.text=t.text,e.selected=this.selectSource===t.value,d.appendChild(e)});const p=document.createElement("div");p.textContent=this._("settings.voice"),p.style.color=t.text,p.style.marginBottom="4px",p.style.marginTop="8px";const h=document.createElement("select");Object.assign(h.style,{width:"100%",padding:"6px",borderRadius:"4px",border:`1px solid ${t.border}`,background:e?"#444":"#fff",color:t.text,marginTop:"4px"});const g=async(t,e=!1)=>{switch(h.innerHTML="",t){case"local":0===speechSynthesis.getVoices().length&&await new Promise(t=>{speechSynthesis.onvoiceschanged=t}),v(a).forEach(t=>{const e=document.createElement("option");e.value=JSON.stringify({name:t.name,provider:"local"}),e.text=t.display,this.voiceStorage[this.selectSource]?.voice?(e.selected=this.voiceStorage[this.selectSource].voice.name===t.name,h.appendChild(e)):h.appendChild(e)});break;case"gemini":o.TTS.GEMINI.VOICES.forEach(t=>{const e=document.createElement("option");e.value=JSON.stringify({name:t,provider:"gemini"}),e.text=t,this.voiceStorage[this.selectSource]?.voice&&(e.selected=this.voiceStorage[this.selectSource].voice.name===t),h.appendChild(e)});break;case"openai":o.TTS.OPENAI.VOICES.forEach(t=>{const e=document.createElement("option");e.value=JSON.stringify({name:t,provider:"openai"}),e.text=t,this.voiceStorage[this.selectSource]?.voice?(e.selected=this.voiceStorage[this.selectSource].voice.name===t,h.appendChild(e)):h.appendChild(e)});break;case"google":const t=()=>{o.TTS.GOOGLE.VOICES?.[a].forEach(t=>{const e=document.createElement("option");e.value=JSON.stringify({name:t.name,provider:"google"}),e.text=t.display,this.voiceStorage[this.selectSource]?.voice?(e.selected=this.voiceStorage[this.selectSource].voice.name===t.name,h.appendChild(e)):h.appendChild(e)})};if(this.selectVoice)if(e)t();else{const t=document.createElement("option");t.value=JSON.stringify({name:this.selectVoice.name,provider:"google"}),t.text=this.selectVoice.display,h.appendChild(t)}else t();break;case"google_translate":if(o.LANGUAGEDISPLAY[a]){const t=o.LANGUAGEDISPLAY[a],e=document.createElement("option");e.value=JSON.stringify({name:t.name,provider:"google_translate"}),e.text=t.display,h.appendChild(e)}}if(!h.options.length){const t=document.createElement("option");t.value="",t.text=this._("notifications.tts_lang_no_voice")+` ${a}`,t.disabled=!0,h.appendChild(t)}},u=(n,a,i,s,o)=>{const r=document.createElement("div");r.style.width="100%",r.innerHTML=`\n<div style="color:${t.text};margin-bottom:4px">${n}</div>\n<div style="display:flex;align-items:center;gap:8px">\n  <input type="range" min="${a}" max="${i}" value="${s}" step="${o}"\n    style="flex:1;height:4px;-webkit-appearance:none;background:${e?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)"};\n      border-radius:2px;outline:none"/>\n  <span style="color:${t.text};min-width:36px;text-align:right">${s}</span>\n</div>\n`;const l=r.querySelector("input"),c=r.querySelector("span");return l.oninput=()=>c.textContent=l.value,{container:r,input:l}},m=u(this._("settings.speed"),.1,2,this.settings.ttsOptions.defaultSpeed,.1),y=u(this._("settings.volume"),0,1,this.settings.ttsOptions.defaultVolume,.1),f=u(this._("settings.pitch"),0,2,this.settings.ttsOptions.defaultPitch,.1),v=t=>window.speechSynthesis.getVoices().filter(e=>e.lang.toLowerCase().includes(t.toLowerCase())).map(t=>({name:t.name,display:`${t.name} (${t.lang})`}));let b;const _=()=>{clearTimeout(b),s.style.opacity="1",s.style.visibility="visible",s.style.transform="scale(1)"},x=()=>{"flex"!==l.style.display&&(b=setTimeout(()=>{s.style.opacity="0",s.style.visibility="hidden",s.style.transform="scale(0.8)"},150))};let S;i.addEventListener("mouseenter",_),i.addEventListener("mouseleave",x),i.addEventListener("touchstart",()=>{S=setTimeout(_,300)}),i.addEventListener("touchend",()=>{clearTimeout(S),x()}),i.addEventListener("touchcancel",()=>{clearTimeout(S),x()});let w=!1;const T=()=>{g(this.selectSource,!0),l.style.display="flex",w=!0,_()},k=()=>{l.style.display="none",w=!1,i.matches(":hover")||x()};let E,C,A;return s.addEventListener("click",t=>{t.stopPropagation(),w?k():T()}),s.addEventListener("touchend",t=>{t.preventDefault(),t.stopPropagation(),w?k():T()}),document.addEventListener("click",t=>{!w||l.contains(t.target)||s.contains(t.target)||k()}),r.onclick=async()=>{E=m.input.value,C=y.input.value,A=f.input.value,this.selectVoice=this.voiceStorage[this.selectSource]?.voice||JSON.parse(h.value),this.playTTS(n,this.selectVoice.name,a,{speedValue:E,volumeValue:C,pitchValue:A},r,e),setTimeout(this.updateButtonState(r,e),50)},d.addEventListener("change",()=>{this.selectSource=d.value,g(this.selectSource,!0),this.selectVoice=JSON.parse(h.value),this.voiceStorage[this.selectSource]={voice:this.selectVoice}}),h.addEventListener("change",async()=>{E=m.input.value,C=y.input.value,A=f.input.value,this.selectVoice=JSON.parse(h.value),this.voiceStorage[this.selectSource]={voice:this.selectVoice},this.playTTS(n,this.selectVoice.name,a,{speedValue:E,volumeValue:C,pitchValue:A},r,e),setTimeout(this.updateButtonState(r,e),50)}),g(this.selectSource),this.updateButtonState(r,e),i.appendChild(s),i.appendChild(r),i.appendChild(l),l.appendChild(c),l.appendChild(d),l.appendChild(p),l.appendChild(h),l.appendChild(m.container),l.appendChild(y.container),l.appendChild(f.container),i}createCopyButton(t,e,n,i){function s(t){if(o.innerHTML="",t){const t=a('\n<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#4CAF50" stroke-width="2">\n  <path d="M20 6L9 17l-5-5"/>\n</svg>'),e=document.createElement("span");e.style.cssText="margin-left: 6px; color: #4CAF50;",e.textContent="Copied!",o.appendChild(t),o.appendChild(e)}else{const t=a('\n<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n  <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>\n  <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>\n</svg>');o.appendChild(t)}}const o=document.createElement("button");return Object.assign(o.style,{display:"flex",alignItems:"center",padding:"8px 12px",border:"none",borderRadius:"8px",backgroundColor:e?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)",color:t.text,cursor:"pointer",transition:"all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1)",fontSize:`calc(${i} - 1px)`}),s(!1),o.onmouseover=()=>{o.style.backgroundColor=e?"rgba(255,255,255,0.2)":"rgba(0,0,0,0.2)",o.style.transform="translateY(-1px)"},o.onmouseout=()=>{o.style.backgroundColor=e?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)",o.style.transform="translateY(0)"},o.onclick=async()=>{try{await navigator.clipboard.writeText(n),s(!0),o.style.backgroundColor=e?"rgba(76,175,80,0.2)":"rgba(76,175,80,0.1)",setTimeout(()=>{s(!1),o.style.backgroundColor=e?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)"},2e3)}catch(t){console.error("Failed to copy:",t)}},this.addRippleEffect(o),o}addRippleEffect(t){t.style.position="relative",t.style.overflow="hidden",t.addEventListener("click",e=>{const n=document.createElement("div"),a=t.getBoundingClientRect(),i=Math.max(t.offsetWidth,t.offsetHeight);n.style.cssText=`\nposition: absolute;\nbackground: rgba(255,255,255,0.3);\nborder-radius: 50%;\npointer-events: none;\nwidth: ${i}px;\nheight: ${i}px;\ntop: ${e.clientY-a.top-i/2}px;\nleft: ${e.clientX-a.left-i/2}px;\nanimation: ripple 0.6s ease-out;\ntransform: scale(0);\n`,t.appendChild(n),setTimeout(()=>n.remove(),600)})}formatTranslation(t,e,n,a){return t.split("<br>").map((t,i)=>t.startsWith(`<b style="color: ${e.text};">KEYWORD</b>:`)?`<div style="\nmargin: 12px 0 8px 0;\ncolor: ${e.text};\nfont-weight: 600;\nfont-size: calc(${a} + 1px);\npadding: 8px 12px;\nbackground: ${n?"rgba(99,102,241,0.1)":"rgba(59,130,246,0.1)"};\nborder-left: 3px solid ${n?"#6366F1":"#3B82F6"};\nborder-radius: 0 8px 8px 0;\n">${t}</div>`:`<p style="\n  margin-bottom: ${0===i?"8px":"12px"};\n  white-space: pre-wrap;\n  word-wrap: break-word;\n  text-align: justify;\n  color: ${e.text};\n  line-height: 1.6;\n  text-indent: ${t.length>50?"1em":"0"};\n">${t}</p>`).join("")}makeDraggable(t,e){function n(e){e.preventDefault(),i=o-e.clientX,s=r-e.clientY,o=e.clientX,r=e.clientY,t.style.top=t.offsetTop-s+"px",t.style.left=t.offsetLeft-i+"px"}function a(){document.onmouseup=null,document.onmousemove=null}let i=0,s=0,o=0,r=0;e.onmousedown=function(t){t.preventDefault(),o=t.clientX,r=t.clientY,document.onmouseup=a,document.onmousemove=n}}setupSelectionHandlers(){this._selectionMousedownHandler&&(document.removeEventListener("mousedown",this._selectionMousedownHandler),document.removeEventListener("mousemove",this._selectionMousemoveHandler),document.removeEventListener("mouseup",this._selectionMouseupHandler),document.removeEventListener("touchend",this._selectionTouchendHandler)),this.translationButtonEnabled&&(this._selectionMousedownHandler=t=>{t.target.classList.contains("translator-button")||(this.isSelecting=!0,this.removeTranslateButton())},this._selectionMousemoveHandler=t=>{if(this.isSelecting){const e=window.getSelection();e.toString().trim()&&(this.removeTranslateButton(),this.debouncedCreateButton(e,t.clientX,t.clientY))}},this._selectionMouseupHandler=t=>{if(!t.target.classList.contains("translator-button")){const e=window.getSelection();e.toString().trim()&&(this.removeTranslateButton(),this.createTranslateButton(e,t.clientX,t.clientY))}this.isSelecting=!1},this._selectionTouchendHandler=t=>{if(!t.target.classList.contains("translator-button")){const e=window.getSelection();if(e.toString().trim()&&t.changedTouches?.[0]){const n=t.changedTouches[0];this.createTranslateButton(e,n.clientX,n.clientY)}}},document.addEventListener("mousedown",this._selectionMousedownHandler),document.addEventListener("mousemove",this._selectionMousemoveHandler),document.addEventListener("mouseup",this._selectionMouseupHandler),document.addEventListener("touchend",this._selectionTouchendHandler))}createTranslateButton(t,e,n){this.removeTranslateButton();const a=document.createElement("button");a.className="translator-button",a.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">\n  <path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/>\n</svg>';const i=window.innerWidth,s=window.innerHeight;let r=Math.min(e+10,i-60-10),l=Math.min(n+30,s-30-30);r=Math.max(10,r),l=Math.max(30,l);const c=this.settings.theme,d=o.THEME[c];Object.assign(a.style,{...o.STYLES.button,backgroundColor:d.button.translate.background,color:d.button.translate.text,position:"fixed",left:`${r}px`,top:`${l}px`,zIndex:"2147483647",userSelect:"none"}),this.shadowRoot.appendChild(a),this.currentTranslateButton=a,this.setupClickHandlers(t)}handleTranslateButtonClick=async(t,e)=>{try{const n=t.toString().trim();if(!n)return void this.showNotification(this._("notifications.no_text_selected"));const a=t.anchorNode?.parentElement;if(!a)return void this.showNotification(this._("notifications.no_target_element"));if(this.removeTranslateButton(),this.showTranslatingStatus(),!this.translator)throw new Error(this._("notifications.translator_instance_not_found"));switch(e){case"quick":await this.translator.translate(n,a);break;case"popup":await this.translator.translate(n,a,!1,!0);break;case"advanced":await this.translator.translate(n,a,!0);break;default:console.log("Unknown translation type:",e)}}catch(t){console.error("Translation error:",t)}finally{if(!this.isDouble)return void this.resetState();window.getSelection().toString().trim()&&(this.resetState(),this.setupSelectionHandlers())}};showTranslatingStatus(){if(!this.shadowRoot.querySelector("#translator-animation-style")){const t=document.createElement("style");t.id="translator-animation-style",t.textContent=`\n@keyframes spin {\n  0% { transform: rotate(0deg); }\n  100% { transform: rotate(360deg); }\n}\n.center-translate-status {\n  position: fixed;\n  top: ${window.innerHeight/2}px;\n  left: ${window.innerWidth/2}px;\n  transform: translate(-50%, -50%);\n  background-color: rgba(0, 0, 0, 0.8);\n  color: white;\n  padding: 15px 25px;\n  border-radius: 8px;\n  z-index: 2147483647;\n  display: flex;\n  align-items: center;\n  gap: 12px;\n  font-family: "GoMono Nerd Font", "Noto Sans", Arial;\n  font-size: 14px;\n  box-shadow: 0 2px 8px rgba(0,0,0,0.2);\n}\n.spinner {\n  display: inline-block;\n  width: 20px;\n  height: 20px;\n  border: 3px solid rgba(255,255,255,0.3);\n  border-radius: 50%;\n  border-top-color: #ddd;\n  animation: spin 1s ease-in-out infinite;\n}\n`,this.shadowRoot.appendChild(t)}this.removeTranslatingStatus();const t=document.createElement("div");t.className="center-translate-status",t.innerHTML=`\n<div class="spinner" style="color: white"></div>\n<span style="color: white">${this._("notifications.translating")}</span>\n`,this.shadowRoot.appendChild(t),this.translatingStatus=t}setupClickHandlers(t){this.pressTimer=null,this.isLongPress=!1,this.isDown=!1,this.isDouble=!1,this.lastTime=0,this.count=0,this.timer=0;const e=e=>{e.preventDefault(),e.stopPropagation(),this.ignoreNextSelectionChange=!0,this.isDown=!0,this.isLongPress=!1;const n=Date.now();n-this.lastTime<400?(this.count++,clearTimeout(this.pressTimer),clearTimeout(this.timer)):this.count=1,this.lastTime=n,this.pressTimer=setTimeout(()=>{if(!this.isDown)return;this.isLongPress=!0,this.count=0;const e=this.settings.clickOptions.hold.translateType;this.handleTranslateButtonClick(t,e)},500)},n=e=>{if(e.preventDefault(),e.stopPropagation(),this.isDown&&(clearTimeout(this.pressTimer),!this.isLongPress)){if(1===this.count)clearTimeout(this.timer),this.timer=setTimeout(()=>{if(1!==this.count)return;const e=this.settings.clickOptions.singleClick.translateType;this.handleTranslateButtonClick(t,e)},400);else if(this.count>=2){this.isDouble=!0;const e=this.settings.clickOptions.doubleClick.translateType;this.handleTranslateButtonClick(t,e)}this.isDown=!1}};this.currentTranslateButton.addEventListener("mousedown",e),this.currentTranslateButton.addEventListener("mouseup",n),this.currentTranslateButton.addEventListener("mouseleave",()=>{this.translateType&&this.resetState()}),this.currentTranslateButton.addEventListener("touchstart",e),this.currentTranslateButton.addEventListener("touchend",n),this.currentTranslateButton.addEventListener("touchcancel",()=>{this.translateType&&this.resetState()})}setupDocumentTapHandler(){const t=this.settings.touchOptions;if(!t?.enabled)return;let e=0,n=null,a=!1;this._touchStartHandler=async i=>{if(!t?.enabled)return;const s=i.target;s.closest(".translator-content")||s.closest(".draggable")||s.closest(".translator-tools-container")||(n&&clearTimeout(n),e=i.touches.length,n=setTimeout(async()=>{switch(e){case 2:const e=t.twoFingers?.translateType;if(e){const t=window.getSelection(),n=t?.toString().trim();n&&(i.preventDefault(),await this.handleTranslateButtonClick(t,e))}break;case 3:const n=t.threeFingers?.translateType;if(n){const t=window.getSelection(),e=t?.toString().trim();e&&(i.preventDefault(),await this.handleTranslateButtonClick(t,n))}break;case 4:i.preventDefault();const s=this.translator.userSettings.createSettingsUI();this.shadowRoot.appendChild(s);break;case 5:if(i.preventDefault(),a)return;a=!0,this.toggleTranslatorTools(),setTimeout(()=>{a=!1},350)}e=0,n=null},t.sensitivity||100))},this._touchEndHandler=()=>{n&&(clearTimeout(n),n=null),e=0},document.addEventListener("touchstart",this._touchStartHandler,{passive:!1}),document.addEventListener("touchend",this._touchEndHandler),document.addEventListener("touchcancel",this._touchEndHandler)}toggleTranslatorTools(){if(!this.isTogglingTools){this.isTogglingTools=!0;try{const n=!("true"===t("translatorToolsEnabled"));e("translatorToolsEnabled",n.toString()),this.settings.showTranslatorTools.enabled=n,this.translator.userSettings.saveSettings(),this.removeToolsContainer(),this.resetState(),this.settings.translatorTools?.enabled&&n&&this.setupTranslatorTools(),this.showNotification(this.settings.translatorTools?.enabled&&n?this._("notifications.translation_tool_on"):this._("notifications.translation_tool_off"))}finally{setTimeout(()=>{this.isTogglingTools=!1},350)}}}removeToolsContainer(){const t=this.$(".translator-tools-container");t&&(t.querySelectorAll("input").forEach(t=>{t.removeEventListener("change",this.handleOCRInput),t.removeEventListener("change",this.handleMediaInput)}),t.remove())}async triggerGooglePageTranslate(){if(this.googleTranslateActive)return void this.showNotification(this._("notifications.google_translate_already_active"),"info");this.translator.page.isTranslated&&await this.translator.page.translatePage(),this.showNotification(this._("notifications.google_translate_enabled"),"success"),this.googleTranslateActive=!0,this.googleTranslateAttempts=0;const t=this.settings.displayOptions.targetLanguage,e=this.settings.pageTranslation.googleTranslateLayout;let n=document.querySelector("#google_translate_element");n||(n=document.createElement("div"),n.id="google_translate_element",n.style.display="none",document.body.appendChild(n)),unsafeWindow.googleTranslateElementInit=()=>{new unsafeWindow.google.translate.TranslateElement({pageLanguage:"auto",includedLanguages:t,layout:unsafeWindow.google.translate.TranslateElement.InlineLayout[e],autoDisplay:!1},"google_translate_element");const n=setInterval(()=>{const e=document.querySelector(".goog-te-combo");e&&e.value!==t&&(e.value=t,e.dispatchEvent(new Event("change")));const a=document.querySelector(".goog-te-banner-frame");a?(a.style.display="none !important",a.style.visibility="hidden !important",a.style.height="0px !important",a.style.border="none !important",a.style.boxShadow="none !important",a.style.opacity="0 !important",clearInterval(n),console.log("Google Translate top bar hidden.")):(this.googleTranslateAttempts++,this.googleTranslateAttempts>100&&(clearInterval(n),console.warn("Could not hide Google Translate top bar after multiple attempts.")))},50)};const a="google-translate-api-script";if(!document.querySelector(`#${a}`)){const t=document.createElement("script");t.id=a,t.type="text/javascript",t.src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit",document.body.appendChild(t)}}removeGoogleTranslate(){this.googleTranslateActive&&(this.googleTranslateActive=!1,location.reload())}async handlePageTranslation(){const t=this.settings;if(t.pageTranslation?.enabled||t.shortcuts?.enabled)try{this.showTranslatingStatus();const t=await this.page.translatePage();if(t.success){const e=this.$(".translator-tools-container");if(e){const t=e.querySelector('[data-type="pageTranslate"]');if(t){const e=t.querySelector(".item-text");e&&(e.textContent=this.page.isTranslated?this._("notifications.original_label"):this._("notifications.page_translate_menu_label"))}}const n=this.$(".page-translate-button");n&&(n.textContent=this.page.isTranslated?`📄 ${this._("notifications.original_label")}`:`📄 ${this._("notifications.page_translate_menu_label")}`),this.showNotification(t.message,"success")}else this.showNotification(t.message,"warning")}catch(t){console.error("Page translation error:",t),this.showNotification(t.message,"error")}finally{this.removeTranslatingStatus()}else this.showNotification(this._("notifications.page_translation_disabled"),"warning")}setupQuickTranslateButton(){const t=this.settings;if(!t.pageTranslation?.enabled&&!t.shortcuts?.enabled)return void this.showNotification(this._("notifications.page_translation_disabled"),"warning");const e=document.createElement("style");e.textContent="\n.page-translate-button {\n  position: fixed;\n  bottom: 20px;\n  left: 20px;\n  z-index: 2147483647;\n  padding: 8px 16px;\n  background-color: #4CAF50;\n  color: white;\n  border: none;\n  border-radius: 8px;\n  cursor: pointer;\n  font-size: 14px;\n  box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n  transition: all 0.3s ease;\n}\n.page-translate-button:hover {\n  background-color: #45a030;\n  transform: translateY(-2px);\n}\n",this.shadowRoot.appendChild(e);const n=document.createElement("button");n.className="page-translate-button",n.textContent=this.page.isTranslated?`📄 ${this._("notifications.original_label")}`:`📄 ${this._("notifications.page_translate_menu_label")}`,n.onclick=async()=>{try{this.showTranslatingStatus();const t=await this.page.translatePage();if(t.success){n.textContent=this.page.isTranslated?`📄 ${this._("notifications.original_label")}`:`📄 ${this._("notifications.page_translate_menu_label")}`;const e=this.$(".translator-tools-container");if(e){const t=e.querySelector('[data-type="pageTranslate"]');t&&t.querySelector(".item-text")&&(t.querySelector(".item-text").textContent=this.page.isTranslated?this._("notifications.original_label"):this._("notifications.page_translate_menu_label"))}this.showNotification(t.message,"success")}else this.showNotification(t.message,"warning")}catch(t){console.error("Page translation error:",t),this.showNotification(t.message,"error")}finally{this.removeTranslatingStatus()}},this.shadowRoot.appendChild(n),setTimeout(()=>{n&&n.parentNode&&n.parentNode.removeChild(n),e&&e.parentNode&&e.parentNode.removeChild(e)},1e4)}setupTranslatorTools(){let e=!1;null===t("translatorToolsEnabled")&&t("translatorToolsEnabled"),"true"===t("translatorToolsEnabled")&&(e=!0),this.settings.translatorTools?.enabled&&e&&(this.$(".translator-tools-container")||this.createToolsContainer())}createToolsContainer(){const t=this.settings,e=document.createElement("div");e.className="translator-tools-container",e.setAttribute("data-permanent","true"),e.setAttribute("data-translator-tool","true");const n=document.createElement("span");n.textContent="×",Object.assign(n.style,{cursor:"pointer",fontSize:"16px",color:"#ffffff",backgroundColor:"rgba(85, 85, 85, 0.28)",padding:"0 3px",opacity:"0.8",transition:"all 0.2s ease",fontWeight:"bold",display:"flex",position:"absolute",top:"-8px",right:"-8px",alignItems:"center",justifyContent:"center",width:"20px",height:"20px",borderRadius:"50%"}),n.onmouseover=()=>{Object.assign(n.style,{opacity:"1",backgroundColor:"#ff4444"})},n.onmouseout=()=>{Object.assign(n.style,{opacity:"0.8",backgroundColor:"transparent"})},n.onclick=()=>{this.removeToolsContainer()},this.handleOCRInput=async t=>{const e=t.target.files?.[0];if(e)try{this.showTranslatingStatus();const t=await this.ocr.processImage(e);if(this.removeTranslatingStatus(),!t)throw new Error(this._("notifications.un_pr_screen"));this.formatTrans(t)}catch(t){this.showNotification(t.message,"error")}finally{this.removeTranslatingStatus()}},this.handleMediaInput=async t=>{const e=t.target.files?.[0];if(e)try{this.showTranslatingStatus(),await this.media.processMediaFile(e),this.removeTranslatingStatus()}catch(t){this.showNotification(t.message)}finally{this.removeTranslatingStatus()}};const i=document.createElement("input");i.type="file",i.accept="image/*",i.style.display="none",i.id="translator-ocr-input",i.addEventListener("change",this.handleOCRInput);const s=document.createElement("input");s.type="file",s.accept="audio/*, video/*",s.style.display="none",s.id="translator-media-input",s.addEventListener("change",this.handleMediaInput);const o=document.createElement("button");o.className="translator-tools-button";const r=document.createElement("span");r.className="tools-icon",r.textContent="⚙️",o.appendChild(r);const l=document.createElement("div");l.className="translator-tools-dropdown";const c=[];t.pageTranslation?.enabled&&c.push({icon:`<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWCAYAAADEtGw7AAAACXBIWXMAAAsTAAALEwEAmpwYAAACPElEQVR4nN2S30uTURyHvekfiIIgUMypr24q8x2k9LqJbOuN3NTJTEUrl02tFUUIdmVkchS8qa6ypB/mkiW1qWEpQTjpD8k/wssnvkPltbLjZXTgge2c5/NcjBUV/TeneASzOEVQKLnJbMkNMrs827sX58jBqkHcxhCPq4bAwc7++xA7zreCO4hbGzYTKPMaId8AZ/aoT/DJTHJMkM/ON3Flow1bl1GNVzAO3PXRbvXzQWjqp835Jq5stOFQLyrcczAsx45zMtDDiV/vxZWNNtzWhYrFMKLd+Nq6uPM3xBFXNtpwdweqJ4YRj+Pq7aT1AF0EL3XS3JckIsT7KBVXNtpwIoJKtmIkolxMRHnlZCDK2Yk8wUebIEx+417BjRwhfOsCKhXGSJ0nlrLJOrltY73ZwH67DsL8BmPiykYbHg2h7ocxRoOUj4Zpd3K3hdObq9hbKyDklxkruKEjhB80o8YDGA/91IwHuOpkoonSHxmOb7/n+vYSye0lysWVjTY8baFmAhhTfmLTFlknU+ewZvx497/7iYkrG234aQPqSePv/+PDjriy0YovfKiX5uHh515ccyZrcz4yBUzWZKMNp+tQCybGQi3WfA2V72ppXfTSvViLR0h7sdNehtN1dCzW0yCubLThnBu17MHIuRnJVdOS9TCZ8zD70U1EyFVjZz0M5zy8Xq3m1K6rD3+pRH2uOPyn2KjAXq9keO+7uLLRhjfL6N8qY2XLReZP5F18zbv4vn9XxopstOF//vwEcbLHwTzAksEAAAAASUVORK5CYII=" alt="${this._("notifications.page_translate_menu_label")}">`,text:this.page.isTranslated?this._("notifications.original_label"):this._("notifications.page_translate_menu_label"),"data-type":"pageTranslate",handler:async()=>{try{l.style.display="none",this.showTranslatingStatus();const t=await this.page.translatePage();if(this.removeTranslatingStatus(),t.success){const e=l.querySelector('[data-type="pageTranslate"]');if(e){const t=e.querySelector(".item-text");t&&(t.textContent=this.page.isTranslated?this._("notifications.original_label"):this._("notifications.page_translate_menu_label"))}this.showNotification(t.message,"success")}else this.showNotification(t.message,"warning")}catch(t){console.error("Page translation error:",t),this.showNotification(t.message,"error")}finally{this.removeTranslatingStatus()}}}),t.pageTranslation?.enableGoogleTranslate&&c.push({icon:`<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWCAYAAADEtGw7AAAACXBIWXMAAAsTAAALEwEAmpwYAAAD3UlEQVR4nK2Ub0wbdRjHO//E+MYYjS9MTIxv8IWJLyTq3gH9XdcS1jJtWKL9u8xJ2NJNNnZ3vVoKuD+tQClkyOTuBmVu6rIx3e5aaLuNoPTK7CSaDc0GCLrNuVg2HIzZXu8xd+CLVVo085t8X1x+z/P5fX/Pk5xKlUcJtbpMQOiggGE/CggtCBiWSWDYTUGjGYojtDup1T6br3dlYFlZcQLDLggIwXdGY+bazp1wgyDgam0tTG/bBpdMJimh0YhxhNKCWu2Pr137+KrQuFpdLSe7ZDKJf/h8sNjWpnje54NUfT3c8XqV74WWFvippgbkywWERsDjeagwFCG4Xle31NzaCjMOh/SNTpddBihOVlSk5eTfb9wop54XSktfLwR9RUBI/HUZmmpogIRGIwOnBIS2xzGsZBShohEMQwmEAgkMuytg2J2CUFln92mDY1Vv3Fvw++F3t/vvdI3HqqoeXnEPJSXPyWEKQqMf616N0Dr4+bx7/nobeW9Uo4G4Wl2velAN0tqOxHFTRkr1wcXo1sXhLVh/srj40QcGx9iKsWtjTQCpw3Dm0HoYpLXbc2vWk6F1lVTorIHih1bxOYOLq1KaIkz53bnJdsimgiCPRB5NLlhPcXYDxUN1x4UVXXNgDPDgFXhr7znR4OSbl8C0Tpyf6QTxZo8CDjPaF/OBm8O3C3pLezKjp/iDSlOUKZ+9dbkV5BkvJdZi+cD5/I5/VAGbvcN/GijOswSmy7+ajOMSzPbB8BEj9HUbG3PBG0i+SE9x7+ba4ORq9U4+S306rYArXSFJ7+TMSpO8rNihCpi7ykgdYe+ElcYXzd27Xvg3i9c7eUqGfRi6BU39N+T04gay/2nlcIBe99TR7jfHA0PMbW5iAHZ89oFoY4nztp4dTxaEkpzO4OLT5JEpJe0mv5AxUDx/X5GFxgObeykIT0UVb/3EI9oZ4gcbTZTmAh3tjscsLP6ecU9P1NY8oqR1f/4LGJxcVv9++KX7ik2HHU/YGXKSOOnLRqZjMDAVAzfXlrEyONhZ4qKVxnssNO61MfhRO0vO2lhS2hvplPZ8EZ/Dg5ezla4Q6J18w4pPs3STRTaG+K3u+D4xNBmByPQZOHUlBB/Fg9DABTJ4vze9P9qV7fv2GAxOxZTzwBAL5gO+8UrXl10qFazJO7e3mV3P21kyaWMJqfPrXomfGFQAuT4xfhqoUy2ilcGzFnp3vafQ/1i1rBKP5xErjVfbWXJGHsXmXirrPNmSaQp1ZPAT+9PypTLQxhCnrXTdy6sC/yFQrbHS+GvyouTlWmm8y8rgjVaaMG9inc/8d+D/pL8Aw3mxX2X1GHoAAAAASUVORK5CYII=" alt="${this._("notifications.google_translate_page_menu_label")}">`,text:this._("notifications.google_translate_page_menu_label"),"data-type":"googlePageTranslate",handler:()=>{l.style.display="none",this.triggerGooglePageTranslate()}}),t.ocrOptions?.enabled&&c.push({icon:`<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAfUlEQVR4nGNgYGBgmHLwxn9kzIAHYFU7hVoGMJAAqGsA1UCm3v+DWXr//2fp/T+Oxv9fb/+fJVP3/29keUwDdP//hilEpnHJk2VAlt7//5l6/6+S7YJs/f8Ombr/v4SG/mfGZsB+qA3HkPnIYYDXC2SDKQOekKYMeGaiBAAAKXcJNrF/Bp0AAAAASUVORK5CYII=" alt="${this._("notifications.ocr_region_menu_label")}">`,text:this._("notifications.ocr_region_menu_label"),handler:async()=>{try{l.style.display="none",await new Promise(t=>setTimeout(t,100));const t=await this.ocr.captureScreen();if(!t)throw new Error("Không thể tạo ảnh chụp màn hình");this.showTranslatingStatus();const e=await this.ocr.processImage(t);if(this.removeTranslatingStatus(),!e)throw new Error(this._("notifications.un_pr_screen"));this.formatTrans(e)}catch(t){console.error("Screen translation error:",t),this.showNotification(t.message,"error")}finally{this.removeTranslatingStatus()}}},{icon:`<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWCAYAAADEtGw7AAAACXBIWXMAAAsTAAALEwEAmpwYAAACQklEQVR4nO2T3UtTcRjHhSAmhUHRjTeNkSdoDjf0bO5Mmst5qFZo2LroRdeL0YQugg2NgsPxts2CIrZQxGAbrSydK6W9SS9CUHThfS9XQf/EJ06bbmtaehHd+IXvxfPleT78fg+/X13dlv6b9H6G9UNM7xsiuSH7eaIfIvxH6EEv242DfDBdZngzNg6yvP8aDeuCbT7GbQP02QZo3Yyt/cg2H8/WBbvPMrPRld14zd5bb7iovKXxr7MnT/F8o+CJLPMTWZjIslQze6YH07lerlT4U1Xdg++Sl91rgQtzPC6koZBmQavP91aArx5j0e/Bu66Pc8HvIbIW+Mskuq/THP7+iB0lVhkc6K69etBNU1Cmd1imRXGiC8p8DrqLe9SkONkZkLkZkBm53k79mizVVQsePYRp1IlP7cKugdVO3qkuMoqbRuUIDWonLxQXstqJR3Uxd7u7eOIqVkjiW8jB0zEHp7U6LHE/5GAm1IFQOp0u5CAx1oEhJJEJS7wck2hbmb8jYQ9LRXhYqgBHrSxHbfRFRUai1uLviYh0RUTuRq14J53oIiIJLX/QhiEikhuXymsp9dsjVuaiIq9Ww5iZXMJMIGbhYdyMEm/Bk2xlV6IF/ZTIHg0cNxfBv/rbMMQtZOKWanjMgj1m4cdqkDIWH/WsETVl5MRsM1OVA8l26lPNZbCmtAlDykhm5kAZnvSyLdXM/GpTXuBevolkromFnMBiXuCjVq84J5DOC7yvzEr9hbzAUkU2mxU4+vtD2FLdP9FPOyyiEx9ZF+gAAAAASUVORK5CYII=" alt="${this._("notifications.web_image_ocr_menu_label")}">`,text:this._("notifications.web_image_ocr_menu_label"),handler:()=>{l.style.display="none",this.startWebImageOCR()}},{icon:`<img src="https://github.com/king1x32/King-Translator-AI/raw/main/icon/comic.png" alt="${this._("notifications.manga_web_menu_label")}">`,text:this._("notifications.manga_web_menu_label"),handler:()=>{l.style.display="none",this.startMangaTranslation()}},{icon:`<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWCAYAAADEtGw7AAAACXBIWXMAAAsTAAALEwEAmpwYAAACKUlEQVR4nO2Sz0uTcRzHn6hTJ+tQHRTMyOmW5HCPxAbPk0zRLZyUPSxCkWfgLNzYKTZDarhVj1B7oovtuXSI7TAaj6VukIp5CD177RAE/R2vGGms/XhaHqM3vC6fz+f94nv4CsL/1KZjnkB7BO1v6ZgnJgicEJqlN8zH7jA99jlu28MordBzn4HeObL2OexNxS4V0xViyaWy4lLRWiLE2oBKUpyhv6lYmsaUptDlGTqbHjXoyNMkZSuxP4jpD6KPBhuL07tMPNmlpO3QXt25ESTpv2shViYxlUl0ZZJ7d8Y5X7svbfC6XIJymdGaTlJRLMRqADMUQA8FWFQDFEMBlh/LnDraf//A6W9FxNqOOk5yZsJCHB3DjPjQo2NsR3xoER+zUR/PmhYOO1EfyZjfQhwfxox70RNenie8BONeVuJejIURrlTfPRjCFh+mnPBS+I1hSvERpurEaQkzJaGnZRbSEkZKJrckcSsl8bDm7lVqiEuNHpeW2agbZtyYugdfxsO7jJtSxs3a4Ww946bwCw9fdZm2SufFNfoyHhLVjjpxVuSLIbKcHUSzwhA5eHOVNkPkpjFIzhDZzw7yqOIwxAbivJNPuX6UP+JkpyIu2Dmb68efd/Lybd/Pv513NhCbDq6vOni66kCz4r2Dg/U+zlQ663YuVHpHjlVHA3Gr2bIR27QR3bxMVzXbNtxb3RSF46YgcHKvk9n9i2jV7HWx+LmLc8cWC/9sfgCb97UQIppPcwAAAABJRU5ErkJggg==" alt="${this._("notifications.image_file_menu_label")}">`,text:this._("notifications.image_file_menu_label"),handler:()=>i.click()}),t.mediaOptions?.enabled&&c.push({icon:`<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWCAYAAADEtGw7AAAACXBIWXMAAAsTAAALEwEAmpwYAAACLUlEQVR4nNWMz0sTcBjGd4gORXTqWEYx3ISZ25iy1ea23MzpNEpbBGITW2yoGJsNkblDsFUopZdSTMMtrDVnaGtlabsEdezkpZCCpOg/6PKJb7iG7ocyL/XAc3jf5/k8Esl/r7JuZEe6qZNfZ1k1xOeM5X4+HnZjFdlWC6boqNTNsXIXS7KrTLWO8HNsBTLufcivCjevZS78Wy0YwRYcNvYwbbnGmt3Pl+l5mHuZdSwJrYN8a+xndasFI9iCwxf6+PR+AUqxYAsON3XwtauH1VIs2ILDzQ7mJSWqKOs4X/pwUdbZvP3w5RYUTjsu4Y4WqnbEemzbD3tspN2NtLkbuOG24dsR67Pkhr56tD4Lc14Lz8TttbDmtRLzWol4bZQVY/8qYNocBk2cGzITHzRhDpgJZTrBNvYGjNQUYzcpbMiGN+s4GDaQDulxhPXMhPRYb5s4LjrBWvaE9azc0nEgH5ujUV02vKPDMaql/a6WVyM2PMOdfB928mPUwJuN/MrYSRrysTma0GTDiWr67ms4PaGhafIM72aT8DgJk/V8GK/h4r0aLOMaevOxOYoqeR5VMfBIiT+q5ElESaf4z5q4lDjLeqKF9dlTtEdVpCJqukTnT1fFQETJYsHhmUr2zytQCydOUB1XsLygZp/IYlUcSihoiFfyNF6JfU7Biuhk+oKV7FTJCswv5Cymyjkq7pSc/iUZtRs/o2Q3SkuRp6VMpaXEhN9KeSB+uxr9J/UbsfXQjgkgRpYAAAAASUVORK5CYII=" alt="${this._("notifications.media_file_menu_label")}">`,text:this._("notifications.media_file_menu_label"),handler:()=>s.click()}),c.push({icon:`<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWCAYAAADEtGw7AAAACXBIWXMAAAsTAAALEwEAmpwYAAABxklEQVR4nNWUv0sbYRyHIwaEgn9AhzgYq6EeCXgpB0nT5ISUUHAIKEp+oNCAGilpaZAOUQdJa5eokw4KcUuCopcEJQaXZHHo/9GpHVpKx6ckWknIte+dm1/48HLH93neDzecxfLgx7bCri3J8VCS0n9SH01zYpmh37B4bIkz4c4iATXDL/d7aoblzgSnoh3XawIfdviRO+R3IMWlfwOrUKwsiMXP4oxG3vJ96xPfYu/4GVykIBSrUbG4Nb5ZbGoEuZVAjJoQCM0ZE5tmwtPmxYaYSNi82BCTmDIvNsSsvDIvNsSkg+bF6SAvhUtrqjHxhh/r+iSpdZXy2iTa7bn6JsSALvDxhVjckmZ9lLJ+lrHQd8f6mM/60Hb15DmPWJzzktr2sHz3/Jx4Bx/d9pLpgfYUsXhfodLZdF/p/nHtKVR7oLzMVV7GfuhmWC8HHgbz8s3lR27i+QnOjib42j5llm4dveWKLq4LTrb+GRfeoqu7cdHZ3bjg1GlcltjRJI7L45R0I/FZG2dVe8p8B9Nu2pqKRFiT2BR9Tt05H2Gg7kCrjxHtfF9zEL50cFGWeXQv8V958wmZpp1qYwStaafSsLP55fGN9A/mHCTEh8xvxQAAAABJRU5ErkJggg==" alt="${this._("notifications.generic_file_menu_label")}">`,text:this._("notifications.generic_file_menu_label"),handler:()=>{l.style.display="none";const t=_.text.formats.map(t=>`.${t.ext}`).join(","),e=document.createElement("input");e.type="file",e.accept=t,e.style.display="none",e.onchange=async t=>{const e=t.target.files[0];if(e)try{this.showTranslatingStatus();const t=await this.translator.translateFile(e);console.log(e.type);const n=e.type.endsWith("pdf")?t:new Blob([t],{type:e.type}),a=URL.createObjectURL(n),i=document.createElement("a");i.href=a,i.download=`king1x32_translated_${e.type.endsWith("pdf")?e.name.replace(".pdf",".html"):e.name}`,this.shadowRoot.appendChild(i),i.click(),URL.revokeObjectURL(a),i.remove(),this.removeTranslatingStatus(),this.showNotification(this._("notifications.file_translated_success"),"success")}catch(t){console.error(this._("notifications.file_translation_error"),t),this.showNotification(t.message,"error")}finally{this.removeTranslatingStatus()}},e.click()}},{icon:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWCAYAAADEtGw7AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB8klEQVR4nNWRz2uScRzHPXSpXeq2Wz8gGxsKGpopmwh7LG09K0gYHQpm2xAdFel8IlbdErpoHWoeGil0WFSLhpJD/Rs67VJEQaf+gy6v+Mzk0X2fZ2ye2hve8OXzfr/ePPA4HAdexzOMnEwx6crR9D/kW9fuJb6cSBGVbKeF2XXUleLU2DybY3O8Sjzld7ENXS++5o9rgc3RefKK52gIazscSbOq3eG7nuNH+SO8aZiu1uHaA35dzrK108IIazs8c5uvzQ0YxMLaDus3+HkrzdYgFtZ2+EqCD44BtSs7c7U/nJriyPVLHOv1zWmO7oXtU1I3w+Q08Vmd+qzOSq+TOjW5JxIctmMVpeNmmIljLF4koHRiaJkY7zMx1u/2jPeyirKaGWajGEuT6vA9jaFclJe5KM2sRtqKVbQcMcPlCMajsDrclWTSsWIVPZkww8I4RiFMoDDOhcIE632WWyczrFhFpaAZFs9jlEKdL34WYKEUpCiW93Y3REA6Vqyiss8MV3wYZX9neNXH8ItzxMXy3u76CUjHilVU8bBR8XK/4iFf9VKvejvD7TCHqh4ei+UtN8mkI91/zCf7YTdDay7Oit+6ef7OZf/zJJNOty+sYy+qjZKvjdgPSyYdx37VchJqOWm0TrNm5baTz80zBPc9/N/qL/loyWQnG2fwAAAAAElFTkSuQmCC" alt="documents-folder">',text:this._("notifications.generic_file_gemini_menu_label"),handler:()=>{l.style.display="none",this.handleGeminiFileOrUrlTranslation()}},{icon:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWCAYAAADEtGw7AAAACXBIWXMAAAsTAAALEwEAmpwYAAADR0lEQVR4nM2S30/bZRTGO83EOX8kLtlcRKeOFa1tkTXwLVOEDgztaNkmli2jWGK+dDgobK5bvEC/6LIEY6ZZ2cbKhM0xllFp+bZCR1taEGVXJuqlLtmNt/o3fMwZssREuoQs0ZM8yTnPeZ4nb973NRj+y9rWywvF3XwpkP6BBZcc5kppJ6UvqxilX1OIyc8zFpU+awBF5tL3eMKqMrOyt6hMV7bypPSiEa14CoY6gxRV+slUtbNL8XNR8aNXtpOofp9dx25RIpBeONkp7UTsfl6v9JMV76rBjnfZXuPj/MocTFF8/AcuhpZIHF/izN/QQ0sMHf6WZ1d04qk7xEsFT+06yGXXISzaIqaPvyfbt4DluSO8WtxFl+D5ICZtEau2SKZvgVcaWzCL5753/LaXwDtteAcWmDudYIulgyGLyohZZb/A0sGoWeW8lmbzwHdkW3w0i6dAJOt8Hl5s3cdsOE1POM8BRysfOXzLpmiUhzWNh6Tf3Uano5Xg4DwHv0jTJZ4De//lGwa8PNXhYVZ1Mxhws3NkjsnPr7KxpZmc7CMZaiI5/hzO8cfwHNXCeZvJi0a0aiO2Dg/nJCPoXP4xd6u7gfoeF90r8400eqCBrV17GJF5PM3E9QwIrqWZEO7IHkZFI9p7j+0k2OOk7l5wyMH2k2+hf1hHfdBJUTJFIuLmsf7a5f+r36Q3eRMSghRB4WR3xssG0YrnRD11kiFZ/7gOrQZzfy29/bUkstOczqaoOKcwfraKctnnk9TkpnlT+gsKtkE7w/lplLkZTmkOdG03RyVj1Sf87A0+Heuk6VYSPWZj60QZszfK2JcqoUgQLWO/cPEKNi0lSYwG8AxU84nhfhW2czKs4Pp5irZfphia9/J4bgcn8kZmBLkdhNI+Nsrupzi+cBWNZ6sIFQz9uoJNlyrQMbBO5tsxmm7HyfwW4+ivU1QLpL/LxXGLRrTiuWTn6VWDr5vZMvYayaiJR8bL8YyVEx1X+ODOFZp+/4Zjgjtf0SSc7K7txB2xsV48V61sLnjqSSsNk1YSMSunLm/j0biFvTHL8heTkl64qJ0Nopm0osesOA1rqZSJqR9trBfMmIgbHlQtGHHljSQF88Y1nu5/X38B2jUbWROlf8IAAAAASUVORK5CYII=" alt="settings--v1">',text:this._("notifications.settings"),handler:()=>{l.style.display="none";const t=this.translator.userSettings.createSettingsUI();this.shadowRoot.appendChild(t)}}),c.forEach(t=>{const e=document.createElement("div");e.className="translator-tools-item",t["data-type"]&&e.setAttribute("data-type",t["data-type"]);const n=document.createElement("span");n.className="item-icon";const i=a(t.icon);i&&n.appendChild(i);const s=document.createElement("span");s.className="item-text",s.textContent=t.text,e.appendChild(n),e.appendChild(s),e.handler=t.handler,e.addEventListener("click",t.handler),l.appendChild(e)}),this.handleButtonClick=t=>{t.stopPropagation(),l.style.display="none"===l.style.display?"block":"none"},o.addEventListener("click",this.handleButtonClick),this.handleClickOutside=()=>{l.style.display="none"},document.addEventListener("click",this.handleClickOutside),e.appendChild(n),e.appendChild(o),e.appendChild(l),e.appendChild(i),e.appendChild(s),this.shadowRoot.appendChild(e),this.shadowRoot.contains(e)||this.shadowRoot.appendChild(e),e.style.zIndex="2147483647"}showProcessingStatus(t){this.removeProcessingStatus();const e=document.createElement("div");e.className="processing-status",e.innerHTML=`\n<div class="processing-spinner" style="color: white"></div>\n<div class="processing-message" style="color: white">${t}</div>\n<div class="processing-progress" style="color: white">0%</div>\n`,Object.assign(e.style,{position:"fixed",top:window.innerHeight/2+"px",left:window.innerWidth/2+"px",transform:"translate(-50%, -50%)",backgroundColor:"rgba(0, 0, 0, 0.8)",color:"white",padding:"20px",borderRadius:"8px",zIndex:"2147483647",textAlign:"center",minWidth:"200px"}),this.shadowRoot.appendChild(e),this.processingStatus=e}updateProcessingStatus(t,e){if(this.processingStatus){const n=this.processingStatus.querySelector(".processing-message"),a=this.processingStatus.querySelector(".processing-progress");n&&(n.textContent=t),a&&(a.textContent=`${e}%`)}}removeProcessingStatus(){this.processingStatus&&(this.processingStatus.remove(),this.processingStatus=null);const t=this.$(".processing-status");t&&t.remove()}readFileContent(t){return new Promise((e,n)=>{const a=new FileReader;a.onload=t=>e(t.target.result),a.onerror=()=>n(new Error(this._("notifications.failed_read_file"))),a.readAsText(t)})}showLoadingStatus(t=this._("notifications.processing_pdf")){const e=document.createElement("div");e.id="pdf-loading-status",e.style.cssText=`\nposition: fixed;\ntop: ${window.innerHeight/2}px;\nleft: ${window.innerWidth/2}px;\ntransform: translate(-50%, -50%);\nbackground-color: rgba(0, 0, 0, 0.8);\ncolor: white;\npadding: 20px;\nborder-radius: 8px;\nz-index: 2147483647;\n`,e.innerHTML=`\n<div style="text-align: center;">\n    <div class="spinner" style="color: white"></div>\n    <div style="color: white">${t}</div>\n</div>\n`,this.shadowRoot.appendChild(e)}removeLoadingStatus(){const t=this.shadowRoot.querySelector("#pdf-loading-status");t&&t.remove()}updateProgress(t,e){const n=this.shadowRoot.querySelector("#pdf-loading-status");n&&(n.innerHTML=`\n<div style="text-align: center;">\n    <div class="spinner" style="color: white"></div>\n    <div style="color: white">${t}</div>\n    <div style="color: white">${e}%</div>\n</div>\n`)}startWebImageOCR(){const t=document.createElement("style");t.textContent=`\n.translator-overlay {\n  position: fixed;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  background-color: rgba(0,0,0,0.3);\n  z-index: 2147483647;\n  pointer-events: none;\n}\n.translator-overlay.translating-done {\n  background-color: transparent;\n}\n.translator-guide {\n  position: fixed;\n  top: 20px;\n  left: ${window.innerWidth/2}px;\n  transform: translateX(-50%);\n  background-color: rgba(0,0,0,0.8);\n  color: white;\n  padding: 10px 20px;\n  border-radius: 8px;\n  font-size: 14px;\n  z-index: 2147483647;\n  pointer-events: none;\n}\n.translator-cancel {\n  position: fixed;\n  top: 20px;\n  right: 20px;\n  background-color: #ff4444;\n  color: white;\n  border: none;\n  border-radius: 50%;\n  width: 30px;\n  height: 30px;\n  font-size: 16px;\n  cursor: pointer;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  z-index: 2147483647;\n  pointer-events: auto;\n}\n`,this.shadowRoot.appendChild(t);const e=document.createElement("style");e.textContent="\nimg:hover, canvas:hover {\n  outline: 3px solid #4a90e2;\n  outline-offset: -3px;\n  cursor: pointer;\n  position: relative;\n  z-index: 2147483647;\n  pointer-events: auto;\n}\n",document.head.appendChild(e);const n=document.createElement("div");n.className="translator-overlay";const a=document.createElement("div");a.className="translator-guide",a.textContent=this._("notifications.ocr_click_guide");const i=document.createElement("button");i.className="translator-cancel",i.textContent="✕",this.shadowRoot.appendChild(n),this.shadowRoot.appendChild(a),this.shadowRoot.appendChild(i);const s=async t=>{if("IMG"===t.target.tagName||"CANVAS"===t.target.tagName){t.preventDefault(),t.stopPropagation();try{this.showTranslatingStatus();const e=t.target,a=document.createElement("canvas"),i=a.getContext("2d",{willReadFrequently:!0});if("IMG"===e.tagName?await this.loadImage(e,a,i):"CANVAS"===e.tagName&&await this.processCanvas(e,a,i),!i.getImageData(0,0,a.width,a.height).data.some(t=>0!==t))throw new Error(this._("notifications.cannot_capture_element"));const s=await new Promise((t,e)=>{a.toBlob(n=>{!n||n.size<100?e(new Error(this._("notifications.cannot_generate_valid"))):t(n)},"image/png",1)}),o=new File([s],"web-image.png",{type:"image/png"}),r=await this.ocr.processImage(o);if(!r)throw new Error(this._("notifications.un_pr_screen"));n.classList.add("translating-done"),this.formatTrans(r)}catch(t){console.error("OCR error:",t),this.showNotification(t.message,"error")}finally{this.removeTranslatingStatus()}}};document.addEventListener("click",s,!0),i.addEventListener("click",()=>{document.removeEventListener("click",s,!0),n.remove(),a.remove(),i.remove(),t.remove(),e.remove()}),this.webImageListeners={click:s,overlay:n,guide:a,cancelBtn:i,style:t,globalStyle:e}}formatTrans(t){if("translation_only"!==this.settings.displayOptions.translationMode){const e=t.split("\n");let n="",a="",i="";for(const t of e){const e=t.split("<|>");i+=(e[0]||"")+"\n",a+=(e[1]||"")+"\n",n+=(e[2]||t.replace("<|>",""))+"\n"}this.displayPopup(n,i,"King1x32 <3",a)}else this.displayPopup(t,"","King1x32 <3")}createMangaOverlay(t,e){const n=document.createElement("div");n.className="manga-translation-overlay",t.position=(t=>{if(t.height/t.width>2&&(t.height=2*t.width),t.edge_detection)switch(t.boundary_position){case"left":t.x-=5,t.width+=5;break;case"right":t.width+=5;break;case"top":t.y-=5,t.height+=5;break;case"bottom":t.height+=5;break;case"corner":t.x-=5,t.y-=5,t.width+=10,t.height+=10}return t})(t.position),["top","bottom","left","right","top-left","top-right","bottom-left","bottom-right"].forEach(t=>{const e=document.createElement("div");e.className=`resize-handle ${t}`,e.dataset.direction=t,n.appendChild(e),setTimeout(()=>{n.contains(e)||n.appendChild(e)},100)});const{naturalWidth:a,naturalHeight:i}=e;let s={x:t.position.x/100,y:t.position.y/100,width:t.position.width/100,height:t.position.height/100,isCustom:!1},o={x:0,y:0};const l=(t,e,n)=>{const a=this.settings.displayOptions.webImageTranslation.fontSize,i=r.displayOptions.webImageTranslation.minFontSize,s=r.displayOptions.webImageTranslation.maxFontSize,o=(t,e)=>{if("number"==typeof t)return t;if("string"!=typeof t)return e;const n=parseFloat(t);return t.endsWith("px")?n:t.endsWith("rem")?n*(parseFloat(getComputedStyle(document.documentElement).fontSize)||16):n||e},l=o(i,8),c=o(s,24),d=n.translation||n.text||"";if(!d.trim())return{fontSize:l,lineHeight:1.3};const p=t-13,h=e-9;if(p<=1||h<=1)return{fontSize:l,lineHeight:1.3};const g=document.createElement("div");let u;Object.assign(g.style,{position:"absolute",left:"-9999px",top:"-9999px",visibility:"hidden",width:`${p}px`,fontFamily:"'Patrick Hand', 'Comic Neue', 'GoMono Nerd Font', 'Noto Sans', Arial",whiteSpace:"pre-wrap",wordBreak:"break-word",padding:"0"}),g.innerText=d,this.shadowRoot.appendChild(g);let m=1.3;const y=(t,e)=>(g.style.fontSize=`${t}px`,g.style.lineHeight=e,g.scrollHeight<=h);if("auto"===a){let t=l,e=Math.min(c,h/(d.split("\n").length||1)),n=t;for(;t<=e;){let a=(t+e)/2;y(a,m)?(n=a,t=a+.1):e=a-.1}u=n}else{const t=o(a,14);if(y(t,m))u=t;else{let e=l,n=t,a=e;for(;e<=n;){let t=(e+n)/2;y(t)?(a=t,e=t+.1):n=t-.1}u=a}}const f=h/p;for(f>1.5?(m=1.1,y(u,m)||(u*=.95)):f<.7&&(m=1.5);!y(u,m)&&u>l;)u-=.5;return g.remove(),{fontSize:Math.max(l,Math.min(c,u)),lineHeight:m}},c=(t,e)=>{const n=i/a*e.width;return t.x=Math.max(e.left,Math.min(t.x,e.right-t.width)),t.y=Math.max(e.top,Math.min(t.y,e.top+n-t.height)),t},d=()=>{const t=e.getBoundingClientRect(),n=t.width,r=i/a*n;let l;if(s.isCustom){const e=n-s.width*n,a=r-s.height*r;l={x:t.left+Math.min(e,Math.max(0,o.x)),y:t.top+Math.min(a,Math.max(0,o.y)),width:s.width*n,height:s.height*r}}else l={x:t.left+n*s.x,y:t.top+r*s.y,width:n*s.width,height:r*s.height};return c(l,t)},p=()=>{const e=d(),{fontSize:a,lineHeight:i}=l(e.width,e.height,t);Object.assign(n.style,{left:`${e.x}px`,top:`${e.y}px`,width:`${e.width}px`,height:`${e.height}px`,fontSize:`${a}px`,lineHeight:i,fontFamily:"'Patrick Hand', 'Comic Neue', 'GoMono Nerd Font', 'Noto Sans', Arial",fontWeight:"bold"===t.position.text_style?"bold":"normal",fontStyle:"italic"===t.position.text_style?"italic":"normal",writingMode:"vertical"===t.position.text_orientation?"vertical-rl":"horizontal-tb"})};let h,g,u,m=!1,y=!1,f=!1,v=0,b=0,_=0,x=0,S=0,w=null;const T=t=>{const e=t.target;e.classList.contains("resize-handle")?(t.preventDefault(),t.stopPropagation(),y=!0,u=n.getBoundingClientRect(),h=t.clientX,g=t.clientY,document.addEventListener("mousemove",k),document.addEventListener("mouseup",E),k.direction=e.dataset.direction):(m=!0,h=t.clientX,g=t.clientY,u={left:n.offsetLeft,top:n.offsetTop},n.style.cursor="grabbing",document.addEventListener("mousemove",k),document.addEventListener("mouseup",E))},k=a=>{if(y){const i=a.clientX-h,s=a.clientY-g;let{width:o,height:r,left:d,top:p}=u;const m=k.direction;m.includes("right")&&(o+=i),m.includes("left")&&(o-=i,d+=i),m.includes("bottom")&&(r+=s),m.includes("top")&&(r-=s,p+=s);const y=20;o<y&&(m.includes("left")&&(d+=o-y),o=y),r<y&&(m.includes("top")&&(p+=r-y),r=y);const f=e.getBoundingClientRect(),v=c({left:d,top:p,width:o,height:r},f);n.style.width=`${v.width}px`,n.style.height=`${v.height}px`,n.style.left=`${v.left}px`,n.style.top=`${v.top}px`;const{fontSize:b,lineHeight:_}=l(v.width,v.height,t);n.style.fontSize=`${b}px`,n.style.lineHeight=_}else if(m){const t=a.clientX-h,e=a.clientY-g,i=u.left+t,s=u.top+e;n.style.left=`${i}px`,n.style.top=`${s}px`}},E=()=>{if(y||m){const t=e.getBoundingClientRect(),r=t.width,l=i/a*r;s.width=n.offsetWidth/r,s.height=n.offsetHeight/l,o.x=n.offsetLeft-t.left,o.y=n.offsetTop-t.top,s.isCustom=!0,(()=>{const t=d(),n=t.height/t.width,a=e.getBoundingClientRect();if(n>2||n<1/3){const e=Math.sqrt(t.width*t.height);s.width=e/a.width,s.height=e/a.height,p()}})()}m=!1,y=!1,n.style.cursor="grab",document.removeEventListener("mousemove",k),document.removeEventListener("mouseup",E)};n.addEventListener("mousedown",T);const C=()=>{s={x:t.position.x/100,y:t.position.y/100,width:t.position.width/100,height:t.position.height/100,isCustom:!1},o={x:0,y:0},p()},A=t=>{if(1!==t.touches.length||f){if(2===t.touches.length){m=!1,f=!0;const[a,i]=t.touches;v=Math.hypot(a.clientX-i.clientX,a.clientY-i.clientY);const s=e.getBoundingClientRect();b=n.offsetWidth/s.width,_=n.offsetHeight/s.height}}else{(t=>{const e=Date.now(),n=e-x;x=e,n<300?(S++,2===S&&(t.preventDefault(),t.stopPropagation(),C(),S=0,w&&clearTimeout(w))):(S=1,w&&clearTimeout(w),w=setTimeout(()=>{S=0},300))})(t),m=!0;const e=t.touches[0];h=e.clientX,g=e.clientY,u=n.getBoundingClientRect()}},L=t=>{if(t.preventDefault(),f&&2===t.touches.length){const[n,a]=t.touches,i=Math.hypot(n.clientX-a.clientX,n.clientY-a.clientY)/v,o=30/e.getBoundingClientRect().width;s.width=Math.max(o,b*i),s.height=Math.max(o,_*i),s.isCustom=!0,p()}else if(m&&1===t.touches.length){const e=t.touches[0],a=e.clientX-h,i=e.clientY-g;n.style.left=`${u.left+a+window.scrollX}px`,n.style.top=`${u.top+i+window.scrollY}px`}},M=t=>{if(t.touches.length<2&&(f=!1),t.touches.length<1&&(m=!1),!f&&!m){const t=e.getBoundingClientRect();o.x=n.offsetLeft-window.scrollX-t.left,o.y=n.offsetTop-window.scrollY-t.top,s.width=n.offsetWidth/t.width,s.height=n.offsetHeight/t.height,s.isCustom=!0}};n.addEventListener("touchstart",A,{passive:!1}),n.addEventListener("touchmove",L,{passive:!1}),n.addEventListener("touchend",M),n.addEventListener("touchcancel",M),n.addEventListener("dblclick",t=>{t.preventDefault(),t.stopPropagation(),C()}),n.addEventListener("wheel",t=>{if(t.ctrlKey){t.preventDefault();const e=parseFloat(n.style.opacity)||.8,a=Math.max(.1,Math.min(1,e+(t.deltaY>0?-.05:.05)));n.style.opacity=a}}),n.innerText=t.translation,p();const N=()=>requestAnimationFrame(p);return window.addEventListener("scroll",N,{passive:!0}),window.addEventListener("resize",N,{passive:!0}),n.cleanup=()=>{window.removeEventListener("scroll",N),window.removeEventListener("resize",N),n.removeEventListener("mousedown",T),document.removeEventListener("mousemove",k),document.removeEventListener("mouseup",E),n.removeEventListener("touchstart",A),n.removeEventListener("touchmove",L),n.removeEventListener("touchend",M),n.removeEventListener("touchcancel",M)},n}startMangaTranslation(){const e="dark"===this.settings.theme,n=document.createElement("style");n.textContent=`\n@import url('https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Comic+Neue:wght@400;700&display=swap');\n.translator-overlay {\n  position: fixed;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  background-color: rgba(0,0,0,0.3);\n  z-index: 2147483647;\n  pointer-events: none;\n}\n.translating-done {\n  background-color: transparent;\n}\n.translator-guide {\n  position: fixed;\n  top: 20px;\n  left: ${window.innerWidth/2}px;\n  transform: translateX(-50%);\n  background-color: rgba(0,0,0,0.8);\n  color: white;\n  padding: 10px 20px;\n  border-radius: 8px;\n  font-size: 14px;\n  z-index: 2147483647;\n  pointer-events: none;\n}\n.translator-cancel {\n  position: fixed;\n  top: 20px;\n  right: 20px;\n  background-color: #ff4444;\n  color: white;\n  border: none;\n  border-radius: 50%;\n  width: 30px;\n  height: 30px;\n  font-size: 16px;\n  cursor: pointer;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  z-index: 2147483647;\n  pointer-events: auto;\n}\n.manga-translation-overlay {\n  position: absolute;\n  background-color: ${e?"rgba(0,0,0,0.8)":"rgba(255,255,255,0.8)"};\n  color: ${e?"#fff":"#000"};\n  border-radius: 8%;\n  padding: 4px 6px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  text-align: center;\n  font-family: 'Patrick Hand', 'Comic Neue', 'GoMono Nerd Font', 'Noto Sans', Arial;\n  z-index: 2147483647;\n  cursor: grab;\n  user-select: none;\n  transition: none;\n  box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n  pointer-events: all;\n}\n.manga-translation-overlay:hover {\n  box-shadow: 0 4px 8px rgba(0,0,0,0.3);\n}\n.manga-translation-overlay:active {\n  cursor: grabbing;\n}\n.manga-translation-overlay .resize-handle {\n  position: absolute;\n  background: transparent;\n  z-index: 2147483647;\n  transition: background-color 0.2s;\n}\n/* Handles ở các cạnh */\n.manga-translation-overlay .resize-handle.top {\n  top: -5px;\n  left: 16px; /* Thêm khoảng đệm để không chạm vào góc */\n  right: 16px;\n  height: 10px;\n  cursor: ns-resize;\n}\n.manga-translation-overlay .resize-handle.bottom {\n  bottom: -5px;\n  left: 16px;\n  right: 16px;\n  height: 10px;\n  cursor: ns-resize;\n}\n.manga-translation-overlay .resize-handle.left {\n  left: -5px;\n  top: 16px;\n  bottom: 16px;\n  width: 10px;\n  cursor: ew-resize;\n}\n.manga-translation-overlay .resize-handle.right {\n  right: -5px;\n  top: 16px;\n  bottom: 16px;\n  width: 10px;\n  cursor: ew-resize;\n}\n/* Handles ở các góc */\n.manga-translation-overlay .resize-handle.top-left {\n  top: 0;\n  left: 0;\n  width: 16px;\n  height: 16px;\n  cursor: nwse-resize;\n  transform: translate(2px, 2px);\n  border-radius: 50%; /* Bo tròn chính handle */\n}\n.manga-translation-overlay .resize-handle.top-right {\n  top: 0;\n  right: 0;\n  width: 16px;\n  height: 16px;\n  cursor: nesw-resize;\n  transform: translate(-2px, 2px);\n  border-radius: 50%;\n}\n.manga-translation-overlay .resize-handle.bottom-left {\n  bottom: 0;\n  left: 0;\n  width: 16px;\n  height: 16px;\n  cursor: nesw-resize;\n  transform: translate(2px, -2px);\n  border-radius: 50%;\n}\n.manga-translation-overlay .resize-handle.bottom-right {\n  bottom: 0;\n  right: 0;\n  width: 16px;\n  height: 16px;\n  cursor: nwse-resize;\n  transform: translate(-2px, -2px);\n  border-radius: 50%;\n}\n.manga-translation-overlay .resize-handle:hover {\n  background-color: rgba(74, 144, 226, 0.3);\n}\n`,this.shadowRoot.appendChild(n);const a=document.createElement("style");a.textContent="\nimg:hover, canvas:hover {\n  outline: 3px solid #4a90e2;\n  outline-offset: -3px;\n  cursor: pointer;\n  position: relative;\n  z-index: 2147483647;\n  pointer-events: auto;\n}\n",document.head.appendChild(a);const i=document.createElement("div");i.className="translator-overlay";const s=document.createElement("div");s.className="translator-guide",s.textContent=this._("notifications.manga_click_guide");const o=document.createElement("button");o.className="translator-cancel",o.textContent="✕";const r=document.createElement("div");r.style.cssText="\nposition: fixed;\ntop: 0;\nleft: 0;\nwidth: 100%;\nheight: 100%;\nz-index: 2147483647;\npointer-events: none;\n",this.shadowRoot.appendChild(i),this.shadowRoot.appendChild(s),this.shadowRoot.appendChild(o),this.shadowRoot.appendChild(r);let l=[],c=!1;const d=this.settings.ocrOptions?.mangaTranslateAll,p="true"===t("kingtranslator_manga_all_for_site")||!0,h=async t=>{if(!c)try{c=!0,i.classList.add("translating-done");const e=await this.detectAndTranslateMangaImage(t.target);e?.regions&&this.sortRegions(e.regions).forEach(e=>{const n=this.createMangaOverlay(e,t.target);r.appendChild(n),l.push(n)})}catch(t){this.showNotification(t.message,"error")}finally{c=!1}},g=t=>{document.removeEventListener("click",u,!0),i.classList.add("translating-done");const e=s.querySelector("button");if(this.enterMangaSelectionMode(s,e,o,l,r),t&&("IMG"===t.target.tagName||"CANVAS"===t.target.tagName)){const e=s.imageClickHandler;e&&e(t)}};let u;if(d&&p){s.textContent=this._("notifications.manga_guide_translate_all_prioritized"),u=t=>{"IMG"!==t.target.tagName&&"CANVAS"!==t.target.tagName||(t.preventDefault(),t.stopPropagation(),g(t))};const t=document.createElement("button");t.textContent=this._("notifications.manga_button_translate_single"),Object.assign(t.style,{marginLeft:"15px",padding:"5px 10px",cursor:"pointer",pointerEvents:"auto",border:"1px solid #fff",borderRadius:"5px",backgroundColor:"rgba(74, 144, 226, 0.8)",color:"white"}),t.onclick=()=>{s.textContent=this._("notifications.manga_click_guide"),t.style.display="none",document.removeEventListener("click",u,!0),document.addEventListener("click",h,{once:!0,capture:!0})},s.appendChild(t)}else if(s.textContent=this._("notifications.manga_click_guide"),u=t=>{"IMG"!==t.target.tagName&&"CANVAS"!==t.target.tagName||(t.preventDefault(),t.stopPropagation(),h(t))},d){const t=document.createElement("button");t.textContent=this._("notifications.manga_translate_all_button"),Object.assign(t.style,{marginLeft:"15px",padding:"5px 10px",cursor:"pointer",pointerEvents:"auto",border:"1px solid #fff",borderRadius:"5px",backgroundColor:"rgba(74, 144, 226, 0.8)",color:"white"}),t.onclick=g,s.appendChild(t)}document.addEventListener("click",u,!0),o.addEventListener("click",()=>{document.removeEventListener("click",u,!0),this.cleanupManga(null,l,i,s,o,n,a,r)}),this.mangaListeners={click:u,overlay:i,guide:s,cancelBtn:o,style:n,globalStyle:a,overlayContainer:r,existingOverlays:l}}enterMangaSelectionMode(t,e,n,a,i){let s=null;t.textContent=this._("notifications.manga_select_first_image"),e&&(e.style.display="none"),document.body.style.cursor="crosshair";const o=t=>{"IMG"!==t.target.tagName&&"CANVAS"!==t.target.tagName||(t.target.style.outline="3px dashed #4CAF50")},r=t=>{"IMG"!==t.target.tagName&&"CANVAS"!==t.target.tagName||(t.target.style.outline="")};document.addEventListener("mouseover",o),document.addEventListener("mouseout",r);const l=()=>{document.removeEventListener("click",c,!0),document.removeEventListener("mouseover",o),document.removeEventListener("mouseout",r),s&&(s.style.outline=""),document.body.style.cursor="default"},c=async e=>{if("IMG"===e.target.tagName||"CANVAS"===e.target.tagName)if(e.preventDefault(),e.stopPropagation(),s){const n=e.target;n.style.outline="5px solid #2196F3",l(),this.translateImageRange(s,n,i,a,t)}else s=e.target,s.style.outline="5px solid #4CAF50",t.textContent=this._("notifications.manga_select_last_image")};document.addEventListener("click",c,!0),n.onclick=()=>{l(),this.cleanupManga(this.mangaListeners.click,a,this.mangaListeners.overlay,this.mangaListeners.guide,this.mangaListeners.cancelBtn,this.mangaListeners.style,this.mangaListeners.globalStyle,this.mangaListeners.overlayContainer)}}async translateImageWithRetries(t,e=5,n=1e3){for(let a=1;a<=e;a++)try{return await this.detectAndTranslateMangaImage(t,!0)}catch(i){if(console.warn(`Attempt ${a}/${e} failed for image`,t.src,i),a===e)return console.error(`Failed to translate image after ${e} attempts.`,t.src),null;const s=n*Math.pow(2,a-1);await new Promise(t=>setTimeout(t,s))}return null}async translateImageRange(t,e,n,a,i){const s=this._;let o=t.parentElement;for(let t=0;t<10&&o&&!o.contains(e);t++)o=o.parentElement;if(!o||!o.contains(e))return this.showNotification(s("notifications.manga_common_parent_not_found"),"error"),void(i&&i.parentElement.remove());const r=Array.from(o.querySelectorAll("img, canvas")).filter(t=>{const e=t.getBoundingClientRect();return e.width>100&&e.height>100&&null!==t.offsetParent});if(0===r.length)return this.showNotification(s("logs.manga_no_images_found"),"warning"),void(i&&i.remove());const l=new Set;let c=0;const d=r.length;i&&(i.textContent=s("logs.manga_translating_progress",{current:0,total:d}));const p=async t=>{const e=await this.translateImageWithRetries(t);e?.regions&&this.sortRegions(e.regions).forEach(e=>{const i=this.createMangaOverlay(e,t);n.appendChild(i),a.push(i)}),c++,i&&(i.textContent=s("logs.manga_translating_progress",{current:c,total:d})),c===d&&setTimeout(()=>{i&&i.remove(),this.showNotification(s("logs.manga_translate_all_completed"),"success")},1e3)},h=t=>{l.has(t)||(l.add(t),p(t).catch(e=>{console.error("Lỗi khi dịch ảnh trong batch:",t.src,e),l.delete(t)}))},g=new IntersectionObserver(t=>{for(const e of t)if(e.isIntersecting){const t=e.target,n=r.indexOf(t);if(n>-1)for(let t=n;t<n+3&&t<d;t++)h(r[t])}},{rootMargin:"120% 0%",threshold:.01});r.forEach(t=>g.observe(t)),this.mangaListeners&&(this.mangaListeners.observer=g)}async detectAndTranslateMangaImage(t,e=!1){e||this.showTranslatingStatus();try{const n=document.createElement("canvas"),a=n.getContext("2d",{willReadFrequently:!0});if("IMG"===t.tagName?await this.loadImage(t,n,a):"CANVAS"===t.tagName&&await this.processCanvas(t,n,a),!a.getImageData(0,0,n.width,n.height).data.some(t=>0!==t))throw new Error(this._("notifications.cannot_capture_element"));const i=await new Promise((t,e)=>{n.toBlob(n=>n?t(n):e(new Error("Could not create blob")),"image/png")}),s=new File([i],"manga-page.png",{type:"image/png"});return await this.detectTextPositions(s,e)}catch(t){throw e||this.removeTranslatingStatus(),t}finally{e||this.removeTranslatingStatus()}}async loadImage(t,e,n){const a=t.src;if(console.log("[Manga Debug] Starting to load image from src:",a),a.startsWith("blob:"))try{return t.complete||await new Promise((e,n)=>{t.onload=e,t.onerror=n}),e.width=t.naturalWidth,e.height=t.naturalHeight,n.drawImage(t,0,0),n.getImageData(0,0,1,1),void console.log("[Manga Debug] Method 1 (Direct Draw) Succeeded.")}catch(t){console.warn("[Manga Debug] Method 1 (Direct Draw) Failed:",t.message,"Trying next method."),n.clearRect(0,0,e.width,e.height)}if(a.startsWith("data:")){console.log("[Manga Debug] Using Method 2 (Redraw via Data URL).");try{const a=document.createElement("canvas"),i=a.getContext("2d");a.width=t.naturalWidth,a.height=t.naturalHeight,i.drawImage(t,0,0);const s=a.toDataURL("image/png");if(s.length<100)throw new Error("Failed to create a valid Data URL.");return await this.drawImageFromBlob(s,e,n),void console.log("[Manga Debug] Method 2 (Redraw via Data URL) Succeeded.")}catch(t){console.warn("[Manga Debug] Method 2 (Redraw via Data URL) Failed:",t.message,"Trying next method."),n.clearRect(0,0,e.width,e.height)}}console.log("[Manga Debug] Using Method 3 (GM_xmlhttpRequest Fallback).");try{const t=await this.fetchImageViaGM2(a);return console.log(`[Manga Debug] Successfully reconstructed blob via GM_xmlhttpRequest. Size: ${t.size}`),await this.drawImageFromBlob(t,e,n),void console.log("[Manga Debug] Method 3 (GM_xmlhttpRequest Fallback) Succeeded.")}catch(t){throw console.error("[Manga Debug] All methods failed to load image.",t),new Error(`Could not load image from src: ${a}. Reason: ${t.message}`)}}async drawImageFromBlob(t,e,n){return new Promise((a,i)=>{const s=new Image;s.onload=()=>{e.width=s.naturalWidth,e.height=s.naturalHeight,n.drawImage(s,0,0),URL.revokeObjectURL(s.src),a()},s.onerror=t=>{console.error("Error in drawImageFromBlob:",t),i(new Error("Could not draw image from blob/data URL."))},s.src="string"==typeof t?t:URL.createObjectURL(t)})}async fetchImageViaGM2(t){return new Promise((e,n)=>{GM_xmlhttpRequest({method:"GET",url:t,headers:{"User-Agent":navigator.userAgent,"Accept-Language":"en-US,vi;q=0.5",Connection:"keep-alive",Referer:window.location.href,"X-Requested-With":"XMLHttpRequest","Sec-Fetch-Mode":"no-cors","Sec-Fetch-Site":"cross-site",Priority:"u=5, i",Pragma:"no-cache","Cache-Control":"no-cache"},overrideMimeType:"text/plain; charset=x-user-defined",responseType:"text",anonymous:!0,onload:function(t){if(t.status>=200&&t.status<300){const a=t.responseText,i=new Uint8Array(a.length);for(let t=0;t<a.length;t++)i[t]=255&a.charCodeAt(t);let s="image/png";const o=t.responseHeaders.match(/content-type:\s*(.*)/i);o&&o[1]&&(s=o[1].trim());const r=new Blob([i],{type:s});if(r.size<100)return n(new Error("Reconstructed blob is too small."));e(r)}else n(new Error(`Request failed with status ${t.status}.`))},onerror:t=>n(new Error(`Network error: ${t.statusText}`))})})}async processCanvas(t,e,n){try{e.width=t.width,e.height=t.height;const a=t.getContext("2d",{willReadFrequently:!0});try{const e=a.getImageData(0,0,t.width,t.height);n.putImageData(e,0,0)}catch(t){if("SecurityError"===t.name)throw new Error(this._("notifications.canvas_security_error"));throw t}}catch(t){throw new Error(`Error processing canvas: ${t.message}`)}}sortRegions(t){const e=(t=>{const e=[],n=new Set;return t.forEach((a,i)=>{if(n.has(i))return;const s=[a];n.add(i),t.forEach((t,e)=>{i===e||n.has(e)||Math.sqrt(Math.pow(a.position.x-t.position.x,2)+Math.pow(a.position.y-t.position.y,2))<=20&&(s.push(t),n.add(e))}),e.push(s)}),e})(t);return e.sort((t,e)=>{const n=t.reduce((t,e)=>t+e.position.y,0)/t.length,a=e.reduce((t,e)=>t+e.position.y,0)/e.length;if(Math.abs(n-a)<20){console.log("phai sang trai");const n=t.reduce((t,e)=>t+e.position.x,0)/t.length;return e.reduce((t,e)=>t+e.position.x,0)/e.length-n}return console.log("trai sang phai"),n-a}).flat()}cleanupManga(t,e,...n){this.mangaListeners?.observer&&this.mangaListeners.observer.disconnect(),document.removeEventListener("click",t,!0),e.forEach(t=>{t.cleanup&&t.cleanup(),t.remove()}),n.forEach(t=>t.remove())}async detectTextPositions(t,e=!1){try{const n=this.settings.displayOptions.targetLanguage,a=document.title?`from content titled "${document.title}"`:"",i=`Analyze this comic/manga/manhua/manhwa image ${a} with special attention to edge regions and partial text bubbles:\n1. Text Detection (Enhanced Edge Detection):\n  - Identify ALL text regions, especially focusing on:\n    * Partial/cut-off speech bubbles at image edges\n    * Text that touches or intersects image boundaries\n    * Small or partially visible text elements\n    * Overlapping or merged text regions\n    * Semi-transparent or low-contrast text areas\n  - Scan image edges with higher sensitivity\n  - Consider incomplete speech bubbles as valid regions\n  - Check corners and borders thoroughly\n  - Detect text fragments and reconstruct possible complete phrases\n2. Position Analysis (Edge-Aware):\n  - x: percentage from left (0-100, allow partial <0 or >100 for edge cases)\n  - y: percentage from top (0-100, allow partial <0 or >100 for edge cases)\n  - width: percentage of image width (adjust for partial bubbles)\n  - height: percentage of image height (adjust for partial bubbles)\n  - edge_detection: true/false (indicates if text touches image boundary)\n  - completion_status: complete/partial (indicates if bubble/text is cut off)\n  - boundary_position: none/left/right/top/bottom/corner (where text touches edge)\n3. Text Extraction Rules:\n  - Extract text even if bubble is partially visible\n  - Reconstruct cut-off characters if possible\n  - Consider context for incomplete words\n  - Maintain reading order even for partial text\n  - Handle text that crosses multiple bubbles\n  - Account for perspective and rotation\n4. Translation Requirements:\n  You are a professional comic/novel translator, specializing in creating accurate and natural translations. You need to translate the text ${a} into the language with code '${n}'. Ensure your translation:\n    - Maintains original meaning and context\n    - Fits the target language style\n    - Considers cultural context and story background\n  Important Translation Rules:\n    - Target language: '${n}'\n    - Keep sentence meanings unchanged\n    - Use appropriate slang or common phrases when needed\n    - Ensure correct spelling and grammar\n    - Add necessary language particles for '${n}' when needed\n    - Use contextually appropriate pronouns\n    - For adult content style reference: [ truyensex.moe, truyensexvn.org, truyensex.vip, truyensextv69.com ]\n  Special handling for Vietnamese translations:\n    - Keep Sino-Vietnamese forms for proper names/locations (e.g. "Diệp Trần, Long kiếm, Thiên kiếp")\n    - Avoid direct translations (e.g. NOT "Lá Trần, Rồng kiếm, Trời kiếp")\n  Other considerations:\n    - Adapt names/terms for target language conventions\n    - Respect text length and bubble space constraints\n    - Maintain comic style and tone\n    - Adapt sound effects appropriately\n    - Keep cultural references understandable\n    - Consider the context and theme ${a}\n5. Position Analysis (CRITICAL):\n  - x: exact percentage from left (0-100)\n  - y: exact percentage from top (0-100)\n  - width: exact percentage of image width (0-100)\n  - height: exact percentage of image height (0-100)\n  - text_length: character count for spacing\n  - text_lines: number of lines in region\n  - text_type: dialogue/narration/sfx/note\n  - container_type: bubble/caption/free/background\n  - container_shape: round/square/jagged/custom\n  - font_size: small/medium/large\n  - layout_direction: horizontal/vertical/custom\n  - text_style: "regular"\n\nReturn JSON object with this structure:\n{\n  "regions": [{\n    "text": "original text",\n    "translation": "translated text",\n    "position": {\n      "x": 20.5,\n      "y": 30.2,\n      "width": 15.3,\n      "height": 10.1,\n      "text_length": 25,\n      "text_lines": 2,\n      "edge_detection": true,\n      "completion_status": "partial",\n      "boundary_position": "right",\n      "text_type": "dialogue",\n      "container_type": "bubble",\n      "container_shape": "round",\n      "font_size": "medium",\n      "layout_direction": "horizontal",\n      "text_style": "regular"\n    }\n  }]\n}\n\nCRITICAL: The final output MUST be a single, valid JSON object. Ensure all strings within the JSON are properly escaped. Do not add any text, comments, or markdown formatting (DO NOT like \`\`\`json) before or after the JSON.\n`,s=await this.ocr.processImage(t,i,e);if(console.log("response: ",s),s){const t=s.match(/\{[\s\S]*\}/);if(t){const e=t[0].replace(/\\(?!["\\/bfnrt]|u[0-9a-fA-F]{4})/g,"\\\\"),n=JSON.parse(e);if(n&&n.regions){const t=t=>{const e=[],n=new Set,a=[...t].sort((t,e)=>t.position.y!==e.position.y?t.position.y-e.position.y:t.position.x-e.position.x),i=(t,e)=>!(t.position.x+t.position.width<e.position.x||e.position.x+e.position.width<t.position.x||t.position.y+t.position.height<e.position.y||e.position.y+e.position.height<t.position.y);for(let t=0;t<a.length;t++){if(n.has(t))continue;const s=[],o=[t];for(n.add(t);o.length>0;){const t=a[o.shift()];s.push(t);for(let e=0;e<a.length;e++)!n.has(e)&&i(t,a[e])&&(n.add(e),o.push(e))}s.sort((t,e)=>t.position.y!==e.position.y?t.position.y-e.position.y:t.position.x-e.position.x);const r={text:s.map(t=>t.text).join(" "),translation:s.map(t=>t.translation).join(" "),position:{x:Math.min(...s.map(t=>t.position.x)),y:Math.min(...s.map(t=>t.position.y)),width:Math.max(...s.map(t=>t.position.x+t.position.width))-Math.min(...s.map(t=>t.position.x)),height:Math.max(...s.map(t=>t.position.y+t.position.height))-Math.min(...s.map(t=>t.position.y)),text_type:s[0].position.text_type,container_type:s[0].position.container_type,container_shape:s[0].position.container_shape,font_size:s[0].position.font_size,layout_direction:s[0].position.layout_direction,text_style:s[0].position.text_style}};e.push(r)}return e};return n.regions=t(n.regions),n}}throw new Error("Invalid response format")}throw new Error("No response from API")}catch(t){throw console.error("Text detection error:",t),t}}getBrowserContextMenuSize(){const t=navigator.userAgent;let e;e=t.includes("Firefox")?{width:275,height:340,itemHeight:34}:t.includes("Safari")&&!t.includes("Chrome")?{width:240,height:300,itemHeight:30}:t.includes("Edge")?{width:260,height:330,itemHeight:33}:{width:250,height:320,itemHeight:32};const n=window.devicePixelRatio||1;return{width:Math.round(e.width*n),height:Math.round(e.height*n),itemHeight:Math.round(e.itemHeight*n)}}setupContextMenu(){this.settings.contextMenu?.enabled&&document.addEventListener("contextmenu",t=>{const e=window.getSelection(),n=e.toString().trim();if(n){this.$$(".translator-context-menu").forEach(t=>t.remove());const a=document.createElement("div");a.className="translator-context-menu";const s=[{text:this._("settings.quick_translate_shortcut"),action:"quick"},{text:this._("settings.popup_translate_shortcut"),action:"popup"},{text:this._("settings.advanced_translate_shortcut"),action:"advanced"},{text:this._("notifications.play_tts"),action:"tts",getLabel:()=>this.isTTSSpeaking?this._("notifications.stop_tts"):this._("notifications.play_tts")}],o=e.getRangeAt(0).cloneRange();s.forEach(t=>{const e=document.createElement("div");e.className="translator-context-menu-item",e.textContent=t.getLabel?t.getLabel():t.text,e.onclick=i=>{i.preventDefault(),i.stopPropagation();const s=window.getSelection();if(s.removeAllRanges(),s.addRange(o),"tts"===t.action){if(this.isTTSSpeaking)this.stopTTS(),this.isTTSSpeaking=!1;else{const t=this.settings.displayOptions,a="auto"===t.sourceLanguage?this.page.languageCode:t.sourceLanguage,i=this.settings.ttsOptions.defaultSpeed,s=this.settings.ttsOptions.defaultVolume,o=this.settings.ttsOptions.defaultPitch;this.selectSource=this.settings.ttsOptions?.defaultProvider||"google","openai"===this.selectSource?(this.selectVoice=this.settings.ttsOptions?.defaultVoice?.[this.selectSource]?.voice||"sage",this.selectVoice={name:this.selectVoice}):"google"===this.selectSource?this.selectVoice=this.settings.ttsOptions?.defaultVoice?.[this.selectSource]?.[a]||null:this.selectVoice=null,this.voiceStorage[this.selectSource]={voice:this.selectVoice},this.playTTS(n,this.selectVoice.name,a,{speedValue:i,pitchValue:o,volumeValue:s},null,!1,e)}this.onSpeechEndCallback(e)}else this.handleTranslateButtonClick(s,t.action),a.remove()},a.appendChild(e)});const r=window.innerWidth,l=window.innerHeight,c=150,d=40*s.length,p=this.getBrowserContextMenuSize(),h=p.width,g=p.height,u=h+c,m=r-t.clientX,y=r-c,f=l-d,v=r-h,b=l-g;let _,x;t.clientX<c&&t.clientY<d?(_=t.clientX+h+10,x=t.clientY):t.clientX>v&&t.clientY<g?(_=t.clientX-u+m,x=t.clientY):t.clientX>v&&t.clientY>l-g?(_=t.clientX-u+m,x=t.clientY-d):t.clientX<c&&t.clientY>l-g?(_=t.clientX+h+10,x=t.clientY-d):t.clientY<d?(_=t.clientX-c,x=t.clientY):t.clientX>v?(_=t.clientX-u+m,x=t.clientY):t.clientY>b-d/2?(_=t.clientX-c,x=t.clientY-d):(_=t.clientX,x=t.clientY-d),_=Math.max(5,Math.min(_,y-5)),x=Math.max(5,Math.min(x,f-5)),a.style.left=`${_}px`,a.style.top=`${x}px`,this.shadowRoot.appendChild(a);const S=t=>{a.contains(t.target)||(speechSynthesis.cancel(),a.remove(),document.removeEventListener("click",S))};document.addEventListener("click",S);const w=i(()=>{speechSynthesis.cancel(),a.remove(),window.removeEventListener("scroll",w)},150);window.addEventListener("scroll",w,{passive:!0})}})}onSpeechEndCallback(t){t&&(t.textContent=this.isTTSSpeaking?this._("notifications.stop_tts"):this._("notifications.play_tts"))}removeWebImageListeners(){this.webImageListeners&&(document.removeEventListener("mouseover",this.webImageListeners.hover,!0),document.removeEventListener("mouseout",this.webImageListeners.leave,!0),document.removeEventListener("click",this.webImageListeners.click,!0),this.webImageListeners.overlay?.remove(),this.webImageListeners.guide?.remove(),this.webImageListeners.cancelBtn?.remove(),this.webImageListeners.style?.remove(),document.querySelectorAll(".translator-image-highlight").forEach(t=>{t.classList.remove("translator-image-highlight")}),this.webImageListeners=null)}handleSettingsShortcut(t){if(this.settings.shortcuts?.settingsEnabled&&(t.altKey||t.metaKey)&&"s"===t.key){t.preventDefault();const e=this.translator.userSettings.createSettingsUI();this.shadowRoot.appendChild(e)}}async handleTranslationShortcuts(t){if(!this.settings.shortcuts?.enabled)return;const e=this.settings.shortcuts;if(t.altKey||t.metaKey){let n=null;if(t.key===e.ocrRegion.key){t.preventDefault();try{const t=await this.ocr.captureScreen();if(!t)return;this.showTranslatingStatus();const e=await this.ocr.processImage(t);this.removeTranslatingStatus(),e&&this.formatTrans(e)}catch(t){this.showNotification(t.message,"error"),this.removeTranslatingStatus()}return}if(t.key===e.ocrWebImage.key)return t.preventDefault(),void this.startWebImageOCR();if(t.key===e.ocrMangaWeb.key)return t.preventDefault(),void this.startMangaTranslation();if(t.key===e.pageTranslate.key)return t.preventDefault(),void await this.handlePageTranslation();if(t.key===e.inputTranslate.key){t.preventDefault();const e=document.activeElement;return void(this.translator.input.isValidEditor(e)&&this.translator.input.getEditorContent(e)&&await this.translator.input.translateEditor(e,!0))}const a=window.getSelection(),i=a?.toString().trim();if(!i)return;const s=a.anchorNode?.parentElement;if(!s)return;t.key===e.quickTranslate.key?(t.preventDefault(),n="quick"):t.key===e.popupTranslate.key?(t.preventDefault(),n="popup"):t.key===e.advancedTranslate.key&&(t.preventDefault(),n="advanced"),n&&await this.handleTranslateButtonClick(a,n)}}async handleGeminiFileOrUrlTranslation(){const t=this.translator,e=this._;if("gemini"!==this.settings.apiProvider)return void this.showNotification(e("notifications.only_gemini"),"warning");const n=["image/*","audio/*","video/*",".pdf",".txt",".json",".html",".xml",".csv",".md",".doc",".docx",".ppt",".pptx",".xls",".xlsx"].join(",");await function(t,e){return new Promise(n=>{const a=window.translator,i=a.userSettings._,s=a.userSettings.settings.theme,r=o.THEME[s],l="dark"===s,c=document.createElement("div");c.style.cssText='\nposition: fixed;\ntop: 0;\nleft: 0;\nwidth: 100vw;\nheight: 100vh;\nbackground: rgba(0,0,0,0.5);\nz-index: 2147483647;\ndisplay: flex;\njustify-content: center;\nalign-items: center;\nfont-family: "GoMono Nerd Font", "Noto Sans", Arial;\n';const d=document.createElement("div");d.style.cssText=`\nbackground: ${r.background};\npadding: 20px;\nborder-radius: 12px;\nbox-shadow: 0 4px 20px rgba(0,0,0,0.2);\ndisplay: flex;\nflex-direction: column;\ngap: 15px;\nmin-width: 350px;\nmax-width: 90vw;\nborder: 1px solid ${r.border};\ncolor: ${r.text};\n`;const p=document.createElement("div");p.style.cssText=`\ncolor: ${r.title};\nfont-size: 16px;\nfont-weight: bold;\ntext-align: center;\nmargin-bottom: 5px;\n`,p.textContent=i("notifications.file_input_title");const h=document.createElement("div");h.style.cssText="\ndisplay: flex;\njustify-content: center;\nmargin-bottom: 15px;\ngap: 10px;\n";const g=document.createElement("button");g.textContent="File Local",g.style.cssText=`\npadding: 8px 15px;\nborder-radius: 8px;\nborder: 1px solid ${r.border};\nbackground: ${l?"#444":"#eee"};\ncolor: ${r.text};\ncursor: pointer;\nfont-size: 14px;\nfont-family: inherit;\ntransition: all 0.2s ease;\n`;const u=document.createElement("button");u.textContent="URL",u.style.cssText=g.style.cssText,h.appendChild(g),h.appendChild(u);const m=document.createElement("div");m.style.cssText="\ndisplay: flex;\nflex-direction: column;\ngap: 10px;\nalign-items: center;\n";const y=document.createElement("input");y.type="file",y.accept=t,y.style.cssText=`\npadding: 8px;\nborder-radius: 8px;\nborder: 1px solid ${r.border};\nbackground: ${l?"#444":"#fff"};\ncolor: ${r.text};\nwidth: 100%;\ncursor: pointer;\nfont-family: inherit;\nfont-size: 14px;\n`;const f=document.createElement("div");f.style.cssText="\ndisplay: none; /* Hidden by default */\nflex-direction: column;\ngap: 10px;\nalign-items: center;\n";const v=document.createElement("div");v.textContent=i("notifications.file_input_url_title"),v.style.cssText=`color: ${r.text}; font-size: 14px;`;const b=document.createElement("input");b.type="text",b.placeholder=i("notifications.file_input_url_placeholder"),b.style.cssText=`\npadding: 8px;\nborder-radius: 8px;\nborder: 1px solid ${r.border};\nbackground: ${l?"#444":"#fff"};\ncolor: ${r.text};\nwidth: 100%;\nfont-family: inherit;\nfont-size: 14px;\n`,f.appendChild(v),f.appendChild(b);const _=document.createElement("div");_.style.cssText="\ndisplay: flex;\ngap: 10px;\njustify-content: center;\nmargin-top: 10px;\n";const x=document.createElement("button");x.style.cssText=`\npadding: 8px 16px;\nborder-radius: 8px;\nborder: none;\nbackground: ${r.button.close.background};\ncolor: ${r.button.close.text};\ncursor: pointer;\nfont-size: 14px;\ntransition: all 0.2s ease;\nfont-family: inherit;\n`,x.textContent=i("settings.cancel"),x.onmouseover=()=>{x.style.transform="translateY(-2px)",x.style.boxShadow="0 2px 4px rgba(0,0,0,0.2)"},x.onmouseout=()=>{x.style.transform="none",x.style.boxShadow="none"};const S=document.createElement("button");S.style.cssText=`\npadding: 8px 16px;\nborder-radius: 8px;\nborder: none;\nbackground: ${r.button.translate.background};\ncolor: ${r.button.translate.text};\ncursor: pointer;\nfont-size: 14px;\ntransition: all 0.2s ease;\nopacity: 0.5;\nfont-family: inherit;\n`,S.textContent=i("notifications.translate"),S.disabled=!0,S.onmouseover=()=>{S.disabled||(S.style.transform="translateY(-2px)",S.style.boxShadow="0 2px 4px rgba(0,0,0,0.2)")},S.onmouseout=()=>{S.style.transform="none",S.style.boxShadow="none"};const w=()=>{const t=y.files?.[0],e=b.value.trim().startsWith("http://")||b.value.trim().startsWith("https://");S.disabled=!(t||e),S.style.opacity=t||e?"1":"0.5"};let T="file";const k=t=>{T=t,"file"===t?(m.style.display="flex",f.style.display="none",g.style.backgroundColor=l?"#666":"#ccc",u.style.backgroundColor=l?"#444":"#eee"):(m.style.display="none",f.style.display="flex",u.style.backgroundColor=l?"#666":"#ccc",g.style.backgroundColor=l?"#444":"#eee"),w()};g.addEventListener("click",()=>k("file")),u.addEventListener("click",()=>k("url")),y.addEventListener("change",w),b.addEventListener("input",w);const E=()=>{c.remove(),n()};x.addEventListener("click",E),S.addEventListener("click",async()=>{if("file"===T){const t=y.files?.[0];if(t){try{S.disabled=!0,S.style.opacity="0.5",S.textContent=i("notifications.processing"),await e(t)}catch(t){console.error("Error processing file:",t)}E()}}else{const t=b.value.trim();if(t.startsWith("http://")||t.startsWith("https://")){try{S.disabled=!0,S.style.opacity="0.5",S.textContent=i("notifications.processing_url"),await e(t)}catch(t){console.error("Error processing URL:",t)}E()}else a.ui.showNotification(i("notifications.invalid_url_format"),"error"),S.disabled=!1,S.style.opacity="1"}}),_.appendChild(x),_.appendChild(S),m.appendChild(y),d.appendChild(p),d.appendChild(h),d.appendChild(m),d.appendChild(f),d.appendChild(_),c.appendChild(d),a.uiRoot.getRoot().appendChild(c),c.addEventListener("click",t=>{t.target===c&&E()}),k("file")})}(n,async n=>{try{t.ui.showTranslatingStatus();const e=t.createPrompt("","file_content");console.log("prompt: ",e);const a=await t.fileProcess.processFile(n,e),i=await t.api.request(a.content,"ocr",a.key);t.ui.removeTranslatingStatus(),t.ui.formatTrans(i)}catch(n){console.error("Lỗi dịch file/URL bằng Gemini:",n),t.ui.showNotification(e("notifications.generic_translation_error")+n.message,"error")}finally{t.ui.removeTranslatingStatus()}})}updateSettingsListener(t){t?document.addEventListener("keydown",this.settingsShortcutListener):document.removeEventListener("keydown",this.settingsShortcutListener)}updateSettingsTranslationListeners(t){t?document.addEventListener("keydown",this.translationShortcutListener):document.removeEventListener("keydown",this.translationShortcutListener)}updateSelectionListeners(t){t&&this.setupSelectionHandlers()}updateTapListeners(t){t&&this.setupDocumentTapHandler()}setupEventListeners(){this.updateSettingsListener(!1),this.updateSettingsTranslationListeners(!1),this.updateSelectionListeners(!1),this.updateTapListeners(!1),this.translator.input&&this.translator.input.cleanup();const e=this.settings.shortcuts,a=this.settings.clickOptions,i=this.settings.touchOptions;this.settings.contextMenu?.enabled&&this.setupContextMenu(),e?.settingsEnabled&&this.updateSettingsListener(!0),e?.enabled&&this.updateSettingsTranslationListeners(!0),a?.enabled&&(this.updateSelectionListeners(!0),this.translationButtonEnabled=!0),i?.enabled&&(this.updateTapListeners(!0),this.translationTapEnabled=!0),this.translator.input=new h(this.translator);let s=!1;null===t("translatorToolsEnabled")&&t("translatorToolsEnabled"),"true"===t("translatorToolsEnabled")&&(s=!0),this.settings.translatorTools?.enabled&&s&&this.setupTranslatorTools(),this._hasSettingsChangedListener||(this.container.addEventListener("settingsChanged",e=>{this.removeToolsContainer();const a=e.detail;this.settings=a,this.updateSettingsListener(a.shortcuts?.settingsEnabled),this.updateSettingsTranslationListeners(a.shortcuts?.enabled),void 0!==a.clickOptions?.enabled&&(this.translationButtonEnabled=a.clickOptions.enabled,this.updateSelectionListeners(a.clickOptions.enabled),a.clickOptions.enabled||this.removeTranslateButton()),void 0!==a.touchOptions?.enabled&&(this.translationTapEnabled=a.touchOptions.enabled,this.updateTapListeners(a.touchOptions.enabled),a.touchOptions.enabled||this.removeTranslateButton()),this.translator?.cache&&this.translator.cache.clear(),this.translator?.imageCache&&this.translator.imageCache.clear(),this.translator?.mediaCache&&this.translator.mediaCache.clear(),this.translator?.ttsCache&&this.translator.ttsCache.clear();const i={providers:o.API.providers,currentProvider:a.apiProvider,apiKey:a.apiKey,maxRetries:o.API.maxRetries,retryDelay:o.API.retryDelay};this.translator.api=new p(i,()=>this.settings);let s=!1;null===t("translatorToolsEnabled")&&t("translatorToolsEnabled"),"true"===t("translatorToolsEnabled")&&(s=!0),this.settings.translatorTools?.enabled&&s&&this.setupTranslatorTools(),a.inputTranslation.savePosition||n("translatorButtonPosition")}),this._hasSettingsChangedListener=!0)}showNotification(t,e="info"){const n=document.createElement("div");n.className="translator-notification";const a={info:"#4a90e2",success:"#28a745",warning:"#ffc107",error:"#dc3545"},i=a[e]||a.info,s="warning"===e?"#000":"#fff";Object.assign(n.style,{position:"fixed",top:"20px",left:window.innerWidth/2+"px",transform:"translateX(-50%)",backgroundColor:i,color:s,padding:"10px 20px",borderRadius:"8px",zIndex:"2147483647",animation:"fadeInOut 2s ease",fontFamily:"'GoMono Nerd Font', 'Noto Sans', Arial",fontSize:"14px",boxShadow:"0 2px 10px rgba(0,0,0,0.2)"}),n.innerText=t,this.shadowRoot.appendChild(n),setTimeout(()=>n.remove(),5e3)}resetState(){this.pressTimer&&clearTimeout(this.pressTimer),this.timer&&clearTimeout(this.timer),this.isLongPress=!1,this.lastTime=0,this.count=0,this.isDown=!1,this.ignoreNextSelectionChange=!1,this.removeTranslateButton(),this.removeTranslatingStatus()}removeTranslateButton(){if(this.currentTranslateButton){const t=this.$(".translator-button");t&&t.remove(),this.currentTranslateButton=null}}removeTranslatingStatus(){this.translatingStatus&&(this.translatingStatus.remove(),this.translatingStatus=null);const t=this.$(".center-translate-status");t&&t.remove()}cleanup(){document.removeEventListener("click",this.handleClickOutside),document.removeEventListener("keydown",this.settingsShortcutListener),document.removeEventListener("keydown",this.translationShortcutListener),document.removeEventListener("mousedown",this.setupSelectionHandlers),document.removeEventListener("mousemove",this.setupSelectionHandlers),document.removeEventListener("mouseup",this.setupSelectionHandlers),document.removeEventListener("touchend",this.setupSelectionHandlers),this._touchStartHandler&&(document.removeEventListener("touchstart",this._touchStartHandler,{passive:!1}),document.removeEventListener("touchend",this._touchEndHandler),document.removeEventListener("touchcancel",this._touchEndHandler),this._touchStartHandler=null,this._touchEndHandler=null),this.removeTranslateButton(),this.removeTranslatingStatus(),this.removeToolsContainer(),this.removeWebImageListeners(),this.mangaListeners&&(this.cleanup(this.mangaListeners.click,this.mangaListeners.existingOverlays,this.mangaListeners.overlay,this.mangaListeners.guide,this.mangaListeners.cancelBtn,this.mangaListeners.style,this.mangaListeners.globalStyle,this.mangaListeners.overlayContainer),this.mangaListeners=null),this.$$(".translator-popup").forEach(t=>{t.cleanup&&t.cleanup(),t.remove()}),this.container&&this.container.parentNode&&this.container.remove(),this.shadowRoot=null,this.container=null}}class T{constructor(){window.translatorInstance&&(window.translatorInstance.cleanup(),window.translatorInstance=null),window.translator=this,this.userSettings=new c(this),this._=this.userSettings._;const t={...o.API,currentProvider:this.userSettings.getSetting("apiProvider"),apiKey:this.userSettings.getSetting("apiKey")};this.cache=new f("textCache",this.userSettings.settings.cacheOptions.text.maxSize,this.userSettings.settings.cacheOptions.text.expirationTime),this.imageCache=new f("imageCache",this.userSettings.settings.cacheOptions.image.maxSize,this.userSettings.settings.cacheOptions.image.expirationTime),this.mediaCache=new f("mediaCache",this.userSettings.settings.cacheOptions.media.maxSize,this.userSettings.settings.cacheOptions.media.expirationTime),this.ttsCache=new f("ttsCache",this.userSettings.settings.cacheOptions.tts.maxSize,this.userSettings.settings.cacheOptions.tts.expirationTime),this.uiRoot=new S(this),this.fileProcess=new b(this),this.videoStreaming=new m(this),this.api=new p(t,()=>this.userSettings.settings,this.userSettings._),this.page=new y(this),this.input=new h(this),this.ocr=new g(this),this.media=new u(this),this.fileManager=new x(this),this.ui=new w(this)}async translate(t,e,n=!1,a=!1,i=""){try{if(!t)return null;const s=this.userSettings.settings.displayOptions,o=i||s.targetLanguage,r=n?"advanced":"normal",l=this.createPrompt(t,r,o);let c;console.log("prompt: ",l);const d=this.userSettings.settings.cacheOptions.text.enabled;if(d&&(c=await this.cache.get(t,n,o)),c||(c=await this.api.request(l,"page"),d&&c&&await this.cache.set(t,c,n,o)),c&&e&&!e.isPDFTranslation)if(n||a)if("translation_only"!==s.translationMode){const e=c.split("\n");let n="",a="";for(const t of e){const e=t.split("<|>");a+=(e[1]||"")+"\n",n+=(e[2]||t.replace("<|>",""))+"\n"}this.ui.displayPopup(n,t,"King1x32 <3",a)}else this.ui.displayPopup(c,"","King1x32 <3");else this.ui.showTranslationBelow(c,e,t);return c}catch(t){console.error("Error translation:",t),this.ui.showNotification(t.message,"error")}}async translateFile(t){try{if(!this.fileManager.isValidFormat(t))throw new Error(this._("notifications.unsupport_file")+" txt, srt, vtt, pdf, html, md, json");if(!this.fileManager.isValidSize(t))throw new Error(this._("notifications.file_too_large"));return await this.fileManager.processFile(t)}catch(t){throw new Error(this._("notifications.file_translation_error")+` ${t.message}`)}}createPrompt(t,e="normal",n=""){const a=`"${document.title}"`,i=this.userSettings.settings,s=n||i.displayOptions.targetLanguage,o="auto"===i.displayOptions.sourceLanguage?this.page.languageCode:i.displayOptions.sourceLanguage,r="translation_only"!==i.displayOptions.translationMode;if(i.promptSettings?.enabled&&i.promptSettings?.useCustom){let n=i.promptSettings.customPrompts[r?`${e}_chinese`:e];if(n)return n.replace(/{text}/g,t).replace(/{docTitle}/g,a).replace(/{targetLang}/g,s).replace(/{sourceLang}/g,o||this.page.languageCode)}return this.createDefaultPrompt(t,e,r,s)}createDefaultPrompt(t,e="normal",n=!1,a=""){const i=`và tiêu đề "${document.title}"`||"",s=this.userSettings.settings,o=a||s.displayOptions.targetLanguage,r=`  - Ngôn ngữ đích: '${o}'.\n  - Dựa vào ngữ cảnh, bối cảnh ${i} để xác định phong cách dịch.\n  - Đảm bảo nghĩa của các câu không bị thay đổi khi dịch.\n  - Sử dụng các từ lóng hoặc cụm từ thông dụng khi cần thiết để bản dịch gần gũi với người đọc.\n  - Kiểm tra chính tả và ngữ pháp trong bản dịch.\n  - Thêm các trợ từ ngôn ngữ có mã ngôn ngữ là '${o}' khi cần để câu văn hoàn chỉnh hơn.\n  - Sử dụng đại từ nhân xưng ngôn ngữ có mã ngôn ngữ là '${o}' tự nhiên và hợp ngữ cảnh.\n  - Tham khảo các trang web sau để lấy văn phong phù hợp cho các đoạn truyện liên quan đến sex: [ truyensex.moe, truyensexvn.org, truyensex.vip, truyensextv69.com ].\n`,l=`Bạn là người dịch thuật chuyên nghiệp, chuyên tạo bản dịch chính xác và tự nhiên. Hãy dịch văn bản cần xử lý ${i} sang ngôn ngữ có mã ngôn ngữ là '${o}' với các yêu cầu sau:\n  - Ngôn ngữ đích: '${o}'.\n  - Dựa vào ngữ cảnh, bối cảnh ${i} để xác định phong cách dịch.\n  - Dịch phải tuân thủ chặt chẽ bối cảnh và sắc thái ban đầu của văn bản.\n  - Đảm bảo sự lưu loát và tự nhiên như người bản xứ.\n  - Không thêm bất kỳ giải thích hay diễn giải nào ngoài bản dịch.\n  - Bảo toàn các thuật ngữ và danh từ riêng với tỷ lệ 1:1.\nNếu bạn nhận thấy văn bản là truyện thì hãy dịch truyện theo yêu cầu sau:\n  Bạn là một người dịch truyện chuyên nghiệp, chuyên tạo bản dịch chính xác và tự nhiên. Bạn cần dịch một đoạn truyện ${i} sang ngôn ngữ có mã ngôn ngữ là '${o}'. Hãy đảm bảo rằng bản dịch của bạn giữ nguyên ý nghĩa của câu gốc và phù hợp với văn phong của ngôn ngữ đích. Khi dịch, hãy chú ý đến ngữ cảnh văn hóa và bối cảnh của câu chuyện để người đọc có thể hiểu chính xác nội dung. Các quy tắc quan trọng bạn cần tuân thủ bao gồm:\n${r}\n`,c=`Văn bản cần dịch:\n\`\`\`\n  ${t}\n\`\`\`\n`,d=`Bạn là một người dịch truyện chuyên nghiệp, chuyên tạo bản dịch chính xác và tự nhiên. Bạn cần dịch một đoạn truyện ${i} sang ngôn ngữ có mã ngôn ngữ là '${o}'. Hãy đảm bảo rằng bản dịch của bạn giữ nguyên ý nghĩa của câu gốc và phù hợp với văn phong của ngôn ngữ đích. Khi dịch, hãy chú ý đến ngữ cảnh văn hóa và bối cảnh của câu chuyện để người đọc có thể hiểu chính xác nội dung. Các quy tắc quan trọng bạn cần tuân thủ bao gồm:\n${r}\n`,p=`Bạn là một người dịch phụ đề phim chuyên nghiệp, chuyên tạo file SRT. Bạn cần dịch một đoạn hội thoại phim ${i} sang ngôn ngữ có mã ngôn ngữ là '${o}'. Hãy đảm bảo rằng bản dịch của bạn chính xác và tự nhiên, giữ nguyên ý nghĩa của câu gốc. Khi dịch, hãy chú ý đến ngữ cảnh văn hóa và bối cảnh của bộ phim để người xem có thể hiểu chính xác nội dung. Các quy tắc quan trọng bạn cần tuân thủ bao gồm:\n${r}\n`,h=`\nHãy trả về theo format sau, mỗi phần cách nhau bằng dấu <|> và không giải thích thêm:\n  Văn bản gốc <|> phiên âm IPA <|> bản dịch sang ngôn ngữ có mã ngôn ngữ là '${o}'\n  Ví dụ: Hello <|> heˈloʊ <|> Xin chào\n`,g=`Lưu ý:\n  - Nếu có từ là tiếng Trung, hãy trả về giá trị phiên âm của từ đó chính là pinyin + số tone (1-4) của từ đó. Ví dụ: 你好 <|> Nǐ3 hǎo3 <|> Xin chào\n  - Bản dịch phải hoàn toàn là ngôn ngữ có mã ngôn ngữ là '${o}', nhưng ví dụ khi dịch sang tiếng Việt nếu gặp những danh từ riêng chỉ địa điểm hoặc tên riêng, có phạm trù trong ngôn ngữ là từ ghép của 2 ngôn ngữ gọi là từ Hán Việt, hãy dịch sang nghĩa từ Hán Việt như Diệp Trần, Lục Thiếu Du, Long kiếm, Thiên kiếp, núi Long Sĩ Đầu, ngõ Nê Bình, Thiên Kiếm môn,... thì sẽ hay hơn là dịch hẳn sang nghĩa tiếng Việt là Lá Trần, Rồng kiếm, Trời kiếp, núi Rồng Ngẩng Đầu,...\n  - Chỉ trả về bản dịch theo format trên, mỗi 1 cụm theo format sẽ ở 1 dòng, giữ nguyên định dạng phông chữ ban đầu và không giải thích thêm.\n`;return n&&{normal:`${l}\n${h}\n${g}\n${c}`,advanced:`Dịch và phân tích từ khóa: ${t}`,ocr:`${d}\n${h}\n${g}\nĐọc hiểu thật kĩ và xử lý toàn bộ văn bản trong hình ảnh.`,media:`${p}\nLưu ý:\n  - Bản dịch phải hoàn toàn là ngôn ngữ có mã ngôn ngữ là '${o}', nhưng ví dụ khi dịch sang tiếng Việt nếu gặp những danh từ riêng chỉ địa điểm hoặc tên riêng, có phạm trù trong ngôn ngữ là từ ghép của 2 ngôn ngữ gọi là từ Hán Việt, hãy dịch sang nghĩa từ Hán Việt như Diệp Trần, Lục Thiếu Du, Long kiếm, Thiên kiếp, núi Long Sĩ Đầu, ngõ Nê Bình, Thiên Kiếm môn,... thì sẽ hay hơn là dịch hẳn sang nghĩa tiếng Việt là Lá Trần, Rồng kiếm, Trời kiếp, núi Rồng Ngẩng Đầu,..\n  - Định dạng bản dịch của bạn theo định dạng SRT và đảm bảo rằng mỗi đoạn hội thoại có ít nhất 4 dòng bao gồm dòng được đánh số thứ tự, dòng có thời gian bắt đầu và kết thúc rõ ràng, dòng nội dung bản dịch và dòng trống để tách các phần số thứ tự hội thoại ở trên.\n  - Chỉ trả về bản dịch, không giải thích.`,page:`Bạn là một người dịch thuật ngôn ngữ chuyên sâu. Bạn sẽ nhận được một chuỗi JSON chứa một mảng các đối tượng, mỗi đối tượng có "id" và "text".\n\nNhiệm vụ của bạn là xử lý MỖI đối tượng và trả về: văn bản gốc, phiên âm IPA (hoặc Pinyin cho tiếng Trung), và bản dịch sang ngôn ngữ có mã là '${o}'.\n\nCác quy tắc BẮT BUỘC:\n1.  **Định dạng đầu ra:** Phản hồi của bạn PHẢI là một chuỗi JSON hợp lệ DUY NHẤT, chứa một mảng các đối tượng.\n2.  **Cấu trúc đối tượng:** Mỗi đối tượng trong mảng trả về PHẢI chứa bốn trường: "id" (giữ nguyên), "original" (văn bản gốc), "ipa" (phiên âm), và "translation" (bản dịch).\n3.  **Toàn vẹn dữ liệu:** KHÔNG được bỏ sót, gộp hoặc thay đổi thứ tự bất kỳ "id" nào. Số lượng đối tượng trả về PHẢI bằng số lượng đối tượng đầu vào.\n4.  **Không có nội dung thừa:** Phản hồi của bạn KHÔNG được chứa bất kỳ văn bản, giải thích, hay định dạng markdown nào (như \`\`\`json) bên ngoài chuỗi JSON.\n5.  **Quy tắc phiên âm:**\n    -   Đối với tiếng Trung: "ipa" phải là Pinyin kèm dấu thanh (ví dụ: "Nǐ hǎo").\n    -   Đối với các ngôn ngữ khác: "ipa" phải là phiên âm IPA (ví dụ: "həˈloʊ").\n\nVí dụ đầu vào:\n\`\`\`json\n[\n  {"id": 0, "text": "Hello world"},\n  {"id": 1, "text": "你好"}\n]\n\`\`\`\n\nVí dụ đầu ra mong muốn (dịch sang 'vi'):\n\`\`\`json\n[\n  {"id": 0, "original": "Hello world", "ipa": "həˈloʊ wɜːrld", "translation": "Xin chào thế giới"},\n  {"id": 1, "original": "你好", "ipa": "Nǐ hǎo", "translation": "Xin chào"}\n]\n\`\`\`\n\nBây giờ, hãy xử lý chuỗi JSON sau:\n${t}`,page_fallback:`Vui lòng cung cấp văn bản gốc, phiên âm, và bản dịch sang ngôn ngữ '${o}' cho văn bản sau.\n- Đối với tiếng Trung, phiên âm là Pinyin có dấu.\n- Đối với các ngôn ngữ khác, phiên âm là IPA.\n- Trả lời theo định dạng nghiêm ngặt: Văn bản gốc <|> Phiên âm <|> Bản dịch\n- KHÔNG thêm bất kỳ giải thích nào.\n${c}`,file_content:`Bạn là một trợ lý dịch thuật chuyên nghiệp. Hãy dịch nội dung của tệp này sang ngôn ngữ có mã là '${o}'. Cung cấp bản dịch toàn diện và chính xác của toàn bộ tài liệu/nội dung phương tiện, bảo toàn mọi thông tin và cấu trúc quan trọng.\nHãy trả về theo format sau, mỗi phần cách nhau bằng dấu <|> và không giải thích thêm:\nVăn bản gốc <|> phiên âm IPA <|> bản dịch sang ngôn ngữ có mã ngôn ngữ là '${o}'\nLưu ý:\n- Nếu có từ là tiếng Trung, hãy trả về giá trị phiên âm của từ đó chính là pinyin + số tone (1-4) của từ đó.\n- Chỉ trả về bản dịch hoàn chỉnh theo format trên mà không có bất kỳ giải thích, tiêu đề hay văn bản bổ sung nào.\n- Đảm bảo bản dịch có văn phong phù hợp với loại nội dung của tệp (ví dụ: formal cho tài liệu, conversational cho audio/video).`}[e]||{normal:`${l}\nLưu ý:\n  - Bản dịch phải hoàn toàn là ngôn ngữ có mã ngôn ngữ là '${o}', nhưng ví dụ khi dịch sang tiếng Việt nếu gặp những danh từ riêng chỉ địa điểm hoặc tên riêng, có phạm trù trong ngôn ngữ là từ ghép của 2 ngôn ngữ gọi là từ Hán Việt, hãy dịch sang nghĩa từ Hán Việt như Diệp Trần, Lục Thiếu Du, Long kiếm, Thiên kiếp, núi Long Sĩ Đầu, ngõ Nê Bình, Thiên Kiếm môn,... thì sẽ hay hơn là dịch hẳn sang nghĩa tiếng Việt là Lá Trần, Rồng kiếm, Trời kiếp, núi Rồng Ngẩng Đầu,...\n  - Hãy in ra bản dịch mà không có dấu ngoặc kép, giữ nguyên định dạng phông chữ ban đầu và không giải thích gì thêm.\n\n${c}`,advanced:`Dịch và phân tích từ khóa: ${t}`,ocr:`${d}\nLưu ý:\n  - Bản dịch phải hoàn toàn là ngôn ngữ có mã ngôn ngữ là '${o}', nhưng ví dụ khi dịch sang tiếng Việt nếu gặp những danh từ riêng chỉ địa điểm hoặc tên riêng, có phạm trù trong ngôn ngữ là từ ghép của 2 ngôn ngữ gọi là từ Hán Việt, hãy dịch sang nghĩa từ Hán Việt như Diệp Trần, Lục Thiếu Du, Long kiếm, Thiên kiếp, núi Long Sĩ Đầu, ngõ Nê Bình, Thiên Kiếm môn,... thì sẽ hay hơn là dịch hẳn sang nghĩa tiếng Việt là Lá Trần, Rồng kiếm, Trời kiếp, núi Rồng Ngẩng Đầu,..\n  - Đọc hiểu thật kĩ và xử lý toàn bộ văn bản trong hình ảnh.\n  - Chỉ trả về bản dịch, không giải thích.`,media:`${p}\nLưu ý:\n  - Bản dịch phải hoàn toàn là ngôn ngữ có mã ngôn ngữ là '${o}', nhưng ví dụ khi dịch sang tiếng Việt nếu gặp những danh từ riêng chỉ địa điểm hoặc tên riêng, có phạm trù trong ngôn ngữ là từ ghép của 2 ngôn ngữ gọi là từ Hán Việt, hãy dịch sang nghĩa từ Hán Việt như Diệp Trần, Lục Thiếu Du, Long kiếm, Thiên kiếp, núi Long Sĩ Đầu, ngõ Nê Bình, Thiên Kiếm môn,... thì sẽ hay hơn là dịch hẳn sang nghĩa tiếng Việt là Lá Trần, Rồng kiếm, Trời kiếp, núi Rồng Ngẩng Đầu,..\n  - Định dạng bản dịch của bạn theo định dạng SRT và đảm bảo rằng mỗi đoạn hội thoại có ít nhất 4 dòng bao gồm dòng được đánh số thứ tự, dòng có thời gian bắt đầu và kết thúc rõ ràng, dòng nội dung bản dịch và dòng trống để tách các phần số thứ tự hội thoại ở trên.\n  - Chỉ trả về bản dịch, không giải thích.`,page:`Bạn là một người dịch thuật chuyên nghiệp, chuyên xử lý các đoạn văn bản HTML. Bạn sẽ nhận được một chuỗi JSON chứa một mảng các đối tượng, mỗi đối tượng có "id" (chỉ số) và "text" (nội dung cần dịch).\n\nNhiệm vụ của bạn là dịch trường "text" của MỖI đối tượng sang ngôn ngữ có mã là '${o}'.\n\nCác quy tắc BẮT BUỘC:\n1.  **Định dạng đầu ra:** Phản hồi của bạn PHẢI là một chuỗi JSON hợp lệ DUY NHẤT, chứa một mảng các đối tượng.\n2.  **Cấu trúc đối tượng:** Mỗi đối tượng trong mảng trả về PHẢI chứa hai trường: "id" (số nguyên, giữ nguyên từ đầu vào) và "translation" (chuỗi, là văn bản đã dịch).\n3.  **Toàn vẹn dữ liệu:** KHÔNG được bỏ sót, gộp hoặc thay đổi thứ tự bất kỳ "id" nào từ đầu vào. Số lượng đối tượng trong mảng đầu ra PHẢI bằng số lượng đối tượng trong mảng đầu vào.\n4.  **Không có nội dung thừa:** Phản hồi của bạn KHÔNG được chứa bất kỳ văn bản, giải thích, ghi chú, hay định dạng markdown nào (như \`\`\`json) bên ngoài chuỗi JSON.\n\nYêu cầu về chất lượng dịch thuật:\n-   Ngôn ngữ đích: '${o}'.\n-   Sử dụng văn phong tự nhiên, phù hợp với ngữ cảnh của trang web có tiêu đề ${i}.\n-   Đối với tiếng Việt, giữ nguyên các danh từ riêng, tên Hán Việt (ví dụ: Diệp Trần, Thiên Kiếm môn) thay vì dịch thuần Việt (Lá Trần, Cổng Gươm Trời).\n\nVí dụ đầu vào:\n\`\`\`json\n[\n  {"id": 0, "text": "Hello world"},\n  {"id": 1, "text": "This is a test."}\n]\n\`\`\`\n\nVí dụ đầu ra mong muốn (dịch sang 'vi'):\n\`\`\`json\n[\n  {"id": 0, "translation": "Xin chào thế giới"},\n  {"id": 1, "translation": "Đây là một bài kiểm tra."}\n]\n\`\`\`\n\nBây giờ, hãy xử lý chuỗi JSON sau:\n${t}`,page_fallback:`Vui lòng dịch đoạn văn bản sau sang ngôn ngữ có mã là '${o}'. Chỉ trả về duy nhất bản dịch, không thêm bất kỳ giải thích hay định dạng nào khác.\n${c}`,file_content:`Bạn là một trợ lý dịch thuật chuyên nghiệp. Hãy dịch nội dung của tệp này sang ngôn ngữ có mã là '${o}'. Cung cấp bản dịch toàn diện và chính xác của toàn bộ tài liệu/nội dung phương tiện, bảo toàn mọi thông tin và cấu trúc quan trọng.\nLưu ý:\n- Chỉ trả về bản dịch hoàn chỉnh mà không có bất kỳ giải thích, tiêu đề hay văn bản bổ sung nào.\n- Đảm bảo bản dịch có văn phong phù hợp với loại nội dung của tệp (ví dụ: formal cho tài liệu, conversational cho audio/video).`}[e]}showSettingsUI(){const t=this.userSettings.createSettingsUI();this.uiRoot.getRoot().appendChild(t)}getRootContainer(){return this.uiRoot?this.uiRoot.container:null}cleanup(){console.log("Cleaning up Translator instance..."),this.uiRoot&&this.uiRoot.cleanup(),this.ui&&this.ui.cleanup(),this.input&&this.input.cleanup(),this.videoStreaming&&this.videoStreaming.cleanup(),window.translatorInstance=null}}let k=null;GM_registerMenuCommand("📄 Webpage Translation",async()=>{const t=window.translator;if(t)try{t.ui.showTranslatingStatus();const e=await t.page.translatePage();t.ui.removeTranslatingStatus(),e.success?t.ui.showNotification(e.message,"success"):t.ui.showNotification(e.message,"warning")}catch(e){console.error("Page translation error:",e),t.ui.showNotification(e.message,"error")}finally{t.ui.removeTranslatingStatus()}}),GM_registerMenuCommand("🌐 Google Translate (Webpage)",()=>{const t=window.translator;if(t){if(!t.userSettings.settings.pageTranslation.enableGoogleTranslate)return void t.ui.showNotification(t.userSettings._("notifications.page_translation_disabled"),"warning");t.ui.triggerGooglePageTranslate()}}),GM_registerMenuCommand("📸 OCR Region Translate",async()=>{const t=window.translator;if(t)try{const e=await t.ocr.captureScreen();if(!e)throw new Error(t.userSettings._("notifications.un_cr_screen"));t.ui.showTranslatingStatus();const n=await t.ocr.processImage(e);if(t.ui.removeTranslatingStatus(),!n)throw new Error(t.userSettings._("notifications.un_pr_screen"));t.ui.formatTrans(n)}catch(e){console.error("Screen translation error:",e),t.ui.showNotification(e.message,"error")}finally{t.ui.removeTranslatingStatus()}}),GM_registerMenuCommand("🖼️ Web Image Translate",()=>{const t=window.translator;t&&t.ui.startWebImageOCR()}),GM_registerMenuCommand("📚 Manga Web Translate",()=>{const t=window.translator;t&&t.ui.startMangaTranslation()}),GM_registerMenuCommand("📷 Image File Translate",async()=>{const t=window.translator;t&&await s("image/*",async e=>{try{t.ui.showTranslatingStatus();const n=await t.ocr.processImage(e);t.ui.removeTranslatingStatus(),t.ui.formatTrans(n)}catch(e){t.ui.showNotification(e.message)}finally{t.ui.removeTranslatingStatus()}})}),GM_registerMenuCommand("🎵 Media File Translate",async()=>{const t=window.translator;t&&await s("audio/*, video/*",async e=>{try{t.ui.showTranslatingStatus(),await t.media.processMediaFile(e),t.ui.removeTranslatingStatus()}catch(e){t.ui.showNotification(e.message)}finally{t.ui.removeTranslatingStatus()}})}),GM_registerMenuCommand("📄 File Translate (pdf, srt, vtt, md, json, txt, html)",async()=>{const t=window.translator;if(!t)return;const e=_.text.formats.map(t=>`.${t.ext}`).join(",");await s(e,async e=>{try{t.ui.showTranslatingStatus();const n=await t.translateFile(e);console.log(e.type);const a="pdf"===e.type?n:new Blob([n],{type:e.type}),i=URL.createObjectURL(a),s=document.createElement("a");s.href=i,s.download=`king1x32_translated_${e.type.endsWith("pdf")?e.name.replace(".pdf",".html"):e.name}`,t.uiRoot.getRoot().appendChild(s),s.click(),URL.revokeObjectURL(i),s.remove(),t.ui.removeTranslatingStatus(),t.ui.showNotification(t.userSettings._("notifications.file_translated_success"),"success")}catch(e){console.error(t.userSettings._("notifications.file_translation_error"),e),t.ui.showNotification(e.message,"error")}finally{t.ui.removeTranslatingStatus()}})}),GM_registerMenuCommand("🌐 Translate VIP",async()=>{const t=window.translator;t&&t.ui.handleGeminiFileOrUrlTranslation()}),GM_registerMenuCommand("⚙️ King Translator AI Settings",()=>{const t=window.translator;if(t){const e=t.userSettings.createSettingsUI();t.uiRoot.getRoot().appendChild(e)}}),function t(){window.translatorInstance&&window.translatorInstance.cleanup(),window.translatorInstance=new T,function(){k&&k.disconnect();const e=window.translatorInstance?.getRootContainer();e?(k=new MutationObserver(i(()=>{window.translatorInstance&&!document.body.contains(e)&&(console.warn("King Translator root element was removed, re-initializing Translator."),k.disconnect(),t())},200)),k.observe(document.body,{childList:!0})):console.warn("Could not setup observer: root container not found.")}()}()}();