// ==UserScript==
// @name                 Netflix Plus
// @namespace            http://tampermonkey.net/
// @version              4.3
// @author               TGSAN
// @match                https://www.netflix.com/*
// @icon                 https://www.google.com/s2/favicons?sz=64&domain=netflix.com
// @run-at               document-start
// @sandbox              raw
// @grant                unsafeWindow
// @grant                GM_setValue
// @grant                GM_getValue
// @grant                GM_registerMenuCommand
// @grant                GM_unregisterMenuCommand
// @downloadURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/Netflix20Plus.user.js
// @updateURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/Netflix20Plus.meta.js
// ==/UserScript==
(async()=>{"use strict";function e(){const e=()=>{try{"linux"==i.netflix.reactContext.models.playerModel.data.config.core.initParams.browserInfo.os.name&&(i.netflix.reactContext.models.playerModel.data.config.core.initParams.browserInfo.os={name:"windows",version:"10.0"}),"computer"!=i.netflix.reactContext.models.playerModel.data.config.core.initParams.browserInfo.hardware&&(i.netflix.reactContext.models.playerModel.data.config.core.initParams.browserInfo.hardware="computer")}catch{setTimeout(e,0)}};if(e(),a=!1,null==o)for(let e of i.document.getElementsByTagName("script"))if(e.src&&e.src.indexOf("cadmium-playercore")>-1){o=e;break}let t=document.createElement("script");t.src="https://www.cloudmoe.com/static/userscript/netflix-plus/cadmium-playercore.js",t.async=o.async,t.id=o.id,o.replaceWith(t)}async function t(e,t){await GM_setValue("NETFLIX_PLUS_"+e,t)}async function n(e,n){let o=await async function(e){let t=await GM_getValue("NETFLIX_PLUS_"+e);return"boolean"==typeof t?t:i.globalOptions[e]}(n);return i.globalOptions[n]=o,await GM_registerMenuCommand((o?"âœ…":"ðŸ”²")+" "+e,async function(){await t(n,!o),i.globalOptions[n]=!o,s()})}async function s(){for(let e of p)await GM_unregisterMenuCommand(e);p=[];for(let e of d)p.push(await n(e[1],e[0]))}let o,i=self.window;self.unsafeWindow?(console.log("[Netflix Plus] use unsafeWindow mode"),i=self.unsafeWindow):console.log("[Netflix Plus] use window mode (your userscript extensions not support unsafeWindow)"),i.addEventListener("load",function(){const e=i.document.createElement("div");i.document.body.appendChild(e),e.style.width="100%",e.style.height="100%",e.style.backgroundColor="transparent",e.style.zIndex=9999,e.style.pointerEvents="none",e.style.position="fixed",e.style.backdropFilter="blur(0px)"});{const e=document.createElement("meta");e.httpEquiv="Cache-Control",e.content="no-cache",i.document.head.appendChild(e)}{const e=document.createElement("meta");e.httpEquiv="Pragma",e.content="no-cache",i.document.head.appendChild(e)}{const e=document.createElement("meta");e.httpEquiv="Expires",e.content="-1",i.document.head.appendChild(e)}let a=!0;i.Function.prototype.callNetflixPlusOriginal=i.Function.prototype.call,i.Function.prototype.call=function(...t){if(a){let t=this.toString();if(t.length>1e6&&t.indexOf("h264mpl")>-1&&t.indexOf("videoElementNetflixPlus")<0)return console.log("PlayerCore found len: "+t.length),void e()}return this.callNetflixPlusOriginal(...t)},void 0!==i.netflix&&void 0!==i.netflix.player&&(function(e,t=1500){let n=function(){let e=document.createElement("div");return e.style.position="fixed",e.style.top="20px",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.padding="10px 20px",e.style.backgroundColor="rgba(250, 250, 250, 1.0)",e.style.color="rgba(32, 32, 32, 1.0)",e.style.fontSize="12px",e.style.textAlign="center",e.style.fontWeight="600",e.style.zIndex="9999",e.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.25)",e.style.borderRadius="30px",e.style.opacity="0.0",e.style.transition="opacity 0.5s",document.body.appendChild(e),e}();n.innerText=e,setTimeout(function(){n.style.opacity="1.0",setTimeout(function(){n.style.opacity="0.0",setTimeout(function(){document.body.removeChild(n)},500)},t)},1)}('Netflix Plus is executing too late and is being forced to run, which may cause issues.\n\nRefresh the page while holding down the "Shift" key to resolve the issue.',1e4),console.warn("The user script is executing too late and is being forced to run, which may cause issues."),e()),i._videoElementNetflixPlus,Object.defineProperty(i,"videoElementNetflixPlus",{get:function(){return i._videoElementNetflixPlus},set:function(e){let t=i._videoElementNetflixPlus;i._videoElementNetflixPlus=e,e.addEventListener("playing",function(){if(t===e)return;if(!i.globalOptions.setMaxBitrateOld)return;let n=function(e){return document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue},s=function(){i.dispatchEvent(new KeyboardEvent("keydown",{keyCode:83,ctrlKey:!0,altKey:!0,shiftKey:!0})),i.dispatchEvent(new KeyboardEvent("keydown",{keyCode:66,ctrlKey:!0,altKey:!0,shiftKey:!0}));const o=n("//div[text()='Video Bitrate / VMAF']"),a=n("//div[text()='Audio Bitrate']"),r=n("//button[text()='Override']");o&&a&&r?([o,a].forEach(function(e){let t=e.parentElement;t.querySelectorAll("select").forEach(function(e){e.removeAttribute("disabled")});let n=t.querySelectorAll("select > option");for(var s=0;s<n.length-1;s++)n[s].removeAttribute("selected");n[n.length-1].setAttribute("selected","selected")}),setTimeout(function(){r.click()},100),t=e):setTimeout(s,100)};s()})}}),i.modifyStreamInfoFilterNetflixPlus=function(e){if(i.globalOptions.onlyMaxBitrate){console.debug("[OnlyMaxBitrate] Dump Data",e);for(const t in e){const n=e[t],s=n.audio_tracks,o=n.video_tracks;if(s&&o){const e=n;console.debug(`[OnlyMaxBitrate] Found StreamInfo in ${t}`);for(const t in e){const n=e[t];if(Array.isArray(n)&&n.length>0&&n[0].streams){console.debug(`[OnlyMaxBitrate] Found CurrentSelectedStreamInfo in ${t}`);for(let e=0;n.length>e;e++)Array.isArray(n[e].streams)&&n[e].streams.length>0&&(n[e].streams=[n[e].streams.pop()]),Array.isArray(n[e].bitrates)&&n[e].bitrates.length>0&&(n[e].bitrates=[n[e].bitrates.pop()])}}}}}return e},i.modifyFilterNetflixPlus=function(e,t,n){let s="playready"===n?30:0;return i.globalOptions.useprk&&(e.push("h264mpl30-dash-playready-prk-qc"),e.push("h264mpl31-dash-playready-prk-qc"),e.push("h264mpl40-dash-playready-prk-qc")),30==s?(i.globalOptions.useddplus&&(e.push("ddplus-2.0-dash"),e.push("ddplus-5.1-dash"),e.push("ddplus-5.1hq-dash"),e.push("ddplus-atmos-dash")),i.globalOptions.usehevc&&(e=e.filter(e=>{if(!new RegExp(/main10-L5/g).test(JSON.stringify(e)))return e})),i.globalOptions.usef12k&&(e=e.filter(e=>{if(!new RegExp(/hevc-main10-L.*-dash-cenc-prk-do/g).test(JSON.stringify(e)))return e})),i.globalOptions.usef4k&&(e.push("hevc-main10-L30-dash-cenc"),e.push("hevc-main10-L31-dash-cenc"),e.push("hevc-main10-L40-dash-cenc"),e.push("hevc-main10-L41-dash-cenc"))):(i.globalOptions.useFHD&&(e.push("playready-h264mpl40-dash"),e.push("playready-h264hpl40-dash"),e.push("vp9-profile0-L40-dash-cenc"),e.push("av1-main-L50-dash-cbcs-prk"),e.push("av1-main-L51-dash-cbcs-prk"),e.push("av1-hdr10plus-main-L40-dash-cbcs-prk"),e.push("av1-hdr10plus-main-L41-dash-cbcs-prk"),e.push("av1-hdr10plus-main-L50-dash-cbcs-prk"),e.push("av1-hdr10plus-main-L51-dash-cbcs-prk")),i.globalOptions.useHA&&e.push("heaac-5.1-dash"),i.globalOptions.usedef||(i.globalOptions.useav1&&(e.push("av1-main-L20-dash-cbcs-prk"),e.push("av1-main-L21-dash-cbcs-prk"),e=(e=e.filter(e=>{if(!new RegExp(/h264/g).test(JSON.stringify(e)))return e})).filter(e=>{if(!new RegExp(/vp9-profile/g).test(JSON.stringify(e)))return e})),i.globalOptions.usevp9&&(e.push("vp9-profile0-L21-dash-cenc"),e=(e=e.filter(e=>{if(!new RegExp(/h264/g).test(JSON.stringify(e)))return e})).filter(e=>{if(!new RegExp(/av1-main/g).test(JSON.stringify(e)))return e})),i.globalOptions.useAVCH&&(e=(e=e.filter(e=>{if(!new RegExp(/vp9-profile/g).test(JSON.stringify(e)))return e})).filter(e=>{if(!new RegExp(/av1-main/g).test(JSON.stringify(e)))return e})),i.globalOptions.useAVC&&(e=(e=(e=e.filter(e=>{if(!new RegExp(/vp9-profile/g).test(JSON.stringify(e)))return e})).filter(e=>{if(!new RegExp(/h264hp/g).test(JSON.stringify(e)))return e})).filter(e=>{if(!new RegExp(/av1-main/g).test(JSON.stringify(e)))return e})))),i.globalOptions.useallSub&&(t.showAllSubDubTracks=1),i.globalOptions.closeimsc&&(e=e.filter(e=>{if(!new RegExp(/imsc1.1/g).test(JSON.stringify(e)))return e})),[e,t,n]};const r=i.fetch;i.fetch=(...e)=>{let t="",n=!1;switch(typeof e[0]){case"object":t=e[0].url,n=!0;break;case"string":t=e[0]}if(t.indexOf("//web.prod.cloud.netflix.com/graphql")>-1&&"object"==typeof e[1]){let t=e[1];if("string"==typeof t.body&&t.body.startsWith("{")&&t.body.endsWith("}")){let e=JSON.parse(t.body);if("string"==typeof e.operationName&&i.globalOptions.disableHouseholdCheck&&e.operationName.startsWith("CLCSInterstitial"))return console.debug("[DisableHouseholdCheck] Mocked: "+e.operationName),new Promise(e=>{let t={data:{}};t.data["body.operationName"]=null,e(new Response(JSON.stringify(t)))});t.body=JSON.stringify(e)}e[1]=t}return r(...e)};const l=class{constructor(e,t){this.script=e,this.target=t,this._cancel=!1,this._replace=null,this._stop=!1}preventDefault(){this._cancel=!0}stopPropagation(){this._stop=!0}replacePayload(e){this._replace=e}};let c=[];i.addBeforeScriptExecuteListener=e=>{if("function"!=typeof e)throw new Error("Event handler must be a function.");c.push(e)},i.removeBeforeScriptExecuteListener=e=>{let t=c.length;for(;t--;)c[t]===e&&c.splice(t,1)};const u=(e,t)=>{if("SCRIPT"!==e.tagName)return;const n=new l(e,t);if("function"==typeof i.onbeforescriptexecute)try{i.onbeforescriptexecute(n)}catch(e){console.error(e)}for(const e of c){if(n._stop)break;try{e(n)}catch(e){console.error(e)}}n._cancel?(e.textContent="",e.remove()):"string"==typeof n._replace&&(e.textContent=n._replace)};new MutationObserver(e=>{for(const t of e)for(const e of t.addedNodes)u(e,t.target)}).observe(document,{childList:!0,subtree:!0});const d=[["onlyMaxBitrate","Only use best bitrate available"],["useallSub","Show all audio-tracks and subs"],["closeimsc","Use SUP subtitle replace IMSC subtitle"],["useDDPandHA","Enable Dolby and HE-AAC 5.1 Audio"],["alwaysUseHDR","Always use HDR or Dolby Vision when available"],["disableHouseholdCheck","Disable checks for Netflix Household"]];let p=[];i.globalOptions={disableHouseholdCheck:!0,useDDPandHA:!0,useXHA:!1,alwaysUseHDR:!1,onlyMaxBitrate:!0,get onlyVideoMaxBitrate(){return i.globalOptions.onlyMaxBitrate},get onlyAudioMaxBitrate(){return i.globalOptions.onlyMaxBitrate},setMaxBitrateOld:!1,useallSub:!0,get useddplus(){return i.globalOptions.useDDPandHA},useAVC:!1,usedef:!1,get useHA(){return i.globalOptions.useDDPandHA},useAVCH:!0,usevp9:!1,useav1:!1,useprk:!0,usehevc:!1,usef4k:!0,usef12k:!1,closeimsc:!0,useFHD:!0,forceUHD:!1},await async function(){let e=[{videoCapabilities:[{contentType:"video/mp4;codecs=avc1.42E01E",robustness:"HW_SECURE_ALL"}]}];try{return await navigator.requestMediaKeySystemAccess("com.widevine.alpha.experiment",e),!0}catch{return!1}}()?d.push(["forceUHD","Force use UHD when available"]):t("forceUHD",!1),i.onbeforescriptexecute=function(){let e=document.getElementsByTagName("script");if(0!==e.length)for(let t=0;e.length>t;t++){let n=e[t];if(n.src.includes("cadmium-playercore")){o=n,console.warn("parsing playercore dom"),i.onbeforescriptexecute=null;break}}},await s(),await async function(){i.globalOptions.forceUHD&&(delete i.screen,i.__defineGetter__("screen",function(){let e=[];return e.width=7680,e.height=4320,e.availWidth=7680,e.availHeight=4320,e.availLeft=0,e.availTop=0,e.colorDepth=32,e.isExtended=!1,e.pixelDepth=32,e}),delete i.devicePixelRatio,i.devicePixelRatio=4,i.MediaKeys.prototype.getStatusForPolicyOriginal=i.MediaKeys.prototype.getStatusForPolicy,i.MediaKeys.prototype.getStatusForPolicy=async function(){return"usable"})}()})();