// ==UserScript==
// @name         TwitchAdSolutions (video-swap-new)
// @namespace    https://github.com/pixeltris/TwitchAdSolutions
// @version      1.45
// @updateURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/videoswapnew.meta.js
// @downloadURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/videoswapnew.user.js
// @author       pixeltris
// @match        *://*.twitch.tv/*
// @run-at       document-start
// @inject-into  page
// @grant        GM.xmlHttpRequest
// @connect      gql.twitch.tv
// ==/UserScript==
!function(){"use strict";function e(e){e.OPT_PREROLL_BACKUP_PLAYER_TYPES=["autoplay","picture-by-picture","embed"],e.OPT_MIDROLL_BACKUP_PLAYER_TYPES=["autoplay","picture-by-picture","embed"],e.OPT_BACKUP_PLATFORM="android",e.OPT_ACCESS_TOKEN_PLAYER_TYPE="site",e.OPT_STRIP_PARENT_DOMAINS=!0,e.OPT_SHOW_AD_BANNER=!0,e.AD_SIGNIFIER="stitched-ad",e.LIVE_SIGNIFIER=",live",e.CLIENT_ID="kimne78kx3ncx6brgo4mv6wki5h1ko",e.StreamInfos=[],e.StreamInfosByUrl=[],e.CurrentChannelNameFromM3U8=null,e.gql_device_id=null,e.ClientIntegrityHeader=null,e.AuthorizationHeader=null,e.SimulatedAdsDepth=0}function t(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.overrideMimeType("text/javascript"),t.send(),t.responseText}function n(e,t){var n,a=t.replace("\r","").split("\n");for(n=0;n<a.length;n++)!a[n].startsWith("#")&&a[n].includes(".m3u8")&&(StreamInfosByUrl[a[n].trimEnd()]=e)}async function a(e,t,a,s,o){var i,r,l,c,p,g,h,y,f,m,v,S,E,_,b,w,k,I,P=t;if(e.IsMidroll=t.includes('"MIDROLL"')||t.includes('"midroll"'),i=e.IsMidroll?OPT_MIDROLL_BACKUP_PLAYER_TYPES:OPT_PREROLL_BACKUP_PLAYER_TYPES,e.BackupEncodingsStatus.size>=i.length)return t;if(e.BackupEncodings&&!e.BackupEncodings.includes(o)&&(r=e.BackupEncodings.match(/^https:.*\.m3u8.*$/m)[0],200===(l=await s(r)).status))return await l.text();for(c="",p=0;p<i.length;p++)if(g=i[p],!e.BackupEncodingsStatus.has(g)){try{if(null!=(h=await d(e.ChannelName,g,OPT_BACKUP_PLATFORM))&&200===h.status&&(y=await h.json(),(f=new URL("https://usher.ttvnw.net/api/channel/hls/"+e.ChannelName+".m3u8"+e.UsherParams)).searchParams.set("sig",y.data.streamPlaybackAccessToken.signature),f.searchParams.set("token",y.data.streamPlaybackAccessToken.value),null!=(m=await s(f.href))&&200===m.status&&(r=(v=await m.text()).match(/^https:.*\.m3u8.*$/m)[0],200===(l=await s(r)).status&&(!(S=await l.text()).includes(AD_SIGNIFIER)&&(0==SimulatedAdsDepth||p>=SimulatedAdsDepth-1)||e.BackupEncodingsStatus.size>=i.length-1)))){if(P=S,c=" ("+g+")",e.BackupEncodingsStatus.set(g,1),e.BackupEncodingsPlayerTypeIndex=p,"embed"!==g){for(E=v.replace("\r","").split("\n"),_=null,b=[],w=0;w<E.length;w++)if(E[w].startsWith("#EXT-X-STREAM-INF")&&u(E[w]).RESOLUTION&&E[w+1].endsWith(".m3u8")){_=E[w+1],b=u(E[w].substring(E[w].indexOf(":")+1));break}if(null!=_&&null!=e.Encodings){for(k=e.Encodings.replace("\r","").split("\n"),w=0;w<k.length-1;w++)if(k[w].startsWith("#EXT-X-STREAM-INF")){I=u(k[w].substring(k[w].indexOf(":")+1));const e="CODECS";"string"==typeof I[e]&&"string"==typeof b[e]&&I[e].length>=3&&b[e].length>=3&&"hev"===I[e].substring(0,3)&&I[e].substring(0,3)!==b[e].substring(0,3)&&(console.log("swap "+I[e]+" to "+b[e]),k[w]=k[w].replace(/CODECS="[^"]+"/,`CODECS="${b[e]}"`),console.log(k[w])),u(k[w]).RESOLUTION&&(_+=" ",k[w+1]=_)}v=k.join("\r\n")}}e.BackupEncodings=v,n(e,v)}}catch(e){console.error(e)}if(1===e.BackupEncodingsStatus.get(g))break;e.BackupEncodingsStatus.set(g,0)}return console.log("Found ads, switch to backup"+c),a&&postMessage({key:"UboReloadPlayer"}),postMessage({key:"UboShowAdBanner",isMidroll:e.IsMidroll}),P}async function s(e,t,n){var s,o,i,r,l,d,c,u=StreamInfosByUrl[e];if(null==u)return t;if(s=t.includes(AD_SIGNIFIER),SimulatedAdsDepth>0&&(!u.BackupEncodings||!u.BackupEncodings.includes(e)||SimulatedAdsDepth-1>u.BackupEncodingsPlayerTypeIndex)&&(s=!0),u.BackupEncodings){if(o=u.Encodings.match(/^https:.*\.m3u8$/m)[0],200==(i=await n(o)).status&&null!=(r=await i.text()))if(r.includes(AD_SIGNIFIER)||0!=SimulatedAdsDepth){if(!r.includes('"MIDROLL"')&&!r.includes('"midroll"'))for(l=r.replace("\r","").split("\n"),d=0;d<l.length;d++)if((c=l[d]).startsWith("#EXTINF")&&l.length>d+1&&!c.includes(LIVE_SIGNIFIER)&&!u.RequestedAds.has(l[d+1])){u.RequestedAds.add(l[d+1]),fetch(l[d+1]).then(e=>{e.blob()});break}}else console.log("No more ads on main stream. Triggering player reload to go back to main stream..."),u.IsMovingOffBackupEncodings=!0,u.BackupEncodings=null,u.BackupEncodingsStatus.clear(),u.BackupEncodingsPlayerTypeIndex=-1,postMessage({key:"UboHideAdBanner"}),postMessage({key:"UboReloadPlayer"});u.BackupEncodings&&s&&(t=await a(u,t,!0,n,e))}else s&&!u.IsMovingOffBackupEncodings?t=await a(u,t,!0,n,e):postMessage({key:"UboHideAdBanner"});return t}function o(){console.log("hookWorkerFetch (video-swap-new)");var e=fetch;fetch=async function(t,o){var l,d;if("string"==typeof t){if((t=t.trimEnd()).endsWith("m3u8"))return new Promise(function(n,a){e(t,o).then(function(a){!async function(a){if(200===a.status){var o=await s(t,await a.text(),e);n(new Response(o,{status:a.status,statusText:a.statusText,headers:a.headers}))}else n(a)}(a)}).catch(function(e){console.log("fetch hook err "+e),a(e)})});if(t.includes("/api/channel/hls/")&&!t.includes("picture-by-picture"))return l=new URL(t).pathname.match(/([^\/]+)(?=\.\w+$)/)[0],CurrentChannelNameFromM3U8!=l&&postMessage({key:"UboChannelNameM3U8Changed",value:l}),CurrentChannelNameFromM3U8=l,OPT_STRIP_PARENT_DOMAINS&&((d=new URL(t)).searchParams.delete("parent_domains"),t=d.toString()),new Promise(async function(s){var d,c,u,p,g,h,y=StreamInfos[l];if(null!=y&&null!=y.Encodings&&200!==(await e(y.Encodings.match(/^https:.*\.m3u8$/m)[0])).status&&(y=null),d=null,null==y||null==y.Encodings){if(StreamInfos[l]=y={RequestedAds:new Set,Encodings:null,BackupEncodings:null,BackupEncodingsStatus:new Map,BackupEncodingsPlayerTypeIndex:-1,IsMovingOffBackupEncodings:!1,IsMidroll:!1,UseFallbackStream:!1,ChannelName:l,UsherParams:new URL(t).search},null==(c=await e(t,o))||200!==c.status)return void s(c);if(u=await c.text(),y.Encodings=u,n(y,u),d=i(u),p=u.match(/^https:.*\.m3u8$/m)[0],200!=(g=await e(p)).status)return void s(g);(h=await g.text()).includes(AD_SIGNIFIER)&&await a(y,h,!1,e,p)}d||null!=(c=await e(t,o))&&200===c.status&&(d=i(await c.text())),y.IsMovingOffBackupEncodings=!1,s(new Response(r(y.BackupEncodings?y.BackupEncodings:y.Encodings,d)))})}return e.apply(this,arguments)}}function i(e){var t=e.match('SERVER-TIME="([0-9.]+)"');return t.length>1?t[1]:null}function r(e,t){return t?e.replace(new RegExp('(SERVER-TIME=")[0-9.]+"'),`SERVER-TIME="${t}"`):e}function l(e,t,n){return[{operationName:"ClientSideAdEventHandling_RecordAdEvent",variables:{input:{eventName:e,eventPayload:JSON.stringify(n),radToken:t}},extensions:{persistedQuery:{version:1,sha256Hash:"7e6c69e6eb59f8ccb97ab73686f3d8b7d85a72a0298745ccd8bfc68e4054ca5b"}}}]}function d(e,t,n){return n||(n="web"),c({operationName:"PlaybackAccessToken_Template",query:'query PlaybackAccessToken_Template($login: String!, $isLive: Boolean!, $vodID: ID!, $isVod: Boolean!, $playerType: String!) {  streamPlaybackAccessToken(channelName: $login, params: {platform: "'+n+'", playerBackend: "mediaplayer", playerType: $playerType}) @include(if: $isLive) {    value    signature    __typename  }  videoPlaybackAccessToken(id: $vodID, params: {platform: "'+n+'", playerBackend: "mediaplayer", playerType: $playerType}) @include(if: $isVod) {    value    signature    __typename  }}',variables:{isLive:!0,login:e,isVod:!1,vodID:"",playerType:t}})}function c(e){if(!gql_device_id){const e="abcdefghijklmnopqrstuvwxyz0123456789";for(let t=0;t<32;t+=1)gql_device_id+=e.charAt(Math.floor(Math.random()*e.length))}var t={"Client-Id":CLIENT_ID,"Client-Integrity":ClientIntegrityHeader,"X-Device-Id":gql_device_id,Authorization:AuthorizationHeader};return new Promise((n,a)=>{const s=Math.random().toString(36).substring(2,15),o={id:s,url:"https://gql.twitch.tv/gql",options:{method:"POST",body:JSON.stringify(e),headers:t}};pendingFetchRequests.set(s,{resolve:n,reject:a}),postMessage({key:"FetchRequest",value:o})})}function u(e){return Object.fromEntries(e.split(/(?:^|,)((?:[^=]*)=(?:"[^"]*"|[^,]*))/).filter(Boolean).map(e=>{const t=e.indexOf("="),n=e.substring(0,t),a=e.substring(t+1),s=Number(a);return[n,Number.isNaN(s)?a.startsWith('"')?JSON.parse(a):a:s]}))}function p(e,t){f.forEach(n=>{n.postMessage({key:e,value:t})})}function g(e){const t=new Headers;return e.trim().split(/[\r\n]+/).forEach(e=>{const n=e.split(":"),a=n.shift(),s=n.join(":");t.append(a,s)}),t}function h(e,t){function n(e,t){if(e.stateNode&&t(e.stateNode))return e.stateNode;let a=e.child;for(;a;){const e=n(a,t);if(e)return e;a=a.sibling}return null}var a,s,o,i,r,l,d=function(){var e,t=null,n=document.querySelector("#root");return n&&n._reactRootContainer&&n._reactRootContainer._internalRoot&&n._reactRootContainer._internalRoot.current&&(t=n._reactRootContainer._internalRoot.current),null==t&&null!=(e=Object.keys(n).find(e=>e.startsWith("__reactContainer")))&&(t=n[e]),t}();if(!d)return void console.log("Could not find react root");if(a=(a=n(d,e=>e.setPlayerActive&&e.props&&e.props.mediaPlayerInstance))&&a.props&&a.props.mediaPlayerInstance?a.props.mediaPlayerInstance:null,s=n(d,e=>e.setSrc&&e.setInitialPlaybackSettings),!a)return void console.log("Could not find player");if(!s)return void console.log("Could not find player state");if(a.paused||a.core?.paused)return;if(e)return console.log("Force seek to reset player (hopefully fixing any audio desync) pos:"+a.getPosition()+" range:"+JSON.stringify(a.getBuffered())),o=a.getPosition(),a.seekTo(0),void a.seekTo(o);if(t)return a.pause(),void a.play();const c="video-quality",u="video-muted",p="volume";i=localStorage.getItem(c),r=localStorage.getItem(u),l=localStorage.getItem(p),a?.core?.state&&(localStorage.setItem(u,JSON.stringify({default:a.core.state.muted})),localStorage.setItem(p,a.core.state.volume)),a?.core?.state?.quality?.group&&localStorage.setItem(c,JSON.stringify({default:a.core.state.quality.group})),s.setSrc({isNewMediaPlayerInstance:!0,refreshAccessToken:!0}),a.play(),setTimeout(()=>{localStorage.setItem(c,i),localStorage.setItem(u,r),localStorage.setItem(p,l)},3e3)}function y(){var e,t,n,a,s,o,i;try{Object.defineProperty(document,"visibilityState",{get:()=>"visible"})}catch{}let r=document.__lookupGetter__("hidden"),l=document.__lookupGetter__("webkitHidden");try{Object.defineProperty(document,"hidden",{get:()=>!1})}catch{}e=e=>{e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation()};let d=!0;t=t=>{if("undefined"!=typeof chrome){const e=document.getElementsByTagName("video");e.length>0&&(!0===r.apply(document)||l&&!0===l.apply(document)?d=!e[0].paused&&!e[0].ended:d&&!e[0].ended&&e[0].play())}e(t)},document.addEventListener("visibilitychange",t,!0),document.addEventListener("webkitvisibilitychange",t,!0),document.addEventListener("mozvisibilitychange",t,!0),document.addEventListener("hasFocus",e,!0);try{/Firefox/.test(navigator.userAgent)?Object.defineProperty(document,"mozHidden",{get:()=>!1}):Object.defineProperty(document,"webkitHidden",{get:()=>!1})}catch{}for(n=["video-quality","video-muted","volume","lowLatencyModeEnabled","persistenceEnabled"],a=new Map,s=0;s<n.length;s++)a.set(n[s],localStorage.getItem(n[s]));o=localStorage.setItem,localStorage.setItem=function(e,t){a.has(e)&&a.set(e,t),o.apply(this,arguments)},i=localStorage.getItem,localStorage.getItem=function(e){return a.has(e)?a.get(e):i.apply(this,arguments)}}var f,m,v,S,E,_,b,w,k,I;if("undefined"==typeof unsafeWindow&&(unsafeWindow=window),void 0!==unsafeWindow.twitchAdSolutionsVersion&&unsafeWindow.twitchAdSolutionsVersion>=13)return console.log("skipping video-swap-new as there's another script active. ourVersion:13 activeVersion:"+unsafeWindow.twitchAdSolutionsVersion),void(unsafeWindow.twitchAdSolutionsVersion=13);unsafeWindow.twitchAdSolutionsVersion=13,f=[],m=["twitch","isVariantA"],v=[],S=["isVariantA","besuper/","${patch_url}"],E=!1,_=!1,unsafeWindow.reloadTwitchPlayer=h,e(unsafeWindow),b=function(){for(var e,t=[],n=unsafeWindow.Worker;n;)e=n.toString(),S.some(t=>e.includes(t))&&t.push(n),n=Object.getPrototypeOf(n);return t}(),w=class extends(function(){for(var e,t=null,n=null,a=unsafeWindow.Worker;a;)e=a.toString(),m.some(t=>e.includes(t))&&!v.some(t=>e.includes(t))?null!==n&&Object.setPrototypeOf(n,Object.getPrototypeOf(a)):(null===t&&(t=a),n=a),a=Object.getPrototypeOf(a);return t}()){constructor(p,y){function m(){var e=document.querySelector(".video-player"),t=null;return null!=e&&null==(t=e.querySelector(".ubo-overlay"))&&((t=document.createElement("div")).className="ubo-overlay",t.innerHTML='<div class="player-ad-notice" style="color: white; background-color: rgba(0, 0, 0, 0.8); position: absolute; top: 0px; left: 0px; padding: 5px;"><p></p></div>',t.style.display="none",t.P=t.querySelector("p"),e.appendChild(t)),t}var v,S=!1;try{S=new URL(p).origin.endsWith(".twitch.tv")}catch{}S?(v=`\n                    const pendingFetchRequests = new Map();\n                    ${s.toString()}\n                    ${o.toString()}\n                    ${e.toString()}\n                    ${d.toString()}\n                    ${c.toString()}\n                    ${l.toString()}\n                    ${u.toString()}\n                    ${n.toString()}\n                    ${a.toString()}\n                    ${t.toString()}\n                    ${i.toString()}\n                    ${r.toString()}\n                    var workerString = getWasmWorkerJs('${p.replaceAll("'","%27")}');\n                    declareOptions(self);\n                    gql_device_id = ${gql_device_id?"'"+gql_device_id+"'":null};\n                    AuthorizationHeader = ${AuthorizationHeader?"'"+AuthorizationHeader+"'":null};\n                    ClientIntegrityHeader = ${AuthorizationHeader?"'"+ClientIntegrityHeader+"'":null};\n                    self.addEventListener('message', function(e) {\n                        if (e.data.key == 'UboUpdateDeviceId') {\n                            gql_device_id = e.data.value;\n                        } else if (e.data.key == 'UpdateClientIntegrityHeader') {\n                            ClientIntegrityHeader = e.data.value;\n                        } else if (e.data.key == 'UpdateAuthorizationHeader') {\n                            AuthorizationHeader = e.data.value;\n                        } else if (e.data.key == 'FetchResponse') {\n                            const responseData = e.data.value;\n                            if (pendingFetchRequests.has(responseData.id)) {\n                                const { resolve, reject } = pendingFetchRequests.get(responseData.id);\n                                pendingFetchRequests.delete(responseData.id);\n                                if (responseData.error) {\n                                    reject(new Error(responseData.error));\n                                } else {\n                                    // Create a Response object from the response data\n                                    const response = new Response(responseData.body, {\n                                        status: responseData.status,\n                                        statusText: responseData.statusText,\n                                        headers: responseData.headers\n                                    });\n                                    resolve(response);\n                                }\n                            }\n                        } else if (e.data.key == 'SimulateAds') {\n                            SimulatedAdsDepth = e.data.value;\n                            console.log('SimulatedAdsDepth:' + SimulatedAdsDepth);\n                        }\n                    });\n                    hookWorkerFetch();\n                    eval(workerString);\n                `,super(URL.createObjectURL(new Blob([v])),y),f.push(this),this.addEventListener("message",e=>{var t;"UboShowAdBanner"==e.data.key?null!=(t=m())&&(t.P.textContent="Blocking"+(e.data.isMidroll?" midroll":"")+" ads",OPT_SHOW_AD_BANNER&&(t.style.display="block")):"UboHideAdBanner"==e.data.key?null!=(t=m())&&(t.style.display="none"):"UboChannelNameM3U8Changed"==e.data.key||("UboReloadPlayer"==e.data.key?h():"UboPauseResumePlayer"==e.data.key?h(!1,!0):"UboSeekPlayer"==e.data.key&&h(!0))}),this.addEventListener("message",async e=>{if("FetchRequest"==e.data.key){const t=e.data.value,n=await async function(e){try{if(E||!_){const t=await unsafeWindow.realFetch(e.url,e.options),n=await t.text(),a={id:e.id,status:t.status,statusText:t.statusText,headers:Object.fromEntries(t.headers.entries()),body:n};if(200===a.status&&(void 0!==JSON.parse(n).errors?_=!0:E=!0),E||!_)return a}if("undefined"!=typeof GM&&void 0!==GM.xmlHttpRequest){e.options.headers["Sec-Ch-Ua"]='"Google Chrome";v="137", "Chromium";v="137", "Not/A)Brand";v="24"',e.options.headers.Referer="https://www.twitch.tv/",e.options.headers.Origin="https://www.twitch.tv/",e.options.headers.Host="gql.twitch.tv";const t=await function(e){return new Promise((t,n)=>{GM.xmlHttpRequest({method:e.options.method,url:e.url,data:e.options.body,headers:e.options.headers,onload:e=>t(e),onerror:e=>n(e)})})}(e),n=t.responseText;return{id:e.id,status:t.status,statusText:t.statusText,headers:Object.fromEntries(g(t.responseHeaders).entries()),body:n}}throw{message:"Failed to resolve GQL request. Try the userscript version of the ad blocking solution"}}catch(t){return{id:e.id,error:t.message}}}(t);this.postMessage({key:"FetchResponse",value:n})}})):super(p,y)}},k=function(e,t){var n,a=e;for(n=0;n<t.length;n++)Object.setPrototypeOf(t[n],a),a=t[n];return a}(w,b),Object.defineProperty(unsafeWindow,"Worker",{get:function(){return k},set:function(e){var t;t=e.toString(),!m.some(e=>t.includes(e))||v.some(e=>t.includes(e))||S.some(e=>t.includes(e))?k=e:console.log("Attempt to set twitch worker denied")}}),I=unsafeWindow.fetch,unsafeWindow.realFetch=I,unsafeWindow.fetch=function(e,t){if("string"==typeof e&&e.includes("gql")){var n=t.headers["X-Device-Id"];if("string"!=typeof n&&(n=t.headers["Device-ID"]),"string"==typeof n&&(gql_device_id=n),gql_device_id&&p("UboUpdateDeviceId",gql_device_id),OPT_ACCESS_TOKEN_PLAYER_TYPE&&"string"==typeof t.body&&t.body.includes("PlaybackAccessToken")&&!t.body.includes("picture-by-picture")){let e="";const n=JSON.parse(t.body);if(Array.isArray(n))for(let t=0;t<n.length;t++)n[t]?.variables?.playerType&&n[t]?.variables?.playerType!==OPT_ACCESS_TOKEN_PLAYER_TYPE&&(e=n[t].variables.playerType,n[t].variables.playerType=OPT_ACCESS_TOKEN_PLAYER_TYPE);else n?.variables?.playerType&&n?.variables?.playerType!==OPT_ACCESS_TOKEN_PLAYER_TYPE&&(e=n.variables.playerType,n.variables.playerType=OPT_ACCESS_TOKEN_PLAYER_TYPE);e&&(console.log(`Replaced '${e}' player type with '${OPT_ACCESS_TOKEN_PLAYER_TYPE}' player type`),t.body=JSON.stringify(n))}"string"==typeof t.headers["Client-Integrity"]&&t.headers["Client-Integrity"]!==ClientIntegrityHeader&&p("UpdateClientIntegrityHeader",ClientIntegrityHeader=t.headers["Client-Integrity"]),"string"==typeof t.headers.Authorization&&t.headers.Authorization!==AuthorizationHeader&&p("UpdateAuthorizationHeader",AuthorizationHeader=t.headers.Authorization)}return I.apply(this,arguments)},"complete"===document.readyState||"loaded"===document.readyState||"interactive"===document.readyState?y():unsafeWindow.addEventListener("DOMContentLoaded",function(){y()}),unsafeWindow.simulateAds=e=>{void 0===e||e<0?console.log("Ad depth paramter required (0 = no simulated ad, 1+ = use backup player for given depth)"):p("SimulateAds",e)}}();