// ==UserScript==
// @name         TwitchAdSolutions (video-swap-new)
// @namespace    https://github.com/pixeltris/TwitchAdSolutions
// @version      1.47
// @updateURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/videoswapnew.meta.js
// @downloadURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/videoswapnew.user.js
// @author       pixeltris
// @match        *://*.twitch.tv/*
// @run-at       document-start
// @inject-into  page
// @grant        none
// ==/UserScript==
!function(){"use strict";function e(e){e.OPT_BACKUP_PLAYER_TYPES=["autoplay","picture-by-picture","embed"],e.OPT_BACKUP_PLATFORM="android",e.OPT_FORCE_ACCESS_TOKEN_PLAYER_TYPE="site",e.AD_SIGNIFIER="stitched-ad",e.LIVE_SIGNIFIER=",live",e.CLIENT_ID="kimne78kx3ncx6brgo4mv6wki5h1ko",e.StreamInfos=[],e.StreamInfosByUrl=[],e.gql_device_id=null,e.ClientIntegrityHeader=null,e.AuthorizationHeader=void 0,e.SimulatedAdsDepth=0,e.V2API=!1}function t(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.overrideMimeType("text/javascript"),t.send(),t.responseText}function n(e,t){var n,a,i,r,s=t.replace("\r","").split("\n");for(n=0;n<s.length;n++)!s[n].startsWith("#")&&s[n].includes(".m3u8")&&(StreamInfosByUrl[s[n].trimEnd()]=e),s[n].startsWith("#EXT-X-STREAM-INF")&&s[n+1].includes(".m3u8")&&(i=(a=u(s[n])).RESOLUTION)&&(r={Resolution:i,FrameRate:a["FRAME-RATE"],Url:s[n+1]},e.Urls.set(s[n+1].trimEnd(),r))}async function a(e,t,a,i,r,s){var o,c,p,g,y,h,f,m,E,v,S,I,w,A,_,k,T,b,R=t;if(e.IsMidroll=t.includes('"MIDROLL"')||t.includes('"midroll"'),o=OPT_BACKUP_PLAYER_TYPES,e.BackupEncodingsStatus.size>=o.length)return t;if(e.BackupEncodings&&!e.BackupEncodings.includes(r)&&(c=l(e.BackupEncodings,s),200===(p=await i(c)).status))return await p.text();for(g="",y=0;y<o.length;y++)if(h=o[y],!e.BackupEncodingsStatus.has(h)){try{if(null!=(f=await d(e.ChannelName,h,OPT_BACKUP_PLATFORM))&&200===f.status&&(m=await f.json(),(E=new URL("https://usher.ttvnw.net/api/"+(V2API?"v2/":"")+"channel/hls/"+e.ChannelName+".m3u8"+e.UsherParams)).searchParams.set("sig",m.data.streamPlaybackAccessToken.signature),E.searchParams.set("token",m.data.streamPlaybackAccessToken.value),null!=(v=await i(E.href))&&200===v.status&&(c=l(S=await v.text(),s),200===(p=await i(c)).status&&(!(I=await p.text()).includes(AD_SIGNIFIER)&&(0==SimulatedAdsDepth||y>=SimulatedAdsDepth-1)||e.BackupEncodingsStatus.size>=o.length-1)))){if(R=I,g=" ("+h+")",e.BackupEncodingsStatus.set(h,1),e.BackupEncodingsPlayerTypeIndex=y,"embed"!==h&&null!=e.Encodings){for(w=e.Encodings.replace("\r","").split("\n"),A=0;A<w.length-1;A++)if(w[A].startsWith("#EXT-X-STREAM-INF")){_=u(w[A].substring(w[A].indexOf(":")+1)),k=l(S,e.Urls.get(w[A+1].trimEnd())),b=u((T=S.match(new RegExp(`^.*(?=\n.*${k})`,"m"))[0]).substring(T.indexOf(":")+1));const t="CODECS";"string"==typeof _[t]&&"string"==typeof b[t]&&_[t].length>=3&&b[t].length>=3&&(_[t].startsWith("hev")||_[t].startsWith("hvc"))&&_[t].substring(0,3)!==b[t].substring(0,3)&&(console.log("swap "+_[t]+" to "+b[t]),w[A]=w[A].replace(/CODECS="[^"]+"/,`CODECS="${b[t]}"`),console.log(w[A])),w[A+1]=k+" ".repeat(A+1)}S=w.join("\n")}e.BackupEncodings=S,n(e,S)}}catch(e){console.error(e)}if(1===e.BackupEncodingsStatus.get(h))break;e.BackupEncodingsStatus.set(h,0)}return console.log("Found ads, switch to backup"+g),a&&postMessage({key:"UboReloadPlayer"}),postMessage({key:"UboShowAdBanner",isMidroll:e.IsMidroll}),R}async function i(e,t,n){var i,r,s,o,l,d,c,u,p=StreamInfosByUrl[e];if(null==p)return t;if(!(i=p.Urls.get(e)))return t;if(r=t.includes(AD_SIGNIFIER),SimulatedAdsDepth>0&&(!p.BackupEncodings||!p.BackupEncodings.includes(e)||SimulatedAdsDepth-1>p.BackupEncodingsPlayerTypeIndex)&&(r=!0),p.BackupEncodings){if(s=p.Encodings.match(/^https:.*\.m3u8$/m)[0],200==(o=await n(s)).status&&null!=(l=await o.text()))if(l.includes(AD_SIGNIFIER)||0!=SimulatedAdsDepth){if(!l.includes('"MIDROLL"')&&!l.includes('"midroll"'))for(d=l.replace("\r","").split("\n"),c=0;c<d.length;c++)if((u=d[c]).startsWith("#EXTINF")&&d.length>c+1&&!u.includes(LIVE_SIGNIFIER)&&!p.RequestedAds.has(d[c+1])){p.RequestedAds.add(d[c+1]),fetch(d[c+1]).then(e=>{e.blob()});break}}else console.log("No more ads on main stream. Triggering player reload to go back to main stream..."),p.IsMovingOffBackupEncodings=!0,p.BackupEncodings=null,p.BackupEncodingsStatus.clear(),p.BackupEncodingsPlayerTypeIndex=-1,postMessage({key:"UboHideAdBanner"}),postMessage({key:"UboReloadPlayer"});p.BackupEncodings&&r&&(t=await a(p,t,!0,n,e,i))}else r&&!p.IsMovingOffBackupEncodings?t=await a(p,t,!0,n,e,i):postMessage({key:"UboHideAdBanner"});return t}function r(){console.log("hookWorkerFetch (video-swap-new)");var e=fetch;fetch=async function(t,r){var l,d;if("string"==typeof t){if((t=t.trimEnd()).endsWith("m3u8"))return new Promise(function(n,a){e(t,r).then(function(a){!async function(a){if(200===a.status){var r=await i(t,await a.text(),e);n(new Response(r,{status:a.status,statusText:a.statusText,headers:a.headers}))}else n(a)}(a)}).catch(function(e){console.log("fetch hook err "+e),a(e)})});if(t.includes("/channel/hls/")&&!t.includes("picture-by-picture"))return V2API=t.includes("/api/v2/"),l=new URL(t).pathname.match(/([^\/]+)(?=\.\w+$)/)[0],OPT_FORCE_ACCESS_TOKEN_PLAYER_TYPE&&((d=new URL(t)).searchParams.delete("parent_domains"),t=d.toString()),new Promise(async function(i){var d,c,u,p,g,y,h=StreamInfos[l];if(null!=h&&null!=h.Encodings&&200!==(await e(h.Encodings.match(/^https:.*\.m3u8$/m)[0])).status&&(h=null),d=null,null==h||null==h.Encodings){if(StreamInfos[l]=h={RequestedAds:new Set,Encodings:null,BackupEncodings:null,BackupEncodingsStatus:new Map,BackupEncodingsPlayerTypeIndex:-1,IsMovingOffBackupEncodings:!1,IsMidroll:!1,UseFallbackStream:!1,ChannelName:l,UsherParams:new URL(t).search,Urls:new Map},null==(c=await e(t,r))||200!==c.status)return void i(c);if(u=await c.text(),h.Encodings=u,n(h,u),d=s(u),p=h.Urls.values().next().value,200!=(g=await e(p.Url)).status)return void i(g);((y=await g.text()).includes(AD_SIGNIFIER)||SimulatedAdsDepth>0)&&await a(h,y,!1,e,p.Url,p)}d||null!=(c=await e(t,r))&&200===c.status&&(d=s(await c.text())),h.IsMovingOffBackupEncodings=!1,i(new Response(o(h.BackupEncodings?h.BackupEncodings:h.Encodings,d)))})}return e.apply(this,arguments)}}function s(e){var t;return V2API?(t=e.match(/#EXT-X-SESSION-DATA:DATA-ID="SERVER-TIME",VALUE="([^"]+)"/)).length>1?t[1]:null:(t=e.match('SERVER-TIME="([0-9.]+)"')).length>1?t[1]:null}function o(e,t){return V2API?t?e.replace(/(#EXT-X-SESSION-DATA:DATA-ID="SERVER-TIME",VALUE=")[^"]+(")/,`$1${t}$2`):e:t?e.replace(new RegExp('(SERVER-TIME=")[0-9.]+"'),`SERVER-TIME="${t}"`):e}function l(e,t){var n,a,i,r,s,o,l,d,c,p=e.replace("\r","").split("\n");const[g,y]=t.Resolution.split("x").map(Number);for(n=null,a=!1,i=null,r=1/0,s=0;s<p.length-1;s++)if(p[s].startsWith("#EXT-X-STREAM-INF")&&p[s+1].includes(".m3u8")&&(l=(o=u(p[s])).RESOLUTION,d=o["FRAME-RATE"],l)){if(l==t.Resolution&&(!n||!a&&d==t.FrameRate)&&(n=p[s+1],a=d==t.FrameRate))return n.trimEnd();const[e,o]=l.split("x").map(Number);(c=Math.abs(e*o-g*y))<r&&(i=p[s+1],r=c)}return i.trimEnd()}function d(e,t,n){return n||(n="web"),c({operationName:"PlaybackAccessToken_Template",query:'query PlaybackAccessToken_Template($login: String!, $isLive: Boolean!, $vodID: ID!, $isVod: Boolean!, $playerType: String!) {  streamPlaybackAccessToken(channelName: $login, params: {platform: "'+n+'", playerBackend: "mediaplayer", playerType: $playerType}) @include(if: $isLive) {    value    signature    __typename  }  videoPlaybackAccessToken(id: $vodID, params: {platform: "'+n+'", playerBackend: "mediaplayer", playerType: $playerType}) @include(if: $isVod) {    value    signature    __typename  }}',variables:{isLive:!0,login:e,isVod:!1,vodID:"",playerType:t}})}function c(e){if(!gql_device_id){const e="abcdefghijklmnopqrstuvwxyz0123456789";for(let t=0;t<32;t+=1)gql_device_id+=e.charAt(Math.floor(Math.random()*e.length))}var t={"Client-Id":CLIENT_ID,"Device-ID":gql_device_id,"X-Device-Id":gql_device_id,Authorization:AuthorizationHeader,...ClientIntegrityHeader&&{"Client-Integrity":ClientIntegrityHeader}};return new Promise((n,a)=>{const i=Math.random().toString(36).substring(2,15),r={id:i,url:"https://gql.twitch.tv/gql",options:{method:"POST",body:JSON.stringify(e),headers:t}};pendingFetchRequests.set(i,{resolve:n,reject:a}),postMessage({key:"FetchRequest",value:r})})}function u(e){return Object.fromEntries(e.split(/(?:^|,)((?:[^=]*)=(?:"[^"]*"|[^,]*))/).filter(Boolean).map(e=>{const t=e.indexOf("="),n=e.substring(0,t),a=e.substring(t+1),i=Number(a);return[n,Number.isNaN(i)?a.startsWith('"')?JSON.parse(a):a:i]}))}function p(e,t){m.forEach(n=>{n.postMessage({key:e,value:t})})}function g(e,t){function n(e,t){if(e.stateNode&&t(e.stateNode))return e.stateNode;let a=e.child;for(;a;){const e=n(a,t);if(e)return e;a=a.sibling}return null}var a,i,r,s,o,l,d=function(){var e,t=null,n=document.querySelector("#root");return n&&n._reactRootContainer&&n._reactRootContainer._internalRoot&&n._reactRootContainer._internalRoot.current&&(t=n._reactRootContainer._internalRoot.current),null==t&&null!=(e=Object.keys(n).find(e=>e.startsWith("__reactContainer")))&&(t=n[e]),t}();if(!d)return void console.log("Could not find react root");if(a=(a=n(d,e=>e.setPlayerActive&&e.props&&e.props.mediaPlayerInstance))&&a.props&&a.props.mediaPlayerInstance?a.props.mediaPlayerInstance:null,i=n(d,e=>e.setSrc&&e.setInitialPlaybackSettings),!a)return void console.log("Could not find player");if(!i)return void console.log("Could not find player state");if(a.paused||a.core?.paused)return;if(e)return console.log("Force seek to reset player (hopefully fixing any audio desync) pos:"+a.getPosition()+" range:"+JSON.stringify(a.getBuffered())),r=a.getPosition(),a.seekTo(0),void a.seekTo(r);if(t)return a.pause(),void a.play();const c="video-quality",u="video-muted",p="volume";s=localStorage.getItem(c),o=localStorage.getItem(u),l=localStorage.getItem(p),h&&a?.core?.state&&(localStorage.setItem(u,JSON.stringify({default:a.core.state.muted})),localStorage.setItem(p,a.core.state.volume)),h&&a?.core?.state?.quality?.group&&localStorage.setItem(c,JSON.stringify({default:a.core.state.quality.group})),i.setSrc({isNewMediaPlayerInstance:!0,refreshAccessToken:!0}),a.play(),h&&setTimeout(()=>{localStorage.setItem(c,s),localStorage.setItem(u,o),localStorage.setItem(p,l)},3e3)}function y(){var e,t,n,a,i,r,s;try{Object.defineProperty(document,"visibilityState",{get:()=>"visible"})}catch{}let o=document.__lookupGetter__("hidden"),l=document.__lookupGetter__("webkitHidden");try{Object.defineProperty(document,"hidden",{get:()=>!1})}catch{}e=e=>{e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation()};let d=!0;t=t=>{if("undefined"!=typeof chrome){const e=document.getElementsByTagName("video");e.length>0&&(!0===o.apply(document)||l&&!0===l.apply(document)?d=!e[0].paused&&!e[0].ended:d&&!e[0].ended&&e[0].paused&&e[0].muted&&e[0].play())}e(t)},document.addEventListener("visibilitychange",t,!0),document.addEventListener("webkitvisibilitychange",t,!0),document.addEventListener("mozvisibilitychange",t,!0),document.addEventListener("hasFocus",e,!0);try{/Firefox/.test(navigator.userAgent)?Object.defineProperty(document,"mozHidden",{get:()=>!1}):Object.defineProperty(document,"webkitHidden",{get:()=>!1})}catch{}for(n=["video-quality","video-muted","volume","lowLatencyModeEnabled","persistenceEnabled"],a=new Map,i=0;i<n.length;i++)a.set(n[i],localStorage.getItem(n[i]));r=localStorage.setItem,localStorage.setItem=function(e,t){a.has(e)&&a.set(e,t),r.apply(this,arguments)},s=localStorage.getItem,localStorage.getItem=function(e){return a.has(e)?a.get(e):s.apply(this,arguments)},localStorage.getItem.toString().includes(Object.keys({cachedValues:a})[0])||(h=!0)}var h,f,m,E,v,S,I,w,A,_;if(void 0!==window.twitchAdSolutionsVersion&&window.twitchAdSolutionsVersion>=15)return console.log("skipping video-swap-new as there's another script active. ourVersion:15 activeVersion:"+window.twitchAdSolutionsVersion),void(window.twitchAdSolutionsVersion=15);window.twitchAdSolutionsVersion=15,h=!1,f=null,m=[],E=["twitch","isVariantA"],v=[],S=["isVariantA","besuper/","${patch_url}"],window.reloadTwitchPlayer=g,e(window),I=function(){for(var e,t=[],n=window.Worker;n;)e=n.toString(),S.some(t=>e.includes(t))&&t.push(n),n=Object.getPrototypeOf(n);return t}(),w=class extends(function(){for(var e,t=null,n=null,a=window.Worker;a;)e=a.toString(),E.some(t=>e.includes(t))&&!v.some(t=>e.includes(t))?null!==n&&Object.setPrototypeOf(n,Object.getPrototypeOf(a)):(null===t&&(t=a),n=a),a=Object.getPrototypeOf(a);return t}()){constructor(p,y){function h(){var e=document.querySelector(".video-player"),t=null;return null!=e&&null==(t=e.querySelector(".ubo-overlay"))&&((t=document.createElement("div")).className="ubo-overlay",t.innerHTML='<div class="player-ad-notice" style="color: white; background-color: rgba(0, 0, 0, 0.8); position: absolute; top: 0px; left: 0px; padding: 5px;"><p></p></div>',t.style.display="none",t.P=t.querySelector("p"),e.appendChild(t)),t}var E,v=!1;try{v=new URL(p).origin.endsWith(".twitch.tv")}catch{}v?(E=`\n                    const pendingFetchRequests = new Map();\n                    ${i.toString()}\n                    ${r.toString()}\n                    ${e.toString()}\n                    ${d.toString()}\n                    ${c.toString()}\n                    ${u.toString()}\n                    ${n.toString()}\n                    ${a.toString()}\n                    ${t.toString()}\n                    ${s.toString()}\n                    ${o.toString()}\n                    ${l.toString()}\n                    var workerString = getWasmWorkerJs('${p.replaceAll("'","%27")}');\n                    declareOptions(self);\n                    gql_device_id = ${gql_device_id?"'"+gql_device_id+"'":null};\n                    AuthorizationHeader = ${AuthorizationHeader?"'"+AuthorizationHeader+"'":void 0};\n                    ClientIntegrityHeader = ${ClientIntegrityHeader?"'"+ClientIntegrityHeader+"'":null};\n                    self.addEventListener('message', function(e) {\n                        if (e.data.key == 'UboUpdateDeviceId') {\n                            gql_device_id = e.data.value;\n                        } else if (e.data.key == 'UpdateClientIntegrityHeader') {\n                            ClientIntegrityHeader = e.data.value;\n                        } else if (e.data.key == 'UpdateAuthorizationHeader') {\n                            AuthorizationHeader = e.data.value;\n                        } else if (e.data.key == 'FetchResponse') {\n                            const responseData = e.data.value;\n                            if (pendingFetchRequests.has(responseData.id)) {\n                                const { resolve, reject } = pendingFetchRequests.get(responseData.id);\n                                pendingFetchRequests.delete(responseData.id);\n                                if (responseData.error) {\n                                    reject(new Error(responseData.error));\n                                } else {\n                                    // Create a Response object from the response data\n                                    const response = new Response(responseData.body, {\n                                        status: responseData.status,\n                                        statusText: responseData.statusText,\n                                        headers: responseData.headers\n                                    });\n                                    resolve(response);\n                                }\n                            }\n                        } else if (e.data.key == 'SimulateAds') {\n                            SimulatedAdsDepth = e.data.value;\n                            console.log('SimulatedAdsDepth:' + SimulatedAdsDepth);\n                        }\n                    });\n                    hookWorkerFetch();\n                    eval(workerString);\n                `,super(URL.createObjectURL(new Blob([E])),y),m.push(this),this.addEventListener("message",e=>{"UboShowAdBanner"==e.data.key?(null==f&&(f=h()),null!=f&&(f.P.textContent="Blocking"+(e.data.isMidroll?" midroll":"")+" ads",f.style.display="block")):"UboHideAdBanner"==e.data.key?(null==f&&(f=h()),null!=f&&(f.style.display="none")):"UboReloadPlayer"==e.data.key?g():"UboPauseResumePlayer"==e.data.key&&g(!0)}),this.addEventListener("message",async e=>{if("FetchRequest"==e.data.key){const t=e.data.value,n=await async function(e){try{const t=await window.realFetch(e.url,e.options),n=await t.text();return{id:e.id,status:t.status,statusText:t.statusText,headers:Object.fromEntries(t.headers.entries()),body:n}}catch(t){return{id:e.id,error:t.message}}}(t);this.postMessage({key:"FetchResponse",value:n})}})):super(p,y)}},A=function(e,t){var n,a=e;for(n=0;n<t.length;n++)Object.setPrototypeOf(t[n],a),a=t[n];return a}(w,I),Object.defineProperty(window,"Worker",{get:function(){return A},set:function(e){var t;t=e.toString(),!E.some(e=>t.includes(e))||v.some(e=>t.includes(e))||S.some(e=>t.includes(e))?A=e:console.log("Attempt to set twitch worker denied")}}),_=window.fetch,window.realFetch=_,window.fetch=function(e,t){if("string"==typeof e&&e.includes("gql")){var n=t.headers["X-Device-Id"];if("string"!=typeof n&&(n=t.headers["Device-ID"]),"string"==typeof n&&gql_device_id!=n&&(gql_device_id=n,p("UboUpdateDeviceId",gql_device_id)),"string"==typeof t.headers["Client-Integrity"]&&t.headers["Client-Integrity"]!==ClientIntegrityHeader&&p("UpdateClientIntegrityHeader",ClientIntegrityHeader=t.headers["Client-Integrity"]),"string"==typeof t.headers.Authorization&&t.headers.Authorization!==AuthorizationHeader&&p("UpdateAuthorizationHeader",AuthorizationHeader=t.headers.Authorization),OPT_FORCE_ACCESS_TOKEN_PLAYER_TYPE&&"string"==typeof t.body&&t.body.includes("PlaybackAccessToken")&&!t.body.includes("picture-by-picture")){let e="";const n=JSON.parse(t.body);if(Array.isArray(n))for(let t=0;t<n.length;t++)n[t]?.variables?.playerType&&n[t]?.variables?.playerType!==OPT_FORCE_ACCESS_TOKEN_PLAYER_TYPE&&(e=n[t].variables.playerType,n[t].variables.playerType=OPT_FORCE_ACCESS_TOKEN_PLAYER_TYPE);else n?.variables?.playerType&&n?.variables?.playerType!==OPT_FORCE_ACCESS_TOKEN_PLAYER_TYPE&&(e=n.variables.playerType,n.variables.playerType=OPT_FORCE_ACCESS_TOKEN_PLAYER_TYPE);e&&(console.log(`Replaced '${e}' player type with '${OPT_FORCE_ACCESS_TOKEN_PLAYER_TYPE}' player type`),t.body=JSON.stringify(n))}}return _.apply(this,arguments)},"complete"===document.readyState||"loaded"===document.readyState||"interactive"===document.readyState?y():window.addEventListener("DOMContentLoaded",function(){y()}),window.simulateAds=e=>{void 0===e||e<0?console.log("Ad depth paramter required (0 = no simulated ad, 1+ = use backup player for given depth)"):p("SimulateAds",e)}}();