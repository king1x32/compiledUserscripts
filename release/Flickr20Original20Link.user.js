// ==UserScript==
// @name        Flickr Original Link
// @namespace   https://greasyfork.org/scripts/1190-flickr-original-link
// @include 	/flickr\.com/
// @version	6.0
// @grant       GM_getValue
// @grant       GM_setValue
// @grant 	GM_addStyle
// @require 	https://code.jquery.com/jquery-3.3.1.min.js
// @downloadURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/Flickr20Original20Link.user.js
// @updateURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/Flickr20Original20Link.meta.js
// ==/UserScript==
function t(t){console.log(t)}function e(){k&&$("div.interaction-view").css("opacity","1"),$("div.interaction-bar").css("bottom","1.1em")}function i(e){var i,n,o,r,a,c,s,h,p,g;if(null!==e){if(null===(i=e.match(/"sizes":.+?}}/gi)))return!1;for(null==(n=e.match(/"datePosted":"\d+"/gi))&&t("cannot find any dates"),o=$("div.photo-list-photo-view"),"album"==l&&(o=$("div.photo-card-view div.foot")),t("Number of photo in this page: "+o.length),r=0;r<o.length;r++)if(!((a=$(o[r])).find(".myFuckingLink").filter(":first").length>0))for(a.html(a.html()+'<a class="myFuckingLink"></a>'),c=0;c<b.length;++c)if(null!==(s=i[r].match(new RegExp('"'+b[c]+'".*?:{"displayUrl":"([^"]+)","width":(\\d+),"height":(\\d+)',"i")))){(h=a.find(".myFuckingLink")).attr("href",s[1].replace(/\\/g,"").replace(/(_[0-9a-z]+)\.([a-z]{3,4})/i,"$1"+d+"$2")),p=n[r].match(/\d+/i),g=new Date(1e3*new Number(p)),h.attr("title",u+s[2]+" x "+s[3]+" | Upload: "+g.toLocaleDateString()),h.html(u+s[2]+" x "+s[3]);break}}}function n(){var t,e=$(this);return e.find(".myFuckingLink").filter(":first").length>0?(e.off("mouseenter"),!1):null!=(t=e.find("a").filter(":first").attr("href"))&&(e.append('<a class="myFuckingLink">(Link loading...)</a>'),void $.get(t,function(t){var i=t.match(/"displayUrl":"([^"]+)","width":(\d+),"height":(\d+)[^}]+}}/i),n=i[1].replace(/\\/g,"").replace(/(_[0-9a-z]+)\.([a-z]{3,4})/i,"$1"+d+"$2"),o=u+i[2]+" x "+i[3]+" Upload: ",l=e.find(".myFuckingLink");l.attr("href",n),l.attr("title",o),l.html(o)}))}function o(){var o,a,c;r=document.URL,o="none",a=$("html").attr("class"),console.log("HTML class: "+a),null!==a.match(/html-photo-page.+scrappy-view/i)?o="single":null!==a.match(/html-(search-photos-unified|group-pool)-page-view/i)?o="hover":$("div.photo-list-photo-view").filter(":first").length>0?o="normal":$("div.photo-list-view").filter(":first").length>0&&(o="album"),console.log("Page type: "+o),l=o,t("Begin get settings"),f=GM_getValue(g,!1),k=GM_getValue(m,!1),f?(d=".",h=' checked="checked" ',u="OPEN "):(d="_d.",h="",u="DOWNLOAD "),p=k?' checked="checked" ':"",e(),c=".myFuckingLink{position:absolute;z-index:999999;left:3px;bottom:0px;width:100%;display:block;color:white!important;} .myFuckingLink:hover{background-color:rgba(100, 100, 255,0.65)!important} .commonButton{display: inline-block;border-radius: 0.5em;margin: 0.2em;padding: 0.5em;font-size: 90%;height: fit-content;} .bigButton{background-color: lightgreen} .smallButton{background-color:pink}","album"==l&&(c=".myFuckingLink{position:absolute;z-index:999999;left:5px;bottom:0px;width:100%;display:block;} .myFuckingLink:hover{background-color:rgba(100, 100, 255,0.65)!important} .commonButton{display: inline-block;border-radius: 0.5em;margin: 0.2em;padding: 0.5em;font-size: 90%;height: fit-content;} .bigButton{background-color: lightgreen} .smallButton{background-color:pink}"),GM_addStyle(c),$(".myOptionBox").remove(),$("ul.nav-menu:first").append('<li class="myOptionBox"><div style="color:pink;padding:1px"><input id="optionbox_openLink" type="checkbox"'+h+'style="margin:2px"/>Open image link in browser<br><input id="optionbox_alwaysShow" type="checkbox"'+p+'style="margin:2px"/>Always show image information in Photostream</div></li>'),$("#optionbox_openLink").change(function(){GM_setValue(g,$(this).prop("checked"))}),$("#optionbox_alwaysShow").change(function(){GM_setValue(m,$(this).prop("checked"))}),"single"==l?function(){if($(".commonButton").length>0)return!1;$.get(document.URL,function(t){var e,i,n,o=t.match(/modelExport: {.+?"sizes":{.+?}}/i),l=o[0].match(/"width":"?\d+"?,"height":"?\d+"?,/gi),r=o[0].match(/"displayUrl":"[^"]+"/gi),a=r.length;for(e=0;e<a;e++)l[e]=l[e].replace(/"width":(\d+),"height":(\d+),/i,"$1 x $2"),r[e]=r[e].replace(/"displayUrl":"([^"]+)"/i,"$1").replace(/\\/g,"").replace(/(_[0-9a-z]+)\.([a-z]{3,4})/i,"$1"+d+"$2");for(i=$(".sub-photo-right-row1").filter(":first"),n='<div><a class="commonButton bigButton" href="'+r[a-1]+'">'+u+l[a-1]+" px</a>",e=a-2;e>=a-7&&e>=0;--e)n+='<a class="commonButton smallButton" href="'+r[e]+'">'+l[e]+" px</a>";n+="</div>",i.prop("outerHTML",n+i.prop("outerHTML"))})}():"normal"==l||"album"==l?function(n){var o=$("#content")[0],l="none",r=0,a=null,c=function(n){var o,c,s=$("div.photo-list-photo-view");if("album"==n&&(s=$("div.photo-card-view")),document.URL==l){if(s.length==r)return!1;e(),t("Number of thumb: "+(r=s.length)),i(a)}else{if((o=s.find("a").filter(":first")).length<1)return!1;e(),a=null,l=document.URL,c=o.attr("href"),console.time("GetSource"),$("#content").append('<div id="loadingIndicator" style="position:fixed;left:5px;bottom:2em;display:block;background-color:pink;border:solid;padding:3px">Getting original link<br>Please wait...</div>'),t("Begin get source 1: "+c),$.get(c,function(e){var n=e.match(/<a\s+class=.+?entry-type.+?href='([^']+)/i)[1];t("Begin get source 2: "+(n=n.replace("/albums/","/sets/"))),$.get(n,function(e){t("Got final source: "+n),console.timeEnd("GetSource"),$("#loadingIndicator").remove(),i(a=e)})})}};c(n),(v=new MutationObserver(function(){c(n)})).observe(o,{childList:!0,subtree:!0})}(l):"hover"==l&&function(){var i=$("body")[0],o=0;(v=new MutationObserver(function(){var i=$("div.photo-list-photo-view");if(i.length==o)return!1;t("Number of thumb: "+i.length),o=i.length,e(),i.mouseenter(n)})).observe(i,{childList:!0,subtree:!0})}()}var l,r,a,c,s,d="_d.jpg",u="DOWNLOAD ",h="",p="",g="flickr_openLink",m="flickr_alwaysShow",f=!1,k=!1,b=["9k","8k","7k","6k","5k","4k","3k","2k","o","k","h","l","b","c","z"],v=null;t("Begin flickr script"),l="none",r="none",t("Kickstart"),a=new Number("1469473824"),t("Time number: "+new Date(1e3*a).toLocaleDateString("vi-VN")),o(),c=$("html")[0],s={childList:!1,attributes:!0},new MutationObserver(function(){r!=document.URL&&(null!==v&&v.disconnect(),o())}).observe(c,s);