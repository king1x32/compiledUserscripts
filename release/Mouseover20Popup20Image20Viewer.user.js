// ==UserScript==
// @name        Mouseover Popup Image Viewer
// @namespace   https://github.com/tophf
//
// @include     *
// @run-at      document-start
//
// @grant       GM_addElement
// @grant       GM_download
// @grant       GM_getValue
// @grant       GM_getValues
// @grant       GM_openInTab
// @grant       GM_registerMenuCommand
// @grant       GM_unregisterMenuCommand
// @grant       GM_setClipboard
// @grant       GM_setValue
// @grant       GM_xmlhttpRequest
//
// @grant       GM.getValue
// @grant       GM.openInTab
// @grant       GM.registerMenuCommand
// @grant       GM.unregisterMenuCommand
// @grant       GM.setClipboard
// @grant       GM.setValue
// @grant       GM.xmlHttpRequest
//
// @version     1.4.8
// @author      tophf
//
// @original-version 2017.9.29
// @original-author  kuehlschrank
//
// @connect     *
// CSP check:
// @connect     self
// rule installer in config dialog:
// @connect     github.com
// big/trusted hostings for the built-in rules with "q":
// @connect     deviantart.com
// @connect     facebook.com
// @connect     fbcdn.com
// @connect     flickr.com
// @connect     gfycat.com
// @connect     googleusercontent.com
// @connect     gyazo.com
// @connect     imgur.com
// @connect     instagr.am
// @connect     instagram.com
// @connect     prnt.sc
// @connect     prntscr.com
// @connect     user-images.githubusercontent.com
//
// @supportURL  https://github.com/tophf/mpiv/issues
// @icon        https://raw.githubusercontent.com/tophf/mpiv/master/icon.png
// @downloadURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/Mouseover20Popup20Image20Viewer.user.js
// @updateURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/Mouseover20Popup20Image20Viewer.meta.js
// ==/UserScript==
"use strict";async function e({rule:t}={}){function i(t){f=t,function(){for(const e of se("input[id], select[id], textarea[id]",w))e.id in f&&(e["checkbox"===e.type?"checked":"value"]=f[e.id]);for(const e of se('input[type="range"]',w))e.oninput();for(const e of se('a[href^="http"]',w))Object.assign(e,{target:"_blank",rel:"noreferrer noopener external"});S.delay.valueAsNumber=f.delay/1e3,S.scale.valueAsNumber=Math.round(100*W(f.scale-1,0,1)),S.start.onchange()}(),m(),function(){const t=S._rules;t.addEventListener("input",d),t.addEventListener("focusin",p),t.addEventListener("paste",p),y=e.blankRuleElement=e.blankRuleElement||t.firstElementChild.cloneNode(),y.nextElementSibling&&(t.textContent="",t.appendChild(y.cloneNode()));for(const e of f.hosts||[]){const o=y.cloneNode();o.value="string"==typeof e?e:N.format(e),t.appendChild(o),d({target:o})}const o=S._search;o.oninput=()=>{e.search=o.value;const n=o.value.toLowerCase();for(const e of t.children)e.hidden=n&&!e.value.toLowerCase().includes(n)},o.value=e.search||"",o.value&&o.oninput()}(),requestAnimationFrame(()=>{S.css.style.minHeight=W(S.css.scrollHeight,40,r.clientHeight/4)+"px"})}function a(e){const t="_apply"===this.id;if(e&&("_ok"===this.id||t)&&(n=f=c({save:!0,clone:t}),N.init(),I.reRegisterAlt(),t))return m();ge(r),r=null}function c({save:e,clone:t}={}){let o={};for(const e of se("input[id], select[id]",w))o[e.id]="checkbox"===e.type?e.checked:"number"===e.type||"range"===e.type?e.valueAsNumber:e.value||"";return Object.assign(o,{css:S.css.value.trim(),delay:1e3*S.delay.valueAsNumber,hosts:u(),scale:W(S.scale.valueAsNumber/100,0,1)+1,scales:S.scales.value.trim().split(/[,;]*\s+/).map(e=>e.replace(",",".")).filter(e=>!isNaN(parseFloat(e)))}),t&&(o=JSON.parse(P.stringify(o))),new O({data:o,save:e})}function u(){return[...S._rules.children].map(e=>[e.value.trim(),e[h]]).sort((e,t)=>e[0]<t[0]?-1:e[0]>t[0]?1:0).map(([e,t])=>t||e).filter(Boolean)}function d({target:e}){let t,o,n;const r=e.previousElementSibling;if(e.value){t=N.parse(e.value),o=t instanceof Error&&(t.message||String(t));const i=!o&&t&&"string"==typeof t.d&&!/^[-.a-z0-9]*$/i.test(t.d);n=[i&&'Disabled due to invalid characters in "d"',o].filter(Boolean).join("\n"),e.classList.toggle("invalid-domain",i),e.classList.toggle("matching-domain",!!t.d&&l.includes(t.d)),r||e.insertAdjacentElement("beforebegin",y.cloneNode())}else r&&(r.focus(),e.remove());e[h]=!o&&t,e.title=n,e.setCustomValidity(o||"")}async function p({target:e,relatedTarget:t}){if(e!==this){if(await new Promise(setTimeout),e[h]&&e.rows<2){let t=e.selectionStart;const o=e.value=N.format(e[h],{expand:!0});t+=o.slice(0,t).match(/^\s*/gm).reduce((e,t)=>e+t.length,0),e.setSelectionRange(t,t),e.rows=o.match(/^/gm).length}this.contains(t)||(t=[...se('[style*="height"]',this)].find(t=>t!==e))}}function m(){S.scales.value=f.scales.join(" ").trim()||O.DEFAULTS.scales.join(" "),S._css.textContent=n._getCss()}if(!Q(s.body.attachShadow))return void alert("Cannot show MPIV config dialog: the browser is probably too old.\nYou can edit the script's storage directly in your userscript manager.");const h=e.RULE||(e.RULE=Symbol("rule"));let f,b,w=(r||0).shadowRoot,{blankRuleElement:y}=e,v=0,x=0,k=0,$=0;const S=e.UI=new Proxy({},{get:(e,t)=>w.getElementById(t)});r||(r=le("div",{contentEditable:!0}),w=r.attachShadow({mode:"open"}),w.append(...function(){const e="https://github.com/tophf/mpiv/wiki/",t="Leave it empty and click Apply or OK to restore the default values.",o=(e,t,o)=>le("a",Object.assign({target:"_blank"},t&&{href:t},o),e),n=(e,t,o="",n)=>le("label",Object.assign({title:o},n),[le("input",{id:t,type:"checkbox"}),e]),r=e=>"{"===e[0]?le("kbd",e.slice(1,-1)):e,i=(e,t="",o=0,n=100,r=1,i="range")=>le("input",{id:e,min:o,max:n,step:r,type:i,"data-title":t}),a=(e,t,o)=>le("label",[e,le("select",{id:t},Object.entries(o).map(([e,t])=>le("option",Object.assign({value:e},"object"==typeof t?t:{textContent:t}))))]),s=([e,t])=>le("tr",e?[le("th",((e=e.split(/(\n)/))[0]=le("b",e[0]))&&e),le("td",t.split(/({.+?})/).map(r))]:le("br")),l='...when the "popup shows" option is "automatically"',c={"data-start-auto":""};return[le("style#_cssSetup",K),le("style#_css"),le(`main#${g}setup`,[le("#_mover"),le("#_x","x"),le("ul#_ul.column",[le("details",{style:"order:1; padding-top: .5em;"},[le("summary",{style:"cursor: pointer"},le("b","Help & hotkeys...")),le("#_usage",[le("table",[["Activate","hover the target"],["Deactivate","move cursor off target, or click, or zoom out fully"],["Ignore target","hold {Shift} ⏵ hover the target ⏵ release the key"],["Freeze popup","hold {Shift} ⏵ leave the target ⏵ release the key"],["Force-activate\n(videos or small pics)","hold {Ctrl} ⏵ hover the target ⏵ release the key"]].map(s)),le("table",[["Start zooming","configurable (automatic or via right-click)\nor tap {Shift} while popup is visible"],["Zoom","mouse wheel"],[],["Rotate",'{L} {r} for "left" or "right"'],["Flip/mirror",'{h} {v} for "horizontal" or "vertical"'],["Previous/next\n(in album)","mouse wheel, {j} {k} or {←} {→} keys"]].map(s)),le("table",[["Antialiasing","{a}"],["Caption in info","{c}"],["Download","{d}"],["Fullscreen","{f}"],["Info","{i}"],["Mute","{m}"],["Night mode","{n}"],["Open in tab","{t}"]].map(s))])]),le("li.options.stretch",[a("Popup shows on","start",{context:"Right-click / ≡ / Ctrl",contextMK:"Right-click / ≡",contextM:"Right-click",contextK:{textContent:"≡ key",title:"≡ is the Menu key (near the right Ctrl)"},ctrl:"Ctrl",auto:"automatically"}),le("label",{title:l,...c},["after, sec",i("delay","seconds",.05,10,.05,"number")]),le("label",{title:"(if the full version of the hovered image is ...% larger)"},["if larger, %",i("scale",null,0,100,1,"number")]),a("Zoom activates on","zoom",{context:"Right click / Shift",wheel:"Wheel up / Shift",shift:"Shift",auto:"automatically"}),a("...and zooms to","fit",{all:"fit to window",large:"fit if larger",no:"100%","":{textContent:"custom",title:"Use custom scale factors"}})]),le("li.options",[le("label",["Zoom step, %",i("zoomStep",null,100,400,1,"number")]),a("When fully zoomed out:","zoomOut",{stay:"stay in zoom mode",auto:"stay if still hovered",unzoom:"undo zoom mode",close:"close popup"}),le("label",{style:"flex: 1",title:`\n              Scale factors to use when “zooms to” selector is set to “custom”.\n              0 = fit to window,\n              0! = same as 0 but also removes smaller values,\n              * after a value marks the default zoom factor, for example: 1*\n              The popup won't shrink below the image's natural size or window size for bigger mages.\n              ${t}\n            `.trim().replace(/\n\s+/g,"\r")},["Custom scale factors:",le("input#scales",{placeholder:t})])]),le("li.options.row",[le([n("Centered*","center","...or try to keep the original link/thumbnail unobscured by the popup"),n("Preload on hover*","preload","Provides smoother experience but increases network traffic"),n("Require Ctrl key for video*","videoCtrl",l,c),n("Mute videos*","mute",'Hotkey: "m" in the popup'),n("Keep playing video*","keepVids","...until you press Esc key or click elsewhere"),n("Keep preview on blur*","keepOnBlur","i.e. when mouse pointer moves outside the page")]),le([n("Show complete image*","waitLoad","...or immediately show a partial image while still loading"),n("Shadow only when complete*","uiShadowOnLoad","...to avoid showing the semi-transparent background while still loading from a slow site"),le("div.flex",{style:"align-items:center"},[n("Info: show for","uiInfo",'Hotkey: "i" (or hold "Shift") in the popup'),le("input#uiInfoHide",{min:1,step:"any",type:"number"}),"sec"]),n("Info: only once*","uiInfoOnce","...or every time the info changes"),n("Info: caption*","uiInfoCaption",'Hotkey: "c" in the popup'),n("Fade-in transition","uiFadein"),n("Fade-in transition in gallery","uiFadeinGallery")]),le([n("Night mode*","night",'Hotkey: "n" in the popup'),n("Run in image tabs","imgtab"),n("Spoof hotlinking*","xhr","Disable only if you spoof the HTTP headers yourself"),n("Set status on <html>*","globalStatus","Causes slowdowns so don't enable unless you explicitly use it in your custom CSS"),n("Auto-start switch in menu*","startAltShown","Show a switch for 'auto-start' mode in userscript manager menu")])]),le("li.options.stretch",[le("label",["Background",le("span",[le("input#uiBackgroundColor",{type:"color"}),le("u"),i("uiBackgroundOpacity","Opacity: $%")])]),le("label",["Border color, opacity, size",le("span",[le("input#uiBorderColor",{type:"color"}),le("u"),i("uiBorderOpacity","Opacity: $%"),i("uiBorder","Border size: $px",0,20)])]),le("label",["Shadow color, opacity, size",le("span",[le("input#uiShadowColor",{type:"color"}),le("u"),i("uiShadowOpacity","Opacity: $%"),i("uiShadow",'Shadow blur radius: $px\n"0" disables the shadow.',0,20)])]),le("label",["Padding",le("span",i("uiPadding","Padding: $px"))]),le("label",["Margin",le("span",i("uiMargin","Margin: $px"))])]),le("li",[o("Custom CSS:",`${e}Custom-CSS`)," e.g. ",le("b","#mpiv-popup { animation: none !important }"),o("View the built-in CSS","",{id:"_reveal",tabIndex:0,style:"float: right",title:"You can copy parts of it to override them in your custom CSS"}),le(".column",[le("textarea#css",{spellcheck:!1}),le("textarea#_cssApp",{spellcheck:!1,hidden:!0,readOnly:!0,rows:30})])]),le("li.flex",{style:"justify-content: space-between;"},[le("div",o("Custom host rules:",`${e}Custom-host-rules`)),le("div",{style:"white-space: pre-line"},["To disable, put any symbol except ",le("code","a..z 0..9 - ."),'\nin "d" value, for example ',le("code",'"d": "!foo.com"')]),le("div",le("input#_search",{type:"search",placeholder:"Search",style:"width: 10em; margin-left: 1em"}))]),le("li",{style:"margin-left: -3px; margin-right: -3px; overflow-y: auto; padding-left: 3px; padding-right: 3px;"},[le("div#_rules.column",le("textarea",{spellcheck:!1,rows:1}))]),le("li#_rules2")]),le("div.flex",[le("button#_ok",{accessKey:"o"},"OK"),le("button#_apply",{accessKey:"a"},"Apply"),le("button#_cancel","Cancel"),le("a",{href:`${e}Rules`,style:"margin: 0 auto"},le("button#_install",{style:"color: inherit"},"Find rule...")),le("button#_import","Import"),le("button#_export",{style:"margin: 0"},"Export"),le("div#_exportNotification",{hidden:!0},"Copied to clipboard")])])]}()),function(){function e({x:e,y:t}){e=k=W(e-v,-innerWidth+4*H,r.clientWidth-H),t=$=W(t-x,0,innerHeight-3*H),ce(b,{transform:`translate(${e}px, ${t}px)`}),S._ul.style.maxHeight=`calc(100vh - ${G+t-H}px)`}function t(){removeEventListener("mousemove",e,!0),removeEventListener("mouseup",t,!0),removeEventListener("keydown",n,!0),ce(b,{opacity:""})}function n(o){"Escape"!==o.key||X(o)||(o.stopPropagation(),e({x:v,y:x}),t())}function s(){this.elSwatch.style.setProperty("--color",P.color(this.value,this.elOpacity.valueAsNumber))}function l(e){this.elEdit&&e.relatedTarget!==this.elEdit&&this.elEdit.onblur(e)}function u(){if(this.elEdit)return;const{min:e,max:t,step:o,value:n}=this;this.elEdit=le("input",{value:n,min:e,max:t,step:o,className:"range-edit",style:`left: ${this.offsetLeft}px; margin-top: ${this.offsetHeight+1}px`,type:"number",elRange:this,onblur:p,oninput:m}),this.insertAdjacentElement("afterend",this.elEdit)}function d(){this.title=(this.dataset.title||"").replace("$",this.value),this.elColor&&this.elColor.oninput(),this.elEdit&&(this.elEdit.valueAsNumber=this.valueAsNumber)}function p(e){e.relatedTarget!==this.elRange&&(this.remove(),this.elRange.elEdit=null)}function m(){this.elRange.valueAsNumber=this.valueAsNumber,this.elRange.oninput()}S._mover.onmousedown=o=>{o.button||X(o)||(b||(b=S._cssSetup.sheet,b.insertRule(":host {}"),b=b.cssRules[1]),addEventListener("mousemove",e,!0),addEventListener("mouseup",t,!0),addEventListener("keydown",n,!0),v=o.x-k,x=o.y-$,ce(b,{opacity:.75}))},S._apply.onclick=S._cancel.onclick=S._ok.onclick=S._x.onclick=a,S._export.onclick=e=>{Z(e),GM.setClipboard(P.stringify(c(),null,"  ")),S._exportNotification.hidden=!1,setTimeout(()=>S._exportNotification.hidden=!0,1e3)},S._import.onclick=e=>{Z(e);const t=prompt("Paste settings:");t&&i(new O({data:t}))},S._install.onclick=o;const h=S._cssApp;S._reveal.onclick=e=>{e.preventDefault(),h.hidden=!h.hidden,h.hidden||(h.value||(M.updateStyles(),h.value=M.globalStyle.trim(),h.setSelectionRange(0,0)),h.focus())},S.start.onchange=function(){S[g+"setup"].dataset.start=this.value},S.xhr.onclick=({target:e})=>e.checked||confirm(me(e,"title"));for(const e of se('[type="color"]',w))e.oninput=s,e.elSwatch=e.nextElementSibling,e.elOpacity=S[e.id.replace("Color","Opacity")],e.elOpacity.elColor=e;for(const e of se('[type="range"]',w))e.oninput=d,e.onblur=l,e.addEventListener("focusin",u);w.addEventListener("keydown",e=>!e.altKey&&!e.metaKey&&e.stopPropagation(),!0)}()),r.parentElement!==s.body&&(i(await O.load({save:!0})),s.body.append(r)),t&&function(e){const t=S._rules.children;let o=[...t].find(t=>P.deepEqual(t[h],e));o||(o=t[0],o[h]=e,o.value=N.format(e),o.hidden=!1,t[Math.max(0,u().indexOf(e))].insertAdjacentElement("afterend",o),t[0].insertAdjacentElement("beforebegin",y.cloneNode()));const n=o.getBoundingClientRect();(n.bottom<0||n.bottom>o.parentNode.offsetHeight)&&o.scrollIntoView(),o.classList.add("highlight"),o.addEventListener("animationend",()=>o.classList.remove("highlight"),{once:!0}),o.focus()}(t)}function t(t){let o;const n=t.target.closest("blockquote, code, pre");n&&!t.button&&!X(t)&&(o=N.fromElement(n))&&(Z(t),e({rule:o}))}async function o(t){function o(e,t,o){return 9===t&&o.length>10?"...":t>10?"":(e.length>100?e.slice(0,100)+"...":e).replace(/^\s/,"")}function n(t){X(t)||e({rule:i[t.currentTarget.selectedIndex][1]})}Z(t);const r=e.UI._rules2;let i;this.disabled=!0,this.textContent="Loading...";try{i=function({doc:e}){return[...se("#wiki-body tr",e)].map(e=>[e.cells[0].textContent.trim(),N.fromElement(e.cells[1])]).filter(([e,t])=>e&&t&&(!t.d||l.includes(t.d))).sort(([e],[t])=>(e=e.toLowerCase())<(t=t.toLowerCase())?-1:e>t?1:0)}(await U.getDoc(this.parentElement.href)),this.textContent="Rules loaded.";const e=le("select",{size:8,style:"width: 100%",ondblclick:t=>t.target!==e&&n(t),onkeyup:e=>"Enter"===e.key&&n(e)},i.map(function([e,t]){return le("option",{textContent:e,title:N.format(t,{expand:!0}).replace(/^{|\s*}$/g,"").split("\n").slice(0,12).map(o).filter(Boolean).join("\n")})})),t=e.selectedIndex=function(){const e=`.${l}.`;let t=0,o=0,n=0;for(const[r,{d:a}]of i){let i=10*!(!a||!l.includes(a));for(const t of r.toLowerCase().split(/[^a-z\d.-]+/i))i+=e.includes(`.${t}.`)&&t.length;i>t&&(t=i,o=n),n++}return o}();r.append(le("div#_installHint",["Double-click the rule (or select and press Enter) to add it. ","Click ",le("code","Apply")," or ",le("code","OK")," to confirm."]),e),t&&requestAnimationFrame(()=>{const t=e.selectedOptions[0].offsetTop-e.offsetTop;e.scrollTo(0,t-e.offsetHeight/2)}),e.focus()}catch(t){r.textContent="Error loading rules: "+(t.message||t)}}let n,r,i,a={rule:{}};const s=document,l=location.hostname,c="."+l,u=CSS.supports("-moz-appearance","none"),d=window.AudioContext||function(){},{from:p,isArray:m}=Array,g="mpiv-",h="data-no-aa",f=`${g}status`,b=Object.assign({},...["getViewSize","viewSize"].map(e=>({[e]:`${g}${e}`}))),w="onwheel"in s?"wheel":"mousewheel",y=/(^|[^-\w])return[\W\s]/,v=/'Trusted(Script| Type)'|unsafe-eval/,x=/https?:\/\/[^\s"<>]+?\.(jpe?g|gif|png|svg|web[mp]|mp4)[^\s"<>]*|$/i,k=/^(?!data:)[^?#]+?\.(avif|bmp|jpe?g?|gif|mp4|png|svgz?|web[mp])($|[?#])/i,$=Symbol("u"),S={s:["m","node","rule"],c:["text","doc","node","rule"],q:["text","doc","node","rule"],g:["text","doc","url","m","rule","node","cb"]};let _,E;"undefined"!=typeof GM&&GM.xmlHttpRequest||(this.GM={__proto__:null,info:GM_info}),GM.getValue||(GM.getValue=GM_getValue),GM.setValue||(GM.setValue=GM_setValue),GM.openInTab||(GM.openInTab=GM_openInTab),GM.registerMenuCommand||"function"!=typeof GM_registerMenuCommand||(GM.registerMenuCommand=GM_registerMenuCommand),GM.unregisterMenuCommand||"function"!=typeof GM_unregisterMenuCommand||(GM.unregisterMenuCommand=GM_unregisterMenuCommand),GM.setClipboard||(GM.setClipboard=GM_setClipboard),GM.xmlHttpRequest||(GM.xmlHttpRequest=GM_xmlhttpRequest);const M={isEnabled:!0,isImageTab:!1,globalStyle:"",popupStyleBase:"",tabfix:/\.(dumpoir|greatfon|picuki)\.com$/.test(c),NOP:/\.(facebook|instagram|chrome|google)\.com$/.test(c)&&(()=>{}),activate(e,t){const{match:o,node:i,rule:s,url:l}=e,c="auto"===n.start,u=n.videoCtrl&&ee(i);r&&console.info({node:i,rule:s,url:l,match:o}),c&&u&&!T.ctrl||(a.node&&M.deactivate(),a=e,a.force=T.ctrl,a.gNum=0,a.zooming=n.css.includes(`${g}zooming`),P.suppressTooltip(),z.updateViewSize(),T.ctrl=!1,T.toggle(!0),T.trackMouse(t),a.force&&(c||"ctrl"===n.start||"context"===n.start)?M.start():!c&&!n.preload||u||s.manual?B.set("ready"):M.belate(c))},belate(e){n.preload?(a.preloadStart=e?te():-1,M.start(),B.set("+preloading")):a.timer=setTimeout(M.start,n.delay)},checkProgress({start:e}={}){const t=a.popup;if(!t)return;const o=a.nwidth=t.naturalWidth||t.videoWidth||a.popupLoaded&&innerWidth/2,n=a.nheight=t.naturalHeight||t.videoHeight||a.popupLoaded&&innerHeight/2;if(n)return M.canCommit(o,n);e&&(clearInterval(a.timerProgress),a.timerProgress=setInterval(M.checkProgress,150))},canClose:(e=a.popup)=>!e||(ee(e)?!n.keepVids:document.fullscreenElement!==e),canCommit(e,t){if(!a.force&&a.rect&&!a.gItems&&Math.max(e/(a.rect.width||1),t/(a.rect.height||1))<n.scale)return M.deactivate(),!1;M.stopTimers();let o=a.preloadStart;return o<0&&!a.force||!a.popup?void 0:(o>0&&(o+=n.delay-te())>0?a.timer=setTimeout(M.checkProgress,o):e&&t||!(a.urls||[]).length?M.commit():M.handleError({type:"error"}),!0)},async commit(){const e=a.popupShown=a.popup,t=n.waitLoad&&Q(e.decode);t&&(await e.decode(),e!==a.popup)||(B.set("-preloading"),M.updateStyles(),z.measurePopup(),(!("auto"===n.zoom||M.isImageTab&&n.imgtab)||void 0===M.toggleZoom({keepScale:!0}))&&R.move(),C.updateName(),C.updateDetails(),B.set(!a.popupLoaded&&"loading"),a.large=a.nwidth>e.clientWidth+a.extras.w||a.nheight>e.clientHeight+a.extras.h,a.large&&(B.set("+large"),u&&e.complete&&!t&&(e.style.backgroundImage=`url('${e.src}')`)),a.preloadStart<0&&Q(e.play)&&e.play().catch(te))},deactivate({wait:e}={}){M.stopTimers(!0),a.req&&ne(a.req.abort),a.tooltip&&(a.tooltip.node.title=a.tooltip.text),B.set(!1),C.set(!1),T.toggle(!1),R.destroy(),e&&(M.isEnabled=!1,setTimeout(M.enable,200)),a={rule:{}}},enable(){M.isEnabled=!0},handleError(e,t=a.rule){if(t&&"skip"===t.onerror)return;if(a.imageUrl&&!a.xhr&&!a.imageUrl.startsWith(location.origin+"/")&&"https:"===location.protocol&&L.init)return void R.create(a.imageUrl,a.pageUrl,e);const o=P.formatError(e,t);t&&a.urls&&a.urls.length||console.warn(...o),a.urls&&a.urls.length?(a.url=a.urls.shift(),a.url?(M.stopTimers(),M.startSingle()):M.deactivate()):a.node&&(B.set("error"),C.set(o.message,"error"))},onMessage(e){if("string"==typeof e.data&&e.data===b.getViewSize){e.stopImmediatePropagation();for(const t of s.getElementsByTagName("iframe"))if(t.contentWindow===e.source){const o=z.frameSize(t,window).join(":");return void e.source.postMessage(`${b.viewSize}:${o}`,"*")}}},onMessageChild(e){if(e.source===parent&&"string"==typeof e.data&&e.data.startsWith(b.viewSize)){e.stopImmediatePropagation(),removeEventListener("message",M.onMessageChild,!0);const[t,o,n,r]=e.data.split(":").slice(1).map(parseFloat);t&&o&&(a.view={w:t,h:o,x:n,y:r})}},start(){M.updateStyles(),a.gallery?M.startGallery():M.startSingle()},startSingle(){B.loading(),a.force&&a.preloadStart<0?M.commit():(a.imageUrl=null,!a.rule.follow||a.rule.q||a.rule.s?a.rule.q&&!m(a.urls)?M.startFromQ():(R.create(a.url),N.runC()):U.findRedirect())},async startFromQ(){try{const{responseText:e,doc:t,finalUrl:o}=await U.getDoc(a.url),n=N.runQ(e,t,o);if(!n)return void M.handleError(['The "q" rule did not produce any URL.',"\nRemote doc: %o",t]);if(q.isFollowableUrl(n,a.rule)){const e=q.find(n,a.node,{noHtml:!0});if(!e||!e.url)throw`Couldn't follow URL: ${n}`;Object.assign(a,e),M.startSingle()}else R.create(n,o),N.runC(e,t)}catch(e){M.handleError(e)}},async startGallery(){B.loading();try{const e=a.url,t=await U.getDoc("gallery"!==a.rule.s&&e),o=await new Promise(e=>{const o=a.gallery(t.responseText,t.doc,t.finalUrl,a.match,a.rule,a.node,e);void 0!==o&&e(o)});if(a.url!==e)return;if(a.gNum=o.length,a.gItems=o.length&&o,!a.gItems)throw"Empty gallery";{const e=o.index;a.gIndex=e>=0&&o[e]?+e:A.findIndex("string"==typeof e?e:a.url),setTimeout(A.next)}}catch(e){M.handleError(e)}},stopTimers(e){for(const t of["timer","timerStatus",e&&"timerBar"])clearTimeout(a[t]);clearInterval(a.timerProgress)},toggleZoom({keepScale:e}={}){const t=a.popup;if(t&&a.scales&&!(a.scales.length<2))return a.zoomed=!a.zoomed,a.scale=a.zoomed&&z.scaleForFirstZoom(e)||a.scales[0],a.zooming&&t.classList.add(`${g}zooming`),R.move(),C.updateDetails(),B.set(!!a.zoomed&&"zoom"),a.zoomed},updateStyles(){P.addStyle("global",(M.globalStyle||(M.globalStyle=(String.raw`
#\mpiv-bar {
  position: fixed;
  z-index: 2147483647;
  top: 0;
  left: 0;
  right: 0;
  text-align: center;
  font-family: sans-serif;
  font-size: 15px;
  font-weight: bold;
  background: #0005;
  color: white;
  padding: 4px 10px;
  text-shadow: .5px .5px 2px #000;
  transition: opacity 1s ease .25s;
  opacity: 0;
}
#\mpiv-bar[data-force] {
  transition: none;
}
#\mpiv-bar.\mpiv-show {
  opacity: 1;
}
#\mpiv-bar[data-zoom][data-prefix]::before {
  content: "[" attr(data-prefix) "] ";
  color: gold;
}
#\mpiv-bar[data-zoom]:not(:empty)::after {
  content: " (" attr(data-zoom) ")";
  opacity: .8;
}
#\mpiv-bar[data-zoom]:empty::after {
  content: attr(data-zoom);
}
#\mpiv-popup.\mpiv-show {
  display: inline;
}
#\mpiv-popup {
  display: none;
  cursor: none;
  box-shadow: none;
${n.uiFadein?String.raw`
  animation: .2s \mpiv-fadein both;
  transition: box-shadow .25s, background-color .25s;
  `:""}
${M.popupStyleBase="\n  border: none;\n  box-sizing: border-box;\n  background-size: cover;\n  position: fixed;\n  z-index: 2147483647;\n  padding: 0;\n  margin: 0;\n  top: 0;\n  left: 0;\n  width: auto;\n  height: auto;\n  transform-origin: center;\n  max-width: none;\n  max-height: none;\n"}
}
#\mpiv-popup.\mpiv-show {
  ${n.uiBorder?`border: ${n.uiBorder}px solid ${P.color("Border")};`:""}
  ${n.uiPadding?`padding: ${n.uiPadding}px;`:""}
  ${n.uiMargin?`margin: ${n.uiMargin}px;`:""}
}
#\mpiv-popup.\mpiv-show${n.uiShadowOnLoad?"[loaded]":""} {
  background-color: ${P.color("Background")};
  ${n.uiShadow?`box-shadow: 2px 4px ${n.uiShadow}px 4px ${P.color("Shadow")};`:""}
}
#\mpiv-popup[data-gallery-flip] {
  animation: none;
  transition: none;
}
#\mpiv-popup[${h}],
#\mpiv-popup.\mpiv-zoom-max {
  image-rendering: pixelated;
}
#\mpiv-popup.\mpiv-night:not(#\\0) {
  box-shadow: 0 0 0 ${Math.max(screen.width,screen.height)}px #000;
}
body:has(#\mpiv-popup.\mpiv-night)::-webkit-scrollbar {
  background: #000;
}
#\mpiv-setup {
}
@keyframes \mpiv-fadein {
  from {
    opacity: 0;
    border-color: transparent;
  }
  to {
    opacity: 1;
  }
}
`+(n.globalStatus?String.raw`
:root.\mpiv-loading:not(.\mpiv-preloading) *:hover {
  cursor: progress !important;
}
:root.\mpiv-edge #\mpiv-popup {
  cursor: default;
}
:root.\mpiv-error *:hover {
  cursor: not-allowed !important;
}
:root.\mpiv-ready *:hover,
:root.\mpiv-large *:hover {
  cursor: zoom-in !important;
}
:root.\mpiv-shift *:hover {
  cursor: default !important;
}
`:String.raw`
[\mpiv-status~="loading"]:not([\mpiv-status~="preloading"]):hover {
  cursor: progress;
}
[\mpiv-status~="edge"]:hover {
  cursor: default;
}
[\mpiv-status~="error"]:hover {
  cursor: not-allowed;
}
[\mpiv-status~="ready"]:hover,
[\mpiv-status~="large"]:hover {
  cursor: zoom-in;
}
[\mpiv-status~="shift"]:hover {
  cursor: default;
}
`)).replace(/\\mpiv-status/g,f).replace(/\\mpiv-/g,g),M.popupStyleBase=M.popupStyleBase.replace(/;/g,"!important;"),M.globalStyle))+n._getCss()),P.addStyle("rule",a.rule.css||"")}},C={set(e,t,o){let r=a.bar;if("string"!=typeof e)return ge(r),void(a.bar=null);const i=!r&&0;r||(r=a.bar=le("div",{id:`${g}bar`,className:`${g}${t}`})),a.barText=e,M.updateStyles(),C.updateDetails(),C.setText(n.uiInfoCaption||"error"===t||"xhr"===t?e:""),he(r,"prefix",o),setTimeout(C.show,0,i),r.parentNode||(s.body.appendChild(r),P.forceLayout(r))},setText(e){/<([a-z][-a-z]*)[^<>]*>[^<>]*<\/\1\s*>/i.test(e)?a.bar.innerHTML=_?_(e):e:a.bar.textContent=e},show(e){const t=a.bar;!e&&(!n.uiInfo||0!==e&&n.uiInfoOnce)||a.barShown||(clearTimeout(a.timerBar),t.classList.add(g+"show"),he(t,"force",2===e?"":null),a.timerBar=!e&&setTimeout(C.hide,1e3*n.uiInfoHide),a.barShown=!0)},hide(e){const t=a.bar;t&&(e||n.uiInfo&&!t.dataset.force)&&a.barShown&&(he(t,"force",2===e?"":null),t.classList.remove(g+"show"),a.barShown=!1)},updateName(){const{gItems:e,gIndex:t,gNum:o}=a;if(e){const n=e[t],r=!e.some(e=>e.desc),i=[e.title&&(!t||r)&&!`${n.desc||""}`.includes(e.title)&&e.title||"",n.desc].filter(Boolean).join(" - ");C.set(i.trim()||" ","gallery",o>1?`${t+1}/${o}`:null)}else"caption"in a?C.set(a.caption,"caption"):a.tooltip?C.set(a.tooltip.text,"tooltip"):C.set(" ","info")},updateDetails(){if(!a.bar)return;const e=a.rotate,t=a.nwidth&&`${Math.round(100*a.scale)}%${a.flipX||a.flipY?`, ${a.flipX?"⇆":""}${a.flipY?"⇅":""}`:""}${e?", "+(e>180?e-360:e)+"°":""}, ${a.nwidth} x ${a.nheight} px, ${Math.round(a.nwidth*a.nheight/1e6*100)/100} MP, ${z.aspectRatio(a.nwidth,a.nheight)}`.replace(/\x20/g," ");a.bar.dataset.zoom===t&&a.nwidth||(he(a.bar,"zoom",t||null),C.show())}},z={aspectRatio(e,t){for(let o,n=e/t,r=0;;){if(r++,o=Math.round(e*r/t),o>10&&r>10||o>100||r>100)return n.toFixed(2);if(Math.abs(o/r-n)<.01)return`${o}:${r}`}},frameSize(e,t){if(!e)return;const o=e.getBoundingClientRect();return[Math.min(o.right,t.innerWidth)-Math.max(o.left,0),Math.min(o.bottom,t.innerHeight)-Math.max(o.top,0),o.left<0?-o.left:0,o.top<0?-o.top:0]},generateScales(e){let[t,o]=e<1?[e,1]:[1,e];const r=n.zoomStep/100,i=[t];if(1!==e){const e=o/t,n=Math.log(e)/Math.log(r)|0,a=n&&Math.pow(e,1/n);for(let e=n;--e>0;)i.push(t*=a);i.push(t=o)}for(;(t*=r)<=16;)i.push(t);return i},measurePopup(){let{popup:e,nwidth:t,nheight:o}=a;if(e.setAttribute("style","display:inline !important;"+M.popupStyleBase),e.clientWidth>t){const n=0|W(e.clientWidth,t,innerWidth/2);o=a.nheight=n/t*o|0,t=a.nwidth=n,e.style.cssText=`width: ${t}px !important; height: ${o}px !important;`}else e.style.cssText="";e.classList.add(`${g}show`);const r=getComputedStyle(e),i=2*oe(r.outlineOffset,r.outlineWidth),s=oe(r.paddingLeft,r.paddingRight,r.borderLeftWidth,r.borderRightWidth),l=oe(r.paddingTop,r.paddingBottom,r.borderTopWidth,r.borderBottomWidth),c=i+oe(r.marginLeft,r.marginRight),u=i+oe(r.marginTop,r.marginBottom);a.extras={inw:s,inh:l,outw:c,outh:u,o:i/2,w:s+c,h:l+u};const d=Math.min((a.view.w-a.extras.w)/a.nwidth,(a.view.h-a.extras.h)/a.nheight)||1,p=!n.fit&&n.scales.length;let m=Math.min(1,d),h="all"===n.fit&&d||"no"===n.fit&&1||m;if(p){const e=[];for(const t of n.scales){const o=parseFloat(t)||d;e.push(o),p&&"string"==typeof t&&(t.includes("!")&&(m=o),t.includes("*")&&(h=o))}a.scales=e.sort(D).filter(z.scaleBiggerThan,m)}else a.scales=z.generateScales(d);a.scale="auto"===n.zoom?h:Math.min(1,d),a.scaleFit=d,a.scaleZoom=h},rect(){const{node:e,rule:t}=a;let o=t.rect&&e.closest(t.rect);if(o)return o.getBoundingClientRect();const n=(o=e).firstElementChild?document.elementsFromPoint(a.cx,a.cy):[];let r,i=0,s=0;do{const e=o.getBoundingClientRect(),t=e.width*e.height;t>i&&(i=t,r=e)}while((o=n[s++])&&e.contains(o));return r},scaleBiggerThan(e,t,o){return e>=this&&(!t||Math.abs(e-o[t-1])>.01)},scaleIndex(e){const t=a.scales.indexOf(a.scale);if(t>=0)return t+e;for(let t=a.scales.length,o=e>0?0:t-1;o>=0&&o<t;o+=e)if(Math.sign(a.scales[o]-a.scale)===e)return o;return-1},scaleForFirstZoom(e){const t=a.scaleZoom;return e||t!==a.scale?t:a.scales.find(e=>e>t)},updateViewSize(){const e="BackCompat"===s.compatMode?s.body:s.documentElement;if(a.view={w:e.clientWidth,h:e.clientHeight,x:0,y:0},window===top)return;const[t,o]=z.frameSize(frameElement,parent)||[];t&&o?a.view={w:t,h:o,x:0,y:0}:(addEventListener("message",M.onMessageChild,!0),parent.postMessage(b.getViewSize,"*"))}};class O{constructor({data:e,save:t}){"string"==typeof e&&(e=re(e)),"object"==typeof e&&e||(e={});const{DEFAULTS:o}=O;if(e.fit=["all","large","no",""].includes(e.fit)?e.fit:(e.scales||0).length&&`${e.scales}`!=`${o.scales}`?"":"large",e.version!==o.version){"string"==typeof e.hosts&&(e.hosts=e.hosts.split("\n").map(e=>re(e)||e).filter(Boolean)),!0!==e.close&&!1!==e.close||(e.zoomOut=e.close?"auto":"stay");for(const t in o)typeof e[t]!=typeof o[t]&&(e[t]=o[t]);3===e.version&&0===e.scales[0]&&(e.scales[0]="0!");for(const t in e)t in o||delete e[t];e.version=o.version,t&&GM.setValue("cfg",e)}Object.keys(n||{}).some(t=>/^ui|^(css|globalStatus)$/.test(t)&&n[t]!==e[t])&&(M.globalStyle=""),m(e.scales)||(e.scales=[]),e.scales=[...new Set(e.scales)].sort((e,t)=>parseFloat(e)-parseFloat(t)),Object.assign(this,o,e)}static async load(e){return e.data=await GM.getValue("cfg"),new O(e)}_getCss(){const{css:e}=this;return e.includes("{")?e:`#${g}-popup {${e}}`}}O.DEFAULTS={__proto__:null,center:!1,css:"",delay:500,fit:"",globalStatus:!1,hosts:[{name:"No popup for YouTube thumbnails",d:"www.youtube.com",e:"ytd-rich-item-renderer *, ytd-thumbnail *",s:""},{name:"No popup for SVG/PNG icons",d:"",e:"img[src*='icon']",r:"//[^/]+/.*\\bicons?\\b.*\\.(?:png|svg)",s:""}],imgtab:!1,keepOnBlur:!1,keepVids:!1,mute:!1,night:!1,preload:!1,scale:1.05,scales:["0!",.125,.25,.5,.75,1,1.5,2,2.5,3,4,5,8,16],start:"auto",startAlt:"context",startAltShown:!1,uiBackgroundColor:"#ffffff",uiBackgroundOpacity:100,uiBorderColor:"#000000",uiBorderOpacity:100,uiBorder:0,uiFadein:!0,uiFadeinGallery:!0,uiInfo:!0,uiInfoCaption:!0,uiInfoHide:3,uiInfoOnce:!0,uiShadowColor:"#000000",uiShadowOpacity:80,uiShadow:20,uiShadowOnLoad:!0,uiPadding:0,uiMargin:0,version:6,videoCtrl:!0,waitLoad:!1,xhr:!0,zoom:"context",zoomOut:"auto",zoomStep:133};const L={csp:null,selfUrl:location.origin+"/",init(){this.busy=new Promise(e=>{const t=new XMLHttpRequest;t.open("get",location),t.timeout=Math.max(2e3,2*(performance.timing.responseEnd-performance.timeOrigin)),t.onreadystatechange=()=>{t.readyState>=t.HEADERS_RECEIVED&&(this.csp=this._parse([t.getResponseHeader("content-security-policy"),pe('meta[http-equiv="Content-Security-Policy"]',"content")].filter(Boolean).join(",")),this.init=this.busy=t.onreadystatechange=null,t.abort(),e())},t.send()})},async check(e,t){t&&this.init&&this.init(),this.busy&&await this.busy;const o=P.isVideoUrl(e);let n;if(this.csp){const t=this.csp[o?"media":"img"];t.some(this._srcMatches,e)||(n=[n,"blob","data"].find(e=>t.includes(`${e}:`)))}return[n||a.xhr,o]},_parse(e){if(!e)return;const t={},o=/(?:^|[;,])\s*(?:(default|img|media|script)-src|require-(trusted)-types-for) ([^;,]+)/g;for(let n;n=o.exec(e);)t[n[1]||n[2]]=n[3].trim().split(/\s+/);(t.script||[]).find(e=>/^'nonce-(.+)'$/.test(e))&&(i=RegExp.$1),(t.trusted||[]).includes("'script'")&&(M.NOP=()=>{}),t.img||(t.img=t.default||[]),t.media||(t.media=t.default||[]);for(const e of[t.img,t.media])e.forEach((t,o)=>{"*"!==t&&t.includes("*")&&(e[o]=new RegExp((/^\w+:/.test(t)?"^":"^\\w+://")+t.replace(/[.+?^$|()[\]{}]/g,"\\$&").replace(/(\\\.)?(\*)(\\\.)?/g,(e,t,o,n)=>`${t?"\\.?":""}[^:/]*${n?"\\.?":""}`).replace(/[^/]$/,"$&/")))});return t},_srcMatches(e){return e instanceof RegExp?e.test(this):"*"===e||e&&this.startsWith(e)&&(e.endsWith("/")||"/"===this[e.length])||"'self'"===e&&this.startsWith(L.selfUrl)}},T={ctrl:!1,hoverData:null,hoverTimer:0,ignoreKeyHeld:!1,onMouseOver(e){let t=e.target;T.ignoreKeyHeld=e.shiftKey,!M.isEnabled||e.shiftKey||a.zoomed||t===a.popup||t===s.body||t===s.documentElement||t===r||a.gallery&&a.rectHovered||!M.canClose()||(t.shadowRoot&&(t=T.pierceShadow(t,e.clientX,e.clientY)),T.hoverData={e:e,node:t,start:te()},T.hoverTimer=T.hoverTimer||setTimeout(T.onMouseOverThrottled,50),t.addEventListener("mouseout",T.onMouseOutThrottled))},onMouseOverThrottled(e){const{start:t,e:o,node:n,nodeOut:r}=T.hoverData||{};if(!n||n===r&&(T.hoverData=null,1))return;const i=e?0:t+50-te();if(T.hoverTimer=i>10&&setTimeout(T.onMouseOverThrottled,i))return;T.hoverData=null,N.rules||N.init();const s=q.adaptiveFind(n);s&&s.url&&s.node!==a.node&&M.activate(s,o)},onMouseOut(e){e.relatedTarget||n.keepOnBlur||e.shiftKey||!M.canClose()||M.deactivate()},onMouseOutThrottled(e){const t=T.hoverData;t&&(t.nodeOut=this),this.removeEventListener("mouseout",T.onMouseOutThrottled),T.hoverTimer=0},onMouseOutShadow(e){const t=e.target.shadowRoot;t&&(t.removeEventListener("mouseover",T.onMouseOver),t.removeEventListener("mouseout",T.onMouseOutShadow))},onMouseMove(e){if(T.trackMouse(e),!e.shiftKey)if(a.zoomed||a.rectHovered||!M.canClose()){if(a.zoomed){R.move();const{cx:e,cy:t,view:{w:o,h:n}}=a,r=o/6,i=n/6,s=e<r||e>o-r||t<i||t>n-i;B.set((s?"+":"-")+"edge")}}else M.deactivate()},onMouseDown({shiftKey:e,button:t,target:o}){t||o!==a.popup||!a.popup.controls||!e&&M.canClose()?2===t||e||(M.deactivate({wait:!0}),s.addEventListener("mouseup",M.enable,{once:!0})):a.controlled=a.zoomed=!0},onMouseScroll(e){const t=(e.deltaY||-e.wheelDelta)<0?1:-1;if(a.zoomed)T.zoomInOut(t);else if(a.gNum>1&&a.popup)A.next(-t);else if("wheel"===n.zoom&&t>0&&a.popup)M.toggleZoom();else if(M.canClose())return void M.deactivate();Z(e)},onKeyDown(e){const t=Y(e),o=a.popupShown;if(o||"^Control"!==t||(addEventListener("keyup",T.onKeyUp,!0),T.ctrl=!0),!o&&"^ContextMenu"===t)return T.onContext.call(this,e);if(o&&!e.repeat){switch(t){case"+Shift":if(a.shiftKeyTime)return;return a.shiftKeyTime=te(),B.set("+shift"),n.uiInfo&&C.show(1),void(ee(o)&&(o.controls=!0));case"KeyA":o.toggleAttribute(h);break;case"ArrowRight":case"KeyJ":A.next(1);break;case"ArrowLeft":case"KeyK":A.next(-1);break;case"KeyC":a.bar.firstChild?(C.setText(""),C.hide(0)):(C.setText(a.barText),C.show(2));break;case"KeyD":U.saveFile();break;case"KeyF":o!==document.fullscreenElement?o.requestFullscreen():document.exitFullscreen();break;case"KeyH":case"KeyV":case"KeyL":case"KeyR":if(!o)return;if("KeyH"===t||"KeyV"===t){const e=!!(a.rotate%180)^"KeyH"===t?"flipX":"flipY";a[e]=!a[e]}else a.rotate=((a.rotate||0)+90*("KeyL"===t?-1:1)+360)%360;C.updateDetails(),R.move();break;case"KeyI":(a.barShown?C.hide:C.show)(2);break;case"KeyM":ee(o)&&(o.muted=!o.muted);break;case"KeyN":a.night=o.classList.toggle(`${g}night`);break;case"KeyT":GM.openInTab(P.tabFixUrl()||o.src),M.deactivate();break;case"Minus":case"NumpadSubtract":a.zoomed?T.zoomInOut(-1):M.toggleZoom();break;case"Equal":case"NumpadAdd":a.zoomed?T.zoomInOut(1):M.toggleZoom();break;case"Escape":M.deactivate({wait:!0});break;case"!Alt":return;default:return void M.deactivate({wait:!0})}Z(e)}},onKeyUp(e){const t=a.popupShown||!1;"Control"===e.key&&(t||removeEventListener("keyup",T.onKeyUp,!0),setTimeout(()=>T.ctrl=!1)),t&&"Shift"===e.key&&a.shiftKeyTime?(B.set("-shift"),n.uiInfo&&C.hide(1),t.controls&&(t.controls=!1),a.controlled||!u&&te()-a.shiftKeyTime>500?a.controlled=!1:t&&(a.zoomed||!1!==a.rectHovered)?M.toggleZoom():M.deactivate({wait:!0}),a.shiftKeyTime=0):"Control"!==Y(e)||t||T.ignoreKeyHeld||"ctrl"!==n.start&&"context"!==n.start&&!a.rule.manual||(Z(e),T.hoverData&&(T.hoverData.e=e,T.onMouseOverThrottled(!0)),a.node&&(a.force=!0,M.start()))},onContext(e){if(T.ignoreKeyHeld)return;const t=a.popupShown;"context"===n.zoom&&t&&M.toggleZoom()?Z(e):t||n.videoCtrl&&ee(a.node)&&!T.ctrl||!("context"===n.start||"contextMK"===n.start||"contextM"===n.start&&2===e.button||"contextK"===n.start&&2!==e.button||"auto"===n.start&&a.rule.manual)?t&&setTimeout(M.deactivate,50,{wait:!0}):(a.node||T.hoverData||T.onMouseOver(e),T.onMouseOverThrottled(!0),a.node&&(a.force=!0,M.start(),Z(e)))},onVisibility(e){T.ctrl=!1},pierceShadow(e,t,o){for(let n;n=e.shadowRoot;){n.addEventListener("mouseover",T.onMouseOver,{passive:!0}),n.addEventListener("mouseout",T.onMouseOutShadow);const r=n.elementFromPoint(t,o);if(!r||r===e)break;e=r}return e},toggle(e){const t=e?"addEventListener":"removeEventListener",o={passive:!0,capture:!0};window[t]("mousemove",T.onMouseMove,o),window[t]("mouseout",T.onMouseOut,o),window[t]("mousedown",T.onMouseDown,o),window[t]("keyup",T.onKeyUp,!0),window[t](w,T.onMouseScroll,{passive:!1,capture:!0}),a.node.removeEventListener("mouseout",T.onMouseOutThrottled)},trackMouse(e){const t=a.cx=e.clientX,o=a.cy=e.clientY,n=a.rect||(a.rect=z.rect());a.rectHovered=!!n&&t>n.left-2&&t<n.right+2&&o>n.top-2&&o<n.bottom+2},zoomInOut(e){const t=z.scaleIndex(e),o=a.scales.length;t>=0&&t<o&&(a.scale=a.scales[t]);const r=n.zoomOut;if(t<=0&&"stay"!==r){if(a.scaleFit<.99*a.scale)a.scales.unshift(a.scale=a.scaleFit);else if((t<=0&&"close"===r||t<0&&!a.rectHovered)&&a.gNum<2)return void M.deactivate({wait:!0});a.zoomed="unzoom"!==r}else a.popup.classList.toggle(`${g}zoom-max`,a.scale>=4&&t>=o-1);a.zooming&&a.popup.classList.add(`${g}zooming`),R.move(),C.updateDetails()}},A={makeParser:e=>Q(e)?e:A.defaultParser,findIndex:e=>Math.max(0,a.gItems.findIndex(({url:t})=>m(t)?t.includes(e):t===e)),next(e){e&&(a.gIndex=A.nextIndex(e));const t=a.gItem=a.gItems[a.gIndex];m(t.url)?(a.urls=t.url.slice(1),a.url=t.url[0]):(a.urls=null,a.url=t.url),a.gItemNext=a.gItems[A.nextIndex(e||1)],M.startSingle(),C.updateName(),e&&C.show(0)},nextIndex:e=>(a.gIndex+e+a.gNum)%a.gNum,defaultParser(e,t,o,n,r){function i(e){const t=e?ae(e,this)||s(e,this.previousElementSibling)||s(e,this.nextElementSibling):this;return t&&g(N.runCHandler.default(t)||t.textContent)}function s(e,t){if(t&&!t.matches(u))return t.matches(e)?t:ae(e,t)}const{g:l}=r,c=l.index,u=l.entry,d=J(l.caption),p=l.image||"img",m=l.title,g=("string"==typeof l.fix?P.newFunction("s","isURL",l.fix):l.fix)||(e=>e.trim()),h=[...se(u||p,t)],f=h.map(function(e){const t={};try{const n=u?ae(p,e):e;t.url=g(U.findImageUrl(n,o),!0),t.desc=d.map(i,e).filter(Boolean).join(" - ")}catch(e){}return t.url&&t}).filter(Boolean);return f.title=function(){const e=ae(m,t);return e&&g(e.getAttribute("content")||e.textContent)||""}(),f.index=y.test(c)?P.newFunction("items","node",c)(f,a.node):"string"==typeof c?U.findImageUrl(ne(ae,c,t),o):null==c?Math.max(0,h.indexOf(a.node)):c,f}},I=window===top&&GM.registerMenuCommand&&{curAltName:"",unreg:GM.unregisterMenuCommand,makeAltName:()=>I.unreg?"MPIV: auto-start is "+("auto"===n.start?"ON":"OFF"):"MPIV: toggle auto-start",register(){GM.registerMenuCommand("MPIV: configure",e),I.registerAlt()},registerAlt(){n.startAltShown&&(I.curAltName=I.makeAltName(),GM.registerMenuCommand(I.curAltName,I.onAltToggled))},reRegisterAlt(){const e=I.curAltName;e&&I.unreg&&I.unreg(e),e&&!I.unreg||I.registerAlt()},onAltToggled(){"auto"===n.start?n.start=n.startAlt||(n.startAlt="context"):(n.startAlt=n.start,n.start="auto"),I.reRegisterAlt()}},R={async create(e,t,o){let r,i=a.popup;const l=i&&!n.uiFadeinGallery&&a.gItems&&!a.zooming;if(l&&i===document.fullscreenElement?R.destroyBlob():i&&(R.destroy(),i=null),a.imageUrl=e,!e)return;const c=a;let u,[d,p]=await L.check(e,o);if(a!==c)return;if(!d&&o)return void M.handleError(o);if(Object.assign(a,{pageUrl:t,xhr:d}),d&&([e,p]=await U.getImage(e,t,d).catch(M.handleError)||[]),a!==c||!e||p&&(u=await GM.getValue("volume"),a!==c))return;i?(i.src=r="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",i.classList.remove(g+"show"),i.removeAttribute("style"),a.popupShown=null,a.popupLoaded=!1):i=a.popup=p?j.create(u):le("img"),i.id=`${g}popup`,i.src=e,i.addEventListener("error",M.handleError),(a.night=null!=a.night?a.night:n.night)&&i.classList.add(`${g}night`),a.zooming&&i.addEventListener("transitionend",R.onZoom),he(i,"galleryFlip",l?"":null),i.toggleAttribute("loaded",!!l);const m=a.popover||"function"==typeof i.showPopover&&ae("[popover]:popover-open");a.popover=m&&m.getBoundingClientRect().width&&(ce(m,{opacity:0}),m)||null,i.parentElement!==s.body&&s.body.insertBefore(i,a.bar&&a.bar.parentElement===s.body&&a.bar||null),await 0,a.popup===i&&!1!==M.checkProgress({start:!0})&&(!r&&i.complete?R.onLoad.call(i):p||i.addEventListener("load",R.onLoad,{once:!0}))},destroy(){const e=a.popup;e&&(e.removeEventListener("load",R.onLoad),e.removeEventListener("error",M.handleError),a.popover&&(a.popover.style.removeProperty("opacity"),a.popover=null),Q(e.pause)&&e.pause(),e.remove(),R.destroyBlob(),a.zoomed=a.popup=a.popupLoaded=null)},destroyBlob(){a.blobUrl&&(setTimeout(URL.revokeObjectURL,50,a.blobUrl),a.blobUrl=null)},move(){let e,t;const{cx:o,cy:r,extras:i,view:s}=a,l=s.w-i.outw,c=s.h-i.outh,u=a.scale*a.nwidth+i.inw,d=a.scale*a.nheight+i.inh,p=a.rotate%180,m=p?d:u,g=p?u:d;if(!a.zoomed&&a.gNum<2&&!n.center){const o=a.rect,n=(o.left+o.right)/2,r=(o.top+o.bottom)/2;l-o.right-40>m||m<o.left-40?(g<c-60&&(t=W(r-g/2,30,c-g-30)),e=n>l/2?o.left-40-m:o.right+40):(c-o.bottom-40>g||g<o.top-40)&&(m<l-60&&(e=W(n-m/2,30,l-m-30)),t=r>c/2?o.top-40-g:o.bottom+40)}null==e&&(e=l>m?(l-m)/2+s.x:(l-m)*W(5/3*((o-s.x)/l-.2),0,1)),null==t&&(t=c>g?(c-g)/2+s.y:(c-g)*W(5/3*((r-s.y)/c-.2),0,1));const h=p?(u-d)/2:0;e+=i.o-h,t+=i.o+h,ce(a.popup,{transform:`translate(${Math.round(e)}px, ${Math.round(t)}px) rotate(${a.rotate||0}deg) scale(${a.flipX?-1:1},${a.flipY?-1:1})`,width:`${Math.round(u)}px`,height:`${Math.round(d)}px`})},onLoad(){if(this===a.popup){this.setAttribute("loaded",""),a.popupLoaded=!0,B.set("-loading");let e=a.gItem;e&&(e.url=this.src),(e=a.gItemNext)&&R.preload(this,e)}},onZoom(){this.classList.remove(`${g}zooming`)},async preload(e,t,o=t.url,n=le("img")){if(a.gItemNext=null,m(o))for(const r=o;e===a.popup&&t.url===r&&(o=r[0]);){const{type:e}=await new Promise(e=>{n.src=o,n.onload=n.onerror=e});if(r[0]===o&&r.shift(),"load"===e){t.url=o;break}}else n.src=o}},j={create:e=>(a.bufBar=!1,a.bufStart=te(),le("video",{autoplay:-1!==a.preloadStart,controls:!0,muted:n.mute||"suspended"===(new d).state,loop:!0,volume:W(+e||.5,0,1),onprogress:j.progress,oncanplaythrough:j.progressDone,onvolumechange:j.rememberVolume})),progress(){const{duration:e}=this;if(e&&this.buffered.length&&te()-a.bufStart>2e3){const t=Math.round(this.buffered.end(0)/e*100);a.bar&&(a.bufBar|=t>0&&t<50)&&C.set(`${t}% of ${Math.round(e)}s`,"xhr")}},progressDone(){this.onprogress=this.oncanplaythrough=null,a.bar&&a.bar.classList.contains(`${g}xhr`)&&C.set(!1),R.onLoad.call(this)},rememberVolume(){GM.setValue("volume",this.volume)}},N={init(){const e=new Map,t=n.hosts||[],o=t.filter((e,t,o)=>!t||!P.deepEqual(e,o[t-1]));o.length<t.length&&GM.setValue("cfg",n);const r=N.rules=o.map(N.parse,e).filter(Boolean),d="function"==typeof GM_addElement,p=i||(i=(ae("script[nonce]")||{}).nonce||"")||d,m=p&&`${GM_info.script.name}${Math.random()}`,g=[],h=[`window[${JSON.stringify(m)}]=[`];for(const[t,o]of e.entries())v.test(o)?(p&&h.push(g.length?",":"","[",r.indexOf(t),",{",...Object.keys(S).map(e=>y.test(t[e])&&`${e}(${S[e]}){${t[e]}},`).filter(Boolean),"}]"),g.push(t)):M.handleError("Invalid custom host rule:",t);if(g.length){let e,t;if(p){const o=d?GM_addElement:(e,{textContent:t})=>document.head.appendChild(Object.assign(document.createElement(e),{textContent:E?E(t):t,nonce:i}));h.push("]; document.currentScript.remove();"),o("script",{textContent:h.join("")}),e=(t=unsafeWindow)[m]||u&&(t=t.wrappedJSObject)[m]}if(e){for(const[t,o]of e)Object.assign(r[t],o);delete t[m]}else console.warn("Site forbids compiling JS code in these custom rules",g)}switch(c.match(/[^.]+(?=\.com?(?:\.[^.]+)?$)|[^.]+\.[^.]+$|$/)[0]){case"4chan.org":r.push({e:'.is_catalog .thread a[href*="/thread/"], .catalog-thread a[href*="/thread/"]',q:".op .fileText a",css:"#post-preview{display:none}"});break;case"amazon":r.push({r:/.+?images\/I\/.+?\./,s:e=>s.getElementById("universal-hover")?"":e[0]+"jpg",css:"#zoomWindow{display:none!important;}"});break;case"bing":r.push({e:'a[m*="murl"]',r:/murl&quot;:&quot;(.+?)&quot;/,s:"$1",html:!0});break;case"deviantart":r.push({e:'a[href*="/art/"] img[src*="/v1/"]',r:/^(.+)\/v1\/\w+\/[^/]+\/(.+)-\d+.(\.\w+)(\?.+)/,s:([,e,t,o,n],r)=>{let i=P.getReactChildren(r.closest("a"),"props.deviation.media.types");return i&&(i=i.find(e=>"fullview"===e.t))&&`${e}${i.c?i.c.replace("<prettyName>",t):`/v1/fill/w_${i.w},h_${i.h}/${t}-fullview${o}`}${n}`}},{e:".dev-view-deviation img",s:()=>[ae(".dev-page-download").href,ae(".dev-content-full").src].filter(Boolean)},{e:"a[data-hook=deviation_link]",q:"link[as=image]"});break;case"discord":r.push({u:"||discordapp.net/external/",r:/\/https?\/(.+)/,s:"//$1",follow:!0});break;case"dropbox":r.push({r:/(.+?&size_mode)=\d+(.*)/,s:"$1=5$2"});break;case"facebook":r.push({e:'a[href^="/photo/?"], a[href^="https://www.facebook.com/photo"]',s:(e,t)=>(e=P.getReactChildren(t.parentNode))&&ie(e,(e[0]?"0.props.linkProps":"props")+".passthroughProps.origSrc")});break;case"flickr":ie(unsafeWindow,"YUI_config.flickr.api.site_key")&&r.push({r:/flickr\.com\/photos\/[^/]+\/(\d+)/,s:e=>`https://www.flickr.com/services/rest/?${new URLSearchParams({photo_id:e[1],api_key:unsafeWindow.YUI_config.flickr.api.site_key,method:"flickr.photos.getSizes",format:"json",nojsoncallback:1}).toString()}`,q:e=>JSON.parse(e).sizes.size.pop().source,anonymous:!0});break;case"github":r.push({r:new RegExp([/(avatars.+?&s=)\d+/,/(raw\.github)(\.com\/.+?\/img\/.+)$/,/\/(github)(\.com\/.+?\/)blob\/([^/]+\/.+?\.(?:avif|webp|png|jpe?g|bmp|gif|cur|ico|svg))$/].map(e=>e.source).join("|")),s:e=>"https://"+(e[1]?`${e[1]}460`:e[2]?`${e[2]}usercontent${e[3]}`:ae(".AppHeader-context-item > .octicon-lock")?`${e[4]}${e[5]}raw/${e[6]}`:`raw.${e[4]}usercontent${e[5]}${e[6]}`)});break;case"google":/[&?]tbm=isch(&|$)/.test(location.search)&&r.push({e:'a[href*="imgres?imgurl="] img',s:(e,t)=>new URLSearchParams(t.closest("a").search).get("imgurl"),follow:!0},{e:"[data-tbnid] a:not([href])",s:(e,t)=>{const o=ae('a[jsaction*="mousedown"]',t.closest("[data-tbnid]"))||t;new MutationObserver((e,n)=>{n.disconnect(),M.isEnabled=!0,t.alt=o.innerText;const{left:r,top:i}=t.getBoundingClientRect();T.onMouseOver({target:ae("img",t),clientX:r,clientY:i})}).observe(t,{attributes:!0,attributeFilter:["href"]}),o.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0})),o.dispatchEvent(new MouseEvent("mouseup",{bubbles:!0}))}});break;case"instagram":r.push({e:'a[href*="/p/"],article [role="button"][tabindex="0"],article [role="button"][tabindex="0"] div',s:(e,t,o)=>{let n,r,i,a,s;(location.pathname.startsWith("/p/")||location.pathname.startsWith("/tv/"))&&(a=ae("img[srcset], video",t.parentNode),a&&(ee(a)||parseFloat(a.sizes)>900)&&(s=(a.srcset||a.currentSrc).split(",").pop().split(" ")[0])),!s&&(i=t.closest('a[href*="/p/"], article'))&&(r="A"===i.tagName?i:ae('a[href*="/p/"]',i));const l=r&&ie(n,"edge_sidecar_to_children.edges.length")||r&&ie(n,"carousel_media_count");return N.toggle(o,"q",n),N.toggle(o,"g",r&&(l>1||/<\w+[^>]+carousel/i.test(r.innerHTML))),o.follow=!o.g,o._data=n,o._img=a,!(!r&&!s)&&`${s||r.href}${o.g?"?__a=1&__d=dis":""}`},c:(e,t,o,n)=>n._getCaption(n._data)||(n._img||0).alt||"",follow:!0,_q:'meta[property="og:video"]',_g(e,t,o,n,r){const i=re(e),a=ie(i,"graphql.shortcode_media")||ie(i,"items.0"),s=ie(a,"edge_sidecar_to_children.edges",e=>e.map(e=>({url:e.node.video_url||e.node.display_url})))||ie(a,"carousel_media",e=>e.map(e=>({url:ie(e,"video_versions.0.url")||ie(e,"image_versions2.candidates.0.url")})));return s.title=r._getCaption(a)||"",s},_getCaption:e=>ie(e,"caption.text")||ie(e,"edge_media_to_caption.edges.0.node.text")});break;case"reddit":r.push({u:"||i.reddituploads.com/"},{e:'[data-url*="i.redd.it"] img[src*="thumb"]',s:(e,t)=>me(t,"data-url")},{r:/preview(\.redd\.it\/\w+\.(jpe?g|png|gif))/,s:"https://i$1"});break;case"stackoverflow":r.push({e:".post-tag, .post-tag img",s:""});break;case"startpage":r.push({r:/[&?]piurl=([^&]+)/,s:"$1",follow:!0});break;case"tumblr":r.push({e:"div.photo_stage_img, div.photo_stage > canvas",s:(e,t)=>/http[^"]+/.exec(t.style.cssText+t.getAttribute("data-img-src"))[0],follow:!0});break;case"twitter":r.push({e:".grid-tweet > .media-overlay",s:(e,t)=>t.previousElementSibling.src,follow:!0})}r.push({r:/[/?=](https?%3A%2F%2F[^&]+)/i,s:"$1",follow:!0,onerror:"skip"},{u:["||500px.com/photo/","||cl.ly/","||cweb-pix.com/","//ibb.co/","||imgcredit.xyz/image/"],r:/\.\w+\/.+/,q:'meta[property="og:image"]'},{u:"attachment.php",r:/attachment\.php.+attachmentid/},{u:"||abload.de/image",q:"#image"},{u:"||deviantart.com/art/",s:(e,t)=>/\b(film|lit)/.test(t.className)||/in Flash/.test(t.title)?"":e.input,q:['#download-button[href*=".jpg"]','#download-button[href*=".jpeg"]','#download-button[href*=".gif"]','#download-button[href*=".png"]',"#gmi-ResViewSizer_fullimg","img.dev-content-full"]},{u:"||dropbox.com/s",r:/com\/sh?\/.+\.(jpe?g|gif|png)/i,q:(e,t)=>pe("img.absolute-center","src",t).replace(/(size_mode)=\d+/,"$1=5")||!1},{r:/[./]ebay\.[^/]+\/itm\//,q:e=>e.match(/https?:\/\/i\.ebayimg\.com\/[^.]+\.JPG/i)[0].replace(/~~60_\d+/,"~~60_57")},{u:"||i.ebayimg.com/",s:(e,t)=>ae(".zoom_trigger_mask",t.parentNode)?"":e.input.replace(/~~60_\d+/,"~~60_57")},{u:"||fastpic.",s:(e,t,o)=>{const n=t.closest("a"),r=decodeURIComponent(U.findImageUrl(n||t)).replace(/\/i(\d+)\.(\w+\.\w+\/)\w+/,"/$2$1").replace(/^\w+:\/\/fastpic[^/]+((?:\/\d+){3})\/\w+(\/\w+\.\w+).*/,"https://fastpic.org/view$1$2.html");return N.toggle(o,"q",r.includes(".html")),n||r.includes(".png")?r:[r,r.replace(/\.jpe?g/,".png")]},_q:'img[src*="/big/"]'},{u:"||flickr.com/photos/",r:/photos\/([0-9]+@N[0-9]+|[a-z0-9_-]+)\/([0-9]+)/,s:e=>e.input.indexOf("/sizes/")<0&&`https://www.flickr.com/photos/${e[1]}/${e[2]}/sizes/sq/`,q:(e,t)=>{const o=se(".sizes-list a",t);return"https://www.flickr.com"+o[o.length-1].getAttribute("href")},follow:!0},{u:"||flickr.com/photos/",r:/\/sizes\//,q:"#allsizes-photo > img"},{u:"||gfycat.com/",r:/(gfycat\.com\/)(gifs\/detail\/|iframe\/)?([a-z]+)/i,s:"https://$1$3",q:'meta[content$=".webm"], #webmsource, source[src$=".webm"], .actual-gif-image'},{u:["||googleusercontent.com/proxy","||googleusercontent.com/gadgets/proxy"],r:/\.com\/(proxy|gadgets\/proxy.+?(http.+?)&)/,s:e=>e[2]?decodeURIComponent(e[2]):e.input.replace(/w\d+-h\d+($|-p)/,"w0-h0")},{u:["||googleusercontent.com/","||ggpht.com/"],s:e=>e.input.includes("webcache.")?"":e.input.replace(/\/s\d{2,}-[^/]+|\/w\d+-h\d+/,"/s0").replace(/([&?]sz)?=[-\w]+([&#].*)?/,"")},{u:"||gravatar.com/",r:/([a-z0-9]{32})/,s:"https://gravatar.com/avatar/$1?s=200"},{u:"//gyazo.com/",r:/\bgyazo\.com\/\w{32,}(\.\w+)?/,s:(e,t,o)=>N.toggle(o,"q",!e[1])?e.input:`https://i.${e[0]}`,_q:'link[rel="image_src"]'},{u:"||hostingkartinok.com/show-image.php",q:".image img"},{u:["||imagecurl.com/images/","||imagecurl.com/viewer.php"],r:/(?:images\/(\d+)_thumb|file=(\d+))(\.\w+)/,s:"https://imagecurl.com/images/$1$2$3"},{u:"||imagebam.com/",r:/^(https:\/\/)thumbs\d+(\.imagebam\.com\/).*?([^/]+)_t\./,s:"$1www$2view/$3",q:"img.main-image"},{u:"||www.imagebam.com/view/",q:"img.main-image"},{u:"||imageban.ru/thumbs",r:/(.+?\/)thumbs(\/\d+)\.(\d+)\.(\d+\/.*)/,s:"$1out$2/$3/$4"},{u:["||imageban.ru/show","||imageban.net/show","||ibn.im/"],q:"#img_main"},{u:"||imageshack.us/img",r:/img(\d+)\.(imageshack\.us)\/img\\1\/\d+\/(.+?)\.th(.+)$/,s:"https://$2/download/$1/$3$4"},{u:"||imageshack.us/i/",q:"#share-dl"},{u:"||imageteam.org/img",q:'img[alt="image"]'},{u:["||imagetwist.com/","||imageshimage.com/"],r:/(\/\/|^)[^/]+\/[a-z0-9]{8,}/,q:"img.pic",xhr:!0},{u:"||imageupper.com/i/",q:"#img",xhr:!0},{u:"||imagevenue.com/",q:'a[data-toggle="full"] img'},{u:"||imagezilla.net/show/",q:"#photo",xhr:!0},{u:["||images-na.ssl-images-amazon.com/images/","||media-imdb.com/images/"],r:/images\/.+?\.jpg/,s:"/V1\\.?_.+?\\.//g"},{u:"||imgbox.com/",r:/\.com\/([a-z0-9]+)$/i,q:"#img",xhr:"imgbox.com"!==l},{u:"||imgclick.net/",r:/\.net\/(\w+)/,q:"img.pic",xhr:!0,post:e=>`op=view&id=${e[1]}&pre=1&submit=Continue%20to%20image...`},{u:".imgcredit.xyz/",r:/^https?(:.*\.xyz\/\d[\w/]+)\.md(.+)/,s:["https$1$2","https$1.png"]},{u:["||imgflip.com/i/","||imgflip.com/gif/"],r:/\/(i|gif)\/([^/?#]+)/,s:e=>`https://i.imgflip.com/${e[2]}${"i"===e[1]?".jpg":".mp4"}`},{u:["||imgur.com/a/","||imgur.com/gallery/"],s:"gallery",async g(){let e=`https://imgur.com/ajaxalbums/getimages/${a.url.split(/[/?#]/)[4]}/hit.json?all=true`,t=re((await U.gmXhr(e)).responseText)||0,o=(t.data||0).images||[];o[0]||(t=(await U.gmXhr(a.url)).responseText.match(/postDataJSON=(".*?")<|$/)[1],t=re(re(t))||0,o=t.media);const n=[];for(const t of o){const o=t.metadata||t;n.push({url:t.url||(e=`https://i.imgur.com/${t.hash}`)&&(".gif"===t.ext&&!1!==t.animated?[`${e}.webm`,`${e}.mp4`,e]:e+t.ext),desc:[o.title,o.description].filter(Boolean).join(" - ")})}return n[0]&&t.title&&!`${n[0].desc||""}`.includes(t.title)&&(n.title=t.title),n}},{u:"||imgur.com/",r:/((?:[a-z]{2,}\.)?imgur\.com\/)((?:\w+,)+\w*)/,s:"gallery",g:(e,t,o,n)=>n[2].split(",").map(e=>({url:`https://i.${n[1]}${e}.jpg`}))},{u:"||imgur.com/",r:/([a-z]{2,}\.)?imgur\.com\/(r\/[a-z]+\/|[a-z0-9]+#)?([a-z0-9]{5,})($|\?|\.(mp4|[a-z]+))/i,s:(e,t)=>{if(/memegen|random|register|search|signin/.test(e.input))return"";const o=t.closest("a");if(o&&o!==t&&/(i\.([a-z]+\.)?)?imgur\.com\/(a\/|gallery\/)?/.test(o.href))return!1;const n=e[3].replace(/(.{7})[hlmtbs]$/,"$1"),r=e[5]?e[5].replace(/gifv?/,"webm"):"jpg",i=`https://i.${(e[1]||"").replace("www.","")}imgur.com/${n}.`;return"webm"===r?[`${i}webm`,`${i}mp4`,`${i}gif`]:i+r}},{u:["||instagr.am/p/","||instagram.com/p/","||instagram.com/tv/"],s:e=>e.input.substr(0,e.input.lastIndexOf("/")).replace("/liked_by","")+"/?__a=1&__d=dis",q:e=>(e=re(e))&&(e=ie(e,"graphql.shortcode_media")||ie(e,"items.0")||0)&&(e.video_url||e.display_url||ie(e,"video_versions.0.url")||ie(e,"carousel_media.0.image_versions2.candidates.0.url")||ie(e,"image_versions2.candidates.0.url")),rect:"div.PhotoGridMediaItem",c:e=>(e=re(e))&&(ie(e,"items.0.caption.text")||ie(e,"graphql.shortcode_media.edge_media_to_caption.edges.0.node.text")||"")},{u:["||livememe.com/","||lvme.me/"],r:/\.\w+\/([^.]+)$/,s:"http://i.lvme.me/$1.jpg"},{u:"||lostpic.net/image",q:".image-viewer-image img"},{u:"||makeameme.org/meme/",r:/\/meme\/([^/?#]+)/,s:"https://media.makeameme.org/created/$1.jpg"},{u:"||photobucket.com/",r:/(\d+\.photobucket\.com\/.+\/)(\?[a-z=&]+=)?(.+\.(jpe?g|png|gif))/,s:"https://i$1$3",xhr:!c.endsWith(".photobucket.com")},{u:"||piccy.info/view3/",r:/(.+?\/view3)\/(.*)\//,s:"$1/$2/orig/",q:"#mainim"},{u:"||pimpandhost.com/image/",r:/(.+?\/image\/[0-9]+)/,s:"$1?size=original",q:"img.original"},{u:["||pixroute.com/","||imgspice.com/"],r:/\.html$/,q:"img[id]",xhr:!0},{u:"||postima",r:/postima?ge?\.org\/image\/\w+/,q:['a[href*="dl="]',"#main-image"]},{u:["||prntscr.com/","||prnt.sc/"],r:/\.\w+\/.+/,q:'meta[property="og:image"]',xhr:!0},{u:"||radikal.ru/",r:/\.ru\/(fp|.+?\.html)|^(.+?)t\.jpg/,s:(e,t,o)=>e[2]&&/radikal\.ru[\w%/]+?(\.\w+)/.test(me(t,"href"))?e[2]+RegExp.$1:N.toggle(o,"q",e[1])?e.input:[e[2]+".jpg",e[2]+".png"],_q:e=>e.match(/https?:\/\/\w+\.radikal\.ru[\w/]+\.(jpg|gif|png)/i)[0]},{u:"||tumblr.com",r:/_500\.jpg/,s:["/_500/_1280/",""]},{u:"||twimg.com/media/",r:/.+?format=(jpe?g|png|gif)/i,s:"$0&name=orig"},{u:"||twimg.com/media/",r:/.+?\.(jpe?g|png|gif)/i,s:"$0:orig"},{u:"||twimg.com/1/proxy",r:/t=([^&_]+)/i,s:e=>atob(e[1]).match(/http.+/)},{u:"||twimg.com/",r:/\/profile_images/i,s:"/_(reasonably_small|normal|bigger|\\d+x\\d+)\\././g"},{u:"||pic.twitter.com/",r:/\.com\/[a-z0-9]+/i,q:e=>e.match(/https?:\/\/twitter\.com\/[^/]+\/status\/\d+\/photo\/\d+/i)[0],follow:!0},{u:"||twitpic.com/",r:/\.com(\/show\/[a-z]+)?\/([a-z0-9]+)($|#)/i,s:"https://twitpic.com/show/large/$2"},{u:"||wiki",r:/\/(?:thumb|images)\/.+\.(?:jpe?g|gif|png|svg)/i,s:e=>e.input.replace(/\/(thumb(?=\/)|\d+px[^/]+(?=$|\?))/g,"").replace(/\/(scale-to-width(-[a-z]+)?\/\d+|(zoom-crop|smart)(\/(width|height)\/\d+)+)/g,"/"),xhr:!l.includes("wiki")},{u:"||ytimg.com/vi/",r:/(.+?\/vi\/[^/]+)/,s:"$1/0.jpg",rect:".video-list-item"},{u:"/viewer.php?file=",r:/(.+?)\/viewer\.php\?file=(.+)/,s:"$1/images/$2",xhr:!0},{u:"/thumb_",r:/\/albums.+\/thumb_[^/]/,s:"/thumb_//"},{u:[".th.jp",".th.gif",".th.png"],r:/(.+?\.)th\.(jpe?g?|gif|png|svg|webm)$/i,s:"$1$2",follow:!0},{r:k})},format(e,{expand:t}={}){const o=P.stringify(e,null," ");return t?o.replace(/^{\s+/g,"{"):o.replace(/\n\s*/g," ").replace(/^({)\s|\s+(})$/g,"$1$2")},fromElement(e){const t=e.textContent.trim();if(t.startsWith("{")&&t.endsWith("}")&&/[{,]\s*"[degqrsu]"\s*:\s*"/.test(t)){const e=re(t);return e&&Object.keys(e).some(e=>/^[degqrsu]$/.test(e))&&e}},isValidE2:([e,t])=>e.trim()&&"string"==typeof t&&t.trim(),parse(e){const t=this instanceof Map;try{if("string"==typeof e&&(e=JSON.parse(e)),"d"in e&&"string"!=typeof e.d)e.d=void 0;else if(t&&e.d&&!l.includes(e.d))return!1;let{e:o}=e;if(null!=o){if(o="string"==typeof o?o.trim():m(o)?o.join(",").trim():Object.entries(o).every(N.isValidE2)&&o,!o)throw new Error('Invalid syntax for "e". Examples: "e": ".image" or "e": [".image1", ".image2"] or "e": {".parent": ".image"} or "e": {".parent1": ".image1", ".parent2": ".image2"}');t&&(e.e=o||void 0)}let n=t?e:{};e.r&&(n.r=new RegExp(e.r,"i")),M.NOP&&(n={});for(const o of Object.keys(S))if(y.test(e[o])){const r=P.newFunction(...S[o],e[o]);r===M.NOP&&t?t&&this.set(e,"unsafe-eval"):n[o]=r}return e}catch(o){return t?(this.set(e,o),e):o}},runC(e,t=document){const o=N.runCHandler[typeof a.rule.c]||N.runCHandler.default;a.caption=o(e,t)},runCHandler:{function:(e,t)=>a.rule.c(e||t.documentElement.outerHTML,t,a.node,a.rule),string:(e,t)=>{const o=de(a.rule.c,t);return o?o.getAttribute("content")||o.getAttribute("title")||o.textContent:""},default:(e,t,o=a.node)=>(a.tooltip||0).text||o.alt||me(o,"title")||U.getFileName(o.tagName===(a.popup||0).tagName?a.url:o.src||me(o,"href"))},runQ(e,t,o){let n;if(Q(a.rule.q))n=a.rule.q(e,t,a.node,a.rule),m(n)&&(a.urls=n.slice(1),n=n[0]);else{const e=de(a.rule.q,t);n=U.findImageUrl(e,o)}return n},runE(e,t,o){let n,r,i,a;for(const s in t)if((n=o.closest(s))&&(r=ae(t[s],n)))if(r===o)i=!0;else if(a=q.adaptiveFind(r,{rules:[e]}))return a;return i},runS(e,t,o){let n,r=[];for(const n of J(t.s))r.push("string"==typeof n?P.decodeUrl(N.substituteSingle(n,o)):Q(n)?n(o,e,t):n);if(!(t.q&&r.length>1))return m(n=r[0])&&(n=r=n),""===n?r:n&&p(new Set(r),P.decodeUrl);console.warn('Rule discarded: "s" array is not allowed with "q"\n%o',t)},runU(e,t){const o=e[$]||(e[$]=F(e.u));return o.fn.call(o.data,t)},substituteSingle(e,t){if(!t||null==t.input)return e;if(e.startsWith("/")&&!e.startsWith("//")){const o=e.search(/[^\\]\//)+1,n=e.lastIndexOf("/"),r=new RegExp(e.slice(1,o),e.slice(n+1));return t.input.replace(r,e.slice(o+1,n))}if(t.length&&e.includes("$")){const o=Math.floor(Math.log10(t.length))+1;e=e.replace(/\$(\d{1,3})/g,(e,n)=>{for(let e=o;e>=0;e--){const o=0|n.slice(0,e);if(o<t.length)return(t[o]||"")+n.slice(e)}return e})}return e},toggle:(e,t,o)=>(e[t]=o?e[`_${t}`]:null,o)},q={adaptiveFind(e,t){const o=e.tagName,n=e.currentSrc||e.src||"",r="IMG"===o||"VIDEO"===o&&P.isVideoUrlExt(n);let i,a,s;if("A"!==o&&(s=r&&!n.startsWith("data:")&&P.rel2abs(n),a=q.find(s,e,t)),!a&&(i=e.closest("A"))){const e=i.dataset;s=e.expandedUrl||e.fullUrl||e.url||i.href||"",s=s.includes("//t.co/")?"https://"+i.textContent:s,s=!s.startsWith("data:")&&s,a=q.find(s,i,t)}return!a&&r&&(a={node:e,rule:{},url:n}),a},find(e,t,{noHtml:o,rules:n,skipRules:r}={}){let i,s,l,c;for(const u of n||N.rules){let d,p;if(r&&r.includes(u)||u.u&&(!e||!N.runU(u,e))||!n&&(d=u.e)&&!(p="string"==typeof d?t.matches(d):N.runE(u,d,t)))continue;if(p&&p.url)return p;const{r:m,s:g}=u;let h=null!=g;if(c=!(o&&u===a.rule)&&(m||h)&&u.html&&(l||(l=t.outerHTML)),m?p=c?m.exec(c):e&&m.exec(e):(p=[""],p[0]=p.input=c||e||u.g&&location.href||"",p.index=0),!p)continue;if(""===g)return{};if(!h&&!r&&(i?s:s="IMG"===(i=t.tagName)||"VIDEO"===i))continue;h&="gallery"!==g;const f=h?N.runS(t,u,p):[p.input];if(f)return q.makeInfo(h,u,p,t,r,f)}},makeInfo(e,t,o,r,i,a){let s,l=`${a[0]}`;const c=l&&e&&!t.q&&q.isFollowableUrl(l,t);if(l?l=P.rel2abs(l):s={},c&&(s=q.find(l,r,{skipRules:[...i||[],t]})),!s&&(!c||k.test(l))){const e=n.xhr&&t.xhr;s={match:o,node:r,rule:t,url:l,urls:a.length>1?a.slice(1):null,gallery:t.g&&A.makeParser(t.g),post:Q(t.post)?t.post(o):t.post,xhr:null!=e?e:isSecureContext&&!l.startsWith(location.protocol)}}return s},isFollowableUrl(e,t){const o=t.follow;return Q(o)?o(e):o}},U={gmXhr:(e,t={})=>(a.req&&ne(a.req.abort),new Promise((o,n)=>{function r(t){a.req=null,t.status<400&&!t.error?o(t):n(`Server error ${t.status} ${t.error}\nURL: ${e}`)}const{anonymous:i}=a.rule||{};a.req=GM.xmlHttpRequest(Object.assign({url:e,anonymous:i,withCredentials:!i,method:"GET",timeout:3e4},t,{onload:r,onerror:r,ontimeout(){a.req=null,n(`Timeout fetching ${e}`)}}))})),async getDoc(e){if(!e)return{doc:s,finalUrl:location.href,responseText:s.documentElement.outerHTML};const t=await(a.post?U.gmXhr(e,{method:"POST",data:a.post,headers:{"Content-Type":"application/x-www-form-urlencoded",Referer:e}}):U.gmXhr(e));return t.doc=ue(t.responseText),t},async getImage(e,t,o=a.xhr){a.bufBar=!1,a.bufStart=te();const n=await U.gmXhr(e,{responseType:"blob",headers:{Accept:"image/png,image/*;q=0.8,*/*;q=0.5",Referer:t||(Q(o)?o():e)},onprogress:U.getImageProgress});C.set(!1);const r=U.guessMimeType(n);let i=n.response;if(!i)throw"Empty response";return i.type!==r&&(i=i.slice(0,i.size,r)),["blob"===o?a.blobUrl=URL.createObjectURL(i):await U.blobToDataUrl(i),r.startsWith("video")]},getImageProgress(e){if(!a.bufBar&&te()-a.bufStart>3e3&&e.loaded/e.total<.5&&(a.bufBar=!0),a.bufBar){const t=e.loaded/e.total*100|0,o=e.total/1024|0;C.set(`${t}% of ${o} kiB`,"xhr")}},async findRedirect(){try{const{finalUrl:e}=await U.gmXhr(a.url,{method:"HEAD",headers:{Referer:location.href.split("#",1)[0]}}),t=q.find(e,a.node,{noHtml:!0});if(!t||!t.url)throw`Couldn't follow redirection target: ${e}`;Object.assign(a,t),M.startSingle()}catch(e){M.handleError(e)}},async saveFile(){const e=a.popup.src||a.popup.currentSrc;let t=U.getFileName(a.imageUrl||e);if(t.includes(".")||(t+=".jpg"),e.startsWith("blob:")||e.startsWith("data:"))le("a",{href:e,download:t}).dispatchEvent(new MouseEvent("click"));else{B.set("+loading");const o=()=>B.set("-loading"),n="function"==typeof GM_download;(n?GM_download:GM.xmlHttpRequest)({url:e,name:t,headers:{Referer:e},method:"get",responseType:"blob",overrideMimeType:"application/octet-stream",onerror:e=>{C.set(`Could not download ${t}: ${e.error||e.message||e}.`,"error"),o()},onprogress:U.getImageProgress,onload({response:e}){if(o(),!n){const o=Object.assign(document.createElement("a"),{href:URL.createObjectURL(e),download:t});o.dispatchEvent(new MouseEvent("click")),setTimeout(URL.revokeObjectURL,1e4,o.href)}}})}},getFileName:e=>decodeURIComponent(e).split(/[#?&]/,1)[0].split("/").pop(),blobToDataUrl:e=>new Promise((t,o)=>{const n=new FileReader;n.onload=()=>t(n.result),n.onerror=o,n.readAsDataURL(e)}),guessMimeType({responseHeaders:e,finalUrl:t}){if(/Content-Type:\s*(\S+)/i.test(e)&&!RegExp.$1.includes("text/plain"))return RegExp.$1;switch((P.extractFileExt(t)||"jpg").toLowerCase()){case"bmp":return"image/bmp";case"gif":return"image/gif";case"jpe":case"jpeg":case"jpg":return"image/jpeg";case"mp4":return"video/mp4";case"png":return"image/png";case"svg":return"image/svg+xml";case"tif":case"tiff":return"image/tiff";case"webm":return"video/webm";default:return"application/octet-stream"}},findImageUrl(e,t){if(!e)return;let o;const n=Object.values(e.dataset).some(e=>o=e.match(x)[0])&&o||e.getAttribute("src")||e.getAttribute("href")||e.getAttribute("content")||(o=e.outerHTML).includes("http")&&o.match(x)[0];return!!n&&P.rel2abs(P.decodeHtmlEntities(n),pe("base[href]","href",e.ownerDocument)||t)}},B={set(e){if(!e&&!n.globalStatus)return void(a.node&&a.node.removeAttribute(f));const t=n.globalStatus?g:"",o=e&&/^[+-]/.test(e)&&e[0],r=e&&`${t}${o?e.slice(1):e}`,i=n.globalStatus?s.documentElement:"edge"===r?a.popup:a.node;if(!i)return;const l=n.globalStatus?"class":f,c=(i.getAttribute(l)||"").trim(),u=new Set(c?c.split(/\s+/):[]);switch(o){case"-":u.delete(r);break;case!1:for(const e of u)e.startsWith(t)&&e!==r&&u.delete(e);case"+":r&&u.add(r)}const d=[...u].join(" ");d!==c&&i.setAttribute(l,d)},loading(e){e?a.popupLoaded||B.set("+loading"):(clearTimeout(a.timerStatus),a.timerStatus=setTimeout(B.loading,50,!0))}},F=(()=>{function e(e){return this.some(t,e)}function t(e){return e.fn.call(e.data,this)}function o(e){return e.endsWith(this)||e.length>this.length&&e.indexOf(this,e.length-this.length-1)>=0&&n(e)}function n(e,t=e.length-1){return d.lastIndex=t,d.test(e)}function r(e){return e.startsWith(this)&&(e.length===this.length||e.length===this.length+1&&n(e))}function i(e){return e.includes(this)}function a(e){return e.includes(this[0])&&this[1].test(e)}function s(e){return e.startsWith(this)}function l(e){return e.includes(this[0])&&c.call(this,e)}function c(e){let t=e.indexOf("//");if(t&&":"!==e[t-1])return;t=t<0?0:t+2;const o=e.slice(t,(e.indexOf("/",t)+1||e.length+1)-1),[r,i,a,s]=this;let l=a?o.length-i.length:0;for(;;l++){if(l=o.indexOf(i,l),l<0)return;if(!l||"."===o[l-1])break}if(l+=t,e.lastIndexOf(r,l)!==l)return;const c=l+r.length;return!s||c===o.length||c===e.length||n(e,c)}const u=/[.+*?(){}[\]^$|]/g,d=/[^\w%._-]/y,p=d.source;return t=>{const n=[];for(const e of J(t)){const t=e.startsWith("||"),c=!t&&e.startsWith("|"),d=e.endsWith("^");let m,g=e.slice(2*t+c,-d||void 0);if(g.includes("^")){let e="";for(const t of g.split("^"))t.length>e.length&&(e=t);const o=new RegExp((c?"^":"")+(t?"^(([^/:]+:)?//)?([^./]*\\.)*?":"")+g.replace(u,"\\$&").replace(/\\\^/g,p)+(d?`(?:${p}|$)`:""),"i");g=[e,o],m=a}else if(c)m=d?r:s;else if(t){const e=g.indexOf("/"),t=e>0?g.slice(0,e):g;g=[g,t,e>0,d],m=l}else m=d?o:i;n.push({fn:m,data:g})}return n.length>1?{fn:e,data:n}:n[0]}})(),P={addStyle(e,t){const o=`${g}style:${e}`,n=s.getElementById(o)||t&&le("style",{id:o});if(n)return n.textContent!==t&&(n.textContent=t),n.parentElement!==s.head&&s.head.appendChild(n),n},color:(e,t=n[`ui${e}Opacity`])=>(e.startsWith("#")?e:n[`ui${e}Color`])+(256+Math.round(t/100*255)).toString(16).slice(1),decodeHtmlEntities:e=>e.replace(/&quot;/g,'"').replace(/&apos;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&"),decodeUrl(e){if(!e||"string"!=typeof e)return e;const t=e.indexOf("%"),o=e.indexOf(":");return t>=0&&(t<o||o<0)?decodeURIComponent(e):e},deepEqual(e,t){if(!e||!t||"object"!=typeof e||typeof e!=typeof t)return e===t;if(m(e))return m(t)&&e.length===t.length&&e.every((e,o)=>P.deepEqual(e,t[o]));const o=Object.keys(e);return o.length===Object.keys(t).length&&o.every(o=>P.deepEqual(e[o],t[o]))},extractFileExt:e=>(e=k.exec(e))&&e[1],forceLayout(e){e.clientHeight},formatError(e,t){const o=m(e),n=o?e[0]:e.message,{url:r,imageUrl:i}=a;let l;e=n?e:(e.readyState?"Request failed.":"error"===e.type&&"File can't be displayed."+(ae('div[bgactive*="flashblock"]',s)?" Check Flashblock settings.":""))||e;const c=[l="%c%s%c","font-weight:bold",o?n:e,"font-weight:normal",(l+="\nNode: %o",a.node),(l+="\nRule: %o",t),r&&(l+="\nURL: %s",r),i&&i!==r&&(l+="\nFile: %s",i),...o?(l+=e[1],e.slice(2)):[],e.stack].filter(Boolean);return c[0]=l,c.message=n||e,c},getReactChildren(e,t){u&&(e=e.wrappedJSObject||e);for(const o of Object.keys(e))if("string"==typeof o&&o.startsWith("__reactProps"))return(e=e[o].children)&&(t?ie(e,t):e)},isVideoUrl:e=>e.startsWith("data:video")||P.isVideoUrlExt(e),isVideoUrlExt:e=>(e=P.extractFileExt(e))&&/^(webm|mp4)$/i.test(e),newFunction(...e){try{return M.NOP||(E?window.eval(E(`(function anonymous(${e.slice(0,-1).join(",")}){${e.slice(-1)[0]}})`)):new Function(...e))}catch(e){if(!v.test(e.message))throw e;return M.NOP=()=>{},M.NOP}},rel2abs(e,t=location.href){try{return/^(data:|blob:|[-\w]+:\/\/)/.test(e)?e:new URL(e,t).href}catch(t){return e}},stringify(...e){const t=Array.prototype,{toJSON:o}=t;o&&(t.toJSON=null);const n=JSON.stringify(...e);return o&&(t.toJSON=o),n},suppressTooltip(){for(const e of[a.node.parentNode,a.node,a.node.firstElementChild]){const t=(e||0).title;if(t&&t!==e.textContent&&!s.title.includes(t)&&!/^https?:\S+$/.test(t)){a.tooltip={node:e,text:t},e.title="";break}}},tabFixUrl(){const{tabfix:e=M.tabfix}=a.rule;return e&&"IMG"===a.popup.tagName&&!a.xhr&&V(`data:text/html;charset=utf8,\n      <style>\n        body {\n          margin: 0;\n          padding: 0;\n          background: #222;\n        }\n        .fit {\n          overflow: hidden\n        }\n        .fit > img {\n          max-width: 100vw;\n          max-height: 100vh;\n        }\n        body > img {\n          margin: auto;\n          position: absolute;\n          left: 0;\n          right: 0;\n          top: 0;\n          bottom: 0;\n        }\n      </style>\n      <body class=fit>\n        <img onclick="document.body.classList.toggle('fit')" src="${a.popup.src}">\n      </body>\n    `).replace(/\x20?([:>])\x20/g,"$1").replace(/#/g,"%23")}},H=20,G=200,K=`\n  :host {\n    all: initial !important;\n    position: fixed !important;\n    z-index: 2147483647 !important;\n    top: ${H}px !important;\n    right: 20px !important;\n    padding: 1.5em !important;\n    color: #000 !important;\n    --bg: #eee;\n    background: var(--bg) !important;\n    box-shadow: 5px 5px 25px 2px #000 !important;\n    width: 33em !important;\n    border: 1px solid black !important;\n    display: flex !important;\n    flex-direction: column !important;\n  }\n  main {\n    font: 12px/15px sans-serif;\n  }\n  main:not([data-start=auto]) [data-start-auto] {\n    opacity: .5;\n  }\n  table {\n    text-align:left;\n  }\n  ul {\n    min-height: 430px;\n    max-height: calc(100vh - ${G}px);\n    margin: 0 0 15px 0;\n    padding: 0;\n    list-style: none;\n  }\n  li {\n    margin: 0;\n    padding: .25em 0;\n  }\n  li.options {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n  }\n  li.row {\n    align-items: start;\n    flex-wrap: wrap;\n  }\n  li.row label {\n    display: flex;\n    flex-direction: row;\n    align-items: center;\n  }\n  li.row input {\n    margin-right: .25em;\n  }\n  li.stretch label {\n    flex: 1;\n    white-space: nowrap;\n  }\n  li.stretch label > span {\n    display: flex;\n    flex-direction: row;\n    flex: 1;\n  }\n  label {\n    display: inline-flex;\n    flex-direction: column;\n  }\n  label:not(:last-child) {\n    margin-right: 1em;\n  }\n  input, select {\n    min-height: 1.3em;\n    box-sizing: border-box;\n  }\n  input[type=checkbox] {\n    margin-left: 0;\n  }\n  input[type=number] {\n    width: 4em;\n  }\n  input:not([type=checkbox])  {\n    padding: 0 .25em;\n  }\n  input[type=range] {\n    flex: 1;\n    width: 100%;\n    margin: 0 .25em;\n    padding: 0;\n    filter: saturate(0);\n    opacity: .5;\n  }\n  u + input[type=range] {\n    max-width: 3em;\n  }\n  input[type=range]:hover {\n    filter: none;\n    opacity: 1;\n  }\n  input[type=color] {\n    position: absolute;\n    width: calc(1.5em + 2px);\n    opacity: 0;\n    cursor: pointer;\n  }\n  u {\n    position: relative;\n    flex: 0 0 1.5em;\n    height: 1.5em;\n    border: 1px solid #888;\n    pointer-events: none;\n    color: #888;\n    background-image:\n      linear-gradient(45deg, currentColor 25%, transparent 25%, transparent 75%, currentColor 75%),\n      linear-gradient(45deg, currentColor 25%, transparent 25%, transparent 75%, currentColor 75%);\n    background-size: .5em .5em;\n    background-position: 0 0, .25em .25em;\n  }\n  u::after {\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    content: "";\n    background-color: var(--color);\n  }\n  .range-edit {\n    position: absolute;\n    box-shadow: 0 0.25em 1em #000;\n    z-index: 99;\n  }\n  textarea {\n    resize: vertical;\n    margin: 1px 0;\n    font: 11px/1.25 Consolas, monospace;\n  }\n  :invalid {\n    background-color: #f002;\n    border-color: #800;\n  }\n  code {\n    font-weight: bold;\n  }\n  a {\n    text-decoration: none;\n    color: LinkText;\n    cursor: pointer;\n  }\n  a:hover {\n    text-decoration: underline;\n  }\n  button {\n    padding: .2em .5em;\n    margin-right: 1em;\n  }\n  kbd {\n    padding: 1px 6px;\n    font-weight: bold;\n    font-family: Consolas, monospace;\n    border: 1px solid #888;\n    border-radius: 3px;\n    box-shadow: inset 1px 1px 5px #8888, .25px .5px 2px #0008;\n  }\n  .column {\n    display: flex;\n    flex-direction: column;\n  }\n  .flex {\n    display: flex;\n  }\n  .highlight {\n    animation: 2s fade-in cubic-bezier(0, .75, .25, 1);\n    animation-fill-mode: both;\n  }\n  #_rules > * {\n    word-break: break-all;\n  }\n  #_rules > :not(:focus) {\n    overflow: hidden; /* prevents wrapping in FF */\n  }\n  .invalid-domain {\n    opacity: .5;\n  }\n  .matching-domain {\n    border-color: #56b8ff;\n    background: #d7eaff;\n  }\n  #_mover {\n    cursor: move;\n    user-select: none;\n    position: absolute;\n    top: 0;\n    left: 8px;\n    right: 24px;\n    height: 24px;\n    text-align: center;\n    background: linear-gradient(transparent 10px, currentColor 10px, currentColor 11px, transparent 11px,\n      transparent 13px, currentColor 13px, currentColor 14px, transparent 14px);\n  }\n  #_mover::after {\n    content: 'MPIV ${GM.info.script.version}';\n    font: bold 20px/1.3 sans;\n    background: var(--bg);\n    padding: 0 1ex;\n  }\n  #_x {\n    position: absolute;\n    top: 0;\n    right: 0;\n    padding: 4px 8px;\n    cursor: pointer;\n    user-select: none;\n  }\n  #_x:hover {\n    background-color: #8884;\n  }\n  #_cssApp {\n    color: seagreen;\n  }\n  #_exportNotification {\n    color: green;\n    font-weight: bold;\n    position: absolute;\n    bottom: 4px;\n    right: 26px;\n  }\n  #_installHint {\n    color: green;\n  }\n  #_usage {\n    display: flex;\n    flex-wrap: wrap;\n    align-items: flex-start;\n    gap: 1em;\n  }\n  #_usage th {\n    font-weight: normal;\n    padding-right: .5em;\n  }\n  #_usage tr:nth-last-child(n + 2) > :not(br) {\n    white-space: pre-line;\n    border-bottom: 1px dotted #8888;\n  }\n  #_usage kbd {\n    font-family: monospace;\n    font-weight: bold;\n  }\n  @keyframes fade-in {\n    from { background-color: deepskyblue }\n    to {}\n  }\n  @media (prefers-color-scheme: dark) {\n    :host {\n      color: #aaa !important;\n      --bg: #333 !important;\n    }\n    a {\n      color: deepskyblue;\n    }\n    button {\n      background: linear-gradient(-5deg, #333, #555);\n      border: 1px solid #000;\n      box-shadow: 0 2px 6px #181818;\n      border-radius: 3px;\n      cursor: pointer;\n    }\n    button:hover {\n      background: linear-gradient(-5deg, #333, #666);\n    }\n    textarea, input, select {\n      background: #111;\n      color: #BBB;\n      border: 1px solid #555;\n    }\n    input[type=checkbox] {\n      filter: invert(1);\n    }\n    input[type=range] {\n      filter: invert(1) saturate(0);\n    }\n    input[type=range]:hover {\n      filter: invert(1);\n    }\n    kbd {\n      border-color: #666;\n    }\n    @supports (-moz-appearance: none) {\n      input[type=checkbox],\n      input[type=range],\n      input[type=range]:hover {\n        filter: none;\n      }\n    }\n    .range-edit {\n      box-shadow: 0 .5em 1em .5em #000;\n    }\n    .matching-domain {\n      border-color: #0065af;\n      background: #032b58;\n      color: #ddd;\n    }\n    #_cssApp {\n      color: darkseagreen;\n    }\n    #_installHint {\n      color: greenyellow;\n    }\n    ::-webkit-scrollbar {\n      width: 14px;\n      height: 14px;\n      background: #333;\n    }\n    ::-webkit-scrollbar-button:single-button {\n      background: radial-gradient(circle at center, #555 40%, #333 40%)\n    }\n    ::-webkit-scrollbar-track-piece {\n      background: #444;\n      border: 4px solid #333;\n      border-radius: 8px;\n    }\n    ::-webkit-scrollbar-thumb {\n      border: 3px solid #333;\n      border-radius: 8px;\n      background: #666;\n    }\n    ::-webkit-resizer {\n      background: #111 linear-gradient(-45deg, transparent 3px, #888 3px, #888 4px, transparent 4px, transparent 6px, #888 6px, #888 7px, transparent 7px) no-repeat;\n      border: 2px solid transparent;\n    }\n  }\n`,W=(e,t,o)=>e<t?t:e>o?o:e,D=(e,t)=>e-t,V=e=>e.trim().replace(/\n\s*/g,""),Z=e=>(e.preventDefault(),e.stopPropagation()),J=e=>m(e)?e:[e],X=e=>(e.altKey?"!":"")+(e.ctrlKey?"^":"")+(e.metaKey?"#":"")+(e.shiftKey?"+":""),Y=e=>X(e)+(e.key&&e.key.length>1?e.key:e.code),Q=e=>"function"==typeof e,ee=e=>e&&"VIDEO"===e.tagName,te=performance.now.bind(performance),oe=(...e)=>{let t=0;for(const o of e)t+=parseFloat(o)||0;return t},ne=(e,...t)=>{try{return e(...t)}catch(e){}},re=e=>ne(JSON.parse,e),ie=(e,t,o)=>{if(e&&t)for(const o of t.split(".")){if(!e)break;e=e[o]}return o&&void 0!==e?o(e):e},ae=(e,t=s)=>t.querySelector(e)||!1,se=(e,t=s)=>t.querySelectorAll(e),le=(e,t,o)=>{"string"!=typeof e&&(o=t,t=e,e=""),o||null==t||"[object Object]"==={}.toString.call(t)||(o=t,t=null);const n="fragment"===e,[,r,i,a]=e.match(/^(\w*)(?:#([^.]+))?(?:\.(.+))?$/),l=n?s.createDocumentFragment():s.createElement(r||"div");if(i&&(l.id=i),a&&(l.className=a.replace(/\./g," ")),t)for(const[e,o]of Object.entries(t))e.startsWith("data-")?null!=o&&l.setAttribute(e,o):l[e]=o;return null!=o&&(m(o)?l.append(...o.filter(Boolean)):o instanceof Node?l.appendChild(o):l.textContent=o),l},ce=(e,t)=>Object.entries(t).forEach(([t,o])=>e.style.setProperty(t,o,"important")),ue=e=>(new DOMParser).parseFromString(e,"text/html"),de=(e,t)=>{for(const o of J(e)){const e=o&&ae(o,t);if(e)return e}},pe=(e,t,o=s)=>(o=ae(e,o))&&o[t]||"",me=(e,t)=>(e=e.closest(`[${t}]`))&&(t.startsWith("data-")?e.getAttribute(t):e[t])||"",ge=e=>e&&e.remove(),he=({dataset:e},t,o)=>null==o?delete e[t]:e[t]=o;if((async()=>{n=await O.load({save:!0}),s.body||await new Promise(e=>new MutationObserver((t,o)=>s.body&&(o.disconnect(),e())).observe(document,{subtree:!0,childList:!0}));const e=s.body.firstElementChild;e&&(M.isImageTab=e===s.body.lastElementChild&&e.matches("img, video"),M.isEnabled=n.imgtab||!M.isImageTab),I&&I.register(),addEventListener("mouseover",T.onMouseOver,!0),addEventListener("contextmenu",T.onContext,!0),addEventListener("keydown",T.onKeyDown,!0),addEventListener("visibilitychange",T.onVisibility,!0),addEventListener("blur",T.onVisibility,!0),["greasyfork.org","github.com"].includes(l)&&addEventListener("click",t,!0),addEventListener("message",M.onMessage,!0)})(),window.trustedTypes){const e=window.trustedTypes,t="createPolicy",o=e[t];e[t]=function n(r,i){let a;const s=o.call(e,r,i);return(_||i[a="createHTML"]&&(_=s[a].bind(s)))&&(E||i[a="createScript"]&&(E=s[a].bind(s)))&&e[t]===n&&delete e[t],s}}