// ==UserScript==
// @name         URL Visit Tracker (Improved)
// @namespace    https://github.com/hongmd/userscript-improved
// @version      2.5.4
// @author       hongmd
// @contributor  Original idea by Chewy
// @license      MIT
// @homepageURL  https://github.com/hongmd/userscript-improved
// @supportURL   https://github.com/hongmd/userscript-improved/issues
// @match        https://*/*
// @run-at       document-start
// @noframes
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_registerMenuCommand
// @downloadURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/URL20Visit20Tracker2028Improved29.user.js
// @updateURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/URL20Visit20Tracker2028Improved29.meta.js
// ==/UserScript==
!function(){"use strict";function e(t){if(!t||"string"!=typeof t)return console.warn("Invalid URL provided to normalizeUrl:",t),location.href;let n=t.trim();try{new URL(n.startsWith("http")?n:"http://"+n)}catch(n){return A.DEBUG&&console.warn("Malformed URL detected, using current location:",t),e(location.href)}return A.NORMALIZE_URL.CLEAN_SEARCH_URLS&&(n=function(e){if(!A.NORMALIZE_URL.CLEAN_SEARCH_URLS)return e;try{const t=new URL(e.startsWith("http")?e:"https://"+e),n=t.hostname.toLowerCase(),o=t.pathname,i=new URLSearchParams(t.search);if((n.includes("google.")||"google.com"===n)&&o.includes("/search")){const n=i.get("q");if(n){const i=`${t.protocol}//${t.hostname}${o}?q=${encodeURIComponent(n)}`;return A.DEBUG&&console.log(`🔍 Cleaned Google search: "${e}" → "${i}"`),i}}else if(n.includes("bing.com")&&o.includes("/search")){const n=i.get("q");if(n){const i=`${t.protocol}//${t.hostname}${o}?q=${encodeURIComponent(n)}`;return A.DEBUG&&console.log(`🔍 Cleaned Bing search: "${e}" → "${i}"`),i}}else if(n.includes("duckduckgo.com")){const n=i.get("q");if(n){const o=`${t.protocol}//${t.hostname}/?q=${encodeURIComponent(n)}`;return A.DEBUG&&console.log(`🔍 Cleaned DuckDuckGo search: "${e}" → "${o}"`),o}}else if(n.includes("youtube.com")&&o.includes("/results")){const n=i.get("search_query");if(n){const i=`${t.protocol}//${t.hostname}${o}?search_query=${encodeURIComponent(n)}`;return A.DEBUG&&console.log(`🔍 Cleaned YouTube search: "${e}" → "${i}"`),i}}}catch(e){A.DEBUG&&console.warn("Failed to clean search URL:",e)}return e}(n)),A.NORMALIZE_URL.REMOVE_PROTOCOL&&(n=n.replace(/^https?:\/\//,"")),A.NORMALIZE_URL.REMOVE_WWW&&(n=n.replace(/^www\./,"")),A.NORMALIZE_URL.REMOVE_TRAILING_SLASH&&(n=n.replace(/\/$/,"")),A.NORMALIZE_URL.REMOVE_HASH&&(n=n.split("#")[0]),A.NORMALIZE_URL.REMOVE_QUERY&&(n=n.split("?")[0]),A.DEBUG&&console.log(`🔗 URL normalized: "${t}" → "${n}"`),n}function t(e){if(!A.URL_FILTERS.SKIP_UTILITY_PAGES)return!1;const t=e.toLowerCase();for(const n of A.URL_FILTERS.SKIP_PATTERNS)if(t.includes(n.toLowerCase()))return A.DEBUG&&console.log(`🚫 Skipping URL (matches pattern "${n}"): ${e}`),!0;return!1}function n(e,t){if(!e)return null;if(e.nodeType===Node.TEXT_NODE&&(e=e.parentElement),!e||"function"!=typeof e.closest){let n=e;for(;n&&n.nodeType===Node.ELEMENT_NODE;){if(n.matches&&n.matches(t))return n;n=n.parentElement}return null}return e.closest(t)}function o(){if(A.POLLING.SKIP_WHEN_HIDDEN&&document.hidden)return void(A.DEBUG&&console.log("⏸️ Skipping poll - tab is hidden"));const e=location.href,t=Date.now();if(B&&!P&&t-w>=k){A.DEBUG&&console.log(`🔄 Polling processing pending URL change: ${$} → ${B}`);const e=B;B=null,e&&e!==$&&($=e,w=t,E())}e!==M&&t-N>=1e3?(A.DEBUG&&console.log(`🔄 Polling detected URL change: ${M} → ${e}`),M=e,N=t,v()):e!==M&&(M=e)}function i(){y&&clearInterval(y);let e=A.POLL_INTERVAL;A.POLLING.ADAPTIVE&&(e=G>0?Math.max(2e3,A.POLL_INTERVAL/2):2*A.POLL_INTERVAL,G=Math.max(0,G-1)),y=setInterval(o,e)}function a(e=new Date){return e.getTime()}function s(e){const t=new Date(e),n=e=>e.toString().padStart(2,"0");return`${n(t.getHours())}:${n(t.getMinutes())} ${n(t.getDate())}/${n(t.getMonth()+1)}/${t.getFullYear()}`}function r(e){if(!Number.isFinite(e))return"0";if(e<0)return"0";if(0===e)return"0";const t=Math.abs(Math.floor(e));return t>=1e9?Math.round(t/1e8)/10+"B":t>=1e6?Math.round(t/1e5)/10+"M":t>=1e3?Math.round(t/100)/10+"K":String(t)}function c(){if(O&&null!==C)return C;try{return C=GM_getValue("visitDB",{}),O=!0,C}catch(e){return console.warn("Failed to read visit database:",e),C={},O=!0,C}}function l(){return O&&null!==C?C:c()}function d(e){try{Object.keys(e).length>A.CLEANUP_THRESHOLD&&(e=function(e){const t=Object.keys(e);if(t.length<=A.MAX_URLS_STORED)return e;A.DEBUG&&console.log(`🧹 Large database cleanup: ${t.length} → ${A.MAX_URLS_STORED} URLs`);const n=()=>{const n=t.map(t=>{const n=e[t],o=n.visits?.[0]??0,i=(Date.now()-o)/864e5,a=Math.max(0,30-i)/30;return{url:t,score:n.count*(1+a),count:n.count,lastVisit:o}});n.sort((e,t)=>t.score-e.score);const o=n.slice(0,A.MAX_URLS_STORED);return Object.fromEntries(o.map(({url:t})=>[t,e[t]]))};return window.requestIdleCallback&&t.length>5e3?new Promise(e=>{requestIdleCallback(()=>{e(n())},{timeout:1e4})}):n()}(e)),C=e,O=!0,GM_setValue("visitDB",e)}catch(e){console.warn("Failed to save visit database:",e),O=!1}}function u(){O=!1,setTimeout(()=>{C=null},0)}function E(){if(t(location.href))return void(A.DEBUG&&console.log(`🚫 Skipping visit tracking: ${location.href}`));const e=c(),n=a(new Date);e[$]??={count:0,visits:[]};const o=e[$];if(o.count+=1,o.visits.unshift(n),o.visits.length>A.MAX_VISITS_STORED&&(o.visits.length=A.MAX_VISITS_STORED),A.DEBUG){const e=1===o.count;console.log(e?`🆕 New URL tracked: ${$}`:`🔄 URL revisited: ${$} (${o.count} times)`)}d(e),m(o),b||(GM_registerMenuCommand("👁️ Toggle Badge",R),GM_registerMenuCommand("📊 Export Data",L),GM_registerMenuCommand("📈 Show Statistics",g),GM_registerMenuCommand("🗑️ Clear Current Page",p),GM_registerMenuCommand("💥 Clear All Data",h),GM_registerMenuCommand("🚫 Toggle URL Filtering",_),GM_registerMenuCommand("🔍 Toggle Search URL Cleaning",f),GM_registerMenuCommand("🐛 Toggle Debug Mode",U),b=!0)}function L(){try{const e=l(),t=JSON.stringify(e,null,2),n=new Blob([t],{type:"application/json"}),o=URL.createObjectURL(n),i=document.createElement("a");i.href=o,i.download=`visit-tracker-${(new Date).toISOString().split("T")[0]}.json`,document.body?(document.body.appendChild(i),i.click(),document.body.removeChild(i)):i.click(),URL.revokeObjectURL(o)}catch(e){console.error("Export failed:",e),alert("Failed to export data: "+e.message)}}function g(){const e=l(),t=Object.keys(e),n=t.length;if(0===n)return void alert("📈 Visit Tracker Statistics\n\n🌐 No websites tracked yet!\n\nStart browsing to collect visit data.");const o=t.reduce((t,n)=>t+e[n].count,0),i=t.reduce((t,n)=>e[n].count>(e[t]?.count??0)?n:t,""),a=t.reduce((t,n)=>{const o=e[n].visits;if(!o?.length)return t;const i=o[o.length-1],a=e[t]?.visits;return a?.length?i<a[a.length-1]?n:t:n},""),s=`\n📈 Visit Tracker Statistics\n\n🌐 Total websites tracked: ${n}\n👆 Total visits recorded: ${o}\n🏆 Most visited: ${i} (${e[i]?.count??0} visits)\n⏰ Oldest tracked site: ${a}\n📅 Current page visits: ${e[$]?.count??0}\n\nDatabase size: ${Math.round(function(e){try{const t=JSON.stringify(e);return new Blob([t],{type:"application/json"}).size}catch(t){return console.warn("Failed to calculate Blob size, using character count:",t),JSON.stringify(e).length}}(e)/1024)} KB (UTF-8)\n    `.trim();alert(s)}function p(){if(confirm(`Clear visit data for current page?\n\nURL: ${$}\nThis will only affect this page.`)){const e=c(),t=a(new Date);e[$]={count:1,visits:[t]},d(e),m(e[$]),alert("Current page data cleared! Counter reset to 1.")}}function h(){if(confirm("⚠️ WARNING: This will clear ALL visit data from ALL websites!\n\nAre you absolutely sure?")){const e=a(new Date),t={};t[$]={count:1,visits:[e]},d(t),m(t[$]),alert("All visit data cleared! Current page counter reset to 1.")}}function m(e){!function(){if(document.getElementById("vt-hover-styles"))return;const e=`\n      .vt-badge {\n        position: fixed;\n        right: ${A.BADGE_POSITION.right};\n        bottom: ${A.BADGE_POSITION.bottom};\n        z-index: 2147483647;\n        font-family: system-ui, sans-serif;\n        cursor: pointer;\n        transition: all 0.3s ease;\n      }\n      .vt-badge.hidden {\n        opacity: 0;\n        pointer-events: none;\n        transform: scale(0.8);\n      }\n      .vt-link {\n        display: inline-block;\n        padding: 6px 10px;\n        border-radius: 9999px;\n        background: rgba(20,20,20,0.9);\n        color: #fff !important;\n        font-size: 12px;\n        box-shadow: 0 4px 14px rgba(0,0,0,0.2);\n        opacity: 0.85;\n        transition: opacity 0.2s ease;\n      }\n      .vt-badge:hover .vt-link { opacity: 1; }\n      .vt-tooltip {\n        position: absolute;\n        bottom: 120%;\n        right: 0;\n        background: #111;\n        color: #fff;\n        border-radius: 10px;\n        padding: 8px 10px;\n        font-size: 12px;\n        white-space: nowrap;\n        box-shadow: 0 10px 25px rgba(0,0,0,0.35);\n        opacity: 0;\n        transform: translateY(6px);\n        transition: opacity 140ms ease, transform 140ms ease;\n        pointer-events: none;\n      }\n      .vt-badge:hover .vt-tooltip {\n        opacity: 1;\n        transform: translateY(0);\n      }\n      .vt-tooltip .vt-line { display: block; }\n    `,t=document.createElement("style");t.id="vt-hover-styles",t.textContent=e,document.documentElement.appendChild(t)}();let t=document.getElementById("vt-hover-badge");t||(t=document.createElement("div"),t.id="vt-hover-badge",t.className="vt-badge",t.innerHTML='\n        <a class="vt-link" href="javascript:void(0)"></a>\n        <div class="vt-tooltip"></div>\n      ',t.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),R()}),document.documentElement.appendChild(t)),D?t.classList.remove("hidden"):t.classList.add("hidden"),t.querySelector(".vt-link").textContent=`Visit: ${r(e.count)}`;const n=t.querySelector(".vt-tooltip");n.innerHTML=`<span class="vt-line">Visit: ${e.count}</span>`,e.visits&&e.visits.length>0?e.visits.forEach((e,t)=>{const o=s(e);n.innerHTML+=`<span class="vt-line">${t+1}. ${o}</span>`}):n.innerHTML+='<span class="vt-line">No visit history</span>'}function R(){D=!D;const e=document.getElementById("vt-hover-badge");e&&(D?e.classList.remove("hidden"):e.classList.add("hidden"));try{GM_setValue("badgeVisible",D)}catch(e){console.warn("Failed to save badge visibility state:",e)}}function _(){A.URL_FILTERS.SKIP_UTILITY_PAGES=!A.URL_FILTERS.SKIP_UTILITY_PAGES;try{GM_setValue("urlFiltering",A.URL_FILTERS.SKIP_UTILITY_PAGES)}catch(e){console.warn("Failed to save URL filtering state:",e)}const e=A.URL_FILTERS.SKIP_UTILITY_PAGES?"enabled":"disabled";alert(`🚫 URL Filtering ${e}!\n\nUtility pages (cookies, auth, etc.) filtering is now ${e}.`)}function f(){A.NORMALIZE_URL.CLEAN_SEARCH_URLS=!A.NORMALIZE_URL.CLEAN_SEARCH_URLS;try{GM_setValue("searchCleaning",A.NORMALIZE_URL.CLEAN_SEARCH_URLS)}catch(e){console.warn("Failed to save search cleaning state:",e)}const e=A.NORMALIZE_URL.CLEAN_SEARCH_URLS?"enabled":"disabled";alert(`🔍 Search URL Cleaning ${e}!\n\nSearch URLs will now ${A.NORMALIZE_URL.CLEAN_SEARCH_URLS?"be cleaned (grouped by query)":"be tracked as-is (separate tracking)"}.`)}function U(){A.DEBUG=!A.DEBUG;try{GM_setValue("debugMode",A.DEBUG)}catch(e){console.warn("Failed to save debug mode state:",e)}const e=A.DEBUG?"enabled":"disabled";alert(`🐛 Debug mode ${e}!\n\nDebug logging is now ${e}.`),A.DEBUG&&console.log("🐛 Visit Tracker Debug Mode: ENABLED")}function v(){const n=e(location.href);if(n===$)return;if(t(location.href))return void(A.DEBUG&&console.log(`🚫 Skipping URL tracking: ${location.href}`));A.POLLING.ADAPTIVE&&(G=Math.min(10,G+2));const o=Date.now(),i=o-w;if(i<k)return A.DEBUG&&console.log(`⏰ URL change rate limited, scheduling: ${$} → ${n}`),B=n,P&&clearTimeout(P),void(P=setTimeout(()=>{if(B&&B!==$){A.DEBUG&&console.log(`⏰ Processing pending URL change: ${$} → ${B}`);const e=B;B=null,P=null,$=e,w=Date.now(),E()}},k-i+10));P&&(clearTimeout(P),P=null,B=null),A.DEBUG&&console.log(`🌐 URL changed: ${$} → ${n}`),$=n,w=o,E()}function I(e,t){Y={x:e+12,y:t+12},F&&cancelAnimationFrame(F),F=requestAnimationFrame(()=>{Y&&(V.style.left=Y.x+"px",V.style.top=Y.y+"px",Y=null),F=null})}function S(){V.style.opacity=0,H=null,F&&(cancelAnimationFrame(F),F=null),Y=null,document.removeEventListener("mousemove",T)}function T(e){I(e.clientX,e.clientY)}const A={MAX_VISITS_STORED:20,MAX_URLS_STORED:1e4,CLEANUP_THRESHOLD:12e3,HOVER_DELAY:1e3,POLL_INTERVAL:5e3,BADGE_POSITION:{right:"14px",bottom:"14px"},BADGE_VISIBLE:!0,DEBUG:!1,POLLING:{PAUSE_WHEN_HIDDEN:!0,SKIP_WHEN_HIDDEN:!0,ADAPTIVE:!0},MULTI_TAB:{ENABLED:!1,SYNC_INTERVAL:1e4},NORMALIZE_URL:{REMOVE_QUERY:!1,REMOVE_HASH:!0,REMOVE_WWW:!0,REMOVE_PROTOCOL:!0,REMOVE_TRAILING_SLASH:!0,CLEAN_SEARCH_URLS:!0},URL_FILTERS:{SKIP_UTILITY_PAGES:!0,SKIP_PATTERNS:["/RotateCookiesPage","/ServiceLogin","/CheckCookie","/robots.txt","/favicon.ico","ogs.google.com","/widget/app","/persist_identity","studio.youtube.com/persist_identity"]}};let D=A.BADGE_VISIBLE,b=!1,y=null,M=location.href,N=Date.now(),G=0,C=null,O=!1,$=e(location.href),w=0,B=null,P=null;const k=500,V=document.createElement("div");let x;Object.assign(V.style,{position:"fixed",padding:"6px 8px",fontSize:"12px",fontFamily:"system-ui, sans-serif",background:"rgba(20, 20, 20, 0.9)",color:"white",borderRadius:"6px",pointerEvents:"none",whiteSpace:"nowrap",zIndex:"999999",opacity:"0",transition:"opacity 0.15s ease"}),function(){if(!document.body)return document.addEventListener("DOMContentLoaded",()=>{try{document.body&&!document.body.contains(V)&&document.body.appendChild(V)}catch(e){console.warn("Failed to append tooltip on DOMContentLoaded:",e)}},{passive:!0,once:!0}),!1;try{return document.body.appendChild(V),!0}catch(e){return console.warn("Failed to append tooltip to body:",e),!1}}()||A.DEBUG&&console.log("📋 Tooltip will be appended when DOM is ready");let H=null,F=null,Y=null;document.addEventListener("mouseover",t=>{const o=n(t.target,"a[href]");if(!o)return;const i=o.href;/^https?:\/\//.test(i)&&H!==o&&(H&&(clearTimeout(x),S()),H=o,clearTimeout(x),x=setTimeout(()=>function(t,n){const o=e(n),i=l()[o];if(V.textContent="",i){const e=document.createElement("div");e.textContent=`Visit: ${r(i.count)}`;const t=document.createElement("div"),n=i.visits?.[0]?s(i.visits[0]):"Never";t.textContent=`Last: ${n}`,V.appendChild(e),V.appendChild(t)}else V.textContent="No visits recorded";I(t.clientX,t.clientY),V.style.opacity=1}(t,i),A.HOVER_DELAY),document.addEventListener("mousemove",T,{passive:!0}))},{passive:!0}),document.addEventListener("mouseout",e=>{const t=n(e.target,"a[href]");if(!t||t!==H)return;const o=e.relatedTarget;o&&t.contains(o)?A.DEBUG&&console.log("🔗 Mouse moved to child element, keeping tooltip visible"):n(o,"a[href]")!==t?(A.DEBUG&&console.log("🔗 Mouse left link, hiding tooltip"),clearTimeout(x),S()):A.DEBUG&&console.log("🔗 Mouse moved within same link structure, keeping tooltip visible")},{passive:!0}),window.addEventListener("beforeunload",()=>{P&&(clearTimeout(P),B&&B!==$&&($=B,E()))}),function(){try{D=GM_getValue("badgeVisible",A.BADGE_VISIBLE)}catch(e){console.warn("Failed to load badge visibility state:",e),D=A.BADGE_VISIBLE}try{A.DEBUG=GM_getValue("debugMode",A.DEBUG)}catch(e){console.warn("Failed to load debug mode state:",e),A.DEBUG=!1}try{A.URL_FILTERS.SKIP_UTILITY_PAGES=GM_getValue("urlFiltering",A.URL_FILTERS.SKIP_UTILITY_PAGES)}catch(e){console.warn("Failed to load URL filtering state:",e),A.URL_FILTERS.SKIP_UTILITY_PAGES=!0}try{A.NORMALIZE_URL.CLEAN_SEARCH_URLS=GM_getValue("searchCleaning",A.NORMALIZE_URL.CLEAN_SEARCH_URLS)}catch(e){console.warn("Failed to load search cleaning state:",e),A.NORMALIZE_URL.CLEAN_SEARCH_URLS=!0}A.DEBUG&&console.log("🐛 Visit Tracker Debug Mode: ENABLED"),E(),function(){const e=history.pushState,t=history.replaceState;history.pushState=function(...t){const n=e.apply(this,t);return setTimeout(v,50),n},history.replaceState=function(...e){const n=t.apply(this,e);return setTimeout(v,50),n},window.addEventListener("popstate",v),window.addEventListener("hashchange",v);let n=null;const o=new MutationObserver(e=>{n||(n=setTimeout(()=>{n=null;let t=!1;for(const n of e)if("childList"===n.type){const e=Array.from(n.addedNodes).some(e=>"TITLE"===e.nodeName),o=Array.from(n.removedNodes).some(e=>"TITLE"===e.nodeName);if("TITLE"===n.target.nodeName){t=!0,A.DEBUG&&console.log("📝 Title childList mutation detected:",n);break}if(e||o){t=!0,A.DEBUG&&console.log("📝 Title element added/removed:",n);break}}else if("characterData"===n.type&&"TITLE"===n.target.parentNode?.nodeName){t=!0,A.DEBUG&&console.log("📝 Title characterData mutation detected:",n);break}t&&(A.DEBUG&&console.log("📝 Title change detected, triggering URL change check"),v())},150))});if(document.head){o.observe(document.head,{childList:!0,subtree:!1,characterData:!1});const e=document.querySelector("title");e&&o.observe(e,{childList:!0,characterData:!0,subtree:!0})}else o.observe(document,{childList:!0,subtree:!1});i()}(),document.addEventListener("visibilitychange",()=>{document.hidden?A.POLLING.PAUSE_WHEN_HIDDEN&&y&&(clearInterval(y),y=null):(A.POLLING.PAUSE_WHEN_HIDDEN&&!y&&(A.POLLING.ADAPTIVE&&(G=Math.min(10,G+3)),i()),A.MULTI_TAB.ENABLED&&u())},{passive:!0}),A.MULTI_TAB.ENABLED&&setInterval(()=>{document.hidden||u()},A.MULTI_TAB.SYNC_INTERVAL)}()}();