// ==UserScript==
// @name        Pixiv Plus
// @namespace   https://github.com/Ahaochan/Tampermonkey
// @version     0.9.3
// @icon        https://www.pixiv.net/favicon.ico
// @author      Ahaochan
// @include     http*://www.pixiv.net*
// @match       http://www.pixiv.net/
// @connect     i.pximg.net
// @connect     i-f.pximg.net
// @connect     i-cf.pximg.net
// @license     GPL-3.0
// @supportURL  https://github.com/Ahaochan/Tampermonkey
// @grant       unsafeWindow
// @grant       GM.xmlHttpRequest
// @grant       GM.setClipboard
// @grant       GM.setValue
// @grant       GM.getValue
// @grant       GM_addStyle
// @grant       GM_xmlhttpRequest
// @grant       GM_registerMenuCommand
// @grant       GM_unregisterMenuCommand
// @grant       GM_setClipboard
// @grant       GM_setValue
// @grant       GM_getValue
// @require     https://update.greasyfork.org/scripts/505351/1435420/jquery%20221.js
// @require     https://update.greasyfork.org/scripts/518632/1489865/jszip-min-js.js
// @require     https://update.greasyfork.org/scripts/498746/1399668/FileSaver.js
// @require     https://greasyfork.org/scripts/2963-gif-js/code/gifjs.js?version=8596
// @require     https://greasyfork.org/scripts/375359-gm4-polyfill-1-0-1/code/gm4-polyfill-101.js?version=652238
// @run-at      document-end
// @noframes
// @downloadURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/Pixiv20Plus.user.js
// @updateURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/Pixiv20Plus.meta.js
// ==/UserScript==
jQuery(t=>{"use strict";t.fn.extend({fitWindow(){this.css("width","auto").css("height","auto").css("max-width","").css("max-height",t(window).height())},replaceTagName(e){const o=[];let i=this.length;for(;i--;){const n=document.createElement(e),a=this[i],r=a.attributes;for(let t=r.length-1;t>=0;t--){const e=r[t];n.setAttribute(e.name,e.value)}n.innerHTML=a.innerHTML,t(a).after(n).remove(),o[i]=n}return t(o)},getBackgroundUrl(){const e=[];return this.each(function(o,{style:i}){let n=t(this).css("background-image")||i.backgroundImage||'url("")';const a=n.match(/url\((['"])(.*?)\1\)/);n=a&&a.length>=2?a[2]:"",e.push(n)}),1===e.length?e[0]:e}});const e={ja:{author:"作者",background:"背景画像",background_not_found:"背景画像なし",copy_to_clipboard:"クリップボードにコピーしました",download:"ダウンロード",download_wait:"ダウンロード完了をお待ちください",illegal:"違法",illust_type_single:"[単枚]",illust_type_multiple:"[複数枚]",illust_type_gif:"[GIF画像]",loginWarning:"Pixiv拡張スクリプト警告！より良い体験のためにPixivにログインしてください！未ログインの場合、予期しないバグが発生する可能性があります！",switch_antiAd:"広告無効化",switch_antiRedirect:"リダイレクト解除",switch_commentLoad:"コメント読み込み",switch_imageSize:"画像サイズ表示",switch_preDownload:"画像を事前ダウンロード",switch_searchUid:"UID検索",switch_searchPid:"PID検索",switch_searchAuthor:"作者検索",switch_searchFavourite:"users入り検索"},en:{author:"Author",background:"Background Image",background_not_found:"No Background Image",copy_to_clipboard:"Copied to clipboard",download:"Download",download_wait:"Please wait for download to complete",illegal:"Illegal",illust_type_single:"[Single Image]",illust_type_multiple:"[Multiple Images]",illust_type_gif:"[GIF Image]",loginWarning:"Pixiv Plus Script Warning! Please login to Pixiv for a better experience! Failure to login may result in unpredictable bugs!",switch_antiAd:"Disable Ads",switch_antiRedirect:"Cancel Redirection",switch_commentLoad:"Load Comments",switch_imageSize:"Show Image Size",switch_preDownload:"Pre-download Images",switch_searchUid:"Search UID",switch_searchPid:"Search PID",switch_searchAuthor:"Search Author",switch_searchFavourite:"Search users入り (user bookmarks)"},zh:{author:"作者",background:"背景图",background_not_found:"无背景图",copy_to_clipboard:"已复制到剪贴板",download:"下载",download_wait:"请等待下载完成",illegal:"不合法",illust_type_single:"[单图]",illust_type_multiple:"[多图]",illust_type_gif:"[gif图]",loginWarning:"Pixiv增强 脚本警告! 请登录Pixiv获得更好的体验! 未登录可能产生不可预料的bug!",switch_antiAd:"禁用广告",switch_antiRedirect:"取消重定向",switch_commentLoad:"加载评论",switch_imageSize:"显示图片尺寸",switch_preDownload:"预下载图片",switch_searchUid:"搜索uid",switch_searchPid:"搜索pid",switch_searchAuthor:"搜索作者",switch_searchFavourite:"搜索users入り"},"zh-cn":{},"zh-tw":{author:"作者",background:"背景圖",background_not_found:"無背景圖",copy_to_clipboard:"已複製到剪貼簿",download:"下載",download_wait:"請等待下載完成",illegal:"不合法",illust_type_single:"[單圖]",illust_type_multiple:"[多圖]",illust_type_gif:"[gif圖]",loginWarning:"Pixiv增強 腳本警告! 請登入Pixiv獲得更好的體驗! 未登入可能產生不可預料的bug!",switch_antiAd:"禁用廣告",switch_antiRedirect:"取消重定向",switch_commentLoad:"載入評論",switch_imageSize:"顯示圖片尺寸",switch_preDownload:"預下載圖片",switch_searchUid:"搜尋uid",switch_searchPid:"搜尋pid",switch_searchAuthor:"搜尋作者",switch_searchFavourite:"搜尋users入り"}};e["zh-cn"]=Object.assign({},e.zh);const o=(document.documentElement.getAttribute("lang")||"en").toLowerCase(),i=t=>e[o][t]||`i18n[${o}][${t}] not found`,[n,a]=[console.log,console.error],r={antiAd:{type:"checkbox"},antiRedirect:{type:"checkbox"},commentLoad:{type:"checkbox"},imageSize:{type:"checkbox"},preDownload:{type:"checkbox"},searchUid:{type:"checkbox"},searchPid:{type:"checkbox"},searchAuthor:{type:"checkbox"},searchFavourite:{type:"checkbox"}};let s={};const l=e=>(s&&String(s.userId)===String(e)||t.ajax({url:`/ajax/user/${e}`,dataType:"json",async:!1,success:({body:t})=>{s=t}}),s);let c={};const d=()=>{const e=location.href.match(/artworks\/(\d*)(#\d*)?$/)?.[1]||"";return c&&String(c?.illustId)===String(e)||t.ajax({url:`/ajax/illust/${e}`,dataType:"json",async:!1,success:({body:t})=>{c=t}}),c},p=function(t){const e={callback:()=>{},node:document.body,option:{childList:!0,subtree:!0}};let o;"function"==typeof t?o={...e,callback:t}:(o=Object.assign({},e,t),o.node=o.node||document.body);const i=new(window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver)((t,e)=>{o.callback.call(this,t,e)});try{i.observe(o.node,o.option)}catch(t){throw console.error("MutationObserver 初始化失败:",t),new Error("MutationObserver 初始化失败")}return i},u="download-name",h=()=>/.+artworks\/\d+.*/.test(location.href);(()=>{let e=0;return t.ajax({url:"https://www.pixiv.net/setting_user.php",async:!1}).done((t,o,i)=>e=i.status),200===e})()||alert(i("loginWarning"));const f=e=>{if(!r.imageSize.isEnable())return;const o=Object.assign({$:void 0,position:"relative"},e),i=o.$,n=o.position;let a=i.next("span");a.length<=0&&(a=t(`<span class="ahao-img-size" style="position: ${n}; right: 0; top: 28px;\n                    color: #ffffff; font-size: x-large; font-weight: bold; -webkit-text-stroke: 1.0px #000000;"></span>`),i.before(a));const s=i.prop("tagName").toLowerCase();if("img"===s){const t=new Image;t.src=i.attr("src"),t.onload=function(){a.text(`${this.width}x${this.height}`)}}else if("canvas"===s){const t=i.attr("width")||i.css("width").replace("px","")||i.css("max-width").replace("px","")||0,e=i.attr("height")||i.css("height").replace("px","")||i.css("max-height").replace("px","")||0;a.text(`${t}x${e}`)}else a.text(`${s}暂不支持获取图片大小`)},g=t=>{const e=Object.assign({$shareButtonContainer:void 0,id:"",text:"",clickFun:()=>{}},t),o=e.$shareButtonContainer.clone();return o.addClass("ahao-download-btn").attr("id",e.id).removeClass(e.$shareButtonContainer.attr("class")).css("margin-right","10px").css("position","relative").css("border","1px solid").css("padding","1px 10px").append(`<p style="display: inline">${e.text}</p>`),o.find("button").css("transform","rotate(180deg)").on("click",e.clickFun),e.$shareButtonContainer.after(o),o},m=t=>{const e=d();return(t=(t=(t=t.replace("{pid}",e.illustId)).replace("{uid}",e.userId)).replace("{pname}",e.illustTitle)).replace("{uname}",e.userName)};h()&&(p({callback(e,o){for(const o of e)for(const e of o.addedNodes){let o=t(e).filter('img[src^="https://i.pximg.net/img-master"]');0===o.length&&(o=t(e).find('img[src^="https://i.pximg.net/img-master"]')),o.attr("ahao-done",!0),o.each(function(){const e=t(this),i=e.parent("a").attr("href"),n="gtm-expand-full-size-illust"===o.parent("a").attr("class");(i?.endsWith("jpg")||i?.endsWith("png"))&&(e.attr("src",i).css("filter","none"),e.fitWindow(),f({$:e,position:n?"relative":"absolute"}))})}},option:{attributes:!0,childList:!0,subtree:!0,attributeFilter:["src","href"]}}),d().pageCount>1&&p({callback:e=>{for(const o of e)for(const e of o.addedNodes){const o=t(e).find('div:has(> button[class^="style_transparentButton"]):eq(1)');if(o.length<=0)continue;const n=new JSZip;let a=0;const s=d(),l=s.pageCount,c=s.urls.original,p=Array(parseInt(l)).fill().map((t,e)=>c.replace(/_p\d\./,`_p${e}.`)),h=g({$shareButtonContainer:o,id:"ahao-download-zip",text:`${i("download")}`,clickFun(){if("true"!==t(this).attr("start"))return t(this).attr("start",!0),void t.each(p,(t,e)=>{GM.xmlHttpRequest({method:"GET",url:e,headers:{referer:"https://www.pixiv.net/"},overrideMimeType:"text/plain; charset=x-user-defined",onload({responseText:o}){const r=o,s=new Uint8Array(r.length);let c=0;for(;c<r.length;)s[c]=r.charCodeAt(c),c++;const d=e.split(".").splice(-1),p=new Blob([s],{type:{png:"image/png",jpg:"image/jpeg",gif:"image/gif"}[d]});GM.getValue(u,"{pid}").then(e=>{n.file(`${m(e)}_${t}.${d}`,p,{binary:!0})}),a++,h.find("p").html(`${i("download")}${a}/${l}`)}})});a<l?alert(i("download_wait")):GM.getValue(u,"{pid}").then(t=>{n.generateAsync({type:"blob",base64:!0}).then(e=>saveAs(e,m(t)))})}});r.preDownload.isEnable()&&h.find("button").click()}},option:{attributes:!0,childList:!0,subtree:!0,attributeFilter:["src","href"]}}),2===d().illustType&&p({callback:e=>{for(const o of e)for(const e of o.addedNodes){const o=t(e).find("canvas");o.length>0&&f({$:o});const i=t(e).find('div:has(> button[class^="style_transparentButton"]):eq(1)');if(i.length<=0)continue;const n=g({$shareButtonContainer:i,id:"ahao-download-zip",text:"zip"}),a=g({$shareButtonContainer:i,id:"ahao-download-gif",text:"gif",clickFun(){t.ajax({url:`/ajax/illust/${d().illustId}/ugoira_meta`,dataType:"json",success:({body:e})=>{let o;const i=[],n=new GIF({workers:1,quality:10,workerScript:GIF_worker_URL});for(let o=0,a=e.frames,r=a.length;o<r;o++){const e=a[o],s=d().urls.original.replace("ugoira0.",`ugoira${o}.`);GM.xmlHttpRequest({method:"GET",url:s,headers:{referer:"https://www.pixiv.net/"},overrideMimeType:"text/plain; charset=x-user-defined",onload({responseText:a}){const l=a,c=new Uint8Array(l.length);let p=0;for(;p<l.length;)c[p]=l.charCodeAt(p),p++;const u=s.split(".").splice(-1),h=new Blob([c],{type:{png:"image/png",jpg:"image/jpeg",gif:"image/gif"}[u]}),f=document.createElement("img");f.src=URL.createObjectURL(h),f.width=d().width,f.height=d().height,f.onload=()=>{i[o]={frame:f,option:{delay:e.delay}},Object.keys(i).length>=r&&(t.each(i,(t,e)=>n.addFrame(e.frame,e.option)),n.render())}}})}n.on("progress",t=>{a.find("p").text(`gif ${parseInt(100*t)}%`)}),n.on("finished",e=>{o=URL.createObjectURL(e),GM.getValue(u,"{pid}").then(e=>{const i=t(`<a href="${o}" download="${m(e)}"></a>`);a.find("button").wrap(i)})}),a.find("button").off("click").on("click",()=>{o||alert("Gif未加载完毕, 请稍等片刻!")})}})}});t.ajax({url:`/ajax/illust/${d().illustId}/ugoira_meta`,dataType:"json",success:({body:e})=>{GM.getValue(u,"{pid}").then(o=>{const i=t(`<a href="${e.originalSrc}" download="${m(o)}"></a>`);n.find("button").wrap(i)})}}),r.preDownload.isEnable()&&a.find("button").click()}},option:{attributes:!0,childList:!0,subtree:!0,attributeFilter:["src","href"]}})),/.+\/users\/\d+.*/.test(location.href)&&p({callback:e=>{for(const o of e){const e=location.href.match(/\/users\/(\d+)/)?.[1],n=t(o.target).find(`div:has(> a[href$="/users/${e}/following"])`);if(n.length<=0||n.attr("ahao-done"))continue;n.attr("ahao-done",!0);const a=n.clone();a.children("a").remove();const r=l(e)?.background?.url||"";r&&"none"!==r?a.append(`<img src="${r}" width="30px"><a target="_blank" href="${r}" style="font-size: 20px;font-weight: 700;color: #333;margin-right: 8px;line-height: 1">${i("background")}</a>`):a.append(`<span>${i("background_not_found")}</span>`),n.parent().append(a);const s=n.clone();s.children("a").remove(),s.append(t(`<div style="font-size: 20px;font-weight: 700;color: #333;margin-right: 8px;line-height: 1">UID:${e}</div>`).on("click",function(){const o=t(this);o.html(`<span>UID${i("copy_to_clipboard")}</span>`),GM.setClipboard(e),setTimeout(()=>{o.html(`<span>UID${e}</span>`)},2e3)})),n.parent().append(s)}},option:{childList:!0,subtree:!0}}),h()&&p({callback:e=>{for(const o of e){const e=t(o.target).filter("aside").find("section:first h2");if(e.length<=0||e.attr("ahao-done"))continue;e.attr("ahao-done",!0);const n=e.find("[data-gtm-value]:first").data("gtm-value"),a=l(n)?.background?.url||"",r=e.clone();r.children("a").remove(),r.children("div").children("div").remove(),r.prepend(`<img src="${a}" width="10%"/>`),r.find("div a").attr("href",a||"javascript:void(0)").attr("target","_blank").text(i(a?"background":"background_not_found")),e.after(r);const s=e.clone();s.children("a").remove(),s.children("div").children("div").remove(),s.find("a").attr("href","javascript:void(0)").attr("id","ahao-uid").text(`UID: ${n}`),s.on("click",function(){const e=t(this);e.find("a").text(`UID${i("copy_to_clipboard")}`),GM.setClipboard(n),setTimeout(()=>{e.find("a").text(`UID: ${n}`)},2e3)}),r.after(s)}},option:{childList:!0,subtree:!0}}),{init(){this.checkUrlAndToggleElement(),this.setupObserver()},checkUrlAndToggleElement(){const e=t(".group\\/logo .flex.gap-8.items-center .ml-8.size-\\[50px\\]"),o=["/artworks","novel/show.php","bookmark_new_illust","/users","/tag","/discovery","/dashboard","/manage","/settings"].some(t=>location.href.includes(t));e.toggle(!o)},setupObserver(){p({callback:()=>this.checkUrlAndToggleElement(),node:document.body,option:{childList:!0,subtree:!0}})}}.init();for(const t in r){const e=r[t];"checkbox"===e.type&&(e.isEnable=()=>GM_getValue(t,!0))}GM_registerMenuCommand("控制面板",()=>{const e=t('<div id="myControlPanel" style="position: fixed; top: 20px; left: 20px; background-color: #fff; border: 1px solid #ddd; padding: 15px; z-index: 1000; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1); border-radius: 5px; font-family: sans-serif; display: flex; flex-direction: column; gap: 10px;"></div>');t("body").append(e);for(const o in r)if("checkbox"===r[o].type){const n=GM_getValue(o,!0),a=t('<div style="display: flex; align-items: center; gap: 10px;"></div>'),r=t('<label style="color: #333;"></label>').text(i(`switch_${o}`)),s=t('<input type="checkbox">').prop("checked",n);s.on("change",function(){GM_setValue(o,t(this).prop("checked"))}),a.append(s,r),e.append(a)}const o=t('<button style="padding: 8px 15px; border: none; border-radius: 3px; cursor: pointer; font-size: 1rem; background-color: #007bff; color: white; transition: background-color 0.3s ease; margin-top: 10px;">重置默认值</button>'),n=t('<button style="padding: 8px 15px; border: none; border-radius: 3px; cursor: pointer; font-size: 1rem; background-color: #6c757d; color: white; transition: background-color 0.3s ease;">关闭</button>');e.append(o,n),o.on("click",function(){for(const t in r){const e=r[t];"checkbox"===e.type?GM_setValue(t,e.default||!0):GM_setValue(t,e.default)}alert("所有配置已重置为默认值。"),window.location.reload()}),n.on("click",function(){e.remove(),window.location.reload()})}),r.antiAd.isEnable()&&(()=>{t(".ad").remove(),t("._premium-lead-tag-search-bar").hide(),t(".popular-introduction-overlay").hide(),t(".ad-footer").remove();const e=["iframe","._premium-lead-promotion-banner",'a[href="/premium/lead/lp/?g=anchor&i=popular_works_list&p=popular&page=visitor"]','a[href="/premium/lead/lp/?g=anchor&i=work_detail_remove_ads"]'];p(o=>{for(const i of o)for(const o of i.addedNodes)if(o.nodeType===Node.ELEMENT_NODE)for(const i of e)t(o).find(i).hide()})})(),setTimeout(()=>(()=>{n("搜索增强 初始化");let e=t("form:not([action]) > div.charcoal-text-field-root").parent("form");e.length||(e=t('#js-mount-point-header form:not([action]), #root div[style="position: static; z-index: auto;"] form:not([action])')),e.find("div.charcoal-text-field-root").length>0?e.parent().parent().css({"grid-template-columns":"1fr minmax(0px, 319px) minmax(0px, 319px) minmax(0px, 438px) minmax(0px, 438px) minmax(0px, 219px) 2fr",gap:"10px"}):e.parent().parent().css("grid-template-columns","1fr minmax(0px, 219px) minmax(0px, 219px) minmax(0px, 538px) minmax(0px, 538px) minmax(0px, 219px) 2fr");const o=t=>{const e=Object.assign({$form:null,field:"搜索字段",placeholder:"请输入",template:"***",validNumber:!1},t);e.$form||a(`搜索组件[${e.field}]初始化失败, form元素获取失败`);const o=e.$form.parent().clone(),n=o.find("form");n.children("div").eq(1).remove(),n.attr("class",`ahao-search-${e.field}`),e.$form.parent().before(o);const r=n.find('input[type="text"]:first');r.attr("placeholder",e.placeholder),r.attr("value",""),r.val(""),n.submit(t=>{t.preventDefault();const o=encodeURIComponent(r.val());if(e.validNumber&&!/^[0-9]+$/.test(o)){const t=e.placeholder+i("illegal");return void alert(t)}const n=e.template.replaceAll("***",o);window.open(n),r.val("")})};if(r.searchUid.isEnable()&&o({$form:e,field:"UID",placeholder:"UID",template:"https://www.pixiv.net/users/***",validNumber:!0}),r.searchPid.isEnable()&&o({$form:e,field:"PID",placeholder:"PID",template:"https://www.pixiv.net/artworks/***",validNumber:!0}),r.searchAuthor.isEnable()&&o({$form:e,field:i("author"),placeholder:i("author"),template:"https://www.pixiv.net/search_user.php?nick=***&s_mode=s_usr",validNumber:!1}),r.searchFavourite.isEnable()){const o=e.find('input[type="text"]:first'),i=t('\n                    <select id="select-ahao-favorites">\n                        <option value=""></option>\n                        <option value="50000users入り">50000users入り</option>\n                        <option value="30000users入り">30000users入り</option>\n                        <option value="20000users入り">20000users入り</option>\n                        <option value="10000users入り">10000users入り</option>\n                        <option value="5000users入り" > 5000users入り</option>\n                        <option value="1000users入り" > 1000users入り</option>\n                        <option value="500users入り"  >  500users入り</option>\n                        <option value="300users入り"  >  300users入り</option>\n                        <option value="100users入り"  >  100users入り</option>\n                        <option value="50users入り"   >   50users入り</option>\n                    </select>');i.on("change",()=>{o.val()&&e.submit()}),e.parent().after(i),e.submit(t=>{t.preventDefault(),i.val()&&(o.val((t,e)=>e.split(" ").filter(t=>!!t&&!/users入り$/.test(t)).join(" ")),o.val((t,e)=>`${e} ${i.val()}`));const e=encodeURIComponent(o.val());e&&(/\/tags\/(.*?)\/artworks/.test(location.href)?location.href=location.href.replace(/\/tags\/(.*?)\/artworks/g,`/tags/${e}/artworks`):location.href=`https://www.pixiv.net/tags/${e}/artworks?s_mode=s_tag`)})}})(),1e3),r.commentLoad.isEnable()&&h()&&p({callback:e=>{for(const o of e)for(const e of o.addedNodes)t(e).filter('[class^="CommentList_buttonArea"]').find("div[role='button']").click(),t(o.target).filter('[class^="CommentList_buttonArea"]').find("div[role='button']").click(),t(o.target).find("._28zR1MQ").click()},option:{childList:!0,subtree:!0},node:document.querySelector("main")[0]}),r.antiRedirect.isEnable()&&p({callback:e=>{for(const o of e)for(const e of o.addedNodes){const o='a[href*="jump.php"]';t(e).find(o).each(function(){const e=t(this),o=e.attr("href").match(/jump\.php\?(url=)?(.*)$/)[2];e.attr("href",decodeURIComponent(o))})}}}),/.+\/stacc.+/.test(location.href)&&(n("标记作品 初始化"),p({callback:e=>{for(const o of e)t(o.target).find(".stacc_ref_illust_title").each(function(){const e=t(this).find("a");if(e.attr("ahao-illust-id"))return;const o=new URL(`${location.origin}/${e.attr("href")}`).searchParams.get("illust_id");e.attr("ahao-illust-id",o),t.ajax({url:`/ajax/illust/${o}`,dataType:"json",success:({body:t})=>{const o=parseInt(t.illustType),n=parseInt(t.pageCount)>1;switch(o){case 0:case 1:e.after(`<p>${i(n?"illust_type_multiple":"illust_type_single")}</p>`);break;case 2:e.after(`<p>${i("illust_type_gif")}</p>`)}}})})},option:{childList:!0},node:document.getElementById("stacc_timeline")}))});