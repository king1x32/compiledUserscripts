// ==UserScript==
// @name               IG Helper
// @namespace          https://github.snkms.com/
// @version            3.8.9.1
// @author             SN-Koarashi (5026)
// @match              https://*.instagram.com/*
// @grant              GM_info
// @grant              GM_addStyle
// @grant              GM_setValue
// @grant              GM_getValue
// @grant              GM_xmlhttpRequest
// @grant              GM_registerMenuCommand
// @grant              GM_unregisterMenuCommand
// @grant              GM_getResourceText
// @grant              GM_notification
// @grant              GM_openInTab
// @connect            i.instagram.com
// @connect            raw.githubusercontent.com
// @require            https://code.jquery.com/jquery-3.7.1.min.js#sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=
// @resource           INTERNAL_CSS https://raw.githubusercontent.com/SN-Koarashi/ig-helper/master/style.css
// @resource           LOCALE_MANIFEST https://raw.githubusercontent.com/SN-Koarashi/ig-helper/master/locale/manifest.json
// @supportURL         https://github.com/SN-Koarashi/ig-helper/
// @contributionURL    https://ko-fi.com/snkoarashi
// @icon               https://www.google.com/s2/favicons?domain=www.instagram.com&sz=32
// @compatible         firefox >= 100
// @compatible         chrome >= 100
// @compatible         edge >= 100
// @license            GPL-3.0-only
// @run-at             document-idle
// @downloadURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/IG20Helper.user.js
// @updateURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/IG20Helper.meta.js
// ==/UserScript==
!function(e){"use strict";async function t(i,a){var n=e('body > div section:visible a[href^="/"]').filter(function(){return 1===e(this).attr("href").split("/").filter(e=>e.length>0).length}).first().attr("href").split("/").filter(e=>e.length>0).at(0);if(i){let i=(new Date).getTime(),s=Math.floor(i/1e3),r=location.href.replace(/\/$/gi,"").split("/").at(-1),o=e("body > div section._ac0a header._ac0k > ._ac3r ._ac3n ._ac3p[style]").length||e("body > div section:visible > div > div:not([class]) > div > div div.x1ned7t2.x78zum5 div.x1caxmr6").length||e("body > div div:not([hidden]) section:visible > div div[style]:not([class]) > div").find("div div.x1ned7t2.x78zum5 div.x1caxmr6").length,l=0;if(P(!0),H.GL_dataCache.highlights[r]){C("Fetch from memory cache:",r);let e=H.GL_dataCache.highlights[r].data.reels_media[0].items.length;n=H.GL_dataCache.highlights[r].data.reels_media[0].owner.username,l=H.GL_dataCache.highlights[r].data.reels_media[0].items[e-o]}else{let e=await u(r),t=e.data.reels_media[0].items.length;n=e.data.reels_media[0].owner.username,l=e.data.reels_media[0].items[t-o],H.GL_dataCache.highlights[r]=e}if(C("onHighlightsStory",r,H.GL_dataCache.highlights[r]),k.RENAME_PUBLISH_DATE&&(s=l.taken_at_timestamp),k.CAPTURE_IMAGE_VIA_MEDIA_CACHE){const e=B(l.id);if(e&&!H.GL_dataCache.highlights[r].data.reels_media[0].items.filter(e=>e.id===l.id).at(0).is_video)return C("[Restore Cached onHighlight]",l.id),void(a?U(e):E(e,n,"stories",s,"jpg",l.id))}if(k.FORCE_RESOURCE_VIA_MEDIA&&!H.tempFetchRateLimit){let e=await g(l.id);"ok"===e.status?e.items[0].video_versions?a?U(e.items[0].video_versions[0].url):E(e.items[0].video_versions[0].url,n,"highlights",s,"mp4",e.items[0].id):a?U(e.items[0].image_versions2.candidates[0].url):E(e.items[0].image_versions2.candidates[0].url,n,"highlights",s,"jpg",e.items[0].id):(k.FALLBACK_TO_BLOB_FETCH_IF_MEDIA_API_THROTTLED?(delete H.GL_dataCache.highlights[r],H.tempFetchRateLimit=!0,t(!0,a)):alert("Fetch failed from Media API. API response message: "+e.message),C(e))}else l.is_video?a?U(l.video_resources.at(-1).src):E(l.video_resources.at(-1).src,n,"highlights",s,"mp4",l.id):a?U(l.display_resources.at(-1).src):E(l.display_resources.at(-1).src,n,"highlights",s,"jpg",l.id),H.tempFetchRateLimit=!1;P(!1)}else if(!e(".IG_DWHISTORY").length){let t=null;if(e("body > div section._ac0a").length>0?t=e("body > div section:visible._ac0a"):(t=e("body > div section:visible > div > div[style]:not([class])"),t.css("position","relative")),0===t.length){let i=e("body > div div:not([hidden]) section:visible > div div[class][style] > div[style]:not([class])"),a=0;i.each(function(){e(this).width()>a&&(a=e(this).width(),t=e(this).children("div").first())})}if(null!=t){t.append(`<div data-ih-locale-title="DW" title="${$("DW")}" class="IG_DWHISTORY">${j}</div>`),t.append(`<div data-ih-locale-title="NEW_TAB" title="${$("NEW_TAB")}" class="IG_DWHINEWTAB">${z}</div>`);let i=D(n);i.length>1&&t.append(`<div data-ih-locale-title="DW_ALL" title="${$("DW_ALL")}" class="IG_DWHISTORY_ALL">${q}</div>`);let a=i.parents("div[class]").find("time[datetime]")?.attr("title");null!=a&&i.parents("div[class]").find("time[datetime]").text(a),t.find("img[referrerpolicy]").each(function(){e(this).on("load",function(){e(this).data("remove-thumbnail")||(0===t.find(".IG_DWHISTORY_THUMBNAIL").length?(e(this).attr("data-remove-thumbnail",!0),e(".IG_DWHISTORY_THUMBNAIL").remove(),C("(highlight) Manually removing thumbnail button")):(e(this).attr("data-remove-thumbnail",!0),C("(highlight) Thumbnail button is not present for this picture")))})})}}}async function i(t){if(t){let t=(new Date).getTime(),a=Math.floor(t/1e3),n=location.href.replace(/\/$/gi,"").split("/").at(-1),s="",r=e("body > div section._ac0a header._ac0k > ._ac3r ._ac3n ._ac3p[style]").length||e("body > div section:visible > div > div:not([class]) > div > div div.x1ned7t2.x78zum5 div.x1caxmr6").length||e("body > div div:not([hidden]) section:visible > div div[style]:not([class]) > div").find("div div.x1ned7t2.x78zum5 div.x1caxmr6").length,o="";if(P(!0),H.GL_dataCache.highlights[n]){C("Fetch from memory cache:",n);let e=H.GL_dataCache.highlights[n].data.reels_media[0].items.length;s=H.GL_dataCache.highlights[n].data.reels_media[0].owner.username,o=H.GL_dataCache.highlights[n].data.reels_media[0].items[e-r]}else{let e=await u(n),t=e.data.reels_media[0].items.length;s=e.data.reels_media[0].owner.username,o=e.data.reels_media[0].items[t-r],H.GL_dataCache.highlights[n]=e}if(k.RENAME_PUBLISH_DATE&&(a=o.taken_at_timestamp),k.FORCE_RESOURCE_VIA_MEDIA&&!H.tempFetchRateLimit){let e=await g(o.id);"ok"===e.status?E(e.items[0].image_versions2.candidates[0].url,s,"highlights",a,"jpg",n):(k.FALLBACK_TO_BLOB_FETCH_IF_MEDIA_API_THROTTLED?(delete H.GL_dataCache.highlights[n],H.tempFetchRateLimit=!0,i(!0)):alert("Fetch failed from Media API. API response message: "+e.message),C(e))}else E(o.display_resources.at(-1).src,s,"highlights",a,"jpg",n),H.tempFetchRateLimit=!1;P(!1)}else if(e("body > div section video.xh8yej3").length){if(!e(".IG_DWHISTORY_THUMBNAIL").length){let t=null;if(e("body > div section._ac0a").length>0?t=e("body > div section:visible._ac0a"):(t=e("body > div section:visible > div > div[style]:not([class])"),t.css("position","relative")),0===t.length){let i=e("body > div div:not([hidden]) section:visible > div div[class][style] > div[style]:not([class])"),a=0;i.each(function(){e(this).width()>a&&(a=e(this).width(),t=e(this).children("div").first())})}null!=t&&t.append(`<div data-ih-locale-title="VIDEO_THUMBNAIL" title="${$("VIDEO_THUMBNAIL")}" class="IG_DWHISTORY_THUMBNAIL">${K}</div>`)}}else e(".IG_DWHISTORY_THUMBNAIL").remove()}function a(t,i){if(!0===i&&(C("hasReferrer","regenerated"),e('article[data-snig="canDownload"], div[data-snig="canDownload"]').filter(function(){return 0===e(this).find(".IG_DW_MAIN").length}).removeAttr("data-snig")),0==t){const t=100;let i=0;var a=setInterval(()=>{(i>t||e('article[data-snig="canDownload"], section:visible > main > div > div[data-snig="canDownload"] > div > div > div > hr, div[id^="mount"] > div > div > div.x1n2onr6.x1vjfegm div[data-snig="canDownload"]').length>0)&&(clearInterval(a),i>t&&console.warn("onReadyMyDW() Timer","maximum number of repetitions reached, terminated")),C("onReadyMyDW() Timer","repeating to call detection createDownloadButton()"),s(),i++},50)}else s()}function n(t){k.DISABLE_VIDEO_LOOPING&&t.find("video").each(function(){e(this).on("ended",function(){e(this).data("loop")||(e(this).attr("data-loop",!0),this.pause(),C("(post) Added video event listener #loop"))})}),k.MODIFY_VIDEO_VOLUME&&t.find("video").each(function(){e(this).on("play playing",function(){e(this).data("modify")||(e(this).attr("data-modify",!0),this.volume=H.videoVolume,C("(post) Added video event listener #modify"))})}),k.HTML5_VIDEO_CONTROL&&t.find("video").each(function(){if(!e(this).data("controls")){let t=e(this);C("(post) Added video html5 contorller #modify"),k.MODIFY_VIDEO_VOLUME&&(this.volume=H.videoVolume,e(this).on("loadstart",function(){this.volume=H.videoVolume})),e(this).on("contextmenu",function(e){e.preventDefault(),t.css("z-index","-1"),t.removeAttr("controls")}),e(this).parent().find("video + div > div").first().on("contextmenu",function(e){e.preventDefault(),t.css("z-index","2"),t.attr("controls",!0)}),e(this).on("volumechange",function(){let t=e(this).parent().find("video + div > div").find('button[type="button"], div[role="button"]').filter(function(){return e(this).width()<=64&&e(this).height()<=64&&e(this).find('svg > path[d^="M16.636 7.028a1.5"], svg > path[d^="M1.5 13.3c-.8"]').length>0});var i=0===t.find('svg > path[d^="M16.636"]').length;this.muted!=i&&(this.volume=H.videoVolume,t?.trigger("click")),e(this).attr("data-completed")&&(H.videoVolume=this.volume,GM_setValue("G_VIDEO_VOLUME",this.volume)),this.volume==H.videoVolume&&e(this).attr("data-completed",!0)}),e(this).css("position","absolute"),e(this).css("z-index","2"),e(this).attr("data-controls",!0),e(this).attr("controls",!0)}}),N(t.find("video"),t.find("video + div > div").first(),"post","bottom")}function s(){e("article, section:visible > main > div > div > div > div > div > hr").map(function(){return e(this).is("section:visible > main > div > div > div > div > div > hr")?e(this).parent().parent().parent().parent()[0]:this}).filter(function(){return e(this).height()>0&&e(this).width()>0}).each(function(t){var i,a;if(!e(this).attr("data-snig")&&!e(this).hasClass("x1iyjqo2")&&!e(this).children("article")?.hasClass("x1iyjqo2")&&0===e(this).parents("div#scrollview").length){C("Found post container",e(this));const s=e(this),r=this.tagName,d="._acay ._acaz";if("DIV"===r&&0!=t)return;const c=s.children("div").children("div");if(0===c.length)return;if(C("Found insert point",c),s.find("._acay").length>0){s.find("._acay + .x24i39r").length>0&&s.find("._acay + .x24i39r").css("top","37px");const e=s.find("._acay").first().parent()[0];new MutationObserver(function(){s.find("._acay + .x24i39r").css("top","37px")}).observe(e,{childList:!0})}c.eq("DIV"===r?0:c.length-2).append('<div class="button_wrapper">');const _=`<div data-ih-locale-title="DW" title="${$("DW")}" class="IG_DW_MAIN">${j}</div>`,h=`<div data-ih-locale-title="NEW_TAB" title="${$("NEW_TAB")}" class="IG_NEWTAB_MAIN">${z}</div>`,p=`<div data-ih-locale-title="VIDEO_THUMBNAIL" title="${$("VIDEO_THUMBNAIL")}" class="IG_THUMBNAIL_MAIN">${K}</div>`,u=`<div data-ih-locale-title="IMAGE_VIEWER" title="${$("IMAGE_VIEWER")}" class="IG_IMAGE_VIEWER">${J}</div>`;if(c.find(".button_wrapper").append(_),s.find(d).length>1&&k.DIRECT_DOWNLOAD_VISIBLE_RESOURCE&&!k.DIRECT_DOWNLOAD_ALL){const e=`<div data-ih-locale-title="DW_ALL" title="${$("DW_ALL")}" class="IG_DW_ALL_MAIN">${q}</div>`;c.find(".button_wrapper").append(e)}c.find(".button_wrapper").append(h),setTimeout(()=>{if(0===c.eq("DIV"===r?0:c.length-2).find("div > ul li._acaz").length)c.find("video").length>0?c.find(".button_wrapper").append(p):(i=s.find("img").filter(function(){return e(this).width()>200&&e(this).height()>200}).attr("src"),c.find(".button_wrapper").append(u));else{const t=new IntersectionObserver(t=>{t.forEach(t=>{if(t.isIntersecting){var a=e(t.target);c.find(".IG_THUMBNAIL_MAIN")?.remove(),c.find(".IG_IMAGE_VIEWER")?.remove(),a.find("video").length>0?(0===c.find(".IG_THUMBNAIL_MAIN").length&&c.find(".button_wrapper").append(p),n(s)):(i=a.find("img").attr("src"),c.find(".button_wrapper").append(u))}})},{root:s.find("div > ul._acay").first().parent().parent().parent()[0],rootMargin:"0px",threshold:.1}),a=new MutationObserver(function(i){var a=i.at(0)?.target;e(a).find("li._acaz").each(function(){t.observe(this)})});s.find("div > ul li._acaz").each(function(){t.observe(this)});const o=c.eq("DIV"===r?0:c.length-2).find("div > ul li._acaz")?.parent()[0],l=c.eq("DIV"===r?0:c.length-2).find("div > ul li._acaz")?.parent().parent()[0];o&&a.observe(o,{childList:!0}),l&&a.observe(l,{attributes:!0})}},50),c.css("position","relative"),n(s),H.GL_registerEventList.push({element:this,trigger:[".IG_THUMBNAIL_MAIN",".IG_NEWTAB_MAIN",".IG_DW_ALL_MAIN",".IG_DW_MAIN",".IG_IMAGE_VIEWER"]}),e(this).on("click",".IG_IMAGE_VIEWER",function(){null!=i?function(t){function i(){r.css("transition",P?"none":"transform 0.15s ease"),r.css("transform",`translate(${v}px, ${g}px) scale(${I})`),o.css("transform",`rotate(${m}deg)`),1==I?c.css("cursor","zoom-in"):c.css("cursor","grabbing")}function a(e,t){e.preventDefault();let a=I;if(null==t){let t=.1,i=e.originalEvent.deltaY<0?1:-1;I=Math.min(5,Math.max(1,I+i*t*I))}else I=t;let n=s[0].getBoundingClientRect(),r=e.clientX-n.left,o=e.clientY-n.top;v=-(r-v)/a*I+r,g=-(o-g)/a*I+o,i()}S(),e("body").append(`<div id="imageViewer">\n    \t<div id="iv_header">\n    \t\t<div style="flex:1;">Image Viewer</div>\n    \t\t<div style="display: flex;filter: invert(1);gap: 8px;margin-right: 8px;">\n                <div id="rotate_left" style="cursor: pointer;">${Q}</div>\n                <div id="rotate_right" style="transform: scaleX(-1);cursor: pointer;">${Q}</div>\n            </div>\n    \t\t<div id="iv_close">${X}</div>\n    \t</div>\n        <section>\n            <div id="iv_transform">\n                <div id="iv_rotate">\n                    <img id="iv_image" src="" />\n                </div>\n            </div>\n        </section>\n    </div>`);const n=e("#imageViewer"),s=e("#imageViewer > section"),r=e("#iv_transform"),o=e("#iv_rotate"),l=e("#iv_header"),d=e("#iv_close"),c=e("#iv_image"),_=e("#rotate_left"),h=e("#rotate_right");c.attr("src",t),n.css("display","flex"),r.css("transform-origin","0 0"),r.css("transition","transform 0.15s ease"),o.css("transform-origin","center"),o.css("transition","transform 0.15s ease"),r.css("will-change","transform"),o.css("will-change","transform");let p,u,m=0,I=1,v=0,g=0,f=!1,P=!1;var D={x:0,y:0};V=setInterval(()=>{const e={x:v,y:g};P=e.x!==D.x||e.y!==D.y,D=e},100),c.on("load",()=>{v=0,g=0,i()}),c.on("dragstart drop",e=>{e.preventDefault()}),c.on("click",e=>{e.preventDefault(),e.stopPropagation(),P||(I<=1?a(e,Math.min(Math.max(1,I+1.25),5)):(I=1,v=0,g=0),i())}),s.on("wheel",e=>{e.preventDefault(),a(e)}),n.on("wheel",e=>{e.preventDefault()}),c.on("mousedown",e=>{1!=I&&(f=!0,p=e.pageX-v,u=e.pageY-g,c.css("cursor","grabbing"))}),c.on("mouseup",()=>{1!=I&&(f=!1,c.css("cursor","grab"))}),_.on("click",function(){m-=90,i()}),h.on("click",function(){m+=90,i()}),e(document).on("mousemove.igHelper",e=>{f&&(e.preventDefault(),v=e.pageX-p,g=e.pageY-u,i())}),n.on("click",()=>{S()}),d.on("click",()=>{S()}),l.on("click",e=>{e.preventDefault(),e.stopPropagation()})}(i):alert("Cannot find resource url.")}),e(this).on("click",".IG_THUMBNAIL_MAIN",function(){P(!0),H.GL_username=s.attr("data-username"),H.GL_postPath=location.pathname.replace(/\/$/,"").split("/").at(-1)||s.find('a[href^="/p/"]').first().attr("href").split("/").at(2)||e(this).parent().parent().parent().children("div:last-child").children("div").children("div:last-child").find('a[href^="/p/"]').last().attr("href").split("/").at(2);var t=l(s);G(!0,!1),o(H.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY","").then(()=>{let i=setInterval(()=>{if(e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").length>0){clearInterval(i);var a=e('.IG_POPUP_DIG .IG_POPUP_DIG_BODY a[data-globalindex="'+(t+1)+'"]')?.parent().find(".videoThumbnail")?.first();null!=a&&a.length>0?a.trigger("click"):alert("Cannot find thumbnail URL."),P(!1),e(".IG_POPUP_DIG").remove()}},250)})}),e(this).on("click",".IG_NEWTAB_MAIN",function(){P(!0),H.GL_username=s.attr("data-username"),H.GL_postPath=location.pathname.replace(/\/$/,"").split("/").at(-1)||s.find('a[href^="/p/"]').first().attr("href").split("/").at(2)||e(this).parent().parent().parent().children("div:last-child").children("div").children("div:last-child").find('a[href^="/p/"]').last().attr("href").split("/").at(2);var t=l(s);G(!0,!1),o(H.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY","").then(()=>{let i=setInterval(()=>{var a,n;if(e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").length>0){if(clearInterval(i),a=e('.IG_POPUP_DIG .IG_POPUP_DIG_BODY a[data-globalindex="'+(t+1)+'"]'),k.FORCE_RESOURCE_VIA_MEDIA&&k.NEW_TAB_ALWAYS_FORCE_MEDIA_IN_POST)T(a.first()[0],!0);else{let e=a?.attr("data-href");e?((n=new URL(e)).host="scontent.cdninstagram.com",U(n.href)):alert("Cannot find open tab URL.")}P(!1),e(".IG_POPUP_DIG").remove()}},250)})}),e(this).on("click",".IG_DW_ALL_MAIN",async function(){H.GL_username=s.attr("data-username"),H.GL_postPath=location.pathname.replace(/\/$/,"").split("/").at(-1)||s.find('a[href^="/p/"]').first().attr("href").split("/").at(2)||e(this).parent().parent().parent().children("div:last-child").children("div").children("div:last-child").find('a[href^="/p/"]').last().attr("href").split("/").at(2),G(k.DIRECT_DOWNLOAD_ALL,!0),e("#article-id").html(`<a href="https://www.instagram.com/p/${H.GL_postPath}">${H.GL_postPath}</a>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").each(function(){e(this).wrap("<div></div>"),e(this).before('<label class="inner_box_wrapper"><input class="inner_box" type="checkbox"><span></span></label>'),e(this).after(`<div data-ih-locale-title="NEW_TAB" title="${$("NEW_TAB")}" class="newTab">${z}</div>`),"video"==e(this).attr("data-name")&&e(this).after(`<div data-ih-locale-title="VIDEO_THUMBNAIL" title="${$("VIDEO_THUMBNAIL")}" class="videoThumbnail">${K}</div>`)}),o(H.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY",$("LOAD_BLOB_MULTIPLE")).then(()=>{let t=setInterval(()=>{e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").length>0&&(clearInterval(t),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").each(function(){e(this).trigger("click")}),e(".IG_POPUP_DIG").remove())},250)})}),e(this).on("click",".IG_DW_MAIN",async function(){var t,i,a,n,r;if(H.GL_username=s.attr("data-username"),H.GL_postPath=location.pathname.replace(/\/$/,"").split("/").at(-1)||s.find('a[href^="/p/"]').first().attr("href").split("/").at(2)||e(this).parent().parent().parent().children("div:last-child").children("div").children("div:last-child").find('a[href^="/p/"]').last().attr("href").split("/").at(2),G(k.DIRECT_DOWNLOAD_ALL,!0),e("#article-id").html(`<a href="https://www.instagram.com/p/${H.GL_postPath}">${H.GL_postPath}</a>`),k.DIRECT_DOWNLOAD_VISIBLE_RESOURCE)return P(!0),e(".IG_POPUP_DIG").length&&e(".IG_POPUP_DIG").addClass("hidden"),t=l(e(this).parent().parent().parent()),void o(H.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY","").then(()=>{let i=setInterval(()=>{if(e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").length>0){clearInterval(i);var a=e('.IG_POPUP_DIG .IG_POPUP_DIG_BODY a[data-globalindex="'+(t+1)+'"]')?.attr("data-href");a?(P(!1),e('.IG_POPUP_DIG .IG_POPUP_DIG_BODY a[data-globalindex="'+(t+1)+'"]')?.trigger("click")):alert("Cannot find download URL."),e(".IG_POPUP_DIG").remove()}},250)});if(!k.DIRECT_DOWNLOAD_ALL)if(i=0,a=e(this).parent().parent().find(d).length,n=k.FORCE_FETCH_ALL_RESOURCES,r=new Date(e(this).parent().parent().parent().find("a[href] time[datetime]").filter(function(){let t=e(this).parents("a[href]").attr("href");return t?.startsWith("/p/")||null!=t?.match(/\/([\w.\-_]+)\/p\//gi)}).first().attr("datetime")).getTime(),a)e(this).parent().parent().find(d).each(function(){let t=e(this).parent().parent().parent().find("video");t&&t.attr("src")&&(n=!0)}),n||k.FORCE_RESOURCE_VIA_MEDIA?o(H.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY",$("LOAD_BLOB_MULTIPLE")):(e(this).parent().parent().find(d).each(function(){i++;let t=e(this).find("video"),a=e(this).find("._aagv img"),s=a.attr("srcset")?a.attr("srcset").split(" ")[0]:a.attr("src");t&&t.attr("src")&&(n=!0),a&&s&&e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY").append(`<a datetime="${r}" data-needed="direct" data-path="${H.GL_postPath}" data-name="photo" data-type="jpg" data-globalIndex="${i}" href="javascript:;" data-href="${s}"><img width="100" src="${s}" /><br/>- <span data-ih-locale="IMG">${$("IMG")}</span> ${i} -</a>`)}),n&&o(H.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY",$("LOAD_BLOB_RELOAD")));else if(k.FORCE_RESOURCE_VIA_MEDIA)o(H.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY",$("LOAD_BLOB_MULTIPLE"));else{i++;let t=e(this).parent().parent().parent().find("video"),a=e(this).parent().parent().parent().find("._aagv img"),n=a.attr("srcset")?a.attr("srcset").split(" ")[0]:a.attr("src");t&&t.attr("src")&&o(H.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY",$("LOAD_BLOB_ONE")),a&&n&&e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY").append(`<a datetime="${r}" data-needed="direct" data-path="${H.GL_postPath}" data-name="photo" data-type="jpg" data-globalIndex="${i}" href="javascript:;" href="" data-href="${n}"><img width="100" src="${n}" /><br/>- <span data-ih-locale="IMG">${$("IMG")}</span> ${i} -</a>`)}e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").each(function(){e(this).wrap("<div></div>"),e(this).before('<label class="inner_box_wrapper"><input class="inner_box" type="checkbox"><span></span></label>'),e(this).after(`<div data-ih-locale-title="NEW_TAB" title="${$("NEW_TAB")}" class="newTab">${z}</div>`),"video"==e(this).attr("data-name")&&e(this).after(`<div data-ih-locale-title="VIDEO_THUMBNAIL" title="${$("VIDEO_THUMBNAIL")}" class="videoThumbnail">${K}</div>`)}),k.DIRECT_DOWNLOAD_ALL&&o(H.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY",$("LOAD_BLOB_MULTIPLE")).then(()=>{let t=setInterval(()=>{e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").length>0&&(clearInterval(t),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").each(function(){e(this).trigger("click")}),e(".IG_POPUP_DIG").remove())},250)})}),a=e(this).find("header > div:last-child > div:first-child span a").first().text()||e(this).find('a[href^="/"]').filter(function(){return e(this)?.text()?.length>0}).first().text(),e(this).attr("data-snig","canDownload"),e(this).attr("data-username",a)}})}function r(e){var t=e.shortcode_media??e;return null==t.owner&&null!=t.user&&(t.owner=t.user),null==t.owner&&(C("carousel_media:","undefined username"),alert("carousel_media: undefined username")),t}async function o(t,i,a){try{e(`${i} a`).remove(),e(i).append('<p id="_SNLOAD">'+a+"</p>");let n=await v(t),s=r(n.data);if("query_hash"===n.type){let t=1;if("GraphVideo"==s.__typename&&s.video_url&&(e(i).append(`<a media-id="${s.id}" datetime="${s.taken_at_timestamp}" data-blob="true" data-needed="direct" data-path="${s.shortcode}" data-name="video" data-type="mp4" data-username="${s.owner.username}" data-globalIndex="${t}" href="javascript:;" data-href="${s.video_url}"><img width="100" src="${s.display_resources[1].src}" /><br/>- <span data-ih-locale="VID">${$("VID")}</span> ${t} -</a>`),t++),"GraphImage"==s.__typename&&(e(i).append(`<a media-id="${s.id}" datetime="${s.taken_at_timestamp}" data-blob="true" data-needed="direct" data-path="${s.shortcode}" data-name="photo" data-type="jpg" data-username="${s.owner.username}" data-globalIndex="${t}" href="javascript:;" data-href="${s.display_resources[s.display_resources.length-1].src}"><img width="100" src="${s.display_resources[1].src}" /><br/>- <span data-ih-locale="IMG">${$("IMG")}</span> ${t} -</a>`),t++),"GraphSidecar"==s.__typename&&s.edge_sidecar_to_children)for(let a of s.edge_sidecar_to_children.edges)"GraphVideo"==a.node.__typename&&e(i).append(`<a media-id="${a.node.id}" datetime="${s.taken_at_timestamp}" data-blob="true" data-needed="direct" data-path="${s.shortcode}" data-name="video" data-type="mp4" data-username="${s.owner.username}" data-globalIndex="${t}" href="javascript:;" data-href="${a.node.video_url}"><img width="100" src="${a.node.display_resources[1].src}" /><br/>- <span data-ih-locale-title="VID">${$("VID")}</span> ${t} -</a>`),"GraphImage"==a.node.__typename&&e(i).append(`<a media-id="${a.node.id}" datetime="${s.taken_at_timestamp}" data-blob="true" data-needed="direct" data-path="${s.shortcode}" data-name="photo" data-type="jpg" data-username="${s.owner.username}" data-globalIndex="${t}" href="javascript:;" data-href="${a.node.display_resources[a.node.display_resources.length-1].src}"><img width="100" src="${a.node.display_resources[1].src}" /><br/>- <span data-ih-locale="IMG">${$("IMG")}</span> ${t} -</a>`),t++}else if(s.carousel_media)C("carousel_media"),s.carousel_media.forEach((t,a)=>{let n=a+1;null==t.video_versions?(t.image_versions2.candidates.sort(function(e,t){let i=new URL(e.url).searchParams.get("stp"),a=new URL(t.url).searchParams.get("stp");if(i&&a){if(i.length>a.length)return 1;if(i.length<a.length)return-1}else{if(e.width<t.width)return 1;if(e.width>t.width)return-1}return 0}),e(i).append(`<a media-id="${t.pk}" datetime="${t.taken_at}" data-blob="true" data-needed="direct" data-path="${s.code}" data-name="photo" data-type="jpg" data-username="${s.owner.username}" data-globalIndex="${n}" href="javascript:;" data-href="${t.image_versions2.candidates[0].url}"><img width="100" src="${t.image_versions2.candidates[0].url}" /><br/>- <span data-ih-locale="IMG">${$("IMG")}</span> ${n} -</a>`)):e(i).append(`<a media-id="${t.pk}" datetime="${t.taken_at}" data-blob="true" data-needed="direct" data-path="${s.code}" data-name="video" data-type="mp4" data-username="${s.owner.username}" data-globalIndex="${n}" href="javascript:;" data-href="${t.video_versions[0].url}"><img width="100" src="${t.image_versions2.candidates[0].url}" /><br/>- <span data-ih-locale="VID">${$("VID")}</span> ${n} -</a>`)});else{let t=1;null==s.video_versions?(s.image_versions2.candidates.sort(function(e,t){let i=new URL(e.url).searchParams.get("stp"),a=new URL(t.url).searchParams.get("stp");if(i&&a){if(i.length>a.length)return 1;if(i.length<a.length)return-1}else{if(e.width<t.width)return 1;if(e.width>t.width)return-1}return 0}),e(i).append(`<a media-id="${s.pk}" datetime="${s.taken_at}" data-blob="true" data-needed="direct" data-path="${s.code}" data-name="photo" data-type="jpg" data-username="${s.owner.username}" data-globalIndex="${t}" href="javascript:;" data-href="${s.image_versions2.candidates[0].url}"><img width="100" src="${s.image_versions2.candidates[0].url}" /><br/>- <span data-ih-locale="IMG">${$("IMG")}</span> ${t} -</a>`)):e(i).append(`<a media-id="${s.pk}" datetime="${s.taken_at}" data-blob="true" data-needed="direct" data-path="${s.code}" data-name="video" data-type="mp4" data-username="${s.owner.username}" data-globalIndex="${t}" href="javascript:;" data-href="${s.video_versions[0].url}"><img width="100" src="${s.image_versions2.candidates[0].url}" /><br/>- <span data-ih-locale="VID">${$("VID")}</span> ${t} -</a>`)}e("#_SNLOAD").remove(),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").each(function(){e(this).wrap("<div></div>"),e(this).before('<label class="inner_box_wrapper"><input class="inner_box" type="checkbox"><span></span></label>'),e(this).after(`<div data-ih-locale-title="NEW_TAB" title="${$("NEW_TAB")}" class="newTab">${z}</div>`),"video"==e(this).attr("data-name")&&e(this).after(`<div data-ih-locale-title="VIDEO_THUMBNAIL" title="${$("VIDEO_THUMBNAIL")}" class="videoThumbnail">${K}</div>`)})}catch(e){C("createMediaListDOM",e)}}function l(t){if(!(t.find("button._afxv._al46._al47").length>0))return 0;var i=0;const a=t.find("ul._acay").parent().parent();if(a.length>0){const n=a.get(0).getBoundingClientRect(),s=n.width;if(s>0){const a=n.right;let r=null,o=1/0;if(t.find("li._acaz").each(function(){if(0===this.getBoundingClientRect().width)return;const e=this.getBoundingClientRect(),t=Math.abs(e.right-a);t<o&&(o=t,r=this)}),r){const t=e(r).attr("style");if(t&&t.includes("translateX")){const e=t.match(/translateX\(([^p]+)px\)/);if(e&&e[1]){const t=parseFloat(e[1]);i=Math.round(t/s)}}}}}return i}async function d(t){if(t){P(!0);let e=(new Date).getTime(),t=Math.floor(e/1e3),a=location.pathname.replaceAll(/(reels|tagged)\/$/gi,"").split("/").filter(e=>e.length>0).at(-1),n=await I(a);try{E(await(i=n.user.pk,new Promise((e,t)=>{GM_xmlhttpRequest({method:"GET",url:`https://i.instagram.com/api/v1/users/${i}/info/`,headers:{"User-Agent":"Mozilla/5.0 (Linux; Android 10; Pixel 7 XL)Build/RP1A.20845.002; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/5.0 Chrome/117.0.5938.60 Mobile Safari/537.36 Instagram 307.0.0.34.111"},onload:function(i){try{let a=JSON.parse(i.response);"ok"!==a.status?(C("getUserHighSizeProfile()","reject",a),t("faild")):(C("getUserHighSizeProfile()",a),e(a.user.hd_profile_pic_url_info?.url))}catch(e){C("getUserHighSizeProfile()","reject",e),t(e)}},onerror:function(e){C("getUserHighSizeProfile()","reject",e),t(e)}})})),a,"avatar",t,"jpg")}catch(e){E(n.user.profile_pic_url,a,"avatar",t,"jpg")}P(!1)}else if(!e(".IG_DWPROFILE").length){let t=setInterval(()=>{e(".IG_DWPROFILE").length?clearInterval(t):(e("header > *[class]:first-child > *[class] img[alt][draggable]").parent().parent().append(`<div data-ih-locale-title="DW" title="${$("DW")}" class="IG_DWPROFILE">${j}</div>`),e("header > *[class]:first-child > *[class] img[alt][draggable]").parent().parent().css("position","relative"),e("header > *[class]:first-child > *[class] img[alt]:not([draggable])").parent().parent().parent().append(`<div data-ih-locale-title="DW" title="${$("DW")}" class="IG_DWPROFILE">${j}</div>`),e("header > *[class]:first-child > *[class] img[alt]:not([draggable])").parent().parent().parent().css("position","relative"))},150)}var i}async function c(t,i,a){try{if(t){P(!0);let e=location.href.split("?").at(0).split("instagram.com/reels/").at(-1).replaceAll("/",""),t=await v(e),n=r(t.data),s=(new Date).getTime();if(k.RENAME_PUBLISH_DATE&&(s="query_hash"===t.type?n.taken_at_timestamp:n.taken_at),"query_hash"===t.type)if(i&&n.is_video)if(a)U(n.video_url);else{let t="mp4";E(n.video_url,n.owner.username,"reels",s,t,e)}else if(a)U(n.display_resources.at(-1).src);else{let t="jpg";E(n.display_resources.at(-1).src,n.owner.username,"reels",s,t,e)}else if(i&&null!=n.video_versions)if(a)U(n.video_versions[0].url);else{let t="mp4";E(n.video_versions[0].url,n.owner.username,"reels",s,t,e)}else if(a)U(n.image_versions2.candidates[0].url);else{let t="jpg";E(n.image_versions2.candidates[0].url,n.owner.username,"reels",s,t,e)}P(!1)}else var n=setInterval(()=>{e('section > main[role="main"] > div div.x1qjc9v5 video').length>0&&(clearInterval(n),k.SCROLL_BUTTON&&(e("#scrollWrapper").remove(),e('section > main[role="main"]').append('<section id="scrollWrapper"></section>'),e('section > main[role="main"] > #scrollWrapper').append('<div class="button-up"><div></div></div>'),e('section > main[role="main"] > #scrollWrapper').append('<div class="button-down"><div></div></div>'),e('section > main[role="main"] > #scrollWrapper > .button-up').on("click",function(){e('section > main[role="main"] > div')[0].scrollBy({top:-30,behavior:"smooth"})}),e('section > main[role="main"] > #scrollWrapper > .button-down').on("click",function(){e('section > main[role="main"] > div')[0].scrollBy({top:30,behavior:"smooth"})})),e('section > main[role="main"] > div[tabindex], section > main[role="main"] > div[class]').children("div").each(function(){var t;e(this).children().length>0&&(e(this).children().find(".IG_REELS").length||(t=e(this),e(this).children().css("position","relative"),e(this).children().append(`<div data-ih-locale-title="DW" title="${$("DW")}" class="IG_REELS">${j}</div>`),e(this).children().append(`<div data-ih-locale-title="NEW_TAB" title="${$("NEW_TAB")}" class="IG_REELS_NEWTAB">${z}</div>`),e(this).children().append(`<div data-ih-locale-title="VIDEO_THUMBNAIL" title="${$("VIDEO_THUMBNAIL")}" class="IG_REELS_THUMBNAIL">${K}</div>`),k.DISABLE_VIDEO_LOOPING&&e(this).find("video").each(function(){e(this).on("ended",function(){if(!e(this).data("loop")){let t=e(this).next().find('div[role="presentation"] > div svg > path[d^="M5.888"]').parents('button[role="button"], div[role="button"]');t.length>0?(e(this).attr("data-loop",!0),t.trigger("click"),C("Adding video event listener #loop, then paused click()")):(e(this).attr("data-loop",!0),e(this).parent().find(".xpgaw4o").removeAttr("style"),this.pause(),C("Adding video event listener #loop, then paused pause()"))}})}),k.HTML5_VIDEO_CONTROL&&e(this).find("video").each(function(){if(!e(this).data("controls")){let t=e(this);C("(reel) Added video html5 contorller #modify"),k.MODIFY_VIDEO_VOLUME&&(this.volume=H.videoVolume,e(this).on("loadstart",function(){this.volume=H.videoVolume})),e(this).on("contextmenu",function(e){e.preventDefault(),t.css("z-index","-1"),t.removeAttr("controls")}),e(this).parent().find('video + div div[role="button"]').filter(function(){return e(this).parent('div[role="presentation"]').length>0&&"pointer"===e(this).css("cursor")&&null!=e(this).attr("style")}).first().on("contextmenu",function(e){e.preventDefault(),t.css("z-index","2"),t.attr("controls",!0)}),e(this).on("volumechange",function(){let t=e(this).parent().find("video + div > div").find('button[type="button"], div[role="button"]').filter(function(){return e(this).width()<=64&&e(this).height()<=64&&e(this).find('svg > path[d^="M16.636 7.028a1.5"], svg > path[d^="M1.5 13.3c-.8"]').length>0});var i=0===t.find('svg > path[d^="M16.636"]').length;this.muted!=i&&(this.volume=H.videoVolume,t?.trigger("click")),e(this).attr("data-completed")&&(H.videoVolume=this.volume,GM_setValue("G_VIDEO_VOLUME",this.volume)),this.volume==H.videoVolume&&e(this).attr("data-completed",!0)}),e(this).css("position","relative"),e(this).css("z-index","2"),e(this).attr("data-controls",!0),e(this).attr("controls",!0)}}),N(t.find("video"),e(this).find('div[role="presentation"] > div[role="button"] > div').first(),"reel")))}))},250)}catch(e){console.error("[reels]",e)}}async function _(t,i){try{e(".IG_POPUP_DIG #post_info").text(`${i} ID: ${t.data.reels_media[0].id}`);const a=".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY";t.data.reels_media[0].items.forEach((n,s)=>{let r=(new Date).getTime(),o=Math.floor(r/1e3),l=t.data.reels_media[0]?.user?.username||t.data.reels_media[0]?.owner?.username;k.RENAME_PUBLISH_DATE&&(o=n.taken_at_timestamp),n.display_resources.sort(function(e,t){return e.config_width<t.config_width?1:e.config_width>t.config_width?-1:0}),n.is_video?e(a).append(`<a media-id="${n.id}" datetime="${o}" data-blob="true" data-needed="direct" data-name="${i}" data-type="mp4" data-username="${l}" data-path="${n.id}" data-globalIndex="${s+1}" href="javascript:;" data-href="${n.video_resources[0].src}"><img width="100" src="${n.display_resources[0].src}" /><br/>- <span data-ih-locale-title="VID">${$("VID")}</span> ${s} -</a>`):e(a).append(`<a media-id="${n.id}" datetime="${o}" data-blob="true" data-needed="direct" data-name="${i}" data-type="jpg" data-username="${l}" data-path="${n.id}" data-globalIndex="${s+1}" href="javascript:;" data-href="${n.display_resources[0].src}"><img width="100" src="${n.display_resources[0].src}" /><br/>- <span data-ih-locale-title="IMG">${$("IMG")}</span> ${s} -</a>`)}),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").each(function(){e(this).wrap("<div></div>"),e(this).before('<label class="inner_box_wrapper"><input class="inner_box" type="checkbox"><span></span></label>'),e(this).after(`<div data-ih-locale-title="NEW_TAB" title="${$("NEW_TAB")}" class="newTab">${z}</div>`),"mp4"==e(this).attr("data-type")&&e(this).after(`<div data-ih-locale-title="VIDEO_THUMBNAIL" title="${$("VIDEO_THUMBNAIL")}" class="videoThumbnail">${K}</div>`)}),P(!1)}catch(e){console.error("createStoryListDOM()",e)}}async function h(t,i,a){var n=e("body > div section._ac0a header._ac0k ._ac0l a + div a").first().text()||location.pathname.split("/").filter(e=>e.length>0).at(1);if(t){let s=(new Date).getTime(),r=Math.floor(s/1e3);if(P(!0),k.FORCE_RESOURCE_VIA_MEDIA&&!H.tempFetchRateLimit){let s=null,o=(await I(n)).user.pk,l=await m(o),d=location.pathname.split("/").filter(e=>e.length>0&&e.match(/^([0-9]{10,})$/)).at(-1);if(l.data.reels_media[0].items.forEach(e=>{e.id==d&&(s=e.id)}),null==s&&D(n).each(function(t){e(this).children().length>0&&(s=l.data.reels_media[0].items[t].id)}),null==s&&(e("body > div section:visible div.x1ned7t2.x78zum5 > div").each(function(t){e(this).hasClass("x1lix1fw")&&e(this).children().length>0&&(s=l.data.reels_media[0].items[t].id)}),e("body > div section:visible ._ac0k > ._ac3r > div").each(function(t){e(this).children().hasClass("_ac3q")&&(s=l.data.reels_media[0].items[t].id)})),null==s&&(s=location.pathname.split("/").filter(e=>e.length>0&&e.match(/^([0-9]{10,})$/)).at(-1)),k.CAPTURE_IMAGE_VIA_MEDIA_CACHE){const e=B(s);if(e&&!l.data.reels_media[0].items.filter(e=>e.id===s).at(0).is_video)return C("[Restore Cached onStory]",s),void(a?U(e):E(e,n,"stories",r,"jpg",s))}let c=await g(s);return k.RENAME_PUBLISH_DATE&&(r=c.items[0].taken_at),"ok"===c.status?c.items[0].video_versions?a?U(c.items[0].video_versions[0].url):E(c.items[0].video_versions[0].url,n,"stories",r,"mp4",s):a?U(c.items[0].image_versions2.candidates[0].url):E(c.items[0].image_versions2.candidates[0].url,n,"stories",r,"jpg",s):(k.FALLBACK_TO_BLOB_FETCH_IF_MEDIA_API_THROTTLED?(H.tempFetchRateLimit=!0,h(t,i,a)):alert("Fetch failed from Media API. API response message: "+c.message),C(c)),void P(!1)}if(e("body > div section:visible video[playsinline]").length>0){let t="mp4",s="",o=location.pathname.replace(/\/$/gi,"").split("/").at(-1),l=null;if(H.GL_dataCache.stories[n]&&!i){if(C("Fetch from memory cache:",n),H.GL_dataCache.stories[n].data.reels_media[0].items.forEach(e=>{e.id==o&&(s=e.video_resources[0].src,k.RENAME_PUBLISH_DATE&&(r=e.taken_at_timestamp,l=e.id))}),0==s.length)return C("Memory cache not found, try fetch from API:",n),void h(!0,!0)}else{let t=(await I(n)).user.pk,i=await m(t);i.data.reels_media[0].items.forEach(e=>{e.id==o&&(s=e.video_resources[0].src,k.RENAME_PUBLISH_DATE&&(r=e.taken_at_timestamp,l=e.id))}),0==s.length&&(D(n).each(function(t){e(this).children().length>0&&(s=i.data.reels_media[0].items[t].video_resources[0].src,k.RENAME_PUBLISH_DATE&&(r=i.data.reels_media[0].items[t].taken_at_timestamp,l=i.data.reels_media[0].items[t].id))}),0==s.length&&(e("body > div section:visible div.x1ned7t2.x78zum5 > div").each(function(t){e(this).hasClass("x1lix1fw")&&e(this).children().length>0&&(s=i.data.reels_media[0].items[t].video_resources[0].src,k.RENAME_PUBLISH_DATE&&(r=i.data.reels_media[0].items[t].taken_at_timestamp,l=i.data.reels_media[0].items[t].id))}),e("body > div section:visible ._ac0k > ._ac3r > div").each(function(t){e(this).children().hasClass("_ac3q")&&(s=i.data.reels_media[0].items[t].video_resources[0].src,k.RENAME_PUBLISH_DATE&&(r=i.data.reels_media[0].items[t].taken_at_timestamp,l=i.data.reels_media[0].items[t].id))}))),H.GL_dataCache.stories[n]=i}0==s.length?alert($("NO_VID_URL")):a?U(s):E(s,n,"stories",r,t,l)}else{let t=e("body > div section:visible img[referrerpolicy][class], body > div section:visible img[crossorigin][class]:not([alt])").attr("srcset")?.split(",")[0]?.split(" ")[0],i=t||e("body > div section:visible img[referrerpolicy][class], body > div section:visible img[crossorigin][class]:not([alt])").filter(function(){return 0===e(this).parents("a").length&&e(this).width()===e(this).parent().width()}).attr("src");if(!i){let t=e("body > div section:visible img._aa63");i=t.attr("srcset")?t.attr("srcset")?.split(",")[0]?.split(" ")[0]:t.attr("src")}k.RENAME_PUBLISH_DATE&&(r=new Date(e("body > div section:visible time[datetime][class]").first().attr("datetime")).getTime());let s=i,o="jpg";const l=B(function(e){let t=new URL(e),i=t?.searchParams?.get("ig_cache_key")?.split(".").at(0);return i?atob(i):null}(s)??"-");if(k.CAPTURE_IMAGE_VIA_MEDIA_CACHE){const e=B(l);if(e)return void(a?U(e):E(e,n,"stories",r,"jpg",l))}a?U(s):E(s,n,"stories",r,o,l)}H.tempFetchRateLimit=!1,P(!1)}else if(!e(".IG_DWSTORY").length){H.GL_dataCache.stories={};let t=null;if(e("body > div section._ac0a").length>0?t=e("body > div section:visible._ac0a"):(t=e("body > div section:visible > div > div[style]:not([class])"),t.css("position","relative")),0===t.length&&(t=e('div[id^="mount"] section > div > a[href="/"]').parent().parent().parent().find("section:visible > div > div[style]:not([class])"),t.css("position","relative")),0===t.length&&(t=e('div[id^="mount"] section > div > a[href="/"]').parent().parent().parent().find('section:visible > div div[style]:not([class]) > div:not([data-visualcompletion="loading-state"])'),t.css("position","relative")),0===t.length){let i=e("body > div div:not([hidden]) section:visible > div div[class][style] > div[style]:not([class])"),a=0;i.each(function(){e(this).width()>a&&(a=e(this).width(),t=e(this).children("div").first())})}null!=t&&(t.first().css("position","relative"),t.first().append(`<div data-ih-locale-title="DW" title="${$("DW")}" class="IG_DWSTORY">${j}</div>`),t.first().append(`<div data-ih-locale-title="NEW_TAB" title="${$("NEW_TAB")}" class="IG_DWNEWTAB">${z}</div>`),D(n).length>1&&t.first().append(`<div data-ih-locale-title="DW_ALL" title="${$("DW_ALL")}" class="IG_DWSTORY_ALL">${q}</div>`),t.find("img[referrerpolicy]").each(function(){e(this).on("load",function(){e(this).data("remove-thumbnail")||(0===t.find(".IG_DWSTORY_THUMBNAIL").length?(e(this).attr("data-remove-thumbnail",!0),e(".IG_DWSTORY_THUMBNAIL").remove(),C("(story) Manually removing thumbnail button")):(e(this).attr("data-remove-thumbnail",!0),C("(story) Thumbnail button is not present for this picture")))})}))}}async function p(t,i){if(t){let t=(new Date).getTime(),a=Math.floor(t/1e3),n="jpg",s=e("body > div section._ac0a header._ac0k ._ac0l a + div a").first().text()||location.pathname.split("/").at(2),r=location.pathname.replace(/\/$/gi,"").split("/").at(-1),o="",l=null;if(P(!0),k.FORCE_RESOURCE_VIA_MEDIA&&!H.tempFetchRateLimit){let t=(await I(s)).user.pk,n=await m(t),r=location.pathname.split("/").filter(e=>e.length>0&&e.match(/^([0-9]{10,})$/)).at(-1);n.data.reels_media[0].items.forEach(e=>{e.id==r&&(l=e.id)}),null==l&&D(s).each(function(t){e(this).children().length>0&&(l=n.data.reels_media[0].items[t].id)}),null==l&&(e("body > div section:visible div.x1ned7t2.x78zum5 > div").each(function(t){e(this).hasClass("x1lix1fw")&&e(this).children().length>0&&(l=n.data.reels_media[0].items[t].id)}),e("body > div section:visible ._ac0k > ._ac3r > div").each(function(t){e(this).children().hasClass("_ac3q")&&(l=n.data.reels_media[0].items[t].id)})),null==l&&(l=location.pathname.split("/").filter(e=>e.length>0&&e.match(/^([0-9]{10,})$/)).at(-1));let o=await g(l);return k.RENAME_PUBLISH_DATE&&(a=o.items[0].taken_at),"ok"===o.status?E(o.items[0].image_versions2.candidates[0].url,s,"stories",a,"jpg",l):(k.FALLBACK_TO_BLOB_FETCH_IF_MEDIA_API_THROTTLED?(H.tempFetchRateLimit=!0,p(!0,i)):alert("Fetch failed from Media API. API response message: "+o.message),C(o)),void P(!1)}if(H.GL_dataCache.stories[s]&&!i){if(C("Fetch from memory cache:",s),H.GL_dataCache.stories[s].data.reels_media[0].items.forEach(e=>{e.id==r&&(o=e.display_url,k.RENAME_PUBLISH_DATE&&(a=e.taken_at_timestamp,l=e.id))}),0==o.length)return C("Memory cache not found, try fetch from API:",s),void p(!0,!0)}else{let t=(await I(s)).user.pk,i=await m(t);i.data.reels_media[0].items.forEach(e=>{e.id==r&&(o=e.display_url,k.RENAME_PUBLISH_DATE&&(a=e.taken_at_timestamp,l=e.id))}),0==o.length&&(D(s).each(function(t){e(this).children().length>0&&(o=i.data.reels_media[0].items[t].display_url,k.RENAME_PUBLISH_DATE&&(a=i.data.reels_media[0].items[t].taken_at_timestamp,l=i.data.reels_media[0].items[t].id))}),0==o.length&&(e("body > div section:visible div.x1ned7t2.x78zum5 > div").each(function(t){e(this).hasClass("x1lix1fw")&&e(this).children().length>0&&(o=i.data.reels_media[0].items[t].display_url,k.RENAME_PUBLISH_DATE&&(a=i.data.reels_media[0].items[t].taken_at_timestamp,l=i.data.reels_media[0].items[t].id))}),e("body > div section:visible ._ac0k > ._ac3r > div").each(function(t){e(this).children().hasClass("_ac3q")&&(o=i.data.reels_media[0].items[t].display_url,k.RENAME_PUBLISH_DATE&&(a=i.data.reels_media[0].items[t].taken_at_timestamp,l=i.data.reels_media[0].items[t].id))})))}E(o,s,"thumbnail",a,n,l),H.tempFetchRateLimit=!1,P(!1)}else if(e("body > div div.IG_DWSTORY").parent().find("video[class]").length){let t=null;if(e("body > div section._ac0a").length>0?t=e("body > div section:visible._ac0a"):(t=e("body > div section:visible > div > div[style]:not([class])"),t.css("position","relative")),0===t.length&&(t=e('div[id^="mount"] section > div > a[href="/"]').parent().parent().parent().find("section:visible > div > div[style]:not([class])"),t.css("position","relative")),0===t.length&&(t=e('div[id^="mount"] section > div > a[href="/"]').parent().parent().parent().find('section:visible > div div[style]:not([class]) > div:not([data-visualcompletion="loading-state"])'),t.css("position","relative")),0===t.length){let i=e("body > div div:not([hidden]) section:visible > div div[class][style] > div[style]:not([class])"),a=0;i.each(function(){e(this).width()>a&&(a=e(this).width(),t=e(this).children("div").first())})}null!=t&&(t.first().css("position","relative"),t.first().append(`<div data-ih-locale-title="VIDEO_THUMBNAIL" title="${$("VIDEO_THUMBNAIL")}" class="IG_DWSTORY_THUMBNAIL">${K}</div>`))}}function u(e){return new Promise((t,i)=>{GM_xmlhttpRequest({method:"GET",url:`https://www.instagram.com/graphql/query/?query_hash=45246d3fe16ccc6577e0bd297a5db1ab&variables=%7B%22highlight_reel_ids%22:%5B%22${e}%22%5D,%22precomposed_overlay%22:false%7D`,onload:function(e){try{let i=JSON.parse(e.response);t(i)}catch(e){C("getHighlightStories()","reject",e.message),i(e)}},onerror:function(e){C("getHighlightStories()","reject",e),i(e)}})})}function m(e){return new Promise((t,i)=>{GM_xmlhttpRequest({method:"GET",url:`https://www.instagram.com/graphql/query/?query_hash=15463e8449a83d3d60b06be7e90627c7&variables=%7B%22reel_ids%22:%5B%22${e}%22%5D,%22precomposed_overlay%22:false%7D`,onload:function(e){try{let i=JSON.parse(e.response);C("getStories()",i),t(i)}catch(e){C("getStories()","reject",e.message),i(e)}},onerror:function(e){C("getStories()","reject",e),i(e)}})})}function I(e){return new Promise((t,i)=>{GM_xmlhttpRequest({method:"GET",url:`https://www.instagram.com/web/search/topsearch/?query=${e}`,onload:function(i){let a=JSON.parse(i.response),n=null;a.users.forEach(t=>{t.user.username?.toLowerCase()===e?.toLowerCase()&&(n=t)}),null!=n?(C("getUserId()",n),t(n)):function(e){return new Promise((t,i)=>{GM_xmlhttpRequest({method:"GET",url:`https://i.instagram.com/api/v1/users/web_profile_info/?username=${e}`,headers:{"X-IG-App-ID":f()},onload:function(e){try{let a=JSON.parse(e.response),n=a?.data?.user;if(null!=n){let e=a?.data;e.user.pk=e.user.id,C("getUserIdWithAgent()",a),t(e)}else C("getUserIdWithAgent()","reject","undefined"),i("undefined")}catch(e){C("getUserIdWithAgent()","reject",e.message),i(e)}},onerror:function(e){C("getUserIdWithAgent()","reject",e),i(e)}})})}(e).then(e=>{t(e)}).catch(()=>{alert("Cannot find user info from getUserId()")})},onerror:function(e){C("getUserId()","reject",e),i(e)}})})}function v(e){return new Promise((t,i)=>{e||i("NOPATH");let a=e;GM_xmlhttpRequest({method:"GET",url:`https://www.instagram.com/graphql/query/?query_hash=2c4c2e343a8f64c625ba02b2aa12c7f8&variables=%7B%22shortcode%22:%22${a}%22}`,headers:{"User-Agent":"Mozilla/5.0 (Linux; Android 10; Pixel 7 XL)Build/RP1A.20845.002; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/5.0 Chrome/117.0.5938.60 Mobile Safari/537.36 Instagram 307.0.0.34.111"},onload:function(e){try{let n=JSON.parse(e.response);C(n),"fail"===n.status?(C("Request with:","getBlobMediaWithQuery()",a),function(e){return new Promise((t,i)=>{e||i("NOPATH"),GM_xmlhttpRequest({method:"GET",url:`https://www.instagram.com/graphql/query/?query_id=9496392173716084&variables={%22shortcode%22:%22${e}%22,%22__relay_internal__pv__PolarisFeedShareMenurelayprovider%22:true,%22__relay_internal__pv__PolarisIsLoggedInrelayprovider%22:true}`,headers:{"User-Agent":"Mozilla/5.0 (Linux; Android 10; Pixel 7 XL)Build/RP1A.20845.002; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/5.0 Chrome/117.0.5938.60 Mobile Safari/537.36 Instagram 307.0.0.34.111","X-IG-App-ID":f()},onload:function(e){try{let a=JSON.parse(e.response);C(a),"fail"===a.status?(alert(`getBlobMediaWithQueryID(): Request failed with API response:\n${a.message}: ${a.feedback_message}`),C(`Request failed with API response ${a.message}: ${a.feedback_message}`),i(e)):(C("getBlobMediaWithQueryID()",a.data),t(a.data))}catch(e){C("getBlobMediaWithQueryID()","reject",e.message),i(e)}},onerror:function(e){C("getBlobMediaWithQueryID()","reject",e),i(e)}})})}(a).then(e=>{t({type:"query_id",data:e.xdt_api__v1__media__shortcode__web_info.items[0]})}).catch(e=>{i(e)})):t({type:"query_hash",data:n.data})}catch(e){C("getBlobMedia()","reject",e.message),i(e)}},onerror:function(e){C("getBlobMedia()","reject",e),i(e)}})})}function g(e){return new Promise((t,i)=>{let a=`https://i.instagram.com/api/v1/media/${e}/info/`;return null==e?(alert("Cannot call Media API because of the media id is invalid."),C("getMediaInfo()","reject","Cannot call Media API because of the media id is invalid."),P(!1),void i(-1)):null==f()?(alert("Cannot call Media API because of the app id is invalid."),C("getMediaInfo()","reject","Cannot call Media API because of the app id is invalid."),P(!1),void i(-1)):void GM_xmlhttpRequest({method:"GET",url:a,headers:{"User-Agent":window.navigator.userAgent,Accept:"*/*","X-IG-App-ID":f()},onload:function(e){if(e.finalUrl==a){let i=JSON.parse(e.response);C("getMediaInfo()",i),t(i)}else new URL(e.finalUrl).pathname.startsWith("/accounts/login")?(C("getMediaInfo()","reject","The account must be logged in to access Media API."),alert("The account must be logged in to access Media API.")):(C("getMediaInfo()","reject",'Unable to retrieve content because the API was redirected to "'+e.finalUrl+'"'),alert('Unable to retrieve content because the API was redirected to "'+e.finalUrl+'"')),P(!1),i(-1)},onerror:function(e){C("getMediaInfo()","reject",e),t(e)}})})}function f(){let t=null;return e('script[type="application/json"]').each(function(){const i=/"APP_ID":"([0-9]+)"/gi;null!=e(this).text().match(i)&&null==t&&(t=[...e(this).text().matchAll(i)])}),t?t.at(0).at(-1):null}function P(t){t?(e('div[id^="mount"] > div > div > div:first').removeClass("x1s85apg"),e('div[id^="mount"] > div > div > div:first').css("z-index","20000")):(e('div[id^="mount"] > div > div > div:first').addClass("x1s85apg"),e('div[id^="mount"] > div > div > div:first').css("z-index",""))}function D(t){let i=e('body > div section:visible a[href^="/'+t+'"] span').filter(function(){return 0===e(this).children().length&&0===e(this).find("svg").length&&e(this).text()?.toLowerCase()===t?.toLowerCase()}).parents("div:not([class]):not([style])").filter(function(){return e(this).text()?.toLowerCase()!==t?.toLowerCase()}).filter(function(){return e(this).children().length>1}).first();return 0===i.length&&(i=e('body > div section:visible a[href^="/'+t+'"]').filter(function(){return e(this).find("img").length>0}).parents("div:not([class]):not([style])").filter(function(){return e(this).text()?.toLowerCase()!==t?.toLowerCase()}).filter(function(){return e(this).children().length>1}).first()),i.children().filter(function(){return e(this).height()<10}).first().children()}function O(t,i){e(".circle_wrapper").length?(e(".circle_wrapper span").text(`${t}/${i}`),t>=i&&e(".circle_wrapper").fadeOut(250,function(){e(this).remove()})):e("body").append(`<div class="circle_wrapper"><circle></circle><span>${t}/${i}</span></div>`)}function G(t,i){let a=t?"hidden":"";e("body").append('<div class="IG_POPUP_DIG '+a+'"><div class="IG_POPUP_DIG_BG"></div><div class="IG_POPUP_DIG_MAIN"><div class="IG_POPUP_DIG_TITLE"></div><div class="IG_POPUP_DIG_BODY"></div></div></div>'),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_TITLE").append(`<div style="position:relative;min-height:36px;text-align:center;margin-bottom: 7px;"><div style="position:absolute;left:0px;line-height: 18px;"><kbd>Alt</kbd>+<kbd>Q</kbd> [<span data-ih-locale="CLOSE">${$("CLOSE")}</span>]</div><div style="line-height: 18px;">IG Helper v${GM_info.script.version}</div><div id="post_info" style="line-height: 14px;font-size:14px;">Post ID: <span id="article-id"></span></div><div class="IG_POPUP_DIG_BTN">${X}</div></div>`),i&&(e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_TITLE").append('<div style="text-align: center;" id="button_group"></div>'),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_TITLE > div#button_group").append(`<button id="batch_download_selected" data-ih-locale="BATCH_DOWNLOAD_SELECTED">${$("BATCH_DOWNLOAD_SELECTED")}</button>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_TITLE > div#button_group").append(`<button id="batch_download_direct" data-ih-locale="BATCH_DOWNLOAD_DIRECT">${$("BATCH_DOWNLOAD_DIRECT")}</button>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_TITLE").append(`<label class="checkbox"><input value="yes" type="checkbox" /><span data-ih-locale="ALL_CHECK">${$("ALL_CHECK")}</span></label>`))}function E(e,t,i,a,n,s){return new Promise(r=>{setTimeout(()=>{P(!0),fetch(e).then(o=>o.blob().then(o=>{P(!1),function(e,t,i,a,n,s,r){n=parseInt(n.toString().padEnd(13,"0")),k.RENAME_PUBLISH_DATE&&(n=parseInt(n.toString().padEnd(13,"0")));const o=new Date(n),l=new URL(e).pathname.split("/").at(-1).split(".").slice(0,-1).join("."),d=o.getFullYear().toString(),c=(o.getMonth()+1).toString().padStart(2,"0"),_=o.getDate().toString().padStart(2,"0"),h=o.getHours().toString().padStart(2,"0"),p=o.getMinutes().toString().padStart(2,"0"),u=o.getSeconds().toString().padStart(2,"0");var m=H.fileRenameFormat.toUpperCase(),I={"%USERNAME%":i,"%SOURCE_TYPE%":a,"%SHORTCODE%":r??"","%YEAR%":d,"%2-YEAR%":d.substr(-2),"%MONTH%":c,"%DAY%":_,"%HOUR%":h,"%MINUTE%":p,"%SECOND%":u,"%ORIGINAL_NAME%":l,"%ORIGINAL_NAME_FIRST%":l.split("_").at(0)};m=m.replace(/%[\w\-]+%/g,function(e){return I[e]||e});const v=i+"_"+l+"."+s,g=k.AUTO_RENAME?m+"."+s:v;k.MODIFY_RESOURCE_EXIF&&"jpg"===s&&r&&"photo"===a&&("image/jpeg"===t.type||"image/webp"===t.type)?async function(e,t){const i=(...e)=>{const t=e.reduce((e,t)=>e+t.length,0),i=new Uint8Array(t);let a=0;for(const t of e)i.set(t,a),a+=t.length;return i},a=e=>{const t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,e,!0),t},n=e=>(new TextEncoder).encode(e),s=(e,t)=>String.fromCharCode(e.getUint8(t),e.getUint8(t+1),e.getUint8(t+2),e.getUint8(t+3)),r=new Uint8Array(await e.slice(0,12).arrayBuffer()),o=255===r[0]&&216===r[1],l=r.length>=12&&"RIFF"===String.fromCharCode(...r.subarray(0,4))&&"WEBP"===String.fromCharCode(...r.subarray(8,12));if(!o&&!l)throw new Error("Not a JPEG or WEBP");const d=n(`https://www.instagram.com/p/${t}/\0`),c=n("Exif\0\0"),_=Uint8Array.from([73,73,42,0,8,0,0,0]),h=Uint8Array.from([1,0]),p=i(Uint8Array.from([14,1,2,0]),a(d.length),a(26)),u=i(_,h,p,a(0),d);if(o){const t=await e.arrayBuffer(),a=new DataView(t),n=i(c,u),s=new Uint8Array(4);new DataView(s.buffer).setUint16(0,65505),new DataView(s.buffer).setUint16(2,n.length+2);const r=i(s,n),o=[new Uint8Array(t,0,2)];let l=2,d=!1;for(;l<a.byteLength;){const e=a.getUint16(l);if(65280&~e)break;if(65498===e){d||o.push(r),o.push(new Uint8Array(t,l));break}const i=a.getUint16(l+2)+2;65505!==e?(o.push(new Uint8Array(t,l,i)),l+=i):l+=i}const _=o.reduce((e,t)=>e+t.length,0),h=new Uint8Array(_);let p=0;return o.forEach(e=>{h.set(e,p),p+=e.length}),new Blob([h],{type:"image/jpeg"})}const m=await e.arrayBuffer(),I=new DataView(m),v=[];let g=-1,f=12;for(;f<I.byteLength;){const e=s(I,f),t=I.getUint32(f+4,!0),i=8+t+(1&t);"EXIF"!==e&&"XMP "!==e&&(v.push(new Uint8Array(m,f,i)),"VP8X"===e&&(g=v.length-1)),f+=i}let P=i(n("EXIF"),a(c.length+u.length),c,u);if(1&P.length&&(P=i(P,Uint8Array.of(0))),-1!==g){const e=new Uint8Array(v[g]);e[8]|=16,v[g]=e,v.splice(g+1,0,P)}else v.push(P);const D=v.reduce((e,t)=>e+t.length,0),O=i(n("RIFF"),a(D+4),n("WEBP")),G=i(O,...v);return new Blob([G],{type:"image/webp"})}(t,r).then(e=>A(e,g)).catch(e=>{console.error("Failed to strip EXIF and/or attach post URL to EXIF.",e),A(t,g)}):A(t,g)}(e,o,t,i,a,n,s),r(!0)}))},50)})}function A(e,t){const i=document.createElement("a");i.href=URL.createObjectURL(e),i.download=t,i.click(),i.remove()}async function T(t,i){var a,n;let s=(new Date).getTime(),r=Math.floor(s/1e3),o=e(t).attr("data-username")?e(t).attr("data-username"):H.GL_username;!o&&e(t).attr("data-path")&&(C("catching owner name from shortcode:",e(t).attr("data-href")),o=await(a=e(t).attr("data-path"),new Promise((e,t)=>{a||t("NOPATH"),GM_xmlhttpRequest({method:"GET",url:`https://www.instagram.com/graphql/query/?query_hash=2c4c2e343a8f64c625ba02b2aa12c7f8&variables=%7B%22shortcode%22:%22${a}%22}`,onload:function(i){try{let t=JSON.parse(i.response);C("getPostOwner()",t),e(t.data.shortcode_media.owner.username)}catch(e){C("getPostOwner()","reject",e.message),t(e)}},onerror:function(e){C("getPostOwner()","reject",e),t(e)}})})).catch(e=>{C("get username failed, replace with default string, error message:",e.message)}),null==o&&(o="NONE")),k.RENAME_PUBLISH_DATE&&e(t).attr("datetime")&&(r=parseInt(e(t).attr("datetime")));let l=e(t).attr("media-id");if(k.CAPTURE_IMAGE_VIA_MEDIA_CACHE){const a=B(l);if(a&&"mp4"!=e(t).data("type"))return void(i?U(a):E(a,o,e(t).data("name"),r,e(t).data("type")||"jpg",e(t).data("path")))}if(k.FORCE_RESOURCE_VIA_MEDIA){P(!0);let a=await g(e(t).attr("media-id"));if(P(!1),"ok"===a.status)if(n=null,a.items[0].video_versions?n=a.items[0].video_versions[0].url:(a.items[0].image_versions2.candidates.sort(function(e,t){let i=new URL(e.url).searchParams.get("stp"),a=new URL(t.url).searchParams.get("stp");if(i&&a){if(i.length>a.length)return 1;if(i.length<a.length)return-1}else{if(e.width<t.width)return 1;if(e.width>t.width)return-1}return 0}),n=a.items[0].image_versions2.candidates[0].url,function(e){if(null!=e.width)return e.width;const t=new URL(e.url).searchParams.get("stp");null!=t&&parseInt(t.match(/_p([0-9]+)x([0-9]+)_/i)?.at(1)||-1)}(a.items[0].image_versions2.candidates[0]),a.items[0].original_width),i){let e=new URL(n);e.host="scontent.cdninstagram.com",U(e.href)}else E(n,o,e(t).attr("data-name"),r,e(t).attr("data-type"),e(t).attr("data-path"));else{if(k.FALLBACK_TO_BLOB_FETCH_IF_MEDIA_API_THROTTLED)if(i){let i=new URL(e(t).attr("data-href"));i.host="scontent.cdninstagram.com",U(i.href)}else E(e(t).attr("data-href"),o,e(t).attr("data-name"),r,e(t).attr("data-type"),e(t).attr("data-path"));else alert("Fetch failed from Media API. API response message: "+a.message);C(a)}}else E(e(t).attr("data-href"),o,e(t).attr("data-name"),r,e(t).attr("data-type"),e(t).attr("data-path"))}function L(){for(let e of H.registerMenuIds)C("GM_unregisterMenuCommand",e),GM_unregisterMenuCommand(e);H.registerMenuIds.push(GM_registerMenuCommand($("SETTING"),()=>{w()},{accessKey:"w"})),H.registerMenuIds.push(GM_registerMenuCommand($("DONATE"),()=>{GM_openInTab("https://ko-fi.com/snkoarashi",{active:!0})},{accessKey:"d"})),H.registerMenuIds.push(GM_registerMenuCommand($("DEBUG"),()=>{M()},{accessKey:"z"})),H.registerMenuIds.push(GM_registerMenuCommand($("FEEDBACK"),()=>{e(".IG_POPUP_DIG").remove(),G(),e(".IG_POPUP_DIG #post_info").text("Feedback Options"),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY").append('<span style="display:block;text-align:center;">'),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY span").append(`<button style="margin: 3px;" class="IG_REPORT_FORK"><a href="https://greasyfork.org/en/scripts/404535-ig-helper/feedback" target="_blank">${$("REPORT_FORK")}</a></button>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY span").append(`<button style="margin: 3px;" class="IG_REPORT_GITHUB"><a href="https://github.com/SN-Koarashi/ig-helper/issues" target="_blank">${$("REPORT_GITHUB")}</a></button>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY span").append(`<button style="margin: 3px;" class="IG_REPORT_DISCORD"><a href="https://discord.gg/q3KT4hdq8x" target="_blank">${$("REPORT_DISCORD")}</a></button>`)},{accessKey:"f"})),H.registerMenuIds.push(GM_registerMenuCommand($("CHECK_FOR_UPDATE"),()=>{R()},{accessKey:"c"})),H.registerMenuIds.push(GM_registerMenuCommand($("RELOAD_SCRIPT"),()=>{y()},{accessKey:"r"}))}function b(e){if(!k.CHECK_FOR_UPDATE)return;const t=GM_getValue("G_CHECK_TIMESTAMP")??(new Date).getTime();(new Date).getTime()>parseInt(t)+1e3*e&&(GM_setValue("G_CHECK_TIMESTAMP",(new Date).getTime()),R())}function R(){const e=GM_info.script.version;GM_xmlhttpRequest({method:"GET",url:"https://raw.githubusercontent.com/SN-Koarashi/ig-helper/refs/heads/master/main.js",onload:function(t){const i=t.responseText.match(/\/\/\s+@version\s+([0-9.\-a-zA-Z]+)/i);if(i&&i[1]){const t=i[1];C("Current version: ",e,"|","Remote version: ",t),t!==e?GM_notification({text:$("NOTICE_UPDATE_CONTENT"),title:$("NOTICE_UPDATE_TITLE"),tag:"ig_helper_notice",highlight:!0,timeout:5e3,zombieTimeout:5e3,image:"https://upload.wikimedia.org/wikipedia/commons/thumb/a/a5/Instagram_icon.png/64px-Instagram_icon.png",onclick:e=>{e?.preventDefault();var t=GM_openInTab(GM_info.script.downloadURL);setTimeout(()=>{t.close()},250)}}):C("there is no new update")}else console.error("Could not find version in the remote script.")}})}function w(){e(".IG_POPUP_DIG").remove(),G(),e(".IG_POPUP_DIG #post_info").text("Preference Settings"),e(".IG_POPUP_DIG .IG_POPUP_DIG_TITLE > div").append('\n                <select id="langSelect"></select>\n                <div style="font-size: 12px;">\n                    Some texts are machine-translated and may be inaccurate; translation contributions are welcome on GitHub.\n                </div>\n            ');for(const t in ee)e("#langSelect").append(`<option value="${t}" ${H.lang===t?"selected":""}>${ee[t]}</option>`);const t=e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY");for(const i in k)t.append(`\n                <label class="globalSettings"\n                       title="${$(i+"_INTRO")}"\n                       data-ih-locale-title="${i+"_INTRO"}">\n\n                    <span data-ih-locale="${i}">${$(i)}</span>\n                    <input id="${i}" value="box" type="checkbox"\n                           ${!0===k[i]?"checked":""}>\n                    <div class="chbtn"><div class="rounds"></div></div>\n                </label>`),"MODIFY_VIDEO_VOLUME"===i&&t.find(`input[id="${i}"]`).parent("label").on("contextmenu",function(t){t.preventDefault(),e(this).find("#tempWrapper").length||e(this).append('<div id="tempWrapper"></div>').children("#tempWrapper").append(`<input value="${H.videoVolume}" type="range" min="0" max="1" step="0.05" />`).append(`<input value="${H.videoVolume}" step="0.05" type="number" />`).append(`<div class="IG_POPUP_DIG_BTN">${X}</div>`)}),"AUTO_RENAME"===i&&t.find(`input[id="${i}"]`).parent("label").on("contextmenu",function(t){t.preventDefault(),e(this).find("#tempWrapper").length||e(this).append('<div id="tempWrapper"></div>').children("#tempWrapper").append(`<input id="date_format" value="${H.fileRenameFormat}" />`).append(`<div class="IG_POPUP_DIG_BTN">${X}</div>`)});e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY input#CHECK_FOR_UPDATE").closest("label").prependTo(".IG_POPUP_DIG .IG_POPUP_DIG_BODY"),Object.entries(Y).forEach(([t,i])=>{let a=e(`.IG_POPUP_DIG .IG_POPUP_DIG_BODY input#${t}`).closest("label");i.forEach(t=>{const i=e(`.IG_POPUP_DIG .IG_POPUP_DIG_BODY input#${t}`).closest("label").detach();i.addClass("child"),a.after(i),a=i})})}function M(){e(".IG_POPUP_DIG").remove(),G(),e(".IG_POPUP_DIG #post_info").text("IG Debug DOM Tree"),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY").append('<textarea style="font-family: monospace;width:100%;box-sizing: border-box;height:300px;background: transparent;" readonly></textarea>'),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY").append('<span style="display:block;text-align:center;">'),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY span").append(`<button style="margin: 3px;" class="IG_DISPLAY_DOM_TREE"><a>${$("SHOW_DOM_TREE")}</a></button>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY span").append(`<button style="margin: 3px;" class="IG_SELECT_DOM_TREE"><a>${$("SELECT_AND_COPY")}</a></button>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY span").append(`<button style="margin: 3px;" class="IG_DOWNLOAD_DOM_TREE"><a>${$("DOWNLOAD_DOM_TREE")}</a></button><br/>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY span").append(`<button style="margin: 3px;" class="IG_REPORT_GITHUB"><a href="https://github.com/SN-Koarashi/ig-helper/issues" target="_blank">${$("REPORT_GITHUB")}</a></button>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY span").append(`<button style="margin: 3px;" class="IG_REPORT_DISCORD"><a href="https://discord.gg/q3KT4hdq8x" target="_blank">${$("REPORT_DISCORD")}</a></button>`)}function U(e){var t=document.createElement("a");t.href=e,t.target="_blank",document.body.appendChild(t),t.click(),t.remove(),setTimeout(()=>{P(!1)},125)}function y(){clearInterval(H.GL_repeat),H.GL_registerEventList.forEach(t=>{t.trigger.forEach(i=>{e(t.element).off("click",i)})}),H.GL_registerEventList=[],e(".button_wrapper").remove(),e(".IG_DWPROFILE, .IG_DWPROFILE, .IG_DWSTORY, .IG_DWSTORY_ALL, .IG_DWSTORY_THUMBNAIL, .IG_DWNEWTAB, .IG_DWHISTORY, .IG_DWHISTORY_ALL, .IG_DWHINEWTAB, .IG_DWHISTORY_THUMBNAIL, .IG_REELS, .IG_REELS_NEWTAB, .IG_REELS_THUMBNAIL").remove(),e("[data-snig]").removeAttr("data-snig"),H.pageLoaded=!1,H.firstStarted=!1,H.currentURL=location.href,H.GL_observer.disconnect(),C("main timer re-register completed")}function C(...e){var t=new Date;H.GL_logger.push({time:t.getTime(),content:[...e]}),H.GL_logger.length>1e3&&(H.GL_logger=[{time:t.getTime(),content:["logger sliced"]},...H.GL_logger.slice(-999)]),console.log(`[${t.toISOString()}]`,...e)}function N(t,i,a,n=""){0===i.find("div.volume_slider").length?(i.append(`<div class="volume_slider ${n}" />`),i.find("div.volume_slider").append(`<div><input type="range" max="1" min="0" step="0.05" value="${H.videoVolume}" /></div>`),i.find("div.volume_slider input").attr("style","--ig-track-progress: "+100*H.videoVolume+"%"),i.find("div.volume_slider input").on("input",function(){var i=100*e(this).val()+"%";H.videoVolume=e(this).val(),GM_setValue("G_VIDEO_VOLUME",e(this).val()),e(this).attr("style",`--ig-track-progress: ${i}`),t.each(function(){C(`(${a})`,"video volume changed #slider"),this.volume=H.videoVolume})}),i.find("div.volume_slider input").on("mouseenter",function(){var i=100*H.videoVolume+"%";e(this).attr("style",`--ig-track-progress: ${i}`),e(this).val(H.videoVolume),t.each(function(){C(`(${a})`,"video volume changed #slider"),this.volume=H.videoVolume})}),i.find("div.volume_slider").on("click",function(e){e.stopPropagation(),e.preventDefault()})):i.find("div.volume_slider").remove()}function S(){clearInterval(V),e("#imageViewer").remove(),e(document).off("mousemove.igHelper")}function B(e){if(!e)return null;const t=H.GL_imageCache[e];return t?Date.now()-t.ts>432e5?(delete H.GL_imageCache[e],null):t.url:null}async function x(e){return new Promise((t,i)=>{GM_xmlhttpRequest({method:"GET",url:`https://raw.githubusercontent.com/SN-Koarashi/ig-helper/master/locale/translations/${e}.json`,onload:function(e){try{let i=JSON.parse(e.response);t(i)}catch(e){i(e)}},onerror:function(e){C("getTranslationText()","reject",e),i(e)}})})}function $(e){const t=(i={"en-US":{NOTICE_UPDATE_TITLE:"Wololo! New version released.",NOTICE_UPDATE_CONTENT:"IG-Helper has released a new version, click here to update.",CHECK_FOR_UPDATE:"Check for Script Updates",RELOAD_SCRIPT:"Reload Script",DONATE:"Donate",FEEDBACK:"Feedback",IMAGE_VIEWER:"Open Image In Viewer",NEW_TAB:"Open in New Tab",SHOW_DOM_TREE:"Show DOM Tree",SELECT_AND_COPY:"Select All and Copy from the Input Box",DOWNLOAD_DOM_TREE:"Download DOM Tree as a Text File",REPORT_GITHUB:"Report an Issue on GitHub",REPORT_DISCORD:"Report an Issue on Discord Support Server",REPORT_FORK:"Report an Issue on Greasy Fork",DEBUG:"Debug Window",CLOSE:"Close",ALL_CHECK:"Select All",BATCH_DOWNLOAD_SELECTED:"Download Selected Resources",BATCH_DOWNLOAD_DIRECT:"Download All Resources",IMG:"Image",VID:"Video",DW:"Download",DW_ALL:"Download All Resources",VIDEO_THUMBNAIL:"Download Video Thumbnail",LOAD_BLOB_ONE:"Loading Blob Media...",LOAD_BLOB_MULTIPLE:"Loading Blob Media and Others...",LOAD_BLOB_RELOAD:"Detecting Blob Media, reloading...",NO_CHECK_RESOURCE:"You need to select a resource to download.",NO_VID_URL:"Cannot find video URL.",SETTING:"Settings",AUTO_RENAME:"Automatically Rename Files (Right-Click to Set)",RENAME_PUBLISH_DATE:"Set Renamed File Timestamp to Resource Publish Date",RENAME_LOCATE_DATE:"Modify Renamed File Timestamp Date Format (Right-Click to Set)",DISABLE_VIDEO_LOOPING:"Disable Video Auto-looping",HTML5_VIDEO_CONTROL:"Display HTML5 Video Controller",REDIRECT_CLICK_USER_STORY_PICTURE:"Redirect When Clicking on User's Story Picture",FORCE_FETCH_ALL_RESOURCES:"Force Fetch All Resources in the Post",DIRECT_DOWNLOAD_VISIBLE_RESOURCE:"Directly Download the Visible Resources in the Post",DIRECT_DOWNLOAD_ALL:"Directly Download All Resources in the Post",DIRECT_DOWNLOAD_STORY:"Directly Download All Resources in the Story/Highlight",MODIFY_VIDEO_VOLUME:"Modify Video Volume (Right-Click to Set)",MODIFY_RESOURCE_EXIF:"Modify Resource EXIF Properties",SCROLL_BUTTON:"Enable Scroll Buttons for Reels Page",FORCE_RESOURCE_VIA_MEDIA:"Force Fetch Resource via Media API",FALLBACK_TO_BLOB_FETCH_IF_MEDIA_API_THROTTLED:"Use Alternative Methods to Download When the Media API is Not Accessible",NEW_TAB_ALWAYS_FORCE_MEDIA_IN_POST:"Always Use Media API for 'Open in New Tab' in Posts",SKIP_VIEW_STORY_CONFIRM:"Skip the Confirmation Page for Viewing a Story/Highlight",CAPTURE_IMAGE_VIA_MEDIA_CACHE:"Capture Image Resource Using Media Cache",AUTO_RENAME_INTRO:"Auto rename file to custom format:\nCustom Format List: \n%USERNAME% - Username\n%SOURCE_TYPE% - Download Source\n%SHORTCODE% - Post Shortcode\n%YEAR% - Year when downloaded/published\n%2-YEAR% - Year (last two digits) when downloaded/published\n%MONTH% - Month when downloaded/published\n%DAY% - Day when downloaded/published\n%HOUR% - Hour when downloaded/published\n%MINUTE% - Minute when downloaded/published\n%SECOND% - Second when downloaded/published\n%ORIGINAL_NAME% - Original name of downloaded file\n%ORIGINAL_NAME_FIRST% - Original name of downloaded file (first part of name)\n\nIf set to false, the file name will remain unchanged.\nExample: instagram_321565527_679025940443063_4318007696887450953_n.jpg",RENAME_PUBLISH_DATE_INTRO:"Sets the timestamp in the file rename format to the resource publish date (browser time zone).\n\nThis feature only works when [Automatically Rename Files] is set to TRUE.",RENAME_LOCATE_DATE_INTRO:"Modify the renamed file timestamp date format to the browser's local time, and format it to your preferred regional date format.\n\nThis feature only works when [Automatically Rename Files] is set to TRUE.",DISABLE_VIDEO_LOOPING_INTRO:"Disable video auto-looping in Reels and posts.",HTML5_VIDEO_CONTROL_INTRO:"Display the HTML5 video controller in video resource.\n\nThis will hide the custom video volume slider and replace it with the HTML5 controller. The HTML5 controller can be hidden by right-clicking on the video to reveal the original details.",REDIRECT_CLICK_USER_STORY_PICTURE_INTRO:"Redirect to a user's profile page when right-clicking on their avatar in the story area on the homepage.\nIf you use the middle mouse button to click, it will open in a new tab.",FORCE_FETCH_ALL_RESOURCES_INTRO:"Force fetching of all resources (photos and videos) in a post via the Instagram API to remove the limit of three resources per post.",DIRECT_DOWNLOAD_VISIBLE_RESOURCE_INTRO:"Directly download the current resources available in the post.",DIRECT_DOWNLOAD_ALL_INTRO:"When you click the download button, all resources in the post will be forcibly fetched and downloaded.",MODIFY_VIDEO_VOLUME_INTRO:"Modify the video playback volume in Reels and posts (right-click to open the volume setting slider).",SCROLL_BUTTON_INTRO:"Enable scroll buttons for the lower right corner of the Reels page.",FORCE_RESOURCE_VIA_MEDIA_INTRO:"The Media API will try to get the highest quality photo or video possible, but it may take longer to load.",FALLBACK_TO_BLOB_FETCH_IF_MEDIA_API_THROTTLED_INTRO:"When the Media API reaches its rate limit or cannot be used for other reasons, the Forced Fetch API will be used to download resources (the resource quality may be slightly lower).",NEW_TAB_ALWAYS_FORCE_MEDIA_IN_POST_INTRO:"The [Open in New Tab] button in posts will always use the Media API to obtain high-resolution resources.",CHECK_FOR_UPDATE_INTRO:"Check for updates when the script is triggered (check every 300 seconds).\nUpdate notifications will be sent as desktop notifications through the browser.",SKIP_VIEW_STORY_CONFIRM_INTRO:"Automatically skip when confirmation page is shown in story or highlight.",MODIFY_RESOURCE_EXIF_INTRO:"Modify the EXIF properties of the image resource to place the post link in it.",DIRECT_DOWNLOAD_STORY_INTRO:"When you click Download All Resources, all stories/highlights are downloaded directly, without showing the image selection dialog.",CAPTURE_IMAGE_VIA_MEDIA_CACHE_INTRO:"Use a watcher to capture any high-quality image URLs in the DOM tree into the scripts storage so that they can be extracted when available and upon user input."}},a=Object.assign({},i,H.locale),Object.keys(a).sort().reduce((e,t)=>(e[t]=a[t],e),{}));var i,a;return null!=t[H.lang]&&null!=t[H.lang][e]?t[H.lang][e]:t["en-US"][e]}function W(){e("[data-ih-locale]").each(function(){e(this).text($(e(this).attr("data-ih-locale")))}),e("[data-ih-locale-title]").each(function(){e(this).attr("title",$(e(this).attr("data-ih-locale-title")))})}var H,V;const k={AUTO_RENAME:!0,CAPTURE_IMAGE_VIA_MEDIA_CACHE:!0,CHECK_FOR_UPDATE:!0,DIRECT_DOWNLOAD_ALL:!1,DIRECT_DOWNLOAD_STORY:!1,DIRECT_DOWNLOAD_VISIBLE_RESOURCE:!1,DISABLE_VIDEO_LOOPING:!1,FALLBACK_TO_BLOB_FETCH_IF_MEDIA_API_THROTTLED:!1,FORCE_FETCH_ALL_RESOURCES:!1,FORCE_RESOURCE_VIA_MEDIA:!1,HTML5_VIDEO_CONTROL:!1,MODIFY_RESOURCE_EXIF:!1,MODIFY_VIDEO_VOLUME:!1,NEW_TAB_ALWAYS_FORCE_MEDIA_IN_POST:!1,REDIRECT_CLICK_USER_STORY_PICTURE:!1,RENAME_PUBLISH_DATE:!0,SCROLL_BUTTON:!0,SKIP_VIEW_STORY_CONFIRM:!1},Y={AUTO_RENAME:["RENAME_PUBLISH_DATE"],FORCE_RESOURCE_VIA_MEDIA:["FALLBACK_TO_BLOB_FETCH_IF_MEDIA_API_THROTTLED","NEW_TAB_ALWAYS_FORCE_MEDIA_IN_POST"]},F="URLS_OF_IMAGES_TEMPORARILY_STORED",j='<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><g><rect fill="none" height="24" width="24"/></g><g><path d="M18,15v3H6v-3H4v3c0,1.1,0.9,2,2,2h12c1.1,0,2-0.9,2-2v-3H18z M17,11l-1.41-1.41L13,12.17V4h-2v8.17L8.41,9.59L7,11l5,5 L17,11z"/></g></svg>',z='<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>',K='<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-4.86 8.86l-3 3.87L9 13.14 6 17h12l-3.86-5.14z"/></svg>',q='<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><g><rect fill="none" height="24" width="24"/></g><g><g><polygon points="18,6.41 16.59,5 12,9.58 7.41,5 6,6.41 12,12.41"/><polygon points="18,13 16.59,11.59 12,16.17 7.41,11.59 6,13 12,19"/></g></g></svg>',X='<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>',J='<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>',Q='<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#1f1f1f"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M7.34 6.41L.86 12.9l6.49 6.48 6.49-6.48-6.5-6.49zM3.69 12.9l3.66-3.66L11 12.9l-3.66 3.66-3.65-3.66zm15.67-6.26C17.61 4.88 15.3 4 13 4V.76L8.76 5 13 9.24V6c1.79 0 3.58.68 4.95 2.05 2.73 2.73 2.73 7.17 0 9.9C16.58 19.32 14.79 20 13 20c-.97 0-1.94-.21-2.84-.61l-1.49 1.49C10.02 21.62 11.51 22 13 22c2.3 0 4.61-.88 6.36-2.64 3.52-3.51 3.52-9.21 0-12.72z"/></svg>',Z=GM_getResourceText("INTERNAL_CSS"),ee=JSON.parse(GM_getResourceText("LOCALE_MANIFEST"));H={videoVolume:GM_getValue("G_VIDEO_VOLUME")?GM_getValue("G_VIDEO_VOLUME"):1,tempFetchRateLimit:!1,fileRenameFormat:GM_getValue("G_RENAME_FORMAT")?GM_getValue("G_RENAME_FORMAT"):"%USERNAME%-%SOURCE_TYPE%-%SHORTCODE%-%YEAR%%MONTH%%DAY%_%HOUR%%MINUTE%%SECOND%_%ORIGINAL_NAME_FIRST%",registerMenuIds:[],locale:{},lang:GM_getValue("UI_LANGUAGE")||navigator.language||navigator.userLanguage,currentURL:location.href,firstStarted:!1,pageLoaded:!1,GL_registerEventList:[],GL_logger:[],GL_referrer:null,GL_postPath:null,GL_username:null,GL_repeat:null,GL_dataCache:{stories:{},highlights:{}},GL_observer:new MutationObserver(function(){a()}),GL_imageCache:GM_getValue(F,{})},function(){for(let e in k)null!=GM_getValue(e)&&"boolean"==typeof GM_getValue(e)&&(k[e]=GM_getValue(e),"MODIFY_VIDEO_VOLUME"===e&&!0!==GM_getValue(e)&&(H.videoVolume=1))}(),GM_addStyle(Z),L(),x(H.lang).then(e=>{H.locale[H.lang]=e,W(),L(),b(300)}).catch(e=>{L(),b(300),H.lang.startsWith("en")||console.error("getTranslationText catch error:",e)}),C("Script Loaded",GM_info.script.name,"version:",GM_info.script.version),function(){const e=Date.now();for(const t in H.GL_imageCache)e-H.GL_imageCache[t].ts>432e5&&delete H.GL_imageCache[t];GM_setValue(F,H.GL_imageCache)}(),setInterval(function(){if(e("div#splash-screen").length>0&&!e("div#splash-screen").is(":hidden")||location.pathname.match(/^\/(explore(\/.*)?|challenge\/?.*|direct\/?.*|qr\/?|accounts\/.*|emails\/.*|language\/?.*?|your_activity\/?.*|settings\/help(\/.*)?$)$/gi)||!location.hostname.startsWith("www.")||location.pathname.startsWith("/auth_platform/codeentry/")||location.pathname.startsWith("/challenge/")||location.pathname.startsWith("/consent/")||location.pathname.startsWith("/accounts/")||(location.pathname.endsWith("/followers/")||location.pathname.endsWith("/following/"))&&e('body > div[class]:not([id^="mount"]) div div[role="dialog"]').length>0)H.pageLoaded=!1;else if(H.currentURL!=location.href||!H.firstStarted||!H.pageLoaded){if(console.log("Main Timer","trigging"),clearInterval(H.GL_repeat),H.pageLoaded=!1,H.firstStarted=!0,H.currentURL=location.href,H.GL_observer.disconnect(),location.pathname.startsWith("/p/")||location.pathname.match(/^\/(.*?)\/(p|reel)\//gi)||location.pathname.startsWith("/reel/")){H.GL_dataCache.stories={},H.GL_dataCache.highlights={},C("isDialog");var n=setInterval(()=>{e('body > div[class]:not([id^="mount"]) div div[role="dialog"] article,\n                                section:visible > main > div > div > div > div > div > hr,\n                                body > div[id^="mount"] section nav + div > article,\n                                section:visible > main > div > div > article > div > div > div > div > div > header\n                            ').length>0&&(clearInterval(n),setTimeout(()=>{a(!1)},15))},100);H.pageLoaded=!0}if(location.pathname.startsWith("/reels/")&&(C("isReelsPage"),setTimeout(()=>{c(!1)},150),H.pageLoaded=!0),"/"===location.pathname){H.GL_dataCache.stories={},H.GL_dataCache.highlights={};let t=null!=H.GL_referrer?.match(/^\/(stories|highlights)\//gi);C("isHomepage",t),setTimeout(()=>{a(!1,t);const i=e('div[id^="mount"] > div > div div > section > main div:not([class]):not([style]) > div > article')?.parent()[0];i&&H.GL_observer.observe(i,{childList:!0})},150),H.pageLoaded=!0}e("header > *[class]:first-child img[alt]").length&&location.pathname.match(/^(\/)([0-9A-Za-z\.\-_]+)\/?(tagged|reels|saved)?\/?$/gi)&&!location.pathname.match(/^(\/explore\/?$|\/stories(\/.*)?$|\/p\/)/gi)&&(C("isProfile"),setTimeout(()=>{d(!1)},150),H.pageLoaded=!0),H.pageLoaded||(location.pathname.startsWith("/stories/highlights/")?(H.GL_dataCache.highlights={},C("isHighlightsStory"),t(!1),H.GL_repeat=setInterval(()=>{i(!1)},250),e(".IG_DWHISTORY").length&&setTimeout(()=>{if(k.SKIP_VIEW_STORY_CONFIRM){var t=e('div[id^="mount"] section:last-child > div > div:not([class]) div:last-child > div[role="button"]').filter(function(){return 0===e(this).children().length&&""!==this.textContent.trim()});t?.trigger("click")}H.pageLoaded=!0},150)):location.pathname.startsWith("/stories/")?(C("isStory"),(e('div[id^="mount"] section > div > a[href="/"]').length>0||e('div[id^="mount"] section > div > a[href^="/?hl="]').length>0)&&(e(".IG_DWSTORY").remove(),e(".IG_DWNEWTAB").remove(),e(".IG_DWSTORY_THUMBNAIL").length&&e(".IG_DWSTORY_THUMBNAIL").remove(),h(!1),setTimeout(()=>{h(!1)},150)),e(".IG_DWSTORY").length&&setTimeout(()=>{if(k.SKIP_VIEW_STORY_CONFIRM){var t=e('div[id^="mount"] section:last-child > div > div:not([class]) div:last-child > div[role="button"]').filter(function(){return 0===e(this).children().length&&""!==this.textContent.trim()});t?.trigger("click")}H.pageLoaded=!0},150)):(H.pageLoaded=!1,e(".IG_DWSTORY").length&&e(".IG_DWSTORY").remove(),e(".IG_DWSTORY_ALL").length&&e(".IG_DWSTORY_ALL").remove(),e(".IG_DWNEWTAB").length&&e(".IG_DWNEWTAB").remove(),e(".IG_DWSTORY_THUMBNAIL").length&&e(".IG_DWSTORY_THUMBNAIL").remove(),e(".IG_DWHISTORY").length&&e(".IG_DWHISTORY").remove(),e(".IG_DWHISTORY_ALL").length&&e(".IG_DWHISTORY_ALL").remove(),e(".IG_DWHINEWTAB").length&&e(".IG_DWHINEWTAB").remove(),e(".IG_DWHISTORY_THUMBNAIL").length&&e(".IG_DWHISTORY_THUMBNAIL").remove())),b(300),H.GL_referrer=new URL(location.href).pathname}},250),V=null;let te=!1,ie=null;e(function(){function a(){let t=e('div[id^="mount"]')[0];var i="";H.GL_logger.forEach(e=>{var t=JSON.stringify(e.content,function(e,t){return Array.isArray(this)&&"object"==typeof t&&t instanceof jQuery?function(e){var t,i=[];for(t of e)i.push({tagName:t.tagName,id:t.id,className:t.className});return i}(t):t},"\t");i+=`${new Date(e.time).toISOString()}: ${t}\n`}),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY textarea").text("Logger:\n"+i+"\n-----\n\nLocation: "+location.pathname+"\nDOM Tree with div#mount:\n"+t.innerHTML)}e("body").on("click",".IG_POPUP_DIG .IG_POPUP_DIG_BODY .IG_DISPLAY_DOM_TREE",function(){a()}),e("body").on("click",".IG_POPUP_DIG .IG_POPUP_DIG_BODY .IG_SELECT_DOM_TREE",function(){e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY textarea").select(),document.execCommand("copy")}),e("body").on("click",".IG_POPUP_DIG .IG_POPUP_DIG_BODY .IG_DOWNLOAD_DOM_TREE",function(){var t,i,n;0===e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY textarea").text().length&&a(),t=e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY textarea").text(),i=document.createElement("a"),n=new Blob([t],{type:"text/plain"}),i.href=URL.createObjectURL(n),i.download="DOMTree-"+(new Date).getTime()+".txt",document.body.appendChild(i),i.click(),i.remove()}),e("body").on("click",".IG_POPUP_DIG_BTN, .IG_POPUP_DIG_BG",function(){e(this).parent("#tempWrapper").length>0?e(this).parent("#tempWrapper").fadeOut(250,function(){e(this).remove()}):e(".IG_POPUP_DIG").remove()}),e(window).on("keydown",function(t){"81"==t.which&&t.altKey&&(e(".IG_POPUP_DIG").remove(),t.preventDefault()),"87"==t.which&&t.altKey&&(w(),t.preventDefault()),"90"==t.which&&t.altKey&&(M(),t.preventDefault()),"82"==t.which&&t.altKey&&(y(),t.preventDefault()),"83"==t.which&&t.altKey&&(location.href.match(/^(https:\/\/www\.instagram\.com\/stories\/)/gi)&&e(".IG_DWSTORY").length>0&&e(".IG_DWSTORY")?.trigger("click"),location.href.match(/^(https:\/\/www\.instagram\.com\/stories\/highlights\/)/gi)&&e(".IG_DWHISTORY").length>0&&e(".IG_DWHISTORY")?.trigger("click"),t.preventDefault())}),e("body").on("change",".IG_POPUP_DIG input",function(){var t=e(this).attr("id");if(t&&void 0!==k[t]){let i=e(this).prop("checked");GM_setValue(t,i),k[t]=i,console.log("user settings",t,i)}}),e("body").on("click",".IG_POPUP_DIG .globalSettings",function(t){e(this).find("#tempWrapper").length>0&&t.preventDefault()}),e("body").on("change",".IG_POPUP_DIG #tempWrapper input:not(#date_format)",function(){let t=e(this).val();"range"==e(this).attr("type")?e(this).next().val(t):e(this).prev().val(t),t>=0&&t<=1&&(H.videoVolume=t,GM_setValue("G_VIDEO_VOLUME",t))}),e("body").on("input",".IG_POPUP_DIG #tempWrapper input:not(#date_format)",function(){if("range"==e(this).attr("type")){let t=e(this).val();e(this).next().val(t)}else{let t=e(this).val();t>=0&&t<=1?e(this).prev().val(t):t<0?e(this).val(0):e(this).val(1)}}),e("body").on("input",".IG_POPUP_DIG #tempWrapper input#date_format",function(){GM_setValue("G_RENAME_FORMAT",e(this).val()),H.fileRenameFormat=e(this).val()}),e("body").on("click",'a[data-needed="direct"]',function(e){e.preventDefault(),T(this)}),e("body").on("click",".IG_POPUP_DIG_BODY .newTab",function(){if(k.FORCE_RESOURCE_VIA_MEDIA&&k.NEW_TAB_ALWAYS_FORCE_MEDIA_IN_POST)T(e(this).parent().children("a").first()[0],!0);else{var t=new URL(e(this).parent().children("a").attr("data-href"));t.host="scontent.cdninstagram.com",U(t.href)}}),e("body").on("click",".IG_POPUP_DIG_BODY .videoThumbnail",function(){let t=(new Date).getTime();k.RENAME_PUBLISH_DATE&&e(this).parent().children("a").attr("datetime")&&(t=e(this).parent().children("a").attr("datetime"));let i=e(this).parent().children("a").attr("data-path")??e("#article-id").text();E(e(this).parent().children("a").find("img").first().attr("src"),e(this).parent().children("a").attr("data-username"),"thumbnail",t,"jpg",i)}),e("body").on("click",".IG_DWSTORY",function(){h(!0)}),e("body").on("click",".IG_DWSTORY_ALL",function(){!async function(){P(!0);let t=(new Date).getTime(),i=Math.floor(t/1e3),a=e("body > div section._ac0a header._ac0k ._ac0l a + div a").first().text()||location.pathname.split("/").filter(e=>e.length>0).at(1),n=(await I(a)).user.pk,s=await m(n);if(k.DIRECT_DOWNLOAD_STORY){let e=0;O(e,s.data.reels_media[0].items.length),s.data.reels_media[0].items.forEach((t,n)=>{setTimeout(()=>{k.RENAME_PUBLISH_DATE&&(i=t.taken_at_timestamp),t.display_resources.sort(function(e,t){return e.config_width<t.config_width?1:e.config_width>t.config_width?-1:0}),t.is_video?E(t.video_resources[0].src,a,"stories",i,"mp4",t.id).then(()=>{O(++e,s.data.reels_media[0].items.length)}):E(t.display_resources[0].src,a,"stories",i,"jpg",t.id).then(()=>{O(++e,s.data.reels_media[0].items.length)})},100*n)})}else G(!1,!0),_(s,"stories")}()}),e("body").on("click",".IG_DWNEWTAB",function(e){e.preventDefault(),h(!0,!0,!0)}),e("body").on("click",".IG_DWSTORY_THUMBNAIL",function(){p(!0)}),e("body").on("click",".IG_DWPROFILE",function(e){e.stopPropagation(),d(!0)}),e("body").on("click",".IG_DWHISTORY",function(){t(!0)}),e("body").on("click",".IG_DWHISTORY_ALL",function(){!async function(){P(!0);let e=(new Date).getTime(),t=Math.floor(e/1e3),i=location.href.replace(/\/$/gi,"").split("/").at(-1),a=await u(i),n=a.data.reels_media[0].owner.username;if(k.DIRECT_DOWNLOAD_STORY){let e=0;O(e,a.data.reels_media[0].items.length),a.data.reels_media[0].items.forEach((i,s)=>{setTimeout(()=>{k.RENAME_PUBLISH_DATE&&(t=i.taken_at_timestamp),i.display_resources.sort(function(e,t){return e.config_width<t.config_width?1:e.config_width>t.config_width?-1:0}),i.is_video?E(i.video_resources[0].src,n,"highlights",t,"mp4",i.id).then(()=>{O(++e,a.data.reels_media[0].items.length)}):E(i.display_resources[0].src,n,"highlights",t,"jpg",i.id).then(()=>{O(++e,a.data.reels_media[0].items.length)})},100*s)})}else G(!1,!0),_(a,"highlights")}()}),e("body").on("click",".IG_DWHINEWTAB",function(e){e.preventDefault(),t(!0,!0)}),e("body").on("click",".IG_DWHISTORY_THUMBNAIL",function(){i(!0)}),e("body").on("click",".IG_REELS",function(){c(!0,!0)}),e("body").on("click",".IG_REELS_NEWTAB",function(){c(!0,!0,!0)}),e("body").on("click",".IG_REELS_THUMBNAIL",function(){c(!0,!1)}),e("body").on("mousedown",'button[role="menuitem"], div[role="menuitem"], ul > li[tabindex="-1"] > div[role="button"]',function(t){if((3===t.which||2===t.which)&&"https://www.instagram.com/"===location.href&&k.REDIRECT_CLICK_USER_STORY_PICTURE&&(t.preventDefault(),e(this).find("canvas._aarh, canvas + span > img").length>0)){const i="https://www.instagram.com/"+e(this).children("div").last().text();2===t.which?GM_openInTab(i):location.href=i}}),e("body").on("change",".IG_POPUP_DIG_TITLE .checkbox",function(){var t=e(this).find("input").prop("checked");e(".IG_POPUP_DIG_BODY .inner_box").each(function(){e(this).prop("checked",t)})}),e("body").on("change",".IG_POPUP_DIG_BODY .inner_box",function(){var t=e(".IG_POPUP_DIG_BODY .inner_box:checked").length,i=e(".IG_POPUP_DIG_BODY .inner_box").length;e(".IG_POPUP_DIG_TITLE .checkbox").find("input").prop("checked",t==i)}),e("body").on("click",".IG_POPUP_DIG_TITLE #batch_download_selected",function(){let t=0;e('.IG_POPUP_DIG_BODY a[data-needed="direct"]').each(function(){e(this).prev().children("input").prop("checked")&&(e(this).trigger("click"),t++)}),0==t&&alert($("NO_CHECK_RESOURCE"))}),e("body").on("change",".IG_POPUP_DIG_TITLE #langSelect",function(){GM_setValue("UI_LANGUAGE",e(this).val()),H.lang=e(this).val(),H.lang?.startsWith("en")||null!=H.locale[H.lang]?(W(),L()):x(H.lang).then(e=>{H.locale[H.lang]=e,W(),L()}).catch(e=>{console.error("getTranslationText catch error:",e)})}),e("body").on("click",".IG_POPUP_DIG_TITLE #batch_download_direct",function(){e('.IG_POPUP_DIG_BODY a[data-needed="direct"]').each(function(){e(this).trigger("click")})}),new PerformanceObserver(e=>{k.CAPTURE_IMAGE_VIA_MEDIA_CACHE&&e.getEntries().forEach(e=>{if("img"===e.initiatorType){const t=e.name;if(!(t.includes("_e35")||t.includes("_e15")||t.includes(".webp?"))||t.match(/_[sp](\d+)x\1(?!\d)/))return;const i=function(e){try{const t=new URL(e).searchParams.get("ig_cache_key");if(!t)return null;const i=t.split(".")[0];return atob(i)}catch{return null}}(t);i&&!H.GL_imageCache[i]&&function(e,t){if(!e)return;const i=Object.keys(H.GL_imageCache);i.length>=300&&(i.sort((e,t)=>H.GL_imageCache[e].ts-H.GL_imageCache[t].ts),delete H.GL_imageCache[i[0]]),te=!0,H.GL_imageCache[e]={url:t,ts:Date.now()},ie||(ie=setTimeout(()=>{te&&(GM_setValue(F,H.GL_imageCache),te=!1),ie=null},500))}(i,t)}})}).observe({entryTypes:["resource"]}),new MutationObserver(t=>{for(const a of t)"childList"===a.type&&a.addedNodes.forEach(t=>{const a=e(t).find("video");if(location.pathname.startsWith("/stories/highlights/")&&null==e(t).attr("data-ih-locale-title")&&null==e(t).attr("data-visualcompletion")&&"DIV"===t.tagName){var n=e(t).find("time[datetime]");let i=n?.attr("title");null!=i&&n.text(i)}if(a.length>0&&(k.MODIFY_VIDEO_VOLUME&&a.each(function(){e(this).on("play playing",function(){e(this).data("modify")||(e(this).attr("data-modify",!0),this.volume=H.videoVolume,C("(audio_observer) Added video event listener #modify"))})}),location.pathname.match(/^(\/stories\/)/gi))){const t=null!=location.pathname.match(/^(\/stories\/highlights\/)/gi),n=t?"highlight":"story";a.each(function(){e(this).on("timeupdate",function(){if(!e(this).data("modify-thumbnail")){let a=e(this);0===a.parents("div[style][class]").filter(function(){return e(this).width()==a.width()}).find(".IG_DWSTORY_THUMBNAIL, .IG_DWHISTORY_THUMBNAIL").length?(e(this).attr("data-modify-thumbnail",!0),t?i(!1):p(!1),C(`(${n})`,"Manually inserting thumbnail button")):(e(this).attr("data-modify-thumbnail",!0),C(`(${n})`,"Thumbnail button already inserted"))}});var a=e(this);if(k.HTML5_VIDEO_CONTROL){if(!a.data("controls")){C(`(${n})`,"Added video html5 contorller #modify"),k.MODIFY_VIDEO_VOLUME&&(this.volume=H.videoVolume,a.on("loadstart",function(){this.volume=H.videoVolume}));let t=a.parents("div").filter(function(){return null==e(this).attr("class")&&null==e(this).attr("style")}).first(),i=t.next();i.hide();let s=t.find('div[class][role="button"]');s.hide();const r=function(t){t.preventDefault(),a.css("z-index","2"),a.attr("controls",!0),s.hide(),i.hide(),N(a,a.parents("div[style][class]").filter(function(){return e(this).width()==a.width()}).first(),n,"vertical")};a.parent().find("video + div").on("contextmenu",r),s.on("contextmenu",r),i.on("contextmenu",r),a.on("contextmenu",function(t){t.preventDefault(),a.css("z-index","-1"),a.removeAttr("controls"),i.show(),s.show(),N(a,a.parents("div[style][class]").filter(function(){return e(this).width()==a.width()}).first(),n,"vertical")}),a.on("volumechange",function(){let i=t.parent().find('svg > path[d^="M1.5 13.3c-.8 0-1.5.7-1.5 1.5v18.4c0"], svg > path[d^="M16.636 7.028a1.5 1.5"]').parents('[role="button"]').first();var a=0===i.find('svg > path[d^="M16.636"]').length;this.muted!=a&&(this.volume=H.videoVolume,i?.trigger("click")),e(this).attr("data-completed")&&(H.videoVolume=this.volume,GM_setValue("G_VIDEO_VOLUME",this.volume)),this.volume==H.videoVolume&&e(this).attr("data-completed",!0)}),a.css("position","absolute"),a.css("z-index","2"),a.attr("data-controls",!0),a.attr("controls",!0)}}else N(a,a.parents("div[style][class]").filter(function(){return e(this).width()==a.width()}).first(),n,"vertical")})}})}).observe(e('div[id^="mount"]')[0],{childList:!0,subtree:!0})})}(jQuery);