// ==UserScript==
// @name                 Netflix UHD
// @namespace            http://tampermonkey.net/
// @version              1.26
// @author               TGSAN
// @match                https://www.netflix.com/*
// @icon                 https://www.google.com/s2/favicons?sz=64&domain=netflix.com
// @run-at               document-start
// @grant                unsafeWindow
// @grant                GM_registerMenuCommand
// @downloadURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/Netflix20UHD.user.js
// @updateURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/Netflix20UHD.meta.js
// ==/UserScript==
!function(){let e;self.unsafeWindow?(console.log("use unsafeWindow mode"),e=self.unsafeWindow):(console.log("use window mode"),e=self.window),delete e.screen,e.__defineGetter__("screen",function(){let e=[];return e.width=7680,e.height=4320,e.availWidth=7680,e.availHeight=4320,e.availLeft=0,e.availTop=0,e.colorDepth=32,e.isExtended=!1,e.pixelDepth=32,e}),delete e.devicePixelRatio,e.devicePixelRatio=4,e.MSMediaKeys&&(e.MSMediaKeys.isTypeSupportedWithFeaturesOriginal=e.MSMediaKeys.isTypeSupportedWithFeatures,e.MSMediaKeys.isTypeSupportedWithFeatures=function(e,i){return i=i.replace(/,display-res-[x|y]=\d+,display-res-[x|y]=\d+/,""),this.isTypeSupportedWithFeaturesOriginal(e,i)},e.MSMediaKeys.isTypeSupportedOriginal=e.MSMediaKeys.isTypeSupported,e.MSMediaKeys.isTypeSupported=function(e){return e=e.replace("com.microsoft.playready.hardware","com.microsoft.playready"),this.isTypeSupportedOriginal(e)},e.MSMediaKeys.prototype.createSessionOriginal=e.MSMediaKeys.prototype.createSession,e.MSMediaKeys.prototype.createSession=function(e,i,a){return console.log(e,i,a),e=e.replace(/,display-res-[x|y]=\d+,display-res-[x|y]=\d+/,""),this.createSessionOriginal(e,i,a)}),e.WebKitMediaKeys&&(e.WebKitMediaKeys.isTypeSupportedOriginal=e.WebKitMediaKeys.isTypeSupported,e.WebKitMediaKeys.isTypeSupported=function(e,i){let a=this.isTypeSupportedOriginal(e,i);return console.log("Hook WebKitMediaKeys",e,i,a),a}),e.navigator.requestMediaKeySystemAccess&&(e.navigator.requestMediaKeySystemAccessOriginal=e.navigator.requestMediaKeySystemAccess,e.navigator.requestMediaKeySystemAccess=async function(i,a){let t=i;if(-1!==i.indexOf("playready"))try{return await e.navigator.requestMediaKeySystemAccessOriginal(t,a)}catch(e){console.warn("Fallback PlayReady to SL"),t="com.microsoft.playready"}for(let e=0;a.length>e;e++)if(null!=a[e].videoCapabilities)for(let i=0;a[e].videoCapabilities.length>i;i++)a[e].videoCapabilities[i].robustness;return await e.navigator.requestMediaKeySystemAccessOriginal(t,a)}),e.MediaCapabilities.prototype&&(e.MediaCapabilities.prototype.decodingInfoOriginal=e.MediaCapabilities.prototype.decodingInfo,e.MediaCapabilities.prototype.decodingInfo=function(e){let i=this.decodingInfoOriginal(e);return new Promise((e,a)=>{i.then(i=>{i.powerEfficient=i.supported,i.smooth=i.supported,e(i)}).catch(e=>{a(e)})})}),async function(){if(self.GM_registerMenuCommand&&window.MSMediaKeys){let e=""!=window.MSMediaKeys.isTypeSupportedWithFeaturesOriginal("com.microsoft.playready.hardware",'video/mp4; features="hdcp=0"'),i=""!=window.MSMediaKeys.isTypeSupportedWithFeaturesOriginal("com.microsoft.playready.hardware",'video/mp4; codecs="hev1,mp4a"; features="hdcp=0"'),a=""!=window.MSMediaKeys.isTypeSupportedWithFeaturesOriginal("com.microsoft.playready.hardware",'video/mp4; features="hdcp=1"'),t=""!=window.MSMediaKeys.isTypeSupportedWithFeaturesOriginal("com.microsoft.playready.hardware",'video/mp4; codecs="hev1,mp4a"; features="hdcp=1"'),o=""!=window.MSMediaKeys.isTypeSupportedWithFeaturesOriginal("com.microsoft.playready.hardware",'video/mp4; features="hdcp=2"'),r=""!=window.MSMediaKeys.isTypeSupportedWithFeaturesOriginal("com.microsoft.playready.hardware",'video/mp4; codecs="hev1,mp4a"; features="hdcp=2"'),d=""!=window.MSMediaKeys.isTypeSupportedWithFeaturesOriginal("com.microsoft.playready.hardware",'video/mp4; codecs="hev1,mp4a"; features="decode-res-x=3840,decode-res-y=2160,decode-bpc=10,hdcp=2"'),s=""!=window.MSMediaKeys.isTypeSupportedWithFeaturesOriginal("com.microsoft.playready.software",'video/mp4; features="hdcp=0"'),n=""!=window.MSMediaKeys.isTypeSupportedWithFeaturesOriginal("com.microsoft.playready.software",'video/mp4; codecs="hev1,mp4a"; features="hdcp=0"'),p=""!=window.MSMediaKeys.isTypeSupportedWithFeaturesOriginal("com.microsoft.playready.software",'video/mp4; features="hdcp=1"'),y=""!=window.MSMediaKeys.isTypeSupportedWithFeaturesOriginal("com.microsoft.playready.software",'video/mp4; codecs="hev1,mp4a"; features="hdcp=1"'),c=""!=window.MSMediaKeys.isTypeSupportedWithFeaturesOriginal("com.microsoft.playready.software",'video/mp4; features="hdcp=2"'),l=""!=window.MSMediaKeys.isTypeSupportedWithFeaturesOriginal("com.microsoft.playready.software",'video/mp4; codecs="hev1,mp4a"; features="hdcp=2"'),u=""!=window.MSMediaKeys.isTypeSupportedWithFeaturesOriginal("com.microsoft.playready.software",'video/mp4; codecs="hev1,mp4a"; features="decode-res-x=3840,decode-res-y=2160,decode-bpc=10,hdcp=2"'),w=function(e){return e?"✓":"✕"};GM_registerMenuCommand("PlayReady DRM Info ("+(d?"UHD Ready":"Restricted")+")",function(){let f="PlayReady DRM (without HDCP 2.2):\n";f+="Hardware: "+w(e)+"    Software: "+w(s)+"\n\n",f+="PlayReady DRM (without HDCP 2.2) with HEVC:\n",f+="Hardware: "+w(i)+"    Software: "+w(n)+"\n\n",f+="PlayReady DRM (HDCP 2.2):\n",f+="Hardware: "+w(a)+"    Software: "+w(p)+"\n\n",f+="PlayReady DRM (HDCP 2.2) with HEVC:\n",f+="Hardware: "+w(t)+"    Software: "+w(y)+"\n\n",f+="PlayReady DRM (HDCP 2.2 Type 1):\n",f+="Hardware: "+w(o)+"    Software: "+w(c)+"\n\n",f+="PlayReady DRM (HDCP 2.2 Type 1) with HEVC:\n",f+="Hardware: "+w(r)+"    Software: "+w(l)+"\n\n",f+="PlayReady DRM (HDCP 2.2 Type 1) with HEVC UHD:\n",f+="Hardware: "+w(d)+"    Software: "+w(u)+"\n\n",alert(f)})}}(),GM_registerMenuCommand("Player Info",function(){console.log("switch player info"),e.dispatchEvent(new KeyboardEvent("keydown",{keyCode:68,ctrlKey:!0,altKey:!0,shiftKey:!0}))}),GM_registerMenuCommand("Stream Selector",function(){console.log("switch player info"),e.dispatchEvent(new KeyboardEvent("keydown",{keyCode:83,ctrlKey:!0,altKey:!0,shiftKey:!0})),e.dispatchEvent(new KeyboardEvent("keydown",{keyCode:66,ctrlKey:!0,altKey:!0,shiftKey:!0}))}),GM_registerMenuCommand("Player Log",function(){console.log("switch player log"),e.dispatchEvent(new KeyboardEvent("keydown",{keyCode:76,ctrlKey:!0,altKey:!0,shiftKey:!0}))}),GM_registerMenuCommand("Load Local Subtitle (.DFXP)",function(){console.log("load local subtitle"),e.dispatchEvent(new KeyboardEvent("keydown",{keyCode:84,ctrlKey:!0,altKey:!0,shiftKey:!0}))})}();