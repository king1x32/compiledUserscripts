// ==UserScript==
// @name         Soundcloud Downloader Clean
// @namespace    https://openuserjs.org/users/webketje
// @version      1.0.0
// @author       webketje
// @license      MIT
// @icon         https://a-v2.sndcdn.com/assets/images/sc-icons/favicon-2cadd14bdb.ico
// @homepageURL  https://gist.github.com/webketje/8cd2e6ae8a86dbe0533c5d2c612c42c6
// @supportURL   https://gist.github.com/webketje/8cd2e6ae8a86dbe0533c5d2c612c42c6#comments
// @noframes
// @match        https://soundcloud.com/*
// @grant        unsafeWindow
// @require      https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js
// @downloadURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/Soundcloud20Downloader20Clean.user.js
// @updateURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/Soundcloud20Downloader20Clean.meta.js
// ==/UserScript==
!function(){"use strict";function e(){var e=(new Date).toLocaleString(),t=[].slice.call(arguments),o=["SCDLC",e,"-"].join(" ");n.debug&&console.log.apply(console,[o+t[0]].concat(t.slice(1)))}var t=unsafeWindow||window,o=".soundActions.sc-button-toolbar .sc-button-group",n={debug:!1,client_id:"",dlButtonId:"scdlc-btn",modalId:"scdl-third-party-modal"},a={en:{download:"Download",downloading:"Downloading",copy:"Copy",copy_success:"Copied to clipboard",copy_failure:"Failed to copy to clipboard!",close:"Close",modal_title:"could not download this track. Use one of these third-party services instead?"},es:{download:"Descargar",downloading:"Descargando..",copy:"Copiar",copy_success:"Copiada al portapapeles",copy_failure:"¡No se pudo copiar al portapapeles!",close:"",modal_title:"no se pudo descargar esta banda sonora. ¿Utilizar uno de estos servicios de terceros en su lugar?"},fr:{download:"Télécharger",downloading:"Téléchargement..",copy:"Copier",copy_success:"Copié dans le presse-papiers!",copy_failure:"Échec de la copie dans le presse-papiers !",close:"Fermer",modal_title:"ne peut pas télécharger ce fichier. Utiliser l’un de ces services tiers ?"},nl:{download:"Downloaden",downloading:"Downloaden..",copy:"Kopiëren",copy_success:"Naar klembord gekopieerd!",copy_failure:"Kopiëren naar klembord mislukt!",close:"Sluiten",modal_title:"kon dit bestand niet downloaden. Een van deze externe diensten gebruiken?"},de:{download:"Herunterladen",downloading:"Herunterladen..",copy:"Kopieren",copy_success:"In die Zwischenablage kopiert",copy_failure:"Kopieren in die Zwischenablage fehlgeschlagen!",close:"Schließen",modal_title:"konnte diesen Sound nicht herunterladen. Nutzen Sie stattdessen einen dieser Drittanbieterdienste?"},pl:{download:"Ściągnij",downloading:"Ściąganie..",copy:"Kopiuj",copy_success:"Skopiowano do schowka",copy_failure:"Nie udało się skopiować do schowka!!",close:"Zamknij",modal_title:"nie udało się pobrać tego utworu. Zamiast tego skorzystać z jednej z usług stron trzecich?"},it:{download:"Scaricare",downloading:"Scaricando..",copy:"Copia",copy_success:"Copiato negli appunti",copy_failure:"Impossibile copiare negli appunti!",close:"Chiudi",modal_title:"non è stato possibile scaricare questo suono. Utilizzi invece uno di questi servizi di terze parti?"},pt_BR:{download:"Baixar",downloading:"Baixando..",copy:"Copiar",copy_success:"Copiado para a área de transferência",copy_failure:"Falha ao copiar para a área de transferência!!",close:"Fechar",modal_title:"não foi possível baixar este som. Usar um desses serviços de terceiros?"},sv:{download:"Ladda ner",downloading:"Laddar ner..",copy:"Kopiera",copy_success:"Kopierat till urklipp",copy_failure:"Det gick inte att kopiera till urklipp!",close:"Stäng",modal_title:"han kunde inte ladda ner det här ljudet. Använd någon av dessa tredjepartstjänster istället?"}}[document.documentElement.lang||"en"];n.getTrackName=function(e){return[e.user.username,e.title].join(" - ")},n.getMediaURL=function(e,t,o){var a,i;e.media&&e.media.transcodings&&(a=e.media.transcodings.filter(function(e){return e.format&&"progressive"===e.format.protocol})[0])?((i=new XMLHttpRequest).onload=function(){var e;try{e=JSON.parse(i.responseText)}catch(e){}e&&e.url?t(e.url):o(!1)},i.onerror=o,i.open("GET",a.url+"?client_id="+n.client_id),i.send()):o(!1)},n.getStreamURL=function(e,t,o){var a=new XMLHttpRequest;a.onload=function(){var e=JSON.parse(a.responseText);n.getMediaURL(e,function(o){t({stream_url:o,track_name:n.getTrackName(e)})},function(){o(!1)})}.bind(this),a.onerror=function(){o(!1)},a.open("GET","https://api-v2.soundcloud.com/resolve?url="+encodeURIComponent(e)+"&client_id="+this.client_id),a.send()},n.button={download:function(e){e.preventDefault();var t=document.getElementById(n.dlButtonId);t&&(t.textContent=a.downloading),setTimeout(function(){saveAs(e.target.href,e.target.dataset.title),t&&(t.textContent=a.download)},100)},render:function(e,t,o){var i=a.download,r=document.createElement("a");return r.className="sc-button sc-button-medium sc-button-responsive sc-button-download",r.href=e,r.id=n.dlButtonId,r.textContent=i,r.title=i,r.dataset.title=t+".mp3",r.setAttribute("download",t+".mp3"),r.target="_blank",r.onclick=o,r.style.marginLeft="5px",r.style.cssFloat="left",r.style.border="1px solid orangered",r},attach:function(){var t=arguments,a=this,i=0,r=setInterval(function(){var s=document.querySelector(o);i++,s&&!document.getElementById(n.dlButtonId)?(s.insertAdjacentElement("beforeend",a.render.apply(a,t)),e("Attaching download button to element:",s),clearInterval(r)):50===i&&(e("%c Couldn't find element \""+o+'" after 2 seconds',"color: #FF0000;"),clearInterval(r))},100)},remove:function(){var e=document.getElementById(n.dlButtonId);e&&e.parentNode.removeChild(e)}},n.modal={providers:["aHR0cHM6Ly9zY2xvdWRkb3dubG9hZGVyLm5ldA==","aHR0cHM6Ly93d3cuc291bmRjbG91ZG1wMy5vcmc=","aHR0cHM6Ly9zb3VuZGNsb3VkbWUuY29t"],render:function(o){var n,i=document.createElement("div"),r=this;const s=['<div class="modal g-z-index-modal-background g-opacity-transition g-z-index-overlay modalWhiteout showBackground g-backdrop-filter-grayscale" style="outline: none; padding-right: 0px; display: flex; justify-content: center;" tabindex="-1" id="scdl-third-party-modal">','<div class="modal__modal sc-border-box g-z-index-modal-content transparentBackground" style="height: auto;">','<button type="button" title="'+a.close+'" class="modal__closeButton">'+a.close+"</button>",'<div class="modal__content"><div class="tabs"><div class="tabs__content"><div class="tabs__contentSlot" style="display: block;"><article class="shareContent">','<div class="publicShare"><section class="g-modal-section sc-clearfix sc-pt-2x">','<h2 class="sc-orange">Soundcloud Downloader Clean '+a.modal_title+"</h2>",'</section><section class="g-modal-section sc-clearfix sc-pt-2x">','<h3 style="margin-bottom: 0.5rem;">'+a.download+" <em>"+o+"</em> via: </h3>",this.providers.map(e=>['<div><a href="',t.atob(e),'" target="_blank" style="display: inline-block; font-size: 14px; padding: 0.25rem 0;">',t.atob(e),"</a></div>"].join("")).join(""),'<div class="shareLink sc-clearfix publicShare__link sc-pt-2x m-showPositionOption" style="margin-top: 1rem;">','<label for="shareLink__field" style="margin-right:0.5rem;">Link</label>','<input type="text" value="'+t.location.href+'" class="shareLink__field sc-input" id="shareLink__field" readonly="readonly">','<button class="sc-button sc-button-copy">'+a.copy+"</button>",'<span class="sc-copy-feedback" style="margin-left: 1rem;"></span>',"</div>","</section></div></article></div></div></div></div></div></div>"].join("");return i.innerHTML=s,(n=i.firstElementChild).addEventListener("click",function(o){this===o.target||o.target.classList.contains("modal__closeButton")?r.remove():o.target.classList.contains("sc-button-copy")&&navigator.clipboard.writeText(t.location.href).then(function(){n.querySelector(".sc-copy-feedback").innerHTML='<span style="color: green;">Copied to clipboard!</span>'},function(t){e("Failed to write URL to the clipboard.",t),n.querySelector(".sc-copy-feedback").innerHTML='<span style="color: red;">Failed to copy to clipboard!</span>'})}),n},attach:function(){this.remove(),document.body.appendChild(this.render.apply(this,arguments))},remove:function(){var e=document.getElementById(n.modalId);e&&e.parentNode.removeChild(e)}},n.parseClientIdFromURL=function(e){var t=/client_id=([\w\d]+)&*/;return e&&e.match(t)&&e.match(t)[1]},n.getClientID=function(e){var o,a,i;o=function(e,t){return n.parseClientIdFromURL(t)},a=e,i=t.XMLHttpRequest.prototype.open,t.XMLHttpRequest.prototype.open=function(){i.apply(this,arguments);var e=o.apply(this,arguments);e&&(t.XMLHttpRequest.prototype.open=i,a(e))}},n.load=function(o){/^(\/(you|stations|discover|stream|upload|search|settings|.+?\/sets))/.test(t.location.pathname)?n.button.remove():n.getStreamURL(o,function(t){t?(e("Detected valid Soundcloud artist track URL. Requesting info..."),n.button.attach(t.stream_url,t.track_name,n.button.download)):n.button.remove()},function(){e("%c No compatible media transcoding found.","color: #FF0000;"),n.button.attach("javascript:void(0);","None",function(){var e=document.querySelector(".soundTitle__title"),t=document.querySelector(".soundTitle__username");n.modal.attach([t.textContent.trim(),"-",e.textContent.trim()].join(" "))})})},["pushState","replaceState","forward","back","go"].forEach(function(e){var o=t.history.pushState;t.history[e]=function(){o.apply(t.history,arguments),n.load(t.location.href)}}),n.debug&&(t.scdl=n),n.getClientID(function(o){e("Found Soundcloud client id:",o,". Initializing..."),n.client_id=o,n.load(t.location.href)})}();