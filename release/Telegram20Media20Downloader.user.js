// ==UserScript==
// @name         Telegram Media Downloader
// @name:en      Telegram Media Downloader
// @version      1.210
// @namespace    https://github.com/Neet-Nestor/Telegram-Media-Downloader
// @author       Nestor Qin
// @license      GNU GPLv3
// @website      https://github.com/Neet-Nestor/Telegram-Media-Downloader
// @match        https://web.telegram.org/*
// @match        https://webk.telegram.org/*
// @match        https://webz.telegram.org/*
// @icon         https://img.icons8.com/color/452/telegram-app--v5.png
// @downloadURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/Telegram20Media20Downloader.user.js
// @updateURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/Telegram20Media20Downloader.meta.js
// ==/UserScript==
!function(){const e=(e,t=null)=>{console.log(`[Tel Download] ${t?`${t}: `:""}${e}`)},t=(e,t=null)=>{console.error(`[Tel Download] ${t?`${t}: `:""}${e}`)},o="",n=/^bytes (\d+)-(\d+)\/(\d+)$/,r=e=>{var t=0,o=e.length,n=0;if(o>0)for(;n<o;)t=(t<<5)-t+e.charCodeAt(n++)|0;return t>>>0},l=(e,t)=>{const o=document.querySelector("html").classList.contains("night")||document.querySelector("html").classList.contains("theme-dark"),n=document.getElementById("tel-downloader-progress-bar-container"),r=document.createElement("div");r.id="tel-downloader-progress-"+e,r.style.width="20rem",r.style.marginTop="0.4rem",r.style.padding="0.6rem",r.style.backgroundColor=o?"rgba(0,0,0,0.3)":"rgba(0,0,0,0.6)";const l=document.createElement("div");l.style.display="flex",l.style.justifyContent="space-between";const s=document.createElement("p");s.className="filename",s.style.margin=0,s.style.color="white",s.innerText=t;const i=document.createElement("div");i.style.cursor="pointer",i.style.fontSize="1.2rem",i.style.color=o?"#8a8a8a":"white",i.innerHTML="&times;",i.onclick=function(){n.removeChild(r)};const a=document.createElement("div");a.className="progress",a.style.backgroundColor="#e2e2e2",a.style.position="relative",a.style.width="100%",a.style.height="1.6rem",a.style.borderRadius="2rem",a.style.overflow="hidden";const c=document.createElement("p");c.style.position="absolute",c.style.zIndex=5,c.style.left="50%",c.style.top="50%",c.style.transform="translate(-50%, -50%)",c.style.margin=0,c.style.color="black";const d=document.createElement("div");d.style.position="absolute",d.style.height="100%",d.style.width="0%",d.style.backgroundColor="#6093B5",a.appendChild(c),a.appendChild(d),l.appendChild(s),l.appendChild(i),r.appendChild(l),r.appendChild(a),n.appendChild(r)},s=o=>{let s=[],i=0,a=null,c="mp4";const d=(Math.random()+1).toString(36).substring(2,10)+"_"+Date.now().toString();let u=r(o).toString(36)+"."+c;try{const e=JSON.parse(decodeURIComponent(o.split("/")[o.split("/").length-1]));e.fileName&&(u=e.fileName)}catch(e){}e(`URL: ${o}`,u);const y=r=>{fetch(o,{method:"GET",headers:{Range:`bytes=${i}-`},"User-Agent":"User-Agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/117.0"}).then(o=>{if(![200,206].includes(o.status))throw new Error("Non 200/206 response was received: "+o.status);const r=o.headers.get("Content-Type").split(";")[0];if(!r.startsWith("video/"))throw new Error("Get non video response with MIME type "+r);c=r.split("/")[1],u=u.substring(0,u.indexOf(".")+1)+c;const l=o.headers.get("Content-Range").match(n),s=parseInt(l[1]),y=parseInt(l[2]),m=parseInt(l[3]);if(s!==i)throw t("Gap detected between responses.",u),e("Last offset: "+i,u),e("New start offset "+l[1],u),"Gap detected between responses.";if(a&&m!==a)throw t("Total size differs",u),"Total size differs";return i=y+1,a=m,e(`Get response: ${o.headers.get("Content-Length")} bytes data from ${o.headers.get("Content-Range")}`,u),e(`Progress: ${(100*i/a).toFixed(0)}%`,u),((e,t,o)=>{const n=document.getElementById("tel-downloader-progress-"+e);n.querySelector("p.filename").innerText=t;const r=n.querySelector("div.progress");r.querySelector("p").innerText=o+"%",r.querySelector("div").style.width=o+"%"})(d,u,(100*i/a).toFixed(0)),o.blob()}).then(e=>{null!==r?r.write(e).then(()=>{}):s.push(e)}).then(()=>{if(!a)throw new Error("_total_size is NULL");i<a?y(r):(null!==r?r.close().then(()=>{e("Download finished",u)}):m(),(e=>{const t=document.getElementById("tel-downloader-progress-"+e).querySelector("div.progress");t.querySelector("p").innerText="Completed",t.querySelector("div").style.backgroundColor="#B6C649",t.querySelector("div").style.width="100%"})(d))}).catch(e=>{t(e,u),(e=>{const t=document.getElementById("tel-downloader-progress-"+e).querySelector("div.progress");t.querySelector("p").innerText="Aborted",t.querySelector("div").style.backgroundColor="#D16666",t.querySelector("div").style.width="100%"})(d)})},m=()=>{e("Finish downloading blobs",u),e("Concatenating blobs and downloading...",u);const t=new Blob(s,{type:"video/mp4"}),o=window.URL.createObjectURL(t);e("Final blob size: "+t.size+" bytes",u);const n=document.createElement("a");document.body.appendChild(n),n.href=o,n.download=u,n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(o),e("Download triggered",u)};"showSaveFilePicker"in unsafeWindow&&(()=>{try{return unsafeWindow.self===unsafeWindow.top}catch{return!1}})()?unsafeWindow.showSaveFilePicker({suggestedName:u}).then(e=>{e.createWritable().then(e=>{y(e),l(d)}).catch(e=>{console.error(e.name,e.message)})}).catch(e=>{"AbortError"!==e.name&&console.error(e.name,e.message)}):(y(null),l(d))},i=t=>{const o=(Math.random()+1).toString(36).substring(2,10)+".jpeg",n=document.createElement("a");document.body.appendChild(n),n.href=t,n.download=o,n.click(),document.body.removeChild(n),e("Download triggered",o)};e("Initialized"),setInterval(()=>{const e=document.getElementById("StoryViewer");if(e){console.log("storiesContainer");const t=()=>{console.log("createDownloadButton");const t=document.createElement("i");t.className="icon icon-download";const o=document.createElement("button");return o.className="Button TkphaPyQ tiny translucent-white round tel-download",o.appendChild(t),o.setAttribute("type","button"),o.setAttribute("title","Download"),o.setAttribute("aria-label","Download"),o.onclick=()=>{const t=e.querySelector("video"),o=t?.src||t?.currentSrc||t?.querySelector("source")?.src;if(o)s(o);else{const t=e.querySelectorAll("img.PVZ8TOWS");if(t.length>0){const e=t[t.length-1]?.src;e&&i(e)}}},o},o=e.querySelector(".GrsJNw3y")||e.querySelector(".DropdownMenu").parentNode;o&&!o.querySelector(".tel-download")&&(console.log("storyHeader"),o.insertBefore(t(),o.querySelector("button")))}const t=document.querySelector("#MediaViewer .MediaViewerSlide--active"),o=document.querySelector("#MediaViewer .MediaViewerActions");if(!t||!o)return;const n=t.querySelector(".MediaViewerContent > .VideoPlayer"),r=t.querySelector(".MediaViewerContent > div > img"),l=document.createElement("i");l.className="icon icon-download";const a=document.createElement("button");if(a.className="Button smaller translucent-white round tel-download",a.setAttribute("type","button"),a.setAttribute("title","Download"),a.setAttribute("aria-label","Download"),n){const e=n.querySelector("video").currentSrc;a.setAttribute("data-tel-download-url",e),a.appendChild(l),a.onclick=()=>{s(n.querySelector("video").currentSrc)};const t=n.querySelector(".VideoPlayerControls");if(t){const e=t.querySelector(".buttons");e.querySelector("button.tel-download")||e.querySelector(".spacer").after(a)}if(o.querySelector("button.tel-download")){const t=o.querySelector("button.tel-download");o.querySelectorAll('button[title="Download"]').length>1?o.querySelector("button.tel-download").remove():t.getAttribute("data-tel-download-url")!==e&&(t.onclick=()=>{s(n.querySelector("video").currentSrc)},t.setAttribute("data-tel-download-url",e))}else o.querySelector('button[title="Download"]')||o.prepend(a)}else if(r&&r.src)if(a.setAttribute("data-tel-download-url",r.src),a.appendChild(l),a.onclick=()=>{i(r.src)},o.querySelector("button.tel-download")){const e=o.querySelector("button.tel-download");o.querySelectorAll('button[title="Download"]').length>1?o.querySelector("button.tel-download").remove():e.getAttribute("data-tel-download-url")!==r.src&&(e.onclick=()=>{i(r.src)},e.setAttribute("data-tel-download-url",r.src))}else o.querySelector('button[title="Download"]')||o.prepend(a)},500),setInterval(()=>{const l=document.body.querySelector(".pinned-audio");let a,c=document.body.querySelector("._tel_download_button_pinned_container")||document.createElement("button");l&&(a=l.getAttribute("data-mid"),c.className="btn-icon tgico-download _tel_download_button_pinned_container",c.innerHTML=`<span class="tgico button-icon">${o}</span>`),document.body.querySelectorAll("audio-element").forEach(o=>{const i=o.closest(".bubble");if(i&&!i.querySelector("._tel_download_button_pinned_container")&&a&&c.getAttribute("data-mid")!==a&&o.getAttribute("data-mid")===a){c.onclick=o=>{o.stopPropagation(),d?(o=>{let l=[],s=0,i=null;const a=r(o).toString(36)+".ogg",c=r=>{fetch(o,{method:"GET",headers:{Range:`bytes=${s}-`}}).then(o=>{if(206!==o.status&&200!==o.status)return void t("Non 200/206 response was received: "+o.status,a);const r=o.headers.get("Content-Type").split(";")[0];if(!r.startsWith("audio/"))throw t("Get non audio response with MIME type "+r,a),"Get non audio response with MIME type "+r;try{const r=o.headers.get("Content-Range").match(n),l=parseInt(r[1]),a=parseInt(r[2]),c=parseInt(r[3]);if(l!==s)throw t("Gap detected between responses."),e("Last offset: "+s),e("New start offset "+r[1]),"Gap detected between responses.";if(i&&c!==i)throw t("Total size differs"),"Total size differs";s=a+1,i=c}finally{return e(`Get response: ${o.headers.get("Content-Length")} bytes data from ${o.headers.get("Content-Range")}`),o.blob()}}).then(e=>{null!==r?r.write(e).then(()=>{}):l.push(e)}).then(()=>{s<i?c(r):null!==r?r.close().then(()=>{e("Download finished",a)}):d()}).catch(e=>{t(e,a)})},d=()=>{e("Finish downloading blobs. Concatenating blobs and downloading...",a);let t=new Blob(l,{type:"audio/ogg"});const o=window.URL.createObjectURL(t);e("Final blob size in bytes: "+t.size,a),t=0;const n=document.createElement("a");document.body.appendChild(n),n.href=o,n.download=a,n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(o),e("Download triggered",a)};"showSaveFilePicker"in unsafeWindow&&(()=>{try{return unsafeWindow.self===unsafeWindow.top}catch{return!1}})()?unsafeWindow.showSaveFilePicker({suggestedName:a}).then(e=>{e.createWritable().then(e=>{c(e)}).catch(e=>{console.error(e.name,e.message)})}).catch(e=>{"AbortError"!==e.name&&console.error(e.name,e.message)}):c(null)})(i):s(i)},c.setAttribute("data-mid",a);const i=o.audio&&o.audio.getAttribute("src"),d=o.audio&&o.audio instanceof HTMLAudioElement;i&&l.querySelector(".pinned-container-wrapper-utils").appendChild(c)}});const d=document.getElementById("stories-viewer");if(d){const e=()=>{const e=document.createElement("button");return e.className="btn-icon rp tel-download",e.innerHTML=`<span class="tgico">${o}</span><div class="c-ripple"></div>`,e.setAttribute("type","button"),e.setAttribute("title","Download"),e.setAttribute("aria-label","Download"),e.onclick=()=>{const e=d.querySelector("video.media-video"),t=e?.src||e?.currentSrc||e?.querySelector("source")?.src;if(t)s(t);else{const e=d.querySelector("img.media-photo")?.src;e&&i(e)}},e},t=d.querySelector("[class^='_ViewerStoryHeaderRight']");t&&!t.querySelector(".tel-download")&&t.prepend(e());const n=d.querySelector("[class^='_ViewerStoryFooterRight']");n&&!n.querySelector(".tel-download")&&n.prepend(e())}const u=document.querySelector(".media-viewer-whole");if(!u)return;const y=u.querySelector(".media-viewer-movers .media-viewer-aspecter"),m=u.querySelector(".media-viewer-topbar .media-viewer-buttons");if(!y||!m)return;const b=m.querySelectorAll("button.btn-icon.hide");let p=null;for(const t of b)t.classList.remove("hide"),""===t.textContent&&t.classList.add("tgico-forward"),t.textContent===o&&(t.classList.add("tgico-download"),p=()=>{t.click()},e("onDownload",p));if(y.querySelector(".ckin__player")){const e=y.querySelector(".default__controls.ckin__controls");if(e&&!e.querySelector(".tel-download")){const t=e.querySelector(".bottom-controls .right-controls"),n=document.createElement("button");n.className="btn-icon default__button tgico-download tel-download",n.innerHTML=`<span class="tgico">${o}</span>`,n.setAttribute("type","button"),n.setAttribute("title","Download"),n.setAttribute("aria-label","Download"),n.onclick=p||(()=>{s(y.querySelector("video").src)}),t.prepend(n)}}else if(y.querySelector("video")&&y.querySelector("video")&&!m.querySelector("button.btn-icon.tgico-download")){const e=document.createElement("button");e.className="btn-icon tgico-download tel-download",e.innerHTML=`<span class="tgico button-icon">${o}</span>`,e.setAttribute("type","button"),e.setAttribute("title","Download"),e.setAttribute("aria-label","Download"),e.onclick=p||(()=>{s(y.querySelector("video").src)}),m.prepend(e)}else if(!m.querySelector("button.btn-icon.tgico-download")){if(!y.querySelector("img.thumbnail")||!y.querySelector("img.thumbnail").src)return;const e=document.createElement("button");e.className="btn-icon tgico-download tel-download",e.innerHTML=`<span class="tgico button-icon">${o}</span>`,e.setAttribute("type","button"),e.setAttribute("title","Download"),e.setAttribute("aria-label","Download"),e.onclick=p||(()=>{i(y.querySelector("img.thumbnail").src)}),m.prepend(e)}},500),function(){const e=document.querySelector("body"),t=document.createElement("div");t.id="tel-downloader-progress-bar-container",t.style.position="fixed",t.style.bottom=0,t.style.right=0,location.pathname.startsWith("/k/")?t.style.zIndex=4:t.style.zIndex=1600,e.appendChild(t)}(),e("Completed script setup.")}();