// ==UserScript==
// @name                YouTube Direct Downloader
// @version             4.5
// @author              FawayTT
// @namespace           FawayTT
// @supportURL          https://github.com/FawayTT/userscripts/issues
// @icon                https://github.com/FawayTT/userscripts/blob/main/ydd-icon.png?raw=true
// @match               *://www.youtube.com/*
// @match               *://yt5s.biz/*
// @match               *://cobalt.tools/*
// @match               *://5smp3.com/*
// @match               *://*.yt1s.biz/*
// @connect             cobalt-api.kwiatekmiki.com
// @require             https://openuserjs.org/src/libs/sizzle/GM_config.js
// @grant               GM_getValue
// @grant               GM_setValue
// @grant               GM_registerMenuCommand
// @grant               GM_openInTab
// @grant               GM_xmlhttpRequest
// @license             MIT
// @run-at              document-end
// @downloadURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/YouTube20Direct20Downloader.user.js
// @updateURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/YouTube20Direct20Downloader.meta.js
// ==/UserScript==
function n(){w.open()}function t(){const n=navigator.userAgent,t=window.location.href,e=window.location.origin;return{"User-Agent":n,Accept:"application/json","Content-Type":"application/json","Accept-Language":navigator.languages,Referer:t,Origin:e}}function e(n,t){const e=w.get("backupService")||u;if(!w.get("showCobaltError")&&"cobalt_api"!==e)return void o(t,e);let i="Cobalt error: "+(n||"Something went wrong! Try again later.");"none"!==e&&"cobalt_api"!==e?(i+="\n\nYou will be redirected to backup provider "+e+".",alert(i),o(t,e)):alert(i)}function o(n,o){switch(o||(o=w.get("downloadService")),o){case"yt5s":GM_setValue("yt5sUrl",document.location.href),n?window.open("https://5smp3.com/watch"):window.open("https://yt5s.biz/");break;case"yt1s":GM_setValue("yt1sUrl",document.location.href),n?window.open("https://5smp3.com/watch"):window.open("https://yt1s.biz/");break;case"cobalt_web":GM_setValue("cobaltUrl",document.location.href),GM_setValue("cobaltUrlAudioOnly",n),window.open("https://cobalt.tools/");break;default:if(g)return e(g,n);GM_xmlhttpRequest({method:"POST",url:"https://cobalt-api.kwiatekmiki.com",headers:t(),data:JSON.stringify({url:encodeURI(document.location.href),videoQuality:w.get("quality"),youtubeVideoCodec:w.get("vCodec"),audioFormat:w.get("aFormat"),filenameStyle:w.get("filenamePattern"),disableMetadata:w.get("disableMetadata"),downloadMode:n?"audio":w.get("isAudioMuted")?"muted":"auto"}),onload:t=>{const o=t.responseText&&JSON.parse(t.responseText);200===t.status?o.url?window.open(o.url):e("Cobalt is not sending expected response.",n):403===t.status?e("Cobalt is blocking your request with Bot Protection.",n):e(`Something went wrong! Try again later. (${o.error.code||o.text||o.statusText||""})`,n)},onerror:function(t){e(t.message||t,n)},ontimeout:function(){e("Cobalt is not responding. Please try again later.",n)}}),clearTimeout(y),g="Slow down.",y=setTimeout(()=>{g=null},5e3)}}function i(){const n=document.querySelectorAll("#ydd-button");0!==n.length&&n.forEach(n=>{n.remove()})}function a(n){n.classList.remove("ydd-scale-up"),n.classList.add("ydd-scale-down"),setTimeout(()=>{n.remove()},400)}function r(t,e){if(!t)return;const i=document.createElement("div"),r=document.createElement("button"),c=document.createElement("div");switch(i.id="ydd-button",r.id="ydd-download",c.id="ydd-options",i.appendChild(r),i.appendChild(c),e?(i.style.marginTop="10px",i.style.marginLeft="0px",t.insertBefore(i,t.firstChild)):t.appendChild(i),w.get("downloadService")||p){case"yt5s":r.title="YT5S";break;case"cobalt_web":r.title="Cobalt";break;case"cobalt_api":{const n=`${w.get("quality")||f}, ${w.get("vCodec")||b}`;r.title="Cobalt: "+n.toUpperCase();break}default:r.title="YDD"}r.innerText="â‡©",c.innerText="â˜°",r.addEventListener("click",()=>{o()}),r.addEventListener("contextmenu",()=>{const n=w.get("downloadService")||p,t=w.get("backupService")||u;n!==t&&"none"!==t&&o(!1,t)}),c.addEventListener("click",()=>{!function(t){let e=document.getElementById("ydd-options-div");if(e)return void a(e);e=document.createElement("div");const i=document.createElement("div"),r=document.createElement("div"),c=document.createElement("div");i.innerText="ðŸ”Š Audio",r.innerText="ðŸ–¹ Subtitles",c.innerText="â›­ Settings",e.id="ydd-options-div",e.appendChild(i),e.appendChild(r),e.appendChild(c),t.appendChild(e),e.style.opacity=void 0,e.classList.add("ydd-scale-up"),c.addEventListener("click",()=>{n(),a(e)}),i.addEventListener("click",()=>{o(!0),a(e)}),r.addEventListener("click",()=>{window.open(`https://downsub.com/?url=${document.location.href}`),a(e)}),window.addEventListener("click",n=>{t.contains(n.target)||a(e)})}(i)})}function c(n,t){Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value").set.call(n,t),n.dispatchEvent(new Event("input",{bubbles:!0}))}function l(){h++,_=h>10}function s(n){switch(n?w.get("backupService"):w.get("downloadService")){case"cobalt_web":if(document.location.href.indexOf("cobalt.tools")>-1){const n=GM_getValue("cobaltUrl"),t=GM_getValue("cobaltUrlAudioOnly");if(n){GM_setValue("cobaltUrl",void 0),GM_setValue("cobaltUrlAudioOnly",void 0);const e=document.querySelector("#link-area"),o=t?document.querySelector("#setting-button-save-downloadMode-audio"):document.querySelector("#setting-button-save-downloadMode-auto"),i=document.querySelector("#input-icons");if(e&&o&&i){_=!0,c(e,n),o.click();const t=new MutationObserver(function(){!i.classList.contains("loading")&&i&&(document.querySelector("#download-button").click(),t.disconnect())});t.observe(i,{attributes:!0,attributeFilter:["class"]})}else l()}return!0}return!1;case"yt5s":if(document.location.href.indexOf("yt5s.biz")>-1){const n=GM_getValue("yt5sUrl");if(n){GM_setValue("yt5sUrl",void 0);const t=document.querySelector("#txt-url"),e=document.querySelector("#btn-submit");t&&e?(_=!0,c(t,n),e.click()):l()}return!0}if(document.location.href.indexOf("5smp3.com")>-1){const n=GM_getValue("yt5sUrl");if(n){GM_setValue("yt5sUrl",void 0);const t=document.querySelector("#inputUrl"),e=document.querySelector(".btn-icon.rounded-pill");t&&e?(_=!0,t.value=n,e.click()):l()}return!0}return!1;case"yt1s":if(document.location.href.indexOf("yt1s.biz")>-1){const n=GM_getValue("yt1sUrl");if(n){GM_setValue("yt1sUrl",void 0);const t=document.querySelector(".index-module--search--fb2ee");t?(_=!0,c(t,n)):l()}return!0}return!1;default:return!1}}function d(){const n=function(n=!0){return document.location.href.indexOf("youtube.com/shorts")>-1&&(w.get("redirectShorts")&&n&&window.location.replace(window.location.toString().replace("/shorts/","/watch?v=")),!0)}();if(!s()&&!s(!0))if(-1!==document.location.href.indexOf("youtube.com/watch")||n)if(n){const n=document.querySelectorAll("#actions");if(n.length<=1)return void(_=!1);i(),n.forEach(n=>{r(n,!0)}),_=!0}else{const n=document.getElementById("owner");if(!n)return void(_=!1);i(),r(n,!1),_=!0}else _=!0}GM_registerMenuCommand("Settings",n);const p="yt5s",u="yt1s",f="max",b="av1";let m=document.createElement("div");document.body.appendChild(m);let g,y,h=0,x=!1,w=new GM_config({id:"YDD_config",title:"YouTube Direct Downloader (YDD) - Settings",css:'\n #YDD_config {\n  background-color: rgba(0, 0, 0, 0.8) !important;\n  backdrop-filter: blur(10px);\n  color: #fff !important;\n  border-radius: 30px !important;\n  padding: 20px !important;\n  height: fit-content !important;\n  max-width: 700px !important;\n  font-family: Arial, sans-serif !important;\n  z-index: 9999999 !important;\n  padding-bottom: 0px !important;\n  width: 100% !important;\n}\n\n#YDD_config_header {\n  background-color: #ff000052 !important;\n  border-radius: 10px;\n  padding: 10px !important;\n  text-align: center !important;\n  font-size: 24px !important;\n  color: blob !important;\n  font-weight: 600 !important;\n}\n\n.section_header_holder {\n  font-weight: 600;\n  margin-top: 10px !important;\n}\n\n#YDD_config_buttons_holder {\n  text-align: center;\n  margin-top: 20px;\n}\n\n#YDD_config_resetLink {\n  color: #fff !important;\n}\n\n.config_var {\n  margin: 0px !important;\n  line-height: 3;\n}\n\n#YDD_config_buttons_holder button {\n  background-color: #ff000052 !important;\n  color: #fff;\n  border: none;\n  font-weight: 600;\n  padding: 10px 20px !important;\n  border-radius: 10px;\n  font-size: 14px;\n  cursor: pointer;\n  transition: background-color 0.1s ease-in;\n}\n\n#YDD_config_buttons_holder button:hover {\n  background-color: #ff0000 !important;\n}\n\n#YDD_config_fieldset {\n  border: 1px solid #444;\n  padding: 10px;\n  border-radius: 5px;\n  margin-top: 10px;\n}\n\n#YDD_config_fieldset legend {\n  color: #ff0000;\n}\n\n #YDD_config .section_header {\n  background: none !important;\n  width: fit-content;\n  margin: 5px 0px !important;\n  border: none !important;\n  font-size: 18px !important;\n  color: #ff0000 !important;\n}\n\n #YDD_config input, select, textarea {\n  cursor: pointer;\n  background-color: #333;\n  color: #fff;\n  border: 1px solid #555;\n  border-radius: 10px;\n  padding: 5px;\n  margin: 5px 0 !important;\n}\n\n #YDD_config ::selection {\n  color: white;\n  background: #ff0000;\n}\n\n #YDD_config input, select, textarea {\n  transition: all 0.1s ease-in;\n}\n\n #YDD_config input:focus, select:focus, textarea:focus {\n  border-color: #ff0000;\n}\n\n #YDD_config input:hover, select:hover, textarea:hover {\n  opacity: 0.8;\n}\n\n #YDD_config label {\n  color: #fff;\n}\n\n#YDD_config_buttons_holder {\n  position: relative;\n  margin-top: 0px !important;\n  display: flex;\n  justify-content: center;\n  align-items: baseline;\n}\n\n.reset_holder {\n  position: absolute;\n  top: 50%;\n  transform: translateY(-50%);\n  right: 0;\n  padding: 10px;\n}\n\ninput[type=\'checkbox\'] {\n  appearance: none;\n  position: absolute;\n  width: 20px;\n  transform: translateY(3px);\n  height: 20px;\n  border: 1px solid #555;\n  border-radius: 10px;\n  background-color: #333;\n  cursor: pointer;\n}\n\ninput[type=\'checkbox\']:before {\n  content: " ";\n}\n\ninput[type=\'checkbox\']:checked {\n  background-color: #d50707;\n}\n\ninput[type=\'checkbox\']:checked::after {\n  content: "";\n  position: absolute;\n  top: 3px;\n  left: 2px;\n  width: 12px;\n  height: 6px;\n  border-bottom: 2px solid #ffffff;\n  border-left: 2px solid #ffffff;\n  transform: rotate(-45deg);\n}\n\n#YDD_config_downloadService_var:after {\n  content: "â–² Use cobalt_api for direct download (hosted by third party and can easily run out of bandwidth).";\n  display: block;\n  font-family: arial, tahoma, myriad pro, sans-serif;\n  font-size: 10px;\n  font-weight: bold;\n  margin-right: 6px;\n  opacity: 0.7;\n}\n\n#YDD_config_vCodec_var:after {\n  content: "â–² H264 [MP4] = best compatibility. VP9 [WEBM] = better quality. AV1 = best quality but is used only by few videos.";\n  display: block;\n  font-family: arial, tahoma, myriad pro, sans-serif;\n  font-size: 10px;\n  font-weight: bold;\n  margin-right: 6px;\n  opacity: 0.7;\n}\n\n#YDD_config_backupService_var:after {\n  content: "â–² Available via right click or used automatically when direct download is not working.";\n  display: block;\n  font-family: arial, tahoma, myriad pro, sans-serif;\n  font-size: 10px;\n  font-weight: bold;\n  margin-right: 6px;\n  opacity: 0.7;\n}\n',frame:m,fields:{downloadService:{section:["Download method"],label:"Main service:",labelPos:"left",type:"select",default:p,options:["cobalt_web","cobalt_api","yt5s","yt1s"]},backupService:{label:"Backup service:",type:"select",default:u,options:["cobalt_web","cobalt_api","yt5s","yt1s","none"]},quality:{section:["Cobalt API settings"],label:"Quality:",labelPos:"left",type:"select",default:f,options:["max","2160","1440","1080","720","480","360","240","144"]},vCodec:{label:"Video codec:",labelPos:"left",type:"select",default:b,options:["h264","vp9","av1"]},aFormat:{label:"Audio format:",type:"select",default:"mp3",options:["best","mp3","ogg","wav","opus"]},isAudioMuted:{label:"Download videos without audio:",type:"checkbox",default:!1},disableMetadata:{label:"Download videos without metadata:",type:"checkbox",default:!1},filenamePattern:{label:"Filename pattern:",type:"select",default:"basic",options:["classic","pretty","basic","nerdy"]},showCobaltError:{label:"Show error messages:",type:"checkbox",default:!1},redirectShorts:{section:["Extra features"],label:"Redirect shorts:",labelPos:"left",type:"checkbox",default:!1},url:{section:["Links"],label:"Github script page",type:"button",click:()=>{GM_openInTab("https://github.com/FawayTT/userscripts")}},cobaltUrl:{label:"Cobalt github page",type:"button",click:()=>{GM_openInTab("https://github.com/imputnet/cobalt")}},cobaltInstance:{label:"Cobalt instance provider",type:"button",click:()=>{GM_openInTab("kwiatekmiki.com")}}},events:{save:function(){w.close(),i(),d()},init:function(){!function(){const n=document.createElement("style");n.innerHTML='\n#experiment-overlay {\n  overflow: visible !important;\n}\n\n#ydd-button {\n  position: relative;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  background: rgba(255, 255, 255, 0.15);\n  border-radius: 15px;\n  margin-left: 8px;\n  box-shadow: 1px 0px 7px -4px rgba(0, 0, 0, 0.8);\n}\n\n#ydd-download {\n  position: relative;\n  z-index: 10;\n  cursor: pointer;\n  font-size: 2rem;\n  padding: 8px 12px;\n  border: none;\n  border-radius: 15px;\n  line-height: 2rem;\n  font-weight: 500;\n  color: #0f0f0f;\n  background-color: #f1f1f1;\n  font-family: "Roboto","Arial",sans-serif;\n  align-items: center;\n  text-transform: capitalize;\n}\n\n#ydd-download:hover {\n  filter: brightness(90%);\n}\n\n#ydd-options {\n  line-height: 2rem;\n  font-weight: 500;\n  color: var(--yt-spec-text-primary);\n  margin: 0px 5px;\n  cursor: pointer;\n  font-family: "Roboto","Arial",sans-serif;\n  transition: all 0.1s ease-in;\n}\n\n#ydd-options:hover {\n  scale: 1.4;\n}\n\n#ydd-options-div {\n  transition: transform 0.3s ease, opacity 0.1s ease;\n  position: absolute;\n  top: 0px;\n  transform: translateY(-70%);\n  right: -24px;\n  background: rgba(255, 255, 255, 0.9);\n  backdrop-filter: blur(10px);\n  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);\n  border-radius: 15px;\n  margin-right: 8px;\n  margin-top: 6px;\n  padding: 6px;\n  display: flex;\n  flex-direction: column;\n  z-index: 9999999;\n  font-family: "Roboto","Arial",sans-serif;\n  font-weight: 500;\n  font-size: 1.2rem;\n  line-height: 2rem;\n  color: black;\n  align-items: start;\n  white-space: nowrap;\n}\n\n#ydd-options-div > * {\n  margin: 6px;\n  cursor: pointer;\n  transition: all 0.1s ease-in;\n}\n\n#ydd-options-div > *:hover {\n  scale: 1.1;\n}\n\n@keyframes scaleIn {\n  0% {\n    transform: scale(0.8) translateY(-20%);\n    opacity: 0;\n  }\n  100% {\n    transform: scale(1) translateY(-10%);\n    opacity: 1;\n  }\n}\n\n@keyframes scaleOut {\n  0% {\n    transform: scale(1) translateY(-10%);\n    opacity: 1;\n  }\n  100% {\n    transform: scale(0.8) translateY(-20%);\n    opacity: 0;\n  }\n}\n\n.ydd-scale-up {\n  animation: scaleIn 0.3s forwards;\n}\n\n.ydd-scale-down {\n  animation: scaleOut 0.3s forwards;\n}\n',document.head.appendChild(n)}(),new MutationObserver(function(){if(x=!0,!_)return d();v!=document.location.href&&(v=document.location.href,_=!1)}).observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>{x||d()},500)}}}),v=document.location.href,_=!1;if(window.trustedTypes&&window.trustedTypes.createPolicy)try{window.trustedTypes.createPolicy("default",{createHTML:n=>n})}catch{console.warn("Trusted Types: Default policy already exists.")}