// ==UserScript==
// @name         TwitchAdSolutions (vaft)
// @namespace    https://github.com/pixeltris/TwitchAdSolutions
// @version      28.0.0
// @updateURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/vaft.meta.js
// @downloadURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/vaft.user.js
// @author       https://github.com/cleanlock/VideoAdBlockForTwitch#credits
// @match        *://*.twitch.tv/*
// @run-at       document-start
// @inject-into  page
// @grant        none
// ==/UserScript==
!function(){"use strict";function e(e){e.AdSignifier="stitched",e.ClientID="kimne78kx3ncx6brgo4mv6wki5h1ko",e.BackupPlayerTypes=["embed","site","autoplay"],e.FallbackPlayerType="embed",e.ForceAccessTokenPlayerType="site",e.SkipPlayerReloadOnHevc=!1,e.AlwaysReloadPlayerOnAd=!1,e.PlayerReloadLowResTime=1500,e.StreamInfos=[],e.StreamInfosByUrl=[],e.GQLDeviceID=null,e.ClientVersion=null,e.ClientSession=null,e.ClientIntegrityHeader=null,e.AuthorizationHeader=void 0,e.SimulatedAdsDepth=0,e.IsPlayerBuffering=!1,e.LastPausePlay=0,e.FixPlayerBufferingInsideAds=!0,e.FixPlayerBufferingOutsideAds=!1,e.DelayBetweenEachPlayerFixBufferAttempt=3e3,e.ActiveStreamInfo=null,e.V2API=!1}function t(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.overrideMimeType("text/javascript"),t.send(),t.responseText}function n(){console.log("hookWorkerFetch (vaft)");var e=fetch;fetch=async function(t,n){var s,o;if("string"==typeof t){if((t=t.trimEnd()).endsWith("m3u8"))return new Promise(function(a,i){e(t,n).then(function(n){!async function(n){200===n.status?a(new Response(await r(t,await n.text(),e))):a(n)}(n)}).catch(function(e){i(e)})});if(t.includes("/channel/hls/")&&!t.includes("picture-by-picture"))return V2API=t.includes("/api/v2/"),s=new URL(t).pathname.match(/([^\/]+)(?=\.\w+$)/)[0],ForceAccessTokenPlayerType&&((o=new URL(t)).searchParams.delete("parent_domains"),t=o.toString()),new Promise(function(o,r){e(t,n).then(function(n){!async function(n){var r,d,c,u,p,y,f,g,h,m,v,S,I,A;if(200==n.status){if(d=a(r=await n.text()),null!=(c=StreamInfos[s])&&null!=c.EncodingsM3U8&&200!==(await e(c.EncodingsM3U8.match(/^https:.*\.m3u8$/m)[0])).status&&(c=null),null==c||null==c.EncodingsM3U8){for(StreamInfos[s]=c={ChannelName:s,IsShowingAd:!1,AdStartTime:0,EncodingsM3U8:r,ModifiedM3U8:null,IsUsingModifiedM3U8:!1,UsherParams:new URL(t).search,RequestedAds:new Set,Urls:[],ResolutionList:[],BackupEncodingsM3U8Cache:[],ActiveBackupPlayerType:null,IsMidroll:!1},u=r.replace("\r","").split("\n"),p=0;p<u.length-1;p++)u[p].startsWith("#EXT-X-STREAM-INF")&&u[p+1].includes(".m3u8")&&((f=(y=l(u[p])).RESOLUTION)&&(g={Resolution:f,FrameRate:y["FRAME-RATE"],Codecs:y.CODECS,Url:u[p+1]},c.Urls[u[p+1]]=g,c.ResolutionList.push(g)),StreamInfosByUrl[u[p+1]]=c);if(h=c.ResolutionList.filter(e=>e.Codecs.startsWith("avc")||e.Codecs.startsWith("av0")),AlwaysReloadPlayerOnAd||h.length>0&&c.ResolutionList.some(e=>e.Codecs.startsWith("hev")||e.Codecs.startsWith("hvc"))&&!SkipPlayerReloadOnHevc){if(h.length>0)for(p=0;p<u.length-1;p++)if(u[p].startsWith("#EXT-X-STREAM-INF")){const e="CODECS";if((m=l(u[p].substring(u[p].indexOf(":")+1)))[e].startsWith("hev")||m[e].startsWith("hvc")){v=m.RESOLUTION;const[t,n]=v.split("x").map(Number);S=h.sort((e,a)=>{const[i,s]=e.Resolution.split("x").map(Number),[o,r]=a.Resolution.split("x").map(Number);return Math.abs(i*s-t*n)-Math.abs(o*r-t*n)})[0],console.log("ModifiedM3U8 swap "+m[e]+" to "+S.Codecs+" oldRes:"+v+" newRes:"+S.Resolution),u[p]=u[p].replace(/CODECS="[^"]+"/,`CODECS="${S.Codecs}"`),u[p+1]=S.Url+" ".repeat(p+1)}}(h.length>0||AlwaysReloadPlayerOnAd)&&(c.ModifiedM3U8=u.join("\n"),I=c.EncodingsM3U8.match(/^https:.*\.m3u8$/m)[0],200==(A=await e(I)).status&&((await A.text()).includes(AdSignifier)||SimulatedAdsDepth>0)&&(c.IsUsingModifiedM3U8=!0))}}else c.IsUsingModifiedM3U8=c.IsShowingAd&&c.ModifiedM3U8;o(new Response(i(c.IsUsingModifiedM3U8?c.ModifiedM3U8:c.EncodingsM3U8,d)))}else o(n)}(n)}).catch(function(e){r(e)})})}return e.apply(this,arguments)}}function a(e){var t;return V2API?(t=e.match(/#EXT-X-SESSION-DATA:DATA-ID="SERVER-TIME",VALUE="([^"]+)"/)).length>1?t[1]:null:(t=e.match('SERVER-TIME="([0-9.]+)"')).length>1?t[1]:null}function i(e,t){return V2API?t?e.replace(/(#EXT-X-SESSION-DATA:DATA-ID="SERVER-TIME",VALUE=")[^"]+(")/,`$1${t}$2`):e:t?e.replace(new RegExp('(SERVER-TIME=")[0-9.]+"'),`SERVER-TIME="${t}"`):e}function s(e,t){var n,a,i,s,o,r,d,c,u,p=e.replace("\r","").split("\n");const[y,f]=t.Resolution.split("x").map(Number);for(n=null,a=!1,i=null,s=1/0,o=0;o<p.length-1;o++)if(p[o].startsWith("#EXT-X-STREAM-INF")&&p[o+1].includes(".m3u8")&&(d=(r=l(p[o])).RESOLUTION,c=r["FRAME-RATE"],d)){if(d==t.Resolution&&(!n||!a&&c==t.FrameRate)&&(n=p[o+1],a=c==t.FrameRate))return n;const[e,r]=d.split("x").map(Number);(u=Math.abs(e*r-y*f))<s&&(i=p[o+1],s=u)}return i}function o(){IsPlayerBuffering&&LastPausePlay<Date.now()-DelayBetweenEachPlayerFixBufferAttempt&&ActiveStreamInfo&&(ActiveStreamInfo.IsShowingAd&&FixPlayerBufferingInsideAds||!ActiveStreamInfo.IsShowingAd&&FixPlayerBufferingOutsideAds)&&(console.log("Attempting to fix player buffering by doing pause/play"),LastPausePlay=Date.now(),postMessage({key:"PauseResumePlayer"}))}async function r(e,t,n){var a,i,r,l,c,u,p,y,f,g,h,m,v,S,I,A,w,k,P,b=StreamInfosByUrl[e];if(!b)return t;if(ActiveStreamInfo=b,t.includes(AdSignifier)||SimulatedAdsDepth>0){if(b.IsMidroll=t.includes('"MIDROLL"')||t.includes('"midroll"'),!b.IsMidroll)for(a=t.replace("\r","").split("\n"),i=0;i<a.length;i++)if((r=a[i]).startsWith("#EXTINF")&&a.length>i+1&&!r.includes(",live")&&!b.RequestedAds.has(a[i+1])){b.RequestedAds.add(a[i+1]),fetch(a[i+1]).then(e=>{e.blob()});break}if(b.Resolution,!(l=b.Urls[e]))return console.log("Ads will leak due to missing resolution info for "+e),t;for(b.ModifiedM3U8&&!b.IsUsingModifiedM3U8&&(b.AdStartTime=Date.now()),b.IsShowingAd||(b.AdStartTime=Date.now(),b.IsShowingAd=!0,b.ModifiedM3U8&&!b.IsUsingModifiedM3U8&&postMessage({key:"ReloadPlayer"}),postMessage({key:"ShowAdBlockBanner",isMidroll:b.IsMidroll})),c=null,u=null,p=null,y=0,(b.ModifiedM3U8&&!b.IsUsingModifiedM3U8||b.ModifiedM3U8&&b.AdStartTime>Date.now()-PlayerReloadLowResTime)&&(y=BackupPlayerTypes.length-1),f=y;!u&&f<BackupPlayerTypes.length;f++)for(g=BackupPlayerTypes[f],i=0;i<2;i++){if(h=!1,!(m=b.BackupEncodingsM3U8Cache[g])){h=!0;try{200===(v=await d(b.ChannelName,g)).status&&(S=await v.json(),(I=new URL("https://usher.ttvnw.net/api/"+(V2API?"v2/":"")+"channel/hls/"+b.ChannelName+".m3u8"+b.UsherParams)).searchParams.set("sig",S.data.streamPlaybackAccessToken.signature),I.searchParams.set("token",S.data.streamPlaybackAccessToken.value),200===(A=await n(I.href)).status&&(m=b.BackupEncodingsM3U8Cache[g]=await A.text()))}catch(e){}}if(m)try{if(w=s(m,l),200==(k=await n(w)).status&&(P=await k.text())&&(g==FallbackPlayerType&&(p=P),!P.includes(AdSignifier)&&(0==SimulatedAdsDepth||f>=SimulatedAdsDepth-1))){c=g,u=P;break}}catch(e){}if(0!=y)break;if(b.BackupEncodingsM3U8Cache[g]=null,h)break}!u&&p&&(c=FallbackPlayerType,u=p),u&&(t=u,b.ActiveBackupPlayerType!=c&&(b.ActiveBackupPlayerType=c,console.log(`Blocking${b.IsMidroll?" midroll ":" "}ads (${c})`)))}else b.IsShowingAd&&(console.log("Finished blocking ads"),b.IsShowingAd=!1,b.ActiveBackupPlayerType=null,postMessage({key:b.IsUsingModifiedM3U8?"ReloadPlayer":"PauseResumePlayer"}),postMessage({key:"HideAdBlockBanner"}));return o(),t}function l(e){return Object.fromEntries(e.split(/(?:^|,)((?:[^=]*)=(?:"[^"]*"|[^,]*))/).filter(Boolean).map(e=>{const t=e.indexOf("="),n=e.substring(0,t),a=e.substring(t+1),i=Number(a);return[n,Number.isNaN(i)?a.startsWith('"')?JSON.parse(a):a:i]}))}function d(e,t){return c({operationName:"PlaybackAccessToken_Template",query:'query PlaybackAccessToken_Template($login: String!, $isLive: Boolean!, $vodID: ID!, $isVod: Boolean!, $playerType: String!) {  streamPlaybackAccessToken(channelName: $login, params: {platform: "android", playerBackend: "mediaplayer", playerType: $playerType}) @include(if: $isLive) {    value    signature    __typename  }  videoPlaybackAccessToken(id: $vodID, params: {platform: "android", playerBackend: "mediaplayer", playerType: $playerType}) @include(if: $isVod) {    value    signature    __typename  }}',variables:{isLive:!0,login:e,isVod:!1,vodID:"",playerType:t}})}function c(e){var t,n;if(!GQLDeviceID)for(t=0;t<32;t++)GQLDeviceID+="abcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(36*Math.random()));return n={"Client-ID":ClientID,"Device-ID":GQLDeviceID,"X-Device-Id":GQLDeviceID,Authorization:AuthorizationHeader,...ClientIntegrityHeader&&{"Client-Integrity":ClientIntegrityHeader},...ClientVersion&&{"Client-Version":ClientVersion},...ClientSession&&{"Client-Session-Id":ClientSession}},new Promise((t,a)=>{const i=Math.random().toString(36).substring(2,15),s={id:i,url:"https://gql.twitch.tv/gql",options:{method:"POST",body:JSON.stringify(e),headers:n}};pendingFetchRequests.set(i,{resolve:t,reject:a}),postMessage({key:"FetchRequest",value:s})})}function u(e,t){function n(e,t){if(e.stateNode&&t(e.stateNode))return e.stateNode;let a=e.child;for(;a;){const e=n(a,t);if(e)return e;a=a.sibling}return null}var a,i,s,o,r,l=function(){var e,t=null,n=document.querySelector("#root");return n&&n._reactRootContainer&&n._reactRootContainer._internalRoot&&n._reactRootContainer._internalRoot.current&&(t=n._reactRootContainer._internalRoot.current),null==t&&null!=(e=Object.keys(n).find(e=>e.startsWith("__reactContainer")))&&(t=n[e]),t}();if(l)if(a=(a=n(l,e=>e.setPlayerActive&&e.props&&e.props.mediaPlayerInstance))&&a.props&&a.props.mediaPlayerInstance?a.props.mediaPlayerInstance:null,i=n(l,e=>e.setSrc&&e.setInitialPlaybackSettings),a)if(i){if(!a.paused&&!a.core?.paused){if(e)return a.pause(),void a.play();if(t){const e="video-quality",t="video-muted",n="volume";return s=localStorage.getItem(e),o=localStorage.getItem(t),r=localStorage.getItem(n),f&&a?.core?.state&&(localStorage.setItem(t,JSON.stringify({default:a.core.state.muted})),localStorage.setItem(n,a.core.state.volume)),f&&a?.core?.state?.quality?.group&&localStorage.setItem(e,JSON.stringify({default:a.core.state.quality.group})),i.setSrc({isNewMediaPlayerInstance:!0,refreshAccessToken:!0}),a.play(),void(f&&setTimeout(()=>{localStorage.setItem(e,s),localStorage.setItem(t,o),localStorage.setItem(n,r)},3e3))}}}else console.log("Could not find player state");else console.log("Could not find player");else console.log("Could not find react root")}function p(e,t){g.forEach(n=>{n.postMessage({key:e,value:t})})}function y(){var e,t,n,a,i,s,o;try{Object.defineProperty(document,"visibilityState",{get:()=>"visible"})}catch{}let r=document.__lookupGetter__("hidden"),l=document.__lookupGetter__("webkitHidden");try{Object.defineProperty(document,"hidden",{get:()=>!1})}catch{}e=e=>{e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation()};let d=!0;t=t=>{if("undefined"!=typeof chrome){const e=document.getElementsByTagName("video");e.length>0&&(!0===r.apply(document)||l&&!0===l.apply(document)?d=!e[0].paused&&!e[0].ended:d&&!e[0].ended&&e[0].paused&&e[0].muted&&e[0].play())}e(t)},document.addEventListener("visibilitychange",t,!0),document.addEventListener("webkitvisibilitychange",t,!0),document.addEventListener("mozvisibilitychange",t,!0),document.addEventListener("hasFocus",e,!0);try{/Firefox/.test(navigator.userAgent)?Object.defineProperty(document,"mozHidden",{get:()=>!1}):Object.defineProperty(document,"webkitHidden",{get:()=>!1})}catch{}for(n=["video-quality","video-muted","volume","lowLatencyModeEnabled","persistenceEnabled"],a=new Map,i=0;i<n.length;i++)a.set(n[i],localStorage.getItem(n[i]));s=localStorage.setItem,localStorage.setItem=function(e,t){a.has(e)&&a.set(e,t),s.apply(this,arguments)},o=localStorage.getItem,localStorage.getItem=function(e){return a.has(e)?a.get(e):o.apply(this,arguments)},localStorage.getItem.toString().includes(Object.keys({cachedValues:a})[0])||(f=!0)}var f,g,h,m,v,S,I,A,w,k;if(void 0!==window.twitchAdSolutionsVersion&&window.twitchAdSolutionsVersion>=15)return console.log("skipping vaft as there's another script active. ourVersion:15 activeVersion:"+window.twitchAdSolutionsVersion),void(window.twitchAdSolutionsVersion=15);window.twitchAdSolutionsVersion=15,f=!1,g=[],h=null,m=["twitch","isVariantA"],v=[],S=["isVariantA","besuper/","${patch_url}"],window.reloadTwitchPlayer=u,e(window),I=function(){for(var e,t=[],n=window.Worker;n;)e=n.toString(),S.some(t=>e.includes(t))&&t.push(n),n=Object.getPrototypeOf(n);return t}(),A=class extends(function(){for(var e,t=null,n=null,a=window.Worker;a;)e=a.toString(),m.some(t=>e.includes(t))&&!v.some(t=>e.includes(t))?null!==n&&Object.setPrototypeOf(n,Object.getPrototypeOf(a)):(null===t&&(t=a),n=a),a=Object.getPrototypeOf(a);return t}()){constructor(p,y){function f(){var e=document.querySelector(".video-player"),t=null;return null!=e&&null==(t=e.querySelector(".adblock-overlay"))&&((t=document.createElement("div")).className="adblock-overlay",t.innerHTML='<div class="player-adblock-notice" style="color: white; background-color: rgba(0, 0, 0, 0.8); position: absolute; top: 0px; left: 0px; padding: 5px;"><p></p></div>',t.style.display="none",t.P=t.querySelector("p"),e.appendChild(t)),t}var m,v=!1;try{v=new URL(p).origin.endsWith(".twitch.tv")}catch{}v?(m=`\n                    const pendingFetchRequests = new Map();\n                    ${s.toString()}\n                    ${r.toString()}\n                    ${n.toString()}\n                    ${e.toString()}\n                    ${d.toString()}\n                    ${c.toString()}\n                    ${l.toString()}\n                    ${t.toString()}\n                    ${a.toString()}\n                    ${i.toString()}\n                    ${o.toString()}\n                    var workerString = getWasmWorkerJs('${p.replaceAll("'","%27")}');\n                    declareOptions(self);\n                    GQLDeviceID = ${GQLDeviceID?"'"+GQLDeviceID+"'":null};\n                    AuthorizationHeader = ${AuthorizationHeader?"'"+AuthorizationHeader+"'":void 0};\n                    ClientIntegrityHeader = ${ClientIntegrityHeader?"'"+ClientIntegrityHeader+"'":null};\n                    ClientVersion = ${ClientVersion?"'"+ClientVersion+"'":null};\n                    ClientSession = ${ClientSession?"'"+ClientSession+"'":null};\n                    self.addEventListener('message', function(e) {\n                        if (e.data.key == 'UpdateClientVersion') {\n                            ClientVersion = e.data.value;\n                        } else if (e.data.key == 'UpdateClientSession') {\n                            ClientSession = e.data.value;\n                        } else if (e.data.key == 'UpdateClientId') {\n                            ClientID = e.data.value;\n                        } else if (e.data.key == 'UpdateDeviceId') {\n                            GQLDeviceID = e.data.value;\n                        } else if (e.data.key == 'UpdateClientIntegrityHeader') {\n                            ClientIntegrityHeader = e.data.value;\n                        } else if (e.data.key == 'UpdateAuthorizationHeader') {\n                            AuthorizationHeader = e.data.value;\n                        } else if (e.data.key == 'FetchResponse') {\n                            const responseData = e.data.value;\n                            if (pendingFetchRequests.has(responseData.id)) {\n                                const { resolve, reject } = pendingFetchRequests.get(responseData.id);\n                                pendingFetchRequests.delete(responseData.id);\n                                if (responseData.error) {\n                                    reject(new Error(responseData.error));\n                                } else {\n                                    // Create a Response object from the response data\n                                    const response = new Response(responseData.body, {\n                                        status: responseData.status,\n                                        statusText: responseData.statusText,\n                                        headers: responseData.headers\n                                    });\n                                    resolve(response);\n                                }\n                            }\n                        } else if (e.data.key == 'SimulateAds') {\n                            SimulatedAdsDepth = e.data.value;\n                            console.log('SimulatedAdsDepth:' + SimulatedAdsDepth);\n                        }\n                        if (e.data.funcName) {\n                            if (e.data.funcName == 'onClientSinkBuffering') {\n                                IsPlayerBuffering = true;\n                            } else if (e.data.funcName == 'onClientSinkPlaying') {\n                                IsPlayerBuffering = false;\n                                LastPausePlay = Date.now();\n                            } else if (e.data.funcName == 'playIntent' || e.data.funcName == 'play') {\n                                LastPausePlay = Date.now();\n                            }\n                            tryFixPlayerBuffering();\n                        }\n                    });\n                    hookWorkerFetch();\n                    eval(workerString);\n                `,super(URL.createObjectURL(new Blob([m])),y),g.push(this),this.addEventListener("message",e=>{"ShowAdBlockBanner"==e.data.key?(null==h&&(h=f()),null!=h&&(h.P.textContent="Blocking"+(e.data.isMidroll?" midroll":"")+" ads",h.style.display="block")):"HideAdBlockBanner"==e.data.key?(null==h&&(h=f()),null!=h&&(h.style.display="none")):"PauseResumePlayer"==e.data.key?u(!0,!1):"ReloadPlayer"==e.data.key&&u(!1,!0)}),this.addEventListener("message",async e=>{if("FetchRequest"==e.data.key){const t=e.data.value,n=await async function(e){try{const t=await window.realFetch(e.url,e.options),n=await t.text();return{id:e.id,status:t.status,statusText:t.statusText,headers:Object.fromEntries(t.headers.entries()),body:n}}catch(t){return{id:e.id,error:t.message}}}(t);this.postMessage({key:"FetchResponse",value:n})}})):super(p,y)}},w=function(e,t){var n,a=e;for(n=0;n<t.length;n++)Object.setPrototypeOf(t[n],a),a=t[n];return a}(A,I),Object.defineProperty(window,"Worker",{get:function(){return w},set:function(e){var t;t=e.toString(),!m.some(e=>t.includes(e))||v.some(e=>t.includes(e))||S.some(e=>t.includes(e))?w=e:console.log("Attempt to set twitch worker denied")}}),k=window.fetch,window.realFetch=k,window.fetch=function(e,t){if("string"==typeof e&&e.includes("gql")){var n=t.headers["X-Device-Id"];if("string"!=typeof n&&(n=t.headers["Device-ID"]),"string"==typeof n&&GQLDeviceID!=n&&(GQLDeviceID=n,p("UpdateDeviceId",GQLDeviceID)),"string"==typeof t.headers["Client-Version"]&&t.headers["Client-Version"]!==ClientVersion&&p("UpdateClientVersion",ClientVersion=t.headers["Client-Version"]),"string"==typeof t.headers["Client-Session-Id"]&&t.headers["Client-Session-Id"]!==ClientSession&&p("UpdateClientSession",ClientSession=t.headers["Client-Session-Id"]),"string"==typeof t.headers["Client-Integrity"]&&t.headers["Client-Integrity"]!==ClientIntegrityHeader&&p("UpdateClientIntegrityHeader",ClientIntegrityHeader=t.headers["Client-Integrity"]),"string"==typeof t.headers.Authorization&&t.headers.Authorization!==AuthorizationHeader&&p("UpdateAuthorizationHeader",AuthorizationHeader=t.headers.Authorization),ForceAccessTokenPlayerType&&"string"==typeof t.body&&t.body.includes("PlaybackAccessToken")&&!t.body.includes("picture-by-picture")){let e="";const n=JSON.parse(t.body);if(Array.isArray(n))for(let t=0;t<n.length;t++)n[t]?.variables?.playerType&&n[t]?.variables?.playerType!==ForceAccessTokenPlayerType&&(e=n[t].variables.playerType,n[t].variables.playerType=ForceAccessTokenPlayerType);else n?.variables?.playerType&&n?.variables?.playerType!==ForceAccessTokenPlayerType&&(e=n.variables.playerType,n.variables.playerType=ForceAccessTokenPlayerType);e&&(console.log(`Replaced '${e}' player type with '${ForceAccessTokenPlayerType}' player type`),t.body=JSON.stringify(n))}}return k.apply(this,arguments)},"complete"===document.readyState||"loaded"===document.readyState||"interactive"===document.readyState?y():window.addEventListener("DOMContentLoaded",function(){y()}),window.simulateAds=e=>{void 0===e||e<0?console.log("Ad depth paramter required (0 = no simulated ad, 1+ = use backup player for given depth)"):p("SimulateAds",e)}}();