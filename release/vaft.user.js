// ==UserScript==
// @name         TwitchAdSolutions (vaft)
// @namespace    https://github.com/pixeltris/TwitchAdSolutions
// @version      26.0.0
// @updateURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/vaft.meta.js
// @downloadURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/vaft.user.js
// @author       https://github.com/cleanlock/VideoAdBlockForTwitch#credits
// @match        *://*.twitch.tv/*
// @run-at       document-start
// @inject-into  page
// @grant        GM.xmlHttpRequest
// @connect      gql.twitch.tv
// ==/UserScript==
!function(){"use strict";function e(e){e.AdSignifier="stitched",e.ClientID="kimne78kx3ncx6brgo4mv6wki5h1ko",e.ClientVersion="null",e.ClientSession="null",e.PlayerType2="embed",e.PlayerType3="site",e.PlayerType4="autoplay",e.CurrentChannelName=null,e.UsherParams=null,e.WasShowingAd=!1,e.GQLDeviceID=null,e.IsSquadStream=!1,e.StreamInfos=[],e.StreamInfosByUrl=[],e.MainUrlByUrl=[],e.EncodingCacheTimeout=6e4,e.ClientIntegrityHeader=null,e.AuthorizationHeader=null}function t(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.overrideMimeType("text/javascript"),t.send(),t.responseText}function n(){console.log("hookWorkerFetch (vaft)");var e=fetch;fetch=async function(t,n){var i;if("string"==typeof t){if(t.endsWith("m3u8"))return new Promise(function(i,a){e(t,n).then(function(n){!async function(n){var a,s,o;200===n.status?(a=await n.text(),s=null,o=s=await r(t,a,e,PlayerType2),s.includes(AdSignifier)&&(s=await r(t,a,e,PlayerType3)),s.includes(AdSignifier)&&(s=await r(t,a,e,PlayerType4)),s.includes(AdSignifier)&&(s=o),i(new Response(s))):i(n)}(n)}).catch(function(e){a(e)})});if(t.includes("/api/channel/hls/"))return i=new URL(t).pathname.match(/([^\/]+)(?=\.\w+$)/)[0],UsherParams=new URL(t).search,CurrentChannelName=i,t.includes("picture-by-picture")&&(t=""),new Promise(function(a,s){e(t,n).then(function(e){!async function(e){var n,s,r,l,d,c;if(200==e.status){for(encodingsM3u8=await e.text(),null==(n=StreamInfos[i])&&(StreamInfos[i]=n={}),n.ChannelName=i,n.RequestedAds=new Set,n.Urls=[],n.EncodingsM3U8Cache=[],n.EncodingsM3U8=encodingsM3u8,s=encodingsM3u8.replace("\r","").split("\n"),r=0;r<s.length;r++)!s[r].startsWith("#")&&s[r].includes(".m3u8")&&(n.Urls[s[r]]=-1,r>0&&s[r-1].startsWith("#EXT-X-STREAM-INF")&&(d=(l=o(s[r-1])).RESOLUTION,c=l["FRAME-RATE"],d&&(n.Urls[s[r]]={Resolution:d,FrameRate:c})),StreamInfosByUrl[s[r]]=n,MainUrlByUrl[s[r]]=t);a(new Response(encodingsM3u8))}else a(e)}(e)}).catch(function(e){s(e)})})}return e.apply(this,arguments)}}function i(e,t,n){var i,a,s,r,l,d,c,u,p,f,h=0;for(n&&n.endsWith("p")&&(h=0|n.substr(0,n.length-1)),i=e.replace("\r","").split("\n"),a=null,s=null,r=null,l=!1,d=0;d<i.length;d++)if(!i[d].startsWith("#")&&i[d].includes(".m3u8")&&d>0&&i[d-1].startsWith("#EXT-X-STREAM-INF")){if(u=(c=o(i[d-1])).RESOLUTION,p=c["FRAME-RATE"],u)if(h){if((f=u.toLowerCase().split("x")[1])==h){if(r=i[d],p<40)return r}else if(f<h)return r||i[d]}else if(!(t&&u!=t.Resolution||r&&(l||p!=t.FrameRate))&&(r=i[d],l=p==t.FrameRate))return r;null==a&&(a=i[d]),s=i[d]}return h?s:r||a}async function a(e,t,n,a,s,r){var o,l,d;return(e.EncodingsM3U8Cache[s].Resolution!=t.Resolution||e.EncodingsM3U8Cache[s].RequestTime<Date.now()-EncodingCacheTimeout)&&console.log(`Blocking ads (type:${s}, resolution:${t.Resolution}, frameRate:${t.FrameRate}, qualityOverride:null)`),e.EncodingsM3U8Cache[s].RequestTime=Date.now(),e.EncodingsM3U8Cache[s].Value=n,e.EncodingsM3U8Cache[s].Resolution=t.Resolution,o=i(n,t,null),200==(l=await r(o)).status?(d=await l.text(),WasShowingAd=!0,postMessage({key:"ShowAdBlockBanner"}),postMessage({key:"ForceChangeQuality"}),d&&!d.includes(AdSignifier)||(e.EncodingsM3U8Cache[s].Value=null),d):(e.EncodingsM3U8Cache[s].Value=null,a)}function s(e,t){var n,i;for(t||(t=["token","sig"]),n=new URL("https://localhost/"+e),i=0;i<t.length;i++)n.searchParams.delete(t[i]);return n.pathname.substring(1)+n.search}async function r(e,t,n,i){var s,r,o,l,d,u,p,f,h,y,g=StreamInfosByUrl[e];if(1==IsSquadStream)return t;if(!t)return t;if(!t.includes(".ts")&&!t.includes(".mp4"))return t;if(t.includes(AdSignifier)){if(!t.includes('"MIDROLL"')&&!t.includes('"midroll"')&&i===PlayerType2)for(s=t.replace("\r","").split("\n"),r=0;r<s.length;r++)if((o=s[r]).startsWith("#EXTINF")&&s.length>r+1&&!o.includes(",live")&&!g.RequestedAds.has(s[r+1])){g.RequestedAds.add(s[r+1]),fetch(s[r+1]).then(e=>{e.blob()});break}if(l=null,g&&g.Urls)for(const[t,n]of Object.entries(g.Urls))if(t==e){l=n;break}if(d=g.EncodingsM3U8Cache[i]){if(d.Value&&d.RequestTime>=Date.now()-EncodingCacheTimeout)try{if(u=a(g,l,d.Value,null,i,n))return u}catch(e){d.Value=null}}else g.EncodingsM3U8Cache[i]={RequestTime:Date.now(),Value:null,Resolution:null};if(200===(p=await c(CurrentChannelName,i)).status){f=await p.json();try{return(h=new URL("https://usher.ttvnw.net/api/channel/hls/"+CurrentChannelName+".m3u8"+UsherParams)).searchParams.set("sig",f.data.streamPlaybackAccessToken.signature),h.searchParams.set("token",f.data.streamPlaybackAccessToken.value),200===(y=await n(h.href)).status?a(g,l,await y.text(),t,i,n):t}catch(e){}return t}return t}return WasShowingAd&&(console.log("Finished blocking ads"),WasShowingAd=!1,postMessage({key:"ForceChangeQuality",value:"original"}),postMessage({key:"PauseResumePlayer"}),postMessage({key:"HideAdBlockBanner"})),t}function o(e){return Object.fromEntries(e.split(/(?:^|,)((?:[^=]*)=(?:"[^"]*"|[^,]*))/).filter(Boolean).map(e=>{const t=e.indexOf("="),n=e.substring(0,t),i=e.substring(t+1),a=Number(i);return[n,Number.isNaN(a)?i.startsWith('"')?JSON.parse(i):i:a]}))}async function l(e){var t,n,i,a,s,r,l=e.match(/#EXT-X-DATERANGE:(ID="stitched-ad-[^\n]+)\n/);if(l.length>1){const e=o(l[1]);t=parseInt(e["X-TV-TWITCH-AD-POD-LENGTH"]?e["X-TV-TWITCH-AD-POD-LENGTH"]:"1"),parseInt(e["X-TV-TWITCH-AD-POD-POSITION"]?e["X-TV-TWITCH-AD-POD-POSITION"]:"0"),n=e["X-TV-TWITCH-AD-RADS-TOKEN"],i=e["X-TV-TWITCH-AD-LINE-ITEM-ID"],a=e["X-TV-TWITCH-AD-ORDER-ID"],s=e["X-TV-TWITCH-AD-CREATIVE-ID"],r=e["X-TV-TWITCH-AD-ADVERTISER-ID"];const c={stitched:!0,roll_type:e["X-TV-TWITCH-AD-ROLL-TYPE"].toLowerCase(),player_mute:!0,player_volume:0,visible:!1};for(let e=0;e<t;e++){const o={...c,ad_id:r,ad_position:e,duration:0,creative_id:s,total_ads:t,order_id:a,line_item_id:i};await u(d("video_ad_impression",n,o));for(let e=0;e<4;e++)await u(d("video_ad_quartile_complete",n,{...o,quartile:e+1}));await u(d("video_ad_pod_complete",n,c))}}}function d(e,t,n){return[{operationName:"ClientSideAdEventHandling_RecordAdEvent",variables:{input:{eventName:e,eventPayload:JSON.stringify(n),radToken:t}},extensions:{persistedQuery:{version:1,sha256Hash:"7e6c69e6eb59f8ccb97ab73686f3d8b7d85a72a0298745ccd8bfc68e4054ca5b"}}}]}function c(e,t){return u({operationName:"PlaybackAccessToken_Template",query:'query PlaybackAccessToken_Template($login: String!, $isLive: Boolean!, $vodID: ID!, $isVod: Boolean!, $playerType: String!) {  streamPlaybackAccessToken(channelName: $login, params: {platform: "android", playerBackend: "mediaplayer", playerType: $playerType}) @include(if: $isLive) {    value    signature    __typename  }  videoPlaybackAccessToken(id: $vodID, params: {platform: "android", playerBackend: "mediaplayer", playerType: $playerType}) @include(if: $isVod) {    value    signature    __typename  }}',variables:{isLive:!0,login:e,isVod:!1,vodID:"",playerType:t}})}function u(e){var t,n;if(!GQLDeviceID)for(t=0;t<32;t++)GQLDeviceID+="abcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(36*Math.random()));return n={"Client-ID":ClientID,"Client-Integrity":ClientIntegrityHeader,"Device-ID":GQLDeviceID,"X-Device-Id":GQLDeviceID,"Client-Version":ClientVersion,"Client-Session-Id":ClientSession,Authorization:AuthorizationHeader},new Promise((t,i)=>{const a=Math.random().toString(36).substring(2,15),s={id:a,url:"https://gql.twitch.tv/gql",options:{method:"POST",body:JSON.stringify(e),headers:n}};pendingFetchRequests.set(a,{resolve:t,reject:i}),postMessage({key:"FetchRequest",value:s})})}function p(e,t,n,i,a){var s,r,o,l,d;try{function c(e,t){if(e.stateNode&&t(e.stateNode))return e.stateNode;let n=e.child;for(;n;){const e=c(n,t);if(e)return e;n=n.sibling}return null}function u(){var e,t=null,n=document.querySelector("#root");return n&&n._reactRootContainer&&n._reactRootContainer._internalRoot&&n._reactRootContainer._internalRoot.current&&(t=n._reactRootContainer._internalRoot.current),null==t&&null!=(e=Object.keys(n).find(e=>e.startsWith("__reactContainer")))&&(t=n[e]),t}if(s=null,!(r=u()))return void console.log("Could not find react root");if(s=(s=c(r,e=>e.setPlayerActive&&e.props&&e.props.mediaPlayerInstance))&&s.props&&s.props.mediaPlayerInstance?s.props.mediaPlayerInstance:null,e)return s.pause(),void s.play();if(t){if(void 0===s.getQuality())return;return JSON.stringify(s.getQuality())||void 0}if(i)return void 0!==s.isAutoQualityMode()&&!!(o=s.isAutoQualityMode())&&(s.setAutoQualityMode(!1),o);if(a)return void s.setAutoQualityMode(!0);try{l=document.URL,d=!0,(l.includes("videos/")||l.includes("clip/"))&&(d=!1),n&&d&&setTimeout(function(){(s.isLiveLowLatency()&&s.getLiveLatency()>5||s.getLiveLatency()>15)&&(s.pause(),s.play())},3e3)}catch(p){}}catch(f){}}function f(e,t){g.forEach(n=>{n.postMessage({key:e,value:t})})}function h(e){const t=new Headers;return e.trim().split(/[\r\n]+/).forEach(e=>{const n=e.split(":"),i=n.shift(),a=n.join(":");t.append(i,a)}),t}function y(){var e,t;try{Object.defineProperty(document,"visibilityState",{get:()=>"visible"})}catch{}let n=document.__lookupGetter__("hidden"),i=document.__lookupGetter__("webkitHidden");try{Object.defineProperty(document,"hidden",{get:()=>!1})}catch{}e=e=>{e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation()};let a=!0;t=t=>{if("undefined"!=typeof chrome){const e=document.getElementsByTagName("video");e.length>0&&(!0===n.apply(document)||i&&!0===i.apply(document)?a=!e[0].paused&&!e[0].ended:a&&!e[0].ended&&e[0].play())}e(t)},document.addEventListener("visibilitychange",t,!0),document.addEventListener("webkitvisibilitychange",t,!0),document.addEventListener("mozvisibilitychange",t,!0),document.addEventListener("hasFocus",e,!0);try{/Firefox/.test(navigator.userAgent)?Object.defineProperty(document,"mozHidden",{get:()=>!1}):Object.defineProperty(document,"webkitHidden",{get:()=>!1})}catch{}}var g,m,v,w,I,T,D,C,S,b,k,A;if("undefined"==typeof unsafeWindow&&(unsafeWindow=window),void 0!==unsafeWindow.twitchAdSolutionsVersion&&unsafeWindow.twitchAdSolutionsVersion>=11)return console.log("skipping vaft as there's another script active. ourVersion:11 activeVersion:"+unsafeWindow.twitchAdSolutionsVersion),void(unsafeWindow.twitchAdSolutionsVersion=11);unsafeWindow.twitchAdSolutionsVersion=11,g=[],m=null,v=["twitch","isVariantA"],w=[],I=["isVariantA","besuper/","${patch_url}"],unsafeWindow.reloadTwitchPlayer=p,T=null,T=unsafeWindow.localStorage.getItem("local_copy_unique_id"),D=!1,C=!1,e(unsafeWindow),S=function(){for(var e,t=[],n=unsafeWindow.Worker;n;)e=n.toString(),I.some(t=>e.includes(t))&&t.push(n),n=Object.getPrototypeOf(n);return t}(),b=class extends(function(){for(var e,t=null,n=null,i=unsafeWindow.Worker;i;)e=i.toString(),v.some(t=>e.includes(t))&&!w.some(t=>e.includes(t))?null!==n&&Object.setPrototypeOf(n,Object.getPrototypeOf(i)):(null===t&&(t=i),n=i),i=Object.getPrototypeOf(i);return t}()){constructor(f,y){function v(){var e=document.querySelector(".video-player"),t=null;return null!=e&&null==(t=e.querySelector(".adblock-overlay"))&&((t=document.createElement("div")).className="adblock-overlay",t.innerHTML='<div class="player-adblock-notice" style="color: white; background-color: rgba(0, 0, 0, 0.8); position: absolute; top: 0px; left: 0px; padding: 5px;"><p></p></div>',t.style.display="none",t.P=t.querySelector("p"),e.appendChild(t)),t}var w,I=!1;try{I=new URL(f).origin.endsWith(".twitch.tv")}catch{}I?(w=`\n                    const pendingFetchRequests = new Map();\n                    ${i.toString()}\n                    ${a.toString()}\n                    ${s.toString()}\n                    ${r.toString()}\n                    ${n.toString()}\n                    ${e.toString()}\n                    ${c.toString()}\n                    ${u.toString()}\n                    ${d.toString()}\n                    ${l.toString()}\n                    ${o.toString()}\n                    ${t.toString()}\n                    var workerString = getWasmWorkerJs('${f.replaceAll("'","%27")}');\n                    declareOptions(self);\n                    self.addEventListener('message', function(e) {\n                        if (e.data.key == 'UpdateIsSquadStream') {\n                            IsSquadStream = e.data.value;\n                        } else if (e.data.key == 'UpdateClientVersion') {\n                            ClientVersion = e.data.value;\n                        } else if (e.data.key == 'UpdateClientSession') {\n                            ClientSession = e.data.value;\n                        } else if (e.data.key == 'UpdateClientId') {\n                            ClientID = e.data.value;\n                        } else if (e.data.key == 'UpdateDeviceId') {\n                            GQLDeviceID = e.data.value;\n                        } else if (e.data.key == 'UpdateClientIntegrityHeader') {\n                            ClientIntegrityHeader = e.data.value;\n                        } else if (e.data.key == 'UpdateAuthorizationHeader') {\n                            AuthorizationHeader = e.data.value;\n                        } else if (e.data.key == 'FetchResponse') {\n                            const responseData = e.data.value;\n                            if (pendingFetchRequests.has(responseData.id)) {\n                                const { resolve, reject } = pendingFetchRequests.get(responseData.id);\n                                pendingFetchRequests.delete(responseData.id);\n                                if (responseData.error) {\n                                    reject(new Error(responseData.error));\n                                } else {\n                                    // Create a Response object from the response data\n                                    const response = new Response(responseData.body, {\n                                        status: responseData.status,\n                                        statusText: responseData.statusText,\n                                        headers: responseData.headers\n                                    });\n                                    resolve(response);\n                                }\n                            }\n                        }\n                    });\n                    hookWorkerFetch();\n                    eval(workerString);\n                `,super(URL.createObjectURL(new Blob([w])),y),g.push(this),this.addEventListener("message",e=>{if("ShowAdBlockBanner"==e.data.key)null==m&&(m=v()),m.P.textContent="Blocking ads",m.style.display="block";else if("HideAdBlockBanner"==e.data.key)null==m&&(m=v()),m.style.display="none";else if("PauseResumePlayer"==e.data.key)p(!0,!1,!1,!1,!1);else if("ForceChangeQuality"==e.data.key)try{return}catch(e){}}),this.addEventListener("message",async e=>{if("FetchRequest"==e.data.key){const t=e.data.value,n=await async function(e){try{if(D||!C){const t=await unsafeWindow.realFetch(e.url,e.options),n=await t.text(),i={id:e.id,status:t.status,statusText:t.statusText,headers:Object.fromEntries(t.headers.entries()),body:n};if(200===i.status&&(void 0!==JSON.parse(n).errors?C=!0:D=!0),D||!C)return i}if("undefined"!=typeof GM&&void 0!==GM.xmlHttpRequest){e.options.headers["Sec-Ch-Ua"]='"Google Chrome";v="137", "Chromium";v="137", "Not/A)Brand";v="24"',e.options.headers.Referer="https://www.twitch.tv/",e.options.headers.Origin="https://www.twitch.tv/",e.options.headers.Host="gql.twitch.tv";const t=await function(e){return new Promise((t,n)=>{GM.xmlHttpRequest({method:e.options.method,url:e.url,data:e.options.body,headers:e.options.headers,onload:e=>t(e),onerror:e=>n(e)})})}(e),n=t.responseText;return{id:e.id,status:t.status,statusText:t.statusText,headers:Object.fromEntries(h(t.responseHeaders).entries()),body:n}}throw{message:"Failed to resolve GQL request. Try the userscript version of the ad blocking solution"}}catch(t){return{id:e.id,error:t.message}}}(t);this.postMessage({key:"FetchResponse",value:n})}})):super(f,y)}},k=function(e,t){var n,i=e;for(n=0;n<t.length;n++)Object.setPrototypeOf(t[n],i),i=t[n];return i}(b,S),Object.defineProperty(unsafeWindow,"Worker",{get:function(){return k},set:function(e){var t;t=e.toString(),!v.some(e=>t.includes(e))||w.some(e=>t.includes(e))||I.some(e=>t.includes(e))?k=e:console.log("Attempt to set twitch worker denied")}}),A=unsafeWindow.fetch,unsafeWindow.realFetch=A,unsafeWindow.fetch=function(e,t){var n,i,a,s;return"string"==typeof e&&(unsafeWindow.location.pathname.includes("/squad")?f("UpdateIsSquadStream",!0):f("UpdateIsSquadStream",!1),(e.includes("/access_token")||e.includes("gql"))&&("string"!=typeof(n=t.headers["X-Device-Id"])&&(n=t.headers["Device-ID"]),"string"!=typeof n||n.includes("twitch-web-wall-mason")?T&&(GQLDeviceID=T.replace('"',""),GQLDeviceID=GQLDeviceID.replace('"',"")):GQLDeviceID=n,GQLDeviceID&&("string"==typeof t.headers["X-Device-Id"]&&(t.headers["X-Device-Id"]=GQLDeviceID),"string"==typeof t.headers["Device-ID"]&&(t.headers["Device-ID"]=GQLDeviceID),f("UpdateDeviceId",GQLDeviceID)),(i=t.headers["Client-Version"])&&"string"==typeof i&&(ClientVersion=i),ClientVersion&&f("UpdateClientVersion",ClientVersion),(a=t.headers["Client-Session-Id"])&&"string"==typeof a&&(ClientSession=a),ClientSession&&f("UpdateClientSession",ClientSession),e.includes("gql")&&t&&"string"==typeof t.body&&t.body.includes("PlaybackAccessToken")&&(((s=t.headers["Client-ID"])&&"string"==typeof s||(s=t.headers["Client-Id"])&&"string"==typeof s)&&(ClientID=s),ClientID&&f("UpdateClientId",ClientID),ClientIntegrityHeader=t.headers["Client-Integrity"],ClientIntegrityHeader&&f("UpdateClientIntegrityHeader",ClientIntegrityHeader),AuthorizationHeader=t.headers.Authorization,AuthorizationHeader&&f("UpdateAuthorizationHeader",AuthorizationHeader)),e.includes("gql")&&t&&"string"==typeof t.body&&t.body.includes("PlaybackAccessToken")&&t.body.includes("picture-by-picture")&&(t.body=""),e.includes("picture-by-picture")&&(e=""))),A.apply(this,arguments)},"complete"===document.readyState||"loaded"===document.readyState||"interactive"===document.readyState?y():unsafeWindow.addEventListener("DOMContentLoaded",function(){y()})}();