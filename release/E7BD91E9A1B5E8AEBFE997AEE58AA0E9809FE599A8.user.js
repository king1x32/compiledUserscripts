// ==UserScript==
// @name         网页访问加速器
// @name:en      Web Access Accelerator
// @namespace    https://github.com/xxxily
// @version      1.0.0
// @author       ankvps
// @icon         https://lh3.googleusercontent.com/5b2IeKOldW9hxPQaV7oyRfdAgN2V7Ot1bGcpE4QT5Uq4yt7yNtdgh0ABq4NCEwvsDdEU4HWKVXwUjYuem2JyJ_JrSu8=w128-h128-e365-rj-sc0x00ffffff
// @match        *://*/*
// @grant        none
// @license      Apache License 2.0
// @run-at       document-start
// @downloadURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/E7BD91E9A1B5E8AEBFE997AEE58AA0E9809FE599A8.user.js
// @updateURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/E7BD91E9A1B5E8AEBFE997AEE58AA0E9809FE599A8.meta.js
// ==/UserScript==
function e(e){return new Promise(function(n,r,t){(t=new XMLHttpRequest).open("GET",e,t.withCredentials=!0),t.onload=function(){200===t.status?n():r()},t.send()})}function n(e){if(e){if(e.saveData)return new Error("Save-Data is enabled");if(/2g/.test(e.effectiveType))return new Error("network conditions are poor")}return!0}function r(r,t){var o=n(navigator.connection);return o instanceof Error?Promise.reject(new Error("Cannot prefetch, "+o.message)):(u.size>0&&!l&&console.warn("[Warning] You are using both prefetching and prerendering on the same document"),Promise.all([].concat(r).map(function(n){if(!a.has(n))return a.add(n),(t?function(n){return window.fetch?fetch(n,{credentials:"include"}):e(n)}:c)(new URL(n,location.href).toString())})))}function t(e){var t,o,i,c,s=n(navigator.connection);if(s instanceof Error)return Promise.reject(new Error("Cannot prerender, "+s.message));if(!HTMLScriptElement.supports("speculationrules"))return r(e),Promise.reject(new Error("This browser does not support the speculation rules API. Falling back to prefetch."));if(document.querySelector('script[type="speculationrules"]'))return Promise.reject(new Error("Speculation Rules is already defined and cannot be altered."));for(t=0,o=[].concat(e);t<o.length;t+=1){if(i=o[t],window.location.origin!==new URL(i,window.location.href).origin)return Promise.reject(new Error("Only same origin URLs are allowed: "+i));u.add(i)}return a.size>0&&!l&&console.warn("[Warning] You are using both prefetching and prerendering on the same document"),c=function(e){var n=document.createElement("script");n.type="speculationrules",n.text='{"prerender":[{"source": "list","urls": ["'+Array.from(e).join('","')+'"]}]}';try{document.head.appendChild(n)}catch(e){return e}return!0}(u),!0===c?Promise.resolve():Promise.reject(c)}function o(e){const n=d.urlPaths.some(n=>e.includes(`/${n}/`))||d.fileExtensions.some(n=>e.includes(n))||d.urlProtocols.some(n=>e.startsWith(n));return n&&f.log("[Quicklink][Ignore]",e),n}var i,c=(i=document.createElement("link")).relList&&i.relList.supports&&i.relList.supports("prefetch")?function(e){return new Promise(function(n,r,t){(t=document.createElement("link")).rel="prefetch",t.href=e,t.onload=n,t.onerror=r,document.head.appendChild(t)})}:e,s=window.requestIdleCallback||function(e){var n=Date.now();return setTimeout(function(){e({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-n))}})},1)},a=new Set,u=new Set,l=!1;const f=window.console,d={urlPaths:"api, logout, signout, exit, quit, login, logoff, subscribe, subscription, doubleclick, bit.ly, signin, signup, apk, release, amazon, google, shopping, checkout, shop, cart, ads, ticket, captcha",fileExtensions:".zip, .pdf, .mp4, .webm, .mp3, .mov, .rar, .apk, .tar, .doc, .docx, .xls, .xlsx, .ppt, .pptx",urlProtocols:"http:, tel:, mailto:, javascript:, market:"};Object.keys(d).forEach(e=>{const n=d[e].split(",");d[e]=n.map(e=>e.trim())}),window.addEventListener("load",()=>{!function(e){var n,o,i,c,f,d,p,h,m,g,w,E;if(e||(e={}),window.IntersectionObserver)n=function(e){function n(){t<e&&r.length>0&&(r.shift()(),t++)}e=e||1;var r=[],t=0;return[function(e){r.push(e)>1||n()},function(){t--,n()}]}(e.throttle||1/0),o=n[0],i=n[1],c=e.limit||1/0,f=e.origins||[location.hostname],d=e.ignores||[],p=e.delay||0,h=[],m=e.timeoutFn||s,g="function"==typeof e.hrefFn&&e.hrefFn,w=e.prerender||!1,l=e.prerenderAndPrefetch||!1,E=new IntersectionObserver(function(n){n.forEach(function(n){if(n.isIntersecting)h.push((n=n.target).href),function(e,n){n?setTimeout(e,n):e()}(function(){-1!==h.indexOf(n.href)&&(E.unobserve(n),(l||w)&&u.size<1?t(g?g(n):n.href).catch(function(n){if(!e.onError)throw n;e.onError(n)}):a.size<c&&!w&&o(function(){r(g?g(n):n.href,e.priority).then(i).catch(function(n){i(),e.onError&&e.onError(n)})}))},p);else{var s=h.indexOf((n=n.target).href);s>-1&&h.splice(s)}})},{threshold:e.threshold||0}),m(function(){(e.el||document).querySelectorAll("a").forEach(function(e){f.length&&!f.includes(e.hostname)||function e(n,r){return Array.isArray(r)?r.some(function(r){return e(n,r)}):(r.test||r).call(r,n.href,n)}(e,d)||E.observe(e)})},{timeout:e.timeout||2e3})}({ignores:[o]})});