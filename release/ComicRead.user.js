// ==UserScript==
// @name            ComicRead
// @namespace       ComicRead
// @version         12.3.5
// @author          hymbz
// @license         AGPL-3.0-or-later
// @noframes
// @match           *://*/*
// @connect         yamibo.com
// @connect         dmzj.com
// @connect         idmzj.com
// @connect         exhentai.org
// @connect         e-hentai.org
// @connect         hath.network
// @connect         nhentai.net
// @connect         gold-usergeneratedcontent.net
// @connect         hypergryph.com
// @connect         mangabz.com
// @connect         2025copy.com
// @connect         mangacopy.com
// @connect         copy20.com
// @connect         mangacopy.com
// @connect         xsskc.com
// @connect         schale.network
// @connect         touhou.ai
// @connect         jsdelivr.net
// @connect         npmmirror.com
// @connect         self
// @connect         127.0.0.1
// @connect         *
// @grant           GM_addElement
// @grant           GM_getResourceText
// @grant           GM_xmlhttpRequest
// @grant           GM.addValueChangeListener
// @grant           GM.removeValueChangeListener
// @grant           GM.getResourceText
// @grant           GM.getValue
// @grant           GM.setValue
// @grant           GM.listValues
// @grant           GM.deleteValue
// @grant           GM.registerMenuCommand
// @grant           GM.unregisterMenuCommand
// @grant           unsafeWindow
// @icon            data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAACBUExURUxpcWB9i2B9i2B9i2B9i2B9i2B9i2B9i2B9i2B9i2B9i2B9i2B9i2B9i2B9i////198il17idng49DY3PT297/K0MTP1M3X27rHzaCxupmstbTByK69xOfr7bfFy3WOmqi4wPz9/X+XomSBjqW1vZOmsN/l6GmFkomeqe7x8vn6+kv+1vUAAAAOdFJOUwDsAoYli9zV+lIqAZEDwV05SQAAAUZJREFUOMuFk+eWgjAUhGPBiLohjZACUqTp+z/gJkqJy4rzg3Nn+MjhwB0AANjv4BEtdITBHjhtQ4g+CIZbC4Qb9FGb0J4P0YrgCezQqgIA14EDGN8fYz+f3BGMASFkTJ+GDAYMUSONzrFL7SVvjNQIz4B9VERRmV0rbJWbrIwidnsd6ACMlEoip3uad3X2HJmqb3gCkkJELwk5DExRDxA6HnKaDEPSsBnAsZoANgJaoAkg12IJqBiPACImXQKF9IDULIHUkOk7kDpeAMykHqCEWACy8ACdSM7LGSg5F3HtAU1rrkaK9uGAshXS2lZ5QH/nVhmlD8rKlmbO3ZsZwLe8qnpdxJRnLaci1X1V5R32fjd5CndVkfYdGpy3D+htU952C/ypzPtdt3JflzZYBy7fi/O1euvl/XH1Pp+Cw3/1P1xOZwB+AWMcP/iw0AlKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC
// @resource        solid-js https://registry.npmmirror.com/solid-js/1.9.8/files/dist/solid.cjs
// @resource        fflate https://registry.npmmirror.com/fflate/0.8.2/files/umd/index.js
// @resource        jsqr https://registry.npmmirror.com/jsqr/1.4.0/files/dist/jsQR.js
// @resource        comlink https://registry.npmmirror.com/comlink/4.4.2/files/dist/umd/comlink.min.js
// @resource        solid-js|store https://registry.npmmirror.com/solid-js/1.9.8/files/store/dist/store.cjs
// @resource        solid-js|web https://registry.npmmirror.com/solid-js/1.9.8/files/web/dist/web.cjs
// @resource        _tensorflow|tfjs https://registry.npmmirror.com/@tensorflow/tfjs/4.22.0/files/dist/tf.min.js
// @resource        _tensorflow|tfjs-backend-webgpu https://registry.npmmirror.com/@tensorflow/tfjs-backend-webgpu/4.22.0/files/dist/tf-backend-webgpu.js
// @supportURL      https://github.com/hymbz/ComicReadScript/issues
// @downloadURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/ComicRead.user.js
// @updateURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/ComicRead.meta.js
// ==/UserScript==
let e="undefined"!=typeof Worker;const t={GM:"undefined"==typeof GM?void 0:GM,GM_addElement:"undefined"==typeof GM_addElement?void 0:GM_addElement,GM_getResourceText:"undefined"==typeof GM_getResourceText?void 0:GM_getResourceText,GM_xmlhttpRequest:"undefined"==typeof GM_xmlhttpRequest?void 0:GM_xmlhttpRequest,unsafeWindow:"undefined"==typeof unsafeWindow?window:unsafeWindow},n=Object.keys(t),o={process:{env:{NODE_ENV:"production"}},...t},a=Math.random().toString(36).slice(2),r=e=>{const n=t.GM_getResourceText?.(e.replaceAll("/","|").replaceAll("@","_"));if(!n)throw new Error(`外部模块 ${e} 未在 @Resource 中声明`);return"@tensorflow/tfjs-backend-webgpu"===e?n.replace("@tensorflow/tfjs-core","@tensorflow/tfjs"):n},s=e=>{if(e)return t.GM_addElement?GM_addElement("script",{textContent:e})?.remove():void eval.call(t.unsafeWindow,e)},i=i=>{let c;switch(i){case"helper/languages":c="\nconst langList = ['zh', 'en', 'ru'];\n/** 判断传入的字符串是否是支持的语言类型代码 */\nconst isLanguages = lang => Boolean(lang) && langList.includes(lang);\n\n/** 返回浏览器偏好语言 */\nconst getBrowserLang = () => {\n  for (const language of navigator.languages) {\n    const matchLang = langList.find(l => l === language.split('-')[0]);\n    if (matchLang) return matchLang;\n  }\n};\nconst getSaveLang = () => typeof GM === 'undefined' ? 'zh' : GM.getValue('@Languages');\nconst setSaveLang = val => typeof GM === 'undefined' || GM.setValue('@Languages', val);\nconst getInitLang = async () => {\n  const saveLang = await getSaveLang();\n  if (isLanguages(saveLang)) return saveLang;\n  const lang = getBrowserLang() ?? 'zh';\n  setSaveLang(lang);\n  return lang;\n};\n\nexports.getInitLang = getInitLang;\nexports.isLanguages = isLanguages;\nexports.langList = langList;\nexports.setSaveLang = setSaveLang;\n";break;case"helper":c='\nconst web = require(\'solid-js/web\');\nconst solidJs = require(\'solid-js\');\nconst languages = require(\'helper/languages\');\nconst store = require(\'solid-js/store\');\n\nconst getDom = id => {\n  let dom = document.getElementById(id);\n  if (dom) {\n    dom.innerHTML = \'\';\n    return dom;\n  }\n  dom = document.createElement(\'div\');\n  dom.id = id;\n  document.body.append(dom);\n  return dom;\n};\n\n/** 挂载 solid-js 组件 */\nconst mountComponents = (id, fc) => {\n  const dom = getDom(id);\n  dom.style.setProperty(\'display\', \'unset\', \'important\');\n  const shadowDom = dom.attachShadow({\n    mode: \'closed\'\n  });\n  web.render(fc, shadowDom);\n  return dom;\n};\n\nclass FaviconProgress {\n  constructor(color = \'#607D8B\') {\n    this.color = color;\n    this.canvas = document.createElement(\'canvas\');\n    this.canvas.width = 32;\n    this.canvas.height = 32;\n    this.ctx = this.canvas.getContext(\'2d\');\n    const existingLink = document.querySelector("link[rel~=\'icon\']");\n    if (existingLink) this.link = existingLink;else {\n      const link = document.createElement(\'link\');\n      link.type = \'image/x-icon\';\n      link.rel = \'icon\';\n      document.head.append(link);\n      this.link = link;\n    }\n    this.initLink = this.link.href || \'/favicon.ico\';\n  }\n  update(progress) {\n    this.ctx.clearRect(0, 0, 32, 32);\n\n    // 绘制背景\n    this.ctx.beginPath();\n    this.ctx.arc(16, 16, 16, 0, Math.PI * 2);\n    this.ctx.fillStyle = \'#FAFAFA\';\n    this.ctx.fill();\n\n    // 绘制进度扇形\n    const startAngle = -Math.PI / 2;\n    const endAngle = Math.PI * 2 * progress + startAngle;\n    this.ctx.beginPath();\n    this.ctx.moveTo(16, 16);\n    this.ctx.arc(16, 16, 16, startAngle, endAngle);\n    this.ctx.fillStyle = this.color;\n    this.ctx.fill();\n    this.updateFavicon();\n  }\n  updateFavicon() {\n    if (!this.link || !this.canvas) return;\n    this.link.href = this.canvas.toDataURL(\'image/png\');\n  }\n\n  /** 恢复默认图标 */\n  recover() {\n    if (!this.link || !this.initLink) return;\n    this.link.href = this.initLink;\n  }\n}\nconst useFaviconProgress = () => {\n  //\n};\n\nconst en = {alert:{comic_load_error:"Comic loading error",download_failed:"Download failed",fetch_comic_img_failed:"Failed to fetch comic images",img_load_failed:"Image loading failed",no_img_download:"No images available for download",repeat_load:"Loading image, please wait",retry_get_img_url:"Retrieve the URL of the image on page {{i}} again",server_connect_failed:"Unable to connect to the server"},button:{auto_scroll:"Auto scroll",close_current_page_translation:"Close translation of the current page",download_completed:"Download completed",download_completed_error:"Download complete, but {{errorNum}} images failed to download",downloading:"Downloading",fullscreen:"Fullscreen",fullscreen_exit:"Exit Fullscreen",grid_mode:"Grid mode",packaging:"Packaging",page_fill:"Page fill",page_mode_double:"Double page mode",page_mode_single:"Single page mode",scroll_mode:"Scroll mode",translate_current_page:"Translate current page",zoom_in:"Zoom in",zoom_out:"Zoom out"},description:"Add enhanced features to the comic site for optimized experience, including dual-page reading and translation.",eh_tag_lint:{combo:"[tag]: In most cases, Should coexist with [tag]",conflict:"[tag]: Should not coexist with [tag]",correct_tag:"Should be the correct tag",miss_female:"Missing male tag, might need",miss_parody:"Missing parody tag, might need",possible_conflict:"[tag]: In most cases, Should not coexist with [tag]",prerequisite:"[tag]: The prerequisite tag [tag] does not exist"},end_page:{next_button:"Next chapter",prev_button:"Prev chapter",tip:{end_jump:"Reached the last page, scrolling down will jump to the next chapter",exit:"Reached the last page, scrolling down will exit",start_jump:"Reached the first page, scrolling up will jump to the previous chapter"}},hotkeys:{enter_read_mode:"Enter reading mode",float_tag_list:"Floating tag list",jump_to_end:"Jump to the last page",jump_to_home:"Jump to the first page",page_down:"Turn the page to the down",page_up:"Turn the page to the up",repeat_tip:"This hotkey has been bound to \\"{{hotkey}}\\"",scroll_down:"Scroll down",scroll_left:"Scroll left",scroll_right:"Scroll right",scroll_up:"Scroll up",switch_auto_enlarge:"Switch auto image enlarge option",switch_dir:"Switch reading direction",switch_grid_mode:"Switch grid mode",switch_page_fill:"Switch page fill",switch_scroll_mode:"Switch scroll mode",switch_single_double_page_mode:"Switch single/double page mode"},img_status:{error:"Load Error",loading:"Loading",wait:"Waiting for load"},other:{auto:"Auto",custom:"Custom",disable:"Disable",distance:"distance",download:"Download",enabled:"Enabled",enter_comic_read_mode:"Enter comic reading mode",exit:"Exit",fab_hidden:"Hide floating button",fab_show:"Show floating button",fill_page:"Fill Page",hotkeys:"Hotkeys",img_loading:"Image loading",interval:"interval",loading_img:"Loading image",none:"None",or:"or",other:"Other",page_range:"Please enter the page range.:\\n (e.g., 1, 3-5, 9-)",read_mode:"Reading mode",setting:"Settings"},pwa:{alert:{img_data_error:"Image data error",img_not_found:"Image not found",img_not_found_files:"Please select an image file or a compressed file containing image files",img_not_found_folder:"No image files or compressed files containing image files in the folder",not_valid_url:"Not a valid URL",parse_error:"Parsing error",password_error:"Incorrect password",repeat_load:"Loading other files…",userscript_not_installed:"ComicRead userscript not installed"},button:{enter_url:"Enter URL",install:"Install",no_more_prompt:"Do not prompt again",resume_read:"Restore reading",select_files:"Select File",select_folder:"Select folder"},install_md:"### Tired of opening this webpage every time?\\nIf you wish to:\\n1. Have an independent window, as if using local software\\n1. Add to the local compressed file opening method for easy direct opening\\n1. Use offline\\n### Welcome to install this page as a PWA app on your computer😃👍",message:{enter_password:"Please enter your password",parsing:"Parsing"},tip_enter_url:"Please enter the URL of the compressed file",tip_md:"# ComicRead PWA\\nRead **local** comics using [ComicRead](https://github.com/hymbz/ComicReadScript) reading mode.\\n---\\n### Drag and drop image files, folders, or compressed files directly to start reading\\n*You can also choose to **paste directly** or **enter** the URL of the compressed file for downloading and reading*"},setting:{hotkeys:{add:"Add new hotkeys",restore:"Restore default hotkeys"},language:"Language",option:{abreast_duplicate:"Column duplicates ratio",abreast_mode:"Abreast scroll mode",adjust_to_width:"Adaptive Width",align_edge:"Align to edge when turning page",always_load_all_img:"Always load all images",autoFullscreen:"Auto fullscreen",autoHiddenMouse:"Auto hide mouse",auto_scale:"Auto Scale",auto_scroll_trigger_end:"Continue scrolling on the end page",auto_switch_page_mode:"Auto switch single/double page mode by aspect ratio",background_color:"Background Color",click_page_turn_area:"Touch area",click_page_turn_enabled:"Click to turn page",click_page_turn_swap_area:"Swap LR clickable areas",dark_mode:"Dark mode",dark_mode_auto:"Dark mode follow system",dir_ltr:"LTR (American comics)",dir_rtl:"RTL (Japanese manga)",disable_auto_enlarge:"Disable automatic image enlarge",first_page_fill:"Enable first page fill by default",full_width:"Viewport Width",img_recognition:"Image Recognition",img_recognition_background:"Recognition background color",img_recognition_pageFill:"Auto switch page fill",img_recognition_warn:"❗ The current browser does not support Web Workers. Enabling this feature may cause page lag. It\'s recommended to upgrade or switch browsers.",img_recognition_warn_2:"❗ The current website does not support Web Workers. Enabling this feature may cause page lag.",paragraph_appearance:"Appearance",paragraph_dir:"Reading direction",paragraph_display:"Display",paragraph_scrollbar:"Scrollbar",paragraph_translation:"Translation",preload_page_num:"Preload page number",scroll_end:"After reaching the End",scroll_end_auto:"First jump to previous/next chapter, else exit",scroll_mode_img_scale:"Scroll mode image zoom ratio",scroll_mode_img_spacing:"Scroll mode image spacing",scrollbar_auto_hidden:"Auto hide",scrollbar_easy_scroll:"Easy scroll",scrollbar_position:"position",scrollbar_position_bottom:"Bottom",scrollbar_position_hidden:"Hidden",scrollbar_position_right:"Right",scrollbar_position_top:"Top",scrollbar_show_img_status:"Show image loading status",show_clickable_area:"Show clickable areas",show_comments:"Show comments on the end page",shrink_menu:"Enable menu area",swap_page_turn_key:"Swap LR page-turning keys",zoom:"Image zoom ratio"},sync_options_other_site:"Sync read options to other sites",translation:{cotrans_tip:"<p>Using the interface provided by <a href=\\"https://cotrans.touhou.ai\\" target=\\"_blank\\">Cotrans</a> to translate images, which is maintained by its maintainer at their own expense.</p>\\n<p>When multiple people use it at the same time, they need to queue and wait. If the waiting queue reaches its limit, uploading new images will result in an error. Please try again after a while.</p>\\n<p>So please <b>mind the frequency of use</b>.</p>\\n<p>It is highly recommended to use your own locally deployed project, as it does not consume server resources and does not require queuing.</p>",options:{box_threshold:"Box threshold",detection_resolution:"Text detection resolution",direction:"Render text orientation",direction_auto:"Follow source",direction_horizontal:"Horizontal only",direction_vertical:"Vertical only",force_retry:"Force retry (ignore cache)",inpainter:"Inpainter",inpainting_size:"Inpainting size",local_url:"customize server URL",mask_dilation_offset:"Mask dilation offset",only_download_translated:"Download only the translated images",target_language:"Target language",text_detector:"Text detector",translator:"Translator",unclip_ratio:"Unclip ratio"},range:"Scope of Translation",server:"Translation server",server_selfhosted:"Selfhosted",translate_all:"Translate all images",translate_to_end:"Translate the current page to the end"}},site:{add_feature:{add_hotkeys_actions:"Add hotkeys actions",auto_adjust_option:"Auto adjust reading option",auto_page_turn:"Infinite scroll",auto_show:"Auto enter reading mode",block_totally:"Totally block comics",colorize_tag:"Colorize tags",cross_site_link:"Cross-site Link",detect_ad:"Detect advertise page",expand_tag_list:"Expand tag list",float_tag_list:"Floating tag list",load_original_image:"Load original image",lock_option:"Lock site option",open_link_new_page:"Open links in a new page",quick_favorite:"Quick favorite",quick_rating:"Quick rating",quick_tag_define:"Quick view tag define",remember_current_site:"Remember the current site",tag_lint:"Tag Lint"},changed_load_failed:"The website has undergone changes, unable to load comics",ehentai:{change_favorite_failed:"Failed to change the favorite",change_favorite_success:"Successfully changed the favorite",change_rating_failed:"Failed to change the rating",change_rating_success:"Successfully changed the rating",fetch_favorite_failed:"Failed to get favorite info",fetch_img_page_source_failed:"Failed to get the source code of the image page",fetch_img_page_url_failed:"Failed to get the image page address from the detail page",fetch_img_url_failed:"Failed to get the image address from the image page",hitomi_error:"hitomi matching error",html_changed_link_failed:"The page structure has changed, and the associated external site features are not functioning properly",ip_banned:"IP address is banned",nhentai_error:"nhentai matching error",nhentai_failed:"Matching failed, please refresh after confirming login to {{nhentai}}"},nhentai:{fetch_next_page_failed:"Failed to get next page of comic data",tag_blacklist_fetch_failed:"Failed to fetch tag blacklist"},show_settings_menu:"Show settings menu",simple:{auto_read_mode_message:"\\"Auto enter reading mode\\" is enabled by default",no_img:"No suitable comic images were found.\\nIf necessary, you can click here to close the simple reading mode.",simple_read_mode:"Enter simple reading mode"}},touch_area:{menu:"Menu",type:{edge:"Edge",l:"L",left_right:"Left Right",up_down:"Up Down"}},translation:{status:{colorizing:"Colorizing","default":"Unknown status",detection:"Detecting text",downscaling:"Downscaling",error:"Error during translation","error-lang":"The target language is not supported by the chosen translator","error-translating":"Did not get any text back from the text translation service","error-with-id":"Error during translation",finished:"Finishing",inpainting:"Inpainting","mask-generation":"Generating mask",ocr:"Scanning text",pending:"Pending","pending-pos":"Pending",preparing:"Waiting for idle window",rendering:"Rendering",saved:"Saved","skip-no-regions":"No text regions detected in the image","skip-no-text":"No text detected in the image",textline_merge:"Merging text lines",translating:"Translating",upscaling:"Upscaling"},tip:{check_img_status_failed:"Failed to check image status",download_img_failed:"Failed to download image",get_translator_list_error:"Error occurred while getting the list of available translation services",id_not_returned:"No id returned",img_downloading:"Downloading images",img_not_fully_loaded:"Image has not finished loading",pending:"Pending, {{pos}} in queue",resize_img_failed:"Failed to resize image",translating:"Translating image",translation_completed:"Translation completed",upload:"Uploading image",upload_error:"Image upload error",upload_return_error:"Error during server translation",wait_translation:"Waiting for translation"},translator:{baidu:"baidu",deepl:"DeepL",google:"Google","gpt3.5":"GPT-3.5",none:"Remove texts",offline:"offline translator",original:"Original",youdao:"youdao"}},upscale:{module_download_complete:"Image Upscaling Model Download Complete",module_download_failed:"Image Upscaling Model Download Failed",module_downloading:"Image Upscaling Model Downloading...",title:"Upscale Image",upscaled:"upscaled",upscaling:"upscaling",webgpu_tip:"Unable to upscale images using WebGPU, processing will be slower"}};\n\nconst ru = {alert:{comic_load_error:"Ошибка загрузки комикса",download_failed:"Ошибка загрузки",fetch_comic_img_failed:"Не удалось загрузить изображения",img_load_failed:"Не удалось загрузить изображение",no_img_download:"Нет доступных картинок для загрузки",repeat_load:"Загрузка изображения, пожалуйста подождите",retry_get_img_url:"Повторно получить адрес изображения на странице {{i}}",server_connect_failed:"Не удалось подключиться к серверу"},button:{auto_scroll:"Автопрокрутка",close_current_page_translation:"Скрыть перевод текущей страницы",download_completed:"Загрузка завершена",download_completed_error:"Загрузка завершена, но {{errorNum}} изображений не удалось загрузить",downloading:"Скачивание",fullscreen:"полноэкранный",fullscreen_exit:"выйти из полноэкранного режима",grid_mode:"Режим сетки",packaging:"Упаковка",page_fill:"Заполнить страницу",page_mode_double:"Двухчастичный режим",page_mode_single:"Одностраничный режим",scroll_mode:"Режим прокрутки",translate_current_page:"Перевести текущую страницу",zoom_in:"Приблизить",zoom_out:"Уменьшить"},description:"Добавляет расширенные функции для удобства на сайт, такие как двухстраничный режим и перевод.",eh_tag_lint:{combo:"[тег]: В большинстве случаев должен сосуществовать с [тегом]",conflict:"[tag]: Не должен сосуществовать с [tag]",correct_tag:"Должен быть правильный тег",miss_female:"Отсутствует мужской тег, возможно, понадобится",miss_parody:"Отсутствует тег пародии, возможно, понадобится",possible_conflict:"[tag]: В большинстве случаев не должен сосуществовать с [tag]",prerequisite:"[tag]: Предварительный тег [tag] не существует"},end_page:{next_button:"Следующая глава",prev_button:"Предыдущая глава",tip:{end_jump:"Последняя страница, следующая глава ниже",exit:"Последняя страница, ниже комикс будет закрыт",start_jump:"Первая страница, выше будет загружена предыдущая глава"}},hotkeys:{enter_read_mode:"Режим чтения",float_tag_list:"Плавающий список тегов",jump_to_end:"Перейти к последней странице",jump_to_home:"Перейти к первой странице",page_down:"Перелистнуть страницу вниз",page_up:"Перелистнуть страницу вверх",repeat_tip:"Эта горячая клавиша была назначена на \\"{{hotkey}}\\"",scroll_down:"Прокрутить вниз",scroll_left:"Прокрутить влево",scroll_right:"Прокрутите вправо",scroll_up:"Прокрутите вверх",switch_auto_enlarge:"Автоматическое приближение",switch_dir:"Направление чтения",switch_grid_mode:"Режим сетки",switch_page_fill:"Заполнение страницы",switch_scroll_mode:"Режим прокрутки",switch_single_double_page_mode:"Одностраничный/Двухстраничный режим"},img_status:{error:"Ошибка загрузки",loading:"Загрузка",wait:"Ожидание загрузки"},other:{auto:"Авто",custom:"Custom",disable:"Отключить",distance:"расстояние",download:"Скачать",enabled:"Включено",enter_comic_read_mode:"Режим чтения комиксов",exit:"Выход",fab_hidden:"Скрыть плавающую кнопку",fab_show:"Показать плавающую кнопку",fill_page:"Заполнить страницу",hotkeys:"Горячие клавиши",img_loading:"Изображение загружается",interval:"интервал",loading_img:"Загрузка изображения",none:"Отсутствует",or:"или",other:"Другое",page_range:"Введите диапазон страниц.:\\n (например, 1, 3-5, 9-)",read_mode:"Режим чтения",setting:"Настройки"},pwa:{alert:{img_data_error:"Ошибка данных изображения",img_not_found:"Изображение не найдено",img_not_found_files:"Пожалуйста выберите файл или архив с изображениями",img_not_found_folder:"В папке не найдены изображения или архивы с изображениями",not_valid_url:"Невалидный URL",parse_error:"Ошибка анализа",password_error:"Неверный пароль",repeat_load:"Загрузка других файлов…",userscript_not_installed:"ComicRead не установлен"},button:{enter_url:"Ввести URL",install:"Установить",no_more_prompt:"Больше не показывать",resume_read:"Продолжить чтение",select_files:"Выбрать файл",select_folder:"Выбрать папку"},install_md:"### Устали открывать эту страницу каждый раз?\\nЕсли вы хотите:\\n1. Иметь отдельное окно, как если бы вы использовали обычное программное обеспечение\\n1. Открывать архивы напрямую\\n1. Пользоваться оффлайн\\n### Установите эту страницу в качестве [PWA](https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B5%D1%81%D1%81%D0%B8%D0%B2%D0%BD%D0%BE%D0%B5_%D0%B2%D0%B5%D0%B1-%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5) на свой компьютер 🐺☝️",message:{enter_password:"Пожалуйста введите пароль",parsing:"Разбор"},tip_enter_url:"Введите URL архива",tip_md:"# ComicRead PWA\\nИспользуйте [ComicRead](https://github.com/hymbz/ComicReadScript) для чтения комиксов **локально**.\\n---\\n### Перетащите изображения, папки или архивы чтобы начать читать\\n*Вы так же можете **открыть** или **вставить** URL архива на напрямую*"},setting:{hotkeys:{add:"Добавить горячие клавиши",restore:"Восстановить горячие клавиши по умолчанию"},language:"Язык",option:{abreast_duplicate:"Коэффициент дублирования столбцов",abreast_mode:"Режим прокрутки в ряд",adjust_to_width:"Адаптивная ширина",align_edge:"Выравнивание по краю при перелистывании страницы",always_load_all_img:"Всегда загружать все изображения",autoFullscreen:"Авто полный экран",autoHiddenMouse:"Автоматически скрывать курсор мыши",auto_scale:"Авто масштаб",auto_scroll_trigger_end:"Продолжить прокрутку на конечной странице",auto_switch_page_mode:"Автоматическое переключение режима одной/двойной страницы в зависимости от соотношения сторон",background_color:"Цвет фона",click_page_turn_area:"Область нажатия",click_page_turn_enabled:"Перелистывать по клику",click_page_turn_swap_area:"Поменять местами правую и левую области переключения страниц",dark_mode:"Тёмная тема",dark_mode_auto:"Тёмный режим следует за системой",dir_ltr:"Чтение слева направо (Американские комиксы)",dir_rtl:"Чтение справа налево (Японская манга)",disable_auto_enlarge:"Отключить автоматическое масштабирование изображений",first_page_fill:"Включить заполнение первой страницы по умолчанию",full_width:"Ширина окна просмотра",img_recognition:"распознавание изображений",img_recognition_background:"Определить цвет фона",img_recognition_pageFill:"Автоматическое переключение заполнения страницы",img_recognition_warn:"❗ Текущий браузер не поддерживает Web Workers. Включение этой функции может вызвать задержку страницы. Рекомендуется обновить или сменить браузер.",img_recognition_warn_2:"❗ Текущий веб-сайт не поддерживает Web Workers. Включение этой функции может привести к задержке страницы.",paragraph_appearance:"Внешность",paragraph_dir:"Направление чтения",paragraph_display:"Отображение",paragraph_scrollbar:"Полоса прокрутки",paragraph_translation:"Перевод",preload_page_num:"Предзагружать страниц",scroll_end:"После достижения конца",scroll_end_auto:"Сначала переход к предыдущей/следующей главе, иначе выход",scroll_mode_img_scale:"Коэффициент масштабирования изображения в режиме скроллинга",scroll_mode_img_spacing:"Расстояние между страницами в режиме скроллинга",scrollbar_auto_hidden:"Автоматически скрывать",scrollbar_easy_scroll:"Лёгкая прокрутка",scrollbar_position:"Позиция",scrollbar_position_bottom:"Снизу",scrollbar_position_hidden:"Спрятано",scrollbar_position_right:"Справа",scrollbar_position_top:"Сверху",scrollbar_show_img_status:"Показывать статус загрузки изображения",show_clickable_area:"Показывать кликабельные области",show_comments:"Показывать комментарии на последней странице",shrink_menu:"Включить область меню",swap_page_turn_key:"Поменять местами клавиши переключения страниц",zoom:"Коэффициент масштабирования изображения"},sync_options_other_site:"Синхронизировать настройки чтения с другими сайтами",translation:{cotrans_tip:"<p>Использует для перевода <a href=\\"https://cotrans.touhou.ai\\" target=\\"_blank\\">Cotrans API</a>, работающий исключительно за счёт своего создателя.</p>\\n<p>Запросы обрабатываются по одному в порядке синхронной очереди. Когда очередь превышает лимит новые запросы будут приводить к ошибке. Если такое случилось попробуйте позже.</p>\\n<p>Так что пожалуйста <b>учитывайте загруженность при выборе</b></p>\\n<p>Настоятельно рекомендовано использовать проект развёрнутый локально т.к. это не потребляет серверные ресурсы и вы не ограничены очередью.</p>",options:{box_threshold:"Порог коробки",detection_resolution:"Разрешение распознавания текста",direction:"Ориетнация текста",direction_auto:"Следование оригиналу",direction_horizontal:"Только горизонтально",direction_vertical:"Только вертикально",force_retry:"Принудительный повтор(Игнорировать кэш)",inpainter:"Инпейнтер",inpainting_size:"Инпейнтинг размер области",local_url:"Настроить URL сервера",mask_dilation_offset:"Маскировочное смещение дилатации",only_download_translated:"Скачать только переведённые изображения",target_language:"Целевой язык",text_detector:"Детектор текста",translator:"Переводчик",unclip_ratio:"Необрезанное соотношение"},range:"Объем перевода",server:"Сервер",server_selfhosted:"Свой",translate_all:"Перевести все изображения",translate_to_end:"Переводить страницу до конца"}},site:{add_feature:{add_hotkeys_actions:"Добавить операции с горячими клавишами",auto_adjust_option:"Автоматическая настройка параметра чтения",auto_page_turn:"Бесконечная прокрутка",auto_show:"Автоматически включать режим чтения",block_totally:"Глобально заблокировать комиксы",colorize_tag:"Цветные названия",cross_site_link:"Кросс-сайтовая ссылка",detect_ad:"Detect advertise page",expand_tag_list:"Развернуть список тегов",float_tag_list:"Плавающий список тегов",load_original_image:"Загружать оригинальное изображение",lock_option:"Блокировка опции сайта",open_link_new_page:"Открывать ссылки в новой вкладке",quick_favorite:"Быстрый фаворит",quick_rating:"Быстрый рейтинг",quick_tag_define:"Определение тега быстрого просмотра",remember_current_site:"Запомнить текущий сайт",tag_lint:"Тэг Линт"},changed_load_failed:"Страница изменилась, невозможно загрузить комикс",ehentai:{change_favorite_failed:"Не удалось изменить избранное",change_favorite_success:"Избранное успешно изменено",change_rating_failed:"Не удалось изменить оценку",change_rating_success:"Успешно изменен рейтинг",fetch_favorite_failed:"Не удалось получить информацию о избранном",fetch_img_page_source_failed:"Не удалось получить исходный код страницы с изображениями",fetch_img_page_url_failed:"Не удалось получить адрес страницы изображений из деталей",fetch_img_url_failed:"Не удалось получить адрес изображения",hitomi_error:"Ошибка сопоставления hitomi",html_changed_link_failed:"Структура страницы изменилась, и связанные функции внешнего сайта не работают должным образом",ip_banned:"IP адрес забанен",nhentai_error:"Ошибка сопоставления nhentai",nhentai_failed:"Ошибка сопостовления. Пожалуйста перезагрузите страницу после входа на {{nhentai}}"},nhentai:{fetch_next_page_failed:"Не удалось получить следующую страницу",tag_blacklist_fetch_failed:"Не удалось получить заблокированные теги"},show_settings_menu:"Показать меню настроек",simple:{auto_read_mode_message:"\\"Автоматически включать режим чтения\\" по умолчанию",no_img:"Не найдено подходящих изображений. Нажмите тут что бы выключить режим простого чтения.",simple_read_mode:"Включить простой режим чтения"}},touch_area:{menu:"Меню",type:{edge:"Грань",l:"L",left_right:"Лево Право",up_down:"Верх Низ"}},translation:{status:{colorizing:"Раскрашивание","default":"Неизвестный статус",detection:"Распознавание текста",downscaling:"Уменьшение масштаба",error:"Ошибка перевода","error-lang":"Целевой язык не поддерживается выбранным переводчиком","error-translating":"Ошибка перевода(пустой ответ)","error-with-id":"Ошибка во время перевода",finished:"Завершение",inpainting:"Наложение","mask-generation":"Генерация маски",ocr:"Распознавание текста",pending:"Ожидание","pending-pos":"Ожидание",preparing:"Ожидание окна бездействия",rendering:"Отрисовка",saved:"Сохранено","skip-no-regions":"На изображении не обнаружено текстовых областей.","skip-no-text":"Текст на изображении не обнаружен",textline_merge:"Обьединение текста",translating:"Переводится",upscaling:"Увеличение изображения"},tip:{check_img_status_failed:"Не удалось проверить статус изображения",download_img_failed:"Не удалось скачать изображение",get_translator_list_error:"Произошла ошибка во время получения списка доступных переводчиков",id_not_returned:"ID не вернули(",img_downloading:"Скачать",img_not_fully_loaded:"Изображение всё ещё загружается",pending:"Ожидение, позиция в очереди {{pos}}",resize_img_failed:"Не удалось изменить размер изображения",translating:"Изображение переводится",translation_completed:"Перевод завершён",upload:"Загрузка изображения",upload_error:"Ошибка отправки изображения",upload_return_error:"Ошибка перевода на сервере",wait_translation:"Ожидание перевода"},translator:{baidu:"baidu",deepl:"DeepL",google:"Google","gpt3.5":"GPT-3.5",none:"Убрать текст",offline:"Оффлайн переводчик",original:"Оригинал",youdao:"youdao"}},upscale:{module_download_complete:"Загрузка модели увеличения изображений завершена",module_download_failed:"Сбой загрузки модели увеличения изображений",module_downloading:"Загрузка модели увеличения изображений...",title:"Увеличение изображения",upscaled:"Увеличенный",upscaling:"Увеличивается",webgpu_tip:"Невозможно увеличить изображения с помощью WebGPU, обработка будет медленнее"}};\n\nconst zh = {alert:{comic_load_error:"漫画加载出错",download_failed:"下载失败",fetch_comic_img_failed:"获取漫画图片失败",img_load_failed:"图片加载失败",no_img_download:"没有能下载的图片",repeat_load:"加载图片中，请稍候",retry_get_img_url:"重新获取第 {{i}} 页图片的地址",server_connect_failed:"无法连接到服务器"},button:{auto_scroll:"自动滚动",close_current_page_translation:"关闭当前页的翻译",download_completed:"下载完成",download_completed_error:"下载完成，但有 {{errorNum}} 张图片下载失败",downloading:"下载中",fullscreen:"全屏",fullscreen_exit:"退出全屏",grid_mode:"网格模式",packaging:"打包中",page_fill:"页面填充",page_mode_double:"双页模式",page_mode_single:"单页模式",scroll_mode:"卷轴模式",translate_current_page:"翻译当前页",zoom_in:"放大",zoom_out:"缩小"},description:"为漫画站增加双页阅读、翻译等优化体验的增强功能。",eh_tag_lint:{combo:"存在 [tag] 时，一般也存在 [tag]",conflict:"存在 [tag] 时，不应该存在 [tag]",correct_tag:"应该是正确的标签",miss_female:"缺少男性标签，可能需要",miss_parody:"缺少原作标签，可能需要",possible_conflict:"存在 [tag] 时，一般不应该存在 [tag]",prerequisite:"[tag] 的前置标签 [tag] 不存在"},end_page:{next_button:"下一话",prev_button:"上一话",tip:{end_jump:"已到结尾，继续向下翻页将跳至下一话",exit:"已到结尾，继续翻页将退出",start_jump:"已到开头，继续向上翻页将跳至上一话"}},hotkeys:{enter_read_mode:"进入阅读模式",float_tag_list:"悬浮标签列表",jump_to_end:"跳至尾页",jump_to_home:"跳至首页",page_down:"向下翻页",page_up:"向上翻页",repeat_tip:"此快捷键已被绑定至「{{hotkey}}」",scroll_down:"向下滚动",scroll_left:"向左滚动",scroll_right:"向右滚动",scroll_up:"向上滚动",switch_auto_enlarge:"切换图片自动放大选项",switch_dir:"切换阅读方向",switch_grid_mode:"切换网格模式",switch_page_fill:"切换页面填充",switch_scroll_mode:"切换卷轴模式",switch_single_double_page_mode:"切换单双页模式"},img_status:{error:"加载出错",loading:"正在加载",wait:"等待加载"},other:{auto:"自动",custom:"自定义",disable:"禁用",distance:"距离",download:"下载",enabled:"启用",enter_comic_read_mode:"进入漫画阅读模式",exit:"退出",fab_hidden:"隐藏悬浮按钮",fab_show:"显示悬浮按钮",fill_page:"填充页",hotkeys:"快捷键",img_loading:"图片加载中",interval:"间隔",loading_img:"加载图片中",none:"无",or:"或",other:"其他",page_range:"请输入页码范围：\\n（例如：1, 3-5, 9-)",read_mode:"阅读模式",setting:"设置"},pwa:{alert:{img_data_error:"图片数据错误",img_not_found:"找不到图片",img_not_found_files:"请选择图片文件或含有图片文件的压缩包",img_not_found_folder:"文件夹下没有图片文件或含有图片文件的压缩包",not_valid_url:"不是有效的 URL",parse_error:"解析出错",password_error:"密码错误",repeat_load:"正在加载其他文件中……",userscript_not_installed:"未安装 ComicRead 脚本"},button:{enter_url:"输入 URL",install:"安装",no_more_prompt:"不再提示",resume_read:"恢复阅读",select_files:"选择文件",select_folder:"选择文件夹"},install_md:"### 每次都要打开这个网页很麻烦？\\n如果你希望\\n1. 能有独立的窗口，像是在使用本地软件一样\\n1. 加入本地压缩文件的打开方式之中，方便直接打开\\n1. 离线使用~~（主要是担心国内网络抽风无法访问这个网页~~\\n### 欢迎将本页面作为 PWA 应用安装到电脑上😃👍",message:{enter_password:"请输入密码",parsing:"解析中"},tip_enter_url:"请输入压缩包 URL",tip_md:"# ComicRead PWA\\n使用 [ComicRead](https://github.com/hymbz/ComicReadScript) 的阅读模式阅读**本地**漫画\\n---\\n### 将图片文件、文件夹、压缩包直接拖入即可开始阅读\\n*也可以选择**直接粘贴**或**输入**压缩包 URL 下载阅读*"},setting:{hotkeys:{add:"添加新快捷键",restore:"恢复默认快捷键"},language:"语言",option:{abreast_duplicate:"每列重复比例",abreast_mode:"并排卷轴模式",adjust_to_width:"自适应宽度",align_edge:"滚动翻页时对齐边缘",always_load_all_img:"始终加载所有图片",autoFullscreen:"自动全屏",autoHiddenMouse:"自动隐藏鼠标",auto_scale:"自动缩放",auto_scroll_trigger_end:"在结束页上继续滚动",auto_switch_page_mode:"按屏幕比例切换单双页",background_color:"背景颜色",click_page_turn_area:"点击区域",click_page_turn_enabled:"点击翻页",click_page_turn_swap_area:"左右点击区域交换",dark_mode:"黑暗模式",dark_mode_auto:"黑暗模式跟随系统",dir_ltr:"从左到右（美漫）",dir_rtl:"从右到左（日漫）",disable_auto_enlarge:"禁止图片自动放大",first_page_fill:"默认启用首页填充",full_width:"视窗宽度",img_recognition:"图像识别",img_recognition_background:"识别背景色",img_recognition_pageFill:"自动调整页面填充",img_recognition_warn:"❗ 当前浏览器不支持 Web Worker，开启此功能可能导致页面卡顿，建议升级或更换浏览器。",img_recognition_warn_2:"❗ 当前网站不支持 Web Worker，开启此功能可能导致页面卡顿。",paragraph_appearance:"外观",paragraph_dir:"阅读方向",paragraph_display:"显示",paragraph_scrollbar:"滚动条",paragraph_translation:"翻译",preload_page_num:"预加载页数",scroll_end:"翻页至尽头后",scroll_end_auto:"优先跳至上/下一话，否则退出",scroll_mode_img_scale:"卷轴图片缩放",scroll_mode_img_spacing:"卷轴图片间距",scrollbar_auto_hidden:"自动隐藏",scrollbar_easy_scroll:"快捷滚动",scrollbar_position:"位置",scrollbar_position_bottom:"底部",scrollbar_position_hidden:"隐藏",scrollbar_position_right:"右侧",scrollbar_position_top:"顶部",scrollbar_show_img_status:"显示图片加载状态",show_clickable_area:"显示点击区域",show_comments:"在结束页显示评论",shrink_menu:"缩小菜单区域",swap_page_turn_key:"左右翻页键交换",zoom:"图片缩放"},sync_options_other_site:"同步阅读配置至其他站点",translation:{cotrans_tip:"<p>将使用 <a href=\\"https://cotrans.touhou.ai\\" target=\\"_blank\\">Cotrans</a> 提供的接口翻译图片，该服务器由其维护者用爱发电自费维护</p>\\n<p>多人同时使用时需要排队等待，等待队列达到上限后再上传新图片会报错，需要过段时间再试</p>\\n<p>所以还请 <b>注意用量</b></p>\\n<p>更推荐使用自己本地部署的项目，既不占用服务器资源也不需要排队</p>",options:{box_threshold:"文本框阈值",detection_resolution:"文本扫描清晰度",direction:"渲染字体方向",direction_auto:"原文一致",direction_horizontal:"仅限水平",direction_vertical:"仅限垂直",force_retry:"忽略缓存强制重试",inpainter:"图像修复器",inpainting_size:"图像修复尺寸",local_url:"自定义服务器 URL",mask_dilation_offset:"掩码膨胀偏移量",only_download_translated:"只下载翻译完的图片",target_language:"目标语言",text_detector:"文本扫描器",translator:"翻译服务",unclip_ratio:"文本框膨胀比率"},range:"翻译范围",server:"翻译服务器",server_selfhosted:"本地部署",translate_all:"翻译全部图片",translate_to_end:"翻译当前页至结尾"}},site:{add_feature:{add_hotkeys_actions:"增加快捷键操作",auto_adjust_option:"自动调整阅读配置",auto_page_turn:"无限滚动",auto_show:"自动进入阅读模式",block_totally:"彻底屏蔽漫画",colorize_tag:"标签染色",cross_site_link:"关联外站",detect_ad:"识别广告页",expand_tag_list:"展开标签列表",float_tag_list:"悬浮标签列表",load_original_image:"加载原图",lock_option:"锁定站点配置",open_link_new_page:"在新页面中打开链接",quick_favorite:"快捷收藏",quick_rating:"快捷评分",quick_tag_define:"快捷查看标签定义",remember_current_site:"记住当前站点",tag_lint:"标签检查"},changed_load_failed:"网站发生变化，无法加载漫画",ehentai:{change_favorite_failed:"收藏夹修改失败",change_favorite_success:"收藏夹修改成功",change_rating_failed:"评分修改失败",change_rating_success:"评分修改成功",fetch_favorite_failed:"获取收藏夹信息失败",fetch_img_page_source_failed:"获取图片页源码失败",fetch_img_page_url_failed:"从详情页获取图片页地址失败",fetch_img_url_failed:"从图片页获取图片地址失败",hitomi_error:"hitomi 匹配出错",html_changed_link_failed:"页面结构发生改变，关联外站功能无法正常生效",ip_banned:"IP地址被禁",nhentai_error:"nhentai 匹配出错",nhentai_failed:"匹配失败，请在确认登录 {{nhentai}} 后刷新"},nhentai:{fetch_next_page_failed:"获取下一页漫画数据失败",tag_blacklist_fetch_failed:"标签黑名单获取失败"},show_settings_menu:"显示设置菜单",simple:{auto_read_mode_message:"已默认开启「自动进入阅读模式」",no_img:"未找到合适的漫画图片，\\n如有需要可点此关闭简易阅读模式",simple_read_mode:"使用简易阅读模式"}},touch_area:{menu:"菜单",type:{edge:"边缘",l:"L",left_right:"左右",up_down:"上下"}},translation:{status:{colorizing:"正在上色","default":"未知状态",detection:"正在检测文本",downscaling:"正在缩小图片",error:"翻译出错","error-lang":"你选择的翻译服务不支持你选择的语言","error-translating":"翻译服务没有返回任何文本","error-with-id":"翻译出错",finished:"正在整理结果",inpainting:"正在修补图片","mask-generation":"正在生成文本掩码",ocr:"正在识别文本",pending:"正在等待","pending-pos":"正在等待",preparing:"等待空闲窗口",rendering:"正在渲染",saved:"保存结果","skip-no-regions":"图片中没有检测到文本区域","skip-no-text":"图片中没有检测到文本",textline_merge:"正在整合文本",translating:"正在翻译文本",upscaling:"正在放大图片"},tip:{check_img_status_failed:"检查图片状态失败",download_img_failed:"下载图片失败",get_translator_list_error:"获取可用翻译服务列表时出错",id_not_returned:"未返回 id",img_downloading:"下载图片中",img_not_fully_loaded:"图片未加载完毕",pending:"正在等待，列队还有 {{pos}} 张图片",resize_img_failed:"缩放图片失败",translating:"翻译图片中",translation_completed:"翻译完成",upload:"上传图片中",upload_error:"上传图片出错",upload_return_error:"服务器翻译出错",wait_translation:"等待翻译"},translator:{baidu:"百度",deepl:"DeepL",google:"谷歌","gpt3.5":"GPT-3.5",none:"删除文本",offline:"离线模型",original:"原文",youdao:"有道"}},upscale:{module_download_complete:"图片放大模型下载完成",module_download_failed:"图片放大模型下载失败",module_downloading:"图片放大模型下载中...",title:"无损放大图片",upscaled:"已放大",upscaling:"放大中",webgpu_tip:"无法使用 WebGPU 放大图片，处理速度将变慢"}};\n\n/**\n * Creates a callback that is debounced and cancellable. The debounced callback is called on **trailing** edge.\n *\n * The timeout will be automatically cleared on root dispose.\n *\n * @param callback The callback to debounce\n * @param wait The duration to debounce in milliseconds\n * @returns The debounced function\n *\n * @see https://github.com/solidjs-community/solid-primitives/tree/main/packages/scheduled#debounce\n *\n * @example\n * ```ts\n * const fn = debounce((message: string) => console.log(message), 250);\n * fn(\'Hello!\');\n * fn.clear() // clears a timeout in progress\n * ```\n */\nconst debounce$1 = (callback, wait) => {\n    if (web.isServer) {\n        return Object.assign(() => void 0, { clear: () => void 0 });\n    }\n    let timeoutId;\n    const clear = () => clearTimeout(timeoutId);\n    if (solidJs.getOwner())\n        solidJs.onCleanup(clear);\n    const debounced = (...args) => {\n        if (timeoutId !== undefined)\n            clear();\n        timeoutId = setTimeout(() => callback(...args), wait);\n    };\n    return Object.assign(debounced, { clear });\n};\n/**\n * Creates a callback that is throttled and cancellable. The throttled callback is called on **trailing** edge.\n *\n * The timeout will be automatically cleared on root dispose.\n *\n * @param callback The callback to throttle\n * @param wait The duration to throttle\n * @returns The throttled callback trigger\n *\n * @see https://github.com/solidjs-community/solid-primitives/tree/main/packages/scheduled#throttle\n *\n * @example\n * ```ts\n * const trigger = throttle((val: string) => console.log(val), 250);\n * trigger(\'my-new-value\');\n * trigger.clear() // clears a timeout in progress\n * ```\n */\nconst throttle$1 = (callback, wait) => {\n    if (web.isServer) {\n        return Object.assign(() => void 0, { clear: () => void 0 });\n    }\n    let isThrottled = false, timeoutId, lastArgs;\n    const throttled = (...args) => {\n        lastArgs = args;\n        if (isThrottled)\n            return;\n        isThrottled = true;\n        timeoutId = setTimeout(() => {\n            callback(...lastArgs);\n            isThrottled = false;\n        }, wait);\n    };\n    const clear = () => {\n        clearTimeout(timeoutId);\n        isThrottled = false;\n    };\n    if (solidJs.getOwner())\n        solidJs.onCleanup(clear);\n    return Object.assign(throttled, { clear });\n};\n/**\n * Creates a scheduled and cancellable callback that will be called on the **leading** edge for the first call, and **trailing** edge for other calls.\n *\n * The timeout will be automatically cleared on root dispose.\n *\n * @param schedule {@link debounce} or {@link throttle}\n * @param callback The callback to debounce/throttle\n * @param wait timeout duration\n * @returns The scheduled callback trigger\n *\n * @see https://github.com/solidjs-community/solid-primitives/tree/main/packages/scheduled#leadingAndTrailing\n *\n * @example\n * ```ts\n * const trigger = leadingAndTrailing(throttle, (val: string) => console.log(val), 250);\n * trigger(\'my-new-value\');\n * trigger.clear() // clears a timeout in progress\n * ```\n */\nfunction leadingAndTrailing(schedule, callback, wait) {\n    if (web.isServer) {\n        let called = false;\n        const scheduled = (...args) => {\n            if (called)\n                return;\n            called = true;\n            callback(...args);\n        };\n        return Object.assign(scheduled, { clear: () => void 0 });\n    }\n    let State;\n    (function (State) {\n        State[State["Ready"] = 0] = "Ready";\n        State[State["Leading"] = 1] = "Leading";\n        State[State["Trailing"] = 2] = "Trailing";\n    })(State || (State = {}));\n    let state = State.Ready;\n    const scheduled = schedule((args) => {\n        state === State.Trailing && callback(...args);\n        state = State.Ready;\n    }, wait);\n    const fn = (...args) => {\n        if (state !== State.Trailing) {\n            if (state === State.Ready)\n                callback(...args);\n            state += 1;\n        }\n        scheduled(args);\n    };\n    const clear = () => {\n        state = State.Ready;\n        scheduled.clear();\n    };\n    if (solidJs.getOwner())\n        solidJs.onCleanup(clear);\n    return Object.assign(fn, { clear });\n}\n/**\n * Creates a signal used for scheduling execution of solid computations by tracking.\n *\n * @param schedule Schedule the invalidate function (can be {@link debounce} or {@link throttle})\n * @returns A function used to track the signal. It returns `true` if the signal is dirty *(callback should be called)* and `false` otherwise.\n *\n * @see https://github.com/solidjs-community/solid-primitives/tree/main/packages/scheduled#createScheduled\n *\n * @example\n * ```ts\n * const debounced = createScheduled(fn => debounce(fn, 250));\n *\n * createEffect(() => {\n *   // track source signal\n *   const value = count();\n *   // track the debounced signal and check if it\'s dirty\n *   if (debounced()) {\n *     console.log(\'count\', value);\n *   }\n * });\n * ```\n */\n// Thanks to Fabio Spampinato (https://github.com/fabiospampinato) for the idea for the primitive\nfunction createScheduled(schedule) {\n    let listeners = 0;\n    let isDirty = false;\n    const [track, dirty] = solidJs.createSignal(void 0, { equals: false });\n    const call = schedule(() => {\n        isDirty = true;\n        dirty();\n    });\n    return () => {\n        if (!isDirty)\n            call(), track();\n        if (isDirty) {\n            isDirty = !!listeners;\n            return true;\n        }\n        if (solidJs.getListener()) {\n            listeners++;\n            solidJs.onCleanup(() => listeners--);\n        }\n        return false;\n    };\n}\n\nfunction getDefaultExportFromCjs (x) {\n\treturn x && x.__esModule && Object.prototype.hasOwnProperty.call(x, \'default\') ? x[\'default\'] : x;\n}\n\nvar es6 = function equal(a, b) {\n  if (a === b) return true;\n\n  if (a && b && typeof a == \'object\' && typeof b == \'object\') {\n    if (a.constructor !== b.constructor) return false;\n\n    var length, i, keys;\n    if (Array.isArray(a)) {\n      length = a.length;\n      if (length != b.length) return false;\n      for (i = length; i-- !== 0;)\n        if (!equal(a[i], b[i])) return false;\n      return true;\n    }\n\n\n    if ((a instanceof Map) && (b instanceof Map)) {\n      if (a.size !== b.size) return false;\n      for (i of a.entries())\n        if (!b.has(i[0])) return false;\n      for (i of a.entries())\n        if (!equal(i[1], b.get(i[0]))) return false;\n      return true;\n    }\n\n    if ((a instanceof Set) && (b instanceof Set)) {\n      if (a.size !== b.size) return false;\n      for (i of a.entries())\n        if (!b.has(i[0])) return false;\n      return true;\n    }\n\n    if (ArrayBuffer.isView(a) && ArrayBuffer.isView(b)) {\n      length = a.length;\n      if (length != b.length) return false;\n      for (i = length; i-- !== 0;)\n        if (a[i] !== b[i]) return false;\n      return true;\n    }\n\n\n    if (a.constructor === RegExp) return a.source === b.source && a.flags === b.flags;\n    if (a.valueOf !== Object.prototype.valueOf) return a.valueOf() === b.valueOf();\n    if (a.toString !== Object.prototype.toString) return a.toString() === b.toString();\n\n    keys = Object.keys(a);\n    length = keys.length;\n    if (length !== Object.keys(b).length) return false;\n\n    for (i = length; i-- !== 0;)\n      if (!Object.prototype.hasOwnProperty.call(b, keys[i])) return false;\n\n    for (i = length; i-- !== 0;) {\n      var key = keys[i];\n\n      if (!equal(a[key], b[key])) return false;\n    }\n\n    return true;\n  }\n\n  // true if both NaN, false otherwise\n  return a!==a && b!==b;\n};\n\nconst isEqual = /*@__PURE__*/getDefaultExportFromCjs(es6);\n\n/** 图片文件扩展名缩写 */\nconst fileType = {\n  j: \'jpg\',\n  p: \'png\',\n  g: \'gif\',\n  w: \'webp\',\n  b: \'bmp\'\n};\nconst throttle = (fn, wait = 100) => leadingAndTrailing(throttle$1, fn, wait);\nconst debounce = (fn, wait = 100) => debounce$1(fn, wait);\nconst sleep = ms => new Promise(resolve => setTimeout(resolve, ms));\nconst clamp = (min, val, max) => Math.max(Math.min(max, val), min);\nconst inRange = (min, val, max) => val >= min && val <= max;\nconst getFileName = url => url.match(/.+\\/([^?]+)/)?.[1];\n\n/** 判断两个数是否在指定误差范围内相等 */\nconst approx = (val, target, range = 1) => Math.abs(target - val) <= range;\n\n/** 创建一个只会执行一次的函数 */\nconst onec = fn => {\n  let hasRun = false;\n  return () => {\n    if (hasRun) return;\n    hasRun = true;\n    fn();\n  };\n};\n\n// oxlint-disable-next-line func-style\nfunction range(a, b, c) {\n  switch (typeof b) {\n    case \'undefined\':\n      return [...Array.from({\n        length: a\n      }).keys()];\n    case \'number\':\n      {\n        const list = [];\n        for (let i = a; i < b; i++) list.push(c ? c(i) : i);\n        return list;\n      }\n    case \'function\':\n      return Array.from({\n        length: a\n      }, (_, i) => b(i));\n    case \'string\':\n      return Array.from({\n        length: a\n      }, () => b);\n  }\n}\n\n/**\n * 对 document.querySelector 的封装\n * 将默认返回类型改为 HTMLElement\n */\nconst querySelector = selector => document.querySelector(selector);\n\n/**\n * 对 document.querySelector 的封装\n * 将默认返回类型改为 HTMLElement\n */\nconst querySelectorAll = selector => [...document.querySelectorAll(selector)];\n\n/** 返回 Dom 的点击函数 */\nconst querySelectorClick = (selector, textContent) => {\n  let getDom;\n  if (typeof selector === \'function\') getDom = selector;else if (textContent) {\n    getDom = () => querySelectorAll(selector).find(e => e.textContent?.includes(textContent));\n  } else getDom = () => querySelector(selector);\n  if (getDom()) return () => getDom()?.click();\n};\n\n/** 找出数组中出现最多次的元素 */\nconst getMostItem = list => {\n  const counts = new Map();\n  for (const val of list) counts.set(val, (counts.get(val) ?? 0) + 1);\n  return [...counts.entries()].reduce((maxItem, item) => maxItem[1] > item[1] ? maxItem : item)[0];\n};\n\n/** 判断字符串是否为 URL */\nconst isUrl = text => {\n  // 等浏览器版本上来后可以直接使用 URL.canParse\n  try {\n    return Boolean(new URL(text));\n  } catch {\n    return false;\n  }\n};\n\n/** 将 blob 数据作为文件保存至本地 */\nconst saveAs = (blob, name = \'download\') => {\n  const a = document.createElementNS(\'http://www.w3.org/1999/xhtml\', \'a\');\n  a.download = name;\n  a.rel = \'noopener\';\n  a.href = URL.createObjectURL(blob);\n  setTimeout(() => a.dispatchEvent(new MouseEvent(\'click\')));\n};\n\n/** 滚动页面到指定元素的所在位置 */\nconst scrollIntoView = (selector, behavior = \'instant\') => querySelector(selector)?.scrollIntoView({\n  behavior\n});\n/** 确保函数在同一时间下只有一个在运行 */\nconst singleThreaded = (callback, initState) => {\n  const state = {\n    running: false,\n    argList: [],\n    continueRun: (...args) => state.argList.length > 0 || state.argList.push(args),\n    ...initState\n  };\n  const work = async () => {\n    if (state.argList.length === 0) return;\n    const args = state.argList.shift();\n    try {\n      state.running = true;\n      await callback(state, ...args);\n    } catch (error) {\n      await sleep(100);\n      if (state.argList.length === 0) throw error;\n    } finally {\n      if (state.abandon) state.argList.length = 0;\n      if (state.argList.length > 0) setTimeout(work, state.timeout);else state.running = false;\n    }\n  };\n  return (...args) => {\n    state.argList.push(args);\n    if (!state.running) return work();\n  };\n};\n\n/**\n * 限制 Promise 并发\n * @param fnList 任务函数列表\n * @param callBack 成功执行一个 Promise 后调用，主要用于显示进度\n * @param limit 限制数\n * @returns 所有 Promise 的返回值\n */\nconst plimit = async (fnList, callBack = undefined, limit = 10) => {\n  let doneNum = 0;\n  const totalNum = fnList.length;\n  const resList = [];\n  const execPool = new Set();\n  const taskList = fnList.map((fn, i) => {\n    let p;\n    return () => {\n      p = (async () => {\n        resList[i] = await fn();\n        doneNum += 1;\n        execPool.delete(p);\n        callBack?.(doneNum, totalNum, resList, i);\n      })();\n      execPool.add(p);\n    };\n  });\n\n  // eslint-disable-next-line no-unmodified-loop-condition\n  while (doneNum !== totalNum) {\n    while (taskList.length > 0 && execPool.size < limit) taskList.shift()();\n    await Promise.race(execPool);\n  }\n  return resList;\n};\n\n/** Promise 并发队列 */\nclass PQueue {\n  wait = new Set();\n  running = new Set();\n  done = new Set();\n  constructor(handleTask, concurrency = 1) {\n    this.handleTask = handleTask;\n    this.concurrency = concurrency;\n  }\n  has = item => this.running.has(item) || this.done.has(item) || this.wait.has(item);\n  async processQueue() {\n    if (this.running.size >= this.concurrency || this.wait.size === 0) return;\n    const [item] = this.wait;\n    if (item === undefined) return;\n    this.wait.delete(item);\n    if (!this.running.has(item)) {\n      try {\n        this.running.add(item);\n        await this.handleTask(item);\n        this.done.add(item);\n      } catch (error) {\n        console.error(error);\n      } finally {\n        this.running.delete(item);\n      }\n    }\n    return this.processQueue();\n  }\n  add(item) {\n    if (this.has(item)) return;\n    this.wait.add(item);\n    this.processQueue();\n  }\n  set(...items) {\n    this.wait.clear();\n    this.wait = new Set(items.filter(item => !this.has(item)));\n    this.processQueue();\n  }\n  clear() {\n    this.wait.clear();\n    this.done.clear();\n  }\n}\n\n/**\n * 判断使用参数颜色作为默认值时是否需要切换为黑暗模式\n * @param hexColor 十六进制颜色。例如 #112233\n */\nconst needDarkMode = hexColor => {\n  // by: https://24ways.org/2010/calculating-color-contrast\n  const r = Number.parseInt(hexColor.slice(1, 3), 16);\n  const g = Number.parseInt(hexColor.slice(3, 5), 16);\n  const b = Number.parseInt(hexColor.slice(5, 7), 16);\n  const yiq = (r * 299 + g * 587 + b * 114) / 1000;\n  return yiq < 128;\n};\n\n// oxlint-disable-next-line func-style\nasync function wait(fn, timeout = Number.POSITIVE_INFINITY, waitTime = 100) {\n  let res = await fn();\n  let _timeout = timeout;\n  while (_timeout > 0 && !res) {\n    await sleep(waitTime);\n    _timeout -= waitTime;\n    res = await fn();\n  }\n  return res;\n}\n\nasync function waitDom(selector, timeout) {\n  return wait(() => querySelector(selector), timeout);\n}\n\n/** 等待指定的图片元素加载完成 */\nconst waitImgLoad = (target, timeout) => new Promise((resolve, reject) => {\n  const img = typeof target === \'string\' ? new Image() : target;\n  if (img.complete && img.naturalHeight) resolve(img);\n  const id = timeout ? window.setTimeout(() => reject(new Error(\'timeout\')), timeout) : undefined;\n  const handleError = e => {\n    window.clearTimeout(id);\n    reject(new Error(e.message));\n  };\n  const handleLoad = () => {\n    window.clearTimeout(id);\n    img.removeEventListener(\'error\', handleError);\n    resolve(img);\n  };\n  img.addEventListener(\'load\', handleLoad, {\n    once: true\n  });\n  img.addEventListener(\'error\', handleError, {\n    once: true\n  });\n  if (typeof target === \'string\') img.src = target;\n});\n\n/** 将指定的布尔值转换为字符串或未定义 */\nconst boolDataVal = val => val ? \'\' : undefined;\n\n/** 测试图片 url 能否正确加载 */\nconst testImgUrl = url => new Promise(resolve => {\n  const img = new Image();\n  img.onload = () => resolve(true);\n  img.onerror = () => resolve(false);\n  img.src = url;\n});\nconst canvasToBlob = (canvas, type, quality = 1) => {\n  if (canvas instanceof OffscreenCanvas) return canvas.convertToBlob({\n    type,\n    quality\n  });\n  return new Promise((resolve, reject) => {\n    canvas.toBlob(blob => blob ? resolve(blob) : reject(new Error(\'Canvas toBlob failed\')), type, quality);\n  });\n};\n\n/**\n * 求 a 和 b 的差集，相当于从 a 中删去和 b 相同的属性\n *\n * 不会修改参数对象，返回的是新对象\n */\nconst difference = (a, b) => {\n  const res = {};\n  const keys = Object.keys(a);\n  for (const key of keys) {\n    if (typeof a[key] === \'object\' && typeof b[key] === \'object\') {\n      const _res = difference(a[key], b[key]);\n      if (Object.keys(_res).length > 0) res[key] = _res;\n    } else if (a[key] !== b?.[key]) res[key] = a[key];\n  }\n  return res;\n};\nconst _assign = (a, b) => {\n  // oxlint-disable-next-line prefer-structured-clone\n  const res = JSON.parse(JSON.stringify(a));\n  const keys = Object.keys(b);\n  for (const key of keys) {\n    if (res[key] === undefined) res[key] = b[key];else if (typeof b[key] === \'object\') {\n      const _res = _assign(res[key], b[key]);\n      if (Object.keys(_res).length > 0) res[key] = _res;\n    } else if (res[key] !== b[key]) res[key] = b[key];\n  }\n  return res;\n};\n\n/**\n * Object.assign 的深拷贝版，不会导致子对象属性的缺失\n *\n * 不会修改参数对象，返回的是新对象\n */\nconst assign = (target, ...sources) => {\n  let res = target;\n  for (const source of sources) if (typeof source === \'object\') res = _assign(res, source);\n  return res;\n};\n\n/** 根据路径获取对象下的指定值 */\nconst byPath = (obj, path, handleVal) => {\n  const keys = typeof path === \'string\' ? path.split(\'.\') : path;\n  let target = obj;\n  for (let i = 0; i < keys.length; i++) {\n    let key = keys[i];\n\n    // 兼容含有「.」的 key\n    while (!Reflect.has(target, key) && i < keys.length) {\n      i += 1;\n      if (keys[i] === undefined) break;\n      key += `.${keys[i]}`;\n    }\n    if (handleVal && i > keys.length - 2 && Reflect.has(target, key)) {\n      const res = handleVal(target, key);\n      while (i < keys.length - 1) {\n        target = target[key];\n        i += 1;\n        key = keys[i];\n      }\n      if (res !== undefined) target[key] = res;\n      break;\n    }\n    target = target[key];\n  }\n  if (target === obj) return null;\n  return target;\n};\nconst requestIdleCallback = (callback, timeout) => {\n  if (Reflect.has(window, \'requestIdleCallback\')) return window.requestIdleCallback(callback, {\n    timeout\n  });\n  return window.setTimeout(callback, 16);\n};\n\n/** 获取键盘事件的编码 */\nconst getKeyboardCode = e => {\n  let {\n    key\n  } = e;\n  switch (key) {\n    case \'Shift\':\n    case \'Control\':\n    case \'Alt\':\n      return key;\n  }\n  key = key.replaceAll(/\\b[A-Z]\\b/g, match => match.toLowerCase());\n  if (e.ctrlKey) key = `Ctrl + ${key}`;\n  if (e.altKey) key = `Alt + ${key}`;\n  if (e.shiftKey) key = `Shift + ${key}`;\n  return key;\n};\n\n/** 将快捷键的编码转换成更易读的形式 */\nconst keyboardCodeToText = code => code.replace(\'Control\', \'Ctrl\').replace(\'ArrowUp\', \'↑\').replace(\'ArrowDown\', \'↓\').replace(\'ArrowLeft\', \'←\').replace(\'ArrowRight\', \'→\').replace(/^\\s$/, \'Space\');\n\n/** 将 HTML 字符串转换为 DOM 对象 */\nconst domParse = html => new DOMParser().parseFromString(html, \'text/html\');\n\n/**\n * 劫持修改原网页上的函数\n *\n * 如果传入函数的所需参数为零，将在原函数执行完后自动调用\n */\nconst hijackFn = (fnName, fn) => {\n  const rawFn = unsafeWindow[fnName];\n  unsafeWindow[fnName] = fn.length === 0 ? (...args) => {\n    const res = rawFn(...args);\n    fn();\n    return res;\n  } : (...args) => fn(rawFn, args);\n};\nconst getGmValue = async (name, setValueFn) => {\n  const value = await GM.getValue(name);\n  if (value !== undefined) return value;\n  await setValueFn();\n  return await GM.getValue(name);\n};\n\n/** 根据范围文本提取指定范围的元素的 index */\nconst extractRange = (rangeText, length) => {\n  const list = new Set();\n  for (const text of rangeText.replaceAll(/[^\\d,-]/g, \'\').split(\',\')) {\n    if (/^\\d+$/.test(text)) list.add(Number(text) - 1);else if (/^\\d*-\\d*$/.test(text)) {\n      let [start, end] = text.split(\'-\').map(Number);\n      end ||= length;\n      for (start--, end--; start <= end; start++) list.add(start);\n    }\n  }\n  return list;\n};\n\n/** extractRange 的逆向，按照相同的语法表述一个结果数组 */\nconst descRange = (list, length) => {\n  let text = \'\';\n  const nowRange = [];\n  const pushRange = newIndex => {\n    if (nowRange.length === 0) return;\n    if (text.length > 0) text += \', \';\n    if (nowRange.length === 1) text += nowRange[0] + 1;else {\n      const end = newIndex === undefined && nowRange[1] === length - 1 ? \'\' : nowRange[1] + 1;\n      text += `${nowRange[0] + 1}-${end}`;\n    }\n    nowRange.length = 0;\n    if (newIndex !== undefined) nowRange[0] = newIndex;\n  };\n  for (const i of list) {\n    switch (nowRange.length) {\n      case 0:\n        nowRange[0] = i;\n        break;\n      case 1:\n        if (i === nowRange[0] + 1) nowRange[1] = i;else pushRange(i);\n        break;\n      case 2:\n        if (i === nowRange[1] + 1) nowRange[1] = i;else pushRange(i);\n        break;\n    }\n  }\n  pushRange();\n  return text;\n};\n\n/** 监听 url 变化 */\nconst onUrlChange = (fn, handleUrl = location => location.href) => {\n  let lastUrl = \'\';\n  const refresh = singleThreaded(async () => {\n    if (!(await wait(() => handleUrl(location) !== lastUrl, 5000))) return;\n    const nowUrl = handleUrl(location);\n    await fn(lastUrl, nowUrl);\n    lastUrl = nowUrl;\n  });\n  const controller = new AbortController();\n  for (const eventName of [\'click\', \'popstate\']) window.addEventListener(eventName, refresh, {\n    capture: true,\n    signal: controller.signal\n  });\n  refresh();\n  return () => controller.abort();\n};\n\n/** wait，但是只在 url 变化时判断 */\nconst waitUrlChange = isValidUrl => new Promise(resolve => {\n  const abort = onUrlChange(() => {\n    if (!isValidUrl()) return;\n    resolve();\n    abort();\n  });\n});\n\n// TODO: 用这个重构相关实现\nclass AnimationFrame {\n  animationId = 0;\n  call = () => {\n    this.animationId = requestAnimationFrame(this.frame);\n  };\n  cancel = () => {\n    if (!this.animationId) return;\n    cancelAnimationFrame(this.animationId);\n    this.animationId = 0;\n  };\n}\n\n/** 锁定屏幕禁止自动熄屏 */\nclass WakeLock {\n  isSupported = false;\n  lock = null;\n  constructor() {\n    if (!(\'wakeLock\' in navigator)) return;\n    this.isSupported = true;\n  }\n  on = async () => {\n    if (!this.isSupported) return null;\n    try {\n      this.lock = await navigator.wakeLock.request(\'screen\');\n      return this.lock.released;\n    } catch {\n      return false;\n    }\n  };\n  off = async () => {\n    if (!this.lock) return;\n    await this.lock.release();\n    this.lock = null;\n  };\n}\nconst getImageData = img => {\n  const {\n    naturalWidth: width,\n    naturalHeight: height\n  } = img;\n  const canvas = new OffscreenCanvas(width, height);\n  const ctx = canvas.getContext(\'2d\', {\n    willReadFrequently: true\n  });\n  ctx.drawImage(img, 0, 0);\n  return ctx.getImageData(0, 0, width, height);\n};\n\nconst [lang, setLang] = solidJs.createSignal(\'zh\');\nconst setInitLang = async () => setLang(await languages.getInitLang());\nconst t = solidJs.createRoot(() => {\n  solidJs.createEffect(solidJs.on(lang, () => languages.setSaveLang(lang()), {\n    defer: true\n  }));\n  const locales = solidJs.createMemo(() => {\n    switch (lang()) {\n      case \'en\':\n        return en;\n      case \'ru\':\n        return ru;\n      default:\n        return zh;\n    }\n  });\n  return (keys, variables) => {\n    let text = byPath(locales(), keys) ?? \'\';\n    if (variables) for (const [k, v] of Object.entries(variables)) text = text.replaceAll(`{{${k}}}`, `${String(v)}`);\n    return text;\n  };\n});\n\nconst prefix = [\'%cComicRead\', \'background-color: #607d8b; color: white; padding: 2px 4px; border-radius: 4px;\'];\n\n// oxlint-disable-next-line no-console\nconst log = (...args) => console.log(...prefix, ...args);\nlog.warn = (...args) => console.warn(...prefix, ...args);\nlog.error = (...args) => console.error(...prefix, ...args);\n\nlet publicOwner;\nsolidJs.createRoot(() => {\n  publicOwner = solidJs.getOwner();\n});\n\n/** 会自动设置 equals 的 createSignal */\nconst createEqualsSignal = (init, options) => solidJs.createSignal(init, {\n  equals: isEqual,\n  ...options\n});\n\n/** 会自动设置 equals 和 createRoot 的 createMemo */\nconst createRootMemo = (fn, init, options) => {\n  // 如果函数已经是 createMemo 创建的，就直接使用\n  if (fn.name === \'bound readSignal\') return fn;\n  const _init = init ?? fn(undefined);\n  // 自动为对象类型设置 equals\n  const _options = options?.equals === undefined && typeof _init === \'object\' ? {\n    ...options,\n    equals: isEqual\n  } : options;\n  return solidJs.getOwner() ? solidJs.createMemo(fn, _init, _options) : solidJs.runWithOwner(publicOwner, () => solidJs.createMemo(fn, _init, _options));\n};\n\n/** 节流的 createMemo */\nconst createThrottleMemo = (fn, wait = 100, init = fn(undefined), options = undefined) => {\n  const scheduled = createScheduled(_fn => throttle(_fn, wait));\n  return createRootMemo(prev => scheduled() ? fn(prev) : prev, init, options);\n};\nconst createMemoMap = fnMap => {\n  const memoMap = Object.fromEntries(Object.entries(fnMap).map(([key, fn]) => [key, createRootMemo(fn)]));\n  const map = createRootMemo(() => {\n    const obj = {};\n    for (const key of Object.keys(memoMap)) Reflect.set(obj, key, memoMap[key]());\n    return obj;\n  });\n  return map;\n};\nconst createRootEffect = (fn, val, options) => solidJs.getOwner() ? solidJs.createEffect(fn, val, options) : solidJs.runWithOwner(publicOwner, () => solidJs.createEffect(fn, val, options));\nconst createEffectOn = (deps, fn, options) => createRootEffect(solidJs.on(deps, fn, options));\nconst onAutoMount = fn => {\n  const owner = solidJs.getOwner();\n  if (!owner) return fn(owner);\n  solidJs.onMount(() => {\n    const cleanFn = fn(owner);\n    if (cleanFn) solidJs.onCleanup(cleanFn);\n  });\n};\n\nconst promisifyRequest = request => new Promise((resolve, reject) => {\n  request.onsuccess = () => resolve(request.result);\n  request.onerror = () => reject(request.error);\n});\nconst openDb = (name, version, initSchema) => new Promise((resolve, reject) => {\n  const request = indexedDB.open(`ComicReadScript${name}`, version);\n  request.onupgradeneeded = () => initSchema(request.result);\n  request.onsuccess = () => resolve(request.result);\n  request.onerror = error => {\n    console.error(\'数据库打开失败\', error);\n    reject(new Error(\'数据库打开失败\'));\n  };\n});\nconst useCache = async (schema, name = \'\', version = 2) => {\n  const db = await openDb(name, version, typeof schema === \'function\' ? schema : db => {\n    for (const storeName of db.objectStoreNames) if (!Reflect.has(schema, storeName)) db.deleteObjectStore(storeName);\n    for (const storeName of Object.keys(schema)) {\n      if (!db.objectStoreNames.contains(storeName)) db.createObjectStore(storeName, {\n        keyPath: schema[storeName]\n      });\n    }\n  });\n  return {\n    set: (storeName, value) => promisifyRequest(db.transaction(storeName, \'readwrite\').objectStore(storeName).put(value)),\n    get: (storeName, query) => promisifyRequest(db.transaction(storeName, \'readonly\').objectStore(storeName).get(query)),\n    del: (storeName, query) => promisifyRequest(db.transaction(storeName, \'readwrite\').objectStore(storeName).delete(query)),\n    each(storeName, callback) {\n      const request = db.transaction(storeName, \'readwrite\').objectStore(storeName).openCursor();\n      request.onsuccess = async function onsuccess(event) {\n        const cursor = event.target.result;\n        if (!cursor) return;\n        await callback(cursor.value, cursor);\n        cursor.continue();\n      };\n    }\n  };\n};\n\nconst createPointerState = (e, type = \'down\') => {\n  const xy = [e.clientX, e.clientY];\n  return {\n    id: e.pointerId,\n    type,\n    xy,\n    initial: xy,\n    last: xy,\n    startTime: performance.now(),\n    target: e.target\n  };\n};\nconst useDrag = ({\n  ref,\n  handleDrag,\n  easyMode,\n  handleClick,\n  skip,\n  setCapture,\n  touches = new Map()\n}) => {\n  onAutoMount(() => {\n    const controller = new AbortController();\n    const options = {\n      capture: false,\n      passive: true,\n      signal: controller.signal\n    };\n    let allowClick = -1;\n    const handleDown = e => {\n      if (skip?.(e)) return;\n      e.stopPropagation();\n      if (!easyMode?.() && e.buttons !== 1) return;\n      if (setCapture) ref.setPointerCapture(e.pointerId);\n      const state = createPointerState(e);\n      touches.set(e.pointerId, state);\n      handleDrag(state, e);\n\n      // 在时限内松手才触发 click 事件\n      allowClick = window.setTimeout(() => {\n        allowClick = 0;\n      }, 300);\n    };\n    const handleMove = e => {\n      e.preventDefault();\n      if (!easyMode?.() && e.buttons !== 1) return;\n      const state = touches.get(e.pointerId);\n      if (!state) return;\n      state.type = \'move\';\n      state.xy = [e.clientX, e.clientY];\n      handleDrag(state, e);\n      state.last = state.xy;\n\n      // 拖拽一段距离后就不触发 click 了\n      if (allowClick > 0 && (Math.abs(e.clientX - state.initial[0]) > 5 || Math.abs(e.clientY - state.initial[1]) > 5)) {\n        window.clearTimeout(allowClick);\n        allowClick = -2;\n      }\n    };\n    const handleUp = e => {\n      e.stopPropagation();\n      ref.releasePointerCapture(e.pointerId);\n      const state = touches.get(e.pointerId);\n      if (!state) return;\n      touches.delete(e.pointerId);\n      state.type = \'up\';\n      state.xy = [e.clientX, e.clientY];\n\n      // 判断单击\n      if (handleClick && allowClick && touches.size === 0 && approx(state.xy[0] - state.initial[0], 0, 5) && approx(state.xy[1] - state.initial[1], 0, 5)) handleClick(e, state.target);\n      window.clearTimeout(allowClick);\n      handleDrag(state, e);\n    };\n    const handleCancel = e => {\n      e.stopPropagation();\n      ref.releasePointerCapture(e.pointerId);\n      const state = touches.get(e.pointerId);\n      if (!state) return;\n      state.type = \'cancel\';\n      handleDrag(state, e);\n      touches.clear();\n    };\n    ref.addEventListener(\'pointerdown\', handleDown, options);\n    ref.addEventListener(\'pointermove\', handleMove, {\n      ...options,\n      passive: false\n    });\n    ref.addEventListener(\'pointerup\', handleUp, options);\n    ref.addEventListener(\'pointercancel\', handleCancel, options);\n    if (easyMode) {\n      ref.addEventListener(\'pointerover\', handleDown, options);\n      ref.addEventListener(\'pointerout\', handleUp, options);\n    }\n    ref.addEventListener(\'click\', e => {\n      if (allowClick > 0 && touches.size === 0 || skip?.(e)) return;\n      e.stopPropagation();\n      e.preventDefault();\n    }, {\n      capture: true\n    });\n    return () => controller.abort();\n  });\n};\n\nconst useStore = initState => {\n  const [store$1, _setState] = store.createStore(initState);\n  const setState = (...args) => {\n    if (args.length === 1 && typeof args[0] === \'function\') return _setState(store.produce(args[0]));\n    return _setState(...args);\n  };\n  return {\n    store: store$1,\n    setState\n  };\n};\n\nconst useStyleSheet = e => {\n  const styleSheet = new CSSStyleSheet();\n  onAutoMount(() => {\n    const root = e?.getRootNode() ?? document;\n    root.adoptedStyleSheets = [...root.adoptedStyleSheets, styleSheet];\n    return () => {\n      const index = root.adoptedStyleSheets.indexOf(styleSheet);\n      if (index !== -1) root.adoptedStyleSheets.splice(index, 1);\n    };\n  });\n  return styleSheet;\n};\nconst useStyle = (css, e) => {\n  const styleSheet = useStyleSheet(e);\n  if (typeof css === \'string\') styleSheet.replaceSync(css);else createEffectOn(createRootMemo(css), style => styleSheet.replaceSync(style));\n};\n/** 用 CSSStyleSheet 实现和修改 style 一样的效果 */\nconst useStyleMemo = (selector, styleMapArg, e) => {\n  const styleSheet = useStyleSheet(e);\n  styleSheet.insertRule(`${selector} { }`);\n  const {\n    style\n  } = styleSheet.cssRules[0];\n  // 等火狐实现了 CSS Typed OM 后改用 styleMap 性能会更好，也能使用 CSS Typed OM 的 单位\n\n  const setStyle = (key, val) => {\n    if (val === undefined || val === \'\') return style.removeProperty(key);\n    style.setProperty(key, typeof val === \'string\' ? val : `${val}`);\n  };\n  const styleMapList = Array.isArray(styleMapArg) ? styleMapArg : [styleMapArg];\n  for (const styleMap of styleMapList) {\n    if (typeof styleMap === \'object\') {\n      for (const [key, val] of Object.entries(styleMap)) {\n        const styleText = createRootMemo(val);\n        createEffectOn(styleText, newVal => setStyle(key, newVal));\n      }\n    } else {\n      const styleMemoMap = createRootMemo(styleMap);\n      createEffectOn(styleMemoMap, map => {\n        for (const [key, val] of Object.entries(map)) setStyle(key, val);\n      });\n    }\n  }\n};\n\nexports.AnimationFrame = AnimationFrame;\nexports.FaviconProgress = FaviconProgress;\nexports.PQueue = PQueue;\nexports.WakeLock = WakeLock;\nexports.approx = approx;\nexports.assign = assign;\nexports.boolDataVal = boolDataVal;\nexports.byPath = byPath;\nexports.canvasToBlob = canvasToBlob;\nexports.clamp = clamp;\nexports.createEffectOn = createEffectOn;\nexports.createEqualsSignal = createEqualsSignal;\nexports.createMemoMap = createMemoMap;\nexports.createRootEffect = createRootEffect;\nexports.createRootMemo = createRootMemo;\nexports.createScheduled = createScheduled;\nexports.createThrottleMemo = createThrottleMemo;\nexports.debounce = debounce;\nexports.descRange = descRange;\nexports.difference = difference;\nexports.domParse = domParse;\nexports.extractRange = extractRange;\nexports.fileType = fileType;\nexports.getFileName = getFileName;\nexports.getGmValue = getGmValue;\nexports.getImageData = getImageData;\nexports.getKeyboardCode = getKeyboardCode;\nexports.getMostItem = getMostItem;\nexports.hijackFn = hijackFn;\nexports.inRange = inRange;\nexports.isEqual = isEqual;\nexports.isUrl = isUrl;\nexports.keyboardCodeToText = keyboardCodeToText;\nexports.lang = lang;\nexports.log = log;\nexports.mountComponents = mountComponents;\nexports.needDarkMode = needDarkMode;\nexports.onAutoMount = onAutoMount;\nexports.onUrlChange = onUrlChange;\nexports.onec = onec;\nexports.plimit = plimit;\nexports.promisifyRequest = promisifyRequest;\nexports.querySelector = querySelector;\nexports.querySelectorAll = querySelectorAll;\nexports.querySelectorClick = querySelectorClick;\nexports.range = range;\nexports.requestIdleCallback = requestIdleCallback;\nexports.saveAs = saveAs;\nexports.scrollIntoView = scrollIntoView;\nexports.setInitLang = setInitLang;\nexports.setLang = setLang;\nexports.singleThreaded = singleThreaded;\nexports.sleep = sleep;\nexports.t = t;\nexports.testImgUrl = testImgUrl;\nexports.throttle = throttle;\nexports.useCache = useCache;\nexports.useDrag = useDrag;\nexports.useFaviconProgress = useFaviconProgress;\nexports.useStore = useStore;\nexports.useStyle = useStyle;\nexports.useStyleMemo = useStyleMemo;\nexports.wait = wait;\nexports.waitDom = waitDom;\nexports.waitImgLoad = waitImgLoad;\nexports.waitUrlChange = waitUrlChange;\n';break;case"request":c="\nconst Toast = require('components/Toast');\nconst helper = require('helper');\n\n// 将 xmlHttpRequest 包装为 Promise\nconst xmlHttpRequest = details => new Promise((resolve, reject) => {\n  const handleError = error => {\n    details.onerror?.(error);\n    console.error('GM_xmlhttpRequest Error', error);\n    reject(new Error(error?.responseText || 'GM_xmlhttpRequest Error'));\n  };\n  const abort = GM_xmlhttpRequest({\n    ...details,\n    onload(res) {\n      details.onload?.call(res, res);\n      resolve(res);\n    },\n    onerror: handleError,\n    ontimeout: handleError,\n    onabort: handleError\n  });\n  details.signal?.addEventListener('abort', abort.abort);\n});\n\n/** 发起请求 */\nconst request = async (url, details = {}, retryNum = 0, errorNum = 0) => {\n  const headers = {\n    Referer: location.href\n  };\n  const errorText = `${details?.errorText ?? helper.t('alert.comic_load_error')}\\nurl: ${url}`;\n  details.fetch ??= url.startsWith('/') || url.startsWith(location.origin);\n  try {\n    // 虽然 GM_xmlhttpRequest 有 fetch 选项，但在 stay 上不太稳定\n    // 为了支持 ios 端只能自己实现一下了\n    if (details.fetch || typeof GM_xmlhttpRequest === 'undefined') {\n      const res = await fetch(url, {\n        method: 'GET',\n        headers,\n        signal: AbortSignal.timeout?.(details.timeout ?? 1000 * 10),\n        body: details.data,\n        ...details\n      });\n      if (!details.noCheckCode && res.status !== 200) {\n        helper.log.error(errorText, res);\n        throw new Error(errorText);\n      }\n      let response = null;\n      switch (details.responseType) {\n        case 'arraybuffer':\n          response = await res.arrayBuffer();\n          break;\n        case 'blob':\n          response = await res.blob();\n          break;\n        case 'json':\n          response = await res.json();\n          break;\n      }\n      const _res = {\n        status: res.status,\n        statusText: res.statusText,\n        response,\n        responseText: response ? '' : await res.text()\n      };\n      details.onload?.call(_res, _res);\n      return _res;\n    }\n    let targetUrl = url;\n    // https://github.com/hymbz/ComicReadScript/issues/195\n    // 在某些情况下 Tampermonkey 无法正确处理相对协议的 url\n    // 实际 finalUrl 会变成 `///xxx.xxx` 莫名多了一个斜杠\n    // 然而在修改代码发出正确的请求后，就再也无法复现了\n    // 不过以防万一还是在这里手动处理下\n    if (url.startsWith('//')) targetUrl = `http:${url}`;\n    // stay 没法处理相对路径，也得转换一下\n    else if (url.startsWith('/')) targetUrl = `${location.origin}${url}`;\n    const res = await xmlHttpRequest({\n      method: 'GET',\n      url: targetUrl,\n      headers,\n      timeout: 1000 * 10,\n      ...details\n    });\n    if (!details.noCheckCode && res.status !== 200) {\n      helper.log.error(errorText, res);\n      throw new Error(errorText);\n    }\n\n    // stay 好像没有正确处理 json，只能再单独判断处理一下\n    if (details.responseType === 'json' && res.responseText && (typeof res.response !== 'object' || Object.keys(res.response).length === 0)) {\n      try {\n        Reflect.set(res, 'response', JSON.parse(res.responseText));\n      } catch {}\n    }\n    return res;\n  } catch (error) {\n    if (details && details.retryFetch && retryNum === 0) {\n      console.warn('retryFetch', url);\n      details.fetch = !details.fetch;\n      return request(url, details, retryNum + 1, errorNum);\n    }\n    if (errorNum >= retryNum) {\n      (details.noTip ? console.error : Toast.toast.error)(`${errorText}\\nerror: ${error.message}`);\n      throw new Error(errorText, {\n        cause: error\n      });\n    }\n    helper.log.error(errorText, error);\n    await helper.sleep(1000);\n    return request(url, details, retryNum, errorNum + 1);\n  }\n};\n\n/** 轮流向多个 api 发起请求 */\nconst eachApi = async (url, baseUrlList, details) => {\n  for (const baseUrl of baseUrlList) {\n    try {\n      return await request(`${baseUrl}${url}`, {\n        ...details,\n        noTip: true\n      });\n    } catch {}\n  }\n  const errorText = details?.errorText ?? helper.t('alert.comic_load_error');\n  if (!details?.noTip) Toast.toast.error(errorText);\n  helper.log.error('所有 api 请求均失败', url, baseUrlList, details);\n  throw new Error(errorText);\n};\n\nexports.eachApi = eachApi;\nexports.request = request;\n";break;case"components/Manga":c="\nconst web = require('solid-js/web');\nconst solidJs = require('solid-js');\nconst helper = require('helper');\nconst request = require('request');\nconst Comlink = require('comlink');\nconst store$1 = require('solid-js/store');\nconst worker = require('worker/ImageRecognition');\nconst fflate = require('fflate');\nconst IconButton$1 = require('components/IconButton');\nconst Toast = require('components/Toast');\nconst worker$1 = require('worker/ImageUpscale');\n\nconst imgState = {\n  imgMap: {},\n  imgList: [],\n  pageList: [],\n  fillEffect: {\n    '-1': true\n  },\n  showRange: [0, 0],\n  renderRange: [0, 0],\n  loadingRange: [0, 0],\n  defaultImgType: ''\n};\n\nconst _defaultOption = {\n  dir: 'rtl',\n  scrollbar: {\n    position: 'auto',\n    autoHidden: false,\n    showImgStatus: true,\n    easyScroll: false\n  },\n  clickPageTurn: {\n    enabled: 'ontouchstart' in document.documentElement,\n    reverse: false,\n    area: 'left_right',\n    shrinkMenu: false\n  },\n  firstPageFill: true,\n  disableZoom: false,\n  darkMode: false,\n  autoDarkMode: false,\n  swapPageTurnKey: false,\n  scroolEnd: 'auto',\n  alwaysLoadAllImg: false,\n  showComment: true,\n  preloadPageNum: 20,\n  pageNum: 0,\n  autoSwitchPageMode: true,\n  autoHiddenMouse: true,\n  autoFullscreen: false,\n  zoom: {\n    ratio: 100,\n    offset: {\n      x: 0,\n      y: 0\n    }\n  },\n  scrollMode: {\n    enabled: false,\n    spacing: 0,\n    imgScale: 1,\n    adjustToWidth: 'disable',\n    abreastMode: false,\n    abreastDuplicate: 0.1,\n    doubleMode: false,\n    alignEdge: false\n  },\n  imgRecognition: {\n    enabled: false,\n    background: true,\n    pageFill: true,\n    upscale: false\n  },\n  translation: {\n    server: 'disable',\n    localUrl: undefined,\n    forceRetry: false,\n    // 一些参数没有使用默认值，而是直接使用文档的推荐值\n    // https://github.com/zyddnys/manga-image-translator?tab=readme-ov-file#recommended-modules\n    options: {\n      detector: {\n        detector: 'ctd',\n        detection_size: '1536',\n        box_threshold: 0.7,\n        unclip_ratio: 2.3\n      },\n      render: {\n        direction: 'auto'\n      },\n      translator: {\n        translator: 'gpt3.5',\n        target_lang: {\n          zh: 'CHS',\n          en: 'ENG',\n          ru: 'RUS'\n        }[helper.lang()] ?? 'CHS'\n      },\n      inpainter: {\n        inpainter: 'lama_large',\n        inpainting_size: '2048'\n      },\n      mask_dilation_offset: 30\n    },\n    onlyDownloadTranslated: false\n  },\n  autoScroll: {\n    enabled: false,\n    interval: 3000,\n    distance: 200,\n    triggerEnd: false\n  }\n};\nconst defaultOption = () => structuredClone(_defaultOption);\nconst optionState = {\n  defaultOption: defaultOption(),\n  option: defaultOption()\n};\n\nconst otherState = {\n  /** 漫画标题 */\n  title: '',\n  /**\n   * 用于防止滚轮连续滚动导致过快触发事件的锁\n   *\n   * - 在首次触发结束页时开启，一段时间关闭。开启时禁止触发结束页的上下话切换功能。\n   */\n  scrollLock: false,\n  /** 当前是否处于全屏状态 */\n  fullscreen: false,\n  rootSize: {\n    width: 0,\n    height: 0\n  },\n  scrollbarSize: {\n    width: 0,\n    height: 0\n  },\n  /** 卷轴模式下的滚动距离 */\n  scrollTop: 0,\n  autoScroll: {\n    play: false,\n    progress: 0\n  },\n  supportWorker: false,\n  supportUpscaleImage: true\n};\n\nconst propState = {\n  commentList: undefined,\n  hotkeys: {},\n  prop: {\n    onExit: undefined,\n    onPrev: undefined,\n    onNext: undefined,\n    onLoading: undefined,\n    onOptionChange: undefined,\n    onHotkeysChange: undefined,\n    editButtonList: list => list,\n    editSettingList: list => list\n  }\n};\n\nconst showState = {\n  isMobile: false,\n  isDragMode: false,\n  activePageIndex: 0,\n  gridMode: false,\n  show: {\n    toolbar: false,\n    scrollbar: false,\n    touchArea: false,\n    endPage: undefined\n  },\n  page: {\n    anima: '',\n    vertical: false,\n    offset: {\n      x: {\n        pct: 0,\n        px: 0\n      },\n      y: {\n        pct: 0,\n        px: 0\n      }\n    }\n  }\n};\n\nconst initStore = {\n  ...imgState,\n  ...showState,\n  ...propState,\n  ...optionState,\n  ...otherState\n};\nconst {\n  store,\n  setState\n} = helper.useStore({\n  ...initStore\n});\nconst refs = {\n  root: undefined,\n  mangaBox: undefined,\n  mangaFlow: undefined,\n  touchArea: undefined,\n  scrollbar: undefined,\n  settingPanel: undefined,\n  // 结束页上的按钮\n  prev: undefined,\n  next: undefined,\n  exit: undefined\n};\n\n// 1. 因为不同汉化组处理情况不同不可能全部适配，所以只能是尽量适配*出现频率更多*的情况\n/** 判断图片是否是跨页图 */\nconst isWideImg = img => {\n  switch (img.type ?? store.defaultImgType) {\n    case 'long':\n    case 'wide':\n      return true;\n    default:\n      return false;\n  }\n};\n\n/** 根据填充页设置双页排列单页图片 */\nconst arrangeImg = (pageList, fill) => {\n  if (pageList.length === 0) return [];\n  const newPageList = [];\n  let imgCache = fill ? [-1] : [];\n  for (const i of pageList) {\n    imgCache.push(i);\n    if (imgCache.length === 2) {\n      newPageList.push(imgCache);\n      imgCache = [];\n    }\n  }\n  if (imgCache.length === 1 && imgCache[0] !== -1) {\n    imgCache.push(-1);\n    newPageList.push(imgCache);\n  }\n  return newPageList;\n};\n\n/** 计算指定图片流中的左右页位置正确的页数 */\nconst computeAccuracy = (imgList, pageList) => {\n  let accuracy = 0;\n  for (const [a, b] of pageList) {\n    if ((imgList[a]?.blankMargin?.left ?? 0) > 0.04) accuracy += 1;\n    if (b === undefined) break;\n    if ((imgList[b]?.blankMargin?.right ?? 0) > 0.04) accuracy += 1;\n  }\n  return accuracy;\n};\n\n/** 自动切换填充页设置到左右页正确率更高的情况 */\nconst arrangePage = (pageList, {\n  imgList,\n  fillEffect,\n  nowFillIndex,\n  switchFill\n}) => {\n  const fill = Boolean(fillEffect[nowFillIndex]);\n  const newPageList = arrangeImg(pageList, fill);\n  if (!switchFill || typeof fillEffect[nowFillIndex] === 'number') return newPageList;\n  const anotherPageList = arrangeImg(pageList, !fill);\n  const anotherAccuracy = computeAccuracy(imgList, anotherPageList);\n  if (anotherAccuracy === 0) return newPageList;\n  const nowAccuracy = computeAccuracy(imgList, newPageList);\n  if (anotherAccuracy <= nowAccuracy) return newPageList;\n  helper.log(`${nowFillIndex} 自动切换页面填充`);\n  fillEffect[nowFillIndex] = !fill;\n  return anotherPageList;\n};\n\n/** 根据图片比例和填充页设置对漫画图片进行排列 */\nconst handleComicData = (imgList, fillEffect, switchFill) => {\n  const context = {\n    imgList,\n    fillEffect,\n    nowFillIndex: -1,\n    switchFill\n  };\n  const pageList = [];\n  const cacheList = [];\n  for (let i = 0; i < imgList.length; i += 1) {\n    const img = imgList[i];\n    if (!isWideImg(img)) {\n      cacheList.push(i);\n      if (Reflect.has(fillEffect, i)) Reflect.deleteProperty(fillEffect, i);\n      continue;\n    }\n\n    // 在除结尾（可能是汉化组图）外的位置出现了跨页图的话，那张跨页图大概率是页序的「正确答案」\n    // 如果这张跨页导致了上面一页缺页，就说明在这之前的填充有误，应该据此调整之前的填充\n    if (typeof fillEffect[context.nowFillIndex] === 'boolean' && i < imgList.length - 2 && (cacheList.length + (fillEffect[context.nowFillIndex] ? 1 : 0)) % 2 === 1) {\n      fillEffect[context.nowFillIndex] = !fillEffect[context.nowFillIndex];\n      return handleComicData(imgList, fillEffect, switchFill);\n    }\n    pageList.push(...arrangePage(cacheList, context), [i]);\n    cacheList.length = 0;\n    if (fillEffect[i] === undefined) fillEffect[i] = false;\n    context.nowFillIndex = i;\n  }\n  if (cacheList.length > 0) pageList.push(...arrangePage(cacheList, context));\n  return pageList;\n};\n\nconst getImg = (i, state = store) => state.imgMap[state.imgList[i]];\n\n/** 找到指定 url 图片在 imgList 里的 index */\nconst getImgIndexs = url => {\n  const indexList = [];\n  for (const [i, imgUrl] of store.imgList.entries()) if (imgUrl === url) indexList.push(i);\n  return indexList;\n};\n\n/** 找到指定 url 图片的 dom */\nconst getImgEle = target => {\n  const index = typeof target === 'number' ? target : store.imgList.indexOf(target);\n  if (index === -1) return;\n  return refs.mangaFlow.querySelector(`#_${index}_0 img`);\n};\n\n/** 找到指定页面所处的图片流 */\nconst findFillIndex = (pageIndex, fillEffect) => {\n  let nowFillIndex = pageIndex;\n  while (!Reflect.has(fillEffect, nowFillIndex)) nowFillIndex -= 1;\n  return nowFillIndex;\n};\n\n/** 触发 onOptionChange */\nconst triggerOnOptionChange = helper.throttle(() => store.prop.onOptionChange?.(helper.difference(store.option, store.defaultOption)), 1000);\n\n/** 在 option 后手动触发 onOptionChange */\nconst setOption = fn => {\n  setState(state => fn(state.option, state));\n  triggerOnOptionChange();\n};\n\n/** 创建用于将 ref 绑定到对应 state 上的工具函数 */\nconst bindRef = name => e => Reflect.set(refs, name, e);\nconst watchDomSize = (name, e) => {\n  const resizeObserver = new ResizeObserver(([{\n    contentRect\n  }]) => {\n    if (!contentRect.width || !contentRect.height) return;\n    setState(state => {\n      state[name] = {\n        width: contentRect.width,\n        height: contentRect.height\n      };\n    });\n  });\n  resizeObserver.disconnect();\n  resizeObserver.observe(e);\n  solidJs.onCleanup(() => resizeObserver.disconnect());\n};\n\n/** 将界面恢复到正常状态 */\nconst resetUI = state => {\n  state.show.toolbar = false;\n  state.show.scrollbar = false;\n  state.show.touchArea = false;\n};\n\n// 特意使用 requestAnimationFrame 和 .click() 是为了能和 Vimium 兼容\n// （虽然因为使用了 shadow dom 的缘故实际还是不能兼容，但说不定之后就改了呢\nconst focus = () => requestAnimationFrame(() => {\n  refs.mangaBox?.click();\n  refs.mangaBox?.focus();\n});\n\n/** 将函数的 state 参数变为可选 */\nconst withOptionalState = fn => (...args) => {\n  // 检查是否传入了 state 参数，没有的话自动调用 setState\n  if (args.length < fn.length) {\n    let result;\n    setState(state => {\n      result = fn(...[...args, state]);\n    });\n    return result;\n  }\n  // 如果传入了 state，直接调用原函数\n  return fn(...args);\n};\nconst closeScrollLock = helper.debounce(() => setState('scrollLock', false), 100);\n/** 打开滚动锁，并在之后自动关闭 */\nconst openScrollLock = withOptionalState(state => {\n  state.scrollLock = true;\n  closeScrollLock();\n});\nconst bindOption$1 = (...path) => ({\n  value: helper.byPath(store.option, path),\n  onChange: val => setOption(draftOption => helper.byPath(draftOption, path, () => val))\n});\n\nconst [defaultHotkeys, setDefaultHotkeys] = solidJs.createSignal({\n  scroll_up: ['w', 'ArrowUp'],\n  scroll_down: ['s', 'ArrowDown'],\n  scroll_left: ['a', 'Shift + a', ',', 'ArrowLeft'],\n  scroll_right: ['d', 'Shift + d', '.', 'ArrowRight'],\n  page_up: ['PageUp', 'Shift + w'],\n  page_down: [' ', 'PageDown', 'Shift + s'],\n  jump_to_home: ['Home'],\n  jump_to_end: ['End'],\n  exit: ['Escape'],\n  switch_page_fill: ['/', 'm', 'z'],\n  switch_scroll_mode: [],\n  switch_grid_mode: [],\n  switch_single_double_page_mode: [],\n  switch_dir: [],\n  switch_auto_enlarge: [],\n  translate_current_page: [],\n  translate_all: [],\n  translate_to_end: [],\n  fullscreen: [],\n  auto_scroll: []\n});\n\n/** 快捷键配置 */\nconst hotkeysMap = helper.createRootMemo(() => Object.fromEntries(Object.entries(store.hotkeys).flatMap(([name, key]) => key.map(k => [k, name]))));\n\n/** 监听快捷键 */\nconst listenHotkey = (actions, capture) => {\n  window.addEventListener('keydown', e => {\n    // 跳过输入框的键盘事件\n    switch (e.target.tagName) {\n      case 'INPUT':\n      case 'TEXTAREA':\n        return;\n    }\n    if (e.target.isContentEditable) return;\n    if (Reflect.has(actions, e.key) && actions[e.key](e) !== 1) {\n      e.stopPropagation();\n      e.preventDefault();\n      e.stopImmediatePropagation();\n    }\n    const hotkeyName = hotkeysMap()[helper.getKeyboardCode(e)];\n    if (Reflect.has(actions, hotkeyName) && actions[hotkeyName](e) !== 1) {\n      e.stopPropagation();\n      e.preventDefault();\n      e.stopImmediatePropagation();\n    }\n  }, {\n    capture\n  });\n};\n\n/** 当前是否为并排卷轴模式 */\nconst isAbreastMode = helper.createRootMemo(() => store.option.scrollMode.enabled && store.option.scrollMode.abreastMode);\n\n/** 当前是否为双页卷轴模式 */\nconst isDoubleMode = helper.createRootMemo(() => store.option.scrollMode.enabled && store.option.scrollMode.doubleMode && !store.option.scrollMode.abreastMode);\n\n/** 当前是否为单页卷轴模式 */\nconst isSingleMode = helper.createRootMemo(() => store.option.scrollMode.enabled && !store.option.scrollMode.doubleMode && !store.option.scrollMode.abreastMode);\n\n/** 当前是否为普通卷轴模式（包含了双页卷轴模式） */\nconst isScrollMode = helper.createRootMemo(() => store.option.scrollMode.enabled && !store.option.scrollMode.abreastMode);\n\n/** 当前是否正在卷轴模式下使用自动缩放值 */\nconst isUseAutoScale = helper.createRootMemo(() => isScrollMode() && typeof store.option.scrollMode.adjustToWidth === 'number');\n\n/** 当前是否开启了识别背景色 */\nconst isEnableBg = helper.createRootMemo(() => store.option.imgRecognition.enabled && store.option.imgRecognition.background);\n\n/** 当前是否开启了图像放大 */\nconst isUpscale = helper.createRootMemo(() => !store.isMobile && store.option.imgRecognition.enabled && store.option.imgRecognition.upscale);\n\n/** 根据视区宽高判断单双页模式 */\nconst autoPageNum = helper.createThrottleMemo(() => store.rootSize.width >= store.rootSize.height ? 2 : 1);\n\n/** 当前使用的单双页模式 */\nconst pageNum = helper.createRootMemo(() => store.option.pageNum || autoPageNum());\n\n/** 是否为单页模式 */\nconst isOnePageMode = helper.createRootMemo(() => {\n  if (store.isMobile || store.imgList.length <= 1) return true;\n  if (store.option.scrollMode.enabled) {\n    if (store.option.scrollMode.abreastMode) return true;\n    return !store.option.scrollMode.doubleMode;\n  }\n  return pageNum() === 1;\n});\n\n/** 并排卷轴模式下的全局滚动填充 */\nconst [abreastScrollFill, _setAbreastScrollFill] = solidJs.createSignal(0);\n/** 并排卷轴模式下的每列布局 */\nconst abreastArea = helper.createRootMemo(prev => {\n  if (!isAbreastMode()) return prev;\n  const columns = [[]];\n  const position = {};\n  let length = 0;\n  const rootHeight = store.rootSize.height;\n  if (!rootHeight || store.imgList.length === 0) return {\n    columns,\n    position,\n    length\n  };\n  const repeatHeight = rootHeight * store.option.scrollMode.abreastDuplicate;\n\n  /** 当前图片在当前列的所在高度 */\n  let top = abreastScrollFill();\n  while (top > rootHeight) {\n    top -= rootHeight - repeatHeight;\n    columns.push([]);\n  }\n  for (let i = 0; i < store.imgList.length; i++) {\n    const img = getImg(i);\n    const imgPosition = [];\n    const imgHeight = img.size.height;\n    length += imgHeight;\n    let height = imgHeight;\n    while (height > 0) {\n      columns.at(-1).push(i);\n      imgPosition.push({\n        column: columns.length - 1,\n        top\n      });\n      if (top < 0 && imgPosition.length > 1) top = 0;\n      const availableHeight = rootHeight - top;\n      top += height;\n      height -= availableHeight;\n\n      // 填满一列后换行\n      if (top < rootHeight) continue;\n      columns.push([]);\n      top = height - imgHeight;\n\n      // 复现上列结尾\n      if (!repeatHeight || columns.length === 1) continue;\n      top += repeatHeight;\n      height = Math.min(imgHeight, height + repeatHeight);\n\n      /** 为了复现而出现的空白部分高度 */\n      let emptyTop = top;\n      let prevImgIndex = i;\n      while (prevImgIndex >= 1 && emptyTop > 0) {\n        prevImgIndex -= 1;\n        // 把上一张图片加进来填补空白\n        columns.at(-1).push(prevImgIndex);\n        const prevImgHeight = getImg(prevImgIndex).size.height;\n        emptyTop -= prevImgHeight;\n        position[prevImgIndex].push({\n          column: columns.length - 1,\n          top: emptyTop\n        });\n      }\n    }\n    position[i] = imgPosition;\n  }\n  return {\n    columns,\n    position,\n    length\n  };\n}, {\n  columns: [],\n  position: {},\n  length: 0\n});\n\n/** 头尾滚动的限制值 */\nconst scrollFillLimit = helper.createRootMemo(() => abreastArea().length - store.rootSize.height);\nconst setAbreastScrollFill = val => _setAbreastScrollFill(helper.clamp(-scrollFillLimit(), val, scrollFillLimit()));\n\n/** 并排卷轴模式下的列宽度 */\nconst abreastColumnWidth = helper.createRootMemo(() => isAbreastMode() ? placeholderSize().width * store.option.scrollMode.imgScale : 0);\n\n/** 并排卷轴模式下当前要显示的列 */\nconst abreastShowColumn = helper.createThrottleMemo(() => {\n  if (!isAbreastMode() || abreastArea().columns.length === 0) return {\n    start: 0,\n    end: 0\n  };\n  const columnWidth = abreastColumnWidth() + store.option.scrollMode.spacing * 7;\n  return {\n    start: helper.clamp(0, Math.floor(store.page.offset.x.px / columnWidth), abreastArea().columns.length - 1),\n    end: helper.clamp(0, Math.floor((store.page.offset.x.px + store.rootSize.width) / columnWidth), abreastArea().columns.length - 1)\n  };\n});\n\n/** 并排卷轴模式下的漫画流宽度 */\nconst abreastContentWidth = helper.createRootMemo(() => abreastArea().columns.length * abreastColumnWidth() + (abreastArea().columns.length - 1) * store.option.scrollMode.spacing * 7);\n\n/** 并排卷轴模式下的最大滚动距离 */\nconst abreastScrollWidth = helper.createRootMemo(() => abreastContentWidth() - store.rootSize.width);\n\n/** 并排卷轴模式下每个图片所在位置的样式 */\nconst imgAreaStyle = helper.createRootMemo(() => {\n  if (!isAbreastMode() || store.gridMode) return '';\n  let styleText = '';\n  for (const index of store.imgList.keys()) {\n    let imgNum = 0;\n    for (const {\n      column,\n      top\n    } of abreastArea().position[index] ?? []) {\n      const itemStyle = `grid-area: _${column} !important; transform: translateY(${top}px);`;\n      styleText += `#_${index}_${imgNum} { ${itemStyle} }\\n`;\n      imgNum += 1;\n    }\n  }\n  return styleText;\n});\n\nconst imgList = helper.createRootMemo(() => store.imgList.map(url => store.imgMap[url]));\n\n/** 当前显示页面 */\nconst activePage = helper.createRootMemo(() => store.pageList[store.activePageIndex] ?? []);\n\n/** 当前显示的第一张图片的 index */\nconst activeImgIndex = helper.createRootMemo(() => activePage().find(i => i !== -1) ?? 0);\n\n/** 当前所处的图片流 */\nconst nowFillIndex = helper.createRootMemo(() => findFillIndex(activeImgIndex(), store.fillEffect));\n\n/** 预加载页数 */\nconst preloadNum = helper.createRootMemo(() => ({\n  back: store.option.preloadPageNum,\n  front: Math.floor(store.option.preloadPageNum / 2)\n}));\n\n/** 获取图片列表中指定属性的中位数 */\nconst getImgMedian = sizeFn => {\n  const list = imgList().filter(img => img.loadType === 'loaded' && img.width).map(sizeFn).toSorted((a, b) => a - b);\n  // 因为涉及到图片默认类型的计算，所以至少等到加载完三张图片再计算，避免被首页大图干扰\n  if (list.length < 3) return null;\n  return list[Math.floor(list.length / 2)];\n};\n\n/** 图片占位尺寸 */\nconst placeholderSize = helper.createThrottleMemo(() => ({\n  width: getImgMedian(img => img.width) ?? 800,\n  height: getImgMedian(img => img.height) ?? 1200\n}), 500);\n\n/** 卷轴模式下的图片缩放比例 */\nconst scrollModeScale = helper.createRootMemo(() => {\n  if (!isUseAutoScale()) return store.option.scrollMode.imgScale;\n\n  // 能让大多数图片的宽度接近指定值的图片缩放比例\n  return store.option.scrollMode.adjustToWidth / placeholderSize().width;\n});\n\n/** 记录每张图片所在的页面 */\nconst imgPageMap = helper.createRootMemo(() => {\n  const map = {};\n  for (let i = 0; i < store.pageList.length; i++) {\n    for (const imgIndex of store.pageList[i]) if (imgIndex !== -1) map[imgIndex] = i;\n  }\n  return map;\n});\n\n/** 滚动距离 */\nconst scrollTop = helper.createRootMemo(() => isAbreastMode() ? store.page.offset.x.px : store.scrollTop);\nconst bindScrollTop = dom => {\n  dom.addEventListener('scroll', () => {\n    // 跳过小于1像素的滚动事件，避免因小数问题引发的误差\n    if (helper.approx(dom.scrollTop, store.scrollTop)) return;\n    setState('scrollTop', dom.scrollTop);\n  }, {\n    passive: true\n  });\n};\n\n// 自动切换黑暗模式\nconst darkModeQuery = matchMedia('(prefers-color-scheme: dark)');\nconst autoSwitchDarkMode = query => {\n  if (!store.option.autoDarkMode) return;\n  if (query.matches === store.option.darkMode) return;\n  setState('option', 'darkMode', query.matches);\n};\ndarkModeQuery.addEventListener('change', autoSwitchDarkMode);\nautoSwitchDarkMode(darkModeQuery);\nhelper.createEffectOn(() => store.option.autoDarkMode, () => autoSwitchDarkMode(darkModeQuery));\n\n// 窗口宽度小于800像素时，标记为移动端\nhelper.createEffectOn(() => store.rootSize.width, width => {\n  const isMobile = helper.inRange(1, width, 800);\n  if (isMobile === store.isMobile) return;\n  setState(state => {\n    state.isMobile = isMobile;\n    resetImgState(state);\n    updatePageData(state);\n  });\n});\n\nfunction getDefaultExportFromCjs (x) {\n\treturn x && x.__esModule && Object.prototype.hasOwnProperty.call(x, 'default') ? x['default'] : x;\n}\n\nvar es6 = function equal(a, b) {\n  if (a === b) return true;\n\n  if (a && b && typeof a == 'object' && typeof b == 'object') {\n    if (a.constructor !== b.constructor) return false;\n\n    var length, i, keys;\n    if (Array.isArray(a)) {\n      length = a.length;\n      if (length != b.length) return false;\n      for (i = length; i-- !== 0;)\n        if (!equal(a[i], b[i])) return false;\n      return true;\n    }\n\n\n    if ((a instanceof Map) && (b instanceof Map)) {\n      if (a.size !== b.size) return false;\n      for (i of a.entries())\n        if (!b.has(i[0])) return false;\n      for (i of a.entries())\n        if (!equal(i[1], b.get(i[0]))) return false;\n      return true;\n    }\n\n    if ((a instanceof Set) && (b instanceof Set)) {\n      if (a.size !== b.size) return false;\n      for (i of a.entries())\n        if (!b.has(i[0])) return false;\n      return true;\n    }\n\n    if (ArrayBuffer.isView(a) && ArrayBuffer.isView(b)) {\n      length = a.length;\n      if (length != b.length) return false;\n      for (i = length; i-- !== 0;)\n        if (a[i] !== b[i]) return false;\n      return true;\n    }\n\n\n    if (a.constructor === RegExp) return a.source === b.source && a.flags === b.flags;\n    if (a.valueOf !== Object.prototype.valueOf) return a.valueOf() === b.valueOf();\n    if (a.toString !== Object.prototype.toString) return a.toString() === b.toString();\n\n    keys = Object.keys(a);\n    length = keys.length;\n    if (length !== Object.keys(b).length) return false;\n\n    for (i = length; i-- !== 0;)\n      if (!Object.prototype.hasOwnProperty.call(b, keys[i])) return false;\n\n    for (i = length; i-- !== 0;) {\n      var key = keys[i];\n\n      if (!equal(a[key], b[key])) return false;\n    }\n\n    return true;\n  }\n\n  // true if both NaN, false otherwise\n  return a!==a && b!==b;\n};\n\nconst isEqual = /*@__PURE__*/getDefaultExportFromCjs(es6);\n\nlet publicOwner;\nsolidJs.createRoot(() => {\n  publicOwner = solidJs.getOwner();\n});\n\n/** 会自动设置 equals 和 createRoot 的 createMemo */\nconst createRootMemo = (fn, init, options) => {\n  // 如果函数已经是 createMemo 创建的，就直接使用\n  if (fn.name === 'bound readSignal') return fn;\n  const _init = fn(undefined);\n  // 自动为对象类型设置 equals\n  const _options = typeof _init === 'object' ? {\n    ...options,\n    equals: isEqual\n  } : options;\n  return solidJs.getOwner() ? solidJs.createMemo(fn, _init, _options) : solidJs.runWithOwner(publicOwner, () => solidJs.createMemo(fn, _init, _options));\n};\n\n/** 卷轴模式下的每页高度 */\nconst pageHeightList = createRootMemo(() => {\n  if (!isScrollMode()) return [];\n  if (!isDoubleMode()) return imgList().map(img => img.size.height ?? 0);\n  const doubleWidth = store.rootSize.width / 2;\n  return store.pageList.map(indexs => {\n    if (indexs.length === 1) return getImg(indexs[0]).size.height;\n\n    // 选择更高的那张图片作为行高度，尽量放大图片\n    let targetImg;\n    for (const i of indexs) {\n      if (i === -1) continue;\n      const img = getImg(i);\n      if (!targetImg || img.size.height > targetImg.size.height) targetImg = img;\n    }\n    if (!targetImg) throw new Error('找不到图片');\n    if (targetImg.size.width < doubleWidth && store.option.scrollMode.adjustToWidth === 'disable') return targetImg.size.height;\n    return targetImg.size.height * (doubleWidth / targetImg.size.width);\n  });\n});\n\n/** 卷轴模式下每页位置 */\nconst pageTopList = createRootMemo(() => {\n  if (!isScrollMode()) return [];\n  const list = Array.from({\n    length: store.pageList.length\n  });\n  for (let top = 0, i = 0; i < store.pageList.length; i++) {\n    list[i] = top;\n    top += pageHeightList()[i] + store.option.scrollMode.spacing * 7;\n  }\n  return list;\n});\n\n/** 卷轴模式下漫画流的总高度 */\nconst contentHeight = createRootMemo(() => {\n  if (!isScrollMode()) return 0;\n  return (pageTopList().at(-1) ?? 0) + (pageHeightList().at(-1) ?? 0);\n});\n\n/** 获取卷轴模式下指定页的位置 */\nconst getPageTop = index => {\n  if (Reflect.has(pageTopList(), index)) return pageTopList()[index];\n  if (index < 0) return 0;\n  return contentHeight();\n};\n\n/** 找到卷轴模式下指定高度上显示的页面 */\nconst findTopPage = (top, initIndex = 0) => {\n  if (top > contentHeight()) return pageTopList().length - 1;\n  for (let i = initIndex; i < pageTopList().length; i++) if (pageTopList()[i] > top) return i === 0 ? 0 : i - 1;\n  return pageTopList().length - 1;\n};\n\n/** 滚动内容的滚动进度 */\nconst scrollProgress = createRootMemo(() => {\n  if (store.option.scrollMode.enabled) return scrollTop();\n  return store.activePageIndex;\n});\n\n/** 滚动内容的总长度 */\nconst scrollLength = createRootMemo(() => {\n  if (store.option.scrollMode.enabled) {\n    if (store.option.scrollMode.abreastMode) return abreastContentWidth();\n    return contentHeight();\n  }\n  return store.pageList.length;\n});\n\n/** 滚动内容的滚动进度百分比 */\nconst scrollPercentage = createRootMemo(() => scrollProgress() / scrollLength());\n\n/** 当前是否已经滚动到顶部 */\nconst isTop = createRootMemo(() => scrollPercentage() === 0);\n\n/** 滚动条元素的长度 */\nconst scrollDomLength = createRootMemo(() => Math.max(store.scrollbarSize.width, store.scrollbarSize.height));\n\n/** 滚动条滑块长度 */\nconst sliderHeight = createRootMemo(() => {\n  let itemLength = 1;\n  if (isScrollMode()) itemLength = store.rootSize.height;\n  if (isAbreastMode()) itemLength = store.rootSize.width;\n  return itemLength / scrollLength();\n});\n\n/** 当前是否已经滚动到底部 */\nconst isBottom = createRootMemo(() => scrollPercentage() + sliderHeight() >= 0.9999);\n\n/** 滚动条滑块的中心点高度 */\nconst sliderMidpoint = createRootMemo(() => scrollDomLength() * (scrollPercentage() + sliderHeight() / 2));\n\n/** 滚动条滑块的位置 */\nconst sliderTop = createRootMemo(() => `${scrollPercentage() * scrollDomLength()}px`);\n\n/** 滚动条位置 */\nconst scrollPosition = createRootMemo(() => {\n  if (store.option.scrollbar.position === 'auto') {\n    if (store.isMobile) return 'top';\n    if (isAbreastMode()) return 'bottom';\n    // 大部分图片都是宽图时，将滚动条移至底部\n    return store.defaultImgType === 'long' ? 'bottom' : 'right';\n  }\n  return store.option.scrollbar.position;\n});\n\n/** 重新计算图片排列 */\nconst updatePageData = state => {\n  const lastActiveImgIndex = activeImgIndex();\n  let newPageList = [];\n  newPageList = isOnePageMode() ? state.imgList.map((_, i) => [i]) : handleComicData(state.imgList.map(url => state.imgMap[url]), state.fillEffect, state.option.imgRecognition.pageFill);\n  if (helper.isEqual(state.pageList, newPageList)) return;\n  state.pageList = newPageList;\n\n  // 在图片排列改变后自动跳转回原先显示图片所在的页数\n  if (lastActiveImgIndex !== activeImgIndex()) {\n    const newActivePageIndex = state.pageList.findIndex(page => page.includes(lastActiveImgIndex));\n    if (newActivePageIndex !== -1) state.activePageIndex = newActivePageIndex;\n  }\n};\nupdatePageData.throttle = helper.throttle(() => setState(updatePageData), 100);\n\n/**\n * 将处理图片的相关变量恢复到初始状态\n *\n * 必须按照以下顺序调用\n * 1. 修改 imgList\n * 2. resetImgState\n * 3. updatePageData\n */\nconst resetImgState = state => {\n  if (state.imgList.length === 0) {\n    state.fillEffect = {\n      '-1': true\n    };\n    return;\n  }\n\n  // 如果用户没有手动修改过首页填充，才将其恢复初始\n  if (typeof state.fillEffect['-1'] === 'boolean') state.fillEffect['-1'] = state.option.firstPageFill && state.imgList.length > 3;\n};\nhelper.createEffectOn([pageNum, isOnePageMode], () => setState(updatePageData));\n\n/** 阻止事件冒泡 */\nconst stopPropagation = e => {\n  e.stopPropagation();\n};\n\n/** 从头开始播放元素的动画 */\nconst playAnimation = e => {\n  if (!e) return;\n  for (const animation of e.getAnimations()) {\n    animation.cancel();\n    animation.play();\n  }\n};\nconst downloadImgHeaders = {\n  Accept: 'image/avif,image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8',\n  'User-Agent': navigator.userAgent,\n  Referer: location.href\n};\nconst downloadImg = async (imgUrl, details) => {\n  const url = store.imgMap[imgUrl]?.blobUrl ?? imgUrl;\n  if (url.startsWith('blob:')) {\n    const res = await fetch(url);\n    return res.blob();\n  }\n  const res = await request.request(url, {\n    responseType: 'blob',\n    errorText: helper.t('translation.tip.download_img_failed'),\n    headers: downloadImgHeaders,\n    retryFetch: true,\n    ...details\n  });\n  if (Reflect.has(store.imgMap, imgUrl)) setState('imgMap', imgUrl, 'blobUrl', URL.createObjectURL(res.response));\n  return res.response;\n};\n\nconst handleImgRecognition = async (url, imgEle) => {\n  const img = store.imgMap[url];\n  const needRecognition = store.option.imgRecognition.background && img.background === undefined || store.option.imgRecognition.pageFill && img.blankMargin === undefined;\n  if (needRecognition) {\n    imgEle ??= await helper.wait(() => getImgEle(url), 1000);\n    if (!imgEle) return helper.log.warn('获取图片元素失败');\n    const {\n      data,\n      width,\n      height\n    } = helper.getImageData(imgEle);\n    initWorker$1();\n    return worker.recognitionImg(Comlink.transfer(data, [data.buffer]), width, height, url, store$1.unwrap(store.option.imgRecognition));\n  }\n};\nconst initWorker$1 = helper.onec(() => {\n  const mainFn = {\n    log: helper.log,\n    updatePageData: helper.throttle(() => setState(updatePageData), 1000),\n    setImg: (url, key, val) => Reflect.has(store.imgMap, url) && setState('imgMap', url, key, val)\n  };\n  worker.setMainFn(Comlink.proxy(mainFn), Object.keys(mainFn));\n});\n\nconst isWideType = type => type === 'wide' || type === 'long';\n\n// https://github.com/hymbz/ComicReadScript/issues/174#issuecomment-2252114640\n// 用于判断图片类型的比例\nconst 单页比例 = 1920 / 2 / 1080;\nconst 横幅比例 = 1920 / 1080;\nconst 条漫比例 = 1920 / 2 / 1080 / 2;\n\n/** 根据比例判断图片类型 */\nconst getImgType = img => {\n  const imgRatio = img.width / img.height;\n  if (imgRatio <= 单页比例) return imgRatio < 条漫比例 ? 'vertical' : '';\n  return imgRatio > 横幅比例 ? 'long' : 'wide';\n};\n\n/** 更新图片类型。返回是否修改了图片类型 */\nconst updateImgType = (state, draftImg) => {\n  const {\n    type\n  } = draftImg;\n  if (!draftImg.width || !draftImg.height) return false;\n  draftImg.type = getImgType(draftImg);\n  if (isWideType(type) !== isWideType(draftImg.type)) updatePageData.throttle();\n  return (type ?? state.defaultImgType) !== draftImg.type;\n};\n\n/** 是否自动开启过卷轴模式 */\nlet autoScrollMode = false;\nhelper.createRootEffect(prevIsWide => {\n  if (store.rootSize.width === 0 || store.rootSize.height === 0) return;\n  const defaultImgType = getImgType(placeholderSize());\n  if (defaultImgType === store.defaultImgType) return prevIsWide;\n  const isWide = isWideType(defaultImgType);\n  setState(state => {\n    state.defaultImgType = defaultImgType;\n\n    // 连续出现多张长图后，自动开启卷轴模式\n    if (defaultImgType === 'vertical' && !autoScrollMode && !state.option.scrollMode.enabled) {\n      state.option.scrollMode.enabled = true;\n      autoScrollMode = true;\n      return;\n    }\n    if (isWide !== prevIsWide) updatePageData(state);\n  });\n  return isWide;\n}, false);\n\n/** 获取指定图片的显示尺寸 */\nconst getImgDisplaySize = (state, img) => {\n  let height = img.height ?? placeholderSize().height;\n  let width = img.width ?? placeholderSize().width;\n  if (!state.option.scrollMode.enabled) return {\n    height,\n    width\n  };\n  const setWidth = w => {\n    height *= w / width;\n    width = w;\n    return {\n      height,\n      width\n    };\n  };\n  if (isAbreastMode()) return setWidth(abreastColumnWidth());\n  if (state.option.scrollMode.adjustToWidth === 'full') return setWidth(state.rootSize.width);\n  height *= scrollModeScale();\n  width *= scrollModeScale();\n  if (width > state.rootSize.width) return setWidth(state.rootSize.width);\n  return {\n    height,\n    width\n  };\n};\n\n/** 更新图片尺寸 */\nconst updateImgSize = (url, width, height) => setState(state => {\n  const img = state.imgMap[url];\n  if (img.width === width && img.height === height) return;\n  img.width = width;\n  img.height = height;\n  img.size = getImgDisplaySize(state, img);\n  updateImgType(state, img);\n});\nhelper.createEffectOn([imgList, () => store.option.scrollMode.enabled, () => store.option.scrollMode.abreastMode, () => store.option.scrollMode.adjustToWidth, scrollModeScale, () => store.rootSize, placeholderSize], ([{\n  length\n}]) => {\n  if (length === 0) return;\n  setState(state => {\n    for (const url of state.imgList) state.imgMap[url].size = getImgDisplaySize(state, state.imgMap[url]);\n  });\n});\n\n/** 获取并排卷轴模式下指定列的指定图片 */\nconst getAbreastColumnImg = (column, img) => {\n  const {\n    columns\n  } = abreastArea();\n  return columns[helper.clamp(0, column, columns.length - 1)]?.at(img) ?? 0;\n};\n\n/** 计算显示页面 */\nconst updateShowRange = state => {\n  if (scrollLength() === 0) {\n    state.showRange = [0, 0];\n    state.renderRange = state.showRange;\n  } else if (!state.option.scrollMode.enabled) {\n    // 翻页模式\n    state.showRange = [state.activePageIndex, state.activePageIndex];\n    state.renderRange = [helper.clamp(0, state.activePageIndex - 1, state.pageList.length - 1), helper.clamp(0, state.activePageIndex + 1, state.pageList.length - 1)];\n  } else if (state.option.scrollMode.abreastMode) {\n    // 并排卷轴模式\n    const {\n      start,\n      end\n    } = abreastShowColumn();\n    state.showRange = [getAbreastColumnImg(start, 0), getAbreastColumnImg(end, -1)];\n    state.renderRange = [getAbreastColumnImg(start - 2, 0), getAbreastColumnImg(end + 2, -1)];\n  } else {\n    // 普通卷轴模式\n    const top = scrollTop();\n    const bottom = scrollTop() + state.rootSize.height;\n    const renderTop = top - state.rootSize.height;\n    const rednerBottom = bottom + state.rootSize.height;\n    const renderTopImg = findTopPage(renderTop);\n    const topImg = findTopPage(top, renderTopImg);\n    const bottomImg = findTopPage(bottom, topImg);\n    const renderBottomImg = findTopPage(rednerBottom, bottomImg);\n    state.showRange = [topImg, bottomImg];\n    state.renderRange = [renderTopImg, renderBottomImg];\n  }\n};\nhelper.createEffectOn([scrollLength, () => store.gridMode, () => store.option.scrollMode.enabled, () => store.activePageIndex, () => store.option.scrollMode.abreastMode, () => store.rootSize, abreastShowColumn, scrollTop], helper.throttle(() => setState(updateShowRange))\n// 两种卷轴模式下都可以通过在每次滚动后记录\n// 当前 `显示的第一张图片的 bottom` 和 `最后一张图片的 top` 作为忽略范围，\n// 在每次滚动后检查是否超出了这个范围，没超出就说明本次滚动不会显示或消失任何图片\n// 以此进行性能优化\n// 不过两个卷轴模式都要这么处理挺麻烦的，姑且先用 throttle 顶上，后面有需要再优化\n);\n\n/** 获取指定范围内页面所包含的图片 */\nconst getRangeImgList = range => {\n  let list;\n  if (range[0] === range[1]) list = new Set(store.pageList[range[0]]);else {\n    list = new Set();\n    for (const [a, b] of store.pageList.slice(range[0], range[1] + 1)) {\n      list.add(a);\n      if (b !== undefined) list.add(b);\n    }\n  }\n  list.delete(-1);\n  return list;\n};\nconst renderImgList = helper.createRootMemo(() => getRangeImgList(store.renderRange));\nconst showImgList = helper.createRootMemo(() => getRangeImgList(store.showRange));\n\n/**\n * 图片显示状态\n *\n * 0 - 页面中的第一张图片\n * 1 - 页面中的最后一张图片\n * '' - 页面中的唯一一张图片\n */\nconst imgShowState = helper.createRootMemo(() => {\n  if (store.pageList.length === 0) return new Map();\n  const showRange = store.gridMode ? [0, store.pageList.length - 1] : store.renderRange;\n  const stateList = new Map();\n  for (let [i] = showRange; i <= showRange[1]; i++) {\n    const page = store.pageList[i];\n    if (!page) continue;\n    const [a, b] = page;\n    if (b === undefined) {\n      stateList.set(a, '');\n    } else {\n      stateList.set(a, 0);\n      stateList.set(b, 1);\n    }\n  }\n  return stateList;\n});\n\n// 卷轴模式下，将当前显示的第一页作为当前页\nhelper.createEffectOn(() => store.showRange, ([firstPage]) => {\n  if (!store.gridMode && store.option.scrollMode.enabled) setState('activePageIndex', firstPage ?? 0);\n});\n\n// 图片发生变化时触发回调\nhelper.createEffectOn(showImgList, showImgs => {\n  if (showImgs.size === 0) return;\n  store.prop.onShowImgsChange?.(showImgs, imgList());\n}, {\n  defer: true\n});\n\nconst setMessage = (url, msg) => setState('imgMap', url, 'translationMessage', msg);\nconst sizeDict = {\n  '1024': 'S',\n  '1536': 'M',\n  '2048': 'L',\n  '2560': 'X'\n};\nconst createFormData = (imgBlob, type) => {\n  const formData = new FormData();\n  const {\n    options\n  } = store.option.translation;\n  const file = new File([imgBlob], `image.${imgBlob.type.split('/').at(-1)}`, {\n    type: imgBlob.type\n  });\n  if (type === 'selfhosted') {\n    formData.append('image', file);\n    formData.append('config', JSON.stringify(options));\n  } else {\n    formData.append('file', file);\n    formData.append('mime', file.type);\n    formData.append('size', sizeDict[options.detector.detection_size]);\n    formData.append('detector', options.detector.detector);\n    formData.append('direction', options.render.direction);\n    formData.append('translator', options.translator.translator);\n    formData.append(type === 'cotrans' ? 'target_language' : 'target_lang', options.translator.target_lang);\n    formData.append('retry', `${store.option.translation.forceRetry}`);\n  }\n  return formData;\n};\n\n/** 将站点列表转为选择器中的选项 */\nconst createOptions = list => list.map(name => [name, helper.t(`translation.translator.${name}`) || name]);\n\nconst handleMessage = (msg, url) => {\n  switch (msg.type) {\n    case 'result':\n      return msg.result.translation_mask;\n    case 'pending':\n      setMessage(url, helper.t('translation.tip.pending', {\n        pos: msg.pos\n      }));\n      break;\n    case 'status':\n      setMessage(url, helper.t(`translation.status.${msg.status}`) || msg.status);\n      break;\n    case 'error':\n      throw new Error(`${helper.t('translation.status.error')}：id ${msg.error_id}`);\n    case 'not_found':\n      throw new Error(`${helper.t('translation.status.error')}：Not Found`);\n  }\n};\nconst waitTranslationPolling = async (id, url) => {\n  let result;\n  while (result === undefined) {\n    const res = await request.request(`https://api.cotrans.touhou.ai/task/${id}/status/v1`, {\n      responseType: 'json'\n    });\n    result = handleMessage(res.response, url);\n    await helper.sleep(1000);\n  }\n  return result;\n};\n\n/** 等待翻译完成 */\nconst waitTranslation = async (id, url) => {\n  const ws = new WebSocket(`wss://api.cotrans.touhou.ai/task/${id}/event/v1`);\n\n  // 如果网站设置了 CSP connect-src 就只能轮询了\n  if (ws.readyState > 1) return waitTranslationPolling(id, url);\n  return new Promise((resolve, reject) => {\n    ws.onmessage = e => {\n      try {\n        const result = handleMessage(JSON.parse(e.data), url);\n        if (result) resolve(result);\n      } catch (error) {\n        reject(error);\n      }\n    };\n  });\n};\n\n/** 将翻译后的内容覆盖到原图上 */\nconst mergeImage = async (rawImage, maskUri) => {\n  const img = await helper.waitImgLoad(URL.createObjectURL(rawImage));\n  const canvas = new OffscreenCanvas(img.naturalWidth, img.naturalHeight);\n  const canvasCtx = canvas.getContext('2d');\n  canvasCtx.drawImage(img, 0, 0);\n  const img2 = new Image();\n  img2.src = URL.createObjectURL(await downloadImg(maskUri));\n  await helper.waitImgLoad(img2);\n  canvasCtx.drawImage(img2, 0, 0);\n  return URL.createObjectURL(await helper.canvasToBlob(canvas));\n};\n\n/** 缩小过大的图片 */\nconst resize = async (blob, w, h) => {\n  if (w <= 4096 && h <= 4096) return blob;\n  const scale = Math.min(4096 / w, 4096 / h);\n  const width = Math.floor(w * scale);\n  const height = Math.floor(h * scale);\n  const img = await helper.waitImgLoad(URL.createObjectURL(blob));\n  const canvas = new OffscreenCanvas(width, height);\n  const ctx = canvas.getContext('2d');\n  ctx.imageSmoothingQuality = 'high';\n  ctx.drawImage(img, 0, 0, width, height);\n  URL.revokeObjectURL(img.src);\n  return helper.canvasToBlob(canvas);\n};\n\n/** 使用 cotrans 翻译指定图片 */\nconst cotransTranslation = async url => {\n  const img = store.imgMap[url];\n  setMessage(url, helper.t('translation.tip.img_downloading'));\n  let imgBlob;\n  try {\n    imgBlob = await downloadImg(img.src);\n  } catch (error) {\n    helper.log.error(error);\n    store.prop.onImgError?.(url);\n    throw new Error(helper.t('translation.tip.download_img_failed'), {\n      cause: error\n    });\n  }\n  try {\n    imgBlob = await resize(imgBlob, img.width, img.height);\n  } catch (error) {\n    helper.log.error(error);\n    throw new Error(helper.t('translation.tip.resize_img_failed'), {\n      cause: error\n    });\n  }\n  setMessage(url, helper.t('translation.tip.upload'));\n  let res;\n  try {\n    res = await request.request('https://api.cotrans.touhou.ai/task/upload/v1', {\n      method: 'POST',\n      data: createFormData(imgBlob, 'cotrans'),\n      headers: {\n        Origin: 'https://cotrans.touhou.ai',\n        Referer: 'https://cotrans.touhou.ai/'\n      }\n    });\n  } catch (error) {\n    helper.log.error(error);\n    throw new Error(helper.t('translation.tip.upload_error'), {\n      cause: error\n    });\n  }\n  let resData;\n  try {\n    resData = JSON.parse(res.responseText);\n    helper.log(resData);\n  } catch (error) {\n    throw new Error(`${helper.t('translation.tip.upload_return_error')}：${res.responseText}`, {\n      cause: error\n    });\n  }\n  if ('error_id' in resData) throw new Error(`${helper.t('translation.tip.upload_return_error')}：${resData.error_id}`);\n  if (!resData.id) throw new Error(helper.t('translation.tip.id_not_returned'));\n  const translation_mask = resData.result?.translation_mask || (await waitTranslation(resData.id, url));\n  return mergeImage(imgBlob, translation_mask);\n};\nconst cotransTranslators = ['google', 'youdao', 'baidu', 'deepl', 'gpt3.5', 'offline', 'none'];\n\nconst apiUrl = () => store.option.translation.localUrl || 'http://127.0.0.1:5003';\n\n/** 使用自部署服务器翻译指定图片 */\nconst selfhostedTranslation = async url => {\n  const html = await request.request(apiUrl(), {\n    errorText: `${helper.t('setting.option.paragraph_translation')} - ${helper.t('alert.server_connect_failed')}`\n  });\n  setMessage(url, helper.t('translation.tip.img_downloading'));\n  let imgBlob;\n  try {\n    imgBlob = await downloadImg(url);\n  } catch (error) {\n    helper.log.error(error, url);\n    store.prop.onImgError?.(url);\n    throw new Error(helper.t('translation.tip.download_img_failed'), {\n      cause: error\n    });\n  }\n\n  // 支持旧版 manga-image-translator\n  // https://sleazyfork.org/zh-CN/scripts/374903/discussions/273466\n  if (html.responseText.includes('value=\"S\">1024px</')) {\n    let task_id;\n    // 上传图片取得任务 id\n    try {\n      const res = await request.request(`${apiUrl()}/submit`, {\n        method: 'POST',\n        responseType: 'json',\n        data: createFormData(imgBlob, 'selfhosted-old')\n      });\n      ({\n        task_id\n      } = res.response);\n    } catch (error) {\n      helper.log.error(error);\n      throw new Error(helper.t('translation.tip.upload_error'), {\n        cause: error\n      });\n    }\n    let errorNum = 0;\n    let taskState;\n    // 等待翻译完成\n    while (!taskState?.finished) {\n      try {\n        await helper.sleep(200);\n        const res = await request.request(`${apiUrl()}/task-state?taskid=${task_id}`, {\n          responseType: 'json'\n        });\n        taskState = res.response;\n        setMessage(url, `${helper.t(`translation.status.${taskState.state}`) || taskState.state}`);\n      } catch (error) {\n        helper.log.error(error);\n        if (errorNum > 5) throw new Error(helper.t('translation.tip.check_img_status_failed'), {\n          cause: error\n        });\n        errorNum += 1;\n      }\n    }\n    return URL.createObjectURL(await downloadImg(`${apiUrl()}/result/${task_id}`));\n  }\n  try {\n    const res = await fetch(`${apiUrl()}/translate/with-form/image/stream`, {\n      method: 'POST',\n      body: createFormData(imgBlob, 'selfhosted')\n    });\n    if (res.status !== 200 || !res.body) throw new Error(helper.t('translation.status.error'));\n    const reader = res.body.getReader();\n    const decoder = new TextDecoder('utf8');\n    let buffer = new Uint8Array();\n    while (true) {\n      const {\n        done,\n        value\n      } = await reader.read();\n      if (done) break;\n      buffer = Uint8Array.from([...buffer, ...value]);\n      while (buffer.length >= 5) {\n        const dataSize = new DataView(buffer.buffer).getUint32(1, false);\n        const totalSize = 5 + dataSize;\n        if (buffer.length < totalSize) break;\n        const data = buffer.slice(5, totalSize);\n        switch (buffer[0]) {\n          case 0:\n            return URL.createObjectURL(new Blob([data], {\n              type: 'image/png'\n            }));\n          case 1:\n            setMessage(url, helper.t(`translation.status.${decoder.decode(data)}`));\n            break;\n          case 2:\n            throw new Error(`${helper.t('translation.status.error')}: ${decoder.decode(data)}`);\n          case 3:\n            {\n              const pos = decoder.decode(data);\n              if (pos !== '0') {\n                setMessage(url, helper.t('translation.tip.pending', {\n                  pos\n                }));\n                break;\n              }\n              // falls through\n            }\n          case 4:\n            setMessage(url, helper.t('translation.status.pending'));\n            break;\n        }\n        buffer = buffer.slice(totalSize);\n      }\n    }\n    throw new Error(helper.t('translation.status.error'));\n  } catch (error) {\n    // 如果因为 cors 无法使用 fetch，就只能使用拿不到翻译状态的非流式接口了\n    if (error.message.includes('Failed to fetch')) {\n      setMessage(url, helper.t('translation.tip.translating'));\n      // 在拷贝漫画上莫名有概率报错\n      // 虽然猜测可能是 cors connect-src 导致的，但在类似的 fantia 上却也无法复现\n      // 也找不到第二个同样问题的网站，考虑到应该没人会在拷贝上翻译，就暂且不管了\n      const res = await request.request(`${apiUrl()}/translate/with-form/image`, {\n        method: 'POST',\n        responseType: 'blob',\n        fetch: false,\n        timeout: 1000 * 60 * 10,\n        data: createFormData(imgBlob, 'selfhosted'),\n        errorText: helper.t('translation.tip.upload_error')\n      });\n      return URL.createObjectURL(res.response);\n    }\n    throw error;\n  }\n};\nconst [selfhostedOptions, setSelfOptions] = helper.createEqualsSignal([]);\n\n/** 更新部署服务的可用翻译 */\nconst updateSelfhostedOptions = async (noTip = false) => {\n  if (store.option.translation.server !== 'selfhosted') return;\n  try {\n    const res = await request.request(`${apiUrl()}`, {\n      noTip,\n      errorText: `${helper.t('setting.option.paragraph_translation')} - ${helper.t('alert.server_connect_failed')}`\n    });\n    const translatorsText = /(?<=validTranslators: )\\[.+?\\](?=,)/s.exec(res.responseText)?.[0];\n    if (!translatorsText) return undefined;\n    const list = JSON.parse(translatorsText.replaceAll(/\\s|,\\s*(?=\\])/g, ``).replaceAll(`'`, `\"`));\n    setSelfOptions(createOptions(list));\n  } catch (error) {\n    helper.log.error(helper.t('translation.tip.get_translator_list_error'), error);\n    setSelfOptions([]);\n  }\n\n  // 如果更新后原先选择的翻译服务失效了，就换成第一个翻译\n  if (!selfhostedOptions().some(([val]) => val === store.option.translation.options.translator.translator)) {\n    setOption(draftOption => {\n      draftOption.translation.options.translator.translator = selfhostedOptions()[0]?.[0];\n    });\n  }\n};\n\n// 在切换翻译服务器的同时切换可用翻译的选项列表\nhelper.createEffectOn([() => store.option.translation.server, () => store.option.translation.localUrl, helper.lang], () => store.imgList.length > 0 && updateSelfhostedOptions(true), {\n  defer: true\n});\n\n/** 翻译指定图片 */\nconst translationImage = async url => {\n  try {\n    if (!url) return;\n    const img = store.imgMap[url];\n    if (img.translationType !== 'wait') return;\n    if (img.translationUrl) return setState('imgMap', url, 'translationType', 'show');\n    if (img.loadType !== 'loaded') return setMessage(url, helper.t('translation.tip.img_not_fully_loaded'));\n    const translationUrl = await (store.option.translation.server === 'cotrans' ? cotransTranslation : selfhostedTranslation)(url);\n    setState('imgMap', url, {\n      translationUrl,\n      translationMessage: helper.t('translation.tip.translation_completed'),\n      translationType: 'show'\n    });\n  } catch (error) {\n    setState('imgMap', url, 'translationType', 'error');\n    if (error?.message) setState('imgMap', url, 'translationMessage', error.message);\n  }\n};\n\n/** 逐个翻译状态为等待翻译的图片 */\nconst translationAll = helper.singleThreaded(async state => {\n  const targetImg = imgList().find(img => img.translationType === 'wait' && img.loadType === 'loaded');\n  if (!targetImg) return;\n  await translationImage(targetImg.src);\n  state.continueRun();\n});\n\n/** 开启或关闭指定图片的翻译 */\nconst setImgTranslationEnbale = (list, enbale) => {\n  if (store.option.translation.server === 'disable' && enbale) return;\n  setState(state => {\n    for (const i of list) {\n      const img = state.imgMap[state.imgList[i]];\n      if (!img) continue;\n      const url = img.src;\n      if (enbale) {\n        if (state.option.translation.forceRetry) {\n          img.translationType = 'wait';\n          img.translationUrl = undefined;\n          setMessage(url, helper.t('translation.tip.wait_translation'));\n        } else {\n          switch (img.translationType) {\n            case 'hide':\n              {\n                img.translationType = 'show';\n                break;\n              }\n            case 'error':\n            case undefined:\n              {\n                img.translationType = 'wait';\n                setMessage(url, helper.t('translation.tip.wait_translation'));\n                break;\n              }\n          }\n        }\n      } else {\n        switch (img.translationType) {\n          case 'show':\n            {\n              img.translationType = 'hide';\n              break;\n            }\n          case 'error':\n          case 'wait':\n            {\n              img.translationType = undefined;\n              break;\n            }\n        }\n      }\n    }\n  });\n  return translationAll();\n};\nconst translatorOptions = helper.createRootMemo(() => store.option.translation.server === 'selfhosted' ? selfhostedOptions() : createOptions(cotransTranslators));\n\n/** 翻译范围的图片 */\nconst translationImgs = helper.createRootMemo(() => {\n  const list = new Set();\n  for (const [i, img] of imgList().entries()) {\n    switch (img.translationType) {\n      case 'error':\n      case 'show':\n      case 'wait':\n        list.add(i);\n    }\n  }\n  return list;\n});\n\n/** 当前显示的图片是否正在翻译 */\nconst isTranslatingImage = helper.createRootMemo(() => activePage().some(i => translationImgs().has(i)));\n\n/** 翻译当前页 */\nconst translateCurrent = () => setImgTranslationEnbale(activePage(), !isTranslatingImage());\nconst createTranslateRange = imgs => {\n  const isTranslating = helper.createRootMemo(() => imgs().every(i => translationImgs().has(i)));\n  const translateRange = () => {\n    if (store.option.translation.server !== 'selfhosted') return;\n    setImgTranslationEnbale(imgs(), !isTranslating());\n  };\n  return [isTranslating, translateRange];\n};\n\n// 翻译全部图片\nconst [isTranslatingAll, translateAll] = createTranslateRange(helper.createRootMemo(() => helper.range(store.imgList.length)));\n\n// 翻译当前页以后的全部图片\nconst [isTranslatingToEnd, translateToEnd] = createTranslateRange(helper.createRootMemo(() => helper.range(activeImgIndex(), store.imgList.length)));\n\n/** 图片上次加载出错的时间 */\nconst imgErrorMap = new Map();\n\n/** 重新加载错误图片 */\nconst reloadImg = url => {\n  if (store.imgMap[url]?.loadType !== 'error') return;\n  setState('imgMap', url, 'loadType', 'wait');\n  updateImgLoadType();\n};\n\n/** 图片加载失败后定时重新加载 */\nconst handleTimeReload = url => {\n  const count = imgErrorMap.get(url) || 0;\n  // 最多重试 8 次\n  if (count > 8) return;\n  imgErrorMap.set(url, count + 1);\n  const time = (2 ** count + Math.random() * 2) * 1000;\n  setTimeout(reloadImg, time, url);\n};\n\n/** 图片加载完毕的回调 */\nconst handleImgLoaded = (url, e) => {\n  // 内联图片元素被创建后立刻就会触发 load 事件，如果在调用这个函数前 url 发生改变\n  // 就会导致这里获得的是上个 url 图片的尺寸\n  if (e && !e.isConnected) return;\n  imgErrorMap.delete(url);\n  const img = store.imgMap[url];\n  if (img.translationType === 'show') return;\n  if (img.loadType !== 'loaded') {\n    setState('imgMap', url, 'loadType', 'loaded');\n    updateImgLoadType();\n    store.prop.onLoading?.(imgList(), store.imgMap[url]);\n  }\n  if (!e) return;\n  updateImgSize(url, e.naturalWidth, e.naturalHeight);\n  if (store.option.imgRecognition.enabled && e.src === img.blobUrl) setTimeout(handleImgRecognition, 0, url, e);\n  translationAll();\n};\n\n/** 图片加载出错的回调 */\nconst handleImgError = (url, e) => {\n  if (e && !e.isConnected) return;\n  setState(state => {\n    const img = state.imgMap[url];\n    if (!img) return;\n    const imgIndexs = getImgIndexs(url);\n    helper.log.error(imgIndexs, helper.t('alert.img_load_failed'), e);\n    img.loadType = 'error';\n    img.type = undefined;\n  });\n  handleTimeReload(url);\n  store.prop.onLoading?.(imgList(), store.imgMap[url]);\n  store.prop.onImgError?.(url);\n  updateImgLoadType();\n};\n\n/** 需要加载的图片 */\nconst needLoadImgList = helper.createRootMemo(() => {\n  const list = new Set();\n  for (const img of imgList()) if (img.loadType !== 'loaded' && img.src) list.add(img.src);\n  return list;\n});\nconst waitUrlImgNum = helper.createRootMemo(() => {\n  let num = 0;\n  for (const img of imgList()) if (!img.src) num += 1;\n  return num;\n});\n\n/** 当前加载的图片 */\nconst loadImgList = new Set();\n\n/** 加载范围中等待 url 的图片 */\nconst waitUrlImgs = new Set();\n\n/** 加载指定图片。返回是否已加载完成 */\nconst loadImg = index => {\n  const img = getImg(index);\n  if (!img.src) {\n    waitUrlImgs.add(index);\n    return true;\n  }\n  if (!needLoadImgList().has(img.src)) return true;\n  if (img.loadType === 'error') return true;\n  loadImgList.add(img.src);\n  return false;\n};\n\n/** 获取指定页数下的头/尾图片 */\nconst getPageImg = (pageNum, imgType) => {\n  const page = store.pageList[pageNum].filter(i => i !== -1);\n  if (page.length === 1) return page[0];\n  return imgType === 'start' ? Math.min(...page) : Math.max(...page);\n};\n\n/**\n * 以当前显示页为基准，预加载附近指定页数的图片，并取消其他预加载的图片\n * @param target 加载目标页\n * @param loadNum 加载图片数量\n * @returns 返回指定范围内是否还有未加载的图片\n */\nconst loadRangeImg = (target = 0, loadNum = 2) => {\n  let start = getPageImg(store.showRange[0], 'start');\n  let end = getPageImg(store.showRange[1], 'end');\n  if (target !== 0) {\n    if (target < 0) {\n      end = start + target;\n      start -= 1;\n    } else {\n      start = end + 1;\n      end += target;\n    }\n    start = helper.clamp(0, start, store.imgList.length - 1);\n    end = helper.clamp(0, end, store.imgList.length - 1);\n  }\n\n  /** 是否还有未加载的图片 */\n  let hasUnloadedImg = false;\n  let index = start;\n  const condition = start <= end ? () => index <= end : () => index >= end;\n  const step = start <= end ? 1 : -1;\n  while (condition()) {\n    if (!loadImg(index)) hasUnloadedImg = true;\n    if (loadImgList.size >= loadNum) return index !== end || hasUnloadedImg;\n    index += step;\n  }\n  return hasUnloadedImg;\n};\n\n/** 加载期间尽快获取图片尺寸 */\nconst checkImgSize = url => {\n  const imgDom = getImgEle(url);\n  if (!imgDom) return;\n  const timeoutId = setInterval(() => {\n    if (!imgDom?.isConnected || store.option.imgRecognition.enabled) return clearInterval(timeoutId);\n    const img = store.imgMap[url];\n    if (!img || img.loadType !== 'loading') return clearInterval(timeoutId);\n    if (imgDom.naturalWidth && imgDom.naturalHeight) {\n      updateImgSize(url, imgDom.naturalWidth, imgDom.naturalHeight);\n      return clearInterval(timeoutId);\n    }\n  }, 200);\n};\nconst updateImgLoadType = helper.singleThreaded(() => {\n  if (store.showRange[0] < 0 || needLoadImgList().size === 0 && waitUrlImgNum() === 0) return;\n  loadImgList.clear();\n  waitUrlImgs.clear();\n  if (store.imgList.length > 0) {\n    // oxlint-disable-next-line no-unused-expressions\n    loadRangeImg() ||\n    // 优先加载当前显示的图片\n    loadRangeImg(preloadNum().back) ||\n    // 再加载后面几页\n    loadRangeImg(-preloadNum().front) ||\n    // 再加载前面几页\n    !store.option.alwaysLoadAllImg ||\n    // 根据设置决定是否要继续加载其余图片\n    loadRangeImg(Number.POSITIVE_INFINITY, 5) ||\n    // 加载当前页后面的图片\n    loadRangeImg(Number.NEGATIVE_INFINITY, 5); // 加载当前页前面的图片\n  }\n  store.prop.onWaitUrlImgs?.(waitUrlImgs, imgList());\n  setState(state => {\n    for (const url of needLoadImgList()) {\n      const img = state.imgMap[url];\n      if (loadImgList.has(url)) {\n        if (img.loadType !== 'loading') {\n          img.loadType = 'loading';\n          if (!store.option.imgRecognition.enabled && img.width === undefined) setTimeout(checkImgSize, 0, img.src);\n        }\n      } else if (img.loadType === 'loading') img.loadType = 'wait';\n    }\n  });\n});\nhelper.createEffectOn([preloadNum, renderImgList, () => store.imgMap, () => store.option.alwaysLoadAllImg], updateImgLoadType);\n\n// 如果当前显示页面有出错的图片，就重新加载一次\nhelper.createEffectOn(showImgList, helper.debounce(list => {\n  if (imgErrorMap.size === 0) return;\n  for (const i of list) reloadImg(getImg(i).src);\n}, 500), {\n  defer: true\n});\n\n/** 加载中的图片 */\nconst loadingImgList = helper.createRootMemo(() => {\n  const list = new Set();\n  for (const [url, img] of Object.entries(store.imgMap)) if (img.loadType === 'loading') list.add(url);\n  return list;\n});\nconst abortMap = new Map();\nconst timeoutAbort = url => {\n  if (!abortMap.has(url)) return;\n  abortMap.get(url).abort();\n  abortMap.delete(url);\n  handleImgError(url);\n};\nhelper.createEffectOn(loadingImgList, (downImgList, prevImgList) => {\n  if (!store.option.imgRecognition.enabled) return;\n  if (prevImgList) {\n    // 中断取消下载的图片\n    for (const url of prevImgList) {\n      if (downImgList.has(url) || !abortMap.has(url)) continue;\n      abortMap.get(url)?.abort();\n      abortMap.delete(url);\n      helper.log(`中断下载 ${url}`);\n    }\n  }\n  for (const url of downImgList.values()) {\n    if (abortMap.has(url) || store.imgMap[url].blobUrl) continue;\n    const controller = new AbortController();\n    const handleTimeout = helper.debounce(() => timeoutAbort(url), 1000 * 3);\n    controller.signal.addEventListener('abort', handleTimeout.clear);\n    abortMap.set(url, controller);\n    handleTimeout();\n    request.request(url, {\n      responseType: 'blob',\n      retryFetch: true,\n      signal: controller.signal,\n      timeout: undefined,\n      noTip: true,\n      headers: downloadImgHeaders,\n      onerror: () => handleImgError(url),\n      onprogress({\n        loaded,\n        total\n      }) {\n        setState('imgMap', url, 'progress', loaded / total * 100);\n        // 一段时间内都没进度后超时中断\n        handleTimeout();\n      },\n      onload({\n        response\n      }) {\n        abortMap.delete(url);\n        setState('imgMap', url, {\n          blobUrl: URL.createObjectURL(response),\n          progress: undefined\n        });\n        handleImgLoaded(url);\n      }\n    });\n  }\n});\n\nconst upscaleImage = async (url, imgEle) => {\n  setState('imgMap', url, 'upscaleUrl', '');\n  const {\n    data,\n    width,\n    height\n  } = helper.getImageData(imgEle);\n  initWorker();\n  await worker$1.upscaleImage(Comlink.transfer(data, [data.buffer]), width, height, url);\n};\nlet upscaleing = false;\nconst findUpscaleImage = async (start, end) => {\n  for (let i = start; i < end; i++) {\n    const img = typeof i === 'number' ? getImg(i) : i;\n    if (img.upscaleUrl !== undefined) continue;\n    const imgEle = await helper.wait(() => getImgEle(i), 1000);\n    if (imgEle) return [img.src, imgEle];\n  }\n};\nconst handleUpscaleImage = async () => {\n  if (upscaleing || !isUpscale() || store.imgList.length === 0) return;\n  // 优先放大 当前显示的图片 > 后面的图片 > 前面的图片\n  const targetImg = (await findUpscaleImage(activeImgIndex(), store.imgList.length)) ?? (await findUpscaleImage(0, activeImgIndex()));\n  if (!targetImg) return;\n  upscaleing = true;\n  await upscaleImage(...targetImg);\n  upscaleing = false;\n  return handleUpscaleImage();\n};\nhelper.createEffectOn([isUpscale, imgList], handleUpscaleImage);\nconst bufferToBase64 = buffer => {\n  let binary = '';\n  const bytes = new Uint8Array(buffer);\n  const len = bytes.byteLength;\n  for (let i = 0; i < len; i++) binary += String.fromCodePoint(bytes[i]);\n  return window.btoa(binary);\n};\nconst getModel = async () => {\n  try {\n    let base64;\n    let buffer;\n    if (typeof GM !== 'undefined') base64 = await GM.getValue('@model.bin');\n    if (!base64) {\n      Toast.toast(helper.t('upscale.module_downloading'), {\n        id: 'upscale',\n        duration: Number.POSITIVE_INFINITY\n      });\n      // TODO: 修改网址\n      const bin = await request.request('https://cdn.jsdelivr.net/npm/@hymbz/comic-read-script@11.12.1/public/realcugan/2x-conservative-128/group1-shard1of1.bin', {\n        responseType: 'arraybuffer',\n        noTip: true\n      });\n      Toast.toast(helper.t('upscale.module_download_complete'), {\n        id: 'upscale',\n        duration: 1000 * 3\n      });\n      buffer = bin.response;\n      base64 = bufferToBase64(buffer);\n      await GM.setValue('@model.bin', base64);\n    }\n    let json = await GM.getValue('@model.json');\n    if (!json) {\n      const jsonFile = await request.request('https://cdn.jsdelivr.net/npm/@hymbz/comic-read-script@11.12.1/public/realcugan/2x-conservative-128/model.json', {\n        noTip: true\n      });\n      json = jsonFile.responseText;\n      await GM.setValue('@model.json', json);\n    }\n    return {\n      base64,\n      json,\n      buffer\n    };\n  } catch (error) {\n    helper.log.error('获取图片放大模型出错', error);\n    Toast.toast.dismiss('upscale');\n    Toast.toast.error(helper.t('upscale.module_download_failed'), {\n      id: 'upscale',\n      duration: Number.POSITIVE_INFINITY\n    });\n    setState('supportUpscaleImage', false);\n    setState('option', 'imgRecognition', 'upscale', false);\n    throw error;\n  }\n};\nconst initWorker = helper.onec(() => {\n  const mainFn = {\n    log: helper.log,\n    toast: Toast.toast,\n    t: helper.t,\n    setImg: (url, key, val) => Reflect.has(store.imgMap, url) && setState('imgMap', url, key, val),\n    getModel\n  };\n  worker$1.setMainFn(Comlink.proxy(mainFn), Object.keys(mainFn));\n});\n\nvar css$1 = \".img____hash_base64_5_ img{display:block;height:100%;object-fit:contain;width:100%}.img____hash_base64_5_{align-content:center;content-visibility:hidden;display:none;height:100%;margin-left:auto;margin-right:auto;position:relative;width:100%}.img____hash_base64_5_[data-show]{content-visibility:visible;display:block}.img____hash_base64_5_>picture{display:block;height:auto;inset:0;margin-bottom:auto;margin-left:inherit;margin-right:inherit;margin-top:auto;max-height:100%;max-width:100%;position:absolute;width:auto}.img____hash_base64_5_>picture,.img____hash_base64_5_>picture:after{background-color:var(--hover-bg-color,#fff3);background-image:var(--md-photo);background-position:50%;background-repeat:no-repeat;background-size:30%}.img____hash_base64_5_[data-load-type=error]>picture:after{background-color:#eee;background-image:var(--md-image-not-supported);content:\\\"\\\";height:100%;pointer-events:none;position:absolute;right:0;top:0;width:100%}.img____hash_base64_5_[data-load-type=loading]>picture{background-image:var(--md-cloud-download)}:is(.img____hash_base64_5_[data-load-type=loading]>picture) img{animation:show____hash_base64_5_ .1s forwards}.img____hash_base64_5_[data-load-type=error]>picture{cursor:pointer}.mangaFlow____hash_base64_5_[dir=ltr] .img____hash_base64_5_[data-show=\\\"1\\\"],.mangaFlow____hash_base64_5_[dir=rtl] .img____hash_base64_5_[data-show=\\\"0\\\"]{margin-left:0;margin-right:auto}.mangaFlow____hash_base64_5_[dir=ltr] .img____hash_base64_5_[data-show=\\\"0\\\"],.mangaFlow____hash_base64_5_[dir=rtl] .img____hash_base64_5_[data-show=\\\"1\\\"]{margin-left:auto;margin-right:0}.mangaFlow____hash_base64_5_{backface-visibility:hidden;color:var(--text);contain:layout;display:grid;grid-auto-columns:100%;grid-auto-flow:column;grid-auto-rows:100%;height:100%;overflow:visible;place-items:center;position:absolute;row-gap:0;touch-action:none;transform-origin:0 0;-webkit-user-select:none;user-select:none;width:100%;will-change:left,top}.mangaFlow____hash_base64_5_[data-disable-zoom] .img____hash_base64_5_>picture{height:fit-content;width:fit-content}.mangaFlow____hash_base64_5_[data-hidden-mouse=true]{cursor:none}.mangaFlow____hash_base64_5_[data-vertical]{grid-auto-flow:row}.mangaBox____hash_base64_5_{contain:layout style;height:100%;transform-origin:0 0;transition-duration:0s;width:100%}.mangaBox____hash_base64_5_[data-animation=page] .mangaFlow____hash_base64_5_,.mangaBox____hash_base64_5_[data-animation=zoom]{transition-duration:.3s}.root____hash_base64_5_:not([data-grid-mode]) .mangaBox____hash_base64_5_{scrollbar-width:none}:is(.root____hash_base64_5_:not([data-grid-mode]) .mangaBox____hash_base64_5_)::-webkit-scrollbar{display:none}.root____hash_base64_5_[data-grid-mode] .mangaFlow____hash_base64_5_{align-items:end;box-sizing:border-box;grid-auto-columns:1fr;grid-auto-flow:row;grid-auto-rows:max-content;grid-template-rows:unset;overflow:auto;row-gap:1.5em}:is(.root____hash_base64_5_[data-grid-mode] .mangaFlow____hash_base64_5_) .img____hash_base64_5_{cursor:pointer;margin-left:auto;margin-right:auto}:is(:is(.root____hash_base64_5_[data-grid-mode] .mangaFlow____hash_base64_5_) .img____hash_base64_5_)>picture{position:relative}:is(:is(.root____hash_base64_5_[data-grid-mode] .mangaFlow____hash_base64_5_) .img____hash_base64_5_)>.gridModeTip____hash_base64_5_{bottom:-1.5em;cursor:auto;direction:ltr;line-height:1.5em;opacity:.5;overflow:hidden;position:absolute;text-align:center;text-overflow:ellipsis;white-space:nowrap;width:100%}[data-load-type=error]:is(:is(.root____hash_base64_5_[data-grid-mode] .mangaFlow____hash_base64_5_) .img____hash_base64_5_),[data-load-type=wait]:is(:is(.root____hash_base64_5_[data-grid-mode] .mangaFlow____hash_base64_5_) .img____hash_base64_5_),[src=\\\"\\\"]:is(:is(.root____hash_base64_5_[data-grid-mode] .mangaFlow____hash_base64_5_) .img____hash_base64_5_){height:100%}.root____hash_base64_5_[data-scroll-mode]:not([data-grid-mode]) .mangaBox____hash_base64_5_{overflow:auto}:is(.root____hash_base64_5_[data-scroll-mode]:not([data-grid-mode]) .mangaBox____hash_base64_5_) .mangaFlow____hash_base64_5_{height:fit-content;row-gap:calc(var(--scroll-mode-spacing)*7px);touch-action:pan-y}[data-abreast-scroll]:is(.root____hash_base64_5_[data-scroll-mode]:not([data-grid-mode]) .mangaBox____hash_base64_5_){overflow:hidden;touch-action:none}[data-abreast-scroll]:is(.root____hash_base64_5_[data-scroll-mode]:not([data-grid-mode]) .mangaBox____hash_base64_5_) .mangaFlow____hash_base64_5_{align-items:start;column-gap:calc(var(--scroll-mode-spacing)*7px);height:100%}:is([data-abreast-scroll]:is(.root____hash_base64_5_[data-scroll-mode]:not([data-grid-mode]) .mangaBox____hash_base64_5_) .mangaFlow____hash_base64_5_) .img____hash_base64_5_{height:auto;width:100%;will-change:transform}:is(:is([data-abreast-scroll]:is(.root____hash_base64_5_[data-scroll-mode]:not([data-grid-mode]) .mangaBox____hash_base64_5_) .mangaFlow____hash_base64_5_) .img____hash_base64_5_)>picture{position:relative}@keyframes show____hash_base64_5_{0%{opacity:0}90%{opacity:0}to{opacity:1}}.endPageBody____hash_base64_5_,.endPage____hash_base64_5_{align-items:center;display:flex;height:100%;justify-content:center;width:100%;z-index:10}.endPage____hash_base64_5_{background-color:#333d;color:#fff;left:0;opacity:0;pointer-events:none;position:absolute;top:0;transition:opacity .5s}.endPage____hash_base64_5_[data-show]{opacity:1;pointer-events:all}.endPage____hash_base64_5_[data-type=start] .tip____hash_base64_5_{transform:translateY(-10em)}.endPage____hash_base64_5_[data-type=end] .tip____hash_base64_5_{transform:translateY(10em)}.endPage____hash_base64_5_ .endPageBody____hash_base64_5_{transform:translateY(var(--drag-y,0));transition:transform .2s}:is(.endPage____hash_base64_5_ .endPageBody____hash_base64_5_) button{animation:jello____hash_base64_5_ .3s forwards;background-color:initial;color:inherit;cursor:pointer;font-size:1.2em;transform-origin:center}[data-is-end]:is(:is(.endPage____hash_base64_5_ .endPageBody____hash_base64_5_) button){font-size:3em;margin:2em}:is(.endPage____hash_base64_5_ .endPageBody____hash_base64_5_) .tip____hash_base64_5_{margin:auto;position:absolute}.endPage____hash_base64_5_[data-drag] .endPageBody____hash_base64_5_{transition:transform 0s}.root____hash_base64_5_[data-mobile] .endPage____hash_base64_5_>button{width:1em}.comments____hash_base64_5_{align-items:flex-end;display:flex;flex-direction:column;max-height:80%;opacity:.3;overflow:auto;padding-right:.5em;position:absolute;right:1em;width:20em}.comments____hash_base64_5_>p{background-color:#333b;border-radius:.5em;margin:.5em .1em;padding:.2em .5em}.comments____hash_base64_5_:hover{opacity:1}.root____hash_base64_5_[data-mobile] .comments____hash_base64_5_{bottom:0;max-height:15em;opacity:.8}@keyframes jello____hash_base64_5_{0%,11.1%,to{transform:translateZ(0)}22.2%{transform:skewX(-12.5deg) skewY(-12.5deg)}33.3%{transform:skewX(6.25deg) skewY(6.25deg)}44.4%{transform:skewX(-3.125deg) skewY(-3.125deg)}55.5%{transform:skewX(1.5625deg) skewY(1.5625deg)}66.6%{transform:skewX(-.7812deg) skewY(-.7812deg)}77.7%{transform:skewX(.3906deg) skewY(.3906deg)}88.8%{transform:skewX(-.1953deg) skewY(-.1953deg)}}.toolbar____hash_base64_5_{align-items:center;display:flex;height:100%;justify-content:flex-start;position:fixed;top:0;z-index:9}.toolbarPanel____hash_base64_5_{display:flex;flex-direction:column;padding:.5em;position:relative;transform:translateX(-100%);transition:transform .2s}.toolbarPanel____hash_base64_5_>hr{border:none;height:1em;margin:0;visibility:hidden}:is(.toolbar____hash_base64_5_[data-show],.toolbar____hash_base64_5_:hover) .toolbarPanel____hash_base64_5_{transform:none}.toolbar____hash_base64_5_[data-close] .toolbarPanel____hash_base64_5_{transform:translateX(-100%);visibility:hidden}.toolbarBg____hash_base64_5_{background-color:var(--page-bg);border-bottom-right-radius:1em;border-top-right-radius:1em;filter:opacity(.8);height:100%;position:absolute;right:0;top:0;width:100%}.root____hash_base64_5_[data-mobile] .toolbar____hash_base64_5_{font-size:1.3em}.root____hash_base64_5_[data-mobile] .toolbar____hash_base64_5_:not([data-show]){pointer-events:none}.root____hash_base64_5_[data-mobile] .toolbarBg____hash_base64_5_{filter:opacity(.8)}.SettingPanelPopper____hash_base64_5_{height:0!important;padding:0!important;pointer-events:unset!important;transform:none!important}.SettingPanel____hash_base64_5_{background-color:var(--page-bg);border-radius:.3em;bottom:0;box-shadow:0 3px 1px -2px #0003,0 2px 2px 0 #00000024,0 1px 5px 0 #0000001f;color:var(--text);font-size:1.2em;height:fit-content;margin:auto;max-height:95%;max-width:calc(100% - 5em);overflow:auto;position:fixed;top:0;-webkit-user-select:text;user-select:text;z-index:1}.SettingPanel____hash_base64_5_ hr{color:#fff;margin:.5em 0}.SettingPanel____hash_base64_5_>hr{margin:0}.SettingBlock____hash_base64_5_{display:grid;grid-template-rows:max-content 1fr;transition:grid-template-rows .2s ease-out}.SettingBlock____hash_base64_5_ .SettingBlockBody____hash_base64_5_{overflow:hidden;padding:0 .5em 1em;z-index:0}:is(.SettingBlock____hash_base64_5_ .SettingBlockBody____hash_base64_5_)>div+:is(.SettingBlock____hash_base64_5_ .SettingBlockBody____hash_base64_5_)>div{margin-top:1em}:is(.SettingBlock____hash_base64_5_ .SettingBlockBody____hash_base64_5_) input,:is(.SettingBlock____hash_base64_5_ .SettingBlockBody____hash_base64_5_) textarea{margin-top:.3em;width:97%}.SettingBlock____hash_base64_5_[data-show=false]{grid-template-rows:max-content 0fr;padding-bottom:unset}.SettingBlock____hash_base64_5_[data-show=false] .SettingBlockBody____hash_base64_5_{padding:unset}.SettingBlockSubtitle____hash_base64_5_{background-color:var(--page-bg);color:var(--text-secondary);cursor:pointer;font-size:.7em;height:3em;line-height:3em;margin-bottom:.1em;position:sticky;text-align:center;top:0;z-index:1}.SettingBlockBody____hash_base64_5_ .SettingBlockSubtitle____hash_base64_5_{height:1em;line-height:1em;position:unset}.SettingsItem____hash_base64_5_{align-items:center;display:flex;justify-content:space-between;position:relative}:is(.SettingsItem____hash_base64_5_,.SettingsShowItem____hash_base64_5_)+.SettingsItem____hash_base64_5_{margin-top:1em}.SettingsItem____hash_base64_5_[data-disabled]{opacity:.5}.SettingsItem____hash_base64_5_[data-disabled] button{cursor:not-allowed}.SettingsItemName____hash_base64_5_{font-size:.9em;max-width:calc(100% - 4em);overflow-wrap:anywhere;text-align:start;white-space:pre-wrap}.SettingsItemSwitch____hash_base64_5_{align-items:center;background-color:var(--switch-bg);border:0;border-radius:1em;cursor:pointer;display:inline-flex;height:.8em;margin:.3em;padding:0;width:2.3em}.SettingsItemSwitchRound____hash_base64_5_{background:var(--switch);border-radius:100%;box-shadow:0 2px 1px -1px #0003,0 1px 1px 0 #00000024,0 1px 3px 0 #0000001f;height:1.15em;transform:translateX(-10%);transition:transform .1s;width:1.15em}.SettingsItemSwitch____hash_base64_5_[data-checked=true]{background:var(--secondary-bg)}.SettingsItemSwitch____hash_base64_5_[data-checked=true] .SettingsItemSwitchRound____hash_base64_5_{background:var(--secondary);transform:translateX(110%)}.SettingsItemIconButton____hash_base64_5_{background-color:initial;border:none;color:var(--text);cursor:pointer;font-size:1.5em;height:1em;position:absolute;right:0}.SettingsItemSelect____hash_base64_5_{background-color:var(--hover-bg-color);border:none;border-radius:5px;cursor:pointer;font-size:.9em;margin:0;max-width:6.5em;outline:none;padding:.3em}.closeCover____hash_base64_5_{height:100%;left:0;position:fixed;top:0;width:100%}.SettingsShowItem____hash_base64_5_{display:grid;transition:grid-template-rows .2s ease-out}.SettingsShowItem____hash_base64_5_>.SettingsShowItemBody____hash_base64_5_{display:flex;flex-direction:column;overflow:hidden}:is(.SettingsShowItem____hash_base64_5_>.SettingsShowItemBody____hash_base64_5_)>.SettingsItem____hash_base64_5_{margin-top:1em}:is(.SettingsShowItem____hash_base64_5_>.SettingsShowItemBody____hash_base64_5_)>:is(textarea,input){line-height:1.2;margin:.4em .2em 0}[data-only-number]{padding:0 .2em}[data-only-number]+span{margin-left:-.1em}.hotkeys____hash_base64_5_{align-items:center;border-bottom:1px solid var(--secondary-bg);color:var(--text);display:flex;flex-grow:1;flex-wrap:wrap;font-size:.9em;padding:2em .2em .2em;position:relative;z-index:1}.hotkeys____hash_base64_5_+.hotkeys____hash_base64_5_{margin-top:.5em}.hotkeys____hash_base64_5_:last-child{border-bottom:none}.hotkeysItem____hash_base64_5_{align-items:center;border-radius:.3em;box-sizing:initial;cursor:pointer;display:flex;font-family:serif;height:1em;margin:.3em;outline:1px solid;outline-color:var(--secondary-bg);padding:.2em 1.2em}.hotkeysItem____hash_base64_5_>svg{background-color:var(--text);border-radius:1em;color:var(--page-bg);display:none;height:1em;margin-left:.4em;opacity:.5}:is(.hotkeysItem____hash_base64_5_>svg):hover{opacity:.9}.hotkeysItem____hash_base64_5_:hover{padding:.2em .5em}.hotkeysItem____hash_base64_5_:hover>svg{display:unset}.hotkeysItem____hash_base64_5_:focus,.hotkeysItem____hash_base64_5_:focus-visible{outline:var(--text) solid 2px}.hotkeysHeader____hash_base64_5_{align-items:center;box-sizing:border-box;display:flex;left:0;padding:0 .5em;position:absolute;top:0;width:100%}.hotkeysHeader____hash_base64_5_>p{background-color:var(--page-bg);line-height:1em;overflow-wrap:anywhere;text-align:start;white-space:pre-wrap}.hotkeysHeader____hash_base64_5_>div[title]{background-color:var(--page-bg);cursor:pointer;display:flex;transform:scale(0);transition:transform .1s}:is(.hotkeysHeader____hash_base64_5_>div[title])>svg{width:1.6em}.hotkeys____hash_base64_5_:hover div[title]{transform:scale(1)}.scrollbar____hash_base64_5_{--arrow-y:clamp(0.45em,calc(var(--slider-midpoint)),calc(var(--scroll-length) - 0.45em));border-left:max(6vw,1em) solid #0000;display:flex;flex-direction:column;height:98%;position:absolute;right:3px;top:1%;touch-action:none;-webkit-user-select:none;user-select:none;width:5px;z-index:9}.scrollbar____hash_base64_5_>div{align-items:center;display:flex;flex-direction:column;flex-grow:1;justify-content:center;pointer-events:none}.scrollbarPage____hash_base64_5_{background-color:var(--secondary);flex-grow:1;height:100%;transform:scaleY(1);transform-origin:bottom;transition:transform 1s;width:100%}.scrollbarPage____hash_base64_5_[data-type=loaded]{transform:scaleY(0)}.scrollbarPage____hash_base64_5_[data-upscale]{background-color:#b39ddb;transform:scaleY(1)}.scrollbarPage____hash_base64_5_[data-upscale=loading]{background-color:#d1c4e9}.scrollbarPage____hash_base64_5_[data-translation-type]{background-color:initial;transform:scaleY(1);transform-origin:top}.scrollbarPage____hash_base64_5_[data-translation-type=wait]{background-color:#81c784}.scrollbarPage____hash_base64_5_[data-translation-type=show]{background-color:#4caf50}.scrollbarPage____hash_base64_5_[data-translation-type=error]{background-color:#f005}.scrollbarPage____hash_base64_5_[data-type=wait]{opacity:.4}.scrollbarPage____hash_base64_5_[data-type=error]{background-color:#f005}.scrollbarSlider____hash_base64_5_{background-color:#fff5;border-radius:1em;height:var(--slider-height);justify-content:center;opacity:1;position:absolute;transform:translateY(var(--slider-top));transition:transform .15s,opacity .15s;width:100%;z-index:1}.scrollbarPoper____hash_base64_5_{--poper-top:clamp(0%,calc(var(--slider-midpoint) - 50%),calc(var(--scroll-length) - 100%));background-color:#303030;border-radius:.3em;color:#fff;font-size:.8em;line-height:1.5em;min-height:1.5em;min-width:1em;padding:.2em .5em;position:absolute;right:2em;text-align:center;transform:translateY(var(--poper-top));white-space:pre;width:fit-content}.scrollbar____hash_base64_5_:before{background-color:initial;border:.4em solid #0000;border-left:.5em solid #303030;content:\\\"\\\";position:absolute;right:2em;transform:translate(140%,calc(var(--arrow-y) - 50%))}.scrollbarPoper____hash_base64_5_,.scrollbar____hash_base64_5_:before{opacity:0;transition:opacity .15s,transform .15s}:is(.scrollbar____hash_base64_5_:hover,.scrollbar____hash_base64_5_[data-force-show]) .scrollbarPoper____hash_base64_5_,:is(.scrollbar____hash_base64_5_:hover,.scrollbar____hash_base64_5_[data-force-show]) .scrollbarSlider____hash_base64_5_,:is(.scrollbar____hash_base64_5_:hover,.scrollbar____hash_base64_5_[data-force-show]):before{opacity:1}.scrollbar____hash_base64_5_[data-drag] .scrollbarPoper____hash_base64_5_,.scrollbar____hash_base64_5_[data-drag] .scrollbarSlider____hash_base64_5_,.scrollbar____hash_base64_5_[data-drag]:before{transition:opacity .15s}.scrollbar____hash_base64_5_[data-auto-hidden]:not([data-force-show]) .scrollbarSlider____hash_base64_5_{opacity:0}.scrollbar____hash_base64_5_[data-auto-hidden]:not([data-force-show]):hover .scrollbarSlider____hash_base64_5_{opacity:1}.scrollbar____hash_base64_5_[data-position=hidden]{display:none}.scrollbar____hash_base64_5_[data-position=top]{border-bottom:max(6vh,1em) solid #0000;top:1px}.scrollbar____hash_base64_5_[data-position=top]:before{border-bottom:.5em solid #303030;right:0;top:1.2em;transform:translate(var(--arrow-x),-120%)}.scrollbar____hash_base64_5_[data-position=top] .scrollbarPoper____hash_base64_5_{top:1.2em}.scrollbar____hash_base64_5_[data-position=bottom]{border-top:max(6vh,1em) solid #0000;bottom:1px;top:unset}.scrollbar____hash_base64_5_[data-position=bottom]:before{border-top:.5em solid #303030;bottom:1.2em;right:0;transform:translate(var(--arrow-x),120%)}.scrollbar____hash_base64_5_[data-position=bottom] .scrollbarPoper____hash_base64_5_{bottom:1.2em}.scrollbar____hash_base64_5_[data-position=bottom],.scrollbar____hash_base64_5_[data-position=top]{--arrow-x:calc(var(--arrow-y)*-1 + 50%);border-left:none;flex-direction:row-reverse;height:5px;right:1%;width:98%}:is(.scrollbar____hash_base64_5_[data-position=top],.scrollbar____hash_base64_5_[data-position=bottom]):before{border-left:.4em solid #0000}:is(.scrollbar____hash_base64_5_[data-position=top],.scrollbar____hash_base64_5_[data-position=bottom]) .scrollbarSlider____hash_base64_5_{height:100%;transform:translateX(calc(var(--slider-top)*-1));width:var(--slider-height)}:is(.scrollbar____hash_base64_5_[data-position=top],.scrollbar____hash_base64_5_[data-position=bottom]) .scrollbarPoper____hash_base64_5_{padding:.1em .3em;right:unset;transform:translateX(calc(var(--poper-top)*-1))}[data-dir=ltr]:is(.scrollbar____hash_base64_5_[data-position=top],.scrollbar____hash_base64_5_[data-position=bottom]){--arrow-x:calc(var(--arrow-y) - 50%);flex-direction:row}[data-dir=ltr]:is(.scrollbar____hash_base64_5_[data-position=top],.scrollbar____hash_base64_5_[data-position=bottom]):before{left:0;right:unset}[data-dir=ltr]:is(.scrollbar____hash_base64_5_[data-position=top],.scrollbar____hash_base64_5_[data-position=bottom]) .scrollbarSlider____hash_base64_5_{transform:translateX(var(--top))}[data-dir=ltr]:is(.scrollbar____hash_base64_5_[data-position=top],.scrollbar____hash_base64_5_[data-position=bottom]) .scrollbarPoper____hash_base64_5_{transform:translateX(var(--poper-top))}:is(.scrollbar____hash_base64_5_[data-position=top],.scrollbar____hash_base64_5_[data-position=bottom]) .scrollbarPage____hash_base64_5_{transform:scaleX(1)}[data-type=loaded]:is(:is(.scrollbar____hash_base64_5_[data-position=top],.scrollbar____hash_base64_5_[data-position=bottom]) .scrollbarPage____hash_base64_5_){transform:scaleX(0)}[data-translation-type]:is(:is(.scrollbar____hash_base64_5_[data-position=top],.scrollbar____hash_base64_5_[data-position=bottom]) .scrollbarPage____hash_base64_5_){transform:scaleX(1)}.scrollbar____hash_base64_5_[data-is-abreast-mode] .scrollbarPoper____hash_base64_5_{line-height:1.5em;text-orientation:upright;writing-mode:vertical-rl}.scrollbar____hash_base64_5_[data-is-abreast-mode][data-dir=ltr] .scrollbarPoper____hash_base64_5_{writing-mode:vertical-lr}.root____hash_base64_5_[data-scroll-mode] .scrollbar____hash_base64_5_:before,.root____hash_base64_5_[data-scroll-mode] :is(.scrollbarSlider____hash_base64_5_,.scrollbarPoper____hash_base64_5_){transition:opacity .15s}:is(.root____hash_base64_5_[data-mobile] .scrollbar____hash_base64_5_:hover) .scrollbarPoper____hash_base64_5_,:is(.root____hash_base64_5_[data-mobile] .scrollbar____hash_base64_5_:hover):before{opacity:0}.touchAreaRoot____hash_base64_5_{color:#fff;display:grid;font-size:3em;grid-template-columns:1fr min(30%,10em) 1fr;grid-template-rows:1fr min(20%,10em) 1fr;height:100%;letter-spacing:.5em;opacity:0;pointer-events:none;position:absolute;top:0;transition:opacity .4s;-webkit-user-select:none;user-select:none;width:100%}.touchAreaRoot____hash_base64_5_[data-show]{opacity:1}.touchAreaRoot____hash_base64_5_ .touchArea____hash_base64_5_{align-items:center;display:flex;justify-content:center;text-align:center}[data-area=PREV]:is(.touchAreaRoot____hash_base64_5_ .touchArea____hash_base64_5_),[data-area=prev]:is(.touchAreaRoot____hash_base64_5_ .touchArea____hash_base64_5_){background-color:#95e1d3e6}[data-area=MENU]:is(.touchAreaRoot____hash_base64_5_ .touchArea____hash_base64_5_),[data-area=menu]:is(.touchAreaRoot____hash_base64_5_ .touchArea____hash_base64_5_){background-color:#fce38ae6}[data-area=NEXT]:is(.touchAreaRoot____hash_base64_5_ .touchArea____hash_base64_5_),[data-area=next]:is(.touchAreaRoot____hash_base64_5_ .touchArea____hash_base64_5_){background-color:#f38181e6}[data-area=PREV]:is(.touchAreaRoot____hash_base64_5_ .touchArea____hash_base64_5_):after{content:var(--i18n-touch-area-prev)}[data-area=MENU]:is(.touchAreaRoot____hash_base64_5_ .touchArea____hash_base64_5_):after{content:var(--i18n-touch-area-menu)}[data-area=NEXT]:is(.touchAreaRoot____hash_base64_5_ .touchArea____hash_base64_5_):after{content:var(--i18n-touch-area-next)}.touchAreaRoot____hash_base64_5_[data-vert=true]{flex-direction:column!important}.touchAreaRoot____hash_base64_5_:not([data-turn-page]) .touchArea____hash_base64_5_[data-area=NEXT],.touchAreaRoot____hash_base64_5_:not([data-turn-page]) .touchArea____hash_base64_5_[data-area=PREV],.touchAreaRoot____hash_base64_5_:not([data-turn-page]) .touchArea____hash_base64_5_[data-area=next],.touchAreaRoot____hash_base64_5_:not([data-turn-page]) .touchArea____hash_base64_5_[data-area=prev]{visibility:hidden}.touchAreaRoot____hash_base64_5_[data-shrink-menu]{grid-template-columns:1fr 2em 1fr}.touchAreaRoot____hash_base64_5_[data-shrink-menu] .touchArea____hash_base64_5_[data-area=MENU]{letter-spacing:0}.root____hash_base64_5_[data-mobile] .touchAreaRoot____hash_base64_5_{flex-direction:column!important;letter-spacing:0}.root____hash_base64_5_[data-mobile] [data-area]:after{font-size:.8em}.root____hash_base64_5_{background-color:var(--bg);font-size:1em;height:100%;outline:0;overflow:hidden;position:relative;width:100%}.root____hash_base64_5_ a{color:var(--text-secondary)}.root____hash_base64_5_[data-mobile]{font-size:.8em}.hidden____hash_base64_5_{display:none!important}.invisible____hash_base64_5_{visibility:hidden!important}.beautifyScrollbar____hash_base64_5_{scrollbar-color:var(--scrollbar-slider) #0000;scrollbar-width:thin}.beautifyScrollbar____hash_base64_5_::-webkit-scrollbar{height:10px;width:5px}.beautifyScrollbar____hash_base64_5_::-webkit-scrollbar-track{background:#0000}.beautifyScrollbar____hash_base64_5_::-webkit-scrollbar-thumb{background:var(--scrollbar-slider)}img,p{margin:0}:where(div,div:focus,div:focus-within,div:focus-visible,button){border:none;outline:none}blockquote{border-left:.25em solid var(--text-secondary,#607d8b);color:var(--text-secondary);font-size:.9em;font-style:italic;line-height:1.2em;margin:.5em 0;overflow-wrap:anywhere;padding:0 0 0 1em;text-align:start;white-space:pre-wrap}svg{width:1em}\";\nvar modules_c21c94f2$1 = {\"img\":\"img____hash_base64_5_\",\"mangaFlow\":\"mangaFlow____hash_base64_5_\",\"mangaBox\":\"mangaBox____hash_base64_5_\",\"root\":\"root____hash_base64_5_\",\"gridModeTip\":\"gridModeTip____hash_base64_5_\",\"endPage\":\"endPage____hash_base64_5_\",\"endPageBody\":\"endPageBody____hash_base64_5_\",\"tip\":\"tip____hash_base64_5_\",\"comments\":\"comments____hash_base64_5_\",\"toolbar\":\"toolbar____hash_base64_5_\",\"toolbarPanel\":\"toolbarPanel____hash_base64_5_\",\"toolbarBg\":\"toolbarBg____hash_base64_5_\",\"SettingPanelPopper\":\"SettingPanelPopper____hash_base64_5_\",\"SettingPanel\":\"SettingPanel____hash_base64_5_\",\"SettingBlock\":\"SettingBlock____hash_base64_5_\",\"SettingBlockBody\":\"SettingBlockBody____hash_base64_5_\",\"SettingBlockSubtitle\":\"SettingBlockSubtitle____hash_base64_5_\",\"SettingsItem\":\"SettingsItem____hash_base64_5_\",\"SettingsShowItem\":\"SettingsShowItem____hash_base64_5_\",\"SettingsItemName\":\"SettingsItemName____hash_base64_5_\",\"SettingsItemSwitch\":\"SettingsItemSwitch____hash_base64_5_\",\"SettingsItemSwitchRound\":\"SettingsItemSwitchRound____hash_base64_5_\",\"SettingsItemIconButton\":\"SettingsItemIconButton____hash_base64_5_\",\"SettingsItemSelect\":\"SettingsItemSelect____hash_base64_5_\",\"closeCover\":\"closeCover____hash_base64_5_\",\"SettingsShowItemBody\":\"SettingsShowItemBody____hash_base64_5_\",\"hotkeys\":\"hotkeys____hash_base64_5_\",\"hotkeysItem\":\"hotkeysItem____hash_base64_5_\",\"hotkeysHeader\":\"hotkeysHeader____hash_base64_5_\",\"scrollbar\":\"scrollbar____hash_base64_5_\",\"scrollbarPage\":\"scrollbarPage____hash_base64_5_\",\"scrollbarSlider\":\"scrollbarSlider____hash_base64_5_\",\"scrollbarPoper\":\"scrollbarPoper____hash_base64_5_\",\"touchAreaRoot\":\"touchAreaRoot____hash_base64_5_\",\"touchArea\":\"touchArea____hash_base64_5_\",\"hidden\":\"hidden____hash_base64_5_\",\"invisible\":\"invisible____hash_base64_5_\",\"beautifyScrollbar\":\"beautifyScrollbar____hash_base64_5_\"};\n\nlet clickTimeout = null;\nconst useDoubleClick = (click, doubleClick, timeout = 200) => event => {\n  // 如果点击触发时还有上次计时器的记录，说明这次是双击\n  if (clickTimeout) {\n    clearTimeout(clickTimeout);\n    clickTimeout = null;\n    doubleClick?.(event);\n    return;\n  }\n\n  // 单击事件延迟触发\n  clickTimeout = window.setTimeout(() => {\n    click(event);\n    clickTimeout = null;\n  }, timeout);\n};\n\nlet cache = undefined;\nconst initCache = async () => {\n  cache ||= await helper.useCache({\n    progress: 'id'\n  }, 'ReadProgress');\n};\nlet lastIndex = -1;\n/** 保存阅读进度 */\nconst saveReadProgress = helper.throttle(async () => {\n  await initCache();\n  const index = activeImgIndex();\n  if (index === lastIndex) return;\n  lastIndex = index;\n  if (\n  // 只保存 50 页以上漫画的进度\n  store.imgList.length < 50 ||\n  // 翻到最后几页时不保存\n  index >= store.imgList.length - 5) return await cache.del('progress', location.pathname);\n  const imgSize = {};\n  for (const [i, img] of imgList().entries()) if (img.width && img.height) imgSize[i] = [img.width, img.height];\n  await cache.set('progress', {\n    id: location.pathname,\n    time: Date.now(),\n    index,\n    imgSize,\n    fillEffect: store$1.unwrap(store.fillEffect)\n  });\n}, 1000);\n\n/** 恢复阅读进度 */\nconst resumeReadProgress = async state => {\n  await initCache();\n  const progress = await cache.get('progress', location.pathname);\n  if (!progress) return;\n\n  // 目前卷轴模式下无法避免因图片加载导致的抖动，\n  // 为了避免在恢复阅读进度时出现问题，只能将图片显示相关的数据也存着用于恢复\n  let i = state.imgList.length;\n  while (i--) {\n    const imgSize = progress.imgSize[i];\n    if (imgSize) updateImgSize(state.imgList[i], ...imgSize);\n  }\n  state.fillEffect = progress.fillEffect;\n  updatePageData(state);\n  if (state.option.scrollMode.enabled) setTimeout(scrollViewImg, 500, progress.index);else jumpToImg(progress.index);\n\n  // 清除过时的进度\n  const nowTime = Date.now();\n  cache.each('progress', async (data, cursor) => {\n    if (nowTime - data.time < 1000 * 60 * 60 * 24 * 29) return;\n    await helper.promisifyRequest(cursor.delete());\n  });\n};\n\n/** 将页面移回原位 */\nconst resetPage = (state, animation = false) => {\n  updateShowRange(state);\n  state.page.offset.x.pct = 0;\n  state.page.offset.y.pct = 0;\n  if (state.option.scrollMode.enabled) {\n    state.page.anima = '';\n    return;\n  }\n  let i = -1;\n  if (helper.inRange(state.renderRange[0], state.activePageIndex, state.renderRange[1])) i = state.activePageIndex - state.renderRange[0];\n  if (store.page.vertical) state.page.offset.y.pct = i === -1 ? 0 : -i;else state.page.offset.x.pct = i === -1 ? 0 : i;\n  state.page.anima = animation ? 'page' : '';\n};\n\n/** 获取指定图片的提示文本 */\nconst getImgTip = i => {\n  if (i === -1) return helper.t('other.fill_page');\n  const img = getImg(i);\n\n  // 如果图片未加载完毕则在其 index 后增加显示当前加载状态\n  if (img.loadType !== 'loaded') return `${i + 1} (${helper.t(`img_status.${img.loadType}`)})`;\n  if (img.translationType && img.translationType !== 'hide' && img.translationMessage) return `${i + 1}：${img.translationMessage}`;\n  if (isUpscale() && img.upscaleUrl !== undefined) return `${i + 1} (${img.upscaleUrl ? helper.t('upscale.upscaled') : helper.t('upscale.upscaling')})`;\n  return `${i + 1}`;\n};\n\n/** 获取指定页面的提示文本 */\nconst getPageTip = pageIndex => {\n  const page = store.pageList[pageIndex];\n  if (!page) return 'null';\n  const pageIndexText = page.map(index => getImgTip(index));\n  if (pageIndexText.length === 1) return pageIndexText[0];\n  if (store.option.dir === 'rtl') pageIndexText.reverse();\n  return pageIndexText.join(' | ');\n};\nhelper.createEffectOn(() => store.activePageIndex, () => store.show.endPage && setState('show', 'endPage', undefined), {\n  defer: true\n});\nhelper.createEffectOn(activePage, helper.throttle(() => store.isDragMode || setState(resetPage)));\n\n// 在关闭工具栏的同时关掉滚动条的强制显示\nhelper.createEffectOn(() => store.show.toolbar, () => store.show.scrollbar && !store.show.toolbar && setState('show', 'scrollbar', false), {\n  defer: true\n});\n\n// 在切换网格模式后关掉 滚动条和工具栏 的强制显示\nhelper.createEffectOn(() => store.gridMode, () => setState(resetUI), {\n  defer: true\n});\n\n/** 处理尽头翻页。返回当前是否已抵达尽头 */\nconst handleEndTurnPage = withOptionalState((dir, state) => {\n  if (dir === 'prev') {\n    switch (state.show.endPage) {\n      case 'start':\n        if (state.scrollLock || store.option.scroolEnd !== 'auto') return true;\n        state.prop.onPrev?.();\n        return true;\n      case 'end':\n        state.show.endPage = undefined;\n        return true;\n      default:\n        // 弹出卷首结束页\n        if (isTop()) {\n          if (state.scrollLock) return true;\n          if (!state.prop.onExit || !state.prop.onPrev || store.option.scroolEnd !== 'auto') return true;\n          state.show.endPage = 'start';\n          return true;\n        }\n    }\n  } else {\n    switch (state.show.endPage) {\n      case 'end':\n        if (state.scrollLock || store.option.scroolEnd === 'none') return true;\n        if (store.option.scroolEnd === 'auto' && state.prop.onNext) state.prop.onNext();else state.prop.onExit?.(true);\n        return true;\n      case 'start':\n        state.show.endPage = undefined;\n        return true;\n      default:\n        // 弹出卷尾结束页\n        if (isBottom()) {\n          if (state.scrollLock) return true;\n          if (!state.prop.onExit) return true;\n          state.show.endPage = 'end';\n          return true;\n        }\n    }\n  }\n  return false;\n});\n\n/** 翻页。返回是否成功改变了当前页数 */\nconst turnPage = withOptionalState((dir, state) => {\n  if (state.gridMode || state.option.scrollMode.enabled) return false;\n  if (handleEndTurnPage(dir, state)) return false;\n  saveReadProgress();\n  state.activePageIndex += dir === 'next' ? 1 : -1;\n  return true;\n});\nconst turnPageAnimation = dir => {\n  setState(state => {\n    // 无法翻页就恢复原位\n    if (!turnPage(dir, state)) {\n      state.page.offset.x.px = 0;\n      state.page.offset.y.px = 0;\n      resetPage(state, true);\n      state.isDragMode = false;\n      return;\n    }\n    state.isDragMode = true;\n    resetPage(state);\n    if (store.page.vertical) state.page.offset.y.pct += dir === 'next' ? 1 : -1;else state.page.offset.x.pct += dir === 'next' ? -1 : 1;\n    setTimeout(() => {\n      setState(draftState => {\n        resetPage(draftState, true);\n        draftState.page.offset.x.px = 0;\n        draftState.page.offset.y.px = 0;\n        draftState.isDragMode = false;\n      });\n    }, 16);\n  });\n};\n\n/** 判断翻页方向 */\nconst getTurnPageDir = (move, total, startTime) => {\n  let dir;\n\n  // 处理无关速度不考虑时间单纯根据当前滚动距离来判断的情况\n  if (!startTime) {\n    if (Math.abs(move) > total / 2) dir = move > 0 ? 'next' : 'prev';\n    return dir;\n  }\n\n  // 滑动距离超过总长度三分之一判定翻页\n  if (Math.abs(move) > total / 3) dir = move > 0 ? 'next' : 'prev';\n  if (dir) return dir;\n\n  // 滑动速度超过 0.4 判定翻页\n  const velocity = move / (performance.now() - startTime);\n  if (velocity < -0.4) dir = 'prev';\n  if (velocity > 0.4) dir = 'next';\n  return dir;\n};\n\nconst touches = new Map();\nconst bound = helper.createMemoMap({\n  x: () => -store.rootSize.width * (store.option.zoom.ratio / 100 - 1),\n  y: () => -store.rootSize.height * (store.option.zoom.ratio / 100 - 1)\n});\nconst checkBound = state => {\n  state.option.zoom.offset.x = helper.clamp(bound().x, state.option.zoom.offset.x, 0);\n  state.option.zoom.offset.y = helper.clamp(bound().y, state.option.zoom.offset.y, 0);\n};\nconst zoom = (val, focal, animation = false) => {\n  const newScale = helper.clamp(100, val, 300);\n  if (newScale === store.option.zoom.ratio) return;\n\n  // 消除放大导致的偏移\n  const {\n    left,\n    top\n  } = refs.mangaBox.getBoundingClientRect();\n  const x = (focal?.x ?? store.rootSize.width / 2) - left;\n  const y = (focal?.y ?? store.rootSize.height / 2) - top;\n\n  // 当前直接放大后的基准点坐标\n  const newX = x / (store.option.zoom.ratio / 100) * (newScale / 100);\n  const newY = y / (store.option.zoom.ratio / 100) * (newScale / 100);\n\n  // 放大后基准点的偏移距离\n  const dx = newX - x;\n  const dy = newY - y;\n  setOption((draftOption, state) => {\n    draftOption.zoom.ratio = newScale;\n    draftOption.zoom.offset.x -= dx;\n    draftOption.zoom.offset.y -= dy;\n    checkBound(state);\n    if (animation) state.page.anima = 'zoom';\n  });\n};\n\n//\n// 惯性滑动\n//\n\n/** 摩擦系数 */\nconst FRICTION_COEFF$1 = 0.91;\nconst mouse = {\n  x: 0,\n  y: 0\n};\nconst last = {\n  x: 0,\n  y: 0\n};\nconst velocity = {\n  x: 0,\n  y: 0\n};\nlet animationId$2 = null;\nconst cancelAnimation = () => {\n  if (!animationId$2) return;\n  cancelAnimationFrame(animationId$2);\n  animationId$2 = null;\n};\nlet lastTime$1 = 0;\n\n/** 逐帧计算惯性滑动 */\nconst handleSlideAnima = timestamp => {\n  // 当速率足够小时停止计算动画\n  if (helper.approx(velocity.x, 0, 1) && helper.approx(velocity.y, 0, 1)) {\n    animationId$2 = null;\n    return;\n  }\n\n  // 在拖拽后模拟惯性滑动\n  setOption((draftOption, state) => {\n    draftOption.zoom.offset.x += velocity.x;\n    draftOption.zoom.offset.y += velocity.y;\n    checkBound(state);\n\n    // 确保每16毫秒才减少一次速率，防止在高刷新率显示器上衰减过快\n    if (timestamp - lastTime$1 > 16) {\n      velocity.x *= FRICTION_COEFF$1;\n      velocity.y *= FRICTION_COEFF$1;\n      lastTime$1 = timestamp;\n    }\n  });\n  animationId$2 = requestAnimationFrame(handleSlideAnima);\n};\n\n/** 逐帧根据鼠标坐标移动元素，并计算速率 */\nconst handleDragAnima$1 = () => {\n  // 当停着不动时退出循环\n  if (mouse.x === store.option.zoom.offset.x && mouse.y === store.option.zoom.offset.y) {\n    animationId$2 = null;\n    return;\n  }\n  setOption((draftOption, state) => {\n    last.x = draftOption.zoom.offset.x;\n    last.y = draftOption.zoom.offset.y;\n    draftOption.zoom.offset.x = mouse.x;\n    draftOption.zoom.offset.y = mouse.y;\n    checkBound(state);\n    velocity.x = draftOption.zoom.offset.x - last.x;\n    velocity.y = draftOption.zoom.offset.y - last.y;\n  });\n  animationId$2 = requestAnimationFrame(handleDragAnima$1);\n};\n\n/** 一段时间没有移动后应该将速率归零 */\nconst resetVelocity = helper.debounce(() => {\n  velocity.x = 0;\n  velocity.y = 0;\n}, 200);\n\n/** 是否正在双指捏合缩放中 */\nlet pinchZoom = false;\n\n/** 处理放大后的拖拽移动 */\nconst handleZoomDrag = ({\n  type,\n  xy: [x, y],\n  last: [lx, ly]\n}) => {\n  if (store.option.zoom.ratio === 100) return;\n  switch (type) {\n    case 'down':\n      {\n        mouse.x = store.option.zoom.offset.x;\n        mouse.y = store.option.zoom.offset.y;\n        if (animationId$2) cancelAnimation();\n        break;\n      }\n    case 'move':\n      {\n        if (animationId$2) cancelAnimation();\n        mouse.x += x - lx;\n        mouse.y += y - ly;\n        animationId$2 ??= requestAnimationFrame(handleDragAnima$1);\n        resetVelocity();\n        break;\n      }\n    case 'up':\n      {\n        resetVelocity.clear();\n\n        // 当双指捏合结束，一个手指抬起时，将剩余的指针当作刚点击来处理\n        if (pinchZoom) {\n          pinchZoom = false;\n          mouse.x = store.option.zoom.offset.x;\n          mouse.y = store.option.zoom.offset.y;\n          return;\n        }\n        if (animationId$2) cancelAnimationFrame(animationId$2);\n        animationId$2 = requestAnimationFrame(handleSlideAnima);\n      }\n  }\n};\n\n//\n// 双指捏合缩放\n//\n\n/** 初始双指距离 */\nlet initDistance = 0;\n/** 初始缩放比例 */\nlet initScale = 100;\n\n/** 获取两个指针之间的距离 */\nconst getDistance = (a, b) => Math.hypot(b.xy[0] - a.xy[0], b.xy[1] - a.xy[1]);\n\n/** 逐帧计算当前屏幕上两点之间的距离，并换算成缩放比例 */\nconst handlePinchZoomAnima = () => {\n  if (touches.size < 2) {\n    animationId$2 = null;\n    return;\n  }\n  const [a, b] = [...touches.values()];\n  const distance = getDistance(a, b);\n  zoom(distance / initDistance * initScale, {\n    x: (a.xy[0] + b.xy[0]) / 2,\n    y: (a.xy[1] + b.xy[1]) / 2\n  });\n  animationId$2 = requestAnimationFrame(handlePinchZoomAnima);\n};\n\n/** 处理双指捏合缩放 */\nconst handlePinchZoom = ({\n  type\n}) => {\n  if (touches.size < 2) return;\n  switch (type) {\n    case 'down':\n      {\n        pinchZoom = true;\n        const [a, b] = [...touches.values()];\n        initDistance = getDistance(a, b);\n        initScale = store.option.zoom.ratio;\n        break;\n      }\n    case 'up':\n      {\n        const [a, b] = [...touches.values()];\n        initDistance = getDistance(a, b);\n        break;\n      }\n    case 'move':\n      {\n        animationId$2 ??= requestAnimationFrame(handlePinchZoomAnima);\n        break;\n      }\n    case 'cancel':\n      {\n        const [a, b] = [...touches.values()];\n        initDistance = getDistance(a, b);\n        break;\n      }\n  }\n};\n\nconst _scrollTo = top => {\n  const val = helper.clamp(0, top, contentHeight() - store.rootSize.height);\n  refs.mangaBox.scrollTo({\n    top: val,\n    behavior: 'instant'\n  });\n  setState(state => {\n    state.scrollTop = val;\n    openScrollLock(state);\n  });\n};\n/** 在卷轴模式下滚动到指定进度 */\nconst scrollTo = (x, smooth = false) => {\n  if (!store.option.scrollMode.enabled) return;\n  if (store.option.scrollMode.abreastMode) {\n    _scrollTo(0);\n    const val = helper.clamp(0, x, abreastScrollWidth());\n    return setState('page', 'offset', 'x', 'px', val);\n  }\n  if (!smooth) {\n    scrollStep.cancel();\n    return _scrollTo(x);\n  }\n  if (scrollStep.animationId) {\n    scrollStep.cancel();\n    _scrollTo(x);\n  }\n  scrollStep.start(x);\n};\n\n/** 在卷轴模式下滚动指定进度 */\nconst scrollBy = (offset, smooth = false) => {\n  if (!store.option.scrollMode.enabled) return;\n  if (handleEndTurnPage(offset > 0 ? 'next' : 'prev')) return;\n  return scrollTo(scrollTop() + offset, smooth);\n};\n\n/** 实现卷轴模式下的平滑滚动 */\nconst scrollStep = new class extends helper.AnimationFrame {\n  /** 动画时长 */\n  duration = 100;\n  /** 要滚动的距离 */\n  distance = 0;\n  /** 滚动开始时间 */\n  startTime = 0;\n  /** 滚动开始位置 */\n  startTop = 0;\n  scrollTo = top => {\n    if (helper.inRange(0, top, scrollLength())) scrollTo(top);else this.cancel();\n  };\n  frame = timestamp => {\n    this.cancel();\n    this.startTime ||= timestamp;\n    /** 已滚动时间 */\n    const elapsed = timestamp - this.startTime;\n    if (elapsed >= this.duration) return this.scrollTo(this.startTop + this.distance);\n    this.scrollTo(this.startTop + elapsed / this.duration * this.distance);\n    this.call();\n  };\n  start = x => {\n    this.startTime = 0;\n    this.startTop = scrollTop();\n    this.distance = x - this.startTop;\n    this.frame(0);\n  };\n}();\n\n/** 实现卷轴模式下的匀速滚动 */\nconst constantScroll = new class extends helper.AnimationFrame {\n  speed = 0;\n  lastTime = 0;\n  scrollTo = top => {\n    if (helper.inRange(0, top, scrollLength())) scrollTo(top);else this.cancel();\n  };\n  frame = timestamp => {\n    if (!this.animationId) return;\n    if (this.lastTime) {\n      const scrollDelta = this.speed * (timestamp - this.lastTime);\n      this.scrollTo(scrollTop() + scrollDelta);\n    }\n    this.lastTime = timestamp;\n    this.call();\n  };\n  start = speed => {\n    if (this.animationId && speed === this.speed) return;\n    this.cancel();\n    this.speed = speed;\n    this.lastTime = 0;\n    this.call();\n  };\n}();\n\n/** 保存当前滚动进度，并在之后恢复 */\nconst saveScrollProgress = () => {\n  const oldScrollPercentage = scrollPercentage();\n  return () => scrollTo(oldScrollPercentage * scrollLength());\n};\n\n/** 在卷轴模式下，滚动到能显示指定图片的位置 */\nconst scrollViewImg = i => {\n  if (!store.option.scrollMode.enabled) return;\n  let top;\n  if (store.option.scrollMode.abreastMode) {\n    const columnNum = abreastArea().columns.findIndex(column => column.includes(i));\n    top = columnNum * abreastColumnWidth() + 1;\n  } else top = pageTopList()[i] + 1;\n  scrollTo(top);\n};\n\n/** 跳转到指定图片的显示位置 */\nconst jumpToImg = index => {\n  zoom(100);\n  setState('gridMode', false);\n  if (store.option.scrollMode.enabled) return scrollViewImg(index);\n  const pageNum = imgPageMap()[index];\n  if (pageNum === undefined) return;\n  setState(state => {\n    state.activePageIndex = pageNum;\n    state.gridMode = false;\n  });\n};\n\n/** 根据坐标找出被点击到的元素 */\nconst findClickEle = (eleList, {\n  x,\n  y\n}) => {\n  for (const e of eleList) {\n    const rect = e.getBoundingClientRect();\n    if (helper.inRange(rect.left, x, rect.right) && helper.inRange(rect.top, y, rect.bottom)) return e;\n  }\n};\n\n/** 触发点击区域操作 */\nconst handlePageClick = e => {\n  // 点击出错的图片可以立刻重新加载\n  for (const i of showImgList()) {\n    const img = getImg(i);\n    if (img.loadType !== 'error') continue;\n    const imgEle = getImgEle(i);\n    if (!imgEle || !findClickEle([imgEle], e)) continue;\n    return reloadImg(img.src);\n  }\n  const targetArea = findClickEle(refs.touchArea.children, e);\n  if (!targetArea || getComputedStyle(targetArea).visibility === 'hidden') return;\n  const areaName = targetArea.dataset.area;\n  if (!areaName) return;\n  if (areaName === 'menu' || areaName === 'MENU') return setState(state => {\n    state.show.scrollbar = !state.show.scrollbar;\n    state.show.toolbar = !state.show.toolbar;\n  });\n  setState(state => {\n    resetUI(state);\n    switch (areaName) {\n      case 'NEXT':\n      case 'next':\n        return handleHotkey('page_down');\n      case 'PREV':\n      case 'prev':\n        return handleHotkey('page_up');\n    }\n  });\n};\n\n/** 网格模式下点击图片跳到对应页 */\nconst handleGridClick = e => {\n  const target = findClickEle(refs.root.getElementsByClassName(modules_c21c94f2$1.img), e);\n  if (target) jumpToImg(Number(/_(\\d+)_/.exec(target.id)?.[1]));\n};\n\n/** 双击放大 */\nconst doubleClickZoom = e => !store.gridMode && zoom(store.option.zoom.ratio === 100 ? 350 : 100, e, true);\nconst handleClick = useDoubleClick(e => store.gridMode ? handleGridClick(e) : handlePageClick(e), doubleClickZoom);\nlet dx$1 = 0;\nlet dy$1 = 0;\nlet animationId$1 = null;\nconst handleDragAnima = () => {\n  // 当停着不动时退出循环\n  if (dx$1 === store.page.offset.x.px && dy$1 === store.page.offset.y.px) {\n    animationId$1 = null;\n    return;\n  }\n  setState(state => {\n    if (state.page.vertical) state.page.offset.y.px = dy$1;else state.page.offset.x.px = dx$1;\n  });\n  animationId$1 = requestAnimationFrame(handleDragAnima);\n};\nconst handleDragEnd = startTime => {\n  dx$1 = 0;\n  dy$1 = 0;\n  if (animationId$1) {\n    cancelAnimationFrame(animationId$1);\n    animationId$1 = null;\n  }\n\n  // 将拖动的页面移回正常位置\n  const dir = store.page.vertical ? getTurnPageDir(-store.page.offset.y.px, store.rootSize.height, startTime) : getTurnPageDir(store.page.offset.x.px, store.rootSize.width, startTime);\n  if (dir) return turnPageAnimation(dir);\n  setState(state => {\n    state.page.offset.x.px = 0;\n    state.page.offset.y.px = 0;\n    state.page.anima = 'page';\n    state.isDragMode = false;\n  });\n};\nhandleDragEnd.debounce = helper.debounce(handleDragEnd, 200);\nconst handleMangaFlowDrag = ({\n  type,\n  xy: [x, y],\n  initial: [ix, iy],\n  startTime\n}) => {\n  switch (type) {\n    case 'move':\n      {\n        dx$1 = store.option.dir === 'rtl' ? x - ix : ix - x;\n        dy$1 = y - iy;\n        if (store.isDragMode) {\n          animationId$1 ||= requestAnimationFrame(handleDragAnima);\n          return;\n        }\n\n        // 判断滑动方向\n        let slideDir;\n        const dxAbs = Math.abs(dx$1);\n        const dyAbs = Math.abs(dy$1);\n        if (dxAbs > 5 && dyAbs < 5) slideDir = 'horizontal';\n        if (dyAbs > 5 && dxAbs < 5) slideDir = 'vertical';\n        if (!slideDir) return;\n        setState(state => {\n          // 根据滑动方向自动切换排列模式\n          state.page.vertical = slideDir === 'vertical';\n          state.isDragMode = true;\n          resetPage(state);\n        });\n        return;\n      }\n    case 'up':\n      return handleDragEnd(startTime);\n  }\n};\nlet lastDeltaY$1 = 0;\nlet retardStartTime = 0;\nconst handleTrackpadWheel = e => {\n  if (store.option.scrollMode.enabled) return;\n  openScrollLock();\n  let deltaY = Math.floor(-e.deltaY);\n  let absDeltaY = Math.abs(deltaY);\n\n  // 加速度小于指定值后逐渐缩小滚动距离，实现减速效果\n  if (Math.abs(absDeltaY - lastDeltaY$1) <= 6) {\n    retardStartTime ||= Date.now();\n    deltaY *= 1 - Math.min(1, (Date.now() - retardStartTime) / 10 * 0.002);\n    absDeltaY = Math.abs(deltaY);\n    if (absDeltaY < 2) return;\n  } else retardStartTime = 0;\n  lastDeltaY$1 = absDeltaY;\n  dy$1 += deltaY;\n  setState(state => {\n    // 滚动过一页时\n    if (dy$1 <= -state.rootSize.height) {\n      if (turnPage('next', state)) dy$1 += state.rootSize.height;\n    } else if (dy$1 >= state.rootSize.height && turnPage('prev', state)) dy$1 -= state.rootSize.height;\n    state.page.vertical = true;\n    state.isDragMode = true;\n    resetPage(state);\n  });\n  animationId$1 ||= requestAnimationFrame(handleDragAnima);\n  handleDragEnd.debounce();\n};\n\n/** 修改卷轴模式下图片的目标宽度 */\nconst setAdjustToWidth = val => {\n  if (typeof store.option.scrollMode.adjustToWidth !== 'number') return;\n  if (typeof val === 'function') val = val(store.option.scrollMode.adjustToWidth);\n  if (Number.isNaN(val)) return;\n  const jump = saveScrollProgress();\n  setOption(draftOption => {\n    const max = Math.ceil(store.rootSize.width);\n    draftOption.scrollMode.adjustToWidth = helper.clamp(200, val, max);\n  });\n  jump();\n};\nconst minImgWidth = helper.createRootMemo(() => {\n  let min = Number.POSITIVE_INFINITY;\n  for (const img of Object.values(store.imgMap)) if (img.width && img.width < min) min = img.width;\n  return min;\n});\n\n/** 在卷轴模式下进行缩放，并且保持滚动进度不变 */\nconst setImgScale = val => {\n  if (typeof val === 'function') val = val(store.option.scrollMode.imgScale);\n  if (Number.isNaN(val)) return;\n  const jump = saveScrollProgress();\n  setOption(draftOption => {\n    val = helper.clamp(0.1, val, 3);\n\n    // 如果当前最小图片宽度大于视窗宽度，并且这次操作是在调小缩放值\n    // 那就将这次操作改为：将缩放值修改为只要缩小一点就会立刻让图片变小的极限值\n    // 避免用户需要多次调小缩放值才能看到效果的情况\n    // https://github.com/hymbz/ComicReadScript/issues/285\n    if (minImgWidth() > store.rootSize.width && val < draftOption.scrollMode.imgScale) {\n      const maxImgScale = store.rootSize.width / minImgWidth();\n      if (val > maxImgScale) val = maxImgScale;\n    }\n    draftOption.scrollMode.imgScale = helper.clamp(0.1, Number(val.toFixed(2)), 3);\n  });\n  jump();\n\n  // 并排卷轴模式下并没有一个明确直观的滚动进度，\n  // 也想不出有什么实现效果能和普通卷轴模式的效果一致,\n  // 所以就摆烂不管了，反正现在这样也已经能避免乱跳了\n};\n\n/** 处理卷轴模式下的放大/缩小操作 */\nconst handleScrollModeZoom = dir => {\n  if (!store.option.scrollMode.enabled) return;\n  if (store.option.scrollMode.adjustToWidth === 'full') return;\n  if (store.option.scrollMode.adjustToWidth === 'disable' || isAbreastMode()) setImgScale(val => val + 0.05 * (dir === 'add' ? 1 : -1));else setAdjustToWidth(val => val + 100 * (dir === 'add' ? 1 : -1));\n};\n\n/** 切换页面填充 */\nconst switchFillEffect = () => {\n  setState(state => {\n    // 如果当前页不是双页显示的就跳过，避免在显示跨页图的页面切换却没看到效果的疑惑\n    if (state.pageList[state.activePageIndex].length !== 2) return;\n    state.fillEffect[nowFillIndex()] = Number(!state.fillEffect[nowFillIndex()]);\n    updatePageData(state);\n  });\n};\n\n/** 切换卷轴模式 */\nconst switchScrollMode = () => {\n  const index = activeImgIndex();\n  zoom(100);\n  setOption((draftOption, state) => {\n    draftOption.scrollMode.enabled = !draftOption.scrollMode.enabled;\n    state.page.offset.x.px = 0;\n    state.page.offset.y.px = 0;\n  });\n  jumpToImg(index);\n};\n\n/** 切换单双页模式 */\nconst switchOnePageMode = () => {\n  const index = activeImgIndex();\n  setOption((draftOption, state) => {\n    if (draftOption.scrollMode.enabled) {\n      if (draftOption.scrollMode.abreastMode) {\n        draftOption.scrollMode.abreastMode = false;\n        draftOption.scrollMode.doubleMode = true;\n      } else draftOption.scrollMode.doubleMode = !draftOption.scrollMode.doubleMode;\n    } else {\n      const newPageNum = pageNum() === 1 ? 2 : 1;\n      draftOption.pageNum = state.option.autoSwitchPageMode && newPageNum === autoPageNum() ? 0 : newPageNum;\n    }\n  });\n  jumpToImg(index);\n};\n\n/** 切换阅读方向 */\nconst switchDir = () => {\n  setOption(draftOption => {\n    draftOption.dir = draftOption.dir === 'rtl' ? 'ltr' : 'rtl';\n  });\n};\n\n/** 切换网格模式 */\nconst switchGridMode = () => {\n  zoom(100);\n  setState(state => {\n    state.gridMode = !state.gridMode;\n    if (store.option.zoom.ratio !== 100) zoom(100);\n    state.page.anima = '';\n  });\n  // 切换到网格模式后自动定位到当前页\n  if (store.gridMode) requestAnimationFrame(() => {\n    refs.mangaFlow.children[activeImgIndex()]?.scrollIntoView({\n      block: 'center',\n      inline: 'center'\n    });\n  });\n};\n\n/** 切换全屏 */\nconst switchFullscreen = () => {\n  if (document.fullscreenElement) document.exitFullscreen();else refs.root.requestFullscreen();\n};\n\n/** 切换自动滚动 */\nconst switchAutoScroll = () => setState('autoScroll', 'play', val => !val);\n\n/** 切换图片识别相关功能 */\nconst switchImgRecognition = (...path) => setOption((draftOption, state) => {\n  const option = draftOption.imgRecognition;\n  if (path.length === 0) path.push('enabled');\n  for (const key of path) option[key] = !option[key];\n  if (!option.enabled) return;\n  for (const img of Object.values(state.imgMap)) {\n    if (!img.blobUrl) img.loadType = 'wait';\n    if (img.loadType !== 'loaded') continue;\n    handleImgRecognition(img.src);\n  }\n  if (path.includes('enabled')) updateImgLoadType();\n});\n\nconst handleMouseDown = e => {\n  if (e.button !== 1 || store.option.scrollMode.enabled) return;\n  e.stopPropagation();\n  e.preventDefault();\n  switchFillEffect();\n};\n\n/** 卷轴模式下滚动至指定页数 */\nconst scrollIntoView = (index, position = 'start') => scrollTo(position === 'start' ? getPageTop(index) : getPageTop(index + 1) - store.rootSize.height, true);\n\n/** 判断指定页能否被完全显示出来 */\nconst isFullView = i => pageHeightList()[i] < store.rootSize.height;\n\n/** 在卷轴模式下，智能滚动至图片的头尾 */\nconst scrollViewTurnPage = offset => {\n  if (!store.option.scrollMode.enabled) return;\n  const dir = offset > 0 ? 'next' : 'prev';\n  if (handleEndTurnPage(dir)) return;\n  if (!store.option.scrollMode.alignEdge) return scrollBy(offset, true);\n  const viewBottom = scrollTop() + store.rootSize.height;\n  let viewBottomPage = findTopPage(viewBottom);\n  // 如果底页只露出了一点点，就当它没显示出来，避免小数滚动的误差\n  if (helper.approx(getPageTop(viewBottomPage), viewBottom)) viewBottomPage -= 1;\n  const viewTop = scrollTop();\n  let viewTopPage = findTopPage(viewTop);\n  // 如果顶页只露出了一点点，就当它没显示出来，避免小数滚动的误差\n  if (helper.approx(getPageTop(viewTopPage + 1), viewTop)) viewTopPage += 1;\n  if (dir === 'next') {\n    const pageBottom = getPageTop(viewBottomPage + 1);\n\n    // 如果底页没显示出结尾，就跳转显示底页\n    if (!helper.approx(viewBottom, pageBottom)) {\n      // 如果当前显示的图片占满了屏幕\n      if (viewBottomPage === viewTopPage) {\n        // 并且在滚动了指定距离后显示的还是这个图片，就直接滚动完事\n        if (viewBottom + offset <= pageBottom) return scrollBy(offset, true);\n        // 否则跳至底页结尾\n        return scrollIntoView(viewBottomPage, 'end');\n      }\n      return scrollIntoView(viewBottomPage, isFullView(viewBottomPage) ? 'end' : 'start');\n    }\n    // 否则下一页\n    const nextPage = viewBottomPage + 1;\n    scrollIntoView(nextPage, isFullView(nextPage) ? 'end' : 'start');\n  } else {\n    const pageTop = getPageTop(viewTopPage);\n\n    // 如果顶页没显示出开头，就跳转显示顶页\n    if (!helper.approx(viewTop, pageTop)) {\n      // 如果当前显示的图片占满了屏幕\n      if (viewBottomPage === viewTopPage) {\n        // 并且在滚动了指定距离后显示的还是这个图片，就直接滚动完事\n        if (viewTop + offset >= pageTop) return scrollBy(offset, true);\n        // 否则跳至顶页开头\n        return scrollIntoView(viewTopPage, 'start');\n      }\n      return scrollIntoView(viewTopPage, isFullView(viewTopPage) ? 'start' : 'end');\n    }\n    // 否则上一页\n    const prevPage = viewTopPage - 1;\n    scrollIntoView(prevPage, isFullView(prevPage) ? 'start' : 'end');\n  }\n};\n\n/** 根据是否开启了 左右翻页键交换 来切换翻页方向 */\nconst handleSwapPageTurnKey = nextPage => {\n  const next = store.option.swapPageTurnKey ? !nextPage : nextPage;\n  return next ? 'next' : 'prev';\n};\nconst handleHotkey = (hotkey, e) => {\n  // 并排卷轴模式下的快捷键\n  if (isAbreastMode()) {\n    switch (hotkey) {\n      case 'scroll_up':\n        return setAbreastScrollFill(abreastScrollFill() - 40);\n      case 'scroll_down':\n        return setAbreastScrollFill(abreastScrollFill() + 40);\n      case 'scroll_left':\n        if (e?.repeat) return constantScroll.start(store.option.dir === 'rtl' ? -1 : 1);\n        return scrollBy(store.option.dir === 'rtl' ? -40 : 40);\n      case 'scroll_right':\n        if (e?.repeat) return constantScroll.start(store.option.dir === 'rtl' ? 1 : -1);\n        return scrollBy(store.option.dir === 'rtl' ? 40 : -40);\n      case 'page_up':\n        return scrollBy(-store.rootSize.width * 0.8);\n      case 'page_down':\n        return scrollBy(store.rootSize.width * 0.8);\n      case 'jump_to_home':\n        return scrollTo(0);\n      case 'jump_to_end':\n        return scrollTo(scrollLength());\n    }\n  }\n\n  // 普通卷轴模式下的快捷键\n  if (isScrollMode()) {\n    switch (hotkey) {\n      case 'page_up':\n        return scrollViewTurnPage(-store.rootSize.height * 0.8);\n      case 'page_down':\n        return scrollViewTurnPage(store.rootSize.height * 0.8);\n      case 'scroll_up':\n        if (e?.repeat) return constantScroll.start(-1);\n        return scrollBy(-40, true);\n      case 'scroll_down':\n        if (e?.repeat) return constantScroll.start(1);\n        return scrollBy(40, true);\n    }\n  }\n  switch (hotkey) {\n    case 'page_up':\n    case 'scroll_up':\n      return turnPage('prev');\n    case 'page_down':\n    case 'scroll_down':\n      return turnPage('next');\n    case 'scroll_left':\n      return turnPage(handleSwapPageTurnKey(store.option.dir === 'rtl'));\n    case 'scroll_right':\n      return turnPage(handleSwapPageTurnKey(store.option.dir !== 'rtl'));\n    case 'jump_to_home':\n      return setState('activePageIndex', 0);\n    case 'jump_to_end':\n      return setState('activePageIndex', Math.max(0, store.pageList.length - 1));\n    case 'switch_page_fill':\n      return switchFillEffect();\n    case 'switch_scroll_mode':\n      return switchScrollMode();\n    case 'switch_single_double_page_mode':\n      return switchOnePageMode();\n    case 'switch_dir':\n      return switchDir();\n    case 'switch_grid_mode':\n      return switchGridMode();\n    case 'translate_current_page':\n      return translateCurrent();\n    case 'translate_all':\n      return translateAll();\n    case 'translate_to_end':\n      return translateToEnd();\n    case 'auto_scroll':\n      return switchAutoScroll();\n    case 'fullscreen':\n      return switchFullscreen();\n    case 'switch_auto_enlarge':\n      return setOption(draftOption => {\n        draftOption.disableZoom = !draftOption.disableZoom;\n      });\n    case 'exit':\n      return store.prop.onExit?.();\n\n    // 阅读模式以外的快捷键转发到网页上去处理\n    default:\n      document.body.dispatchEvent(new KeyboardEvent('keydown', e));\n      document.body.dispatchEvent(new KeyboardEvent('keyup', e));\n  }\n};\nconst handleKeyDown = e => {\n  switch (e.target.tagName) {\n    case 'INPUT':\n    case 'TEXTAREA':\n      return;\n  }\n  if (e.target.className === modules_c21c94f2$1.hotkeysItem) return;\n  const code = helper.getKeyboardCode(e);\n\n  // esc 在触发配置操作前，先用于退出一些界面\n  if (e.key === 'Escape') {\n    if (store.gridMode) {\n      e.stopPropagation();\n      e.preventDefault();\n      return setState('gridMode', false);\n    }\n    if (store.show.endPage) {\n      e.stopPropagation();\n      e.preventDefault();\n      return setState('show', 'endPage', undefined);\n    }\n  }\n\n  // 处理标注了 data-only-number 的元素\n  if (e.target.dataset.onlyNumber !== undefined) {\n    // 拦截能输入数字外的按键\n    if (/^(?:Shift \\+ )?[a-zA-Z]$/.test(code)) {\n      e.stopPropagation();\n      e.preventDefault();\n    }\n    return;\n  }\n\n  // 卷轴、网格模式下跳过用于移动的原生按键\n  if ((isScrollMode() || store.gridMode) && !store.show.endPage) {\n    switch (e.key) {\n      case 'Home':\n      case 'End':\n      case 'ArrowRight':\n      case 'ArrowLeft':\n        return e.stopPropagation();\n      case 'ArrowUp':\n      case 'PageUp':\n        e.stopPropagation();\n        if (isScrollMode()) return handleEndTurnPage('prev');\n        return;\n      case 'ArrowDown':\n      case 'PageDown':\n      case ' ':\n        e.stopPropagation();\n        if (isScrollMode()) return handleEndTurnPage('next');\n        return;\n    }\n  }\n\n  // 拦截已注册的快捷键\n  if (Reflect.has(hotkeysMap(), code)) {\n    e.stopPropagation();\n    e.preventDefault();\n  } else return;\n  handleHotkey(hotkeysMap()[code], e);\n};\nconst handleKeyUp = e => {\n  switch (hotkeysMap()[helper.getKeyboardCode(e)]) {\n    // 停止长按滚动\n    case 'scroll_left':\n    case 'scroll_right':\n    case 'scroll_up':\n    case 'scroll_down':\n      return constantScroll.cancel();\n  }\n};\n\n/** 判断两个数值是否是整数倍的关系 */\nconst isMultipleOf = (a, b) => {\n  const decimal = `${a < b ? b / a : a / b}`.split('.')?.[1];\n  return !decimal || decimal.startsWith('0000') || decimal.startsWith('9999');\n};\nlet lastDeltaY = -1;\nlet timeoutId = 0;\nlet lastPageNum = -1;\nlet wheelType;\nlet equalNum = 0;\nlet diffNum = 0;\nconst handleWheel = e => {\n  if (store.gridMode) return;\n  e.stopPropagation();\n  if (e.ctrlKey || e.altKey) e.preventDefault();\n  const isWheelDown = e.deltaY > 0;\n  const dir = isWheelDown ? 'next' : 'prev';\n  const absDeltaY = Math.abs(e.deltaY);\n\n  // 通过`两次滚动距离是否成倍数`和`滚动距离是否过小`来判断是否是触摸板\n  if (wheelType !== 'trackpad' && (absDeltaY < 5 || !Number.isInteger(lastDeltaY) && !Number.isInteger(absDeltaY) && !isMultipleOf(lastDeltaY, absDeltaY))) {\n    wheelType = 'trackpad';\n    if (timeoutId) clearTimeout(timeoutId);\n    // 如果是触摸板滚动，且上次成功触发了翻页，就重新翻页回去\n    if (lastPageNum !== -1) setState('activePageIndex', lastPageNum);\n  }\n  if (absDeltaY < 5) return;\n\n  // 卷轴模式下的图片缩放\n  if ((e.ctrlKey || e.altKey) && store.option.scrollMode.enabled && store.option.zoom.ratio === 100) {\n    e.preventDefault();\n    return handleScrollModeZoom(isWheelDown ? 'sub' : 'add');\n  }\n  if (e.ctrlKey || e.altKey) {\n    e.preventDefault();\n    return zoom(store.option.zoom.ratio + (isWheelDown ? -25 : 25), e);\n  }\n  if (handleEndTurnPage(dir)) {\n    openScrollLock();\n    return e.preventDefault();\n  }\n\n  // 并排卷轴模式下\n  if (isAbreastMode() && store.option.zoom.ratio === 100) {\n    e.preventDefault();\n    scrollBy(e.deltaY, true);\n  }\n\n  // 防止滚动到网页\n  if (!isScrollMode()) e.preventDefault();\n\n  // 为了避免因临时卡顿而误判为触摸板\n  // 在连续几次滚动量均相同的情况下，将 wheelType 相关变量重置回初始状态\n  if (diffNum < 10) {\n    if (lastDeltaY === absDeltaY && absDeltaY > 5) equalNum += 1;else {\n      diffNum += 1;\n      equalNum = 0;\n    }\n    if (equalNum >= 3) {\n      wheelType = undefined;\n      lastPageNum = -1;\n    }\n  }\n  lastDeltaY = absDeltaY;\n  switch (wheelType) {\n    case undefined:\n      {\n        if (lastPageNum === -1) {\n          // 第一次触发滚动没法判断类型，就当作滚轮来处理\n          // 但为了避免触摸板前两次滚动事件间隔大于帧生成时间导致得重新翻页回去的闪烁，加个延迟等待下\n          lastPageNum = store.activePageIndex;\n          timeoutId = window.setTimeout(turnPage, 16, dir);\n          return;\n        }\n        wheelType = 'mouse';\n      }\n    // falls through\n\n    case 'mouse':\n      return turnPage(dir);\n    case 'trackpad':\n      return handleTrackpadWheel(e);\n  }\n};\n\n/** 判断点击位置在滚动条上的位置比率 */\nconst getClickTop = (x, y, e) => {\n  switch (scrollPosition()) {\n    case 'bottom':\n    case 'top':\n      return store.option.dir === 'rtl' ? 1 - x / e.offsetWidth : x / e.offsetWidth;\n    default:\n      return y / e.offsetHeight;\n  }\n};\n\n/** 计算在滚动条上的拖动距离 */\nconst getSliderDist = ([x, y], [ix, iy], e) => {\n  switch (scrollPosition()) {\n    case 'bottom':\n    case 'top':\n      return store.option.dir === 'rtl' ? (1 - (x - ix)) / e.offsetWidth : (x - ix) / e.offsetWidth;\n    default:\n      return (y - iy) / e.offsetHeight;\n  }\n};\nconst [isDrag, setIsDrag] = solidJs.createSignal(false);\nconst closeDrag = helper.debounce(() => setIsDrag(false), 200);\nlet lastType = 'up';\n\n/** 开始拖拽时的 sliderTop 值 */\nlet startTop = 0;\nconst handleScrollbarSlider = ({\n  type,\n  xy,\n  initial\n}, e) => {\n  const [x, y] = xy;\n\n  // 检测是否是拖动操作\n  if (type === 'move' && lastType === type) {\n    setIsDrag(true);\n    closeDrag();\n  }\n  lastType = type;\n\n  // 跳过拖拽结束事件（单击时会同时触发开始和结束，就用开始事件来完成单击的效果\n  if (type === 'up') return saveReadProgress();\n  if (!refs.mangaFlow) return;\n  const scrollbarDom = e.target;\n\n  /** 点击位置在滚动条上的位置比率 */\n  const clickTop = getClickTop(x, y, e.target);\n  if (store.option.scrollMode.enabled) {\n    if (type === 'move') {\n      const top = helper.clamp(0, startTop + getSliderDist(xy, initial, scrollbarDom), 1) * scrollLength();\n      scrollTo(top);\n    } else {\n      // 确保滚动条的中心会在点击位置\n      startTop = clickTop - sliderHeight() / 2;\n      const top = startTop * scrollLength();\n      scrollTo(top, true);\n    }\n  } else {\n    let newPageIndex = Math.floor(clickTop * store.pageList.length);\n    // 处理超出范围的情况\n    if (newPageIndex < 0) newPageIndex = 0;else if (newPageIndex >= store.pageList.length) newPageIndex = store.pageList.length - 1;\n    if (newPageIndex !== store.activePageIndex) setState('activePageIndex', newPageIndex);\n  }\n};\n\n/** 摩擦系数 */\nconst FRICTION_COEFF = 0.96;\nlet lastTop = 0;\nlet dy = 0;\nlet lastLeft = 0;\nlet dx = 0;\nlet animationId = null;\nlet lastTime = 0;\n\n/** 逐帧计算速率 */\nconst calcVelocity = () => {\n  const nowTop = store.option.scrollMode.abreastMode ? abreastScrollFill() : scrollTop();\n  dy = nowTop - lastTop;\n  lastTop = nowTop;\n  dx = store.page.offset.x.px - lastLeft;\n  lastLeft = store.page.offset.x.px;\n  animationId = requestAnimationFrame(calcVelocity);\n};\n\n/** 逐帧计算惯性滑动 */\nconst handleSlide = timestamp => {\n  // 当速率足够小时停止计算动画\n  if (Math.abs(dx) + Math.abs(dy) < 1) {\n    animationId = null;\n    return;\n  }\n\n  // 确保每16毫秒才减少一次速率，防止在高刷新率显示器上衰减过快\n  if (timestamp - lastTime > 16) {\n    dy *= FRICTION_COEFF;\n    dx *= FRICTION_COEFF;\n    lastTime = timestamp;\n  }\n  if (store.option.scrollMode.abreastMode) {\n    scrollTo(scrollTop() + dx);\n    setAbreastScrollFill(abreastScrollFill() + dy);\n  } else scrollTo(scrollTop() + dy);\n  animationId = requestAnimationFrame(handleSlide);\n};\nlet initTop = 0;\nlet initLeft = 0;\nlet initAbreastScrollFill = 0;\nconst handleScrollModeDrag = ({\n  type,\n  xy: [x, y],\n  initial: [ix, iy],\n  startTime\n}, e) => {\n  if (!store.option.scrollMode.abreastMode && e.pointerType !== 'mouse') return;\n  switch (type) {\n    case 'down':\n      {\n        if (animationId) cancelAnimationFrame(animationId);\n        initTop = refs.mangaBox.scrollTop;\n        initLeft = store.page.offset.x.px * (store.option.dir === 'rtl' ? 1 : -1);\n        initAbreastScrollFill = abreastScrollFill();\n        requestAnimationFrame(calcVelocity);\n        return;\n      }\n    case 'move':\n      {\n        if (store.option.scrollMode.abreastMode) {\n          const _dx = x - ix;\n          const _dy = y - iy;\n          scrollTo((initLeft + _dx) * (store.option.dir === 'rtl' ? 1 : -1));\n          setAbreastScrollFill(initAbreastScrollFill + _dy);\n        } else scrollTo(initTop + iy - y);\n        return;\n      }\n    case 'up':\n      {\n        if (animationId) cancelAnimationFrame(animationId);\n        if (performance.now() - startTime < 50) return;\n        animationId = requestAnimationFrame(handleSlide);\n        saveReadProgress();\n      }\n  }\n};\n\n/** 在鼠标静止一段时间后自动隐藏 */\nconst useHiddenMouse = () => {\n  const [hiddenMouse, setHiddenMouse] = solidJs.createSignal(true);\n  const hidden = helper.debounce(() => setHiddenMouse(true), 1000);\n  return {\n    hiddenMouse,\n    /** 鼠标移动 */\n    onMouseMove() {\n      setHiddenMouse(false);\n      hidden();\n    }\n  };\n};\n\nconst useStyle = css => solidJs.onMount(() => helper.useStyle(css, refs.root));\nconst useStyleMemo = (selector, styleMapArg) => solidJs.onMount(() => helper.useStyleMemo(selector, styleMapArg, refs.root));\n\nconst ComicImg = img => {\n  const showState = () => imgShowState().get(img.index);\n  const src = () => {\n    if (img.loadType === 'wait') return '';\n    if (img.translationType === 'show') return img.translationUrl;\n    if (store.option.imgRecognition.enabled) {\n      if (store.option.imgRecognition.upscale && img.upscaleUrl) return img.upscaleUrl;\n      return img.blobUrl;\n    }\n    // 有些浏览器不支持显示带有 hash 标识的图片 url\n    if (img.src.startsWith('blob:')) return img.src.replace(/#\\..+/, '');\n    return img.src;\n  };\n\n  /** 并排卷轴模式下需要复制的图片数量 */\n  const cloneNum = solidJs.createMemo(() => {\n    if (!isAbreastMode()) return 0;\n    const imgPosition = abreastArea().position[img.index];\n    return imgPosition ? imgPosition.length - 1 : 0;\n  });\n\n  /** 是否要渲染复制图片 */\n  const renderClone = () => !store.gridMode && showState() !== undefined && cloneNum() > 0;\n  const selector = `.${modules_c21c94f2$1.img}[id^=\"_${img.index}_\"]`;\n  useStyleMemo(selector, {\n    'grid-area': () => isAbreastMode() && !store.gridMode ? 'none' : `_${img.index}`,\n    'background-color': () => isEnableBg() ? img.background : undefined\n  });\n  useStyleMemo(`${selector} > picture`, {\n    'aspect-ratio': () => `${img.size.width} / ${img.size.height}`,\n    background: () => img.progress && `linear-gradient(\n          to bottom,\n          var(--secondary-bg) ${img.progress}%,\n          var(--hover-bg-color,#fff3) ${img.progress}%\n        )`\n  });\n  const _ComicImg = props => (() => {\n    var _el$ = web.template(`<div><picture>`)(),\n      _el$2 = _el$.firstChild;\n    web.insert(_el$2, web.createComponent(solidJs.Show, {\n      get when() {\n        return web.memo(() => img.loadType !== 'wait')() && src();\n      },\n      get children() {\n        var _el$3 = web.template(`<img draggable=false decoding=sync>`)();\n        _el$3.addEventListener(\"error\", e => handleImgError(img.src, e.currentTarget));\n        _el$3.addEventListener(\"load\", e => handleImgLoaded(img.src, e.currentTarget));\n        web.effect(_p$ => {\n          var _v$ = src(),\n            _v$2 = `${img.index}`,\n            _v$3 = img.src;\n          _v$ !== _p$.e && web.setAttribute(_el$3, \"src\", _p$.e = _v$);\n          _v$2 !== _p$.t && web.setAttribute(_el$3, \"alt\", _p$.t = _v$2);\n          _v$3 !== _p$.a && web.setAttribute(_el$3, \"data-src\", _p$.a = _v$3);\n          return _p$;\n        }, {\n          e: undefined,\n          t: undefined,\n          a: undefined\n        });\n        return _el$3;\n      }\n    }));\n    web.insert(_el$, web.createComponent(solidJs.Show, {\n      get when() {\n        return store.gridMode;\n      },\n      get children() {\n        var _el$4 = web.template(`<div>`)();\n        web.insert(_el$4, (() => {\n          var _c$ = web.memo(() => !!store.gridMode);\n          return () => _c$() ? getImgTip(img.index) : '';\n        })());\n        web.effect(() => web.className(_el$4, modules_c21c94f2$1.gridModeTip));\n        return _el$4;\n      }\n    }), null);\n    web.effect(_p$ => {\n      var _v$4 = modules_c21c94f2$1.img,\n        _v$5 = `_${img.index}_${props.cloneIndex ?? 0}`,\n        _v$6 = showState(),\n        _v$7 = img.type ?? store.defaultImgType,\n        _v$8 = img.loadType === 'loaded' ? undefined : img.loadType;\n      _v$4 !== _p$.e && web.className(_el$, _p$.e = _v$4);\n      _v$5 !== _p$.t && web.setAttribute(_el$, \"id\", _p$.t = _v$5);\n      _v$6 !== _p$.a && web.setAttribute(_el$, \"data-show\", _p$.a = _v$6);\n      _v$7 !== _p$.o && web.setAttribute(_el$, \"data-type\", _p$.o = _v$7);\n      _v$8 !== _p$.i && web.setAttribute(_el$, \"data-load-type\", _p$.i = _v$8);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined,\n      a: undefined,\n      o: undefined,\n      i: undefined\n    });\n    return _el$;\n  })();\n  return [web.createComponent(_ComicImg, {}), web.createComponent(solidJs.Show, {\n    get when() {\n      return renderClone();\n    },\n    get children() {\n      return web.createComponent(solidJs.For, {\n        get each() {\n          return Array.from({\n            length: cloneNum()\n          });\n        },\n        children: (_, i) => web.createComponent(_ComicImg, {\n          get cloneIndex() {\n            return i() + 1;\n          }\n        })\n      });\n    }\n  })];\n};\n\n// 目前即使是不显示的图片也必须挂载上，否则解析好的图片会被浏览器垃圾回收掉，\n// 导致在 ehentai 上无法正常加载图片。但这样会在图片过多时造成性能问题，\n// 虽然也尝试了将解析好的 Image 对象存储起来挂上引用和另外放到一个避免渲染的 dom 下，\n// 但也都失败了，只能暂时先不管了。\n// 之后尝试新方案时必须经过如下测试：开个几百页的漫画加载完毕后，再打开二十个标签页切换过去，\nconst EmptyTip = () => {\n  let ref; // oxlint-disable-line no-unassigned-vars\n\n  helper.onAutoMount(() => {\n    let timeoutId = 0;\n    const observer = new IntersectionObserver(([{\n      isIntersecting\n    }]) => {\n      if (!isIntersecting) return;\n      timeoutId = window.setTimeout(() => {\n        ref?.style.removeProperty('opacity');\n        timeoutId = 0;\n      }, 2000);\n    }, {\n      threshold: 1\n    });\n    observer.observe(ref);\n    return () => {\n      observer.disconnect();\n      if (timeoutId) clearTimeout(timeoutId);\n    };\n  });\n  return (() => {\n    var _el$ = web.template(`<h1>`)();\n    var _ref$ = ref;\n    typeof _ref$ === \"function\" ? web.use(_ref$, _el$) : ref = _el$;\n    web.setStyleProperty(_el$, \"opacity\", \"0\");\n    _el$.textContent = \"NULL\";\n    return _el$;\n  })();\n};\n\nconst ComicImgFlow = () => {\n  const {\n    hiddenMouse,\n    onMouseMove\n  } = useHiddenMouse();\n  const handleDrag = (state, e) => {\n    if (store.gridMode) return;\n    if (touches.size > 1) return handlePinchZoom(state);\n    if (store.option.zoom.ratio !== 100) return handleZoomDrag(state);\n    if (store.option.scrollMode.enabled) return handleScrollModeDrag(state, e);\n    return handleMangaFlowDrag(state);\n  };\n  solidJs.onMount(() => {\n    helper.useDrag({\n      ref: refs.mangaBox,\n      handleDrag,\n      handleClick,\n      touches\n    });\n    bindScrollTop(refs.mangaBox);\n  });\n  const handleTransitionEnd = () => {\n    if (store.isDragMode) return;\n    setState(state => {\n      if (store.option.zoom.ratio === 100) resetPage(state, false);else state.page.anima = '';\n    });\n  };\n\n  /** 在当前页之前有图片被加载出来，导致内容高度发生变化后，重新滚动页面，确保当前显示位置不变 */\n  helper.createEffectOn([() => store.showRange[0], () => pageTopList()[store.showRange[0]], pageTopList], ([showImg, height, topList], prev) => {\n    if (!prev || !height || !isScrollMode()) return;\n    const [prevShowImg, prevHeight, prevTopList] = prev;\n    if (showImg !== prevShowImg || prevTopList === topList || prevHeight === height) return;\n    scrollTo(scrollTop() + height - prevHeight);\n    // 目前还是会有轻微偏移，但考虑到大部分情况下都是顺序阅读，本身出现概率就低，就不继续排查优化了\n  });\n  const pageToText = page => `${(page.length === 1 ? [page[0], page[0]] : page).map(i => i === -1 ? '.' : `_${i}`).join(' ')}`;\n  const gridAreas = solidJs.createMemo(() => {\n    if (store.pageList.length === 0) return undefined;\n    if (store.gridMode) {\n      let columnNum;\n      if (store.isMobile) columnNum = 2;else if (store.defaultImgType === 'vertical') columnNum = 6;else if (isOnePageMode()) columnNum = 4;else columnNum = 2;\n      const areaList = [[]];\n      for (const page of store.pageList) {\n        if (areaList.at(-1).length === columnNum) areaList.push([]);\n        areaList.at(-1).push(pageToText(page));\n      }\n      while (areaList.at(-1).length !== columnNum) areaList.at(-1).push('. .');\n      return areaList.map(line => `\"${line.join(' ')}\"`).join('\\n') || undefined;\n    }\n    if (store.option.scrollMode.enabled) {\n      if (store.option.scrollMode.abreastMode) return `\"${helper.range(abreastArea().columns.length, i => `_${i}`).join(' ')}\"`;\n      if (store.option.scrollMode.doubleMode) return store.pageList.map(page => `\"${pageToText(page)}\"`).join('\\n');\n      return helper.range(store.imgList.length, i => `\"_${i}\"`).join('\\n');\n    }\n    return store.page.vertical ? store.pageList.slice(store.renderRange[0], store.renderRange[1] + 1).map(page => `\"${pageToText(page)}\"`).join('\\n') : `\"${store.pageList.slice(store.renderRange[0], store.renderRange[1] + 1).map(pageToText).join(' ')}\"`;\n  });\n  useStyleMemo(`.${modules_c21c94f2$1.mangaBox}`, {\n    transform: () => `translate(${store.option.zoom.offset.x}px, ${store.option.zoom.offset.y}px)\n        scale(${store.option.zoom.ratio / 100})`\n  });\n  const pageX = solidJs.createMemo(() => {\n    if (store.gridMode || isScrollMode()) return 0;\n    let x = store.page.offset.x.pct * store.rootSize.width + store.page.offset.x.px;\n    if (store.option.dir !== 'rtl') x = -x;\n    return x;\n  });\n  useStyleMemo(`#${modules_c21c94f2$1.mangaFlow}`, {\n    // 不能使用 transform 来移动，不然在 Safari 浏览器上悬浮显示时\n    // 每次滚动底下的网页时 mangaFlow 都会闪烁一下，在简易模式下会频繁触发\n    left: () => `${pageX()}px`,\n    top: () => `${store.page.offset.y.pct * store.rootSize.height + store.page.offset.y.px}px`,\n    'touch-action': function () {\n      if (store.gridMode) return 'auto';\n      if (store.option.zoom.ratio !== 100) {\n        if (!store.option.scrollMode.enabled) return 'none';\n        if (store.option.zoom.offset.y === 0) return 'pan-up';\n        if (store.option.zoom.offset.y === bound().y) return 'pan-down';\n      }\n    },\n    'grid-template-areas': gridAreas,\n    'grid-template-columns': function () {\n      if (store.imgList.length === 0 || store.gridMode) return undefined;\n      if (store.option.scrollMode.enabled) {\n        if (store.option.scrollMode.abreastMode) return `repeat(${abreastArea().columns.length}, ${abreastColumnWidth()}px)`;\n        if (store.option.scrollMode.doubleMode) return `50% 50%`;\n        return undefined;\n      }\n      if (store.page.vertical) return '50% 50%';\n      return `repeat(${gridAreas()?.split(' ').length ?? 0}, 50%)`;\n    },\n    'grid-template-rows': function () {\n      if (store.gridMode) return undefined;\n      if (isScrollMode()) return pageHeightList().map(num => `${num}px`).join(' ');\n    },\n    'background-color': () => isEnableBg() ? getImg(activeImgIndex())?.background : undefined\n  });\n  useStyle(imgAreaStyle);\n  return (() => {\n    var _el$ = web.template(`<div tabindex=-1><div tabindex=-1>`)(),\n      _el$2 = _el$.firstChild;\n    web.addEventListener(_el$, \"scrollend\", focus);\n    _el$.addEventListener(\"transitionend\", handleTransitionEnd);\n    var _ref$ = bindRef('mangaBox');\n    typeof _ref$ === \"function\" && web.use(_ref$, _el$);\n    _el$2.addEventListener(\"transitionend\", handleTransitionEnd);\n    web.addEventListener(_el$2, \"mousemove\", onMouseMove);\n    var _ref$2 = bindRef('mangaFlow');\n    typeof _ref$2 === \"function\" && web.use(_ref$2, _el$2);\n    web.insert(_el$2, web.createComponent(solidJs.Index, {\n      get each() {\n        return imgList();\n      },\n      get fallback() {\n        return web.createComponent(EmptyTip, {});\n      },\n      children: (img, i) => web.createComponent(ComicImg, web.mergeProps({\n        index: i\n      }, img))\n    }));\n    web.effect(_p$ => {\n      var _v$ = `${modules_c21c94f2$1.mangaBox} ${modules_c21c94f2$1.beautifyScrollbar}`,\n        _v$2 = store.page.anima,\n        _v$3 = helper.boolDataVal(store.option.scrollMode.abreastMode),\n        _v$4 = modules_c21c94f2$1.mangaFlow,\n        _v$5 = store.option.dir,\n        _v$6 = `${modules_c21c94f2$1.mangaFlow} ${modules_c21c94f2$1.beautifyScrollbar}`,\n        _v$7 = helper.boolDataVal(store.option.disableZoom && !store.option.scrollMode.enabled),\n        _v$8 = helper.boolDataVal(store.option.zoom.ratio !== 100),\n        _v$9 = helper.boolDataVal(store.page.vertical),\n        _v$0 = !store.gridMode && store.option.autoHiddenMouse && hiddenMouse();\n      _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n      _v$2 !== _p$.t && web.setAttribute(_el$, \"data-animation\", _p$.t = _v$2);\n      _v$3 !== _p$.a && web.setAttribute(_el$, \"data-abreast-scroll\", _p$.a = _v$3);\n      _v$4 !== _p$.o && web.setAttribute(_el$2, \"id\", _p$.o = _v$4);\n      _v$5 !== _p$.i && web.setAttribute(_el$2, \"dir\", _p$.i = _v$5);\n      _v$6 !== _p$.n && web.className(_el$2, _p$.n = _v$6);\n      _v$7 !== _p$.s && web.setAttribute(_el$2, \"data-disable-zoom\", _p$.s = _v$7);\n      _v$8 !== _p$.h && web.setAttribute(_el$2, \"data-scale-mode\", _p$.h = _v$8);\n      _v$9 !== _p$.r && web.setAttribute(_el$2, \"data-vertical\", _p$.r = _v$9);\n      _v$0 !== _p$.d && web.setAttribute(_el$2, \"data-hidden-mouse\", _p$.d = _v$0);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined,\n      a: undefined,\n      o: undefined,\n      i: undefined,\n      n: undefined,\n      s: undefined,\n      h: undefined,\n      r: undefined,\n      d: undefined\n    });\n    return _el$;\n  })();\n};\n\n\nconst areaArrayMap = {\n  left_right: [['prev', 'menu', 'next'], ['PREV', 'MENU', 'NEXT'], ['prev', 'menu', 'next']],\n  up_down: [['prev', 'PREV', 'prev'], ['menu', 'MENU', 'menu'], ['next', 'NEXT', 'next']],\n  edge: [['next', 'menu', 'next'], ['NEXT', 'MENU', 'NEXT'], ['next', 'PREV', 'next']],\n  l: [['PREV', 'prev', 'prev'], ['prev', 'MENU', 'next'], ['next', 'next', 'NEXT']]\n};\nconst areaType = helper.createRootMemo(() => Reflect.has(areaArrayMap, store.option.clickPageTurn.area) ? store.option.clickPageTurn.area : 'left_right');\nconst dir = helper.createRootMemo(() => {\n  if (!store.option.clickPageTurn.reverse) return store.option.dir;\n  return store.option.dir === 'rtl' ? 'ltr' : 'rtl';\n});\nconst TouchArea = () => (() => {\n  var _el$ = web.template(`<div>`)();\n  var _ref$ = bindRef('touchArea');\n  typeof _ref$ === \"function\" && web.use(_ref$, _el$);\n  web.insert(_el$, web.createComponent(solidJs.For, {\n    get each() {\n      return areaArrayMap[areaType()];\n    },\n    children: rows => web.createComponent(solidJs.For, {\n      each: rows,\n      children: area => (() => {\n        var _el$2 = web.template(`<div role=button tabindex=-1>`)();\n        web.setAttribute(_el$2, \"data-area\", area);\n        web.effect(() => web.className(_el$2, modules_c21c94f2$1.touchArea));\n        return _el$2;\n      })()\n    })\n  }));\n  web.effect(_p$ => {\n    var _v$ = modules_c21c94f2$1.touchAreaRoot,\n      _v$2 = dir(),\n      _v$3 = helper.boolDataVal(store.show.touchArea),\n      _v$4 = areaType(),\n      _v$5 = helper.boolDataVal(store.option.clickPageTurn.enabled),\n      _v$6 = helper.boolDataVal(store.option.clickPageTurn.shrinkMenu);\n    _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n    _v$2 !== _p$.t && web.setAttribute(_el$, \"dir\", _p$.t = _v$2);\n    _v$3 !== _p$.a && web.setAttribute(_el$, \"data-show\", _p$.a = _v$3);\n    _v$4 !== _p$.o && web.setAttribute(_el$, \"data-area\", _p$.o = _v$4);\n    _v$5 !== _p$.i && web.setAttribute(_el$, \"data-turn-page\", _p$.i = _v$5);\n    _v$6 !== _p$.n && web.setAttribute(_el$, \"data-shrink-menu\", _p$.n = _v$6);\n    return _p$;\n  }, {\n    e: undefined,\n    t: undefined,\n    a: undefined,\n    o: undefined,\n    i: undefined,\n    n: undefined\n  });\n  return _el$;\n})();\n\nlet delayTypeTimer = 0;\nconst EndPage = () => {\n  const handleClick = e => {\n    e.stopPropagation();\n    if (e.target?.nodeName !== 'BUTTON') setState('show', 'endPage', undefined);\n    focus();\n  };\n  let ref; // oxlint-disable-line no-unassigned-vars\n\n  const [isDrag, setIsDrag] = solidJs.createSignal(false);\n  const [dragY, setDragY] = solidJs.createSignal(0);\n  const handleDrag = ({\n    type,\n    xy: [, y],\n    initial: [, iy],\n    startTime\n  }) => {\n    switch (type) {\n      case 'down':\n        return setIsDrag(true);\n      case 'move':\n        return setDragY(y - iy);\n    }\n    const pageDir = getTurnPageDir(-dragY(), store.rootSize.height / 2, startTime);\n    if (pageDir) handleEndTurnPage(pageDir);\n    setDragY(0);\n    setIsDrag(false);\n  };\n  solidJs.onMount(() => {\n    helper.useDrag({\n      ref,\n      handleDrag,\n      skip: e => e.target.matches(`.${modules_c21c94f2$1.comments}, .${modules_c21c94f2$1.comments} *`)\n    });\n  });\n\n  // state.show.endPage 变量的延时版本，在隐藏的动画效果结束之后才会真正改变\n  // 防止在动画效果结束前 tip 就消失或改变了位置\n  const [delayType, setDelayType] = solidJs.createSignal();\n  solidJs.createEffect(() => {\n    if (store.show.endPage) {\n      window.clearTimeout(delayTypeTimer);\n      setDelayType(store.show.endPage);\n    } else {\n      delayTypeTimer = window.setTimeout(() => setDelayType(store.show.endPage), 500);\n    }\n  });\n  const tip = solidJs.createMemo(() => {\n    if (store.option.scroolEnd === 'none') return '';\n    switch (delayType()) {\n      case 'start':\n        if (!store.prop.onPrev || store.option.scroolEnd !== 'auto') break;\n        return helper.t('end_page.tip.start_jump');\n      case 'end':\n        if (store.prop.onNext && store.option.scroolEnd === 'auto') return helper.t('end_page.tip.end_jump');\n        if (store.prop.onExit) return helper.t('end_page.tip.exit');\n    }\n    return '';\n  });\n  return (() => {\n    var _el$ = web.template(`<div role=button tabindex=-1><div><p></p><button type=button></button><button type=button data-is-end></button><button type=button>`)(),\n      _el$2 = _el$.firstChild,\n      _el$3 = _el$2.firstChild,\n      _el$4 = _el$3.nextSibling,\n      _el$5 = _el$4.nextSibling,\n      _el$6 = _el$5.nextSibling;\n    web.addEventListener(_el$, \"click\", handleClick);\n    var _ref$ = ref;\n    typeof _ref$ === \"function\" ? web.use(_ref$, _el$) : ref = _el$;\n    web.insert(_el$3, tip);\n    web.addEventListener(_el$4, \"click\", () => store.prop.onPrev?.());\n    var _ref$2 = bindRef('prev');\n    typeof _ref$2 === \"function\" && web.use(_ref$2, _el$4);\n    web.insert(_el$4, () => helper.t('end_page.prev_button'));\n    web.addEventListener(_el$5, \"click\", () => store.prop.onExit?.(store.show.endPage === 'end'));\n    var _ref$3 = bindRef('exit');\n    typeof _ref$3 === \"function\" && web.use(_ref$3, _el$5);\n    web.insert(_el$5, () => helper.t('other.exit'));\n    web.addEventListener(_el$6, \"click\", () => store.prop.onNext?.());\n    var _ref$4 = bindRef('next');\n    typeof _ref$4 === \"function\" && web.use(_ref$4, _el$6);\n    web.insert(_el$6, () => helper.t('end_page.next_button'));\n    web.insert(_el$2, web.createComponent(solidJs.Show, {\n      get when() {\n        return web.memo(() => !!(store.option.showComment && delayType() === 'end'))() && store.commentList?.length;\n      },\n      get children() {\n        var _el$7 = web.template(`<div>`)();\n        web.addEventListener(_el$7, \"wheel\", stopPropagation);\n        web.insert(_el$7, web.createComponent(solidJs.For, {\n          get each() {\n            return store.commentList;\n          },\n          children: comment => (() => {\n            var _el$8 = web.template(`<p>`)();\n            web.insert(_el$8, comment);\n            return _el$8;\n          })()\n        }));\n        web.effect(() => web.className(_el$7, `${modules_c21c94f2$1.comments} ${modules_c21c94f2$1.beautifyScrollbar}`));\n        return _el$7;\n      }\n    }), null);\n    web.effect(_p$ => {\n      var _v$ = modules_c21c94f2$1.endPage,\n        _v$2 = store.show.endPage,\n        _v$3 = delayType(),\n        _v$4 = helper.boolDataVal(isDrag()),\n        _v$5 = dir() === 'rtl' ? 'row-reverse' : undefined,\n        _v$6 = modules_c21c94f2$1.endPageBody,\n        _v$7 = `${dragY()}px`,\n        _v$8 = modules_c21c94f2$1.tip,\n        _v$9 = {\n          [modules_c21c94f2$1.invisible]: !store.prop.onPrev\n        },\n        _v$0 = store.show.endPage ? 0 : -1,\n        _v$1 = store.show.endPage ? 0 : -1,\n        _v$10 = {\n          [modules_c21c94f2$1.invisible]: !store.prop.onNext\n        },\n        _v$11 = store.show.endPage ? 0 : -1;\n      _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n      _v$2 !== _p$.t && web.setAttribute(_el$, \"data-show\", _p$.t = _v$2);\n      _v$3 !== _p$.a && web.setAttribute(_el$, \"data-type\", _p$.a = _v$3);\n      _v$4 !== _p$.o && web.setAttribute(_el$, \"data-drag\", _p$.o = _v$4);\n      _v$5 !== _p$.i && web.setStyleProperty(_el$, \"flex-direction\", _p$.i = _v$5);\n      _v$6 !== _p$.n && web.className(_el$2, _p$.n = _v$6);\n      _v$7 !== _p$.s && web.setStyleProperty(_el$2, \"--drag-y\", _p$.s = _v$7);\n      _v$8 !== _p$.h && web.className(_el$3, _p$.h = _v$8);\n      _p$.r = web.classList(_el$4, _v$9, _p$.r);\n      _v$0 !== _p$.d && web.setAttribute(_el$4, \"tabindex\", _p$.d = _v$0);\n      _v$1 !== _p$.l && web.setAttribute(_el$5, \"tabindex\", _p$.l = _v$1);\n      _p$.u = web.classList(_el$6, _v$10, _p$.u);\n      _v$11 !== _p$.c && web.setAttribute(_el$6, \"tabindex\", _p$.c = _v$11);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined,\n      a: undefined,\n      o: undefined,\n      i: undefined,\n      n: undefined,\n      s: undefined,\n      h: undefined,\n      r: undefined,\n      d: undefined,\n      l: undefined,\n      u: undefined,\n      c: undefined\n    });\n    return _el$;\n  })();\n};\n\nconst getScrollbarPage = (img, i, double = false) => {\n  let num;\n  if (store.option.scrollMode.enabled) num = getImg(i).size.height;else num = double ? 2 : 1;\n  let upscale;\n  if (isUpscale() && img.upscaleUrl !== undefined) upscale = img.upscaleUrl === '' ? 'loading' : true;\n  return {\n    num,\n    loadType: img.loadType,\n    translationType: img.translationType,\n    upscale\n  };\n};\nconst ScrollbarPage = props => (() => {\n  var _el$ = web.template(`<div>`)();\n  web.effect(_p$ => {\n    var _v$ = modules_c21c94f2$1.scrollbarPage,\n      _v$2 = `${props.num / scrollLength() * 100}%`,\n      _v$3 = props.loadType,\n      _v$4 = props.translationType,\n      _v$5 = props.upscale;\n    _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n    _v$2 !== _p$.t && web.setStyleProperty(_el$, \"flex-basis\", _p$.t = _v$2);\n    _v$3 !== _p$.a && web.setAttribute(_el$, \"data-type\", _p$.a = _v$3);\n    _v$4 !== _p$.o && web.setAttribute(_el$, \"data-translation-type\", _p$.o = _v$4);\n    _v$5 !== _p$.i && web.setAttribute(_el$, \"data-upscale\", _p$.i = _v$5);\n    return _p$;\n  }, {\n    e: undefined,\n    t: undefined,\n    a: undefined,\n    o: undefined,\n    i: undefined\n  });\n  return _el$;\n})();\nconst isSameItem = (a, b) => a.loadType === b.loadType && a.translationType === b.translationType && a.upscale === b.upscale;\n\n/** 显示对应图片加载情况的元素 */\nconst ScrollbarPageStatus = () => {\n  // 将相同类型的页面合并显示\n  const scrollbarPageList = helper.createThrottleMemo(() => {\n    if (store.pageList.length === 0) return [];\n    const list = [];\n    let item;\n    const handleImg = (i, double = false) => {\n      const img = getImg(i);\n      const imgItem = getScrollbarPage(img, i, double);\n      if (!item) {\n        item = imgItem;\n        return;\n      }\n      if (isSameItem(item, imgItem)) {\n        if (store.option.scrollMode.enabled) item.num += img.size.height;else item.num += double ? 2 : 1;\n      } else {\n        list.push(item);\n        item = getScrollbarPage(img, i, double);\n      }\n    };\n    for (const [a, b] of store.pageList) {\n      if (b === undefined) handleImg(a, !isOnePageMode());else if (a === -1) {\n        handleImg(b);\n        handleImg(b);\n      } else if (b === -1) {\n        handleImg(a);\n        handleImg(a);\n      } else {\n        handleImg(a);\n        handleImg(b);\n      }\n    }\n    if (item) list.push(item);\n    return list;\n  }, 200);\n  return web.createComponent(solidJs.For, {\n    get each() {\n      return scrollbarPageList();\n    },\n    children: page => web.createComponent(ScrollbarPage, page)\n  });\n};\n\n\n/** 滚动条 */\nconst Scrollbar = () => {\n  solidJs.onMount(() => {\n    helper.useDrag({\n      ref: refs.scrollbar,\n      handleDrag: handleScrollbarSlider,\n      easyMode: () => isScrollMode() && store.option.scrollbar.easyScroll,\n      setCapture: true\n    });\n    watchDomSize('scrollbarSize', refs.scrollbar);\n  });\n\n  // 在被滚动时使自身可穿透，以便在卷轴模式下触发页面的滚动\n  const [penetrate, setPenetrate] = solidJs.createSignal(false);\n  const resetPenetrate = helper.debounce(() => setPenetrate(false));\n  const handleWheel = () => {\n    setPenetrate(true);\n    resetPenetrate();\n  };\n\n  /** 是否强制显示滚动条 */\n  const showScrollbar = solidJs.createMemo(() => store.show.scrollbar || Boolean(penetrate()));\n\n  /** 滚动条提示文本 */\n  const tipText = helper.createThrottleMemo(() => {\n    if (store.showRange[0] === store.showRange[1]) return getPageTip(store.showRange[0]);\n\n    /** 并排卷轴模式下的滚动条提示文本 */\n    if (isAbreastMode()) {\n      const columns = abreastArea().columns.slice(abreastShowColumn().start, abreastShowColumn().end + 1).map(column => column.map(getPageTip));\n      if (store.option.dir !== 'rtl') columns.reverse();\n      return columns.map(column => column.join(' ')).join('\\n');\n    }\n    const tipList = [];\n    for (let [i] = store.showRange; i <= store.showRange[1]; i++) tipList.push(getPageTip(i));\n    if (isOnePageMode() || isDoubleMode()) return tipList.join('\\n');\n    if (tipList.length === 1) return tipList[0];\n    if (store.option.dir === 'rtl') tipList.reverse();\n    return tipList.join('   ');\n  });\n  useStyleMemo(`.${modules_c21c94f2$1.scrollbar}`, {\n    'pointer-events': () => penetrate() || store.isDragMode || store.gridMode ? 'none' : 'auto',\n    '--scroll-length': () => `${scrollDomLength()}px`,\n    '--slider-midpoint': () => `${sliderMidpoint()}px`,\n    '--slider-height': () => `${sliderHeight() * scrollDomLength()}px`,\n    '--slider-top': sliderTop\n  });\n  const _Scrollbar = props => (() => {\n    var _el$ = web.template(`<div role=scrollbar tabindex=-1>`)();\n    _el$.addEventListener(\"wheel\", handleWheel);\n    var _ref$ = props.ref;\n    typeof _ref$ === \"function\" ? web.use(_ref$, _el$) : props.ref = _el$;\n    web.insert(_el$, () => props.children);\n    web.effect(_p$ => {\n      var _v$ = modules_c21c94f2$1.scrollbar,\n        _v$2 = modules_c21c94f2$1.mangaFlow,\n        _v$3 = store.activePageIndex || -1,\n        _v$4 = helper.boolDataVal(store.option.scrollbar.autoHidden),\n        _v$5 = helper.boolDataVal(showScrollbar()),\n        _v$6 = store.option.dir,\n        _v$7 = scrollPosition(),\n        _v$8 = helper.boolDataVal(isAbreastMode()),\n        _v$9 = helper.boolDataVal(isDrag()),\n        _v$0 = props.style;\n      _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n      _v$2 !== _p$.t && web.setAttribute(_el$, \"aria-controls\", _p$.t = _v$2);\n      _v$3 !== _p$.a && web.setAttribute(_el$, \"aria-valuenow\", _p$.a = _v$3);\n      _v$4 !== _p$.o && web.setAttribute(_el$, \"data-auto-hidden\", _p$.o = _v$4);\n      _v$5 !== _p$.i && web.setAttribute(_el$, \"data-force-show\", _p$.i = _v$5);\n      _v$6 !== _p$.n && web.setAttribute(_el$, \"data-dir\", _p$.n = _v$6);\n      _v$7 !== _p$.s && web.setAttribute(_el$, \"data-position\", _p$.s = _v$7);\n      _v$8 !== _p$.h && web.setAttribute(_el$, \"data-is-abreast-mode\", _p$.h = _v$8);\n      _v$9 !== _p$.r && web.setAttribute(_el$, \"data-drag\", _p$.r = _v$9);\n      _p$.d = web.style(_el$, _v$0, _p$.d);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined,\n      a: undefined,\n      o: undefined,\n      i: undefined,\n      n: undefined,\n      s: undefined,\n      h: undefined,\n      r: undefined,\n      d: undefined\n    });\n    return _el$;\n  })();\n  return [web.createComponent(_Scrollbar, {\n    ref(r$) {\n      var _ref$2 = bindRef('scrollbar');\n      typeof _ref$2 === \"function\" && _ref$2(r$);\n    },\n    get children() {\n      return [(() => {\n        var _el$2 = web.template(`<div>`)();\n        web.insert(_el$2, tipText);\n        web.effect(() => web.className(_el$2, modules_c21c94f2$1.scrollbarPoper));\n        return _el$2;\n      })(), web.createComponent(solidJs.Show, {\n        get when() {\n          return store.option.scrollbar.showImgStatus;\n        },\n        get children() {\n          return web.createComponent(ScrollbarPageStatus, {});\n        }\n      })];\n    }\n  }), web.createComponent(_Scrollbar, {\n    style: {\n      'mix-blend-mode': 'difference',\n      'pointer-events': 'none'\n    },\n    get children() {\n      var _el$3 = web.template(`<div>`)();\n      web.effect(_p$ => {\n        var _v$1 = modules_c21c94f2$1.scrollbarSlider,\n          _v$10 = {\n            [modules_c21c94f2$1.hidden]: store.gridMode\n          };\n        _v$1 !== _p$.e && web.className(_el$3, _p$.e = _v$1);\n        _p$.t = web.classList(_el$3, _v$10, _p$.t);\n        return _p$;\n      }, {\n        e: undefined,\n        t: undefined\n      });\n      return _el$3;\n    }\n  })];\n};\n\nconst MdClose = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdFullscreenExit = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M6 16h2v2c0 .55.45 1 1 1s1-.45 1-1v-3c0-.55-.45-1-1-1H6c-.55 0-1 .45-1 1s.45 1 1 1m2-8H6c-.55 0-1 .45-1 1s.45 1 1 1h3c.55 0 1-.45 1-1V6c0-.55-.45-1-1-1s-1 .45-1 1zm7 11c.55 0 1-.45 1-1v-2h2c.55 0 1-.45 1-1s-.45-1-1-1h-3c-.55 0-1 .45-1 1v3c0 .55.45 1 1 1m1-11V6c0-.55-.45-1-1-1s-1 .45-1 1v3c0 .55.45 1 1 1h3c.55 0 1-.45 1-1s-.45-1-1-1z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdFullscreen = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M6 14c-.55 0-1 .45-1 1v3c0 .55.45 1 1 1h3c.55 0 1-.45 1-1s-.45-1-1-1H7v-2c0-.55-.45-1-1-1m0-4c.55 0 1-.45 1-1V7h2c.55 0 1-.45 1-1s-.45-1-1-1H6c-.55 0-1 .45-1 1v3c0 .55.45 1 1 1m11 7h-2c-.55 0-1 .45-1 1s.45 1 1 1h3c.55 0 1-.45 1-1v-3c0-.55-.45-1-1-1s-1 .45-1 1zM14 6c0 .55.45 1 1 1h2v2c0 .55.45 1 1 1s1-.45 1-1V6c0-.55-.45-1-1-1h-3c-.55 0-1 .45-1 1\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdGrid = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M22 6c0-.55-.45-1-1-1h-2V3c0-.55-.45-1-1-1s-1 .45-1 1v2h-4V3c0-.55-.45-1-1-1s-1 .45-1 1v2H7V3c0-.55-.45-1-1-1s-1 .45-1 1v2H3c-.55 0-1 .45-1 1s.45 1 1 1h2v4H3c-.55 0-1 .45-1 1s.45 1 1 1h2v4H3c-.55 0-1 .45-1 1s.45 1 1 1h2v2c0 .55.45 1 1 1s1-.45 1-1v-2h4v2c0 .55.45 1 1 1s1-.45 1-1v-2h4v2c0 .55.45 1 1 1s1-.45 1-1v-2h2c.55 0 1-.45 1-1s-.45-1-1-1h-2v-4h2c.55 0 1-.45 1-1s-.45-1-1-1h-2V7h2c.55 0 1-.45 1-1M7 7h4v4H7zm0 10v-4h4v4zm10 0h-4v-4h4zm0-6h-4V7h4z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdLooksOne = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m-6 14c-.55 0-1-.45-1-1V9h-1c-.55 0-1-.45-1-1s.45-1 1-1h2c.55 0 1 .45 1 1v8c0 .55-.45 1-1 1\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdLooksTwo = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m-4 8c0 1.1-.9 2-2 2h-2v2h3c.55 0 1 .45 1 1s-.45 1-1 1h-4c-.55 0-1-.45-1-1v-3c0-1.1.9-2 2-2h2V9h-3c-.55 0-1-.45-1-1s.45-1 1-1h3c1.1 0 2 .9 2 2z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdLowPriority = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M15 5h6c.55 0 1 .45 1 1s-.45 1-1 1h-6c-.55 0-1-.45-1-1s.45-1 1-1m0 5.5h6c.55 0 1 .45 1 1s-.45 1-1 1h-6c-.55 0-1-.45-1-1s.45-1 1-1m0 5.5h6c.55 0 1 .45 1 1s-.45 1-1 1h-6c-.55 0-1-.45-1-1s.45-1 1-1m-5.15 3.15 1.79-1.79c.2-.2.2-.51 0-.71l-1.79-1.79a.495.495 0 0 0-.85.35v3.59c0 .44.54.66.85.35M9 16h-.3c-2.35 0-4.45-1.71-4.68-4.05A4.51 4.51 0 0 1 8.5 7H11c.55 0 1-.45 1-1s-.45-1-1-1H8.5c-3.86 0-6.96 3.4-6.44 7.36C2.48 15.64 5.43 18 8.73 18H9\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdQueue = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M3 6c-.55 0-1 .45-1 1v13c0 1.1.9 2 2 2h13c.55 0 1-.45 1-1s-.45-1-1-1H5c-.55 0-1-.45-1-1V7c0-.55-.45-1-1-1m17-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2m-2 9h-3v3c0 .55-.45 1-1 1s-1-.45-1-1v-3h-3c-.55 0-1-.45-1-1s.45-1 1-1h3V6c0-.55.45-1 1-1s1 .45 1 1v3h3c.55 0 1 .45 1 1s-.45 1-1 1\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdSettings = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M19.5 12c0-.23-.01-.45-.03-.68l1.86-1.41c.4-.3.51-.86.26-1.3l-1.87-3.23a.987.987 0 0 0-1.25-.42l-2.15.91c-.37-.26-.76-.49-1.17-.68l-.29-2.31c-.06-.5-.49-.88-.99-.88h-3.73c-.51 0-.94.38-1 .88l-.29 2.31c-.41.19-.8.42-1.17.68l-2.15-.91c-.46-.2-1-.02-1.25.42L2.41 8.62c-.25.44-.14.99.26 1.3l1.86 1.41a7.3 7.3 0 0 0 0 1.35l-1.86 1.41c-.4.3-.51.86-.26 1.3l1.87 3.23c.25.44.79.62 1.25.42l2.15-.91c.37.26.76.49 1.17.68l.29 2.31c.06.5.49.88.99.88h3.73c.5 0 .93-.38.99-.88l.29-2.31c.41-.19.8-.42 1.17-.68l2.15.91c.46.2 1 .02 1.25-.42l1.87-3.23c.25-.44.14-.99-.26-1.3l-1.86-1.41c.03-.23.04-.45.04-.68m-7.46 3.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdTranslate = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M12.65 15.67c.14-.36.05-.77-.23-1.05l-2.09-2.06.03-.03A17.5 17.5 0 0 0 14.07 6h1.94c.54 0 .99-.45.99-.99v-.02c0-.54-.45-.99-.99-.99H10V3c0-.55-.45-1-1-1s-1 .45-1 1v1H1.99c-.54 0-.99.45-.99.99 0 .55.45.99.99.99h10.18A15.7 15.7 0 0 1 9 11.35c-.81-.89-1.49-1.86-2.06-2.88A.89.89 0 0 0 6.16 8c-.69 0-1.13.75-.79 1.35.63 1.13 1.4 2.21 2.3 3.21L3.3 16.87a.99.99 0 0 0 0 1.42c.39.39 1.02.39 1.42 0L9 14l2.02 2.02c.51.51 1.38.32 1.63-.35M17.5 10c-.6 0-1.14.37-1.35.94l-3.67 9.8c-.24.61.22 1.26.87 1.26.39 0 .74-.24.88-.61l.89-2.39h4.75l.9 2.39c.14.36.49.61.88.61.65 0 1.11-.65.88-1.26l-3.67-9.8c-.22-.57-.76-.94-1.36-.94m-1.62 7 1.62-4.33L19.12 17z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdViewDay = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M3 21h17c.55 0 1-.45 1-1v-1c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v1c0 .55.45 1 1 1M20 8H3c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1h17c.55 0 1-.45 1-1V9c0-.55-.45-1-1-1M2 4v1c0 .55.45 1 1 1h17c.55 0 1-.45 1-1V4c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdZoomIn = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M15.5 14h-.79l-.28-.27a6.5 6.5 0 0 0 1.48-5.34c-.47-2.78-2.79-5-5.59-5.34-4.23-.52-7.78 3.04-7.27 7.27.34 2.8 2.56 5.12 5.34 5.59a6.5 6.5 0 0 0 5.34-1.48l.27.28v.79l4.26 4.25c.41.41 1.07.41 1.48 0l.01-.01c.41-.41.41-1.07 0-1.48zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14m0-7c-.28 0-.5.22-.5.5V9H7.5c-.28 0-.5.22-.5.5s.22.5.5.5H9v1.5c0 .28.22.5.5.5s.5-.22.5-.5V10h1.5c.28 0 .5-.22.5-.5s-.22-.5-.5-.5H10V7.5c0-.28-.22-.5-.5-.5\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdZoomOut = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M15.5 14h-.79l-.28-.27a6.5 6.5 0 0 0 1.48-5.34c-.47-2.78-2.79-5-5.59-5.34a6.505 6.505 0 0 0-7.27 7.27c.34 2.8 2.56 5.12 5.34 5.59a6.5 6.5 0 0 0 5.34-1.48l.27.28v.79l4.26 4.25c.41.41 1.07.41 1.48 0l.01-.01c.41-.41.41-1.07 0-1.48zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14m-2-5h4c.28 0 .5.22.5.5s-.22.5-.5.5h-4c-.28 0-.5-.22-.5-.5s.22-.5.5-.5\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nvar css = \".iconButtonItem____hash_base64_5_{align-items:center;display:flex;position:relative}.iconButton____hash_base64_5_{align-items:center;background-color:initial;border-radius:9999px;border-style:none;color:var(--text,#fff);cursor:pointer;display:flex;font-size:1.5em;height:1.5em;justify-content:center;margin:.1em;outline:none;padding:0;width:1.5em}.iconButton____hash_base64_5_:focus,.iconButton____hash_base64_5_:hover{background-color:var(--hover-bg-color,#fff3)}.iconButton____hash_base64_5_.enabled____hash_base64_5_:not(.disable____hash_base64_5_){background-color:var(--text,#fff);color:var(--text-bg,#121212)}.iconButton____hash_base64_5_.enabled____hash_base64_5_:not(.disable____hash_base64_5_):focus,.iconButton____hash_base64_5_.enabled____hash_base64_5_:not(.disable____hash_base64_5_):hover{background-color:var(--hover-bg-color-enable,#fffa)}.iconButton____hash_base64_5_.disable____hash_base64_5_{background-color:unset;cursor:not-allowed;opacity:.5}.iconButton____hash_base64_5_>svg{width:1em}.iconButtonPopper____hash_base64_5_{align-items:center;background-color:#303030;border-radius:.3em;color:#fff;display:flex;font-size:.8em;opacity:0;padding:.4em .5em;pointer-events:none;position:absolute;top:50%;transform:translateY(-50%);-webkit-user-select:none;user-select:none;white-space:nowrap}.iconButtonPopper____hash_base64_5_[data-placement=right]{left:calc(100% + 1.5em)}.iconButtonPopper____hash_base64_5_[data-placement=right]:before{border-right-color:var(--switch-bg,#6e6e6e);border-right-width:.5em;right:calc(100% + .5em)}.iconButtonPopper____hash_base64_5_[data-placement=left]{right:calc(100% + 1.5em)}.iconButtonPopper____hash_base64_5_[data-placement=left]:before{border-left-color:var(--switch-bg,#6e6e6e);border-left-width:.5em;left:calc(100% + .5em)}.iconButtonPopper____hash_base64_5_:before{background-color:initial;border:.4em solid #0000;content:\\\"\\\";pointer-events:none;position:absolute;transition:opacity .15s}.iconButtonItem____hash_base64_5_:is(:hover,:focus,[data-show=true]) .iconButtonPopper____hash_base64_5_{opacity:1}.hidden____hash_base64_5_{display:none}\";\nvar modules_c21c94f2 = {\"iconButtonItem\":\"iconButtonItem____hash_base64_5_\",\"iconButton\":\"iconButton____hash_base64_5_\",\"enabled\":\"enabled____hash_base64_5_\",\"disable\":\"disable____hash_base64_5_\",\"iconButtonPopper\":\"iconButtonPopper____hash_base64_5_\",\"hidden\":\"hidden____hash_base64_5_\"};\n\n/** 图标按钮 */\nconst IconButton = _props => {\n  const props = solidJs.mergeProps({\n    placement: 'right'\n  }, _props);\n  let buttonRef; // oxlint-disable-line no-unassigned-vars\n  const handleClick = e => {\n    if (props.disable) return;\n    props.onClick?.(e);\n    // 在每次点击后取消焦点\n    buttonRef?.blur();\n  };\n  return (() => {\n    var _el$ = web.template(`<div><button type=button tabindex=0>`)(),\n      _el$2 = _el$.firstChild;\n    web.use(ref => helper.useStyle(css, ref), _el$);\n    web.addEventListener(_el$2, \"click\", handleClick);\n    var _ref$ = buttonRef;\n    typeof _ref$ === \"function\" ? web.use(_ref$, _el$2) : buttonRef = _el$2;\n    web.insert(_el$2, () => props.children);\n    web.insert(_el$, (() => {\n      var _c$ = web.memo(() => !!(props.popper || props.tip));\n      return () => _c$() ? (() => {\n        var _el$3 = web.template(`<div>`)();\n        web.insert(_el$3, () => props.popper || props.tip);\n        web.effect(_p$ => {\n          var _v$7 = [modules_c21c94f2.iconButtonPopper, props.popperClassName].join(' '),\n            _v$8 = props.placement;\n          _v$7 !== _p$.e && web.className(_el$3, _p$.e = _v$7);\n          _v$8 !== _p$.t && web.setAttribute(_el$3, \"data-placement\", _p$.t = _v$8);\n          return _p$;\n        }, {\n          e: undefined,\n          t: undefined\n        });\n        return _el$3;\n      })() : null;\n    })(), null);\n    web.effect(_p$ => {\n      var _v$ = modules_c21c94f2.iconButtonItem,\n        _v$2 = props.showTip,\n        _v$3 = props.tip,\n        _v$4 = modules_c21c94f2.iconButton,\n        _v$5 = props.style,\n        _v$6 = {\n          [modules_c21c94f2.hidden]: props.hidden,\n          [modules_c21c94f2.enabled]: props.enabled,\n          [modules_c21c94f2.disable]: props.disable\n        };\n      _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n      _v$2 !== _p$.t && web.setAttribute(_el$, \"data-show\", _p$.t = _v$2);\n      _v$3 !== _p$.a && web.setAttribute(_el$2, \"aria-label\", _p$.a = _v$3);\n      _v$4 !== _p$.o && web.className(_el$2, _p$.o = _v$4);\n      _p$.i = web.style(_el$2, _v$5, _p$.i);\n      _p$.n = web.classList(_el$2, _v$6, _p$.n);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined,\n      a: undefined,\n      o: undefined,\n      i: undefined,\n      n: undefined\n    });\n    return _el$;\n  })();\n};\n\nconst MdPlayArrow = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M8 6.82v10.36c0 .79.87 1.27 1.54.84l8.14-5.18a1 1 0 0 0 0-1.69L9.54 5.98A.998.998 0 0 0 8 6.82\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdStop = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M8 6h8c1.1 0 2 .9 2 2v8c0 1.1-.9 2-2 2H8c-1.1 0-2-.9-2-2V8c0-1.1.9-2 2-2\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst autoScroll = new class extends helper.AnimationFrame {\n  /** 上次滚动的时间 */\n  lastTime = 0;\n  scroll = () => {\n    if (isBottom()) {\n      this.stop();\n      if (!store.prop.onExit) return;\n      setState('show', 'endPage', 'end');\n      if (store.option.autoScroll.triggerEnd) setTimeout(handleEndTurnPage, 500, 'next');\n      return;\n    }\n    handleHotkey('page_down');\n  };\n  frame = timestamp => {\n    const elapsed = timestamp - this.lastTime;\n    let progress;\n    if (elapsed >= store.option.autoScroll.interval) {\n      this.lastTime = timestamp;\n      this.scroll();\n      progress = 1;\n    }\n    if (!store.autoScroll.play) return;\n    progress ||= elapsed / store.option.autoScroll.interval;\n    setState('autoScroll', 'progress', progress);\n    this.call();\n  };\n  start = () => {\n    this.lastTime = 0;\n    this.call();\n  };\n  stop = () => {\n    this.cancel();\n    setState('autoScroll', 'play', false);\n  };\n}();\nhelper.createEffectOn(() => [...Object.values(store.option.autoScroll), store.autoScroll.play], () => {\n  autoScroll.cancel();\n  if (!store.option.autoScroll.enabled || !store.autoScroll.play) return;\n  autoScroll.start();\n});\n\n// 点击屏幕中间停止自动滚动\nhelper.createEffectOn(() => store.show.toolbar, show => show && autoScroll.stop());\nconst AutoScrollButton = () => {\n  const background = solidJs.createMemo(() => {\n    if (!store.autoScroll.play) return undefined;\n    const deg = store.autoScroll.progress * 360 % 360;\n    return `conic-gradient(var(--text-secondary) 0deg, var(--text-secondary) ${deg}deg, var(--text) ${deg}deg)`;\n  });\n  return web.createComponent(IconButton, {\n    get tip() {\n      return helper.t('button.auto_scroll');\n    },\n    get enabled() {\n      return store.autoScroll.play;\n    },\n    get style() {\n      return {\n        background: background()\n      };\n    },\n    onClick: switchAutoScroll,\n    get children() {\n      return web.memo(() => !!store.autoScroll.play)() ? web.createComponent(MdStop, {}) : web.createComponent(MdPlayArrow, {});\n    }\n  });\n};\n\nconst MdFileDownload = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M16.59 9H15V4c0-.55-.45-1-1-1h-4c-.55 0-1 .45-1 1v5H7.41c-.89 0-1.34 1.08-.71 1.71l4.59 4.59c.39.39 1.02.39 1.41 0l4.59-4.59c.63-.63.19-1.71-.7-1.71M5 19c0 .55.45 1 1 1h12c.55 0 1-.45 1-1s-.45-1-1-1H6c-.55 0-1 .45-1 1\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst getExtName = mime => /.+\\/([^;]+)/.exec(mime)?.[1] ?? 'jpg';\n\n/** 下载按钮 */\nconst DownloadButton = () => {\n  const {\n    store: state,\n    setState\n  } = helper.useStore({\n    length: 0,\n    /** undefined 表示未开始下载，等于 length 表示正在打包，-1 表示下载完成 */\n    completedNum: undefined,\n    errorNum: 0,\n    rawTitle: document.title,\n    showRawTitle: true\n  });\n  const progress = new helper.FaviconProgress();\n  const handleDownload = async () => {\n    const fileData = {};\n    setState({\n      errorNum: 0,\n      length: imgList().length\n    });\n    if (state.showRawTitle) setState('rawTitle', document.title);\n    const imgIndexNum = `${state.length}`.length;\n    for (let i = 0; i < state.length; i += 1) {\n      setState('completedNum', i);\n      const img = imgList()[i];\n      if (store.option.translation.onlyDownloadTranslated && img.translationType !== 'show') continue;\n      let url;\n      if (img.translationType === 'show') url = img.translationUrl;else if (img.upscaleUrl && isUpscale()) url = img.upscaleUrl;else url = img.src;\n      let data;\n      let fileName;\n      const index = `${i}`.padStart(imgIndexNum, '0');\n      try {\n        data = await downloadImg(url);\n        fileName = img.name || `${index}.${getExtName(data.type)}`;\n      } catch {\n        fileName = `${index} - ${helper.t('alert.download_failed')}`;\n        setState('errorNum', num => num + 1);\n      }\n      fileData[fileName] = new Uint8Array((await data?.arrayBuffer()) ?? []);\n    }\n    if (Object.keys(fileData).length === 0) {\n      Toast.toast.warn(helper.t('alert.no_img_download'));\n      setState('completedNum', undefined);\n      return;\n    }\n    setState('completedNum', state.length);\n    const zipped = fflate.zipSync(fileData, {\n      level: 0,\n      comment: location.href\n    });\n    helper.saveAs(new Blob([zipped]), `${store.title || state.rawTitle}.zip`);\n    setState('completedNum', -1);\n    Toast.toast(state.errorNum > 0 ? helper.t('button.download_completed_error', {\n      errorNum: state.errorNum\n    }) : helper.t('button.download_completed'), {\n      type: state.errorNum > 0 ? 'warn' : 'success',\n      onDismiss() {\n        document.title = state.rawTitle;\n        setState('showRawTitle', true);\n        progress.recover();\n      }\n    });\n  };\n  const tip = solidJs.createMemo(() => {\n    switch (state.completedNum) {\n      case undefined:\n        return helper.t('other.download');\n      case state.length:\n        return helper.t('button.packaging');\n      case -1:\n        return helper.t('button.download_completed');\n      default:\n        return `${helper.t('button.downloading')} - ${state.completedNum}/${state.length}`;\n    }\n  });\n\n  // 根据下载进度更新网页标题\n  helper.createEffectOn(() => state.completedNum, num => {\n    let showTip = '';\n    switch (num) {\n      case undefined:\n        return;\n      case state.length:\n        showTip = '📦';\n        break;\n      case -1:\n        showTip = state.errorNum > 0 ? `❗[${state.errorNum}]` : '✅';\n        break;\n      default:\n        showTip = `${num}/${state.length}`;\n    }\n    document.title = `${showTip} - ${state.rawTitle}`;\n    setState('showRawTitle', false);\n  }, {\n    defer: true\n  });\n\n  // 根据下载进度更新网页图标\n  helper.createEffectOn(() => state.completedNum, num => num && num > 0 && progress.update(num / state.length), {\n    defer: true\n  });\n  return web.createComponent(IconButton$1.IconButton, {\n    get tip() {\n      return tip();\n    },\n    onClick: handleDownload,\n    get enabled() {\n      return state.completedNum !== undefined;\n    },\n    get children() {\n      return web.createComponent(MdFileDownload, {});\n    }\n  });\n};\n\nconst MdOutlineFormatTextdirectionLToR = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M9 10v4c0 .55.45 1 1 1s1-.45 1-1V4h2v10c0 .55.45 1 1 1s1-.45 1-1V4h1c.55 0 1-.45 1-1s-.45-1-1-1H9.17C7.08 2 5.22 3.53 5.02 5.61A4 4 0 0 0 9 10m11.65 7.65-2.79-2.79a.501.501 0 0 0-.86.35V17H6c-.55 0-1 .45-1 1s.45 1 1 1h11v1.79c0 .45.54.67.85.35l2.79-2.79c.2-.19.2-.51.01-.7\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdOutlineFormatTextdirectionRToL = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M10 10v4c0 .55.45 1 1 1s1-.45 1-1V4h2v10c0 .55.45 1 1 1s1-.45 1-1V4h1c.55 0 1-.45 1-1s-.45-1-1-1h-6.83C8.08 2 6.22 3.53 6.02 5.61A4 4 0 0 0 10 10m-2 7v-1.79c0-.45-.54-.67-.85-.35l-2.79 2.79c-.2.2-.2.51 0 .71l2.79 2.79a.5.5 0 0 0 .85-.36V19h11c.55 0 1-.45 1-1s-.45-1-1-1z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdAdd = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M18 13h-5v5c0 .55-.45 1-1 1s-1-.45-1-1v-5H6c-.55 0-1-.45-1-1s.45-1 1-1h5V6c0-.55.45-1 1-1s1 .45 1 1v5h5c.55 0 1 .45 1 1s-.45 1-1 1\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdRefresh = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M17.65 6.35a7.95 7.95 0 0 0-6.48-2.31c-3.67.37-6.69 3.35-7.1 7.02C3.52 15.91 7.27 20 12 20a7.98 7.98 0 0 0 7.21-4.56c.32-.67-.16-1.44-.9-1.44-.37 0-.72.2-.88.53a5.994 5.994 0 0 1-6.8 3.31c-2.22-.49-4.01-2.3-4.48-4.52A6.002 6.002 0 0 1 12 6c1.66 0 3.14.69 4.22 1.78l-1.51 1.51c-.63.63-.19 1.71.7 1.71H19c.55 0 1-.45 1-1V6.41c0-.89-1.08-1.34-1.71-.71z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst setHotkeys = (...args) => {\n  setState(...['hotkeys', ...args]);\n  store.prop.onHotkeysChange?.(Object.fromEntries(Object.entries(store.hotkeys).filter(([name, keys]) => !helper.isEqual(keys.filter(Boolean), defaultHotkeys()[name]))));\n};\nconst delHotkeys = code => {\n  for (const [name, keys] of Object.entries(store.hotkeys)) {\n    const i = keys.indexOf(code);\n    if (i === -1) continue;\n    const newKeys = [...store.hotkeys[name]];\n    newKeys.splice(i, 1);\n    setHotkeys(name, newKeys);\n  }\n};\nconst getHotkeyName = code => helper.t(`hotkeys.${code}`) || helper.t(`button.${code}`) || helper.t(`setting.translation.${code}`) || helper.t(`other.${code}`) || code;\nconst KeyItem = props => {\n  const code = () => store.hotkeys[props.operateName][props.i];\n  const del = () => delHotkeys(code());\n  const handleKeyDown = e => {\n    e.stopPropagation();\n    e.preventDefault();\n    switch (e.key) {\n      case 'Tab':\n      case 'Enter':\n      case 'Escape':\n        focus();\n        return;\n      case 'Backspace':\n        setHotkeys(props.operateName, props.i, '');\n        return;\n    }\n    const newCode = helper.getKeyboardCode(e);\n    if (Reflect.has(hotkeysMap(), newCode)) Toast.toast.error(helper.t('hotkeys.repeat_tip', {\n      hotkey: getHotkeyName(hotkeysMap()[newCode])\n    }));else setHotkeys(props.operateName, props.i, newCode);\n  };\n  return (() => {\n    var _el$ = web.template(`<div tabindex=0>`)();\n    _el$.addEventListener(\"blur\", () => code() || del());\n    web.use(ref => code() || setTimeout(() => ref.focus()), _el$);\n    web.addEventListener(_el$, \"keydown\", handleKeyDown);\n    web.insert(_el$, () => helper.keyboardCodeToText(code()), null);\n    web.insert(_el$, web.createComponent(MdClose, {\n      \"on:click\": del\n    }), null);\n    web.effect(() => web.className(_el$, modules_c21c94f2$1.hotkeysItem));\n    return _el$;\n  })();\n};\nconst SettingHotkeys = props => web.createComponent(solidJs.For, {\n  get each() {\n    return props.keys;\n  },\n  children: name => (() => {\n    var _el$2 = web.template(`<div><div><p></p><span style=flex-grow:1></span><div></div><div>`)(),\n      _el$3 = _el$2.firstChild,\n      _el$4 = _el$3.firstChild,\n      _el$5 = _el$4.nextSibling,\n      _el$6 = _el$5.nextSibling,\n      _el$7 = _el$6.nextSibling;\n    web.insert(_el$4, () => getHotkeyName(name));\n    web.addEventListener(_el$6, \"click\", () => setHotkeys(name, store.hotkeys[name].length, ''));\n    web.insert(_el$6, web.createComponent(MdAdd, {}));\n    web.addEventListener(_el$7, \"click\", () => {\n      const newKeys = defaultHotkeys()[name] ?? [];\n      for (const code of defaultHotkeys()[name]) delHotkeys(code);\n      setHotkeys(name, newKeys);\n    });\n    web.insert(_el$7, web.createComponent(MdRefresh, {}));\n    web.insert(_el$2, web.createComponent(solidJs.Index, {\n      get each() {\n        return store.hotkeys[name];\n      },\n      children: (_, i) => web.createComponent(KeyItem, {\n        operateName: name,\n        i: i\n      })\n    }), null);\n    web.effect(_p$ => {\n      var _v$ = modules_c21c94f2$1.hotkeys,\n        _v$2 = modules_c21c94f2$1.hotkeysHeader,\n        _v$3 = helper.t('setting.hotkeys.add'),\n        _v$4 = helper.t('setting.hotkeys.restore');\n      _v$ !== _p$.e && web.className(_el$2, _p$.e = _v$);\n      _v$2 !== _p$.t && web.className(_el$3, _p$.t = _v$2);\n      _v$3 !== _p$.a && web.setAttribute(_el$6, \"title\", _p$.a = _v$3);\n      _v$4 !== _p$.o && web.setAttribute(_el$7, \"title\", _p$.o = _v$4);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined,\n      a: undefined,\n      o: undefined\n    });\n    return _el$2;\n  })()\n});\nconst OtherHotkeys = props => {\n  let ref; // oxlint-disable-line no-unassigned-vars\n\n  const handleChange = e => {\n    const name = e.target.value;\n    setHotkeys(name, store.hotkeys[name].length, '');\n    ref.value = '';\n  };\n  return (() => {\n    var _el$8 = web.template(`<div><select><option value disabled hidden selected> …`)(),\n      _el$9 = _el$8.firstChild,\n      _el$0 = _el$9.firstChild,\n      _el$1 = _el$0.firstChild;\n    _el$9.addEventListener(\"change\", handleChange);\n    var _ref$ = ref;\n    typeof _ref$ === \"function\" ? web.use(_ref$, _el$9) : ref = _el$9;\n    web.setStyleProperty(_el$9, \"height\", \"100%\");\n    web.insert(_el$0, () => helper.t('other.other'), _el$1);\n    web.insert(_el$9, web.createComponent(solidJs.For, {\n      get each() {\n        return props.keys;\n      },\n      children: name => (() => {\n        var _el$10 = web.template(`<option>`)();\n        _el$10.value = name;\n        web.insert(_el$10, () => getHotkeyName(name));\n        return _el$10;\n      })()\n    }), null);\n    web.effect(_p$ => {\n      var _v$5 = modules_c21c94f2$1.hotkeys,\n        _v$6 = modules_c21c94f2$1.hotkeysHeader;\n      _v$5 !== _p$.e && web.className(_el$8, _p$.e = _v$5);\n      _v$6 !== _p$.t && web.className(_el$9, _p$.t = _v$6);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined\n    });\n    return _el$8;\n  })();\n};\nconst SettingHotkeysBlock = () => {\n  const hotkeys = helper.createRootMemo(() => {\n    const show = [];\n    const other = [];\n    for (const [name, keys] of Object.entries(store.hotkeys)) (keys.length > 0 ? show : other).push(name);\n    return {\n      show,\n      other\n    };\n  });\n  return [web.createComponent(SettingHotkeys, {\n    get keys() {\n      return hotkeys().show;\n    }\n  }), web.createComponent(solidJs.Show, {\n    get when() {\n      return hotkeys().other.length;\n    },\n    get children() {\n      return web.createComponent(OtherHotkeys, {\n        get keys() {\n          return hotkeys().other;\n        }\n      });\n    }\n  })];\n};\n\n/** 设置菜单项 */\nconst SettingsItem = props => (() => {\n  var _el$ = web.template(`<div><div> <!> `)(),\n    _el$2 = _el$.firstChild,\n    _el$3 = _el$2.firstChild,\n    _el$5 = _el$3.nextSibling;\n  web.insert(_el$2, () => props.name, _el$5);\n  web.insert(_el$, () => props.children, null);\n  web.effect(_p$ => {\n    var _v$ = props.class ? `${modules_c21c94f2$1.SettingsItem} ${props.class}` : modules_c21c94f2$1.SettingsItem,\n      _v$2 = {\n        [props.class ?? '']: Boolean(props.class?.length),\n        ...props.classList\n      },\n      _v$3 = props.style,\n      _v$4 = helper.boolDataVal(props.disabled),\n      _v$5 = modules_c21c94f2$1.SettingsItemName;\n    _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n    _p$.t = web.classList(_el$, _v$2, _p$.t);\n    _p$.a = web.style(_el$, _v$3, _p$.a);\n    _v$4 !== _p$.o && web.setAttribute(_el$, \"data-disabled\", _p$.o = _v$4);\n    _v$5 !== _p$.i && web.className(_el$2, _p$.i = _v$5);\n    return _p$;\n  }, {\n    e: undefined,\n    t: undefined,\n    a: undefined,\n    o: undefined,\n    i: undefined\n  });\n  return _el$;\n})();\n\n/** 按钮式菜单项 */\nconst SettingsItemButton = props => {\n  const [, others] = solidJs.splitProps(props, ['children', 'onClick']);\n  return web.createComponent(SettingsItem, web.mergeProps(others, {\n    get children() {\n      var _el$ = web.template(`<button type=button>`)();\n      web.addEventListener(_el$, \"click\", props.onClick);\n      web.insert(_el$, () => props.children);\n      web.effect(() => web.className(_el$, modules_c21c94f2$1.SettingsItemIconButton));\n      return _el$;\n    }\n  }));\n};\n\n/** 数值输入框 */\nconst NumberInput = props => {\n  const handleInput = e => {\n    const target = e.currentTarget;\n    if (props.maxLength === undefined || target.textContent.length <= props.maxLength) return;\n    target.textContent = target.textContent.slice(0, props.maxLength);\n    target.blur();\n  };\n  const handleKeyDown = e => {\n    switch (e.key) {\n      case 'ArrowUp':\n        return props.onChange((Number(e.target.textContent) * 1000 + (props.step ?? 1) * 1000) / 1000);\n      case 'ArrowDown':\n        return props.onChange((Number(e.target.textContent) * 1000 - (props.step ?? 1) * 1000) / 1000);\n      case 'Enter':\n        return e.target.blur();\n    }\n  };\n  return [(() => {\n    var _el$ = web.template(`<span contenteditable data-only-number>`)();\n    _el$.addEventListener(\"blur\", e => {\n      try {\n        props.onChange(Number(e.currentTarget.textContent) || 0);\n      } finally {\n        e.currentTarget.textContent = `${props.value}`;\n      }\n    });\n    web.addEventListener(_el$, \"keydown\", handleKeyDown);\n    web.addEventListener(_el$, \"input\", handleInput);\n    web.insert(_el$, () => `${props.value}`);\n    return _el$;\n  })(), web.createComponent(solidJs.Show, {\n    get when() {\n      return props.suffix;\n    },\n    get children() {\n      return props.suffix;\n    }\n  })];\n};\n\n\n/** 数值输入框菜单项 */\nconst SettingsItemNumber = props => web.createComponent(SettingsItem, {\n  get name() {\n    return props.name;\n  },\n  get [\"class\"]() {\n    return props.class;\n  },\n  get classList() {\n    return props.classList;\n  },\n  get children() {\n    var _el$ = web.template(`<div>`)();\n    web.insert(_el$, web.createComponent(NumberInput, props));\n    web.effect(_$p => web.setStyleProperty(_el$, \"margin-right\", props.suffix ? '.3em' : '.6em'));\n    return _el$;\n  }\n});\n\n/** 选择器式菜单项 */\nconst SettingsItemSelect = props => {\n  let ref; // oxlint-disable-line no-unassigned-vars\n\n  solidJs.createEffect(() => {\n    ref.value = props.options?.some(([val]) => val === props.value) ? props.value : '';\n  });\n  return web.createComponent(SettingsItem, {\n    get name() {\n      return props.name;\n    },\n    get [\"class\"]() {\n      return props.class;\n    },\n    get classList() {\n      return props.classList;\n    },\n    get children() {\n      var _el$ = web.template(`<select>`)();\n      web.addEventListener(_el$, \"click\", () => props.onClick?.());\n      _el$.addEventListener(\"change\", e => props.onChange(e.target.value));\n      var _ref$ = ref;\n      typeof _ref$ === \"function\" ? web.use(_ref$, _el$) : ref = _el$;\n      web.insert(_el$, web.createComponent(solidJs.For, {\n        get each() {\n          return props.options;\n        },\n        children: ([val, label]) => (() => {\n          var _el$2 = web.template(`<option>`)();\n          _el$2.value = val;\n          web.insert(_el$2, label ?? val);\n          return _el$2;\n        })()\n      }));\n      web.effect(() => web.className(_el$, modules_c21c94f2$1.SettingsItemSelect));\n      return _el$;\n    }\n  });\n};\n\n/** 开关式菜单项 */\nconst SettingsItemSwitch = props => {\n  const handleClick = () => props.onChange(!props.value);\n  return web.createComponent(SettingsItem, {\n    get name() {\n      return props.name;\n    },\n    get [\"class\"]() {\n      return props.class;\n    },\n    get classList() {\n      return props.classList;\n    },\n    get disabled() {\n      return props.disabled;\n    },\n    get children() {\n      var _el$ = web.template(`<button type=button><div>`)(),\n        _el$2 = _el$.firstChild;\n      web.addEventListener(_el$, \"click\", handleClick);\n      web.effect(_p$ => {\n        var _v$ = modules_c21c94f2$1.SettingsItemSwitch,\n          _v$2 = props.value,\n          _v$3 = modules_c21c94f2$1.SettingsItemSwitchRound;\n        _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n        _v$2 !== _p$.t && web.setAttribute(_el$, \"data-checked\", _p$.t = _v$2);\n        _v$3 !== _p$.a && web.className(_el$2, _p$.a = _v$3);\n        return _p$;\n      }, {\n        e: undefined,\n        t: undefined,\n        a: undefined\n      });\n      return _el$;\n    }\n  });\n};\n\n\n/** 带有动画过渡的切换显示设置项 */\nconst SettingsShowItem = props => (() => {\n  var _el$ = web.template(`<div><div>`)(),\n    _el$2 = _el$.firstChild;\n  web.insert(_el$2, () => props.children);\n  web.effect(_p$ => {\n    var _v$ = modules_c21c94f2$1.SettingsShowItem,\n      _v$2 = props.when ? '1fr' : '0fr',\n      _v$3 = modules_c21c94f2$1.SettingsShowItemBody;\n    _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n    _v$2 !== _p$.t && web.setStyleProperty(_el$, \"grid-template-rows\", _p$.t = _v$2);\n    _v$3 !== _p$.a && web.className(_el$2, _p$.a = _v$3);\n    return _p$;\n  }, {\n    e: undefined,\n    t: undefined,\n    a: undefined\n  });\n  return _el$;\n})();\n\n/** 范围输入框 */\nconst RangeInput = props => {\n  let ref; // oxlint-disable-line no-unassigned-vars\n\n  /** 在保持光标位置不变的情况下修改文本 */\n  const editText = text => {\n    const offset = ref.selectionStart;\n    ref.value = text;\n    if (offset) requestAnimationFrame(() => {\n      ref.selectionStart = offset;\n      ref.selectionEnd = offset;\n    });\n  };\n\n  /** 修改文本中的数字 */\n  const replaceTextNumer = (text, offset, fn) => {\n    const isNumber = num => /\\d/.test(text[num]);\n    let start = offset;\n    if (!isNumber(offset)) {\n      if (isNumber(start - 1)) start--;else if (isNumber(start + 1)) start++;else return text;\n    }\n    let end = start;\n    while (isNumber(start - 1)) start--;\n    while (isNumber(end + 1)) end++;\n    return text.slice(0, start) + fn(Number(text.slice(start, end + 1))) + text.slice(end + 1);\n  };\n  const handleKeyDown = e => {\n    switch (e.key) {\n      case 'ArrowUp':\n      case 'ArrowDown':\n        editText(replaceTextNumer(ref.value, ref.selectionStart, num => e.key === 'ArrowUp' ? num + 1 : num - 1));\n    }\n  };\n  return (() => {\n    var _el$ = web.template(`<textarea autocomplete=off rows=2>`)();\n    _el$.addEventListener(\"blur\", () => {\n      try {\n        props.onChange?.(ref.value);\n      } finally {\n        ref.value = props.value;\n      }\n    });\n    web.addEventListener(_el$, \"keydown\", handleKeyDown);\n    var _ref$ = ref;\n    typeof _ref$ === \"function\" ? web.use(_ref$, _el$) : ref = _el$;\n    web.effect(_p$ => {\n      var _v$ = props.style,\n        _v$2 = props.placeholder;\n      _p$.e = web.style(_el$, _v$, _p$.e);\n      _v$2 !== _p$.t && web.setAttribute(_el$, \"placeholder\", _p$.t = _v$2);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined\n    });\n    web.effect(() => _el$.value = props.value);\n    return _el$;\n  })();\n};\n\nconst bindOption = (...args) => bindOption$1('translation', ...args);\nconst [rangeText, setRangeText] = solidJs.createSignal('');\n// 实时更新翻译范围\nhelper.createEffectOn(translationImgs, imgs => setRangeText(helper.descRange(imgs, store.imgList.length)));\nconst TranslateRange = () => {\n  helper.createEffectOn(rangeText, () => {\n    const imgImgs = helper.extractRange(rangeText(), store.imgList.length);\n    const openImgs = [...imgImgs].filter(i => {\n      // 过滤掉翻译完成和等待翻译的图片，避免因为范围变化而重新发起翻译\n      switch (imgList()[i].translationType) {\n        case 'show':\n        case 'wait':\n          return false;\n        default:\n          return true;\n      }\n    });\n    if (openImgs.length > 0) setImgTranslationEnbale(openImgs, true);\n    const closeImgs = new Set();\n    for (let i = 0; i < store.imgList.length; i++) if (!imgImgs.has(i)) closeImgs.add(i);\n    if (closeImgs.size > 0) setImgTranslationEnbale(closeImgs, false);\n    setRangeText(helper.descRange(imgImgs, store.imgList.length));\n  });\n  return [web.createComponent(SettingsItem, {\n    get name() {\n      return helper.t('setting.translation.range');\n    }\n  }), web.createComponent(RangeInput, {\n    get [\"class\"]() {\n      return modules_c21c94f2$1.SettingsItem;\n    },\n    get placeholder() {\n      return helper.t('other.page_range');\n    },\n    get value() {\n      return rangeText();\n    },\n    onChange: setRangeText\n  })];\n};\nconst SettingTranslation = () => [web.createComponent(SettingsItemSelect, web.mergeProps({\n  get name() {\n    return helper.t('setting.translation.server');\n  },\n  get options() {\n    return [['disable', helper.t('other.disable')], ['selfhosted', helper.t('setting.translation.server_selfhosted')], ['cotrans']];\n  }\n}, () => bindOption('server'))), web.createComponent(solidJs.Show, {\n  get when() {\n    return store.option.translation.server === 'cotrans';\n  },\n  get children() {\n    var _el$ = web.template(`<blockquote>`)();\n    web.effect(() => _el$.innerHTML = helper.t('setting.translation.cotrans_tip'));\n    return _el$;\n  }\n}), web.createComponent(solidJs.Show, {\n  get when() {\n    return store.option.translation.server === 'selfhosted';\n  },\n  get children() {\n    return [web.createComponent(SettingsItemSwitch, {\n      get name() {\n        return helper.t('setting.translation.translate_all');\n      },\n      get value() {\n        return isTranslatingAll();\n      },\n      onChange: translateAll\n    }), web.createComponent(SettingsItemSwitch, {\n      get name() {\n        return helper.t('setting.translation.translate_to_end');\n      },\n      get value() {\n        return isTranslatingToEnd();\n      },\n      onChange: translateToEnd\n    }), web.createComponent(TranslateRange, {}), (() => {\n      var _el$2 = web.template(`<hr>`)();\n      web.setStyleProperty(_el$2, \"margin\", \"1em 0\");\n      return _el$2;\n    })()];\n  }\n}), web.createComponent(solidJs.Show, {\n  get when() {\n    return store.option.translation.server !== 'disable';\n  },\n  get children() {\n    return [web.createComponent(SettingsItemSelect, web.mergeProps({\n      get name() {\n        return helper.t('setting.translation.options.target_language');\n      },\n      options: [['CHS', '简体中文'], ['CHT', '繁體中文'], ['JPN', '日本語'], ['ENG', 'English'], ['KOR', '한국어'], ['VIN', 'Tiếng Việt'], ['CSY', 'čeština'], ['NLD', 'Nederlands'], ['FRA', 'français'], ['DEU', 'Deutsch'], ['HUN', 'magyar nyelv'], ['ITA', 'italiano'], ['PLK', 'polski'], ['PTB', 'português'], ['ROM', 'limba română'], ['RUS', 'русский язык'], ['ESP', 'español'], ['TRK', 'Türk dili'], ['IND', 'Indonesia']]\n    }, () => bindOption('options', 'translator', 'target_lang'))), web.createComponent(SettingsItemSelect, web.mergeProps({\n      get name() {\n        return helper.t('setting.translation.options.translator');\n      },\n      get options() {\n        return translatorOptions();\n      },\n      onClick: updateSelfhostedOptions\n    }, () => bindOption('options', 'translator', 'translator'))), web.createComponent(SettingsItemSelect, web.mergeProps({\n      get name() {\n        return helper.t('setting.translation.options.direction');\n      },\n      get options() {\n        return [['auto', helper.t('setting.translation.options.direction_auto')], ['horizontal', helper.t('setting.translation.options.direction_horizontal')], ['vertical', helper.t('setting.translation.options.direction_vertical')]];\n      }\n    }, () => bindOption('options', 'render', 'direction'))), web.createComponent(SettingsItemSelect, web.mergeProps({\n      get name() {\n        return helper.t('setting.translation.options.detection_resolution');\n      },\n      options: [['1024', '1024px'], ['1536', '1536px'], ['2048', '2048px'], ['2560', '2560px']]\n    }, () => bindOption('options', 'detector', 'detection_size'))), web.createComponent(SettingsItemSelect, web.mergeProps({\n      get name() {\n        return helper.t('setting.translation.options.text_detector');\n      },\n      options: [['default'], ['ctd', 'Comic Text Detector']]\n    }, () => bindOption('options', 'detector', 'detector'))), web.createComponent(solidJs.Show, {\n      get when() {\n        return store.option.translation.server === 'selfhosted';\n      },\n      get children() {\n        return [web.createComponent(SettingsItemSelect, web.mergeProps({\n          get name() {\n            return helper.t('setting.translation.options.inpainting_size');\n          },\n          options: [['516', '516px'], ['1024', '1024px'], ['2048', '2048px'], ['2560', '2560px']]\n        }, () => bindOption('options', 'inpainter', 'inpainting_size'))), web.createComponent(SettingsItemSelect, web.mergeProps({\n          get name() {\n            return helper.t('setting.translation.options.inpainter');\n          },\n          options: [['default', 'Default'], ['lama_large', 'Lama Large'], ['lama_mpe', 'Lama MPE'], ['sd', 'SD'], ['none', 'None'], ['original', 'Original']]\n        }, () => bindOption('options', 'inpainter', 'inpainter'))), web.createComponent(SettingsItemNumber, web.mergeProps({\n          get name() {\n            return helper.t('setting.translation.options.unclip_ratio');\n          },\n          step: 0.01\n        }, () => bindOption('options', 'detector', 'unclip_ratio'))), web.createComponent(SettingsItemNumber, web.mergeProps({\n          get name() {\n            return helper.t('setting.translation.options.box_threshold');\n          },\n          step: 0.01\n        }, () => bindOption('options', 'detector', 'box_threshold'))), web.createComponent(SettingsItemNumber, web.mergeProps({\n          get name() {\n            return helper.t('setting.translation.options.mask_dilation_offset');\n          }\n        }, () => bindOption('options', 'mask_dilation_offset')))];\n      }\n    })];\n  }\n}), web.createComponent(solidJs.Show, {\n  get when() {\n    return store.option.translation.server !== 'disable';\n  },\n  get children() {\n    return [(() => {\n      var _el$3 = web.template(`<hr>`)();\n      web.setStyleProperty(_el$3, \"margin\", \"1em 0\");\n      return _el$3;\n    })(), web.createComponent(SettingsItemSwitch, web.mergeProps({\n      get name() {\n        return helper.t('setting.translation.options.force_retry');\n      }\n    }, () => bindOption('forceRetry'))), web.createComponent(SettingsItemSwitch, web.mergeProps({\n      get name() {\n        return helper.t('setting.translation.options.only_download_translated');\n      }\n    }, () => bindOption('onlyDownloadTranslated'))), web.createComponent(solidJs.Show, {\n      get when() {\n        return store.option.translation.server === 'selfhosted';\n      },\n      get children() {\n        return [web.createComponent(SettingsItemSwitch, {\n          get name() {\n            return helper.t('setting.translation.options.local_url');\n          },\n          get value() {\n            return store.option.translation.localUrl !== undefined;\n          },\n          onChange: val => {\n            setOption(draftOption => {\n              draftOption.translation.localUrl = val ? '' : undefined;\n            });\n          }\n        }), web.createComponent(solidJs.Show, {\n          get when() {\n            return store.option.translation.localUrl !== undefined;\n          },\n          get children() {\n            var _el$4 = web.template(`<input type=url>`)();\n            _el$4.addEventListener(\"change\", e => {\n              setOption(draftOption => {\n                // 删掉末尾的斜杠\n                const url = e.target.value.replace(/\\/$/, '');\n                draftOption.translation.localUrl = url;\n              });\n            });\n            web.effect(() => _el$4.value = store.option.translation.localUrl);\n            return _el$4;\n          }\n        })];\n      }\n    })];\n  }\n})];\n\n/** 默认菜单项 */\nconst defaultSettingList = () => [[helper.t('setting.option.paragraph_dir'), () => web.createComponent(SettingsItemButton, {\n  get name() {\n    return web.memo(() => store.option.dir === 'rtl')() ? helper.t('setting.option.dir_rtl') : helper.t('setting.option.dir_ltr');\n  },\n  onClick: switchDir,\n  get children() {\n    return web.memo(() => store.option.dir === 'rtl')() ? web.createComponent(MdOutlineFormatTextdirectionRToL, {}) : web.createComponent(MdOutlineFormatTextdirectionLToR, {});\n  }\n}), {\n  initShow: true\n}], [helper.t('setting.option.paragraph_display'), () => [web.createComponent(solidJs.Show, {\n  get when() {\n    return !store.option.scrollMode.enabled;\n  },\n  get children() {\n    return [web.createComponent(SettingsItemSwitch, web.mergeProps({\n      get name() {\n        return helper.t('setting.option.disable_auto_enlarge');\n      }\n    }, () => bindOption$1('disableZoom'))), web.createComponent(SettingsItemNumber, {\n      get name() {\n        return helper.t('setting.option.zoom');\n      },\n      maxLength: 3,\n      suffix: \"%\",\n      step: 5,\n      onChange: val => Number.isNaN(val) || zoom(val),\n      get value() {\n        return Math.round(store.option.zoom.ratio);\n      }\n    })];\n  }\n}), web.createComponent(solidJs.Show, {\n  get when() {\n    return store.option.scrollMode.enabled;\n  },\n  get children() {\n    return [web.createComponent(SettingsItemSwitch, {\n      get name() {\n        return helper.t('setting.option.abreast_mode');\n      },\n      get value() {\n        return store.option.scrollMode.abreastMode;\n      },\n      onChange: val => {\n        const jump = saveScrollProgress();\n        setOption(draftOption => {\n          draftOption.scrollMode.abreastMode = val;\n          draftOption.scrollMode.doubleMode = false;\n        });\n        jump();\n      }\n    }), web.createComponent(solidJs.Show, {\n      get when() {\n        return store.option.scrollMode.abreastMode;\n      },\n      get children() {\n        return web.createComponent(SettingsItemNumber, {\n          get name() {\n            return helper.t('setting.option.abreast_duplicate');\n          },\n          maxLength: 3,\n          suffix: \"%\",\n          step: 5,\n          onChange: val => {\n            if (Number.isNaN(val)) return;\n            setOption(draftOption => {\n              const newVal = helper.clamp(0, val / 100, 0.95);\n              draftOption.scrollMode.abreastDuplicate = newVal;\n            });\n          },\n          get value() {\n            return Math.round(store.option.scrollMode.abreastDuplicate * 100);\n          }\n        });\n      }\n    }), web.createComponent(solidJs.Show, {\n      get when() {\n        return !store.option.scrollMode.abreastMode;\n      },\n      get children() {\n        return [web.createComponent(SettingsItemSelect, {\n          get name() {\n            return helper.t('setting.option.adjust_to_width');\n          },\n          get options() {\n            return [['disable', helper.t('other.disable')], ['full', helper.t('setting.option.full_width')], ['custom', helper.t('other.custom')]];\n          },\n          get value() {\n            return web.memo(() => typeof store.option.scrollMode.adjustToWidth === 'number')() ? 'custom' : store.option.scrollMode.adjustToWidth;\n          },\n          onChange: val => {\n            const jump = saveScrollProgress();\n            setOption((draftOption, state) => {\n              if (val === 'custom') draftOption.scrollMode.adjustToWidth = state.isMobile ? state.rootSize.width : 1280;else draftOption.scrollMode.adjustToWidth = val;\n            });\n            jump();\n          }\n        }), web.createComponent(solidJs.Show, {\n          get when() {\n            return isUseAutoScale();\n          },\n          get children() {\n            return web.createComponent(SettingsItemNumber, {\n              get name() {\n                return helper.t('setting.option.adjust_to_width');\n              },\n              maxLength: 6,\n              step: 100,\n              onChange: setAdjustToWidth,\n              get value() {\n                return store.option.scrollMode.adjustToWidth;\n              }\n            });\n          }\n        })];\n      }\n    }), web.createComponent(solidJs.Show, {\n      get when() {\n        return store.option.scrollMode.adjustToWidth === 'disable';\n      },\n      get children() {\n        return web.createComponent(SettingsItemNumber, {\n          get name() {\n            return helper.t('setting.option.scroll_mode_img_scale');\n          },\n          maxLength: 3,\n          suffix: \"%\",\n          step: 5,\n          onChange: val => setImgScale(val / 100),\n          get value() {\n            return Math.round(store.option.scrollMode.imgScale * 100);\n          }\n        });\n      }\n    }), web.createComponent(SettingsItemNumber, {\n      get name() {\n        return helper.t('setting.option.scroll_mode_img_spacing');\n      },\n      maxLength: 5,\n      onChange: val => {\n        if (Number.isNaN(val)) return;\n        const newVal = helper.clamp(0, val, Number.POSITIVE_INFINITY);\n        setOption(draftOption => {\n          draftOption.scrollMode.spacing = newVal;\n        });\n      },\n      get value() {\n        return Math.round(store.option.scrollMode.spacing);\n      }\n    })];\n  }\n})], {\n  initShow: true\n}], [helper.t('button.scroll_mode'), () => [web.createComponent(SettingsItemSwitch, web.mergeProps({\n  get name() {\n    return helper.t('setting.option.align_edge');\n  }\n}, () => bindOption$1('scrollMode', 'alignEdge'))), web.createComponent(SettingsItemSwitch, web.mergeProps({\n  get name() {\n    return helper.t('setting.option.scrollbar_easy_scroll');\n  }\n}, () => bindOption$1('scrollbar', 'easyScroll')))], {\n  initShow: () => isScrollMode(),\n  hidden: () => !isScrollMode()\n}], [helper.t('setting.option.paragraph_appearance'), () => [web.createComponent(SettingsItemSwitch, web.mergeProps({\n  get name() {\n    return helper.t('setting.option.dark_mode');\n  }\n}, () => bindOption$1('darkMode'))), web.createComponent(SettingsItemSwitch, web.mergeProps({\n  get name() {\n    return helper.t('setting.option.dark_mode_auto');\n  }\n}, () => bindOption$1('autoDarkMode'))), web.createComponent(SettingsItemSwitch, web.mergeProps({\n  get name() {\n    return helper.t('setting.option.show_comments');\n  }\n}, () => bindOption$1('showComment'))), web.createComponent(SettingsItemSwitch, web.mergeProps({\n  get name() {\n    return helper.t('setting.option.autoHiddenMouse');\n  }\n}, () => bindOption$1('autoHiddenMouse'))), web.createComponent(SettingsItem, {\n  get name() {\n    return helper.t('setting.option.background_color');\n  },\n  get children() {\n    var _el$ = web.template(`<input type=color style=margin-right:.4em>`)();\n    web.addEventListener(_el$, \"input\", helper.throttle(e => {\n      if (!e.target.value) return;\n      setOption(draftOption => {\n        // 在拉到纯黑或纯白时改回初始值\n        draftOption.customBackground = e.target.value === '#000000' || e.target.value === '#ffffff' ? undefined : e.target.value;\n        if (draftOption.customBackground) draftOption.darkMode = helper.needDarkMode(draftOption.customBackground);\n      });\n    }, 20));\n    web.setStyleProperty(_el$, \"width\", \"2em\");\n    web.effect(() => _el$.value = store.option.customBackground ?? (store.option.darkMode ? '#000000' : '#ffffff'));\n    return _el$;\n  }\n}), web.createComponent(SettingsItemSelect, {\n  get name() {\n    return helper.t('setting.language');\n  },\n  options: [['zh', '中文'], ['en', 'English'], ['ru', 'Русский']],\n  get value() {\n    return helper.lang();\n  },\n  onChange: helper.setLang\n})]], [helper.t('setting.option.paragraph_scrollbar'), () => [web.createComponent(SettingsItemSelect, web.mergeProps({\n  get name() {\n    return helper.t('setting.option.scrollbar_position');\n  },\n  get options() {\n    return [['auto', helper.t('other.auto')], ['right', helper.t('setting.option.scrollbar_position_right')], ['top', helper.t('setting.option.scrollbar_position_top')], ['bottom', helper.t('setting.option.scrollbar_position_bottom')], ['hidden', helper.t('setting.option.scrollbar_position_hidden')]];\n  }\n}, () => bindOption$1('scrollbar', 'position'))), web.createComponent(SettingsShowItem, {\n  get when() {\n    return store.option.scrollbar.position !== 'hidden';\n  },\n  get children() {\n    return [web.createComponent(solidJs.Show, {\n      get when() {\n        return !store.isMobile;\n      },\n      get children() {\n        return web.createComponent(SettingsItemSwitch, web.mergeProps({\n          get name() {\n            return helper.t('setting.option.scrollbar_auto_hidden');\n          }\n        }, () => bindOption$1('scrollbar', 'autoHidden')));\n      }\n    }), web.createComponent(SettingsItemSwitch, web.mergeProps({\n      get name() {\n        return helper.t('setting.option.scrollbar_show_img_status');\n      }\n    }, () => bindOption$1('scrollbar', 'showImgStatus')))];\n  }\n})]], [helper.t('setting.option.click_page_turn_enabled'), () => [web.createComponent(SettingsItemSwitch, web.mergeProps({\n  get name() {\n    return helper.t('other.enabled');\n  }\n}, () => bindOption$1('clickPageTurn', 'enabled'))), web.createComponent(SettingsItemSwitch, {\n  get name() {\n    return helper.t('setting.option.show_clickable_area');\n  },\n  get value() {\n    return store.show.touchArea;\n  },\n  onChange: () => setState('show', 'touchArea', !store.show.touchArea)\n}), web.createComponent(SettingsItemSwitch, web.mergeProps({\n  get name() {\n    return helper.t('setting.option.shrink_menu');\n  }\n}, () => bindOption$1('clickPageTurn', 'shrinkMenu'))), web.createComponent(SettingsShowItem, {\n  get when() {\n    return store.option.clickPageTurn.enabled;\n  },\n  get children() {\n    return [web.createComponent(SettingsItemSelect, web.mergeProps({\n      get name() {\n        return helper.t('setting.option.click_page_turn_area');\n      },\n      get options() {\n        return Object.keys(areaArrayMap).map(key => [key, helper.t(`touch_area.type.${key}`)]);\n      }\n    }, () => bindOption$1('clickPageTurn', 'area'))), web.createComponent(SettingsItemSwitch, web.mergeProps({\n      get name() {\n        return helper.t('setting.option.click_page_turn_swap_area');\n      }\n    }, () => bindOption$1('clickPageTurn', 'reverse')))];\n  }\n})]], [helper.t('button.auto_scroll'), () => [web.createComponent(SettingsItemSwitch, web.mergeProps({\n  get name() {\n    return helper.t('other.enabled');\n  }\n}, () => bindOption$1('autoScroll', 'enabled'))), web.createComponent(SettingsItemNumber, {\n  get name() {\n    return helper.t('other.interval');\n  },\n  maxLength: 3,\n  suffix: \"s\",\n  step: 1,\n  onChange: val => {\n    if (!Number.isNaN(val)) setState('option', 'autoScroll', 'interval', val * 1000);\n  },\n  get value() {\n    return store.option.autoScroll.interval / 1000;\n  }\n}), web.createComponent(SettingsItemNumber, {\n  get name() {\n    return helper.t('other.distance');\n  },\n  maxLength: 3,\n  suffix: \"px\",\n  step: 20,\n  onChange: val => {\n    if (!Number.isNaN(val)) setState('option', 'autoScroll', 'distance', val);\n  },\n  get value() {\n    return store.option.autoScroll.distance;\n  }\n}), web.createComponent(SettingsItemSwitch, web.mergeProps({\n  get name() {\n    return helper.t('setting.option.auto_scroll_trigger_end');\n  }\n}, () => bindOption$1('autoScroll', 'triggerEnd')))]], [helper.t('setting.option.img_recognition'), () => [web.createComponent(SettingsItemSwitch, {\n  get name() {\n    return helper.t('other.enabled');\n  },\n  get value() {\n    return store.option.imgRecognition.enabled;\n  },\n  onChange: () => switchImgRecognition('enabled')\n}), web.createComponent(solidJs.Show, {\n  when: typeof Worker === 'undefined',\n  get children() {\n    var _el$2 = web.template(`<blockquote><p>`)(),\n      _el$3 = _el$2.firstChild;\n    web.effect(() => _el$3.innerHTML = helper.t('setting.option.img_recognition_warn'));\n    return _el$2;\n  }\n}), web.createComponent(solidJs.Show, {\n  get when() {\n    return !store.supportWorker;\n  },\n  get children() {\n    var _el$4 = web.template(`<blockquote><p>`)(),\n      _el$5 = _el$4.firstChild;\n    web.effect(() => _el$5.innerHTML = helper.t('setting.option.img_recognition_warn_2'));\n    return _el$4;\n  }\n}), web.createComponent(SettingsItemSwitch, {\n  get name() {\n    return helper.t('setting.option.img_recognition_background');\n  },\n  get disabled() {\n    return !store.option.imgRecognition.enabled;\n  },\n  get value() {\n    return store.option.imgRecognition.background;\n  },\n  onChange: () => switchImgRecognition('background')\n}), web.createComponent(SettingsItemSwitch, {\n  get name() {\n    return helper.t('setting.option.img_recognition_pageFill');\n  },\n  get disabled() {\n    return !store.option.imgRecognition.enabled;\n  },\n  get value() {\n    return store.option.imgRecognition.pageFill;\n  },\n  onChange: () => switchImgRecognition('pageFill')\n}), web.createComponent(solidJs.Show, {\n  get when() {\n    return !store.isMobile;\n  },\n  get children() {\n    return web.createComponent(SettingsItemSwitch, {\n      get name() {\n        return helper.t('upscale.title');\n      },\n      get disabled() {\n        return !store.option.imgRecognition.enabled || !store.supportUpscaleImage;\n      },\n      get value() {\n        return store.option.imgRecognition.upscale;\n      },\n      onChange: () => switchImgRecognition('upscale')\n    });\n  }\n})]], [helper.t('setting.option.paragraph_translation'), SettingTranslation, {\n  initShow: () => store.option.translation.server !== 'disable'\n}], [helper.t('other.hotkeys'), SettingHotkeysBlock], [helper.t('other.other'), () => [web.createComponent(SettingsItemSwitch, web.mergeProps({\n  get name() {\n    return helper.t('setting.option.first_page_fill');\n  }\n}, () => bindOption$1('firstPageFill'))), web.createComponent(SettingsItemSwitch, {\n  get name() {\n    return helper.t('setting.option.auto_switch_page_mode');\n  },\n  get value() {\n    return store.option.autoSwitchPageMode;\n  },\n  onChange: val => {\n    setOption((draftOption, state) => {\n      draftOption.autoSwitchPageMode = val;\n      state.option.pageNum = val ? 0 : autoPageNum();\n    });\n  }\n}), web.createComponent(SettingsItemSwitch, web.mergeProps({\n  get name() {\n    return helper.t('setting.option.swap_page_turn_key');\n  }\n}, () => bindOption$1('swapPageTurnKey'))), web.createComponent(SettingsItemSwitch, web.mergeProps({\n  get name() {\n    return helper.t('setting.option.autoFullscreen');\n  }\n}, () => bindOption$1('autoFullscreen'))), web.createComponent(SettingsItemSelect, web.mergeProps({\n  get name() {\n    return helper.t('setting.option.scroll_end');\n  },\n  get options() {\n    return [['none', helper.t('other.none')], ['exit', helper.t('other.exit')], ['auto', helper.t('setting.option.scroll_end_auto')]];\n  }\n}, () => bindOption$1('scroolEnd'))), web.createComponent(SettingsItemSwitch, web.mergeProps({\n  get name() {\n    return helper.t('setting.option.always_load_all_img');\n  }\n}, () => bindOption$1('alwaysLoadAllImg'))), web.createComponent(SettingsItemNumber, {\n  get name() {\n    return helper.t('setting.option.preload_page_num');\n  },\n  maxLength: 5,\n  onChange: val => {\n    if (Number.isNaN(val)) return;\n    setOption(draftOption => {\n      draftOption.preloadPageNum = helper.clamp(0, val, 99_999);\n    });\n  },\n  get value() {\n    return store.option.preloadPageNum;\n  }\n})]]];\n\nconst SettingBlockSubtitle = props => (() => {\n  var _el$ = web.template(`<div>`)();\n  web.addEventListener(_el$, \"click\", props.onClick);\n  web.insert(_el$, () => props.children);\n  web.effect(() => web.className(_el$, modules_c21c94f2$1.SettingBlockSubtitle));\n  return _el$;\n})();\n\n/** 菜单面板 */\nconst SettingPanel = () => (() => {\n  var _el$2 = web.template(`<div>`)();\n  web.addEventListener(_el$2, \"click\", stopPropagation);\n  web.addEventListener(_el$2, \"scroll\", stopPropagation);\n  _el$2.addEventListener(\"wheel\", e => refs.settingPanel.scrollHeight > refs.settingPanel.clientHeight && e.stopPropagation());\n  var _ref$ = bindRef('settingPanel');\n  typeof _ref$ === \"function\" && web.use(_ref$, _el$2);\n  web.insert(_el$2, web.createComponent(solidJs.For, {\n    get each() {\n      return store.prop.editSettingList(defaultSettingList());\n    },\n    children: ([name, SettingItem, options], i) => {\n      const initShow = options?.initShow;\n      const [show, setShwo] = solidJs.createSignal(Boolean(initShow));\n      if (typeof initShow === 'function') helper.createEffectOn(initShow, val => setShwo(Boolean(val)));\n      return web.createComponent(solidJs.Show, {\n        get when() {\n          return web.memo(() => !!options?.hidden)() ? !options.hidden() : true;\n        },\n        get children() {\n          return [web.memo(() => web.memo(() => !!i())() ? web.template(`<hr>`)() : null), (() => {\n            var _el$3 = web.template(`<div><div>`)(),\n              _el$4 = _el$3.firstChild;\n            web.insert(_el$3, web.createComponent(SettingBlockSubtitle, {\n              onClick: () => setShwo(prev => !prev),\n              get children() {\n                return [name, web.memo(() => show() ? null : '…')];\n              }\n            }), _el$4);\n            web.insert(_el$4, web.createComponent(SettingItem, {}));\n            web.effect(_p$ => {\n              var _v$3 = modules_c21c94f2$1.SettingBlock,\n                _v$4 = show(),\n                _v$5 = modules_c21c94f2$1.SettingBlockBody;\n              _v$3 !== _p$.e && web.className(_el$3, _p$.e = _v$3);\n              _v$4 !== _p$.t && web.setAttribute(_el$3, \"data-show\", _p$.t = _v$4);\n              _v$5 !== _p$.a && web.className(_el$4, _p$.a = _v$5);\n              return _p$;\n            }, {\n              e: undefined,\n              t: undefined,\n              a: undefined\n            });\n            return _el$3;\n          })()];\n        }\n      });\n    }\n  }));\n  web.effect(_p$ => {\n    var _v$ = `${modules_c21c94f2$1.SettingPanel} ${modules_c21c94f2$1.beautifyScrollbar}`,\n      _v$2 = helper.lang() === 'zh' ? '15em' : '20em';\n    _v$ !== _p$.e && web.className(_el$2, _p$.e = _v$);\n    _v$2 !== _p$.t && web.setStyleProperty(_el$2, \"width\", _p$.t = _v$2);\n    return _p$;\n  }, {\n    e: undefined,\n    t: undefined\n  });\n  return _el$2;\n})();\n\nconst ZoomButton = () => web.createComponent(IconButton, {\n  get tip() {\n    return web.memo(() => store.option.zoom.ratio === 100)() ? helper.t('button.zoom_in') : helper.t('button.zoom_out');\n  },\n  get enabled() {\n    return store.option.zoom.ratio !== 100;\n  },\n  onClick: () => doubleClickZoom(),\n  get children() {\n    return web.createComponent(solidJs.Show, {\n      get when() {\n        return store.option.zoom.ratio === 100;\n      },\n      get fallback() {\n        return web.createComponent(MdZoomOut, {});\n      },\n      get children() {\n        return web.createComponent(MdZoomIn, {});\n      }\n    });\n  }\n});\n\n/** 工具栏的默认按钮列表 */\nconst defaultButtonList = [\n// 单双页模式\n() => web.createComponent(IconButton, {\n  get tip() {\n    return web.memo(() => !!isOnePageMode())() ? helper.t('button.page_mode_single') : helper.t('button.page_mode_double');\n  },\n  get hidden() {\n    return store.isMobile;\n  },\n  onClick: switchOnePageMode,\n  get children() {\n    return web.memo(() => !!isOnePageMode())() ? web.createComponent(MdLooksOne, {}) : web.createComponent(MdLooksTwo, {});\n  }\n}),\n// 卷轴模式\n() => web.createComponent(IconButton, {\n  get tip() {\n    return helper.t('button.scroll_mode');\n  },\n  get enabled() {\n    return store.option.scrollMode.enabled;\n  },\n  onClick: switchScrollMode,\n  get children() {\n    return web.createComponent(MdViewDay, {});\n  }\n}),\n// 页面填充\n() => web.createComponent(IconButton, {\n  get tip() {\n    return helper.t('button.page_fill');\n  },\n  get enabled() {\n    return Boolean(store.fillEffect[nowFillIndex()]);\n  },\n  get hidden() {\n    return isOnePageMode();\n  },\n  onClick: switchFillEffect,\n  get children() {\n    return web.createComponent(MdQueue, {});\n  }\n}),\n// 网格模式\n() => web.createComponent(IconButton, {\n  get tip() {\n    return helper.t('button.grid_mode');\n  },\n  get enabled() {\n    return store.gridMode;\n  },\n  onClick: switchGridMode,\n  get children() {\n    return web.createComponent(MdGrid, {});\n  }\n}),\n// 翻译\n() => web.createComponent(solidJs.Show, {\n  get when() {\n    return store.option.translation.server !== 'disable';\n  },\n  get children() {\n    return [web.template(`<hr>`)(), web.createComponent(IconButton, {\n      get tip() {\n        return web.memo(() => !!isTranslatingImage())() ? helper.t('button.close_current_page_translation') : helper.t('button.translate_current_page');\n      },\n      get enabled() {\n        return isTranslatingImage();\n      },\n      onClick: translateCurrent,\n      get children() {\n        return web.createComponent(MdTranslate, {});\n      }\n    }), web.createComponent(IconButton, {\n      get tip() {\n        return helper.t('setting.translation.translate_to_end');\n      },\n      get enabled() {\n        return isTranslatingToEnd();\n      },\n      get hidden() {\n        return store.option.translation.server !== 'selfhosted';\n      },\n      onClick: translateToEnd,\n      get children() {\n        return web.createComponent(MdLowPriority, {});\n      }\n    })];\n  }\n}),\n// 自动滚动\n() => web.createComponent(solidJs.Show, {\n  get when() {\n    return store.option.autoScroll.enabled;\n  },\n  get children() {\n    return [web.template(`<hr>`)(), web.createComponent(AutoScrollButton, {})];\n  }\n}), () => web.template(`<hr>`)(),\n// 缩放\n() => [web.createComponent(solidJs.Show, {\n  get when() {\n    return !store.option.scrollMode.enabled;\n  },\n  get children() {\n    return web.createComponent(ZoomButton, {});\n  }\n}), web.createComponent(solidJs.Show, {\n  get when() {\n    return web.memo(() => !!store.option.scrollMode.enabled)() && store.option.scrollMode.adjustToWidth !== 'full';\n  },\n  get children() {\n    return [web.createComponent(IconButton, {\n      get tip() {\n        return helper.t('button.zoom_in');\n      },\n      get enabled() {\n        return store.option.scrollMode.imgScale >= 3;\n      },\n      onClick: () => handleScrollModeZoom('add'),\n      get children() {\n        return web.createComponent(MdZoomIn, {});\n      }\n    }), web.createComponent(IconButton, {\n      get tip() {\n        return helper.t('button.zoom_out');\n      },\n      get enabled() {\n        return store.option.scrollMode.imgScale <= 0.1;\n      },\n      onClick: () => handleScrollModeZoom('sub'),\n      get children() {\n        return web.createComponent(MdZoomOut, {});\n      }\n    })];\n  }\n})],\n// 全屏\n() => web.createComponent(IconButton, {\n  get tip() {\n    return web.memo(() => !!store.fullscreen)() ? helper.t('button.fullscreen_exit') : helper.t('button.fullscreen');\n  },\n  get hidden() {\n    return !refs.root.requestFullscreen;\n  },\n  onClick: switchFullscreen,\n  get children() {\n    return web.memo(() => !!store.fullscreen)() ? web.createComponent(MdFullscreenExit, {}) : web.createComponent(MdFullscreen, {});\n  }\n}), DownloadButton,\n// 设置\n() => {\n  const [showPanel, setShowPanel] = solidJs.createSignal(false);\n  const handleClick = () => {\n    const _showPanel = !showPanel();\n    setState('show', 'toolbar', _showPanel);\n    setShowPanel(_showPanel);\n  };\n  helper.createEffectOn(() => store.show.toolbar, showToolbar => showToolbar || setShowPanel(false));\n  const Popper = web.createComponent(solidJs.Show, {\n    get when() {\n      return showPanel();\n    },\n    get children() {\n      return [web.createComponent(SettingPanel, {}), (() => {\n        var _el$4 = web.template(`<div role=button tabindex=-1>`)();\n        _el$4.addEventListener(\"wheel\", e => {\n          if (isScrollMode()) refs.mangaBox.scrollBy({\n            top: e.deltaY\n          });\n        });\n        web.addEventListener(_el$4, \"click\", handleClick);\n        web.effect(() => web.className(_el$4, modules_c21c94f2$1.closeCover));\n        return _el$4;\n      })()];\n    }\n  });\n  return web.createComponent(IconButton, {\n    get tip() {\n      return helper.t('other.setting');\n    },\n    get enabled() {\n      return showPanel();\n    },\n    get showTip() {\n      return showPanel();\n    },\n    onClick: handleClick,\n    get popperClassName() {\n      return web.memo(() => !!showPanel())() && modules_c21c94f2$1.SettingPanelPopper;\n    },\n    get popper() {\n      return showPanel() && Popper;\n    },\n    get children() {\n      return web.createComponent(MdSettings, {});\n    }\n  });\n}, () => web.template(`<hr>`)(), () => web.createComponent(IconButton, {\n  get tip() {\n    return helper.t('other.exit');\n  },\n  onClick: () => store.prop.onExit?.(),\n  get children() {\n    return web.createComponent(MdClose, {});\n  }\n})];\n\n\n/** 左侧工具栏 */\nconst Toolbar = () => {\n  helper.createEffectOn(() => store.show.toolbar, show => show || focus());\n  return (() => {\n    var _el$ = web.template(`<div role=toolbar><div><div>`)(),\n      _el$2 = _el$.firstChild,\n      _el$3 = _el$2.firstChild;\n    web.addEventListener(_el$2, \"click\", focus);\n    web.insert(_el$2, web.createComponent(solidJs.For, {\n      get each() {\n        return store.prop.editButtonList(defaultButtonList);\n      },\n      children: ButtonItem => web.createComponent(ButtonItem, {})\n    }), null);\n    web.effect(_p$ => {\n      var _v$ = modules_c21c94f2$1.toolbar,\n        _v$2 = helper.boolDataVal(store.show.toolbar),\n        _v$3 = helper.boolDataVal(store.isMobile && store.gridMode),\n        _v$4 = store.isDragMode ? 'none' : undefined,\n        _v$5 = modules_c21c94f2$1.toolbarPanel,\n        _v$6 = modules_c21c94f2$1.toolbarBg;\n      _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n      _v$2 !== _p$.t && web.setAttribute(_el$, \"data-show\", _p$.t = _v$2);\n      _v$3 !== _p$.a && web.setAttribute(_el$, \"data-close\", _p$.a = _v$3);\n      _v$4 !== _p$.o && web.setStyleProperty(_el$, \"pointer-events\", _p$.o = _v$4);\n      _v$5 !== _p$.i && web.className(_el$2, _p$.i = _v$5);\n      _v$6 !== _p$.n && web.className(_el$3, _p$.n = _v$6);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined,\n      a: undefined,\n      o: undefined,\n      i: undefined,\n      n: undefined\n    });\n    return _el$;\n  })();\n};\n\n// TODO: 使用 light-dark()\n// https://developer.mozilla.org/docs/Web/CSS/color_value/light-dark\n/** 深色模式 */\nconst darkStyle = {\n  '--hover-bg-color': '#FFF3',\n  '--hover-bg-color-enable': '#FFFa',\n  '--switch': '#BDBDBD',\n  '--switch-bg': '#6E6E6E',\n  '--page-bg': '#303030',\n  '--secondary': '#7A909A',\n  '--secondary-bg': '#556065',\n  '--text': 'white',\n  '--text-secondary': '#FFFC',\n  '--text-bg': '#121212',\n  'color-scheme': 'dark'\n};\n\n/** 浅色模式 */\nconst lightStyle = {\n  '--hover-bg-color': '#0001',\n  '--hover-bg-color-enable': '#0009',\n  '--switch': '#FAFAFA',\n  '--switch-bg': '#9C9C9C',\n  '--page-bg': 'white',\n  '--secondary': '#7A909A',\n  '--secondary-bg': '#BAC5CA',\n  '--text': 'black',\n  '--text-secondary': '#0008',\n  '--text-bg': '#FAFAFA',\n  'color-scheme': 'light'\n};\nconst createSvgIcon = (fill, d) => `url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='${fill}' viewBox='0 0 24 24'%3E%3Cpath d='${d}'/%3E%3C/svg%3E\")`;\nconst MdImageNotSupported = `m21.9 21.9-8.49-8.49-9.82-9.82L2.1 2.1.69 3.51 3 5.83V19c0 1.1.9 2 2 2h13.17l2.31 2.31 1.42-1.41zM5 18l3.5-4.5 2.5 3.01L12.17 15l3 3H5zm16 .17L5.83 3H19c1.1 0 2 .9 2 2v13.17z`;\nconst MdCloudDownload = `M19.35 10.04A7.49 7.49 0 0 0 12 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 0 0 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-4.65 4.65c-.2.2-.51.2-.71 0L7 13h3V9h4v4h3z`;\nconst MdPhoto = `M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-4.86 8.86-3 3.87L9 13.14 6 17h12l-3.86-5.14z`;\nconst useCssVar = () => {\n  const svg = () => {\n    const fill = store.option.darkMode ? 'rgb(156,156,156)' : 'rgb(110,110,110)';\n    return {\n      '--md-image-not-supported': `${createSvgIcon(fill, MdImageNotSupported)}`,\n      '--md-cloud-download': `${createSvgIcon(fill, MdCloudDownload)}`,\n      '--md-photo': `${createSvgIcon(fill, MdPhoto)}`\n    };\n  };\n  const i18n = () => ({\n    '--i18n-touch-area-prev': `\"${helper.t('hotkeys.page_up')}\"`,\n    '--i18n-touch-area-next': `\"${helper.t('hotkeys.page_down')}\"`,\n    '--i18n-touch-area-menu': `\"${helper.t('touch_area.menu')}\"`\n  });\n  useStyleMemo(`.${modules_c21c94f2$1.root}`, [{\n    '--bg': () => `${store.option.customBackground ?? (store.option.darkMode ? '#000' : '#fff')}`,\n    '--scroll-mode-spacing': () => store.option.scrollMode.spacing\n  }, () => store.option.darkMode ? darkStyle : lightStyle, svg, i18n]);\n};\n\nconst useInit = props => {\n  watchDomSize('rootSize', refs.root);\n  const updateOption = state => {\n    state.defaultOption = helper.assign(defaultOption(), props.defaultOption ?? {});\n    state.option = helper.assign(state.defaultOption, props.option ?? {});\n  };\n  const bindProp = (key, defaultValue) => state => Reflect.set(state.prop, key, props[key] ?? defaultValue);\n  const bindDebounce = key => state => {\n    state.prop[key] = props[key] ? helper.debounce(props[key]) : undefined;\n  };\n  const watchProps = {\n    option: updateOption,\n    onLoading: bindDebounce('onLoading'),\n    onOptionChange: bindDebounce('onOptionChange'),\n    onHotkeysChange: bindDebounce('onHotkeysChange'),\n    onShowImgsChange: bindDebounce('onShowImgsChange'),\n    defaultOption(state) {\n      updateOption(state);\n    },\n    fillEffect(state) {\n      state.fillEffect = props.fillEffect ?? {\n        '-1': true\n      };\n      updatePageData(state);\n    },\n    onExit(state) {\n      state.prop.onExit = isEnd => {\n        playAnimation(refs.exit);\n        props.onExit?.(Boolean(isEnd));\n        setState(draftState => {\n          if (isEnd) draftState.activePageIndex = 0;\n          draftState.show.endPage = undefined;\n        });\n        if (document.fullscreenElement) document.exitFullscreen();\n      };\n    },\n    onPrev(state) {\n      state.prop.onPrev = props.onPrev ? helper.throttle(() => {\n        playAnimation(refs.prev);\n        props.onPrev?.();\n      }, 1000) : undefined;\n    },\n    onNext(state) {\n      state.prop.onNext = props.onNext ? helper.throttle(() => {\n        playAnimation(refs.next);\n        props.onNext?.();\n      }, 1000) : undefined;\n    },\n    onImgError: bindProp('onImgError'),\n    onWaitUrlImgs: bindProp('onWaitUrlImgs'),\n    editButtonList: bindProp('editButtonList', list => list),\n    editSettingList: bindProp('editSettingList', list => list),\n    commentList(state) {\n      state.commentList = props.commentList;\n    },\n    title(state) {\n      state.title = props.title ?? '';\n    }\n  };\n  for (const [key, fn] of Object.entries(watchProps)) {\n    solidJs.createEffect(solidJs.on(() => props[key], () => setState(fn)));\n  }\n  solidJs.createEffect(() => {\n    setState(state => {\n      state.hotkeys = {\n        ...structuredClone(defaultHotkeys()),\n        ...props.hotkeys\n      };\n    });\n  });\n  const handleImgList = () => {\n    setState(state => {\n      const newImgMap = {};\n      const newImgList = []; // 因为会有相同 url 的图片，所以不能用 Set\n      for (const img of store$1.unwrap(props.imgList)) {\n        // 使用相对协议路径，防止 Mixed Content 报错\n        const url = (typeof img === 'object' ? img.src : img)?.replace(/^http:/, '') ?? '';\n        newImgList.push(url);\n        if (Reflect.has(newImgMap, url)) continue;\n        if (Reflect.has(state.imgMap, url)) {\n          newImgMap[url] = state.imgMap[url];\n          continue;\n        }\n        const imgItem = typeof img === 'string' ? {\n          src: url\n        } : img;\n        imgItem.loadType ??= 'wait';\n        if (imgItem.width && imgItem.height) {\n          imgItem.size = getImgDisplaySize(state, imgItem);\n          imgItem.type = getImgType(imgItem);\n        }\n        imgItem.size ??= placeholderSize();\n        if (!imgItem.blobUrl && url.startsWith('blob:')) imgItem.blobUrl = imgItem.src;\n        newImgMap[url] = imgItem;\n      }\n\n      /** 修改前的当前显示图片 */\n      const oldActiveImg = state.pageList[state.activePageIndex]?.map(i => state.imgList?.[i]) ?? [];\n\n      /** 是否需要重置页面填充 */\n      let needResetFillEffect = false;\n      const fillEffectList = Object.keys(state.fillEffect).map(Number);\n      for (const pageIndex of fillEffectList) {\n        if (pageIndex === -1) continue;\n        if (state.imgList[pageIndex] === newImgList[pageIndex]) continue;\n        needResetFillEffect = true;\n        break;\n      }\n      const oldImgList = new Set(state.imgList);\n      if (oldImgList.size === 0 && newImgList.length > 0) {\n        resumeReadProgress(state);\n        updateSelfhostedOptions(true);\n      }\n\n      /** 被删除的图片 */\n      const deleteList = [...oldImgList].filter(url => !newImgList.includes(url));\n      for (const url of deleteList) if (state.imgMap[url].blobUrl && state.imgMap[url].blobUrl !== url) URL.revokeObjectURL(state.imgMap[url].blobUrl);\n\n      /** 删除图片数 */\n      const deleteNum = deleteList.length;\n\n      /** 传入的是否是新漫画 */\n      const isNew = deleteNum >= oldImgList.size * 0.8; // 删掉8成图就算是新漫画\n\n      /** 是否需要更新页面 */\n      const needUpdatePageData = needResetFillEffect || state.imgList.length !== newImgList.length || deleteNum > 0;\n      state.imgMap = newImgMap;\n      state.imgList = [...newImgList];\n      state.prop.onLoading?.(state.imgList.map(url => state.imgMap[url]));\n      if (isNew) state.show.endPage = undefined;\n      if (isNew || needResetFillEffect) state.fillEffect = props.fillEffect ?? {\n        '-1': true\n      };\n      if (isNew || needUpdatePageData) {\n        updatePageData(state);\n\n        // 当前位于最后一页时最后一页被删的处理\n        if (state.activePageIndex >= state.pageList.length) state.activePageIndex = state.pageList.length - 1;\n        updateShowRange(state);\n      }\n      if (isNew || state.pageList.length === 0) {\n        resetImgState(state);\n        state.activePageIndex = 0;\n        scrollTo(0);\n        return;\n      }\n\n      // 尽量使当前显示的图片在修改后依然不变\n      oldActiveImg.some(url => {\n        // 跳过填充页和已被删除的图片\n        if (!url || newImgList.includes(url)) return false;\n        const newPageIndex = state.pageList.findIndex(page => page.some(index => state.imgList?.[index] === url));\n        if (newPageIndex === -1) return false;\n        state.activePageIndex = newPageIndex;\n        return true;\n      });\n\n      // 如果已经翻到了最后一页，且最后一页的图片被删掉了，那就保持在末页显示\n      if (state.activePageIndex > state.pageList.length - 1) state.activePageIndex = state.pageList.length - 1;\n    });\n  };\n\n  // 处理 imgList 参数的初始化和修改\n  helper.createEffectOn(helper.createRootMemo(() => props.imgList), helper.throttle(handleImgList, 500));\n\n  // 通过手动创建一个 Worker 来检测是否支持 Worker，避免因为 CSP 限制而出错\n  setTimeout(() => {\n    const codeUrl = URL.createObjectURL(new Blob(['self.close();'], {\n      type: 'text/javascript'\n    }));\n    setTimeout(URL.revokeObjectURL, 0, codeUrl);\n    setState('supportWorker', Boolean(new Worker(codeUrl)));\n  }, 0);\n\n  // 更新 fullscreen 参数\n  refs.root.addEventListener('fullscreenchange', () => {\n    if (!document.fullscreenElement) return setState('fullscreen', false);\n    if (document.fullscreenElement.id === 'comicRead' || document.fullscreenElement.classList.contains(modules_c21c94f2$1.root)) setState('fullscreen', true);\n  });\n  for (const eventName of ['keypress', 'keyup', 'touchstart', 'touchmove', 'touchend']) refs.root.addEventListener(eventName, stopPropagation, {\n    capture: true\n  });\n  focus();\n};\n\nsolidJs.enableScheduling();\n/** 漫画组件 */\nconst Manga = props => {\n  useStyle(css$1);\n  useCssVar();\n  solidJs.onMount(() => useInit(props));\n  solidJs.createEffect(() => props.show && focus());\n  return (() => {\n    var _el$ = web.template(`<div>`)();\n    web.addEventListener(_el$, \"wheel\", handleWheel);\n    web.addEventListener(_el$, \"mousedown\", handleMouseDown);\n    web.addEventListener(_el$, \"click\", stopPropagation);\n    var _ref$ = bindRef('root');\n    typeof _ref$ === \"function\" && web.use(_ref$, _el$);\n    _el$.addEventListener(\"keydown\", handleKeyDown, true);\n    _el$.addEventListener(\"keyup\", handleKeyUp, true);\n    web.insert(_el$, web.createComponent(ComicImgFlow, {}), null);\n    web.insert(_el$, web.createComponent(TouchArea, {}), null);\n    web.insert(_el$, web.createComponent(Scrollbar, {}), null);\n    web.insert(_el$, web.createComponent(EndPage, {}), null);\n    web.insert(_el$, web.createComponent(Toolbar, {}), null);\n    web.effect(_p$ => {\n      var _v$ = modules_c21c94f2$1.root,\n        _v$2 = {\n          [modules_c21c94f2$1.hidden]: props.show === false,\n          [props.class ?? '']: Boolean(props.class),\n          ...props.classList\n        },\n        _v$3 = helper.boolDataVal(store.isMobile),\n        _v$4 = helper.boolDataVal(store.option.scrollMode.enabled),\n        _v$5 = helper.boolDataVal(store.gridMode);\n      _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n      _p$.t = web.classList(_el$, _v$2, _p$.t);\n      _v$3 !== _p$.a && web.setAttribute(_el$, \"data-mobile\", _p$.a = _v$3);\n      _v$4 !== _p$.o && web.setAttribute(_el$, \"data-scroll-mode\", _p$.o = _v$4);\n      _v$5 !== _p$.i && web.setAttribute(_el$, \"data-grid-mode\", _p$.i = _v$5);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined,\n      a: undefined,\n      o: undefined,\n      i: undefined\n    });\n    return _el$;\n  })();\n};\n\nexports.Manga = Manga;\nexports.SettingBlockSubtitle = SettingBlockSubtitle;\nexports.SettingHotkeys = SettingHotkeys;\nexports.SettingsItem = SettingsItem;\nexports.SettingsItemButton = SettingsItemButton;\nexports.SettingsItemNumber = SettingsItemNumber;\nexports.SettingsItemSwitch = SettingsItemSwitch;\nexports._setAbreastScrollFill = _setAbreastScrollFill;\nexports.abreastArea = abreastArea;\nexports.abreastColumnWidth = abreastColumnWidth;\nexports.abreastContentWidth = abreastContentWidth;\nexports.abreastScrollFill = abreastScrollFill;\nexports.abreastScrollWidth = abreastScrollWidth;\nexports.abreastShowColumn = abreastShowColumn;\nexports.activeImgIndex = activeImgIndex;\nexports.activePage = activePage;\nexports.autoPageNum = autoPageNum;\nexports.bindOption = bindOption$1;\nexports.bindRef = bindRef;\nexports.bindScrollTop = bindScrollTop;\nexports.bound = bound;\nexports.checkImgSize = checkImgSize;\nexports.constantScroll = constantScroll;\nexports.contentHeight = contentHeight;\nexports.defaultHotkeys = defaultHotkeys;\nexports.doubleClickZoom = doubleClickZoom;\nexports.downloadImg = downloadImg;\nexports.downloadImgHeaders = downloadImgHeaders;\nexports.findFillIndex = findFillIndex;\nexports.findTopPage = findTopPage;\nexports.focus = focus;\nexports.getImg = getImg;\nexports.getImgDisplaySize = getImgDisplaySize;\nexports.getImgEle = getImgEle;\nexports.getImgIndexs = getImgIndexs;\nexports.getImgTip = getImgTip;\nexports.getImgType = getImgType;\nexports.getPageTip = getPageTip;\nexports.getPageTop = getPageTop;\nexports.getTurnPageDir = getTurnPageDir;\nexports.handleClick = handleClick;\nexports.handleComicData = handleComicData;\nexports.handleEndTurnPage = handleEndTurnPage;\nexports.handleHotkey = handleHotkey;\nexports.handleImgError = handleImgError;\nexports.handleImgLoaded = handleImgLoaded;\nexports.handleKeyDown = handleKeyDown;\nexports.handleKeyUp = handleKeyUp;\nexports.handleMangaFlowDrag = handleMangaFlowDrag;\nexports.handleMouseDown = handleMouseDown;\nexports.handlePinchZoom = handlePinchZoom;\nexports.handleScrollModeDrag = handleScrollModeDrag;\nexports.handleScrollModeZoom = handleScrollModeZoom;\nexports.handleScrollbarSlider = handleScrollbarSlider;\nexports.handleTrackpadWheel = handleTrackpadWheel;\nexports.handleWheel = handleWheel;\nexports.handleZoomDrag = handleZoomDrag;\nexports.hotkeysMap = hotkeysMap;\nexports.imgAreaStyle = imgAreaStyle;\nexports.imgList = imgList;\nexports.imgPageMap = imgPageMap;\nexports.imgShowState = imgShowState;\nexports.isAbreastMode = isAbreastMode;\nexports.isBottom = isBottom;\nexports.isDoubleMode = isDoubleMode;\nexports.isDrag = isDrag;\nexports.isEnableBg = isEnableBg;\nexports.isOnePageMode = isOnePageMode;\nexports.isScrollMode = isScrollMode;\nexports.isSingleMode = isSingleMode;\nexports.isTop = isTop;\nexports.isTranslatingAll = isTranslatingAll;\nexports.isTranslatingImage = isTranslatingImage;\nexports.isTranslatingToEnd = isTranslatingToEnd;\nexports.isUpscale = isUpscale;\nexports.isUseAutoScale = isUseAutoScale;\nexports.jumpToImg = jumpToImg;\nexports.listenHotkey = listenHotkey;\nexports.loadingImgList = loadingImgList;\nexports.nowFillIndex = nowFillIndex;\nexports.openScrollLock = openScrollLock;\nexports.pageHeightList = pageHeightList;\nexports.pageNum = pageNum;\nexports.pageTopList = pageTopList;\nexports.placeholderSize = placeholderSize;\nexports.preloadNum = preloadNum;\nexports.refs = refs;\nexports.reloadImg = reloadImg;\nexports.renderImgList = renderImgList;\nexports.resetImgState = resetImgState;\nexports.resetPage = resetPage;\nexports.resetUI = resetUI;\nexports.resumeReadProgress = resumeReadProgress;\nexports.saveReadProgress = saveReadProgress;\nexports.saveScrollProgress = saveScrollProgress;\nexports.scrollBy = scrollBy;\nexports.scrollDomLength = scrollDomLength;\nexports.scrollLength = scrollLength;\nexports.scrollModeScale = scrollModeScale;\nexports.scrollPercentage = scrollPercentage;\nexports.scrollPosition = scrollPosition;\nexports.scrollProgress = scrollProgress;\nexports.scrollTo = scrollTo;\nexports.scrollTop = scrollTop;\nexports.scrollViewImg = scrollViewImg;\nexports.selfhostedOptions = selfhostedOptions;\nexports.selfhostedTranslation = selfhostedTranslation;\nexports.setAbreastScrollFill = setAbreastScrollFill;\nexports.setAdjustToWidth = setAdjustToWidth;\nexports.setDefaultHotkeys = setDefaultHotkeys;\nexports.setImgScale = setImgScale;\nexports.setImgTranslationEnbale = setImgTranslationEnbale;\nexports.setIsDrag = setIsDrag;\nexports.setOption = setOption;\nexports.setSelfOptions = setSelfOptions;\nexports.setState = setState;\nexports.showImgList = showImgList;\nexports.sliderHeight = sliderHeight;\nexports.sliderMidpoint = sliderMidpoint;\nexports.sliderTop = sliderTop;\nexports.store = store;\nexports.switchAutoScroll = switchAutoScroll;\nexports.switchDir = switchDir;\nexports.switchFillEffect = switchFillEffect;\nexports.switchFullscreen = switchFullscreen;\nexports.switchGridMode = switchGridMode;\nexports.switchImgRecognition = switchImgRecognition;\nexports.switchOnePageMode = switchOnePageMode;\nexports.switchScrollMode = switchScrollMode;\nexports.touches = touches;\nexports.translateAll = translateAll;\nexports.translateCurrent = translateCurrent;\nexports.translateToEnd = translateToEnd;\nexports.translationAll = translationAll;\nexports.translationImage = translationImage;\nexports.translationImgs = translationImgs;\nexports.translatorOptions = translatorOptions;\nexports.turnPage = turnPage;\nexports.turnPageAnimation = turnPageAnimation;\nexports.updateImgLoadType = updateImgLoadType;\nexports.updateImgSize = updateImgSize;\nexports.updateImgType = updateImgType;\nexports.updatePageData = updatePageData;\nexports.updateSelfhostedOptions = updateSelfhostedOptions;\nexports.updateShowRange = updateShowRange;\nexports.upscaleImage = upscaleImage;\nexports.watchDomSize = watchDomSize;\nexports.withOptionalState = withOptionalState;\nexports.zoom = zoom;\n";break;case"components/IconButton":c='\nconst web = require(\'solid-js/web\');\nconst solidJs = require(\'solid-js\');\nconst helper = require(\'helper\');\n\nvar css = ".iconButtonItem____hash_base64_5_{align-items:center;display:flex;position:relative}.iconButton____hash_base64_5_{align-items:center;background-color:initial;border-radius:9999px;border-style:none;color:var(--text,#fff);cursor:pointer;display:flex;font-size:1.5em;height:1.5em;justify-content:center;margin:.1em;outline:none;padding:0;width:1.5em}.iconButton____hash_base64_5_:focus,.iconButton____hash_base64_5_:hover{background-color:var(--hover-bg-color,#fff3)}.iconButton____hash_base64_5_.enabled____hash_base64_5_:not(.disable____hash_base64_5_){background-color:var(--text,#fff);color:var(--text-bg,#121212)}.iconButton____hash_base64_5_.enabled____hash_base64_5_:not(.disable____hash_base64_5_):focus,.iconButton____hash_base64_5_.enabled____hash_base64_5_:not(.disable____hash_base64_5_):hover{background-color:var(--hover-bg-color-enable,#fffa)}.iconButton____hash_base64_5_.disable____hash_base64_5_{background-color:unset;cursor:not-allowed;opacity:.5}.iconButton____hash_base64_5_>svg{width:1em}.iconButtonPopper____hash_base64_5_{align-items:center;background-color:#303030;border-radius:.3em;color:#fff;display:flex;font-size:.8em;opacity:0;padding:.4em .5em;pointer-events:none;position:absolute;top:50%;transform:translateY(-50%);-webkit-user-select:none;user-select:none;white-space:nowrap}.iconButtonPopper____hash_base64_5_[data-placement=right]{left:calc(100% + 1.5em)}.iconButtonPopper____hash_base64_5_[data-placement=right]:before{border-right-color:var(--switch-bg,#6e6e6e);border-right-width:.5em;right:calc(100% + .5em)}.iconButtonPopper____hash_base64_5_[data-placement=left]{right:calc(100% + 1.5em)}.iconButtonPopper____hash_base64_5_[data-placement=left]:before{border-left-color:var(--switch-bg,#6e6e6e);border-left-width:.5em;left:calc(100% + .5em)}.iconButtonPopper____hash_base64_5_:before{background-color:initial;border:.4em solid #0000;content:\\"\\";pointer-events:none;position:absolute;transition:opacity .15s}.iconButtonItem____hash_base64_5_:is(:hover,:focus,[data-show=true]) .iconButtonPopper____hash_base64_5_{opacity:1}.hidden____hash_base64_5_{display:none}";\nvar modules_c21c94f2 = {"iconButtonItem":"iconButtonItem____hash_base64_5_","iconButton":"iconButton____hash_base64_5_","enabled":"enabled____hash_base64_5_","disable":"disable____hash_base64_5_","iconButtonPopper":"iconButtonPopper____hash_base64_5_","hidden":"hidden____hash_base64_5_"};\n\n/** 图标按钮 */\nconst IconButton = _props => {\n  const props = solidJs.mergeProps({\n    placement: \'right\'\n  }, _props);\n  let buttonRef; // oxlint-disable-line no-unassigned-vars\n  const handleClick = e => {\n    if (props.disable) return;\n    props.onClick?.(e);\n    // 在每次点击后取消焦点\n    buttonRef?.blur();\n  };\n  return (() => {\n    var _el$ = web.template(`<div><button type=button tabindex=0>`)(),\n      _el$2 = _el$.firstChild;\n    web.use(ref => helper.useStyle(css, ref), _el$);\n    web.addEventListener(_el$2, "click", handleClick);\n    var _ref$ = buttonRef;\n    typeof _ref$ === "function" ? web.use(_ref$, _el$2) : buttonRef = _el$2;\n    web.insert(_el$2, () => props.children);\n    web.insert(_el$, (() => {\n      var _c$ = web.memo(() => !!(props.popper || props.tip));\n      return () => _c$() ? (() => {\n        var _el$3 = web.template(`<div>`)();\n        web.insert(_el$3, () => props.popper || props.tip);\n        web.effect(_p$ => {\n          var _v$7 = [modules_c21c94f2.iconButtonPopper, props.popperClassName].join(\' \'),\n            _v$8 = props.placement;\n          _v$7 !== _p$.e && web.className(_el$3, _p$.e = _v$7);\n          _v$8 !== _p$.t && web.setAttribute(_el$3, "data-placement", _p$.t = _v$8);\n          return _p$;\n        }, {\n          e: undefined,\n          t: undefined\n        });\n        return _el$3;\n      })() : null;\n    })(), null);\n    web.effect(_p$ => {\n      var _v$ = modules_c21c94f2.iconButtonItem,\n        _v$2 = props.showTip,\n        _v$3 = props.tip,\n        _v$4 = modules_c21c94f2.iconButton,\n        _v$5 = props.style,\n        _v$6 = {\n          [modules_c21c94f2.hidden]: props.hidden,\n          [modules_c21c94f2.enabled]: props.enabled,\n          [modules_c21c94f2.disable]: props.disable\n        };\n      _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n      _v$2 !== _p$.t && web.setAttribute(_el$, "data-show", _p$.t = _v$2);\n      _v$3 !== _p$.a && web.setAttribute(_el$2, "aria-label", _p$.a = _v$3);\n      _v$4 !== _p$.o && web.className(_el$2, _p$.o = _v$4);\n      _p$.i = web.style(_el$2, _v$5, _p$.i);\n      _p$.n = web.classList(_el$2, _v$6, _p$.n);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined,\n      a: undefined,\n      o: undefined,\n      i: undefined,\n      n: undefined\n    });\n    return _el$;\n  })();\n};\n\nexports.IconButton = IconButton;\n';break;case"components/Fab":c='\nconst web = require(\'solid-js/web\');\nconst solidJs = require(\'solid-js\');\nconst helper = require(\'helper\');\n\nconst MdMenuBook = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox="0 0 24 24"stroke=currentColor fill=currentColor stroke-width=0><path d="M17.5 4.5c-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5-1.45 0-2.99.22-4.28.79C1.49 5.62 1 6.33 1 7.14v11.28c0 1.3 1.22 2.26 2.48 1.94.98-.25 2.02-.36 3.02-.36 1.56 0 3.22.26 4.56.92.6.3 1.28.3 1.87 0 1.34-.67 3-.92 4.56-.92 1 0 2.04.11 3.02.36 1.26.33 2.48-.63 2.48-1.94V7.14c0-.81-.49-1.52-1.22-1.85-1.28-.57-2.82-.79-4.27-.79M21 17.23c0 .63-.58 1.09-1.2.98-.75-.14-1.53-.2-2.3-.2-1.7 0-4.15.65-5.5 1.5V8c1.35-.85 3.8-1.5 5.5-1.5.92 0 1.83.09 2.7.28.46.1.8.51.8.98z"></path><path d="M13.98 11.01c-.32 0-.61-.2-.71-.52-.13-.39.09-.82.48-.94 1.54-.5 3.53-.66 5.36-.45.41.05.71.42.66.83s-.42.71-.83.66c-1.62-.19-3.39-.04-4.73.39-.08.01-.16.03-.23.03m0 2.66c-.32 0-.61-.2-.71-.52-.13-.39.09-.82.48-.94 1.53-.5 3.53-.66 5.36-.45.41.05.71.42.66.83s-.42.71-.83.66c-1.62-.19-3.39-.04-4.73.39a1 1 0 0 1-.23.03m0 2.66c-.32 0-.61-.2-.71-.52-.13-.39.09-.82.48-.94 1.53-.5 3.53-.66 5.36-.45.41.05.71.42.66.83s-.42.7-.83.66c-1.62-.19-3.39-.04-4.73.39a1 1 0 0 1-.23.03">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nvar css = ".fabRoot____hash_base64_5_{font-size:1.1em;touch-action:none;transition:transform .2s}.fabRoot____hash_base64_5_[data-show=false]{pointer-events:none}.fabRoot____hash_base64_5_[data-show=false]>button{transform:scale(0)}.fabRoot____hash_base64_5_[data-trans=true]{opacity:.8}.fabRoot____hash_base64_5_[data-trans=true]:focus,.fabRoot____hash_base64_5_[data-trans=true]:focus-visible,.fabRoot____hash_base64_5_[data-trans=true]:hover{opacity:1}.fab____hash_base64_5_{align-items:center;background-color:var(--fab,#607d8b);border:none;border-radius:100%;box-shadow:0 3px 5px -1px #0003,0 6px 10px 0 #00000024,0 1px 18px 0 #0000001f;color:#fff;cursor:pointer;display:flex;font-size:1em;height:3.6em;justify-content:center;transform:scale(1);transition:transform .2s;width:3.6em}.fab____hash_base64_5_>svg{font-size:1.5em;width:1em}.fab____hash_base64_5_:focus,.fab____hash_base64_5_:focus-visible{box-shadow:0 3px 5px -1px #00000080,0 6px 10px 0 #00000057,0 1px 18px 0 #00000052;outline:none}.progress____hash_base64_5_{color:#b0bec5;display:inline-block;height:100%;position:absolute;transform:rotate(-90deg);transition:transform .3s cubic-bezier(.4,0,.2,1) 0s;width:100%}.progress____hash_base64_5_>svg{stroke:currentcolor;stroke-dasharray:290%;stroke-dashoffset:100%;stroke-linecap:round;transition:stroke-dashoffset .3s cubic-bezier(.4,0,.2,1) 0s}.progress____hash_base64_5_:hover{color:#cfd8dc}.progress____hash_base64_5_[aria-valuenow=\\"1\\"]{opacity:0;transition:opacity .2s .15s}.popper____hash_base64_5_{align-items:center;background-color:#303030;border-radius:.3em;color:#fff;display:flex;font-size:.8em;opacity:0;padding:.4em .5em;pointer-events:none;position:absolute;right:calc(100% + 1.5em);top:50%;transform:translateY(-50%) scale(0);transform-origin:right;transition:transform .23s,opacity .15s;transition-delay:var(--hide-delay);white-space:nowrap}.fabRoot____hash_base64_5_[data-placement=right] .popper____hash_base64_5_{left:calc(100% + 1.5em);right:unset;transform-origin:left}.fabRoot____hash_base64_5_:is(:hover,[data-focus=true]) .popper____hash_base64_5_{opacity:1;transform:translateY(-50%) scale(1);transition-delay:0s}.speedDial____hash_base64_5_{align-items:center;bottom:0;display:flex;flex-direction:column-reverse;font-size:1.1em;padding-bottom:120%;pointer-events:none;position:absolute;touch-action:none;width:100%;z-index:-1}.speedDial____hash_base64_5_[data-placement=bottom]{bottom:unset;flex-direction:column;padding-bottom:unset;padding-top:120%;top:0}.speedDialItem____hash_base64_5_{margin:.1em 0;opacity:0;transform:scale(0);transition-delay:var(--hide-delay);transition-duration:.23s;transition-property:transform,opacity}.fabRoot____hash_base64_5_:is(:hover:not([data-show=false]),[data-focus=true]) .speedDial____hash_base64_5_,.speedDial____hash_base64_5_:hover{pointer-events:all}:is(.fabRoot____hash_base64_5_:is(:hover:not([data-show=false]),[data-focus=true]) .speedDial____hash_base64_5_)>.speedDialItem____hash_base64_5_{opacity:unset;transform:unset;transition-delay:var(--show-delay)}.backdrop____hash_base64_5_{background:#000;height:100vh;left:0;opacity:0;pointer-events:none;position:fixed;top:0;transition:opacity .5s;width:100vw}.fabRoot____hash_base64_5_[data-focus=true] .backdrop____hash_base64_5_{pointer-events:unset}:is(.fabRoot____hash_base64_5_:hover:not([data-show=false]),.fabRoot____hash_base64_5_[data-focus=true],.speedDial____hash_base64_5_:hover) .backdrop____hash_base64_5_{opacity:.4}";\nvar modules_c21c94f2 = {"fabRoot":"fabRoot____hash_base64_5_","fab":"fab____hash_base64_5_","progress":"progress____hash_base64_5_","popper":"popper____hash_base64_5_","speedDial":"speedDial____hash_base64_5_","speedDialItem":"speedDialItem____hash_base64_5_","backdrop":"backdrop____hash_base64_5_"};\n\n/**\n * Fab 按钮\n */\nconst Fab = _props => {\n  const props = solidJs.mergeProps({\n    progress: 0,\n    initialShow: true,\n    autoTrans: false\n  }, _props);\n\n  // 上次滚动位置\n  let lastY = window.scrollY;\n  const [show, setShow] = solidJs.createSignal(props.initialShow);\n\n  // 绑定滚动事件\n  const handleScroll = helper.throttle(e => {\n    // 跳过非用户操作的滚动\n    if (!e.isTrusted) return;\n    if (window.scrollY === lastY) return;\n    setShow(\n    // 滚动到底部时显示\n    window.scrollY + window.innerHeight >= document.body.scrollHeight ||\n    // 向上滚动时显示，反之隐藏\n    window.scrollY - lastY < 0);\n    lastY = window.scrollY;\n  }, 200);\n  solidJs.onMount(() => window.addEventListener(\'scroll\', handleScroll));\n  solidJs.onCleanup(() => window.removeEventListener(\'scroll\', handleScroll));\n\n  // 将 forceShow 的变化同步到 show 上\n  solidJs.createEffect(() => props.show && setShow(props.show));\n  return (() => {\n    var _el$ = web.template(`<div><button type=button tabindex=-1><span role=progressbar><svg viewBox="22 22 44 44"><circle cx=44 cy=44 r=20.2 fill=none stroke-width=3.6>`)(),\n      _el$2 = _el$.firstChild,\n      _el$3 = _el$2.firstChild,\n      _el$4 = _el$3.firstChild;\n    web.use(ref => helper.useStyle(css, ref), _el$);\n    web.addEventListener(_el$2, "click", () => props.onClick?.());\n    web.use(ref => props.ref?.(ref), _el$2);\n    web.insert(_el$2, () => props.children ?? web.createComponent(MdMenuBook, {}), _el$3);\n    web.insert(_el$2, (() => {\n      var _c$ = web.memo(() => !!props.tip);\n      return () => _c$() ? (() => {\n        var _el$7 = web.template(`<div>`)();\n        web.insert(_el$7, () => props.tip);\n        web.effect(() => web.className(_el$7, modules_c21c94f2.popper));\n        return _el$7;\n      })() : null;\n    })(), null);\n    web.insert(_el$, web.createComponent(solidJs.Show, {\n      get when() {\n        return props.speedDial?.length;\n      },\n      get children() {\n        var _el$5 = web.template(`<div><div>`)(),\n          _el$6 = _el$5.firstChild;\n        web.addEventListener(_el$6, "click", () => props.onBackdropClick?.());\n        web.insert(_el$5, web.createComponent(solidJs.For, {\n          get each() {\n            return props.speedDial;\n          },\n          children: (SpeedDialItem, i) => (() => {\n            var _el$8 = web.template(`<div>`)();\n            web.insert(_el$8, web.createComponent(SpeedDialItem, {}));\n            web.effect(_p$ => {\n              var _v$12 = modules_c21c94f2.speedDialItem,\n                _v$13 = `${(i() + 1) * 30}ms`,\n                _v$14 = `${(props.speedDial.length - 1 - i()) * 50}ms`,\n                _v$15 = i() * 30;\n              _v$12 !== _p$.e && web.className(_el$8, _p$.e = _v$12);\n              _v$13 !== _p$.t && web.setStyleProperty(_el$8, "--show-delay", _p$.t = _v$13);\n              _v$14 !== _p$.a && web.setStyleProperty(_el$8, "--hide-delay", _p$.a = _v$14);\n              _v$15 !== _p$.o && web.setAttribute(_el$8, "data-i", _p$.o = _v$15);\n              return _p$;\n            }, {\n              e: undefined,\n              t: undefined,\n              a: undefined,\n              o: undefined\n            });\n            return _el$8;\n          })()\n        }), null);\n        web.effect(_p$ => {\n          var _v$ = modules_c21c94f2.speedDial,\n            _v$2 = props.speedDialPlacement,\n            _v$3 = modules_c21c94f2.backdrop;\n          _v$ !== _p$.e && web.className(_el$5, _p$.e = _v$);\n          _v$2 !== _p$.t && web.setAttribute(_el$5, "data-placement", _p$.t = _v$2);\n          _v$3 !== _p$.a && web.className(_el$6, _p$.a = _v$3);\n          return _p$;\n        }, {\n          e: undefined,\n          t: undefined,\n          a: undefined\n        });\n        return _el$5;\n      }\n    }), null);\n    web.effect(_p$ => {\n      var _v$4 = modules_c21c94f2.fabRoot,\n        _v$5 = props.show ?? show(),\n        _v$6 = props.autoTrans,\n        _v$7 = props.focus,\n        _v$8 = props.placement,\n        _v$9 = {\n          ...props.style,\n          \'--hide-delay\': `${(props.speedDial?.length ?? 0) * 50}ms`\n        },\n        _v$0 = modules_c21c94f2.fab,\n        _v$1 = modules_c21c94f2.progress,\n        _v$10 = props.progress,\n        _v$11 = `${(1 - props.progress) * 290}%`;\n      _v$4 !== _p$.e && web.className(_el$, _p$.e = _v$4);\n      _v$5 !== _p$.t && web.setAttribute(_el$, "data-show", _p$.t = _v$5);\n      _v$6 !== _p$.a && web.setAttribute(_el$, "data-trans", _p$.a = _v$6);\n      _v$7 !== _p$.o && web.setAttribute(_el$, "data-focus", _p$.o = _v$7);\n      _v$8 !== _p$.i && web.setAttribute(_el$, "data-placement", _p$.i = _v$8);\n      _p$.n = web.style(_el$, _v$9, _p$.n);\n      _v$0 !== _p$.s && web.className(_el$2, _p$.s = _v$0);\n      _v$1 !== _p$.h && web.className(_el$3, _p$.h = _v$1);\n      _v$10 !== _p$.r && web.setAttribute(_el$3, "aria-valuenow", _p$.r = _v$10);\n      _v$11 !== _p$.d && web.setStyleProperty(_el$4, "stroke-dashoffset", _p$.d = _v$11);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined,\n      a: undefined,\n      o: undefined,\n      i: undefined,\n      n: undefined,\n      s: undefined,\n      h: undefined,\n      r: undefined,\n      d: undefined\n    });\n    return _el$;\n  })();\n};\n\nexports.Fab = Fab;\n';break;case"components/Toast":c="\nconst helper = require('helper');\nconst web = require('solid-js/web');\nconst solidJs = require('solid-js');\n\nconst {\n  store,\n  setState\n} = helper.useStore({\n  ref: null,\n  list: [],\n  map: {}\n});\nconst creatId = () => {\n  let id = `${Date.now()}`;\n  while (Reflect.has(store.map, id)) id += '_';\n  return id;\n};\nconst dismiss = id => Reflect.has(store.map, id) && setState('map', id, 'exit', true);\n\nvar css = \".root____hash_base64_5_{align-items:flex-end;bottom:0;display:flex;flex-direction:column;font-size:16px;pointer-events:none;position:fixed;right:0;z-index:2147483647}.item____hash_base64_5_{align-items:center;animation:bounceInRight____hash_base64_5_ .5s 1;background:#fff;border-radius:4px;box-shadow:0 1px 10px 0 #0000001a,0 2px 15px 0 #0000000d;color:#000;cursor:pointer;display:flex;margin:1em;max-width:min(30em,100vw);overflow:hidden;padding:.8em 1em;pointer-events:auto;position:relative;width:fit-content}.item____hash_base64_5_>svg{color:var(--theme);margin-right:.5em;width:1.5em}.item____hash_base64_5_[data-exit]{animation:bounceOutRight____hash_base64_5_ .5s 1}.schedule____hash_base64_5_{background-color:var(--theme);bottom:0;height:.2em;left:0;position:absolute;transform-origin:left;width:100%}.item____hash_base64_5_[data-schedule] .schedule____hash_base64_5_{transition:transform .1s}.item____hash_base64_5_:not([data-schedule]) .schedule____hash_base64_5_{animation:schedule____hash_base64_5_ linear 1 forwards}:is(.item____hash_base64_5_:hover,.item____hash_base64_5_[data-schedule],.root____hash_base64_5_[data-paused]) .schedule____hash_base64_5_{animation-play-state:paused}.msg____hash_base64_5_{line-height:1.4em;overflow-wrap:anywhere;text-align:start;white-space:break-spaces;width:fit-content}.msg____hash_base64_5_ h2{margin:0}.msg____hash_base64_5_ h3{margin:.7em 0}.msg____hash_base64_5_ ul{margin:0;text-align:left}.msg____hash_base64_5_ button{background-color:#eee;border:none;border-radius:.4em;cursor:pointer;font-size:inherit;margin:0 .5em;outline:none;padding:.2em .6em}:is(.msg____hash_base64_5_ button):hover{background:#e0e0e0}p{margin:0}@keyframes schedule____hash_base64_5_{0%{transform:scaleX(1)}to{transform:scaleX(0)}}@keyframes bounceInRight____hash_base64_5_{0%,60%,75%,90%,to{animation-timing-function:cubic-bezier(.215,.61,.355,1)}0%{opacity:0;transform:translate3d(3000px,0,0) scaleX(3)}60%{opacity:1;transform:translate3d(-25px,0,0) scaleX(1)}75%{transform:translate3d(10px,0,0) scaleX(.98)}90%{transform:translate3d(-5px,0,0) scaleX(.995)}to{transform:translateZ(0)}}@keyframes bounceOutRight____hash_base64_5_{20%{opacity:1;transform:translate3d(-20px,0,0) scaleX(.9)}to{opacity:0;transform:translate3d(2000px,0,0) scaleX(2)}}\";\nvar modules_c21c94f2 = {\"root\":\"root____hash_base64_5_\",\"item\":\"item____hash_base64_5_\",\"schedule\":\"schedule____hash_base64_5_\",\"msg\":\"msg____hash_base64_5_\"};\n\nconst MdCheckCircle = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2M9.29 16.29 5.7 12.7a.996.996 0 1 1 1.41-1.41L10 14.17l6.88-6.88a.996.996 0 1 1 1.41 1.41l-7.59 7.59a.996.996 0 0 1-1.41 0\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdError = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 11c-.55 0-1-.45-1-1V8c0-.55.45-1 1-1s1 .45 1 1v4c0 .55-.45 1-1 1m1 4h-2v-2h2z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdInfo = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 15c-.55 0-1-.45-1-1v-4c0-.55.45-1 1-1s1 .45 1 1v4c0 .55-.45 1-1 1m1-8h-2V7h2z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdWarning = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M4.47 21h15.06c1.54 0 2.5-1.67 1.73-3L13.73 4.99c-.77-1.33-2.69-1.33-3.46 0L2.74 18c-.77 1.33.19 3 1.73 3M12 14c-.55 0-1-.45-1-1v-2c0-.55.45-1 1-1s1 .45 1 1v2c0 .55-.45 1-1 1m1 4h-2v-2h2z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst iconMap = {\n  info: MdInfo,\n  success: MdCheckCircle,\n  warn: MdWarning,\n  error: MdError\n};\nconst colorMap = {\n  info: '#3a97d7',\n  success: '#23bb35',\n  warn: '#f0c53e',\n  error: '#e45042',\n  custom: '#1f2936'\n};\n\n/** 删除 toast */\nconst dismissToast = id => setState(state => {\n  state.map[id]?.onDismiss?.({\n    ...state.map[id]\n  });\n  const i = state.list.indexOf(id);\n  if (i !== -1) state.list.splice(i, 1);\n  Reflect.deleteProperty(state.map, id);\n});\n\n/** 重置 toast 的 update 属性 */\nconst resetToastUpdate = id => setState('map', id, 'update', undefined);\nconst ToastItem = props => {\n  /** 是否要显示进度 */\n  const showSchedule = solidJs.createMemo(() => props.duration === Number.POSITIVE_INFINITY && props.schedule ? true : undefined);\n  const _dismiss = e => {\n    e.stopPropagation();\n    if (showSchedule() && 'animationName' in e) return;\n    dismiss(props.id);\n  };\n\n  // 在退出动画结束后才真的删除\n  const handleAnimationEnd = () => {\n    if (!props.exit) return;\n    dismissToast(props.id);\n  };\n  let scheduleRef; // oxlint-disable-line no-unassigned-vars\n  solidJs.createEffect(() => {\n    if (!props.update) return;\n    resetToastUpdate(props.id);\n    if (!scheduleRef) return;\n    for (const animation of scheduleRef.getAnimations()) animation.currentTime = 0;\n  });\n  const handleClick = e => {\n    props.onClick?.();\n    _dismiss(e);\n  };\n  return (() => {\n    var _el$ = web.template(`<div><div>`)(),\n      _el$2 = _el$.firstChild;\n    _el$.addEventListener(\"animationend\", handleAnimationEnd);\n    web.addEventListener(_el$, \"click\", handleClick);\n    web.insert(_el$, web.createComponent(web.Dynamic, {\n      get component() {\n        return iconMap[props.type];\n      }\n    }), _el$2);\n    web.insert(_el$2, (() => {\n      var _c$ = web.memo(() => typeof props.msg === 'string');\n      return () => _c$() ? props.msg : web.createComponent(props.msg, {});\n    })());\n    web.insert(_el$, web.createComponent(solidJs.Show, {\n      get when() {\n        return props.duration !== Number.POSITIVE_INFINITY || props.schedule !== undefined;\n      },\n      get children() {\n        var _el$3 = web.template(`<div>`)();\n        _el$3.addEventListener(\"animationend\", _dismiss);\n        var _ref$ = scheduleRef;\n        typeof _ref$ === \"function\" ? web.use(_ref$, _el$3) : scheduleRef = _el$3;\n        web.effect(_p$ => {\n          var _v$ = modules_c21c94f2.schedule,\n            _v$2 = `${props.duration}ms`,\n            _v$3 = showSchedule() ? `scaleX(${props.schedule})` : undefined;\n          _v$ !== _p$.e && web.className(_el$3, _p$.e = _v$);\n          _v$2 !== _p$.t && web.setStyleProperty(_el$3, \"animation-duration\", _p$.t = _v$2);\n          _v$3 !== _p$.a && web.setStyleProperty(_el$3, \"transform\", _p$.a = _v$3);\n          return _p$;\n        }, {\n          e: undefined,\n          t: undefined,\n          a: undefined\n        });\n        return _el$3;\n      }\n    }), null);\n    web.effect(_p$ => {\n      var _v$4 = modules_c21c94f2.item,\n        _v$5 = colorMap[props.type],\n        _v$6 = showSchedule(),\n        _v$7 = props.exit,\n        _v$8 = modules_c21c94f2.msg;\n      _v$4 !== _p$.e && web.className(_el$, _p$.e = _v$4);\n      _v$5 !== _p$.t && web.setStyleProperty(_el$, \"--theme\", _p$.t = _v$5);\n      _v$6 !== _p$.a && web.setAttribute(_el$, \"data-schedule\", _p$.a = _v$6);\n      _v$7 !== _p$.o && web.setAttribute(_el$, \"data-exit\", _p$.o = _v$7);\n      _v$8 !== _p$.i && web.className(_el$2, _p$.i = _v$8);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined,\n      a: undefined,\n      o: undefined,\n      i: undefined\n    });\n    return _el$;\n  })();\n};\n\nconst Toaster = () => {\n  const [visible, setVisible] = solidJs.createSignal(document.visibilityState === 'visible');\n  solidJs.onMount(() => {\n    helper.useStyle(css, store.ref);\n    const handleVisibilityChange = () => {\n      setVisible(document.visibilityState === 'visible');\n    };\n    document.addEventListener('visibilitychange', handleVisibilityChange);\n    solidJs.onCleanup(() => document.removeEventListener('visibilitychange', handleVisibilityChange));\n  });\n  return (() => {\n    var _el$ = web.template(`<div>`)();\n    web.use(ref => setState('ref', ref), _el$);\n    web.insert(_el$, web.createComponent(solidJs.For, {\n      get each() {\n        return store.list;\n      },\n      children: id => web.createComponent(ToastItem, web.mergeProps(() => store.map[id]))\n    }));\n    web.effect(_p$ => {\n      var _v$ = modules_c21c94f2.root,\n        _v$2 = visible() ? undefined : '';\n      _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n      _v$2 !== _p$.t && web.setAttribute(_el$, \"data-paused\", _p$.t = _v$2);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined\n    });\n    return _el$;\n  })();\n};\nlet dom;\nconst init = () => {\n  if (dom || store.ref) return;\n  dom = helper.mountComponents('toast', () => web.createComponent(Toaster, {}));\n  dom.style.setProperty('z-index', '2147483647', 'important');\n};\n\nconst toast = (msg, options) => {\n  if (!msg) return;\n  init();\n  const id = options?.id ?? (typeof msg === 'string' ? msg : creatId());\n  setState(state => {\n    if (Reflect.has(state.map, id)) {\n      Object.assign(state.map[id], {\n        msg,\n        ...options,\n        update: true\n      });\n      return;\n    }\n    state.map[id] = {\n      id,\n      type: 'info',\n      duration: 3000,\n      msg,\n      ...options\n    };\n    state.list.push(id);\n  });\n\n  /** 弹窗后记录一下 */\n  let fn = helper.log;\n  switch (options?.type) {\n    case 'warn':\n      fn = helper.log.warn;\n      break;\n    case 'error':\n      fn = helper.log.error;\n      break;\n  }\n  fn('Toast:', msg);\n  if (options?.throw && typeof msg === 'string') throw new Error(msg);\n};\ntoast.dismiss = dismiss;\ntoast.set = (id, options) => {\n  if (!Reflect.has(store.map, id)) return;\n  setState(state => Object.assign(state.map[id], options));\n};\ntoast.success = (msg, options) => toast(msg, {\n  ...options,\n  exit: undefined,\n  type: 'success'\n});\ntoast.warn = (msg, options) => toast(msg, {\n  ...options,\n  exit: undefined,\n  type: 'warn'\n});\ntoast.error = (msg, options) => toast(msg, {\n  ...options,\n  exit: undefined,\n  type: 'error'\n});\n\nexports.Toaster = Toaster;\nexports.toast = toast;\n";break;case"userscript/dmzjApi":c="\nconst solidJs = require('solid-js');\nconst store = require('solid-js/store');\nconst dmzjDecrypt = require('dmzjDecrypt');\nconst helper = require('helper');\nconst main = require('main');\n\n/** 根据漫画 id 和章节 id 获取章节数据 */\nconst getChapterInfo = async (comicId, chapterId) => {\n  const res = await main.request(`https://m.dmzj.com/chapinfo/${comicId}/${chapterId}.html`, {\n    responseType: 'json',\n    errorText: '获取章节数据失败'\n  });\n  return res.response;\n};\n\n/** 根据漫画 id 和章节 id 获取章节评论 */\nconst getViewpoint = async (comicId, chapterId) => {\n  try {\n    const res = await main.request(`http://v3api.dmzj.com/viewPoint/0/${comicId}/${chapterId}.json`, {\n      responseType: 'json',\n      errorText: '获取章节评论失败'\n    });\n\n    // 还有另一个 api\n    // https://manhua.dmzj.com/tpi/api/viewpoint/getViewpoint?type=0&type_id=${comicId}&chapter_id=${chapterId}&more=1\n\n    return res.response.map(({\n      content,\n      num\n    }) => `${content} [+${num}]`);\n  } catch {\n    return [];\n  }\n};\nconst getComicDetail_base = async comicId => {\n  const res = await main.request(`https://api.dmzj.com/dynamic/comicinfo/${comicId}.json`, {\n    responseType: 'json'\n  });\n  const {\n    info: {\n      last_updatetime,\n      title\n    },\n    list\n  } = res.response.data;\n  return {\n    title,\n    last_updatetime,\n    last_update_chapter_id: undefined,\n    chapters: [{\n      name: '连载',\n      list: list.map(({\n        id,\n        chapter_name,\n        updatetime\n      }) => ({\n        id,\n        title: chapter_name,\n        updatetime\n      }))\n    }]\n  };\n};\nconst getComicDetail_v4Api = async comicId => {\n  const res = await main.request(`https://v4api.idmzj.com/comic/detail/${comicId}?uid=2665531&disable_level=1`);\n  const {\n    comicInfo: {\n      last_update_chapter_id,\n      last_updatetime,\n      chapters,\n      title\n    }\n  } = dmzjDecrypt(res.responseText);\n  for (const chapter of Object.values(chapters)) chapter.data.sort((a, b) => a.chapter_order - b.chapter_order);\n  return {\n    title,\n    last_updatetime,\n    last_update_chapter_id,\n    chapters: chapters.map(({\n      data,\n      title: name\n    }) => ({\n      name,\n      list: data.map(({\n        chapter_id,\n        chapter_title,\n        updatetime\n      }) => ({\n        id: chapter_id,\n        title: chapter_title,\n        updatetime\n      }))\n    }))\n  };\n};\nconst getComicDetail_traversal = async (comicId, draftData) => {\n  let nextId = draftData.last_update_chapter_id;\n  if (!nextId) {\n    helper.log.warn('last_update_chapter_id 为空，无法通过遍历获取章节');\n    return;\n  }\n  draftData.chapters[0] = {\n    name: '连载',\n    list: []\n  };\n  main.toast.warn('正在通过遍历获取所有章节，耗时可能较长', {\n    id: 'traversalTip',\n    duration: Number.POSITIVE_INFINITY\n  });\n  while (nextId) {\n    try {\n      const {\n        chapter_name,\n        updatetime,\n        prev_chap_id\n      } = await getChapterInfo(comicId, nextId);\n      draftData.chapters[0].list.push({\n        id: nextId,\n        title: chapter_name,\n        updatetime\n      });\n      nextId = prev_chap_id;\n    } catch {\n      nextId = undefined;\n    }\n  }\n  main.toast.dismiss('traversalTip');\n};\n\n/** 返回可变 store 类型的漫画数据 */\nconst useComicDetail = comicId => {\n  const data = store.createMutable({});\n  const apiFn = [getComicDetail_v4Api, getComicDetail_base, getComicDetail_traversal];\n  solidJs.onMount(async () => {\n    for (const api of apiFn) {\n      try {\n        Object.assign(data, await api(comicId, data));\n        if (data.chapters?.some(chapter => chapter.list.length)) return;\n      } catch {}\n    }\n    main.toast.error('漫画数据获取失败', {\n      duration: Number.POSITIVE_INFINITY\n    });\n  });\n  return data;\n};\n\n/** 根据漫画拼音简称找到对应的 id */\nconst getComicId = async py => {\n  const res = await main.request(`https://manhua.dmzj.com/api/v1/comic2/comic/detail?${new URLSearchParams({\n    channel: 'pc',\n    app_name: 'comic',\n    version: '1.0.0',\n    timestamp: `${Date.now()}`,\n    uid: '',\n    comic_py: py\n  }).toString()}`, {\n    responseType: 'json'\n  });\n  return res.response.data?.comicInfo?.id;\n};\n\nexports.getChapterInfo = getChapterInfo;\nexports.getComicId = getComicId;\nexports.getViewpoint = getViewpoint;\nexports.useComicDetail = useComicDetail;\n";break;case"userscript/copyApi":c="\nconst helper = require('helper');\nconst main = require('main');\nconst request = require('request');\n\nlet contentKey = '';\nlet key = '';\nconst getKeys = async url => {\n  if (contentKey && key) return [contentKey, key];\n\n  // 热辣漫画放在网页元素里\n  if (helper.querySelector('.disData[contentkey]')) {\n    contentKey = helper.querySelector('.disData[contentkey]').getAttribute('contentkey');\n    key = helper.querySelector('.disPass[contentkey]').getAttribute('contentkey');\n    return [contentKey, key];\n  }\n\n  // 拷贝 PC 端直接放在网页变量里，不过另一个变量的名字会变\n  if (unsafeWindow.contentKey && unsafeWindow.cct) {\n    contentKey = unsafeWindow.contentKey; // oxlint-disable-line prefer-destructuring\n    key = unsafeWindow.cct;\n    return [contentKey, key];\n  }\n\n  // 如果另一个变量的名字变了，或者是在拷贝的移动端，就得从 PC 端的网页里解析获取了\n  if (url) {\n    const html = await request.request(url, {\n      fetch: false,\n      headers: {\n        'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.5112.79 Safari/537.36'\n      }\n    });\n    const [script] = html.responseText.match(/(?<=<script>\\s+)(var .+?contentKey =.+?)(?=<\\/script)/gs);\n    const res = {};\n    for (const [, key, value] of script.matchAll(/var (\\S+) = '(.+?)';\\n/g)) res[key] = value;\n    contentKey = res.contentKey; // oxlint-disable-line prefer-destructuring\n\n    const passKey = Object.keys(res).find(key => key !== 'contentKey');\n    if (!passKey) {\n      main.toast.error(helper.t('site.changed_load_failed'));\n      throw new Error(helper.t('site.changed_load_failed'));\n    }\n    key = res[passKey];\n    return [contentKey, key];\n  }\n  main.toast.error(helper.t('site.changed_load_failed'));\n  throw new Error(helper.t('site.changed_load_failed'));\n};\n\n// by: https://github.com/MapoMagpie/comic-looms/blob/7799f87fdd5a8ac73c878f338b7ae6aa5c0b2d18/src/platform/matchers/mangacopy.ts#L96-L125\nconst decryptData = async (raw, key) => {\n  key ||= (await getKeys())[1]; // oxlint-disable-line no-await-expression-member\n\n  const cipher = raw.slice(16);\n  const iv = raw.slice(0, 16);\n  const decryptedBuffer = await crypto.subtle.decrypt({\n    name: 'AES-CBC',\n    iv: new TextEncoder().encode(iv)\n  }, await crypto.subtle.importKey('raw', new TextEncoder().encode(key), {\n    name: 'AES-CBC'\n  }, false, ['decrypt']), new Uint8Array(cipher.match(/.{1,2}/g).map(byte => Number.parseInt(byte, 16))).buffer);\n  return JSON.parse(new TextDecoder().decode(decryptedBuffer));\n};\n\n/** 通过解析网页变量获取图片列表 */\nconst getImglistByHtml = async url => {\n  const keys = await getKeys(url);\n  const res = await decryptData(...keys);\n  return res.map(({\n    url\n  }) => url.replace(/(?<=(\\/|\\.))c800x/, 'c1500x'));\n};\n\nexports.decryptData = decryptData;\nexports.getImglistByHtml = getImglistByHtml;\n";break;case"userscript/detectAd":c="\nconst Comlink = require('comlink');\nconst helper = require('helper');\nconst main = require('main');\nconst worker = require('worker/detectAd');\n\n/** 用常识逻辑进行判断，以期能在检测失误时减小影响范围和遗漏 */\nconst getAdPage = async (list, isAdPage, adList) => {\n  let i = list.length - 1;\n  let normalNum = 0;\n  // 只检查最后十张\n  for (; i >= list.length - 10; i--) {\n    // 开头肯定不会是广告\n    if (i <= 2) break;\n    if (adList.has(i)) continue;\n    const item = list[i];\n    if (!item) break;\n    if (await isAdPage(item)) adList.add(i);\n    // 找到连续三张正常漫画页后中断\n    else if (normalNum >= 2) break;else normalNum += 1;\n  }\n  let adNum = 0;\n  for (i = Math.min(...adList); i < list.length; i++) {\n    if (adList.has(i)) {\n      adNum += 1;\n      continue;\n    }\n\n    // 连续两张广告后面的肯定也都是广告\n    if (adNum >= 2) adList.add(i);\n    // 夹在两张广告中间的肯定也是广告\n    else if (adList.has(i - 1) && adList.has(i + 1)) adList.add(i);else adNum = 0;\n  }\n  return adList;\n};\nconst imgToCanvas = async img => {\n  if (typeof img !== 'string') {\n    await helper.waitImgLoad(img);\n    try {\n      const canvas = new OffscreenCanvas(img.width, img.height);\n      const ctx = canvas.getContext('2d');\n      ctx.drawImage(img, 0, 0);\n      // 没被 CORS 污染就直接使用\n      if (ctx.getImageData(0, 0, 1, 1)) {\n        const imgBitmap = canvas.transferToImageBitmap();\n        return Comlink.transfer(imgBitmap, [imgBitmap]);\n      }\n    } catch {}\n  }\n  const url = typeof img === 'string' ? img : img.src;\n  const res = await main.request(url, {\n    responseType: 'blob',\n    fetch: false\n  });\n  const imgBitmap = await createImageBitmap(res.response);\n  return Comlink.transfer(imgBitmap, [imgBitmap]);\n};\n\n/** 通过文件名判断是否是广告 */\nconst getAdPageByFileName = (fileNameList, adList) => getAdPage(fileNameList, fileName => /^z+/i.test(fileName), adList);\nconst isAdImg = imgBitmap => {\n  initWorker();\n  return worker.isAdImg(Comlink.transfer(imgBitmap, [imgBitmap]));\n};\n\n/** 通过图片内容判断是否是广告 */\nconst getAdPageByContent = (imgList, adList) => getAdPage(imgList, async img => isAdImg(await imgToCanvas(img)), adList);\nconst initWorker = helper.onec(() => {\n  const mainFn = {\n    log: helper.log\n  };\n  worker.setMainFn(Comlink.proxy(mainFn), Object.keys(mainFn));\n});\n\nexports.getAdPageByContent = getAdPageByContent;\nexports.getAdPageByFileName = getAdPageByFileName;\nexports.isAdImg = isAdImg;\n";break;case"main":c="\nconst helper = require('helper');\nconst web = require('solid-js/web');\nconst Manga = require('components/Manga');\nconst Toast = require('components/Toast');\nconst solidJs = require('solid-js');\nconst Fab = require('components/Fab');\nconst IconButton = require('components/IconButton');\nconst request = require('request');\n\nconst MdSettings = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M19.5 12c0-.23-.01-.45-.03-.68l1.86-1.41c.4-.3.51-.86.26-1.3l-1.87-3.23a.987.987 0 0 0-1.25-.42l-2.15.91c-.37-.26-.76-.49-1.17-.68l-.29-2.31c-.06-.5-.49-.88-.99-.88h-3.73c-.51 0-.94.38-1 .88l-.29 2.31c-.41.19-.8.42-1.17.68l-2.15-.91c-.46-.2-1-.02-1.25.42L2.41 8.62c-.25.44-.14.99.26 1.3l1.86 1.41a7.3 7.3 0 0 0 0 1.35l-1.86 1.41c-.4.3-.51.86-.26 1.3l1.87 3.23c.25.44.79.62 1.25.42l2.15-.91c.37.26.76.49 1.17.68l.29 2.31c.06.5.49.88.99.88h3.73c.5 0 .93-.38.99-.88l.29-2.31c.41-.19.8-.42 1.17-.68l2.15.91c.46.2 1 .02 1.25-.42l1.87-3.23c.25-.44.14-.99-.26-1.3l-1.86-1.41c.03-.23.04-.45.04-.68m-7.46 3.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdCloudDownload = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M19.35 10.04A7.49 7.49 0 0 0 12 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 0 0 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96M17 13l-4.65 4.65c-.2.2-.51.2-.71 0L7 13h3V9h4v4z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdImageSearch = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M18 15v4c0 .55-.45 1-1 1H5c-.55 0-1-.45-1-1V7c0-.55.45-1 1-1h3.02c.55 0 1-.45 1-1s-.45-1-1-1H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-5c0-.55-.45-1-1-1s-1 .45-1 1m-2.5 3H6.52c-.42 0-.65-.48-.39-.81l1.74-2.23a.5.5 0 0 1 .78-.01l1.56 1.88 2.35-3.02c.2-.26.6-.26.79.01l2.55 3.39c.25.32.01.79-.4.79m3.8-9.11c.48-.77.75-1.67.69-2.66-.13-2.15-1.84-3.97-3.97-4.2A4.5 4.5 0 0 0 11 6.5c0 2.49 2.01 4.5 4.49 4.5.88 0 1.7-.26 2.39-.7l2.41 2.41c.39.39 1.03.39 1.42 0s.39-1.03 0-1.42zM15.5 9a2.5 2.5 0 0 1 0-5 2.5 2.5 0 0 1 0 5\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdImportContacts = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M17.5 4.5c-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5-1.45 0-2.99.22-4.28.79C1.49 5.62 1 6.33 1 7.14v11.28c0 1.3 1.22 2.26 2.48 1.94.98-.25 2.02-.36 3.02-.36 1.56 0 3.22.26 4.56.92.6.3 1.28.3 1.87 0 1.34-.67 3-.92 4.56-.92 1 0 2.04.11 3.02.36 1.26.33 2.48-.63 2.48-1.94V7.14c0-.81-.49-1.52-1.22-1.85-1.28-.57-2.82-.79-4.27-.79M21 17.23c0 .63-.58 1.09-1.2.98-.75-.14-1.53-.2-2.3-.2-1.7 0-4.15.65-5.5 1.5V8c1.35-.85 3.8-1.5 5.5-1.5.92 0 1.83.09 2.7.28.46.1.8.51.8.98z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdMenuBook = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M17.5 4.5c-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5-1.45 0-2.99.22-4.28.79C1.49 5.62 1 6.33 1 7.14v11.28c0 1.3 1.22 2.26 2.48 1.94.98-.25 2.02-.36 3.02-.36 1.56 0 3.22.26 4.56.92.6.3 1.28.3 1.87 0 1.34-.67 3-.92 4.56-.92 1 0 2.04.11 3.02.36 1.26.33 2.48-.63 2.48-1.94V7.14c0-.81-.49-1.52-1.22-1.85-1.28-.57-2.82-.79-4.27-.79M21 17.23c0 .63-.58 1.09-1.2.98-.75-.14-1.53-.2-2.3-.2-1.7 0-4.15.65-5.5 1.5V8c1.35-.85 3.8-1.5 5.5-1.5.92 0 1.83.09 2.7.28.46.1.8.51.8.98z\"></path><path d=\"M13.98 11.01c-.32 0-.61-.2-.71-.52-.13-.39.09-.82.48-.94 1.54-.5 3.53-.66 5.36-.45.41.05.71.42.66.83s-.42.71-.83.66c-1.62-.19-3.39-.04-4.73.39-.08.01-.16.03-.23.03m0 2.66c-.32 0-.61-.2-.71-.52-.13-.39.09-.82.48-.94 1.53-.5 3.53-.66 5.36-.45.41.05.71.42.66.83s-.42.71-.83.66c-1.62-.19-3.39-.04-4.73.39a1 1 0 0 1-.23.03m0 2.66c-.32 0-.61-.2-.71-.52-.13-.39.09-.82.48-.94 1.53-.5 3.53-.66 5.36-.45.41.05.71.42.66.83s-.42.7-.83.66c-1.62-.19-3.39-.04-4.73.39a1 1 0 0 1-.23.03\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst useFab = mainContext => {\n  const {\n    store,\n    setState,\n    options,\n    setOptions\n  } = mainContext;\n  helper.useStyle(`\n    #fab {\n      --text-bg: transparent;\n\n      position: fixed;\n      right: calc(3vw - var(--left, 0px));\n      bottom: calc(6vh - var(--top, 0px));\n\n      font-size: clamp(12px, 1.5vw, 16px);\n    }\n  `);\n  helper.useStyleMemo('#fab', {\n    '--left': () => `${options.fabPosition.left}px`,\n    '--top': () => `${options.fabPosition.top}px`\n  });\n  const FabIcon = () => {\n    switch (store.fab.progress) {\n      case undefined:\n        return MdImportContacts;\n      // 没有内容的书\n      case 1:\n      case 2:\n        return MdMenuBook;\n      // 有内容的书\n      default:\n        return store.fab.progress > 1 ? MdCloudDownload : MdImageSearch;\n    }\n  };\n  const handleMount = ref => {\n    const handleDrag = ({\n      xy: [x, y],\n      last: [lx, ly]\n    }) => {\n      const left = options.fabPosition.left + x - lx;\n      const top = options.fabPosition.top + y - ly;\n      setOptions({\n        fabPosition: {\n          left,\n          top\n        }\n      });\n    };\n    helper.useDrag({\n      ref,\n      handleDrag,\n      setCapture: true\n    });\n\n    // 超出显示范围就恢复原位\n    const observer = new IntersectionObserver(entries => {\n      if (entries.length !== 1 || entries[0].isIntersecting) return;\n      setOptions({\n        fabPosition: {\n          left: 0,\n          top: 0\n        }\n      });\n    }, {\n      threshold: 0.5\n    });\n    observer.observe(ref);\n  };\n  const dom = helper.mountComponents('fab', () => {\n    solidJs.createEffect(() => {\n      setState('fab', {\n        placement: -options.fabPosition.left < window.innerWidth / 2 ? 'left' : 'right',\n        speedDialPlacement: -options.fabPosition.top < window.innerHeight / 2 ? 'top' : 'bottom'\n      });\n    });\n    return web.createComponent(Fab.Fab, web.mergeProps({\n      ref: handleMount\n    }, () => store.fab, {\n      get children() {\n        return store.fab.children ?? web.createComponent(web.Dynamic, {\n          get component() {\n            return FabIcon();\n          }\n        });\n      }\n    }));\n  });\n  dom.style.setProperty('z-index', '2147483646', 'important');\n  useSpeedDial(mainContext);\n};\n\nconst MdAutoSync = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M12 4V2.21c0-.45-.54-.67-.85-.35l-2.8 2.79c-.2.2-.2.51 0 .71l2.79 2.79c.32.31.86.09.86-.36V6c3.31 0 6 2.69 6 6 0 .79-.15 1.56-.44 2.25-.15.36-.04.77.23 1.04.51.51 1.37.33 1.64-.34.37-.91.57-1.91.57-2.95 0-4.42-3.58-8-8-8m0 14c-3.31 0-6-2.69-6-6 0-.79.15-1.56.44-2.25.15-.36.04-.77-.23-1.04-.51-.51-1.37-.33-1.64.34C4.2 9.96 4 10.96 4 12c0 4.42 3.58 8 8 8v1.79c0 .45.54.67.85.35l2.79-2.79c.2-.2.2-.51 0-.71l-2.79-2.79a.5.5 0 0 0-.85.36z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\n/** 判断版本号1是否小于版本号2 */\nconst versionLt = (version1, version2) => {\n  const v1 = version1.split('.').map(Number);\n  const v2 = version2.split('.').map(Number);\n  for (let i = 0; i < 3; i++) {\n    const num1 = v1[i] ?? 0;\n    const num2 = v2[i] ?? 0;\n    if (num1 !== num2) return num1 < num2;\n  }\n  return false;\n};\nconst migrationOption = async (name, editFn) => {\n  try {\n    const option = await GM.getValue(name);\n    if (!option) throw new Error(`GM.getValue Error: not found ${name}`);\n    if (await editFn(option)) return;\n    GM.setValue(name, option);\n  } catch (error) {\n    helper.log.error(`migration ${name} option error:`, error);\n  }\n};\n\n/** 重命名配置项 */\nconst renameOption = (name, list) => migrationOption(name, option => {\n  for (const itemText of list) {\n    const [path, newName] = itemText.split(' => ');\n    helper.byPath(option, path, (parent, key) => {\n      helper.log('rename Option', itemText);\n      if (newName) Reflect.set(parent, newName, parent[key]);\n      Reflect.deleteProperty(parent, key);\n    });\n  }\n});\n\n/** 旧版本配置迁移 */\nconst migration = async version => {\n  // 任何样式修改都得更新 css 才行，干脆直接删了\n  GM.deleteValue('ehTagColorizeCss');\n  GM.deleteValue('ehTagSortCss');\n  const values = await GM.listValues();\n\n  // 6 => 7\n  if (versionLt(version, '7')) for (const key of values) {\n    switch (key) {\n      case 'Version':\n      case 'Languages':\n        continue;\n      case 'HotKeys':\n        {\n          await renameOption(key, ['向上翻页 => turn_page_up', '向下翻页 => turn_page_down', '向右翻页 => turn_page_right', '向左翻页 => turn_page_left', '跳至首页 => jump_to_home', '跳至尾页 => jump_to_end', '退出 => exit', '切换页面填充 => switch_page_fill', '切换卷轴模式 => switch_scroll_mode', '切换单双页模式 => switch_single_double_page_mode', '切换阅读方向 => switch_dir', '进入阅读模式 => enter_read_mode']);\n          break;\n        }\n      default:\n        await renameOption(key, ['option.scrollbar.showProgress => showImgStatus', 'option.clickPage => clickPageTurn', 'option.clickPage.overturn => reverse', 'option.swapTurnPage => swapPageTurnKey', 'option.flipToNext => jumpToNext',\n        // ehentai\n        '匹配nhentai => associate_nhentai', '快捷键翻页 => hotkeys_page_turn',\n        // nhentai\n        '自动翻页 => auto_page_turn', '彻底屏蔽漫画 => block_totally', '在新页面中打开链接 => open_link_new_page',\n        // other\n        '记住当前站点 => remember_current_site']);\n    }\n  }\n\n  // 8 => 9\n  if (versionLt(version, '9')) for (const key of values) {\n    switch (key) {\n      case 'Version':\n      case 'Languages':\n        continue;\n      case 'Hotkeys':\n        {\n          await renameOption(key, [\n          // 原本上下快捷键是混在一起的，现在分开后要迁移太麻烦了，应该也没多少人改，就直接删了\n          'turn_page_up => ', 'turn_page_down => ', 'turn_page_right => scroll_right', 'turn_page_left => scroll_left']);\n          break;\n        }\n      default:\n        await migrationOption(key, option => {\n          if (typeof option.option?.scrollMode !== 'boolean') return true;\n          option.option.scrollMode = {\n            enabled: option.option.scrollMode,\n            spacing: option.option.scrollModeSpacing,\n            imgScale: option.option.scrollModeImgScale,\n            fitToWidth: option.option.scrollModeFitToWidth\n          };\n        });\n    }\n  }\n\n  // 9.3 => 9.4\n  if (versionLt(version, '9.4')) await migrationOption('ehentai', option => {\n    if (!Reflect.has(option, 'hotkeys_page_turn')) return true;\n    option.hotkeys = option.hotkeys_page_turn;\n    Reflect.deleteProperty(option, 'hotkeys_page_turn');\n  });\n\n  // 11.4.2 => 11.5\n  if (versionLt(version, '11.5')) await migrationOption('Hotkeys', option => {\n    for (const [name, hotkeys] of Object.entries(option)) {\n      option[name] = hotkeys.map(key => key.replaceAll(/\\b[A-Z]\\b/g, match => match.toLowerCase()));\n    }\n  });\n  if (versionLt(version, '11.9.1')) for (const key of values) {\n    switch (key) {\n      case 'Version':\n      case 'Languages':\n      case 'Hotkeys':\n        continue;\n      default:\n        await renameOption(key, ['option.translation => ']);\n    }\n  }\n\n  // 11.11 => 11.12\n  if (versionLt(version, '11.12')) for (const key of values) {\n    switch (key) {\n      case 'Version':\n      case 'Languages':\n      case 'Hotkeys':\n        continue;\n      default:\n        await renameOption(key, ['associate_nhentai => cross_site_link']);\n    }\n  }\n  if (versionLt(version, '12')) for (const key of values) {\n    switch (key) {\n      case 'Version':\n      case 'Languages':\n      case 'Hotkeys':\n        {\n          await GM.setValue(`@${key}`, await GM.getValue(key));\n          await GM.deleteValue(key);\n          continue;\n        }\n      default:\n        await renameOption(key, ['hotkeys => add_hotkeys_actions']);\n    }\n  }\n};\n\nlet dom;\n\n/**\n * 显示漫画阅读窗口\n */\nconst useManga = ({\n  store,\n  setState,\n  options,\n  setOptions\n}) => {\n  helper.useStyle(`\n    #comicRead {\n      position: fixed;\n      top: 0;\n      left: 0;\n      transform: scale(0);\n\n      contain: strict;\n\n      width: 100%;\n      height: 100%;\n\n      writing-mode: initial;\n      font-size: 16px;\n\n      opacity: 0;\n\n      transition:\n        opacity 300ms,\n        transform 0s 300ms;\n    }\n\n    #comicRead[show] {\n      transform: scale(1);\n      opacity: 1;\n      transition: opacity 300ms, transform 100ms;\n    }\n\n    /* 防止其他扩展的元素显示到漫画上来 */\n    #comicRead[show] ~ :not(#fab, #toast, .comicread-ignore) {\n      display: none !important;\n      pointer-events: none !important;\n      visibility: hidden !important;\n      opacity: 0 !important;\n      z-index: 1 !important;\n    }\n  `);\n  setState('manga', {\n    show: false,\n    option: options.option,\n    defaultOption: options.defaultOption,\n    onOptionChange: option => setOptions({\n      option\n    }),\n    hotkeys: store.hotkeys,\n    onHotkeysChange(newValue) {\n      GM.setValue('@Hotkeys', newValue);\n      setState('hotkeys', newValue);\n    }\n  });\n  dom = helper.mountComponents('comicRead', () => web.createComponent(Manga.Manga, web.mergeProps(() => store.manga)));\n  dom.style.setProperty('z-index', '2147483647', 'important');\n\n  // 确保 toast 可以显示在漫画之上\n  const toastDom = helper.querySelector('#toast');\n  if (toastDom) dom.after(toastDom);\n  const htmlStyle = document.documentElement.style;\n  let lastOverflow = htmlStyle.overflow;\n  const wakeLock = new helper.WakeLock();\n  helper.createEffectOn(helper.createRootMemo(() => store.manga.show && store.manga.imgList.length > 0), show => {\n    if (show) {\n      dom.setAttribute('show', '');\n      lastOverflow = htmlStyle.overflow;\n      htmlStyle.setProperty('overflow', 'hidden', 'important');\n      htmlStyle.setProperty('scrollbar-width', 'none', 'important');\n      if (Manga.store.option.autoFullscreen) Manga.refs.root.requestFullscreen();\n      wakeLock.on();\n    } else {\n      dom.removeAttribute('show');\n      htmlStyle.overflow = lastOverflow;\n      htmlStyle.removeProperty('scrollbar-width');\n      wakeLock.off();\n    }\n  }, {\n    defer: true\n  });\n  setState('manga', {\n    onExit: () => setState('manga', 'show', false),\n    editSettingList(list) {\n      const SyncOptions = () => {\n        const sync = async () => {\n          const currentReadOption = helper.difference(Manga.store.option, Manga.store.defaultOption);\n          for (const key of await GM.listValues()) {\n            if (key.startsWith('@')) continue;\n            await migrationOption(key, option => {\n              option.option = currentReadOption;\n            });\n          }\n          Toast.toast.success(helper.t('setting.sync_options_other_site'));\n        };\n        return web.createComponent(Manga.SettingsItemButton, {\n          get name() {\n            return helper.t('setting.sync_options_other_site');\n          },\n          onClick: sync,\n          get children() {\n            return web.createComponent(MdAutoSync, {});\n          }\n        });\n      };\n\n      // 在其他设置里增加同步配置的按钮\n      const otherSetting = list.find(([title]) => title === helper.t('other.other'));\n      if (otherSetting) {\n        const [, FC] = otherSetting;\n        otherSetting[1] = () => [web.createComponent(FC, {}), web.createComponent(SyncOptions, {})];\n      }\n      return list;\n    }\n  });\n};\n\n\n/** 处理版本更新相关 */\nconst handleVersionUpdate = async () => {\n  const version = await GM.getValue('@Version');\n  if (!version) return GM.setValue('@Version', GM.info.script.version);\n  if (version === GM.info.script.version) return;\n  await migration(version); // 每次版本更新都执行一遍迁移\n\n  // 只在语言为中文时弹窗提示最新更新内容\n  if (helper.lang() === 'zh') {\n    Toast.toast(() => /* eslint-disable i18next/no-literal-string */[(() => {\n      var _el$ = web.template(`<h2>🥳 ComicRead 已更新到 v`)();\n      web.insert(_el$, () => GM.info.script.version, null);\n      return _el$;\n    })(), web.template(`<h3>新增`)(), web.template(`<ul><li>支持 IMHentai`)(), web.template(`<h3>修复`)(), web.template(`<ul><li><p>修复 komiic 上/下话切换失效的 bug </p></li><li><p>修复开启了图像无损放大后只能下载到原图的 bug`)(), web.createComponent(solidJs.Show, {\n      get when() {\n        return versionLt(version, '12');\n      },\n      get children() {\n        return [web.template(`<h3>新增`)(), web.template(`<ul><li>实现图片放大功能（需要打开「图像识别」功能）</li><li>增加 ehentai 在缩略图列表页里展开标签列表功能`)()];\n      }\n    })] /* eslint-enable i18next/no-literal-string */, {\n      id: 'Version Tip',\n      type: 'custom',\n      duration: Number.POSITIVE_INFINITY,\n      // 手动点击关掉通知后才不会再次弹出\n      onDismiss: () => GM.setValue('@Version', GM.info.script.version)\n    });\n\n    // 监听储存的版本数据的变动，如果和当前版本一致就关掉弹窗\n    // 防止在更新版本后一次性打开多个页面，不得不一个一个关过去\n    const listenerId = await GM.addValueChangeListener('@Version', async (_, __, newVersion) => {\n      if (newVersion !== GM.info.script.version) return;\n      Toast.toast.dismiss('Version Tip');\n      await GM.removeValueChangeListener(listenerId);\n    });\n  } else await GM.setValue('@Version', GM.info.script.version);\n};\n\n/** 对基础的初始化操作的封装 */\nconst useInit = async (name, initSiteOptions = {}) => {\n  await helper.setInitLang();\n  await handleVersionUpdate();\n  const defaultOptions = {\n    option: undefined,\n    defaultOption: undefined,\n    autoShow: true,\n    lockOption: false,\n    hiddenFAB: false,\n    fabPosition: {\n      top: 0,\n      left: 0\n    },\n    ...initSiteOptions\n  };\n  const saveOptions = await GM.getValue(name);\n  // 检查清理下已保存配置的多余项\n  if (saveOptions) {\n    for (const key of Object.keys(saveOptions)) {\n      if (Reflect.has(defaultOptions, key)) continue;\n      Reflect.deleteProperty(saveOptions, key);\n    }\n  } else await GM.setValue(name, {});\n  const {\n    store,\n    setState\n  } = helper.useStore({\n    fab: {\n      tip: helper.t('other.read_mode'),\n      show: false\n    },\n    manga: {\n      imgList: []\n    },\n    hotkeys: await GM.getValue('@Hotkeys', {}),\n    name,\n    options: {\n      ...structuredClone(defaultOptions),\n      ...saveOptions\n    },\n    comicMap: {\n      '': {\n        getImgList: function init() {\n          return [];\n        }\n      }\n    },\n    nowComic: '',\n    flag: {\n      isStored: saveOptions !== undefined,\n      needAutoShow: true\n    }\n  });\n  Manga.setDefaultHotkeys(_hotkeys => ({\n    ..._hotkeys,\n    enter_read_mode: ['v']\n  }));\n  const {\n    options\n  } = store;\n  const setOptions = function (newOptions) {\n    if (newOptions) setState(state => Object.assign(state.options, newOptions));\n    if (options.lockOption && newOptions?.lockOption !== false) return;\n    // 只保存和默认设置不同的部分\n    return GM.setValue(store.name, helper.difference(options, defaultOptions));\n  };\n  const loadComic = async (id = store.nowComic) => {\n    if (!Reflect.has(store.comicMap, id)) throw new Error('comic not found');\n    try {\n      setState('comicMap', id, 'imgList', []);\n      const newImgList = await store.comicMap[id].getImgList(main);\n      if (newImgList.length === 0) throw new Error(helper.t('alert.fetch_comic_img_failed'));\n      setState('comicMap', id, 'imgList', newImgList);\n    } catch (error) {\n      setState('comicMap', id, 'imgList', undefined);\n      helper.log.error(error);\n      throw error;\n    }\n  };\n  const showComic = async (id = store.nowComic) => {\n    if (!Reflect.has(store.comicMap, id)) throw new Error('comic not found');\n    if (id !== store.nowComic) setState('nowComic', id);\n    switch (store.comicMap[id].imgList?.length) {\n      case 0:\n        return Toast.toast.warn(helper.t('alert.repeat_load'), {\n          duration: 1500\n        });\n      case undefined:\n        {\n          try {\n            await loadComic(id);\n            setState('flag', 'needAutoShow', false);\n          } catch (error) {\n            return Toast.toast.error(error.message);\n          }\n        }\n    }\n    setState('manga', 'show', true);\n  };\n  let inited = false;\n  const init = () => {\n    if (inited) return;\n    inited = true;\n    setState('fab', {\n      onClick: showComic,\n      show: !options.hiddenFAB && undefined\n    });\n    if (store.flag.needAutoShow && options.autoShow) showComic();\n    (async () => {\n      await GM.registerMenuCommand(helper.t('other.enter_comic_read_mode'), () => store.fab.onClick?.());\n      await updateHideFabMenu();\n    })();\n    Manga.listenHotkey({\n      enter_read_mode: () => store.fab.onClick?.()\n    }, true);\n  };\n\n  // 首次设置默认漫画的加载函数时，进行初始化\n  helper.createEffectOn(() => store.comicMap[''].getImgList, (_, prev) => !prev && init(), {\n    defer: true\n  });\n  const main = {\n    store,\n    setState,\n    options,\n    setOptions,\n    loadComic,\n    showComic,\n    init,\n    dynamicLoad: async (loadImgFn, length, id = '') => {\n      if (store.comicMap[id].imgList?.length) return store.comicMap[id].imgList;\n      const imgNum = typeof length === 'number' ? length : length();\n      setState('comicMap', id, 'imgList', helper.range(imgNum, ''));\n      // oxlint-disable-next-line no-async-promise-executor\n      await new Promise(async resolve => {\n        try {\n          await loadImgFn((i, img) => {\n            setState('comicMap', id, 'imgList', list => list.with(i, img));\n            resolve();\n          });\n        } catch (error) {\n          Toast.toast.error(error.message);\n        }\n      });\n      return store.comicMap[id].imgList;\n    },\n    dynamicLazyLoad: async ({\n      loadImg,\n      length,\n      id = '',\n      concurrency = 4,\n      onEnd\n    }) => {\n      if (store.comicMap[id].imgList?.length) return store.comicMap[id].imgList;\n      const imgNum = typeof length === 'number' ? length : length();\n      let loadNum = 0;\n\n      // oxlint-disable-next-line no-async-promise-executor\n      await new Promise(resolve => {\n        const queue = new helper.PQueue(async i => {\n          const img = await loadImg(i);\n          setState('comicMap', id, 'imgList', list => list.with(i, img));\n          resolve();\n          loadNum += 1;\n          if (loadNum === imgNum) onEnd?.();\n        }, concurrency);\n        setState(state => {\n          state.comicMap[id].imgList = helper.range(imgNum, '');\n          state.manga.onWaitUrlImgs = imgs => queue.set(...imgs);\n        });\n      });\n      return store.comicMap[id].imgList;\n    }\n  };\n  useFab(main);\n  useManga(main);\n  const nowImgList = helper.createRootMemo(() => {\n    const comic = store.comicMap[store.nowComic];\n    if (!comic?.imgList) return undefined;\n    if (!comic.adList?.size) return comic.imgList;\n    return comic.imgList.filter((_, i) => !comic.adList?.has(i));\n  });\n  helper.createEffectOn(nowImgList, list => list && setState('manga', 'imgList', list));\n\n  /** 当前已取得 url 的图片数量 */\n  const doneImgNum = helper.createRootMemo(() => nowImgList()?.filter(Boolean)?.length);\n\n  /** 已加载完毕的图片数量 */\n  const loadedImgNum = helper.createRootMemo(() => {\n    let i = 0;\n    for (const img of Manga.imgList()) if (img.loadType === 'loaded') i += 1;\n    return i;\n  });\n\n  // 设置 Fab 的显示进度\n  helper.createEffectOn([doneImgNum, loadedImgNum, () => nowImgList()?.length], ([doneNum, loadNum, totalNum]) => {\n    if (totalNum === undefined || doneNum === undefined) return setState('fab', 'progress', undefined);\n    if (totalNum === 0) return setState('fab', {\n      progress: 0,\n      tip: `${helper.t('other.loading_img')} - ${doneNum}/${totalNum}`\n    });\n\n    // 加载图片 url 阶段的进度\n    if (doneNum < totalNum) return setState('fab', {\n      progress: doneNum / totalNum,\n      tip: `${helper.t('other.loading_img')} - ${doneNum}/${totalNum}`\n    });\n\n    // 图片加载阶段的进度\n    if (loadNum < totalNum) return setState('fab', {\n      progress: 1 + loadNum / totalNum,\n      tip: `${helper.t('other.img_loading')} - ${loadNum}/${totalNum}`\n    });\n    return setState('fab', {\n      progress: 1 + loadNum / totalNum,\n      tip: helper.t('other.read_mode'),\n      show: !options.hiddenFAB && undefined\n    });\n  });\n  let menuId;\n  /** 更新显示/隐藏悬浮按钮的菜单项 */\n  const updateHideFabMenu = async () => {\n    await GM.unregisterMenuCommand(menuId);\n    menuId = await GM.registerMenuCommand(options.hiddenFAB ? helper.t('other.fab_show') : helper.t('other.fab_hidden'), async () => {\n      await setOptions({\n        hiddenFAB: !options.hiddenFAB\n      });\n      setState('fab', 'show', !options.hiddenFAB && undefined);\n      await updateHideFabMenu();\n    });\n  };\n  await GM.registerMenuCommand(helper.t('site.show_settings_menu'), () => setState('fab', {\n    show: true,\n    focus: true,\n    tip: helper.t('other.setting'),\n    children: web.createComponent(MdSettings, {}),\n    onBackdropClick: () => setState('fab', {\n      show: false,\n      focus: false\n    })\n  }));\n  return main;\n};\n\n/** 对简单站点的通用解 */\nconst universal = async ({\n  name,\n  wait: waitFn,\n  getImgList,\n  onPrev,\n  onNext,\n  onExit,\n  onShowImgsChange,\n  getCommentList,\n  initOptions,\n  SPA\n}) => {\n  if (SPA?.isMangaPage) await helper.waitUrlChange(SPA.isMangaPage);\n  if (waitFn) await helper.wait(waitFn);\n  const mainContext = await useInit(name, initOptions);\n  const {\n    store,\n    setState,\n    showComic\n  } = mainContext;\n  setState('comicMap', '', {\n    getImgList: () => getImgList(mainContext)\n  });\n  setState('manga', {\n    onShowImgsChange\n  });\n  if (onExit) setState('manga', {\n    onExit: isEnd => {\n      onExit?.(isEnd);\n      setState('manga', 'show', false);\n    }\n  });\n  if (!SPA) {\n    if (onNext ?? onPrev) setState('manga', {\n      onNext,\n      onPrev\n    });\n    if (getCommentList) setState('manga', 'commentList', await getCommentList());\n    return;\n  }\n  helper.onUrlChange(async () => {\n    if (SPA.isMangaPage && !(await SPA.isMangaPage())) return setState(state => {\n      state.fab.show = false;\n      state.manga.show = false;\n      state.comicMap[''].imgList = undefined;\n    });\n    if (waitFn) await helper.wait(waitFn);\n    setState(state => {\n      state.fab.show = undefined;\n      state.manga.onPrev = undefined;\n      state.manga.onNext = undefined;\n      state.flag.needAutoShow = state.options.autoShow;\n      state.comicMap[''].imgList = undefined;\n    });\n    if (store.options.autoShow) await showComic('');\n    await Promise.all([(async () => getCommentList && setState('manga', 'commentList', await getCommentList()))(), (async () => SPA.getOnPrev && setState('manga', {\n      onPrev: await helper.wait(SPA.getOnPrev, 5000)\n    }))(), (async () => SPA.getOnNext && setState('manga', {\n      onNext: await helper.wait(SPA.getOnNext, 5000)\n    }))()]);\n  }, SPA?.handleUrl);\n};\n\nconst MdAutoFixHigh = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"m20.45 6 .49-1.06L22 4.45a.5.5 0 0 0 0-.91l-1.06-.49L20.45 2a.5.5 0 0 0-.91 0l-.49 1.06-1.05.49a.5.5 0 0 0 0 .91l1.06.49.49 1.05c.17.39.73.39.9 0M8.95 6l.49-1.06 1.06-.49a.5.5 0 0 0 0-.91l-1.06-.48L8.95 2a.492.492 0 0 0-.9 0l-.49 1.06-1.06.49a.5.5 0 0 0 0 .91l1.06.49L8.05 6c.17.39.73.39.9 0m10.6 7.5-.49 1.06-1.06.49a.5.5 0 0 0 0 .91l1.06.49.49 1.06a.5.5 0 0 0 .91 0l.49-1.06 1.05-.5a.5.5 0 0 0 0-.91l-1.06-.49-.49-1.06c-.17-.38-.73-.38-.9.01m-1.84-4.38-2.83-2.83a.996.996 0 0 0-1.41 0L2.29 17.46a.996.996 0 0 0 0 1.41l2.83 2.83c.39.39 1.02.39 1.41 0L17.7 10.53c.4-.38.4-1.02.01-1.41m-3.5 2.09L12.8 9.8l1.38-1.38 1.41 1.41z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdAutoFixOff = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"m22 3.55-1.06-.49L20.45 2a.5.5 0 0 0-.91 0l-.49 1.06-1.05.49a.5.5 0 0 0 0 .91l1.06.49.49 1.05a.5.5 0 0 0 .91 0l.49-1.06L22 4.45c.39-.17.39-.73 0-.9m-7.83 4.87 1.41 1.41-1.46 1.46 1.41 1.41 2.17-2.17a.996.996 0 0 0 0-1.41l-2.83-2.83a.996.996 0 0 0-1.41 0l-2.17 2.17 1.41 1.41zM2.1 4.93l6.36 6.36-6.17 6.17a.996.996 0 0 0 0 1.41l2.83 2.83c.39.39 1.02.39 1.41 0l6.17-6.17 6.36 6.36a.996.996 0 1 0 1.41-1.41L3.51 3.51a.996.996 0 0 0-1.41 0c-.39.4-.39 1.03 0 1.42\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdFlashOff = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M16.12 11.5a.995.995 0 0 0-.86-1.5h-1.87l2.28 2.28zm.16-8.05c.33-.67-.15-1.45-.9-1.45H8c-.55 0-1 .45-1 1v.61l6.13 6.13zm2.16 14.43L4.12 3.56a.996.996 0 1 0-1.41 1.41L7 9.27V12c0 .55.45 1 1 1h2v7.15c0 .51.67.69.93.25l2.65-4.55 3.44 3.44c.39.39 1.02.39 1.41 0 .4-.39.4-1.02.01-1.41\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdFlashOn = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M7 3v9c0 .55.45 1 1 1h2v7.15c0 .51.67.69.93.25l5.19-8.9a.995.995 0 0 0-.86-1.5H13l2.49-6.65A.994.994 0 0 0 14.56 2H8c-.55 0-1 .45-1 1\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdLockOpen = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M12 13c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m6-5h-1V6c0-2.76-2.24-5-5-5-2.28 0-4.27 1.54-4.84 3.75-.14.54.18 1.08.72 1.22a1 1 0 0 0 1.22-.72A2.996 2.996 0 0 1 12 3c1.65 0 3 1.35 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2m0 11c0 .55-.45 1-1 1H7c-.55 0-1-.45-1-1v-8c0-.55.45-1 1-1h10c.55 0 1 .45 1 1z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdLock = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2m-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2M9 8V6c0-1.66 1.34-3 3-3s3 1.34 3 3v2z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst useSpeedDial = ({\n  store,\n  setState,\n  options,\n  setOptions\n}) => {\n  const DefaultButton = props => web.createComponent(IconButton.IconButton, {\n    get placement() {\n      return store.fab.placement;\n    },\n    showTip: true,\n    get tip() {\n      return props.showName ?? (helper.t(`site.add_feature.${props.optionName}`) || helper.t(`other.${props.optionName}`) || props.optionName);\n    },\n    onClick: () => setOptions({\n      [props.optionName]: !options[props.optionName]\n    }),\n    get children() {\n      return props.children ?? (options[props.optionName] ? web.createComponent(MdAutoFixHigh, {}) : web.createComponent(MdAutoFixOff, {}));\n    }\n  });\n  helper.createEffectOn(() => store.fab.otherSpeedDial, () => {\n    const list = [() => web.createComponent(DefaultButton, {\n      optionName: \"autoShow\",\n      get showName() {\n        return helper.t('site.add_feature.auto_show');\n      },\n      get children() {\n        return web.memo(() => !!options.autoShow)() ? web.createComponent(MdFlashOn, {}) : web.createComponent(MdFlashOff, {});\n      }\n    }), () => web.createComponent(DefaultButton, {\n      optionName: \"lockOption\",\n      get showName() {\n        return helper.t('site.add_feature.lock_option');\n      },\n      get children() {\n        return web.memo(() => !!options.lockOption)() ? web.createComponent(MdLock, {}) : web.createComponent(MdLockOpen, {});\n      }\n    })];\n    if (store.fab.otherSpeedDial) {\n      for (const optionName of store.fab.otherSpeedDial) list.push(() => web.createComponent(DefaultButton, {\n        optionName: optionName\n      }));\n    } else {\n      for (const optionName of Object.keys(options)) {\n        switch (optionName) {\n          case 'hiddenFAB':\n          case 'option':\n          case 'autoShow':\n          case 'lockOption':\n            continue;\n          default:\n            if (typeof options[optionName] === 'boolean') list.push(() => web.createComponent(DefaultButton, {\n              optionName: optionName\n            }));\n        }\n      }\n    }\n    setState('fab', 'speedDial', list);\n  });\n};\n\nconst triggerOptions = !web.isServer && solidJs.DEV ? { equals: false, name: \"trigger\" } : { equals: false };\nconst triggerCacheOptions = !web.isServer && solidJs.DEV ? { equals: false, internal: true } : triggerOptions;\nclass TriggerCache {\n    #map;\n    constructor(mapConstructor = Map) {\n        this.#map = new mapConstructor();\n    }\n    dirty(key) {\n        if (web.isServer)\n            return;\n        this.#map.get(key)?.$$();\n    }\n    dirtyAll() {\n        if (web.isServer)\n            return;\n        for (const trigger of this.#map.values())\n            trigger.$$();\n    }\n    track(key) {\n        if (!solidJs.getListener())\n            return;\n        let trigger = this.#map.get(key);\n        if (!trigger) {\n            const [$, $$] = solidJs.createSignal(undefined, triggerCacheOptions);\n            this.#map.set(key, (trigger = { $, $$, n: 1 }));\n        }\n        else\n            trigger.n++;\n        solidJs.onCleanup(() => {\n            // remove the trigger when no one is listening to it\n            if (--trigger.n === 0)\n                // microtask is to avoid removing the trigger used by a single listener\n                queueMicrotask(() => trigger.n === 0 && this.#map.delete(key));\n        });\n        trigger.$();\n    }\n}\n\nconst $KEYS = Symbol(\"track-keys\");\n/**\n * A reactive version of a Javascript built-in `Set` class.\n * @see https://github.com/solidjs-community/solid-primitives/tree/main/packages/set#ReactiveSet\n * @example\n * const set = new ReactiveSet([1,2,3]);\n * [...set] // reactive on any change\n * set.has(2) // reactive on change to the result\n * // apply changes\n * set.add(4)\n * set.delete(2)\n * set.clear()\n */\nclass ReactiveSet extends Set {\n    #triggers = new TriggerCache();\n    constructor(values) {\n        super();\n        if (values)\n            for (const value of values)\n                super.add(value);\n    }\n    [Symbol.iterator]() {\n        return this.values();\n    }\n    get size() {\n        this.#triggers.track($KEYS);\n        return super.size;\n    }\n    has(value) {\n        this.#triggers.track(value);\n        return super.has(value);\n    }\n    keys() {\n        return this.values();\n    }\n    *values() {\n        this.#triggers.track($KEYS);\n        for (const value of super.values()) {\n            yield value;\n        }\n    }\n    *entries() {\n        this.#triggers.track($KEYS);\n        for (const entry of super.entries()) {\n            yield entry;\n        }\n    }\n    forEach(callbackfn, thisArg) {\n        this.#triggers.track($KEYS);\n        super.forEach(callbackfn, thisArg);\n    }\n    add(value) {\n        if (!super.has(value)) {\n            super.add(value);\n            solidJs.batch(() => {\n                this.#triggers.dirty(value);\n                this.#triggers.dirty($KEYS);\n            });\n        }\n        return this;\n    }\n    delete(value) {\n        const result = super.delete(value);\n        if (result) {\n            solidJs.batch(() => {\n                this.#triggers.dirty(value);\n                this.#triggers.dirty($KEYS);\n            });\n        }\n        return result;\n    }\n    clear() {\n        if (!super.size)\n            return;\n        solidJs.batch(() => {\n            this.#triggers.dirty($KEYS);\n            for (const member of super.values()) {\n                this.#triggers.dirty(member);\n            }\n            super.clear();\n        });\n    }\n}\n\nexports.toast = Toast.toast;\nexports.request = request.request;\nexports.ReactiveSet = ReactiveSet;\nexports.handleVersionUpdate = handleVersionUpdate;\nexports.universal = universal;\nexports.useInit = useInit;\nexports.useSpeedDial = useSpeedDial;\n";break;case"worker/detectAd":c="\nconst jsQR = require('jsqr');\n\nconst mainFn = {};\nconst setMainFn = (helper, keys) => {\n  for (const name of keys) Reflect.set(mainFn, name, (...args) => Reflect.apply(helper[name], helper, args));\n};\n\n/** 计算 rgb 的灰度 */\nconst toGray = (r, g, b) => Math.round(0.299 * r + 0.587 * g + 0.114 * b);\n\n// jsQR 最为简洁，但不支持包含多个二维码的图片\n// https://github.com/cozmo/jsQR/issues/24\n//\n// ZXing 可以扫描包含多个二维码的图片，但因为同时支持多种编码，\n// 包含了很多根本不需要的代码，用在这里感觉太牛刀杀鸡了\n//\n// qr-scanner 基于上述两个库进行开发，是最优选。但会收到 CSP 限制而无法使用\n/** 判断一张图是否是彩图 */\nconst isColorImg = data => {\n  for (let i = 0; i < data.length; i += 16) {\n    const r = data[i];\n    const g = data[i + 1];\n    const b = data[i + 2];\n    if (!(r === g && r === b)) return true;\n  }\n  return false;\n};\n\n/** 二维码白名单 */\nconst qrCodeWhiteList = [\n// fanbox\n/^https:\\/\\/[^.]+\\.fanbox\\.cc/,\n// twitter\n/^https:\\/\\/twitter\\.com/, /^https:\\/\\/x\\.com/,\n// fantia\n/^https:\\/\\/fantia\\.jp/,\n// 棉花糖\n/^https:\\/\\/marshmallow-qa\\.com/,\n// dlsite\n/^https:\\/\\/www\\.dlsite\\.com/,\n// hitomi\n/^https:\\/\\/hitomi\\.la/];\nconst options = {\n  inversionAttempts: 'attemptBoth'\n};\n\n/** 识别图像上的二维码 */\nconst getQrCode = (img, width, height) => {\n  try {\n    const binaryData = jsQR(img, width, height, options)?.binaryData;\n    if (!binaryData) return false;\n    // 因为 jsqr 默认的输出不支持特殊符号，为以防万一，手动进行转换\n    const text = new TextDecoder().decode(Uint8Array.from(binaryData));\n    mainFn.log(`检测到二维码： ${text}`);\n    return text;\n  } catch (error) {\n    mainFn.log(error);\n    return undefined;\n  }\n};\n\n// zxing 方案\n//\n// import {\n//   MultiFormatReader,\n//   BarcodeFormat,\n//   DecodeHintType,\n//   RGBLuminanceSource,\n//   BinaryBitmap,\n//   HybridBinarizer,\n// } from '@zxing/library';\n//\n// const hints = new Map();\n// // 只识别二维码\n// hints.set(DecodeHintType.POSSIBLE_FORMATS, [\n//   BarcodeFormat.QR_CODE,\n//   BarcodeFormat.DATA_MATRIX,\n// ]);\n// // 花更多时间尝试寻找条形码\n// hints.set(DecodeHintType.TRY_HARDER, true);\n//\n// /** 识别图像上的二维码 */\n// const getQrCode = (\n//   data: Uint8ClampedArray,\n//   width: number,\n//   height: number,\n// ) => {\n//   try {\n//     const luminance = new Uint8ClampedArray(width * height);\n//     for (let i = 0; i < data.length; i += 4) {\n//       const r = data[i];\n//       const g = data[i + 1];\n//       const b = data[i + 2];\n//       luminance[i / 4] = (r + g + b) / 3;\n//     }\n//     const luminanceSource = new RGBLuminanceSource(luminance, width, height);\n//     const binaryBitmap = new BinaryBitmap(new HybridBinarizer(luminanceSource));\n//     const res = new MultiFormatReader().decode(binaryBitmap, hints);\n//     const text = res.getText();\n//     if (!text) return false;\n//     mainFn.log(`检测到二维码： ${text}`);\n//     return text;\n//   } catch (error) {\n//     console.log(error);\n//     debugger;\n//     return false;\n//   }\nconst getImgData = img => {\n  const canvas = new OffscreenCanvas(img.width, img.height);\n  const ctx = canvas.getContext('2d');\n  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);\n  return ctx.getImageData(0, 0, canvas.width, canvas.height);\n};\nconst scanImgBlock = (img, sx, sy, w, h) => {\n  if (w === img.width && h === img.height) return getQrCode(img.data, w, h);\n  const data = new Uint8ClampedArray(new ArrayBuffer(w * h * 4));\n  for (let y = 0, height = sy + h; y < height; y++) for (let x = 0, width = sx + w; x < width; x++) {\n    const i = (y * w + x) * 4;\n    const target = ((y + sy) * img.width + (x + sx)) * 4;\n    data[i] = img.data[target];\n    data[i + 1] = img.data[target + 1];\n    data[i + 2] = img.data[target + 2];\n    data[i + 3] = img.data[target + 3];\n  }\n  return getQrCode(data, w, h);\n};\nconst isAdImg = imgBitmap => {\n  const imgData = getImgData(imgBitmap);\n\n  // 黑白图肯定不是广告\n  if (!isColorImg(imgData.data)) return false;\n\n  // 以 200 灰度为阈值，将图片二值化，以便识别彩色二维码\n  for (let i = 0; i < imgData.data.length; i += 4) {\n    const gray = toGray(imgData.data[i], imgData.data[i + 1], imgData.data[i + 2]);\n    const val = gray < 200 ? 0 : 255;\n    imgData.data[i] = val;\n    imgData.data[i + 1] = val;\n    imgData.data[i + 2] = val;\n    imgData.data[i + 3] = 255;\n  }\n\n  // mainFn.showCanvas?.(imgData.data, imgBitmap.width, imgBitmap.height);\n\n  let text = getQrCode(imgData.data, imgData.width, imgData.height);\n\n  // 分区块扫描图片\n  if (!text) {\n    const w = Math.floor(imgData.width / 2);\n    const h = Math.floor(imgData.height / 2);\n    for (const args of [[w, h],\n    // ↘\n    [0, h],\n    // ↙\n    [w, 0],\n    // ↗\n    [0, 0] // ↖\n    ]) {\n      text = scanImgBlock(imgData, ...args, w, h);\n      if (text) break;\n    }\n  }\n  if (text) return qrCodeWhiteList.every(reg => !reg.test(text));\n  return false;\n};\n\nexports.isAdImg = isAdImg;\nexports.setMainFn = setMainFn;\n";break;case"worker/ImageRecognition":c="\nconst mainFn = {};\nconst setMainFn = (helper, keys) => {\n  for (const name of keys) Reflect.set(mainFn, name, (...args) => Reflect.apply(helper[name], helper, args));\n};\nconst getEdgeScope = (width, height) => Math.min(Math.ceil((width + height) * 0.01), 10);\n\n/** 对指定数值取整 */\nconst round = (n, int) => {\n  const remainder = n % int;\n  return remainder < int / 2 ? n - remainder : n + (int - remainder);\n};\n\n/** 计算 rgb 的灰度 */\nconst toGray = (r, g, b) => Math.round(0.299 * r + 0.587 * g + 0.114 * b);\n\n/** 获取图片的灰度表 */\nconst toGrayList = (imgData, roundNum) => {\n  const grayList = new Uint8ClampedArray(new ArrayBuffer(imgData.length / 4));\n  for (let i = 0, gi = 0; i < imgData.length; i += 4, gi++) {\n    const r = imgData[i];\n    const g = imgData[i + 1];\n    const b = imgData[i + 2];\n    grayList[gi] = round(toGray(r, g, b), roundNum);\n  }\n  return grayList;\n};\n\n/** 遍历图片的指定行 */\nconst forEachRows = (width, y, fn, start = 0, end = width) => {\n  for (let i = start; i < end; i++) fn(width * y + i);\n};\n\n/** 遍历图片的指定列 */\nconst forEachCols = (width, height, x, fn, start = 0, end = height) => {\n  for (let i = start; i < end; i++) fn(i * width + x);\n};\n\n/** 遍历图片的边缘 */\nconst forEachEdge = (width, height, scope, fn) => {\n  for (let i = 0; i < scope; i++) {\n    forEachRows(width, i, fn);\n    forEachRows(width, height - i - 1, fn);\n    forEachCols(width, height, i, fn, scope, height - scope);\n    forEachCols(width, height, width - i - 1, fn, scope, height - scope);\n  }\n};\n\n/** 缩小图像 */\nconst resizeImg = (rawImgData, width, height) => {\n  // const scale = 1;\n  const scale = Math.min(200 / width, 200 / height);\n  const w = Math.floor(width * scale);\n  const h = Math.floor(height * scale);\n  const data = new Uint8ClampedArray(new ArrayBuffer(w * h * 4));\n  for (let y = 0; y < h; y++) {\n    for (let x = 0; x < w; x++) {\n      // 使用最简单的采样方式，避免出现原图所没有的颜色\n      const i = (y * w + x) * 4;\n      const tx = Math.floor(x / scale);\n      const ty = Math.floor(y / scale);\n      const target = (width * ty + tx) * 4;\n      data[i] = rawImgData[target];\n      data[i + 1] = rawImgData[target + 1];\n      data[i + 2] = rawImgData[target + 2];\n      data[i + 3] = 255;\n    }\n  }\n  return {\n    scale,\n    w,\n    h,\n    data\n  };\n};\n\n/** 通过互相比较数组项求出最终项 */\nconst boil = (array, compareFunc) => {\n  if (!array || (array.length ?? 0) === 0) return null;\n  return array.reduce(compareFunc);\n};\n\n/** 获取颜色区域在边缘区域上的占比 */\nconst getAreaEdgeRatio = (pixelList, width, height) => {\n  let size = 0;\n  const edgeScope = getEdgeScope(width, height);\n  const add = i => pixelList.has(i) && size++;\n  forEachEdge(width, height, edgeScope, add);\n  return size / (width * edgeScope * 2 + (height - 2 * edgeScope) * edgeScope * 2);\n};\n\n/** 根据灰度值获取图片边缘相似颜色的区域 */\nconst getEdgeArea = (grayList, width, height) => {\n  const maximum = width * height * 0.4;\n  const areaMap = new Map();\n\n  /** 待检查相邻像素的像素 */\n  const seedPixel = new Set();\n  const addSeedPixel = index => {\n    const gray = grayList[index];\n    if (gray === undefined) return;\n    seedPixel.add(index);\n    if (!areaMap.has(gray)) areaMap.set(gray, new Set());\n    areaMap.get(gray).add(index);\n  };\n  const popSeedPixel = () => {\n    if (seedPixel.size === 0) return undefined;\n    const index = seedPixel.values().next().value;\n    seedPixel.delete(index);\n    return index;\n  };\n\n  // 将边缘区域的像素设为种子\n  const edgeScope = getEdgeScope(width, height);\n  forEachEdge(width, height, edgeScope, addSeedPixel);\n\n  /** 获取相邻像素 */\n  const getAdjacentPixel = i => {\n    const adjacentPixel = [];\n    const x = i % width;\n    const y = Math.floor(i / width);\n    const left = x !== 0;\n    const up = y >= 1;\n    const right = x < width - 1;\n    const down = y < height - 1;\n    if (left) adjacentPixel.push(i - 1); // ←\n    if (up) adjacentPixel.push(i - width); // ↑\n    if (right) adjacentPixel.push(i + 1); // →\n    if (down) adjacentPixel.push(i + width); // ↓\n    if (left && up) adjacentPixel.push(i - width - 1); // ↖\n    if (left && down) adjacentPixel.push(i + width - 1); // ↙\n    if (right && up) adjacentPixel.push(i - width + 1); // ↗\n    if (right && down) adjacentPixel.push(i + width + 1); // ↘\n\n    return adjacentPixel;\n  };\n\n  // 从种子像素开始不断合并相同灰度的像素形成区域\n  for (let i = popSeedPixel(); i !== undefined; i = popSeedPixel()) {\n    const gray = grayList[i];\n    const areaPixelList = areaMap.get(gray);\n    const adjacentPixelList = getAdjacentPixel(i);\n    for (const adjacentPixel of adjacentPixelList) {\n      if (areaPixelList.has(adjacentPixel)) continue;\n      const pixelGray = grayList[adjacentPixel];\n      if (pixelGray !== gray) continue;\n      addSeedPixel(adjacentPixel);\n    }\n\n    // 如果当前区域像素数量超过阈值，就直接认定其为背景\n    if (areaPixelList.size > maximum) return [areaPixelList];\n  }\n  const areaList = [];\n  for (const pixelList of areaMap.values()) {\n    if (pixelList.size < 100) continue;\n    areaList.push(pixelList);\n  }\n  return areaList;\n};\n\n/** 获取图像指定区域中的主色 */\nconst getAreaColor = (imgData, pixelList) => {\n  const colorMap = new Map();\n  const maximum = pixelList.size * 0.5;\n  let maxColor = '';\n  let maxCount = 0;\n  for (const i of pixelList.values()) {\n    const index = i * 4;\n    const r = imgData[index];\n    const g = imgData[index + 1];\n    const b = imgData[index + 2];\n    const color = `rgb(${r}, ${g}, ${b})`;\n    if (!colorMap.has(color)) colorMap.set(color, 0);\n    const colorCount = colorMap.get(color) + 1;\n    colorMap.set(color, colorCount);\n    if (colorCount > maxCount) {\n      maxColor = color;\n      maxCount = colorCount;\n    }\n    if (colorCount > maximum) break;\n  }\n  return maxColor;\n};\n\n/** 获取图像指定矩形区域中的主色 */\nconst getSquareAreaColor = (imgData, _topLeftX, _topLeftY, _bottomRightX, _bottomRightY) => {\n  const topLeftX = Math.floor(_topLeftX);\n  const topLeftY = Math.floor(_topLeftY);\n  const bottomRightX = Math.floor(_bottomRightX);\n  const bottomRightY = Math.floor(_bottomRightY);\n  const colorMap = new Map();\n  const maximum = (bottomRightX - topLeftX) * (bottomRightY - topLeftY) * 0.5;\n  let maxColor = '';\n  let maxCount = 0;\n  for (let x = topLeftX; x < bottomRightX; x++) {\n    for (let y = topLeftY; y < bottomRightY; y++) {\n      const index = (x + y * bottomRightX) * 4;\n      const r = imgData[index];\n      const g = imgData[index + 1];\n      const b = imgData[index + 2];\n      const color = `rgb(${r}, ${g}, ${b})`;\n      if (!colorMap.has(color)) colorMap.set(color, 0);\n      const colorCount = colorMap.get(color) + 1;\n      colorMap.set(color, colorCount);\n      if (colorCount > maxCount) {\n        maxColor = color;\n        maxCount = colorCount;\n      }\n      if (colorCount > maximum) break;\n    }\n  }\n  return maxColor;\n};\n\n/** 根据边缘颜色区域获取背景颜色 */\nconst byEdgeArea = ({\n  data,\n  grayList,\n  width,\n  height\n}) => {\n  const areaList = getEdgeArea(grayList, width, height);\n  // if (false) mainFn.showColorArea?.(data, width, height, ...areaList);\n\n  if (areaList.length === 0) return undefined;\n  const minimum = width * height * 0.02;\n  let maxArea;\n  let maxRatio = 0.1;\n\n  // 过滤总体占比和边缘占比过小的区域\n  for (const pixelList of areaList) {\n    if (pixelList.size < minimum) continue;\n    const edgeRatio = getAreaEdgeRatio(pixelList, width, height);\n    if (edgeRatio < maxRatio) continue;\n    maxArea = pixelList;\n    maxRatio = edgeRatio;\n  }\n  if (!maxArea) return undefined;\n  return getAreaColor(data, maxArea);\n};\nconst getPosAreaColor = (pos, {\n  data,\n  blankMargin,\n  width: w,\n  height: h\n}) => {\n  switch (pos) {\n    case 'top':\n      return getSquareAreaColor(data, 0, 0, w, blankMargin.top * h);\n    case 'bottom':\n      return getSquareAreaColor(data, 0, h - blankMargin.bottom * h, w, h);\n    case 'left':\n      return getSquareAreaColor(data, 0, 0, blankMargin.left * w, h);\n    case 'right':\n      return getSquareAreaColor(data, w - blankMargin.right * w, 0, w, h);\n  }\n};\n\n/** 从足够大的空白边缘中获取背景颜色 */\nconst byBlankMargin = context => {\n  const colorMap = {};\n  for (const pos of ['top', 'bottom', 'left', 'right']) {\n    if (!context.blankMargin[pos]) continue;\n    const color = getPosAreaColor(pos, context);\n    if (!color) continue;\n    colorMap[color] = (colorMap[color] || 0) + context.blankMargin[pos];\n  }\n\n  // 过滤占比过低的空白边缘\n  const colorList = Object.entries(colorMap).filter(([, v]) => v > 0.04);\n  if (colorList.length === 0) return undefined;\n  return boil(colorList, (a, b) => a[1] > b[1] ? a : b)?.[0];\n};\n\n/** 判断图像的背景色 */\nconst getBackground = context => 'blankMargin' in context && byBlankMargin(context) || byEdgeArea(context);\n\n/** 获取图片空白边缘的长度 */\nconst getBlankMargin = ({\n  grayList,\n  width,\n  height\n}) => {\n  let blankColor;\n\n  // 检查指定行或列上是否全是相同颜色\n  const isBlankLine = (x, y) => {\n    const colorMap = new Map();\n    const eachFn = i => {\n      const gray = grayList[i];\n      colorMap.set(gray, (colorMap.get(gray) || 0) + 1);\n      // grayList[i] = Math.abs(gray - 255);\n    };\n    if (x < 0) forEachRows(width, y, eachFn);else forEachCols(width, height, x, eachFn);\n    let maxColor;\n    // 为了能跳过些微色差和漫画水印，阈值就只设为 90%\n    let maxNum = height * 0.9;\n    for (const [gray, num] of colorMap.entries()) {\n      if (num < maxNum) continue;\n      maxColor = gray;\n      maxNum = num;\n    }\n    if (maxColor === undefined) return false;\n    blankColor ||= maxColor;\n    if (maxColor !== blankColor) return false;\n    return true;\n  };\n  let left = 0;\n  for (let x = 0, end = width * 0.4; x < end; x++, left++) if (!isBlankLine(x, -1)) break;\n  blankColor = undefined;\n  let right = 0;\n  for (let x = width - 1, end = width * 0.6; x >= end; x--, right++) if (!isBlankLine(x, -1)) break;\n  blankColor = undefined;\n  let top = 0;\n  for (let y = 0, end = height * 0.4; y < end; y++, top++) if (!isBlankLine(-1, y)) break;\n  blankColor = undefined;\n  let bottom = 0;\n  for (let y = height - 1, end = height * 0.6; y >= end; y--, bottom++) if (!isBlankLine(-1, y)) break;\n\n  // if (false) mainFn.showGrayList?.(grayList, width, height);\n\n  if (left || right || top || bottom) return {\n    left,\n    right,\n    top,\n    bottom\n  };\n  return undefined;\n};\n\nconst recognitionImg = async (imgData, width, height, url, option) => {\n  const startTime = Date.now();\n  const {\n    w,\n    h,\n    data\n  } = resizeImg(imgData, width, height);\n  // if (false) mainFn.showCanvas?.(data, w, h);\n\n  const grayList = toGrayList(data, 5);\n  // if (false) mainFn.showGrayList?.(grayList, w, h);\n\n  const context = {\n    data,\n    grayList,\n    width: w,\n    height: h\n  };\n  let blankMargin;\n  if (option.pageFill || option.background) {\n    blankMargin = getBlankMargin(context);\n    if (blankMargin) {\n      for (const key of ['top', 'bottom', 'left', 'right']) blankMargin[key] &&= blankMargin[key] / w;\n      mainFn.setImg(url, 'blankMargin', {\n        left: blankMargin.left,\n        right: blankMargin.right\n      });\n      mainFn.updatePageData();\n      context.blankMargin = blankMargin;\n    } else mainFn.setImg(url, 'blankMargin', null);\n  }\n  let bgColor;\n  if (option.background) {\n    // 虽然也想支持渐变背景，但浏览器上不像手机端那样只需要显示上下背景，可以无视中间的渐变\n    // 大部分时候都要显示左右区域的背景，不能和实际背景一致的话就会很突兀\n    // 要是图片能一直占满屏幕的话，那还能通过单独显示上下或左右部分的背景色来实现\n    // 但偏偏又有「禁止图片自动放大」功能，需要把图片的四边背景都显示出来\n    bgColor = getBackground(context);\n    if (bgColor) mainFn.setImg(url, 'background', bgColor);\n  }\n  let logText = `${url}\\n耗时 ${Date.now() - startTime}ms 处理完成`;\n  const resList = [];\n  if (blankMargin) resList.push(`空白边缘：${Object.entries(blankMargin).filter(([, v]) => v).map(([k, v]) => `${k}:${v && (v * 100).toFixed(2)}%`).join(' ')}`);\n  if (bgColor) resList.push(`背景色: ${bgColor}`);\n  if (resList.length > 0) logText += `\\n${resList.join('\\n')}`;\n  mainFn.log?.(logText);\n};\n\nexports.recognitionImg = recognitionImg;\nexports.setMainFn = setMainFn;\n";break;case"worker/ImageUpscale":c="\nconst tf = require('@tensorflow/tfjs');\nconst tfjsBackendWebgpu = require('@tensorflow/tfjs-backend-webgpu');\nconst helper = require('helper');\n\nclass Img {\n  constructor(width, height, data = new Uint8Array(width * height * 4)) {\n    this.width = width;\n    this.height = height;\n    this.data = data;\n  }\n  getImageCrop(x, y, image, x1, y1, x2, y2) {\n    const width = x2 - x1;\n    for (let j = 0; j < y2 - y1; j++) {\n      const srcIndex = (y1 + j) * image.width * 4 + x1 * 4;\n      this.data.set(image.data.subarray(srcIndex, srcIndex + width * 4), (y + j) * this.width * 4 + x * 4);\n    }\n  }\n  padToTileSize(tileSize) {\n    let newWidth = this.width;\n    let newHeight = this.height;\n    if (this.width < tileSize) newWidth = tileSize;\n    if (this.height < tileSize) newHeight = tileSize;\n    if (newWidth === this.width && newHeight === this.height) return;\n    const newData = new Uint8Array(newWidth * newHeight * 4);\n    for (let y = 0; y < this.height; y++) {\n      const srcStart = y * this.width * 4;\n      newData.set(this.data.subarray(srcStart, srcStart + this.width * 4), y * newWidth * 4);\n    }\n    if (newWidth > this.width) {\n      const rightColumnIndex = (this.width - 1) * 4;\n      for (let y = 0; y < this.height; y++) {\n        const destRowStart = y * newWidth * 4;\n        const srcPixelIndex = y * this.width * 4 + rightColumnIndex;\n        const padPixel = this.data.subarray(srcPixelIndex, srcPixelIndex + 4);\n        for (let x = this.width; x < newWidth; x++) newData.set(padPixel, destRowStart + x * 4);\n      }\n    }\n    if (newHeight > this.height) {\n      const bottomRowStart = (this.height - 1) * newWidth * 4;\n      const bottomRow = newData.subarray(bottomRowStart, bottomRowStart + newWidth * 4);\n      for (let y = this.height; y < newHeight; y++) newData.set(bottomRow, y * newWidth * 4);\n    }\n    this.width = newWidth;\n    this.height = newHeight;\n    this.data = newData;\n  }\n  cropToOriginalSize(width, height) {\n    const newData = new Uint8Array(width * height * 4);\n    for (let y = 0; y < height; y++) {\n      const srcStart = y * this.width * 4;\n      newData.set(this.data.subarray(srcStart, srcStart + width * 4), y * width * 4);\n    }\n    this.width = width;\n    this.height = height;\n    this.data = newData;\n  }\n}\n\nconst mainFn = {};\nconst setMainFn = (helper, keys) => {\n  for (const name of keys) Reflect.set(mainFn, name, (...args) => Reflect.apply(helper[name], helper, args));\n};\nconst base64ToArrayBuffer = base64 => {\n  const binaryString = atob(base64);\n  const len = binaryString.length;\n  const bytes = new Uint8Array(len);\n  for (let i = 0; i < len; i++) bytes[i] = binaryString.codePointAt(i);\n  return bytes.buffer;\n};\n\n// 引用一下，避免被 rullup treeshake 掉\nconsole.debug(tfjsBackendWebgpu.webgpu_util); // oxlint-disable-line no-console\n\nlet model;\nlet loading = false;\nconst getModel = async () => {\n  if (model) return model;\n  if (loading) return helper.wait(() => model);\n  loading = true;\n  try {\n    await tf.setBackend('webgpu');\n  } catch (error) {\n    mainFn.toast.warn(mainFn.t('upscale.webgpu_tip'));\n    mainFn.log.error('切换 WebGPU 出错', error);\n  }\n  const {\n    buffer,\n    base64,\n    json\n  } = await mainFn.getModel();\n  // 修改 tfjs 里的 fetch 来加载模型\n  Reflect.set(tf.env().platform, 'fetch', () => ({\n    ok: true,\n    json: () => JSON.parse(json),\n    arrayBuffer: () => buffer || base64ToArrayBuffer(base64)\n  }));\n  model = await tf.loadGraphModel('xxx');\n  return model;\n};\n\nconst upscaleImg = async image => {\n  const model = await getModel();\n  const result = tf.tidy(() => model.predict(img2tensor(image)));\n  const resultImage = await tensor2img(result);\n  tf.dispose(result);\n  return resultImage;\n};\nconst img2tensor = image => {\n  const imgdata = new ImageData(image.width, image.height);\n  imgdata.data.set(image.data);\n  return tf.browser.fromPixels(imgdata).div(255).toFloat().expandDims();\n};\nconst tensor2img = async tensor => {\n  const [, height, width] = tensor.shape;\n  const clipped = tf.tidy(() => tensor.reshape([height, width, 3]).mul(255).cast('int32').clipByValue(0, 255));\n  tensor.dispose();\n  const data = await tf.browser.toPixels(clipped);\n  clipped.dispose();\n  return new Img(width, height, data);\n};\n\n// 为了省事，就不支持调整参数了\n// 不会支持透明图片，处理起来太麻烦了\n// 代码均抄自\n// https://github.com/xororz/web-realesrgan/blob/f81d2dd7935ee8df947674933fd41a446b90e911/src/worker.js\n// 只删去了因参数固定而变得冗余的代码\n//\n// 模型文件在 Releases 下载\n//\n// https://cappuccino.moe/realcugan/2x-conservative-128/model.json\nconst factor = 2;\nconst input_size = 128;\nconst min_lap = 12;\nconst upscale = async (data, width, height) => {\n  const input = new Img(width, height, new Uint8Array(data));\n  input.padToTileSize(input_size);\n  const output = new Img(width * factor, height * factor);\n  let num_x = 1;\n  for (; (input_size * num_x - width) / (num_x - 1) < min_lap; num_x++);\n  let num_y = 1;\n  for (; (input_size * num_y - height) / (num_y - 1) < min_lap; num_y++);\n  const locs_x = Array.from({\n    length: num_x\n  });\n  const locs_y = Array.from({\n    length: num_y\n  });\n  const pad_left = Array.from({\n    length: num_x\n  });\n  const pad_top = Array.from({\n    length: num_y\n  });\n  const pad_right = Array.from({\n    length: num_x\n  });\n  const pad_bottom = Array.from({\n    length: num_y\n  });\n  const total_lap_x = input_size * num_x - width;\n  const total_lap_y = input_size * num_y - height;\n  const base_lap_x = Math.floor(total_lap_x / (num_x - 1));\n  const base_lap_y = Math.floor(total_lap_y / (num_y - 1));\n  const extra_lap_x = total_lap_x - base_lap_x * (num_x - 1);\n  const extra_lap_y = total_lap_y - base_lap_y * (num_y - 1);\n  locs_x[0] = 0;\n  for (let i = 1; i < num_x; i++) {\n    if (i <= extra_lap_x) locs_x[i] = locs_x[i - 1] + input_size - base_lap_x - 1;else locs_x[i] = locs_x[i - 1] + input_size - base_lap_x;\n  }\n  locs_y[0] = 0;\n  for (let i = 1; i < num_y; i++) {\n    if (i <= extra_lap_y) locs_y[i] = locs_y[i - 1] + input_size - base_lap_y - 1;else locs_y[i] = locs_y[i - 1] + input_size - base_lap_y;\n  }\n  pad_left[0] = 0;\n  pad_top[0] = 0;\n  pad_right[num_x - 1] = 0;\n  pad_bottom[num_y - 1] = 0;\n  for (let i = 1; i < num_x; i++) pad_left[i] = Math.floor((locs_x[i - 1] + input_size - locs_x[i]) / 2);\n  for (let i = 1; i < num_y; i++) pad_top[i] = Math.floor((locs_y[i - 1] + input_size - locs_y[i]) / 2);\n  for (let i = 0; i < num_x - 1; i++) pad_right[i] = locs_x[i] + input_size - locs_x[i + 1] - pad_left[i + 1];\n  for (let i = 0; i < num_y - 1; i++) pad_bottom[i] = locs_y[i] + input_size - locs_y[i + 1] - pad_top[i + 1];\n  for (let i = 0; i < num_x; i++) {\n    for (let j = 0; j < num_y; j++) {\n      const x1 = locs_x[i];\n      const y1 = locs_y[j];\n      const x2 = locs_x[i] + input_size;\n      const y2 = locs_y[j] + input_size;\n      const tile = new Img(input_size, input_size);\n      tile.getImageCrop(0, 0, input, x1, y1, x2, y2);\n      const scaled = await upscaleImg(tile);\n      output.getImageCrop((x1 + pad_left[i]) * factor, (y1 + pad_top[j]) * factor, scaled, pad_left[i] * factor, pad_top[j] * factor, scaled.width - pad_right[i] * factor, scaled.height - pad_bottom[j] * factor);\n    }\n  }\n  return output;\n};\nconst upscaleImage = async (data, width, height, url) => {\n  const startTime = Date.now();\n  const output = await upscale(data, width, height);\n  const canvas = new OffscreenCanvas(output.width, output.height);\n  const ctx = canvas.getContext('2d');\n  const imgData = ctx.createImageData(output.width, output.height);\n  for (let i = 0; i < imgData.data.length; i++) imgData.data[i] = output.data[i];\n  ctx.putImageData(imgData, 0, 0);\n  const blob = await canvas.convertToBlob({\n    type: 'image/png'\n  });\n  mainFn.setImg(url, 'upscaleUrl', URL.createObjectURL(blob));\n  mainFn.log?.(`${url}\\n${width}x${height}\\n耗时 ${Date.now() - startTime}ms 放大完成`);\n};\n\nexports.setMainFn = setMainFn;\nexports.upscaleImage = upscaleImage;\n";break;case"userscript/otherSite":c="\nconst web = require('solid-js/web');\nconst helper = require('helper');\nconst main = require('main');\n\nconst prevRe = /^上一?(?:[章話话]|章节)$|^(?:prev|previous)(?:\\s+chapter)?$|^前の章$/i;\nconst nextRe = /^下一?(?:[章話话]|章节)$|^next(?:\\s+chapter)?$|^次の章$/i;\nconst getChapterSwitch = () => {\n  let onPrev;\n  let onNext;\n  const checkElement = e => {\n    const texts = [e.textContent, e.ariaLabel].filter(Boolean)\n    // 删除可能混在其中的特殊符号\n    .map(text => text.replaceAll(/[<>()《》（）「」『』]/g, '').trim());\n    if (texts.length === 0) return;\n    for (const text of texts) {\n      if (!onPrev && prevRe.test(text)) {\n        onPrev = () => e.click();\n        break;\n      }\n      if (!onNext && nextRe.test(text)) {\n        onNext = () => e.click();\n        break;\n      }\n    }\n  };\n  for (const e of helper.querySelectorAll('a, button')) {\n    checkElement(e);\n    if (onPrev && onNext) break;\n    for (const element of e.querySelectorAll('div, span, p')) {\n      checkElement(element);\n      if (onPrev && onNext) break;\n    }\n  }\n  return {\n    onPrev,\n    onNext\n  };\n};\n\nconst getTagText = ele => {\n  let text = ele.nodeName;\n  if (ele.id && !/\\d/.test(ele.id)) text += `#${ele.id}`;\n  return text;\n};\n\n/** 获取元素仅记录了层级结构关系的选择器 */\nconst getEleSelector = ele => {\n  const parents = [ele.nodeName];\n  const root = ele.getRootNode();\n  let e = ele;\n  while (e.parentNode && e.parentNode !== root) {\n    e = e.parentNode;\n    parents.push(getTagText(e));\n  }\n  return parents.toReversed().join('>');\n};\n\n/** 判断指定元素是否符合选择器 */\nconst isEleSelector = (ele, selector) => {\n  const parents = selector.split('>').toReversed();\n  let e = ele;\n  for (let i = 0; e && i < parents.length; i++) {\n    if (getTagText(e) !== parents[i]) return false;\n    e = e.parentNode;\n  }\n  return e === e.getRootNode();\n};\n\n// 目录页和漫画页的图片层级相同\n// https://www.biliplus.com/manga/\n// 图片路径上有 id 元素并且 id 含有漫画 id，不同话数 id 也不同\nconst createImgData = (oldSrc = '') => ({\n  triggedNum: 0,\n  observerTimeout: 0,\n  oldSrc\n});\n\n/** 用于判断是否是图片 url 的正则 */\nconst isImgUrlRe = /^(?:(?:(?:https?|ftp|file):)?\\/)?\\/[-\\w+&@#/%?=~|!:,.;]+[-\\w+&@#%=~|]$/;\n\n/** 找出格式为图片 url 的元素属性 */\nconst getDatasetUrl = e => {\n  for (const key of e.getAttributeNames()) {\n    // 跳过白名单\n    switch (key) {\n      case 'src':\n      case 'alt':\n      case 'class':\n      case 'style':\n      case 'id':\n      case 'title':\n      case 'onload':\n      case 'onerror':\n        continue;\n    }\n    const val = e.getAttribute(key).trim();\n    if (!isImgUrlRe.test(val)) continue;\n    return val;\n  }\n};\n\n/**\n *\n * 通过滚动到指定图片元素位置并停留一会来触发图片的懒加载，返回图片 src 是否发生变化\n *\n * 会在触发后重新滚回原位，当 time 为 0 时，因为滚动速度很快所以是无感的\n */\nconst triggerEleLazyLoad = async (e, time, isLazyLoaded, runCondition) => {\n  const nowScroll = window.scrollY;\n  e.scrollIntoView({\n    behavior: 'instant'\n  });\n  e.dispatchEvent(new Event('scroll', {\n    bubbles: true\n  }));\n  try {\n    if (isLazyLoaded && time) return await helper.wait(isLazyLoaded, time);\n  } finally {\n    if (runCondition()) window.scroll({\n      top: nowScroll,\n      behavior: 'instant'\n    });\n  }\n};\nconst isImageElement = e => e.tagName === 'IMG';\n\n/** 判断一个元素是否已经成功触发完懒加载 */\nconst isLazyLoaded = (e, oldSrc) => {\n  if (isImageElement(e)) {\n    if (!e.src) return false;\n    if (!e.offsetParent) return false;\n    // 有些网站会使用 svg 占位\n    if (e.src.startsWith('data:image/svg')) return false;\n    if (e.naturalWidth > 500 || e.naturalHeight > 500) return true;\n    if (oldSrc !== undefined && e.src !== oldSrc) return true;\n  } else {\n    const imgDomList = e.querySelectorAll('img');\n    for (const imgDom of imgDomList) if (isLazyLoaded(imgDom, oldSrc)) return true;\n  }\n  return false;\n};\nconst imgMap = new WeakMap();\nlet imgShowObserver;\nconst getImg = e => imgMap.get(e) ?? createImgData();\nconst MAX_TRIGGED_NUM = 5;\n\n/** 判断图片元素是否需要触发懒加载 */\nconst needTrigged = e => !isLazyLoaded(e, imgMap.get(e)?.oldSrc) && (imgMap.get(e)?.triggedNum ?? 0) < MAX_TRIGGED_NUM;\n\n/** 图片懒加载触发完后调用 */\nconst handleTrigged = e => {\n  const img = getImg(e);\n  img.observerTimeout = 0;\n  img.triggedNum += 1;\n  if (isLazyLoaded(e, img.oldSrc) && img.triggedNum < MAX_TRIGGED_NUM) img.triggedNum = MAX_TRIGGED_NUM;\n  imgMap.set(e, img);\n  if (!needTrigged(e)) imgShowObserver.unobserve(e);\n};\n\n/** 监视图片是否被显示的 Observer */\nimgShowObserver = new IntersectionObserver(entries => {\n  for (const img of entries) {\n    const e = img.target;\n    if (img.isIntersecting) {\n      imgMap.set(e, {\n        ...getImg(e),\n        observerTimeout: window.setTimeout(handleTrigged, 290, e)\n      });\n    } else window.clearTimeout(imgMap.get(e)?.observerTimeout);\n  }\n});\nconst turnPageScheduled = helper.createScheduled(fn => helper.throttle(fn, 1000));\n/** 触发翻页 */\nconst triggerTurnPage = async (waitTime, runCondition) => {\n  if (!turnPageScheduled()) return;\n  const nowScroll = window.scrollY;\n  // 滚到底部再滚回来，触发可能存在的自动翻页脚本\n  window.scroll({\n    top: document.body.scrollHeight,\n    behavior: 'instant'\n  });\n  document.body.dispatchEvent(new Event('scroll', {\n    bubbles: true\n  }));\n  if (waitTime) await helper.sleep(waitTime);\n  if (runCondition()) window.scroll({\n    top: nowScroll,\n    behavior: 'instant'\n  });\n};\nconst waitTime = 300;\n\n/** 触发页面上图片元素的懒加载 */\nconst triggerLazyLoad = helper.singleThreaded(async (_, targetImgList, runCondition) => {\n  for (const e of targetImgList) {\n    imgShowObserver.observe(e);\n    if (!imgMap.has(e)) imgMap.set(e, createImgData(isImageElement(e) ? e.src : ''));\n  }\n  for (const e of targetImgList) {\n    await helper.wait(runCondition);\n    await triggerTurnPage(0, runCondition);\n    if (!needTrigged(e)) continue;\n    const datasetUrl = getDatasetUrl(e);\n    if (datasetUrl) e.setAttribute('src', datasetUrl);\n    if (await triggerEleLazyLoad(e, waitTime, () => isLazyLoaded(e, imgMap.get(e)?.oldSrc), runCondition)) handleTrigged(e);\n  }\n  await triggerTurnPage(waitTime, runCondition);\n});\n\n\n// 测试案例\n// https://www.177picyy.com/html/2023/03/5505307.html\n// 需要配合其他翻页脚本使用\n// https://www.colamanga.com/manga-za76213/1/5.html\n// 直接跳转到图片元素不会立刻触发，还需要停留20ms\n// https://www.colamanga.com/manga-kg45140/1/2.html\n/** 执行脚本操作。如果中途中断，将返回 true */\nconst otherSite = async () => {\n  let laseScroll = window.scrollY;\n  const {\n    store,\n    setState,\n    options,\n    setOptions\n  } = await main.useInit(location.hostname, {\n    remember_current_site: true,\n    selector: ''\n  });\n\n  // 点击按钮后立刻删掉记住当前站点的配置\n  helper.createEffectOn(() => options.remember_current_site, async remember => {\n    if (remember) return;\n    await GM.deleteValue(location.hostname);\n    location.reload();\n  });\n  if (!store.flag.isStored) main.toast(() => (() => {\n    var _el$ = web.template(`<div><button>`)(),\n      _el$2 = _el$.firstChild;\n    web.insert(_el$, () => helper.t('site.simple.auto_read_mode_message'), _el$2);\n    web.addEventListener(_el$2, \"click\", () => setOptions({\n      autoShow: false\n    }));\n    web.insert(_el$2, () => helper.t('other.disable'));\n    return _el$;\n  })(), {\n    duration: 1000 * 7\n  });\n\n  // 为避免卡死，提供一个删除 selector 的菜单项\n  const menuId = await GM.registerMenuCommand(helper.t('site.simple.simple_read_mode'), () => setOptions({\n    selector: ''\n  }));\n\n  // 等待 selector 匹配到目标后再继续执行，避免在漫画页外的其他地方运行\n  await helper.wait(() => !options.selector || helper.querySelectorAll(options.selector).length >= 2);\n  await GM.unregisterMenuCommand(menuId);\n\n  /** 记录传入的图片元素中最常见的那个 selector */\n  const saveImgEleSelector = imgEleList => {\n    if (imgEleList.length < 7) return;\n    const selector = helper.getMostItem(imgEleList.map(getEleSelector));\n    if (selector !== options.selector) setOptions({\n      selector\n    });\n  };\n  const blobUrlMap = new Map();\n  // 处理那些 URL.createObjectURL 后马上 URL.revokeObjectURL 的图片\n  const handleBlobImg = async e => {\n    if (blobUrlMap.has(e.src)) return blobUrlMap.get(e.src);\n    if (!e.src.startsWith('blob:')) return e.src;\n    if (await helper.testImgUrl(e.src)) return e.src;\n    const canvas = new OffscreenCanvas(e.naturalWidth, e.naturalHeight);\n    const canvasCtx = canvas.getContext('2d');\n    canvasCtx.drawImage(e, 0, 0);\n    const url = URL.createObjectURL(await helper.canvasToBlob(canvas));\n    blobUrlMap.set(e.src, url);\n    return url;\n  };\n  const handleImgUrl = async e => {\n    const url = await handleBlobImg(e);\n    if (url.startsWith('http:') && location.protocol === 'https:') return url.replace('http:', 'https:');\n    return url;\n  };\n\n  /** 重复的加载占位图 */\n  const placeholderImgList = new Set();\n  helper.createEffectOn(() => store.manga.imgList.filter(url => url && !placeholderImgList.has(url)), helper.throttle(imgList => {\n    if (!imgList?.length || imgList.length - new Set(imgList).size <= 4) return;\n    const repeatNumMap = new Map();\n    for (const url of imgList) {\n      const repeatNum = (repeatNumMap.get(url) ?? 0) + 1;\n      repeatNumMap.set(url, repeatNum);\n      if (repeatNum > 5) placeholderImgList.add(url);\n    }\n  }));\n\n  /** 根据元素所在高度进行排序 */\n  const eleSortFn = (a, b) => a === undefined || b === undefined ? 0 : a.getBoundingClientRect().y - b.getBoundingClientRect().y;\n  const imgBlackList = [\n  // 东方永夜机的预加载图片\n  '#pagetual-preload',\n  // 177picyy 上会在图片下加一个 noscript\n  // 本来只是图片元素的 html 代码，但经过东方永夜机加载后就会变成真的图片元素，导致重复\n  'noscript'];\n  const getAllImg = () => helper.querySelectorAll(`:not(${imgBlackList.join(',')}) > img`);\n\n  /** 获取大概率是漫画图片的图片元素 */\n  const getExpectImgList = () => helper.querySelectorAll(options.selector).filter(e => isLazyLoaded(e, imgMap.get(e)?.oldSrc) || !imgMap.has(e) || imgMap.get(e).triggedNum <= 5);\n\n  /** 判断一个图片元素是否符合标准 */\n  const isDisplayImg = e => e.offsetHeight > 100 && e.offsetWidth > 100 && (e.naturalHeight > 500 && e.naturalWidth > 500 || isEleSelector(e, options.selector));\n  let imgEleList;\n\n  /** 检查筛选符合标准的图片元素用于更新 imgList */\n  const updateImgList = helper.singleThreaded(async _state => {\n    imgEleList = await helper.wait(() => {\n      /** 大概率是漫画图片的图片元素 */\n      const expectImgs = options.selector ? new Set(getExpectImgList()) : undefined;\n      let imgNum = 0;\n      const newImgList = [];\n      for (const e of getAllImg()) {\n        if (isDisplayImg(e)) {\n          newImgList.push(e);\n          imgNum += 1;\n        } else if (expectImgs?.has(e) && needTrigged(e)) newImgList.push(undefined);\n      }\n      return imgNum >= 2 && newImgList.toSorted(eleSortFn);\n    });\n    if (imgEleList.length === 0) return setState(state => {\n      state.fab.show = false;\n      state.manga.show = false;\n    });\n\n    // 随着图片的增加，需要补上空缺位置，避免变成稀疏数组\n    if (store.manga.imgList.length < imgEleList.length) setState('comicMap', '', 'imgList', [...store.manga.imgList, ...Array.from({\n      length: imgEleList.length - store.manga.imgList.length\n    }, () => '')]);\n    // colamanga 会创建随机个数的假 img 元素，导致刚开始时高估页数，需要删掉多余的页数\n    else if (store.manga.imgList.length > imgEleList.length) setState('comicMap', '', 'imgList', store.manga.imgList.slice(0, imgEleList.length));\n    let isEdited = false;\n    await helper.plimit(imgEleList.map((e, i) => async () => {\n      let newUrl = '';\n      if (e) {\n        newUrl = await handleImgUrl(e);\n        if (placeholderImgList.has(newUrl)) newUrl = getDatasetUrl(e) ?? '';\n      }\n      if (newUrl === store.manga.imgList[i]) return;\n      isEdited ||= true;\n      setState('comicMap', '', 'imgList', list => list.with(i, newUrl));\n    }));\n    if (isEdited) saveImgEleSelector(imgEleList.filter(Boolean));\n    if (isEdited || imgEleList.some(e => !e || needTrigged(e))) {\n      await helper.sleep(1000);\n      _state.continueRun();\n    }\n  });\n  let timeout = false;\n\n  /** 只在`开启了阅读模式`和`当前可显示图片数量不足`时通过滚动触发懒加载 */\n  const runCondition = () => store.manga.show || !timeout && store.manga.imgList.length === 0;\n\n  /** 触发大概率是漫画图片的懒加载 */\n  const triggerExpectImg = (num, time) => helper.wait(async () => {\n    let expectImgList = getExpectImgList().filter(needTrigged);\n    if (num) expectImgList = expectImgList.slice(0, num);\n    await triggerLazyLoad(expectImgList, runCondition);\n    return expectImgList.every(e => !needTrigged(e));\n  }, time);\n  const triggerAllLazyLoad = helper.singleThreaded(async () => {\n    // 优先触发大概率是漫画图片的懒加载\n    if (options.selector) {\n      await triggerExpectImg(3, 1000 * 5);\n      await triggerExpectImg();\n    }\n    await triggerLazyLoad(getAllImg().filter(needTrigged).toSorted(eleSortFn), runCondition);\n\n    // 针对不使用 img 来触发懒加载的网站，要找到图片容器元素再尝试触发懒加载\n    // https://www.twmanga.com/comic/chapter/sanjiaoguanxirumen-founai/0_0.html\n    if (imgEleList.length > 3) {\n      let parent = imgEleList[0];\n      // 从现有的图片元素开始冒泡查找，检查每个层级上是否有超过5个相似的兄弟元素\n      while (parent?.parentElement) {\n        const siblingList = parent.parentElement.children;\n        if (siblingList.length >= 5) {\n          const {\n            dataset\n          } = parent;\n          let sameNum = 0;\n          for (const siblingDom of siblingList) {\n            if (siblingDom === parent) continue;\n            if ('dataset' in siblingDom && helper.isEqual(siblingDom.dataset, dataset)) {\n              sameNum++;\n              if (sameNum >= 5) break;\n            }\n          }\n          if (sameNum >= 5) {\n            await triggerLazyLoad(helper.querySelectorAll(getEleSelector(parent)), runCondition);\n            break;\n          }\n        }\n        parent = parent.parentElement;\n      }\n    }\n  });\n  const handleMutation = () => {\n    updateImgList();\n    triggerAllLazyLoad();\n    setState('manga', getChapterSwitch());\n  };\n  /** 监视页面元素发生变化的 Observer */\n  const imgDomObserver = new MutationObserver(handleMutation);\n  setState('comicMap', '', {\n    async getImgList() {\n      if (!imgEleList) {\n        imgEleList = [];\n        imgDomObserver.observe(document.body, {\n          subtree: true,\n          childList: true,\n          attributes: true,\n          attributeFilter: ['src']\n        });\n        handleMutation();\n        setTimeout(() => {\n          timeout = true;\n          if (store.manga.imgList.length > 0) return;\n          main.toast.warn(helper.t('site.simple.no_img'), {\n            id: 'no_img',\n            duration: Number.POSITIVE_INFINITY,\n            async onClick() {\n              await setOptions({\n                remember_current_site: false\n              });\n              location.reload();\n            }\n          });\n        }, 3000);\n      }\n      await helper.wait(() => store.manga.imgList.length);\n      main.toast.dismiss('no_img');\n      return store.manga.imgList;\n    }\n  });\n\n  // 同步滚动显示网页上的图片，用于以防万一保底触发漏网之鱼\n  setState('manga', 'onShowImgsChange', helper.throttle(showImgs => {\n    if (!store.manga.show) return;\n    imgEleList[[...showImgs].at(-1)]?.scrollIntoView({\n      behavior: 'instant',\n      block: 'end'\n    });\n  }, 1000));\n\n  // 在退出阅读模式时跳回之前的滚动位置\n  helper.createEffectOn(() => store.manga.show, show => {\n    if (show) laseScroll = window.scrollY;else window.scroll({\n      top: laseScroll,\n      behavior: 'instant'\n    });\n  });\n\n  // 针对 SPA 网站，在网址改变后清空图片\n  helper.onUrlChange((lastUrl, nowUrl) => {\n    if (!lastUrl || lastUrl.split('/').length === nowUrl.split('/').length) return;\n    setState('comicMap', '', 'imgList', undefined);\n  });\n};\n\nexports.otherSite = otherSite;\n";break;case"userscript/ehTagRules":c='\n// 使用 i18n-ally 扩展查看对应的中文翻译\n\n// 概率标签的标准：有A标签的本子中，只有 10% 的本子没有 B 标签\n// 「`A标签 -B标签` 的搜索结果数」<「`A标签` 的搜索结果数」的 10%\n// 有没有必要加上复杂规则呢？\n// - 组合标签\n//   - 单扶她 + 单女主 = 大概率「扶上女」\n// - 根据条件将「大概率」限定为「必须」\n//   - 单萝莉 + 贫乳 + (单女主) = 肯定无法共存\n// - 把画廊类型也加进标签，方便过滤 CG 集等图库\nconst rules = {"prerequisite":{"(x|f):incest":["f:cousin","f:aunt","f:daughter","f:mother","f:granddaughter","f:sister","f:grandmother","f:niece"],"(x|m):incest":["m:cousin"],"f:incest":["f:inseki","f:low_incest"],"m:incest":["m:inseki","m:low_incest"],"x:incest":["x:inseki","x:low_incest"],"f:group":["f:fff_threesome","f:ttt_threesome","f:fft_threesome","f:ttf_threesome"],"m:group":["m:mmm_threesome"],"x:group":["x:mmf_threesome","x:mmt_threesome","x:ttm_threesome","x:ffm_threesome","x:mtf_threesome","x:oyakodon","x:shimaidon","x:gang_rape"],"(x|f):group":["f:oyakodon","f:shimaidon","f:multiple_straddling","f:gang_rape","f:layer_cake","f:harem"],"(x|m):group":["m:oyakodon","m:shimaidon","m:multiple_straddling","m:gang_rape","m:layer_cake","m:harem"],"f:yuri":["f:fff_threesome"],"m:yaoi":["m:group","m:mmm_threesome"],"f:futanari":["f:ttt_threesome","f:fft_threesome","f:ttf_threesome","f:full-packaged_futanari","f:futanarization"],"f:shemale":["f:ball-less_shemale"],"f:lolicon":["f:kodomo_doushi","x:kodomo_doushi","f:oppai_loli","f:mesugaki","f:low_lolicon"],"m:shotacon":["m:kodomo_doushi","x:kodomo_doushi"],"f:blowjob":["f:multimouth_blowjob","f:blowjob_face","f:deepthroat","f:focus_blowjob"],"m:blowjob":["m:multimouth_blowjob","m:blowjob_face","m:deepthroat","m:focus_blowjob"],"f:handjob":["f:multiple_handjob"],"m:handjob":["m:multiple_handjob"],"f:assjob":["f:multiple_assjob"],"m:assjob":["m:multiple_assjob"],"f:footjob":["f:multiple_footjob"],"m:footjob":["m:multiple_footjob"],"f:paizuri":["f:focus_paizuri"],"m:paizuri":["m:focus_paizuri"],"f:rimjob":["f:focus_rimjob"],"m:rimjob":["m:focus_rimjob"],"f:cunnilingus":["f:focus_cunnilingus"],"f:anal":["f:focus_anal","f:anal_intercourse","f:tail_plug","f:butt_plug"],"m:anal":["m:focus_anal","m:anal_intercourse","m:tail_plug","m:butt_plug"],"f:rape":["f:gang_rape"],"m:rape":["m:gang_rape"],"(f|m):corpse":["f:necrophilia","m:necrophilia"],"(f|m):masturbation":["f:phone_sex","m:phone_sex"],"f:bondage":["f:fanny_packing","f:shibari","f:straitjacket"],"m:bondage":["m:fanny_packing","m:shibari","m:straitjacket"],"f:inflation":["f:cumflation"],"m:inflation":["m:cumflation"],"f:lactation":["f:milking"],"m:lactation":["m:milking"],"f:piercing":["f:nipple_piercing","f:genital_piercing"],"m:piercing":["m:nipple_piercing","m:genital_piercing"],"f:big_breasts":["f:huge_breasts","f:gigantic_breasts"],"f:huge_breasts":["f:gigantic_breasts"],"f:sex_toys":["f:tail_plug","f:butt_plug","f:unusual_insertions"],"m:sex_toys":["m:tail_plug","m:butt_plug","m:unusual_insertions"],"f:swimsuit":["f:bikini"],"m:swimsuit":["m:bikini"],"f:crossdressing":["f:schoolboy_uniform"],"f:bandages":["f:sarashi"],"f:monster_girl":["f:zombie","f:skeleton"],"f:tail":["f:multiple_tails"],"(f|m):robot":["f:dismantling","m:dismantling"]},"conflict":{"f:females_only":["f:futanari","f:bisexual","f:ttt_threesome","f:fft_threesome","f:ttf_threesome","x:mmf_threesome","x:mmt_threesome","x:ttm_threesome","x:mtf_threesome","x:group","m:*","x:*"],"f:sole_female":["f:ttt_threesome","f:fft_threesome","x:mmt_threesome","x:ttm_threesome","m:mmm_threesome"],"f:sole_dickgirl":["f:fff_threesome","f:ttt_threesome","f:ttf_threesome","x:mmf_threesome","x:ttm_threesome","m:mmm_threesome"]},"possibleConflict":{"f:dark_skin":["f:tanlines"],"m:dark_skin":["m:tanlines"],"f:lolicon":["f:small_breasts"],"f:breast_feeding":["f:nipple_stimulation"]},"combo":{"f:kemonomimi":["f:horse_girl","f:dog_girl","f:mouse_girl","f:bunny_girl","f:catgirl","f:cowgirl","c:amiya","c:rosmontis","c:suzuran","c:shamare","c:schwarz"],"f:tail":["f:horse_girl","c:suzuran","c:schwarz","c:yuko_yoshida"],"f:leotard":["f:bunny_girl"],"f:horns":["f:oni","c:yuko_yoshida"],"f:horse_girl":["p:uma_musume_pretty_derby"],"f:halo":["p:blue_archive","c:nagisa_kirifuji","c:mika_misono"],"f:zombie":["p:zombie_land_saga"],"f:hair_buns":["c:ayumu_uehara","c:yoshiko_tsushima","c:chisato_arashi","c:ceylon"],"f:twintails":["c:yu_takasaki","c:rurino_osawa","c:sayaka_murano","c:nico_yazawa","c:nozomi_tojo","c:ruby_kurosawa","c:ria_kazuno","c:arisa_ichigaya","c:himari_uehara","c:ako_udagawa","c:reona_nyubara","c:tsukushi_futaba","c:kotone_fujita"],"f:ponytail":["c:hime_anyoji","c:eli_ayase","c:honoka_kosaka","c:kanan_matsuura","c:seira_kazuno","c:ren_hazuki","c:saaya_yamabuki","c:nijika_ijichi","c:schwarz","c:mafuyu_asahina"],"f:very_long_hair":["c:hitori_gotou","c:nijika_ijichi","c:euphyllia_magenta","c:nagisa_kirifuji","c:mika_misono","c:kanade_yoisaki"],"f:lolicon":["c:suzuran","c:shamare"],"f:multiple_tails":["c:suzuran"],"f:wings":["c:remilia_scarlet","c:flandre_scarlet","c:koakuma","c:nagisa_kirifuji","c:mika_misono"],"f:vampire":["c:remilia_scarlet","c:flandre_scarlet"],"f:demon_girl":["c:koakuma","c:yuko_yoshida"],"f:thick_eyebrows":["c:suletta_mercury"],"f:glasses":["c:junna_hoshimi"],"f:beauty_mark":["c:misuzu_hataya"],"m:crossdressing":["c:mizuki_akiyama"],"f:angel":["c:nagisa_kirifuji","c:mika_misono"]}};\nconst getTagLintRules = () => {\n  const shortNamespace = new Map([[\'p\', \'parody\'], [\'c\', \'character\'], [\'g\', \'group\'], [\'a\', \'artist\'], [\'m\', \'male\'], [\'f\', \'female\'], [\'x\', \'mixed\'], [\'o\', \'other\']].map(([short, full]) => [new RegExp(`\\\\b${short}\\\\b(?=.*:)`), full]));\n  // 将缩写的命名空间转回全拼\n  const getTagName = tag => {\n    let fullTag = tag;\n    for (const re of shortNamespace.keys()) if (re.test(fullTag)) {\n      fullTag = fullTag.replace(re, shortNamespace.get(re));\n    }\n    return fullTag;\n  };\n  const createRuleMap = (map, reverse = false) => {\n    const ruleMap = new Map();\n    if (reverse) for (let [targetTag, tags] of Object.entries(map)) {\n      targetTag = getTagName(targetTag);\n      for (let tag of tags) {\n        tag = getTagName(tag);\n        if (ruleMap.has(tag)) ruleMap.get(tag).add(targetTag);else ruleMap.set(tag, new Set([targetTag]));\n      }\n    } else for (const [tag, targetTag] of Object.entries(map)) ruleMap.set(getTagName(tag), new Set(targetTag.map(getTagName)));\n    return ruleMap;\n  };\n  return {\n    prerequisite: createRuleMap(rules.prerequisite, true),\n    conflict: createRuleMap(rules.conflict),\n    possibleConflict: createRuleMap(rules.possibleConflict),\n    // 写的时候为了可以根据不同作品分类而没有反转\n    // 但为了减少代码，在打包时反转了下，所以在用时得再反转回去\n    combo: createRuleMap(rules.combo, true)\n  };\n};\n\n/** 拆分多个命名空间的标签 */\nconst splitTagNamespace = tag => {\n  if (!tag.startsWith(\'(\')) return [tag];\n  const [, namespaces, tagName] = /\\((.+?)\\)(.+)/.exec(tag);\n  return namespaces.split(\'|\').map(namespace => `${namespace}${tagName}`);\n};\n\n/** 判断是否缺少指定命名空间下的标签 */\nconst isMissingNamespace = (tagList, ...namespaces) => {\n  for (const namespace of namespaces) for (const tag of tagList) if (tag.startsWith(namespace)) return false;\n  return true;\n};\n\n/** 检查标签是否存在 */\nconst hasTag = (tagList, tagName) => {\n  if (tagName.startsWith(\'(\')) for (const tag of splitTagNamespace(tagName)) if (tagList.has(tag)) return true;\n  if (tagName.endsWith(\':*\')) return !isMissingNamespace(tagList, tagName.split(\':*\')[0]);\n  return tagList.has(tagName);\n};\n\n/** 判断是否缺少指定标签 */\nconst isMissingTags = (tagList, ...tags) => {\n  for (const tag of tags) if (tagList.has(tag)) return false;\n  return true;\n};\n\nexports.getTagLintRules = getTagLintRules;\nexports.hasTag = hasTag;\nexports.isMissingNamespace = isMissingNamespace;\nexports.isMissingTags = isMissingTags;\nexports.splitTagNamespace = splitTagNamespace;\n';break;default:c=r(i)}if(i.startsWith("worker/")&&e)try{const e=new Map;e.set("Comlink",r("comlink"));const t=n=>n.replaceAll(/require\('(.+?)'\)/g,(n,o)=>(e.has(o)||e.set(o,t(r(o))),`moduleMap['${o}']`)),n=t(c);let a="const moduleMap = {};\n";for(const[t,n]of e)a+=`\nmoduleMap['${t}'] = {};\n(function (exports, module) { ${n} }) (\n  moduleMap['${t}'],\n  {\n    set exports(value) { moduleMap['${t}'] = value; },\n    get exports() { return moduleMap['${t}']; }\n  },\n);\n`;a+=`\nconst exports = {};\n${n}\nmoduleMap['Comlink'].expose(exports);`;const s=URL.createObjectURL(new Blob([a],{type:"text/javascript"}));setTimeout(URL.revokeObjectURL,0,s);const d=new Worker(s);return void(o[i]=l("comlink").wrap(d))}catch{e=!1}let d=`\n    (function (process, require, exports, module, ${n.join(", ")}) {\n      ${c}\n    })(\n      window['${a}'].process,\n      window['${a}'].require,\n      window['${a}']['${i}'],\n      ((module) => ({\n        set exports(value) { module['${i}'] = value; },\n        get exports() { return module['${i}']; },\n      }))(window['${a}']),\n      ${n.map(e=>`window['${a}'].${e}`).join(", ")}\n    );\n  `;t.unsafeWindow[a]=o,t.unsafeWindow[a][i]={},s(d),Reflect.deleteProperty(t.unsafeWindow,a)},l=e=>{const t={value:!0},n=()=>{};n.default={};const a=new Proxy(n,{get:(n,r)=>"__esModule"===r?t:"default"===r?a:(o[e]||i(e),Reflect.has(o[e],"default")&&Reflect.has(o[e].default,r)?o[e].default[r]:o[e][r]),apply(t,n,a){o[e]||i(e);const r=o[e];return("function"==typeof r.default?r.default:r)(...a)},construct(t,n){o[e]||i(e);const a=o[e];return new("function"==typeof a.default?a.default:a)(...n)},ownKeys:()=>(o[e]||i(e),Reflect.ownKeys(o[e])),getOwnPropertyDescriptor:()=>({enumerable:!0,configurable:!0})});return a};o.require=l;const c=l("components/Manga"),d=l("helper"),p=l("helper/languages"),g=l("main"),m=l("userscript/copyApi"),u=l("userscript/otherSite");let h;try{switch(location.hostname){case"bbs.yamibo.com":{const e=l("solid-js/web"),t=l("solid-js"),n=l("helper"),o=l("main");(async()=>{const{setState:a,options:r,showComic:s,loadComic:i}=await o.useInit("yamibo",{"记录阅读进度":!0,"关闭快捷导航的跳转":!0,"修正点击页数时的跳转判定":!0,"固定导航条":!0,"自动签到":!0,"移动端显示帖子权限":!0});if(n.useStyle(`#fab { --fab: #6E2B19; }\n\n    ${r.固定导航条?".header-stackup { position: fixed !important }":""}\n\n    .historyTag {\n      white-space: nowrap;\n\n      border: 2px solid #6e2b19;\n    }\n\n    a.historyTag {\n      font-weight: bold;\n\n      margin-left: 1em;\n      padding: 1px 4px;\n\n      color: #6e2b19;\n      border-radius: 4px 0 0 4px;\n    }\n    a.historyTag:last-child {\n      border-radius: 4px;\n    }\n\n    div.historyTag {\n      display: initial;\n\n      margin-left: -.4em;\n      padding: 1px;\n\n      color: RGB(255, 237, 187);\n      border-radius: 0 4px 4px 0;\n      background-color: #6e2b19;\n    }\n\n    #threadlisttableid tbody:nth-child(2n) div.historyTag {\n      color: RGB(255, 246, 215);\n    }\n\n    /* 将「回复/查看」列加宽一点 */\n    .tl .num {\n      width: 80px !important;\n    }\n    `),unsafeWindow.discuz_uid&&"0"!==unsafeWindow.discuz_uid&&r.自动签到&&(async()=>{const e=(new Date).toLocaleDateString("zh-CN");if(e===localStorage.getItem("signDate"))return;const t=n.querySelector('#scbar_form > input[name="formhash"]')?.value;if(t)try{const n=await fetch(`plugin.php?id=zqlj_sign&sign=${t}`),a=await n.text();if(!/成功！|打过卡/.test(a))throw new Error("自动签到失败");o.toast.success("自动签到成功"),localStorage.setItem("signDate",e)}catch{o.toast.error("自动签到失败")}})(),r.关闭快捷导航的跳转&&n.querySelector("#qmenu a")?.setAttribute("href","javascript:;"),/thread(?:-\d+){3}|mod=viewthread/.test(document.URL)){for(const e of n.querySelectorAll('img[file*="sinaimg.cn"]'))e.setAttribute("referrerpolicy","no-referrer");const e=()=>{!n.querySelector(".pg > .prev")||a("flag","needAutoShow",!1);let e=n.querySelectorAll(":is(.t_fsz, .message) img");const t=()=>{let t=e.length;for(;t--;){const n=e[t],o=n.getAttribute("file");o&&n.src!==o&&(n.setAttribute("src",o),n.setAttribute("lazyloaded","true")),(n.src.includes("static/image")||n.complete&&n.naturalHeight&&n.naturalWidth&&n.naturalHeight<500&&n.naturalWidth<500)&&e.splice(t,1)}return e.map(e=>e.src)};a("comicMap","",{getImgList:t}),a("manga",{onLoading(e,t){if(t&&t.width<500&&t.height<500)return i()},onExit(e){e&&n.scrollIntoView(".psth, .rate, #postlist > div:nth-of-type(2)"),a("manga","show",!1)}}),n.querySelector("div.pti > div.authi")&&(n.querySelector("div.pti > div.authi").insertAdjacentHTML("beforeend",'<span class="pipe show">|</span><a id="comicReadMode" class="show" href="javascript:;">漫画阅读</a>'),document.getElementById("comicReadMode")?.addEventListener("click",()=>s())),n.querySelector("#threadindex")&&n.hijackFn("ajaxinnerhtml",()=>{e=n.querySelectorAll(".t_fsz img"),0!==e.length&&0!==t().length&&r.autoShow&&s()});const l=n.querySelector(".ptg.mbm.mtn > a");if(l){const[,e]=l.href.split("id="),t=/(?<=<th>\s<a href="thread-)\d+(?=-)/g;let n=[];const r=async(s=1)=>{const i=[...(await o.request(`/misc.php?mod=tag&id=${e}&type=thread&page=${s}`)).responseText.matchAll(t)].map(([e])=>Number(e));n=[...n,...i];const l=n.indexOf(unsafeWindow.tid);return i.length>0&&(-1===l||!n[l+1])?r(s+1):a("manga",{onPrev:n[l-1]?()=>location.assign(`thread-${n[l-1]}-1-1.html`):void 0,onNext:n[l+1]?()=>location.assign(`thread-${n[l+1]}-1-1.html`):void 0})};setTimeout(r)}},t=unsafeWindow.fid??Number(new URLSearchParams(n.querySelector("h2 > a")?.href).get("fid")??"-1");if(30===t||37===t)e();else{n.querySelector("div.pti > div.authi").insertAdjacentHTML("beforeend",'<span class="pipe show">|</span><a id="comicReadMode" class="show" href="javascript:;">漫画阅读</a>');const t=document.getElementById("comicReadMode");t?.addEventListener("click",()=>{t.previousElementSibling?.remove(),t.remove(),e(),s()})}if(r.记录阅读进度){const e=unsafeWindow.tid??new URLSearchParams(location.search).get("tid")??/\/thread-(\d+)-\d+-\d+.html/.exec(location.pathname)?.[1];if(!e)return;let t;try{const n=await o.request(`/api/mobile/index.php?module=viewthread&tid=${e}`,{responseType:"json",errorText:"获取帖子回复数时出错",noTip:!0});t=Number.parseInt(n.response?.Variables?.thread?.allreplies,10)}catch{}const a=Number.parseInt(n.querySelector("#pgt strong")?.textContent??n.querySelector("#dumppage")?.value??"1",10),r=await n.useCache({history:"tid"}),s=await r.get("history",`${e}`);if(s&&a<s.lastPageNum)return;const i=n.querySelectorAll(s?.lastAnchor&&a===s.lastPageNum?`#${s.lastAnchor} ~ div`:"#postlist > div, .plc.cl");if(0===i.length)return;let l=0;const c=e=>{l&&window.clearTimeout(l),l=window.setTimeout(async()=>{l=0,await r.set("history",e)},200)},d=new IntersectionObserver(n=>{const o=n.find(e=>e.isIntersecting);if(!o)return;const r=i.indexOf(o.target);if(-1!==r){for(const e of i.splice(0,r+1))d.unobserve(e);c({tid:`${e}`,lastPageNum:a,lastReplies:t||s?.lastReplies||0,lastAnchor:o.target.id})}},{rootMargin:"-160px"});for(const e of i)d.observe(e)}return}if(/forum(?:-\d+){2}|mod=forumdisplay/.test(document.URL)){if(r.修正点击页数时的跳转判定){const e=n.querySelectorAll(".tps>a");let t=e.length;for(;t--;)e[t].setAttribute("onClick","atarget(this)")}if(r.记录阅读进度){const o=await n.useCache({history:"tid"}),a=!document.querySelector("#flk"),[r,s]=t.createSignal(!1),i=()=>s(e=>!e);let l="tbody[id^=normalthread]",c=e=>e.id.split("_")[1],d=(e,t)=>`thread-${t}-${e.lastPageNum}-1.html#${e.lastAnchor}`;a&&(l=".threadlist li.list",c=e=>new URLSearchParams(e.children[1].getAttribute("href")).get("tid"),d=(e,t)=>`forum.php?mod=viewthread&tid=${t}&extra=page%3D1&mobile=2&page=${e.lastPageNum}#${e.lastAnchor}`);for(const s of n.querySelectorAll(l)){const i=c(s);e.render(()=>{const[l,c]=t.createSignal();n.createEffectOn(r,()=>o.get("history",i).then(c));const p=t.createMemo(()=>l()?d(l(),i):""),g=t.createMemo(()=>!a&&l()?Number(s.querySelector(".num a").innerHTML)-l().lastReplies:0);return e.createComponent(t.Show,{get when(){return Boolean(l())},get children(){return e.createComponent(t.Show,{when:a,get children(){return t=e.template("<li><a>回第<!>页")(),o=(n=t.firstChild).firstChild.nextSibling,e.addEventListener(n,"click",unsafeWindow.atarget,!0),e.setStyleProperty(n,"color","unset"),e.insert(n,()=>l()?.lastPageNum,o),e.effect(()=>e.setAttribute(n,"href",p())),t;var t,n,o},get fallback(){return[(n=e.template("<a class=historyTag>回第<!>页 ")(),o=n.firstChild.nextSibling,e.addEventListener(n,"click",unsafeWindow.atarget,!0),e.insert(n,()=>l()?.lastPageNum,o),e.effect(()=>e.setAttribute(n,"href",p())),n),e.createComponent(t.Show,{get when(){return g()>0},get children(){var t=e.template("<div class=historyTag>+")();return e.insert(t,g,null),t}})];var n,o}})}})},a?s.children[3]:s.getElementsByTagName("th")[0])}document.addEventListener("visibilitychange",i),n.querySelector("#autopbn")?.addEventListener("click",i)}if(r.移动端显示帖子权限&&/mod=forumdisplay/.test(document.URL)){const e=new URL(location.href);e.pathname="/api/mobile/index.php",e.searchParams.set("module",e.searchParams.get("mod")),e.searchParams.delete("mod");const t=await o.request(`${e}`,{responseType:"json",errorText:"获取帖子权限时出错"}),a=new Map;for(const{tid:e,readperm:n}of t.response.Variables.forum_threadlist)"0"!==n&&a.set(Number(e),Number(n));for(const e of n.querySelectorAll(".threadlist li.list")){const t=e.querySelector('a[href*="&tid="]'),n=Number(new URLSearchParams(t.href).get("tid"));a.has(n)&&e.querySelector(".threadlist_foot li.mr").insertAdjacentHTML("beforeend",`<span style="margin-right: .5em; color: #EE1B2E">#权限${a.get(n)}</span>`)}}}})().catch(e=>n.log.error(e)),e.delegateEvents(["click"]);break}case"www.yamibo.com":{if(!location.pathname.includes("/manga/view-chapter"))break;const e=new URLSearchParams(location.search).get("id");if(!e)break;const t=Number(d.querySelector("section div:first-of-type div:last-of-type").innerHTML.split("：")[1]);if(Number.isNaN(t))throw new Error(d.t("site.changed_load_failed"));const n=async t=>{const n=await g.request(`https://www.yamibo.com/manga/view-chapter?id=${e}&page=${t}`);return/(?<=<img id=['"]imgPic['"].+?src=['"]).+?(?=['"])/.exec(n.responseText)[0].replaceAll("&amp;","&").replaceAll("http://","https://")};h={name:"newYamibo",getImgList:({dynamicLazyLoad:e})=>e({loadImg:n,length:t}),onNext:d.querySelectorClick("#btnNext"),onPrev:d.querySelectorClick("#btnPrev"),onExit:e=>e&&d.scrollIntoView("#w1")};break}case"comic.idmzj.com":case"comic.dmzj.com":case"manhua.idmzj.com":case"manhua.dmzj.com":{const e=l("solid-js/web"),t=l("solid-js"),n=l("helper"),o=l("main"),a=l("userscript/dmzjApi");(async()=>{const r=async()=>{const[,e,t]=location.pathname.split(/\/|\./);return e||o.toast.error("漫画数据获取失败",{duration:Number.POSITIVE_INFINITY,throw:new Error("获取漫画拼音简称失败")}),{comicId:await a.getComicId(e),chapterId:t}},s=e=>{const t=n.querySelector(e);if(t?.textContent)return()=>t.click()};await o.universal({name:"dmzj",getImgList:async()=>(await(async()=>{await n.waitDom("#qiehuan_txt"),await n.wait(()=>{const e=n.querySelector("#qiehuan_txt");if(e)return"切换到上下滚动阅读"!==e.textContent||void e.click()})})(),await n.waitDom(".comic_wraCon img"),n.querySelectorAll(".comic_wraCon img").map(e=>e.src)),onExit:e=>e&&n.scrollIntoView("#hd"),async getCommentList(){const{comicId:e,chapterId:t}=await r();return a.getViewpoint(e,t)},SPA:{isMangaPage:()=>/^\/[^/]*\/?$/.test(location.pathname)?(async()=>{if(await n.waitDom(".commentBox"),!n.querySelector(".cartoon_online_border > img"))return!1;n.querySelector(".cartoon_online_border").innerHTML="获取漫画数据中";for(const e of n.querySelectorAll(".odd_anim_title ~ *"))e.remove();const{comicId:o}=await r();return e.render(()=>{const n=a.useComicDetail(o);return e.createComponent(t.For,{get each(){return n.chapters},children:({name:a,list:r})=>{return[(l=e.template('<div class=photo_part><div class=h2_title2><span class="h2_icon h2_icon22"></span><h2> ')(),c=l.firstChild.firstChild.nextSibling,d=c.firstChild,e.insert(c,()=>n.title,d),e.insert(c,"连载"===a?"在线漫画全集":`漫画其它版本：${a}`,null),l),(s=e.template("<div class=cartoon_online_border_other style=margin-top:-8px><ul></ul><div class=clearfix>")(),i=s.firstChild,e.insert(i,e.createComponent(t.For,{each:r,children:({title:t,id:a,updatetime:r})=>{return s=e.template("<li><a target=_blank>")(),i=s.firstChild,e.setAttribute(i,"title",t),e.setAttribute(i,"href",`https://m.dmzj.com/view/${o}/${a}.html`),e.insert(i,t),e.effect(()=>i.classList.toggle("color_red",!(r!==n.last_updatetime))),s;var s,i}})),s)];var s,i,l,c,d}})},n.querySelector(".middleright_mr")),!1})():/^\/.*?\/\d+\.shtml$/.test(location.pathname),getOnPrev:()=>s(".display_left #prev_chapter"),getOnNext:()=>s(".display_right #next_chapter")}})})().catch(e=>n.log.error(e));break}case"m.idmzj.com":case"m.dmzj.com":{const e=l("dmzjDecrypt"),t=l("helper"),n=l("main"),o=l("userscript/dmzjApi");(async()=>{switch(location.pathname.split("/")[1]){case"info":{if(Reflect.has(unsafeWindow,"obj_id"))return;const o=Number.parseInt(location.pathname.split("/")[2],10);if(Number.isNaN(o))return document.body.innerHTML="",document.body.insertAdjacentHTML("beforeend",'\n            请手动输入漫画名进行搜索 <br />\n            <input type="search"> <button>搜索</button> <br />\n            <div id="list" />\n          '),void t.querySelector("button").addEventListener("click",async()=>{const e=t.querySelector("input")?.value;if(!e)return;const o=await n.request(`https://s.acg.dmzj.com/comicsum/search.php?s=${e}`,{errorText:"搜索漫画时出错"}),a=JSON.parse(o.responseText.slice(20,-1));t.querySelector("#list").innerHTML=a.map(({id:e,comic_name:t,comic_author:n,comic_url:o})=>`\n                <b>《${t}》<b/>——${n}\n                <a href="${o}">Web端</a>\n                <a href="https://m.dmzj.com/info/${e}.html">移动端</a>\n              `).join("<br />")});const a=await n.request(`https://v4api.idmzj.com/comic/detail/${o}?uid=2665531&disable_level=1`,{errorText:"获取漫画数据失败"}),{comicInfo:{last_updatetime:r,title:s,chapters:i}}=e(a.responseText);document.title=s,document.body.insertAdjacentHTML("beforeend",`<h1>${s}</h1>`);for(const e of Object.values(i)){let t=`<h2>${e.title}</h2>`,n=e.data.length;for(;n--;)t+=`<a target="_blank" title="${e.data[n].chapter_title}" href="https://m.dmzj.com/view/${o}/${e.data[n].chapter_id}.html" ${e.data[n].updatetime===r?'style="color:red"':""}>${e.data[n].chapter_title}</a>`;document.body.insertAdjacentHTML("beforeend",t)}document.body.childNodes[0].remove(),t.useStyle("\n          h1 { margin: 0 -20vw; }\n          h1, h2 { text-align: center; }\n          body { padding: 0 20vw; }\n          a {\n            display: inline-block;\n\n            min-width: 4em;\n            margin: 0 1em;\n\n            line-height: 2em;\n            white-space: nowrap;\n          }\n        ");break}case"view":{if(unsafeWindow.comic_id)return t.useStyle(".subHeader{display:none !important}"),void await n.universal({name:"dmzj",getImgList:()=>t.querySelectorAll("#commicBox img").map(e=>e.dataset.original).filter(Boolean),getCommentList:()=>o.getViewpoint(unsafeWindow.subId,unsafeWindow.chapterId),onNext:t.querySelectorClick("#loadNextChapter"),onPrev:t.querySelectorClick("#loadPrevChapter")});const e=document.createElement("p");let a,r,s;e.textContent="正在加载中，请坐和放宽，若长时间无反应请刷新页面",document.body.append(e);try{[,r,s]=/(\d+)\/(\d+)/.exec(location.pathname),a=await o.getChapterInfo(r,s)}catch(t){throw n.toast.error("获取漫画数据失败",{duration:Number.POSITIVE_INFINITY}),e.textContent=t.message,t}e.textContent="加载完成，即将进入阅读模式";const{folder:i,chapter_name:l,next_chap_id:c,prev_chap_id:d,comic_id:p,page_url:g}=a;document.title=`${l} ${i.split("/").at(1)}`;const{setState:m}=await n.useInit("dmzj");m(t=>{t.manga.onExit=void 0,t.manga.onNext=c?()=>{location.href=`https://m.dmzj.com/view/${p}/${c}.html`}:void 0,t.manga.onPrev=d?()=>{location.href=`https://m.dmzj.com/view/${p}/${d}.html`}:void 0,t.manga.editButtonList=e=>e,t.comicMap[""].getImgList=()=>g.length>0?g:(e.innerHTML='无法获得漫画数据，请通过 <a href="https://github.com/hymbz/ComicReadScript/issues" target="_blank">Github</a> 或 <a href="https://sleazyfork.org/zh-CN/scripts/374903-comicread/feedback#post-discussion" target="_blank">Greasy Fork</a> 进行反馈',[])}),m("manga","commentList",await o.getViewpoint(r,s));break}}})().catch(e=>t.log.error(e));break}case"www.idmzj.com":case"www.dmzj.com":{const e=l("helper"),t=l("main"),n=l("userscript/dmzjApi"),o=e=>{if(e)return()=>{window.open(location.href.replace(/(?<=\/)\d+(?=\.html)/,`${e}`),"_self")}};(async()=>{await e.waitDom(".head_wz");const a=e.querySelector(".head_wz [id]")?.id,r=/(?<=\/)\d+(?=\.html)/.exec(location.pathname)?.[0];if(!a||!r)return;const{setState:s}=await t.useInit("dmzj");try{const{next_chap_id:e,prev_chap_id:t,page_url:i}=await n.getChapterInfo(a,r);s(n=>{n.comicMap[""].getImgList=()=>i,n.manga.onNext=o(e),n.manga.onPrev=o(t)})}catch{t.toast.error("获取漫画数据失败",{duration:Number.POSITIVE_INFINITY})}})().catch(t=>e.log.error(t));break}case"exhentai.org":case"e-hentai.org":{const e=l("solid-js/web"),t=l("solid-js"),n=l("components/Manga"),o=l("helper"),a=l("main"),r=l("solid-js/store"),s=l("userscript/detectAd"),i=l("request"),c=l("userscript/ehTagRules"),d=async e=>{const t=e?`/mytags?tagset=${e}`:"/mytags",n=await a.request(t,{fetch:!0});return o.domParse(n.responseText)},p=(e,t=[])=>{const n=e.querySelector("#tagcolor").value.slice(1)||"0",[,...o]=[...e.getElementById("usertags_outer").children];for(const e of o){const o=Number(e.id.split("usertag_")[1]),a=e.querySelector(`#tagpreview_${o}`),{color:r,borderColor:s}=a.style;let[i,l]=a.title.split(":");switch(i){case"female":case"male":case"mixed":i="gender"}const c=Number.parseInt(e.querySelector(`#tagcolor_${o}`).value.slice(1)||n,16);t.push({e:e,id:o,title:a.title,color:c,fontColor:r,borderColor:s,group:i,name:l,weight:Number(e.querySelector("input[id^=tagweight_]").value),watch:e.querySelector(`#tagwatch_${o}`).checked,hidden:e.querySelector(`#taghide_${o}`).checked,order:-1})}return t},g=e=>{const t=new Intl.Collator,n=(e,n)=>e.color!==n.color?n.color-e.color:e.group!==n.group?t.compare(e.group,n.group):e.hidden!==n.hidden?e.hidden?1:-1:e.watch!==n.watch?e.watch?-1:1:e.weight!==n.weight?n.weight-e.weight:t.compare(e.name,n.name);let o=-e.length;for(const t of e.sort(n))t.order=o++;return e},m=async()=>{const e=[],t=await d();await Promise.all([...t.querySelectorAll("#tagset_outer select option")].map(async n=>{const o=n.selected?t:await d(n.value);o.querySelector("#tagset_enable")?.checked&&e.push(o)}));const n=[];for(const t of e)p(t,n);return g(n)},u=new Set,h=async()=>{const e=await m();for(const t of u)await t(e)},_=(e,t)=>`\n${[...e].map(e=>`${t}${CSS.escape(e)}`).join(",\n")}\n`,f=async e=>{const t={},n={},o={};for(const a of e){const{color:e,borderColor:r,fontColor:s}=a,i=a.title.replaceAll(" ","_");(t[e]||=new Set).add(i),(n[r]||=new Set).add(i),(o[s]||=new Set).add(i)}let a="";for(const[e,n]of Object.entries(t))a+=`:is(${_(n,"#td_")})`,a+=`{ background: #${Number(e).toString(16).padStart(6,"0")}; }\n\n`;for(const[e,t]of Object.entries(n))a+=`:is(${_(t,"#td_")}).gt`,a+=`{ border-color: ${e}; }\n\n`;for(const[e,t]of Object.entries(o))a+=`:is(${_(t,"#td_")}):not(.gt)`,a+=`{ border-color: ${e}; }\n\n`,a+=`#taglist a:is(${_(t,"#ta_")})`,a+=`{ color: ${e} !important; position: relative; }\n\n`;return a+='\n    /* 禁用 eh 的变色效果，必须使用 !important */\n    #taglist a[id] { color: var(--tag) !important; position: relative; }\n    #taglist a[id]:hover { color: var(--tag-hover) !important; }\n\n    #taglist a[id]::after {\n      content: "";\n      background: var(--color);\n      width: 100%;\n      position: absolute;\n      left: 0;\n      height: 2px;\n      bottom: -7px;\n    }\n    .tup { --color: var(--tup) }\n    .tdn { --color: var(--tdn) }\n    #taglist a[id][style="color: blue;"] { --color: blue; }\n\n    /* 避免被上一行的下划线碰到 */\n    #taglist div:is(.gt, .gtl, .gtw) { margin-top: 1px; }\n  ',await GM.setValue("ehTagColorizeCss",a),a},b=async e=>{switch(u.add(f),e){case"gallery":{let e="https://exhentai.org"===location.origin?"--tag: #DDDDDD; --tag-hover: #EEEEEE; --tup: #00E639; --tdn: #FF3333;":"--tag: #5C0D11; --tag-hover: #8F4701; --tup: green; --tdn: red;";return e=`#taglist { ${e} }\n\n`,e+=await o.getGmValue("ehTagColorizeCss",h),o.useStyle(e)}case"mytags":h(),o.hijackFn("usertag_callback",o.debounce(h))}},w={cross_site_link:!0,add_hotkeys_actions:!0,detect_ad:!0,quick_favorite:!0,colorize_tag:!1,quick_rating:!0,quick_tag_define:!0,float_tag_list:!1,auto_adjust_option:!1,tag_lint:!1,expand_tag_list:!0,autoShow:!1},y=async()=>{let n;if(n=Reflect.has(unsafeWindow,"display_comment_field")?"gallery":"/mytags"===location.pathname?"mytags":Reflect.has(unsafeWindow,"mpvkey")?"mpv":o.querySelector('option[value="t"]')?.parentElement?.value,!n)return;const r=await a.useInit("ehentai",w);if("gallery"!==n)return{type:n,...r};let s=0;if(s=Number(o.querySelector(".gtb .gpc")?.textContent?.replaceAll(",","").match(/\d+/g)?.at(-1)),Number.isNaN(s)){const{responseText:e}=await a.request(location.href);s=Number(/(?<=class="gdt2">)\d+(?= pages<\/td>)/.exec(e)?.[0])}const i=o.querySelector("#newtagfield");return i?.addEventListener("keydown",e=>"Escape"===e.key&&i.blur()),{type:"gallery",...r,galleryId:Number(location.pathname.split("/")[2]),galleryTitle:o.querySelector("#gn")?.textContent||void 0,japanTitle:o.querySelector("#gj")?.textContent||void 0,imgNum:s,imgList:o.range(s,""),pageList:[],fileNameList:[],LoadButton(n){const o=t.createMemo(()=>{const e=r.store.comicMap[n.id]?.imgList;if(0===e?.length)return` loading - 0/${s}`;const t=e?.filter(Boolean).length;switch(e?.length){case void 0:return" Load comic";case t:return" Read";default:return` loading - ${t}/${s}`}});return(a=e.template("<a href=javascript:;>")()).$$click=async e=>{await(n.onClick?.(e)),r.showComic(n.id)},e.insert(a,o),a;var a},dom:{newTagField:i}}};e.delegateEvents(["click"]);const v=new Map(["关闭显示标签定义","取消选中当前标签","关闭浮动标签栏"].map(e=>[e,()=>!0])),x=()=>{const e=new Set,t=new Set;for(const n of o.querySelectorAll("#taglist table [id^=td_]")){const[o]=n.getElementsByTagName("a");o.classList.contains("tdn")||(o.classList.contains("tup")||n.classList.contains("gt")?e.add(n.id.slice(3)):n.classList.contains("gtl")&&t.add(n.id.slice(3)))}return[e,t]},$=e=>{const[t,n]=e.trim().split(":");return n?[t,n.replaceAll(/[^a-z-_ ]/gi,"")]:["",""]},S=[["artist","a"],["character","c","char"],["cosplayer","c","os"],["female","f"],["group","g","circle"],["language","l","lang"],["male","m"],["mixed","x"],["other","o"],["parody","p","series"],["reclass","r"]],k=e=>{const[t,n]=$(e);for(const e of S)if(e.includes(t))return`${e[0]}:${n}`;return e},I={Western:"ta",Misc:"t1",Doujinshi:"t2",Manga:"t3","Artist CG":"t4","Game CG":"t5","Image Set":"t6",Cosplay:"t7","Asian Porn":"t8","Non-H":"t9"},M=(...e)=>Boolean(o.querySelector(`#gdc > .cs:is(${e.map(e=>`.c${I[e]}`).join(", ")})`)),C=(e,t,n)=>{const o=new URL(e.pageList[t]);o.searchParams.set("nl",n),e.pageList[t]=o.href},L=async({setState:e,galleryTitle:t})=>{const{response:{result:n}}=await a.request(`https://nhentai.net/api/galleries/search?query=${t}`,{responseType:"json",errorText:o.t("site.ehentai.nhentai_error"),noTip:!0,headers:{"User-Agent":navigator.userAgent},fetch:!1});return n.map(({id:t,title:n,images:r,num_pages:s,media_id:i})=>{const l=`@nh:${t}`;return e("comicMap",l,{getImgList:({dynamicLazyLoad:e})=>e({loadImg:e=>(async(e,t,n)=>{const r=await a.request(`https://i.nhentai.net/galleries/${t}/${e+1}.${o.fileType[n]}`,{headers:{Referer:`https://nhentai.net/g/${t}`},responseType:"blob",fetch:!1});return URL.createObjectURL(r.response)})(e,i,r.pages[e].t),length:s,id:l})}),{id:l,showText:`${t}`,title:n.english||n.japanese,href:`https://nhentai.net/g/${t}`,class:"gtl"}})};L.errorTip=e=>o.t("site.ehentai.nhentai_failed",{nhentai:`<a href='https://nhentai.net/search/?q=${e.galleryTitle}' target="_blank"> <u> nhentai </u> </a>`});const T=async({setState:e,galleryId:t})=>{const n="gold-usergeneratedcontent.net",r=async e=>{const n=await a.request(e,{headers:{Referer:`https://hitomi.la/reader/${t}.html`},responseType:"blob",fetch:!1});return URL.createObjectURL(n.response)},s=await a.request(`https://ltn.${n}/galleries/${t}.js`,{errorText:o.t("site.ehentai.hitomi_error"),noTip:!0,noCheckCode:!0});switch(s.status){case 404:return[];case 200:break;default:throw new Error(o.t("site.ehentai.hitomi_error"))}const i=JSON.parse(s.responseText.slice(18)),l=`@hitomi:${i.id}`;return e("comicMap",l,{getImgList:async({dynamicLazyLoad:e})=>{const{responseText:t}=await a.request(`https://ltn.${n}/gg.js?_=${Date.now()}`,{errorText:o.t("site.ehentai.hitomi_error"),noTip:!0});let s={};return eval(t),e({loadImg:async e=>{const{hash:t,name:o}=i.files[e],a=s.s(t),l=/[\da-f]{61}([\da-f]{2})([\da-f])/.exec(t),c=Number.parseInt(l[2]+l[1],16),d=`https://w${s.m(c)+1}.${n}/${s.b}${a}/${t}.webp`;return{src:await r(d),name:o}},length:i.files.length,id:l,concurrency:1})}}),[{id:l,showText:i.id,title:i.title,href:`https://hitomi.la/galleries/${i.id}`,class:"gt"}]};T.errorTip=()=>o.t("site.ehentai.hitomi_error");const P=async n=>{if(!n.galleryTitle)return a.toast.error(o.t("site.ehentai.html_changed_link_failed"));const s=[];if(M("Doujinshi","Manga","Artist CG","Game CG","Image Set")&&s.push(T),M("Doujinshi","Manga")&&s.push(L),0===s.length)return;const[i,l]=r.createStore({}),c=t=>{return n=e.template("<div><a>")(),o=n.firstChild,e.setStyleProperty(n,"opacity","1.0"),e.effect(a=>{var r=`td_${t.id}`,s=t.class,i=t.title,l=t.id,c=t.href,d=`return toggle_tagmenu(1, '${t.id}',this)`,p=t.title,g=t.showText;return r!==a.e&&e.setAttribute(n,"id",a.e=r),s!==a.t&&e.className(n,a.t=s),i!==a.a&&e.setAttribute(n,"title",a.a=i),l!==a.o&&e.setAttribute(o,"id",a.o=l),c!==a.i&&e.setAttribute(o,"href",a.i=c),d!==a.n&&e.setAttribute(o,"onclick",a.n=d),p!==a.s&&e.setAttribute(o,"title",a.s=p),g!==a.h&&(o.innerText=a.h=g),a},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),n;var n,o},d=()=>e.render(()=>e.createComponent(t.For,{get each(){return Object.entries(i)},children:([n,o])=>{return s=(r=(a=e.template("<tr><td class=tc>:")()).firstChild).firstChild,e.setAttribute(a,"id",`${n}_tagline`),e.insert(r,n,s),e.insert(a,e.createComponent(t.Show,{when:"string"!=typeof o,get fallback(){return(t=e.template("<td class=tc style=text-align:left>")()).innerHTML=o,t;var t},get children(){var n=e.template("<td>")();return e.insert(n,e.createComponent(t.For,{each:o,children:c})),n}}),null),a;var a,r,s}}),o.querySelector("#taglist tbody"));d(),o.hijackFn("tag_update_vote",()=>{for(const e of o.querySelectorAll("#nh_tagline"))e.remove();d()});const p=n=>e.createComponent(t.For,{get each(){return n.children},children:t=>[e.template('<img src=https://ehgt.org/g/mr.gif class=mr alt=">">')(),t]}),g=document.getElementById("tagmenu_act");let m;o.hijackFn("_refresh_tagmenu_act",(t,[o])=>{if(m?.(),!o.id.startsWith("@"))return t(o);g.children.length>0&&(g.innerHTML=""),m=e.render(()=>e.createComponent(p,{get children(){return[(t=e.template("<a target=_blank>")(),t.innerText=" Jump",e.effect(()=>e.setAttribute(t,"href",o.href)),t),e.createComponent(n.LoadButton,{get id(){return o.id}})];var t}}),g)});for(const e of s){l(e.name,"searching...");try{const t=await e(n);t.length>0?l(e.name,t):l(e.name,"null")}catch(t){const o=e.errorTip(n);console.error(o,t),l(e.name,o)}}const{adList:u}=n.store.comicMap[""];if(u)for(const e of Object.values(i))"string"!=typeof e&&1===e.length&&n.setState("comicMap",e[0].id,{adList:u})},A=({store:{comicMap:e},setState:t,options:n,imgList:r,pageList:i,fileNameList:l})=>{if(!n.detect_ad||!document.getElementById("ta_other:extraneous_ads"))return;t("comicMap","","adList",new a.ReactiveSet);const c=[];for(const e of o.querySelectorAll("#gdt > a")){const t=Number(/.+-(\d+)/.exec(e.href)?.[1])-1;if(Number.isNaN(t))continue;i[t]=e.href;const n=e.querySelector("[title]");[,l[t]]=n.title.split(/：|: /),c[t]="IMG"===n.tagName?n:/url\("(.+)"\)/.exec(n.style.backgroundImage)[1]}return(async()=>{await s.getAdPageByFileName(l,e[""].adList),0===e[""].adList.size&&await s.getAdPageByContent(c,e[""].adList),o.useStyle(o.createRootMemo(()=>e[""]?.adList?.size?[...e[""].adList].map(e=>`a[href="${i[e]}"] [title]:not(:hover) {\n              filter: blur(8px);\n              clip-path: border-box;\n              backdrop-filter: blur(8px);\n            }`).join("\n"):""))})(),{checkFileName:()=>s.getAdPageByFileName(l,e[""].adList),checkContent:()=>s.getAdPageByContent(r,e[""].adList)}},E=e=>{if("t"!==e.type)return;o.useStyle(`\n    #taglist {\n      height: auto;\n      max-height: 230px;\n      padding: 0 3px;\n\n      --scrollbar-slider: ${getComputedStyle(o.querySelector(".ido")).backgroundColor};\n      scrollbar-color: var(--scrollbar-slider) transparent;\n      scrollbar-width: thin;\n      &::-webkit-scrollbar { width: 5px; height: 10px; }\n      &::-webkit-scrollbar-track { background: transparent; }\n      &::-webkit-scrollbar-thumb { background: var(--scrollbar-slider); }\n    }\n    .gl1t[data-tag-list-loading], .gl1t[data-tag-list-loading] * { cursor: progress; }\n    .gl1t[data-show-tag-list] .gl6t { display: none; }\n    .gl1t:not([data-show-tag-list]) #taglist { display: none; }\n\n    /* 长标签换行 */\n    #taglist [id^=td_] a[id^=ta_] {\n      text-wrap: balance;\n      word-break: keep-all;\n      overflow-wrap: anywhere;\n    }\n  `);const r=new Map,s=async e=>{if("progress"!==e.style.cursor){if(!r.has(e)){let t,n=null;try{e.dataset.tagListLoading="";const r=await a.request(e.querySelector("a").href,{noTip:!0,errorText:"Fetch tag list error",noCheckCode:!0});if(t=o.domParse(r.responseText),n=t.querySelector("#taglist"),!n)throw new Error("Fetch tag list error");const[,s]=t.querySelector("#gdt div[title][style]").style.background.split('"');(new Image).src=s;for(const e of n.querySelectorAll("a"))e.target="_blank"}catch{n=document.createElement("div"),n.id="taglist",n.textContent=t?.querySelector(".d p")?.textContent||"Fetch tag list error"}e.querySelector(".gl3t").after(n),r.set(e,n),Reflect.deleteProperty(e.dataset,"tagListLoading")}Reflect.has(e.dataset,"showTagList")?Reflect.deleteProperty(e.dataset,"showTagList"):e.dataset.showTagList=""}};for(const e of o.querySelectorAll(".gl1t"))e.addEventListener("click",t=>t.target.matches(":not(a):is(.gl1t, .gl6t, .gl6t *, #taglist, #taglist *)")&&s(e));n.setDefaultHotkeys(e=>({...e,float_tag_list:["q"]}));const[i,l]=t.createSignal([0,0]);document.addEventListener("pointermove",e=>l([e.clientX,e.clientY])),n.listenHotkey({float_tag_list:()=>{for(const e of document.elementsFromPoint(...i()))if(e.matches(".gl1t"))return s(e)}}),b("gallery")},N='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" fill="currentColor" stroke-width="0"><path d="M18 7h-6c-.55 0-1 .45-1 1v4c0 .55.45 1 1 1h6c.55 0 1-.45 1-1V8c0-.55-.45-1-1-1m3-4H3c-1.1 0-2 .9-2 2v14c0 1.1.9 1.98 2 1.98h18c1.1 0 2-.88 2-1.98V5c0-1.1-.9-2-2-2m-1 16.01H4c-.55 0-1-.45-1-1V5.98c0-.55.45-1 1-1h16c.55 0 1 .45 1 1v12.03c0 .55-.45 1-1 1"/></svg>',R=e=>{const t=e.getBoundingClientRect(),n=getComputedStyle(e),o=Number.parseFloat(n.borderLeftWidth),a=Number.parseFloat(n.paddingLeft),r=Number.parseFloat(n.paddingTop),s=Number.parseFloat(n.borderTopWidth);return{left:t.left+o+a,top:t.top+s+r,width:n.width,height:n.height}},D=({store:{manga:e},dom:{newTagField:t}})=>{const a=o.querySelector("#gd4"),r=getComputedStyle(a);let s="rgba(0, 0, 0, 0)",i=a;for(;"rgba(0, 0, 0, 0)"===s;)s=getComputedStyle(i).backgroundColor,i=i.parentElement;const{borderColor:l}=getComputedStyle(o.querySelector("#gdt")),c=`1px solid ${l}`;o.useStyle(`\n      #comicread-tag-box {\n        position: fixed;\n        z-index: 2147483647;\n\n        font-size: 12px;\n        text-align: justify;\n\n        background: ${s};\n        box-shadow: 0 0 15px -3px #0004;\n      }\n\n      #comicread-tag-box > #gd4 {\n        margin: 0;\n        padding: 0;\n        border: none;\n      }\n\n      #comicread-tag-box > #ehs-introduce-box {\n        position: relative;\n        width: 161px;\n        height: 100%;\n        border-left: ${c};\n      }\n\n      /* 确保始终显示在最上层，防止和其他脚本冲突 */\n      #ehs-introduce-box { z-index: 1; }\n\n      #comicread-tag-box-placeholder {\n        cursor: pointer;\n\n        float: left;\n        display: flex;\n        grid-area: gd4;\n        justify-content: center;\n\n        margin: 0 0 0 10px;\n        padding: 0 0 0 5px;\n\n        border-right: 1px solid ${l};\n        border-left: 1px solid ${l};\n      }\n\n      #comicread-tag-box-placeholder svg {\n        width: 17em;\n        opacity: 0.5;\n      }\n\n      /* 防止在窗口变小时确认按钮被挤出范围 */\n      #tagmenu_new {\n        width: fit-content;\n      }\n    `);const{store:d,setState:p}=o.useStore({open:!1,top:0,left:0,opacity:1,mouse:{x:0,y:0},bound:{width:0,height:0}}),g=(e,t,n)=>{e.top=o.clamp(.75*-a.clientHeight,t,e.bound.height),e.left=o.clamp(.75*-a.clientWidth,n,e.bound.width)},m=e=>p("opacity",o.clamp(.5,e,1));m(Number(localStorage.getItem("floatTagListOpacity"))||1),document.addEventListener("pointermove",e=>{p(t=>{t.mouse.x=e.clientX,t.mouse.y=e.clientY})});const u=()=>{p(e=>{e.bound.width=window.innerWidth-a.clientWidth/4,e.bound.height=window.innerHeight-a.clientHeight/4,g(e,e.top,e.left)})};window.addEventListener("resize",u),u(),o.useStyleMemo("#comicread-tag-box",{display:()=>d.open?void 0:"none",top:()=>`${d.top}px`,left:()=>`${d.left}px`,opacity:()=>d.opacity});const h=a.cloneNode();h.id="comicread-tag-box-placeholder",h.style.display="none",h.addEventListener("click",()=>p("open",!1)),h.innerHTML=N,a.before(h);const _=document.createElement("div");_.id="comicread-tag-box",_.classList.add("comicread-ignore"),document.body.append(_),_.addEventListener("wheel",e=>{e.shiftKey&&(e.stopPropagation(),e.preventDefault(),m(d.opacity+(e.deltaY>0?-.05:.05)),localStorage.setItem("floatTagListOpacity",`${d.opacity}`))},{passive:!1});const f={top:0,left:0};let b,w;o.useDrag({ref:a,handleDrag({type:t,xy:[n,r],initial:[s,i]}){switch(t){case"down":if(!d.open){const e=R(a);p(t=>{t.top=e.top,t.left=e.left})}f.top=d.top,f.left=d.left;break;case"up":p(t=>{if(e.show)return;const n=h.getBoundingClientRect();o.approx(t.top,n.top,50)&&o.approx(t.left,n.left,50)&&(t.open=!1)});break;case"move":p(e=>{g(e,f.top+r-i,f.left+n-s),e.open=!0})}},handleClick:(e,t)=>t.click(),skip:e=>!e.target.matches("#gd4, #taglist, #gwrd, td+td, [id^=comidread] *:not(a)")}),o.createEffectOn(()=>d.open,e=>{if((()=>{if(b)return;if(b=o.querySelector("#ehs-introduce-box"),!b)return;w=b.parentElement;const e=o.querySelector(".eh-syringe-lite-auto-complete-list");e&&(e.classList.add("comicread-ignore"),e.style.zIndex="2147483647",document.body.append(e)),o.hijackFn("toggle_tagmenu",()=>unsafeWindow.selected_tagname||o.querySelector("#ehs-introduce-box .ehs-close")?.click())})(),e){const{height:e,width:t}=r;h.style.cssText=`height: ${e}; width: ${t};`,_.style.height=e,a.style.width=t,_.append(a),b&&_.append(b),document.activeElement.blur()}else h.style.cssText="display: none;",a.style.width="",h.after(a),b&&w.append(b),n.focus()},{defer:!0}),n.setDefaultHotkeys(e=>({...e,float_tag_list:["q"]})),v.set("关闭浮动标签栏",()=>!d.open||p("open",!1)),n.listenHotkey({float_tag_list:()=>{p(e=>{e.open=!e.open,e.open&&g(e,e.mouse.y-a.clientHeight/2,e.mouse.x-a.clientWidth/2)})}}),o.hijackFn("tag_from_field",(e,t)=>(d.open&&document.activeElement.blur(),e(...t))),t.addEventListener("pointerenter",()=>d.open&&t.focus());const y=e=>{const n=(e=>{const t=o.querySelector(`a[href=${CSS.escape(e)}]`);if(t)return t.title||t.id.slice(3).replaceAll("_"," ")})(e.dataTransfer.getData("text"));n&&(e.preventDefault(),t.value.includes(n)||(t.value+=`${n}, `),t.dispatchEvent(new Event("input")))};t.addEventListener("drop",y);const x=o.querySelector("#taglist");x.addEventListener("dragover",e=>e.preventDefault()),x.addEventListener("dragenter",e=>e.preventDefault()),x.addEventListener("drop",y)},O=async(e,t)=>{const n=await i.request("/api.php",{fetch:!1,method:"POST",responseType:"json",cookie:document.cookie,data:JSON.stringify(e),...t});if(n.response.error)throw o.log.error(n.response.error),new Error(n.response.error);return n.response},z=async(e,t,n)=>{const o=e.pageList[t],[,a,r,s,i]=/\/s\/(\S+)\/(\d+)-(\d+)(?=$|\?nl=(\d+))/.exec(o),l={gid:r,page:s,imgkey:a};if(i&&(l.nl=i),e.mpvkey){const o=await O({method:"imagedispatch",...l,mpvkey:e.mpvkey},{noTip:!0});return n&&C(e,t,o.s),o.i}const c=await O({method:"showpage",...l,showkey:e.showkey},{noTip:!0});return n&&C(e,t,/nl\('(\d+-\d+)'\)/.exec(c.i3)[1]),/src="(\S+)"/.exec(c.i3)[1]},q=async(e,t)=>{if(e.showkey)return;const n=await i.request(t,{fetch:!0},10),[,o]=/showkey="(\S+)"/.exec(n.responseText);e.showkey=o},B=async e=>{if(e.mpvkey)return;const t=`${location.origin}${location.pathname}`.replace("/g/","/mpv/");if(!o.querySelector(`.g2 a[href="${t}"]`))return;const n=await i.request(t,{fetch:!0}),a=/mpvkey = "(\S+)"/.exec(n.responseText);if(!a)return;const[,r]=a;e.mpvkey=r},j=e=>{e.options.add_hotkeys_actions&&("gallery"===e.type?(v.set("取消选中当前标签",()=>!unsafeWindow.selected_tagname||unsafeWindow.toggle_tagmenu()),n.listenHotkey({ArrowUp:()=>unsafeWindow.selected_tagid&&unsafeWindow?.tag_vote_up(),ArrowDown:()=>unsafeWindow.selected_tagid&&unsafeWindow?.tag_vote_down(),scroll_right:()=>o.querySelector(".ptt td:last-child:not(.ptdd)")?.click(),scroll_left:()=>o.querySelector(".ptt td:first-child:not(.ptdd)")?.click()})):n.listenHotkey({scroll_right:()=>o.querySelector("#unext")?.click(),scroll_left:()=>o.querySelector("#uprev")?.click()}))},F='\n  .comidread-favorites {\n    position: absolute;\n    z-index: 75;\n    left: 0;\n\n    overflow: auto;\n    align-content: center;\n\n    box-sizing: border-box;\n    width: 100%;\n    padding-left: 0.6em;\n\n    border: none;\n    border-radius: 0;\n  }\n\n  .comidread-favorites-item {\n    cursor: pointer;\n\n    display: flex;\n    align-items: center;\n\n    width: 100%;\n    margin: 1em 0;\n\n    text-align: left;\n    overflow-wrap: anywhere;\n  }\n\n  .comidread-favorites-item > input {\n    pointer-events: none;\n    margin: 0 0.5em 0 0;\n  }\n\n  .comidread-favorites-item > div {\n    flex-shrink: 0;\n\n    width: 15px;\n    height: 15px;\n    margin: 0 0.5em 0 0;\n\n    background-image: url("https://ehgt.org/g/fav.png");\n    background-repeat: no-repeat;\n  }\n\n  .gl1t > .comidread-favorites {\n    padding: 1em 1.5em;\n  }\n',U=(n,r,s,i,l=0)=>{r.style.position="relative";const[c,d]=t.createSignal(!1),[p,g]=t.createSignal([]),[m,u]=t.createSignal(""),h=async()=>{try{const e=await a.request(s,{errorText:o.t("site.ehentai.fetch_favorite_failed")}),t=o.domParse(e.responseText),n=[...t.querySelectorAll(".nosel > div")];10===n.length&&(n[0].querySelector("input").checked=!1),u(t.querySelector('#galpop textarea[name="favnote"]')?.value??""),g(n)}catch{a.toast.error(o.t("site.ehentai.fetch_favorite_failed")),g([])}};let _=!1;const f=()=>{if(_)return;_=!0;const n=(n,r)=>{const{checked:i}=n.querySelector("input"),l=async()=>{if(i)return;d(!1);const e=new FormData;e.append("favcat",10===r()?"favdel":`${r()}`),e.append("apply","Apply Changes"),e.append("favnote",m()),e.append("update","1");const t=await a.request(s,{method:"POST",data:e,errorText:o.t("site.ehentai.change_favorite_failed")});a.toast.success(o.t("site.ehentai.change_favorite_success"));const n=/\nif\(window.opener.document.+\n/.exec(t.responseText)?.[0]?.replaceAll("window.opener.document","window.document");n&&eval(n),await h()};return c=e.template("<div class=comidread-favorites-item><input type=radio>")(),p=c.firstChild,c.$$click=l,p.checked=i,e.insert(c,e.createComponent(t.Show,{get when(){return r()<=9},get children(){var t=e.template("<div>")();return e.effect(()=>e.setStyleProperty(t,"background-position",`0px -${2+19*r()}px`)),t}}),null),e.insert(c,()=>n.textContent?.trim(),null),c;var c,p};let g="rgba(0, 0, 0, 0)",u=r;for(;"rgba(0, 0, 0, 0)"===g;)g=getComputedStyle(u).backgroundColor,u=u.parentElement;e.render(()=>e.createComponent(t.Show,{get when(){return c()},get children(){var o=e.template("<span class=comidread-favorites>")();return e.setStyleProperty(o,"background",g),e.setStyleProperty(o,"height",`${i}px`),e.setStyleProperty(o,"top",`${l}px`),e.insert(o,e.createComponent(t.For,{get each(){return p()},children:n,get fallback(){return e.template("<h3>loading...")()}})),o}}),r)},b=n.onclick;n.onclick=null,n.addEventListener("mousedown",async e=>{if(1===e.buttons||4===e.buttons){if(e.stopPropagation(),e.preventDefault(),e.shiftKey||e.ctrlKey||e.altKey||e.metaKey||4===e.buttons)return b.call(n,e);f(),d(e=>!e),c()&&await h()}})},W=e=>{switch(e.type){case"gallery":{o.useStyle(F);const e=o.querySelector("#gdf"),t=o.querySelector("#gd3"),n=e.firstElementChild.offsetTop;U(e,t,`${unsafeWindow.popbase}addfav`,n);break}case"t":o.useStyle(F);for(const e of o.querySelectorAll(".gl1t")){const t=e.querySelector("[id^=posted_]"),n=e.firstElementChild.getBoundingClientRect().bottom-e.getBoundingClientRect().top,o=e.lastElementChild.getBoundingClientRect().top-e.getBoundingClientRect().top,[a]=/http.+?(?=')/.exec(t.getAttribute("onclick"));U(t,e,a,o-n,n)}break;case"e":o.useStyle(F);for(const e of o.querySelectorAll(".gl1e")){const t=e.nextElementSibling.querySelector("[id^=posted_]"),n=Number.parseInt(getComputedStyle(e).height,10),[o]=/http.+?(?=')/.exec(t.getAttribute("onclick"));U(t,e,o,n)}}};e.delegateEvents(["click"]);const H=n=>{let r;switch(n.type){case"e":r=o.querySelectorAll("#favform > table > tbody > tr");break;case"m":case"p":case"l":r=o.querySelectorAll("#favform > table > tbody > tr").slice(1);break;case"t":r=o.querySelectorAll(".gl1t");break;default:return}o.useStyle("\n    .comidread-quick-rating {\n      position: absolute;\n      width: 100%;\n      height: 100%;\n      pointer-events: click;\n    }\n  ");const s=["0,0,7,16","8,0,15,16","16,0,23,16","24,0,31,16","32,0,39,16","40,0,47,16","48,0,55,16","56,0,63,16","64,0,71,16","72,0,79,16"],i=(e,t)=>{let n=Math.round(t+1);const o=16*Math.ceil(n/2)-80;n=n%2==1?-21:-1,e.style.backgroundPosition=`${o}px ${n}px`},l=(n,r,l)=>{let c=r.style.backgroundPosition;e.render(()=>{return g=(p=(d=e.template("<span class=comidread-quick-rating><img src=https://ehgt.org/g/blank.gif><map>")()).firstChild).nextSibling,d.$$mouseout=()=>{r.style.backgroundPosition=c},e.setAttribute(d,"data-index",l),e.setAttribute(p,"usemap",`#rating-${l}`),e.setAttribute(g,"name",`rating-${l}`),e.insert(g,e.createComponent(t.For,{each:s,children:(t,s)=>{return(l=e.template("<area shape=rect>")()).$$click=async()=>{const e=await(async(e,t)=>{try{const n=await a.request(e,{errorText:o.t("site.ehentai.change_rating_failed"),noTip:!0}),r=/api_url = "(.+?)";.+?gid = (\d+);.+?token = "(.+?)";.+?apiuid = (\d+);.+?apikey = "(.+?)"/s.exec(n.responseText);if(!r)throw new Error(o.t("site.ehentai.change_rating_failed"));const[,s,i,l,c,d]=r,p=await a.request(s,{method:"POST",responseType:"json",data:JSON.stringify({method:"rategallery",rating:`${t}`,apikey:d,apiuid:c,gid:i,token:l}),fetch:!0,noTip:!0});return a.toast.success(`${o.t("site.ehentai.change_rating_success")}: ${p.response.rating_usr}`),p.response}catch{throw a.toast.error(o.t("site.ehentai.change_rating_failed")),new Error(o.t("site.ehentai.change_rating_failed"))}})(n.querySelector("a").href,s()+1);r.className=e.rating_cls,i(r,2*e.rating_usr-1),c=r.style.backgroundPosition},l.$$mouseover=()=>i(r,s()),e.setAttribute(l,"coords",t),l;var l}})),d;var d,p,g},r)};for(const[e,t]of r.entries()){const n=[...t.querySelectorAll(".ir")].at(-1);n&&n.addEventListener("mouseenter",()=>l(t,n,e),{once:!0})}};e.delegateEvents(["mouseout","mouseover","click"]);const V=(t={})=>{return n=e.template('<svg xmlns=http://www.w3.org/2000/svg viewBox="0 0 24 24"stroke=currentColor fill=currentColor stroke-width=0><path d="M18 19H6c-.55 0-1-.45-1-1V6c0-.55.45-1 1-1h5c.55 0 1-.45 1-1s-.45-1-1-1H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-6c0-.55-.45-1-1-1s-1 .45-1 1v5c0 .55-.45 1-1 1M14 4c0 .55.45 1 1 1h2.59l-9.13 9.13a.996.996 0 1 0 1.41 1.41L19 6.41V9c0 .55.45 1 1 1s1-.45 1-1V3h-6c-.55 0-1 .45-1 1">')(),e.spread(n,t,!0,!0),n;var n},J=()=>{const n=r.createMutable({});o.useStyle("\n    #comidread-tag-define {\n      position: absolute;\n      z-index: 1;\n      top: 0;\n      left: 0;\n      width: 100%;\n      text-align: start;\n      padding: 0 1em;\n      box-sizing: border-box;\n    }\n\n    #taglist {\n      position: relative;\n    }\n\n    #comidread-tag-define h1 {\n      border-bottom: 1px solid #a2a9b1;\n      margin: 0.4em 0;\n    }\n\n    #comidread-tag-define h1 svg {\n      height: 0.7em;\n      margin-left: 0.2em;\n    }\n\n    #comidread-tag-define ul {\n      margin: 0.3em 0 0 1.6em;\n      padding: 0;\n    }\n\n    #comidread-tag-define li {\n      margin-bottom: 0.2em;\n    }\n\n    #comidread-tag-define div a {\n      text-decoration: underline;\n    }\n\n    #comidread-tag-define dd {\n      margin-left: 1.6em;\n    }\n\n    #comidread-tag-define dl {\n      margin-top: 0.2em;\n      margin-bottom: 0.5em;\n    }\n  ");const[s,i]=t.createSignal(!1),l=o.querySelector("#taglist");let c="rgba(0, 0, 0, 0)",d=l;for(;"rgba(0, 0, 0, 0)"===c;)c=getComputedStyle(d).backgroundColor,d=d.parentElement;e.render(()=>e.createComponent(t.Show,{get when(){return s()},get children(){var t=e.template("<span id=comidread-tag-define>")();return e.setStyleProperty(t,"background",c),e.insert(t,()=>n[unsafeWindow.selected_tagname]??e.template("<h3>loading...")()),e.effect(()=>e.setStyleProperty(t,"height",`${l.scrollHeight}px`)),t}}),l),unsafeWindow.tag_define=async()=>{if(unsafeWindow.selected_tagname){if(s())return i(!1);i(!0);try{await(async t=>{var r,s,i;if(Reflect.has(n,t))return;const l=`https://ehwiki.org/wiki/${t.replaceAll(/[a-z]+:\s?/gi,"")}`,c=await a.request(l,{noCheckCode:!0});if(200!==c.status)return void(n[t]=(r=e.template("<h3>")(),e.insert(r,()=>`${c.status} - ${c.statusText}`),r));const d=o.domParse(c.responseText).querySelector("#mw-content-text");for(const e of d.querySelectorAll('img[src^="/"]'))e.setAttribute("src",`https://ehwiki.org${e.getAttribute("src")}`);for(const e of d.getElementsByTagName("a")){const t=e.getAttribute("href")??"";t.startsWith("/")&&e.setAttribute("href",`https://ehwiki.org${t}`),e.target="_blank"}for(const e of d.querySelectorAll(".thumb"))e.remove();n[t]=[(s=e.template("<h1><a target=_blank>")(),i=s.firstChild,e.setAttribute(i,"href",l),e.insert(i,t,null),e.insert(i,e.createComponent(V,{}),null),s),d]})(unsafeWindow.selected_tagname)}catch(e){console.error(e),i(!1)}}},o.hijackFn("toggle_tagmenu",()=>i(!1)),v.set("关闭显示标签定义",()=>!s()||i(!1))},G=e=>{let t="tr a :is(.gltm, .glink + div:not([class])) { display: flex; }";for(const{title:n,order:o}of e)t+=`\n.gt[title="${n}"] { order: ${o}; }`;return GM.setValue("ehTagSortCss",t)},Y=async e=>{switch(u.add(G),e.type){case"p":case"l":case"t":return o.useStyle(await o.getGmValue("ehTagSortCss",h));case"mytags":{let e;const t=t=>{let n=`\n          #usertags_outer { display: flex; flex-direction: column; }\n          #usertags_outer > div { margin: unset; }\n          #usertag_0 { order: -${t.length}; }`;for(const{order:e,id:o}of t)n+=`\n#usertag_${o} { view-transition-name: _${o}; order: ${e}; }`;e||=GM_addElement("style",{textContent:n}),e.textContent=n};u.add(e=>{if(!document.startViewTransition)return t(e);document.startViewTransition(()=>t(e))})}}},K=({dom:{newTagField:n}})=>{const a=M("Doujinshi","Manga","Non-H"),r=c.getTagLintRules(),[s,i]=t.createSignal({});o.useStyle("\n    #comidread-tag-lint [id^=td_] {\n      display: inline-block;\n      float: none;\n    }\n  ");const l=t=>{return n=e.template("<div><a>")(),(o=n.firstChild).$$click=e=>e.preventDefault(),e.insert(o,()=>t.name),e.effect(a=>{var r,s,i=`td_${t.name}`,l=(r=t.name,void 0===(s=t.weak)?document.getElementById(`td_${r}`)?.className:s?"gtl":"gt"),c=`ta_${t.name}`,d=`https://exhentai.org/tag/${t.name.replaceAll("_","+")}`;return i!==a.e&&e.setAttribute(n,"id",a.e=i),l!==a.t&&e.className(n,a.t=l),c!==a.a&&e.setAttribute(o,"id",a.a=c),d!==a.o&&e.setAttribute(o,"href",a.o=d),a},{e:void 0,t:void 0,a:void 0,o:void 0}),n;var n,o},d=n=>{const a=c.splitTagNamespace(n.name);return e.createComponent(t.Show,{get when(){return a.length>1},get fallback(){return l(n)},get children(){var r=e.template("<span>「<!> 」")(),s=r.firstChild.nextSibling;return e.insert(r,e.createComponent(t.For,{each:a,children:(t,a)=>[e.memo(()=>e.memo(()=>!!a())()?` ${o.t("other.or")} `:""),e.createComponent(l,{name:t,get weak(){return n.weak}})]}),s),r}})},p=n=>{const[o,a,r]=n.text.split("[tag]");return e.createComponent(t.Show,{get when(){return n.warnList?.size},get children(){return e.createComponent(t.For,{get each(){return[...n.warnList.entries()]},children:([s,i])=>{return l=e.template("<li>")(),e.insert(l,o,null),e.insert(l,e.createComponent(d,{name:s}),null),e.insert(l,a,null),e.insert(l,e.createComponent(t.For,{each:i,children:t=>e.createComponent(d,{name:t,get weak(){return n.weak}})}),null),e.insert(l,r,null),l;var l}})}})};let g,m;const u=o.singleThreaded(()=>{const n={},[l,u]=x(),h=new Set([...l,...u]),_=(e,t,o=!1)=>{const a=r[t];if(a.has(e))for(const r of a.get(e)){if(c.hasTag(o?l:h,r)===o)continue;n[t]??=new Map([[e,[]]]);const a=n[t];a.has(e)||a.set(e,[]),a.get(e).push(r)}};for(const e of h)_(e,"prerequisite",!0),_(e,"conflict"),a&&_(e,"possibleConflict"),_(e,"combo",!0);const f=(e,t)=>{n.other??=[],n.other.push([e,t])},b=[];for(const e of u)if(/^(?:artist|group):/.test(e)){const t=o.querySelector("#gd2").textContent.toLowerCase();if(t.includes(e.replaceAll(/^(artist|group):|_/g," ").trim()))b.push(e);else{const n=document.getElementById(`ta_${e}`)?.textContent;n&&t.includes(n)&&b.push(e)}}b.length>0&&f(o.t("eh_tag_lint.correct_tag"),b),M("Doujinshi")&&c.isMissingNamespace(h,"parody")&&f(o.t("eh_tag_lint.miss_parody"),["parody:original"]),a&&c.isMissingTags(l,"female:females_only","female:futanari","female:shemale")&&c.isMissingNamespace(h,"male","mixed")&&f(o.t("eh_tag_lint.miss_female"),["female:females_only"]),i(n),g?.isConnected||(g=document.createElement("div"),g.id="comidread-tag-lint",o.querySelector("#taglist").append(g)),m?.(),m=e.render(()=>e.createComponent(t.Show,{get when(){return Object.keys(s()).length},get children(){return[e.template("<hr>")(),(n=e.template("<ul>")(),e.insert(n,e.createComponent(t.For,{get each(){return s().other},children:([n,o])=>{return a=e.template("<li>")(),e.insert(a,n,null),e.insert(a,e.createComponent(t.For,{each:o,children:t=>e.createComponent(d,{name:t,weak:!0})}),null),a;var a}}),null),e.insert(n,e.createComponent(p,{get warnList(){return s().prerequisite},get text(){return o.t("eh_tag_lint.prerequisite")},weak:!1}),null),e.insert(n,e.createComponent(p,{get warnList(){return s().conflict},get text(){return o.t("eh_tag_lint.conflict")}}),null),e.insert(n,e.createComponent(p,{get warnList(){return s().possibleConflict},get text(){return o.t("eh_tag_lint.possible_conflict")}}),null),e.insert(n,e.createComponent(p,{get warnList(){return s().combo},get text(){return o.t("eh_tag_lint.combo")},weak:!0}),null),n)];var n}}),g)});u(),o.hijackFn("tag_update_vote",u);const[h,_]=o.createEqualsSignal([]);o.useStyle(o.createRootMemo(()=>h().map(e=>`#td_${CSS.escape(e.replaceAll(" ","_"))} { box-shadow: 0px 0px 4px var(--tag); }`).join("\n")));const f=()=>_(n.value.split(",").map(e=>k(e.trim())).filter(Boolean));n.addEventListener("input",f),n.addEventListener("keydown",f),o.hijackFn("tag_update_vote",f)};e.delegateEvents(["click"]),(async()=>{const r=await y();if(!r)return;const{setState:s,options:i,setOptions:l,showComic:c}=r,d=()=>[e.createComponent(t.For,{each:["colorize_tag","float_tag_list","expand_tag_list","tag_lint","","quick_favorite","quick_rating","quick_tag_define","","cross_site_link","detect_ad","add_hotkeys_actions","auto_adjust_option"],children:a=>e.createComponent(t.Show,{when:a,get fallback(){return e.template("<hr>")()},get children(){return e.createComponent(n.SettingsItemSwitch,{get name(){return o.t(`site.add_feature.${a}`)},get value(){return i[a]},onChange:e=>l({[a]:e})})}})}),e.template("<hr>")(),e.createComponent(n.SettingBlockSubtitle,{get children(){return o.t("other.hotkeys")}}),e.createComponent(n.SettingHotkeys,{keys:["float_tag_list"]})];if(s(e=>{e.manga.editSettingList=e=>[...e,["E-Hentai",d]],e.fab.otherSpeedDial=["tag_lint","colorize_tag","cross_site_link","detect_ad"]}),"mpv"===r.type)return s("comicMap","",{getImgList({dynamicLazyLoad:e}){const t=unsafeWindow.imagelist;return e({loadImg:async e=>{const n=()=>t[e].i;for(;!n();)Reflect.has(t[e],"xhr")||(unsafeWindow.load_image(e+1),unsafeWindow.next_possible_request=0),await o.wait(n);return n()},length:t.length})}});if(n.listenHotkey({Escape:e=>{for(const t of v.values())if(!0!==t())return e.stopImmediatePropagation()}}),i.colorize_tag&&(b(r.type),Y(r)),-1!==unsafeWindow.apiuid&&i.quick_favorite&&o.requestIdleCallback(()=>W(r)),i.quick_rating&&o.requestIdleCallback(()=>H(r),1e3),i.expand_tag_list&&o.requestIdleCallback(()=>E(r),1e3),"gallery"!==r.type)return j(r);if(i.auto_adjust_option&&!M("Doujinshi","Manga","Non-H")){let e={pageNum:1,imgRecognition:{enabled:!1}};i.option&&(e=o.assign(i.option,e)),s("manga","option",e)}i.float_tag_list&&o.requestIdleCallback(()=>D(r)),i.quick_tag_define&&o.requestIdleCallback(()=>J(),1e3),i.tag_lint&&o.requestIdleCallback(()=>K(r),1e3);const p=document.getElementById("gd5");if(new ResizeObserver(()=>{Reflect.deleteProperty(p.dataset,"long");const e=o.querySelector("#gd5 p:last-of-type");e.offsetTop+e.offsetHeight>352&&(p.dataset.long="")}).observe(p),o.useStyle(`\n    #gd5[data-long] {\n      --scrollbar-slider: ${getComputedStyle(o.querySelector(".gm")).borderColor};\n      scrollbar-color: var(--scrollbar-slider) transparent;\n      scrollbar-width: thin;\n      overflow: auto;\n      max-height: 352px;\n      &::-webkit-scrollbar { width: 5px; height: 10px; }\n      &::-webkit-scrollbar-track { background: transparent; }\n      &::-webkit-scrollbar-thumb { background: var(--scrollbar-slider); }\n    }\n    /* 在显示 ehs 时隐藏 gd5 上的滚动条，避免同时显示两个滚动条 */\n    #gd5[data-long]:has(#ehs-introduce-box .ehs-content) { overflow: hidden; }\n    #gmid #ehs-introduce-box { width: 100%; }\n\n\n    /*\n      消除 ehs 针对按钮太多时的解决办法，用脚本的处理方式就好了，避免在浮动标签栏时导致滚动\n      https://github.com/EhTagTranslation/EhSyringe/commit/009054cc34ee818972d2a042990bf89bdff1895a\n     */\n    body #gmid #gd5 { --ehs-gap: 1; justify-content: unset; }\n  `),i.cross_site_link&&o.requestIdleCallback(()=>P(r),1e3),Number.isNaN(r.imgNum))return a.toast.error(o.t("site.changed_load_failed"));const g=await A(r),m=e=>e.includes("IP address has been temporarily banned")&&a.toast.error(o.t("site.ehentai.ip_banned"),{throw:!0,duration:Number.POSITIVE_INFINITY}),u=async e=>{try{return await z(r,e)}catch(e){o.log.warn("getImgUrlByApi failed",e)}const t=await a.request(r.pageList[e],{fetch:!0,errorText:o.t("site.ehentai.fetch_img_page_source_failed")},10);m(t.responseText);try{return/id="img" src="(.+?)"/.exec(t.responseText)[1]}catch{throw new Error(o.t("site.ehentai.fetch_img_url_failed"))}},[h,_]=t.createSignal(`1-${r.imgNum}`),f=o.createRootMemo(()=>[...o.extractRange(h(),r.imgList.length||r.imgNum)]),w=Number(o.querySelector(".ptt td:nth-last-child(2)").textContent);s("comicMap","",{getImgList:async({dynamicLazyLoad:e})=>{if(r.pageList.length!==w){const e=await o.plimit(o.range(w,e=>()=>(async(e=0)=>{const t=await a.request(`${location.pathname}${e?`?p=${e}`:""}`,{fetch:!0,errorText:o.t("site.ehentai.fetch_img_page_url_failed")});m(t.responseText);const n=[...t.responseText.matchAll(/<a href="(.{20,50})"><(img alt=.+?|div><div |div )title=".+?: (.+?)"/g)].map(([,e,,t])=>[e,t]);if(0===n.length)throw new Error(o.t("site.ehentai.fetch_img_page_url_failed"));return n})(e)));r.pageList.length=0,r.fileNameList.length=0;for(const t of e)for(const[e,n]of t)r.pageList.push(e),r.fileNameList.push(n);g?.checkFileName()}try{await B(r),await q(r,r.pageList[0])}catch(e){o.log.warn("checkKey failed",e)}return e({loadImg:async e=>{const t=f()[e];return r.imgList[t]||=await u(t),{src:r.imgList[t],name:r.fileNameList[t]}},length:()=>f().length,onEnd:g?.checkContent})}});const x=await o.useCache({pageRange:"id"});e.render(()=>{const t=p.children[6]?.classList.contains("gsp");return n=e.template('<p class="g2 gsp"style=padding-bottom:0><img src=https://ehgt.org/g/mr.gif>')(),e.setStyleProperty(n,"padding-top",t?0:void 0),n.addEventListener("click",async e=>{if(!e.shiftKey)return;e.stopPropagation();const t=await x.get("pageRange",unsafeWindow.gid),n=prompt(o.t("other.page_range"),t?.range);n&&(await x.set("pageRange",{id:unsafeWindow.gid??r.galleryId,range:n}),_(n??`1-${r.imgNum}`),s("comicMap","","imgList",void 0),c())},!0),e.insert(n,e.createComponent(r.LoadButton,{id:""}),null),n;var n},p),j(r);const $=o.singleThreaded(async(e,t)=>{const i=r.imgList.indexOf(t);if(-1!==i){if(r.imgList[i]=await u(i),!await o.testImgUrl(r.imgList[i])&&(await(async e=>{try{return await z(r,e,!0)}catch{}const t=await a.request(r.pageList[e],{errorText:o.t("site.ehentai.fetch_img_page_source_failed")});m(t.responseText);const n=/nl\('(.+?)'\)/.exec(t.responseText)?.[1];if(!n)throw new Error(o.t("site.ehentai.fetch_img_url_failed"));C(r,e,n)})(i),r.imgList[i]=await u(i),a.toast.warn(o.t("alert.retry_get_img_url",{i:i})),!await o.testImgUrl(r.imgList[i])))return await o.sleep(500),$(t);s("comicMap","","imgList",[...r.imgList]);for(const e of n.imgList())if("error"===e.loadType)return $(e.src)}});s(e=>{e.manga.title=r.japanTitle||r.galleryTitle,e.manga.onExit=e=>{e&&o.scrollIntoView("#cdiv"),s("manga","show",!1)},e.manga.onImgError=$,e.fab.initialShow=i.autoShow})})().catch(e=>o.log.error(e));break}case"nhentai.net":{const e=l("solid-js/web"),t=l("helper"),n=l("main"),o=l("userscript/detectAd");(async()=>{const{store:a,options:r,setState:s,showComic:i}=await n.useInit("nhentai",{auto_page_turn:!0,block_totally:!0,open_link_new_page:!0,detect_ad:!0});if(Reflect.has(unsafeWindow,"gallery")){s("manga",{onExit(e){e&&t.scrollIntoView("#comment-container"),s("manga","show",!1)}});const c=unsafeWindow._n_app.options.image_cdn_urls;s("comicMap","",{getImgList:()=>_gallery.images.pages.map(({t:e,w:n,h:o},a)=>({src:`https://${c[a%c.length]}/galleries/${_gallery.media_id}/${a+1}.${t.fileType[e]}`,width:n,height:o}))}),s("fab","initialShow",r.autoShow);const d=((l=e.template('<a href=javascript:; id=comicReadMode class="btn btn-secondary"><i class="fa fa-book"></i> Read')()).$$click=()=>i(),l);return document.getElementById("download").after(d),void(r.detect_ad&&t.querySelector("#tags .tag.tag-144644")&&(s("comicMap","","adList",new n.ReactiveSet),await o.getAdPageByContent(t.querySelectorAll(".thumb-container img").map(e=>e.dataset.src),a.comicMap[""].adList),t.createEffectOn(()=>a.comicMap[""].imgList,e=>e?.length&&o.getAdPageByContent(e.map(e=>"string"==typeof e?e:e.src),a.comicMap[""].adList)),t.useStyle(()=>a.comicMap[""]?.adList?.size?[...a.comicMap[""].adList].map(e=>`\n            .thumb-container:nth-of-type(${e+1}):not(:hover) {\n              filter: blur(8px);\n              clip-path: border-box;\n            }`).join("\n"):"")))}var l;if(document.getElementsByClassName("gallery").length>0){if(r.open_link_new_page)for(const e of t.querySelectorAll('a:not([href^="javascript:"])'))e.setAttribute("target","_blank");const e=(unsafeWindow?._n_app??unsafeWindow?.n)?.options?.blacklisted_tags;if(void 0===e&&n.toast.error(t.t("site.nhentai.tag_blacklist_fetch_failed")),r.block_totally&&e?.length&&t.useStyle(".blacklisted.gallery { display: none; }"),r.auto_page_turn){let o=t.querySelector("a.next")?.href;if(!o)return;t.useStyle("\n        hr { bottom: 1px; box-sizing: border-box; margin: -1em auto 2em; }\n        hr:last-child { position: relative; animation: load .8s linear alternate infinite; }\n        hr:not(:last-child) { display: none; }\n        @keyframes load { 0% { width: 100%; } 100% { width: 0; } }\n      ");const a=new Set(e),r=document.getElementById("content"),s=()=>r.querySelector(":is(.index-container, #favcontainer):last-of-type"),i=t.singleThreaded(async()=>{if(!o)return;const e=await n.request(o,{fetch:!0,errorText:t.t("site.nhentai.fetch_next_page_failed")}),i=t.domParse(e.responseText);history.replaceState(null,"",o);const c=i.querySelector(".index-container, #favcontainer");for(const e of c.querySelectorAll(".gallery")){for(const t of e.getElementsByTagName("img"))t.setAttribute("src",t.dataset.src);e.dataset.tags.split(" ").map(Number).some(e=>a.has(e))&&e.classList.add("blacklisted")}const d=i.querySelector(".pagination");o=d.querySelector("a.next")?.href,r.append(c,d);const p=document.createElement("hr");r.append(p),l.disconnect(),l.observe(s()),o||(p.style.animationPlayState="paused")},{abandon:!0});i();const l=new IntersectionObserver(e=>e[0].isIntersecting&&i());l.observe(s()),t.querySelector("section.pagination")&&r.append(document.createElement("hr"))}}})().catch(e=>t.log.error(e)),e.delegateEvents(["click"]);break}case"yuri.website":{const e=l("helper"),t=l("main");(async()=>{const{store:n,setState:o,showComic:a,init:r}=await t.useInit("yurifans",{"自动签到":!0});if(n.options.自动签到&&(async()=>{if(!globalThis.b2token)return;const e=(new Date).toLocaleDateString("zh-CN");if(e!==localStorage.getItem("signDate"))try{const n=await t.request("/wp-json/b2/v1/userMission",{method:"POST",noTip:!0,headers:{Authorization:`Bearer ${b2token}`}}),o=JSON.parse(n.responseText);if(!o?.mission?.date&&Number.isNaN(Number(o)))throw new Error("签到失败");t.toast("自动签到成功"),localStorage.setItem("signDate",e)}catch{t.toast.error("自动签到失败")}})(),await e.waitDom('a.post-list-cat-item[title="在线区-漫画"]')){if(e.querySelector(".content-hidden")){const t=e.querySelector(".content-hidden").getElementsByTagName("img");return void(await e.wait(()=>t.length,1e3)&&o("comicMap","",{getImgList:()=>[...t].map(e=>e.src)}))}if(e.querySelector(".xControl")){o("flag","needAutoShow",!1);const t=e=>{a(e),o("manga",{onPrev:Reflect.has(n.comicMap,e-1)?()=>t(e-1):void 0,onNext:Reflect.has(n.comicMap,e+1)?()=>t(e+1):void 0})};for(const[n,a]of e.querySelectorAll(".xControl > a").entries()){const e=a.parentElement.nextElementSibling;o("comicMap",n,{getImgList:()=>[...e.querySelectorAll("img")].map(e=>e.dataset.src??e.src)}),a.addEventListener("click",()=>e.style.display&&t(n))}return void r()}await e.wait(()=>e.querySelectorAll(".entry-content img").length),o("comicMap","",{getImgList:()=>e.querySelectorAll(".entry-content img").map(e=>e.dataset.src||e.src)})}})();break}case"2025copy.com":case"www.2025copy.com":case"copy20.com":case"www.copy20.com":case"mangacopy.com":case"www.mangacopy.com":{const e=l("solid-js/web"),t=l("solid-js"),n=l("helper"),o=l("main"),a=l("userscript/copyApi"),r=new class{headers={webp:"1",region:"1","User-Agent":"COPY/3.0.0",version:"2025.08.15",source:"copyApp",referer:"com.copymanga.app-3.0.0"};get=(e,t,...n)=>o.request(e,{responseType:"json",headers:this.headers,...t},...n)},s=new class{headers={"User-Agent":navigator.userAgent,referer:location.href};get=(e,t,...n)=>o.request(`https://mapi.copy20.com${e}`,{responseType:"json",headers:this.headers,fetch:!1,...t},...n)},i=e=>{let t;const o=new CSSStyleSheet;document.adoptedStyleSheets.push(o);const a=async()=>{t||(async()=>{t=document.createElement("a");const e=await n.wait(()=>n.querySelector(".table-default-right"));t.target="_blank",e.firstElementChild?.before(t);const o=document.createElement("span");o.textContent="最後閱讀：",e.firstElementChild?.before(o)})(),t.textContent="獲取中",t.removeAttribute("href");const a=await s.get(`/api/v3/comic2/${e}/query?platform=3`),r=a.response?.results?.browse;if(!r)return void(t.textContent=null===r?"無":"未返回數據");const i=r.chapter_id;i?(await o.replace(`ul a[href*="${i}"] {\n        color: #fff !important;\n        background: #1790E6;\n      }`),t.href=`${location.pathname}/chapter/${i}`,t.textContent=r.chapter_name):t.textContent="接口異常"};setTimeout(a),document.addEventListener("visibilitychange",a)},c=async(o,s)=>{const{response:{results:i}}=await r.get(`/comicdetail/${o}/chapters`,{errorText:"加載漫畫目錄失敗"}),l=await a.decryptData(i);n.log(l);const{build:{type:c},groups:d}=l,p=a=>{const r=Object.fromEntries(c.map(({id:e})=>[e,[]]));for(const e of a.chapters)r[e.type].push(e);switch(s){case"mobile":for(const e of n.querySelectorAll(".van-divider"))e.remove();return h=e.template('<div class="detailsTextContentTabs van-tabs van-tabs--line">')(),e.insert(h,e.createComponent(t.For,{each:c,children:({id:n,name:s})=>e.createComponent(t.Show,{get when(){return r[n].length},get children(){return[(c=e.template('<div class=van-tabs__wrap><div role=tablist class="van-tabs__nav van-tabs__nav--line"><div role=tab class="van-tab van-tab--active"><span class="van-tab__text van-tab__text--ellipsis"><span></span></span></div><div class=van-tabs__line style=transition-duration:0.3s>')(),d=c.firstChild,p=d.firstChild,g=p.firstChild.firstChild,m=p.nextSibling,e.setStyleProperty(d,"background","transparent"),e.insert(g,s),e.setStyleProperty(m,"width","0.24rem"),e.setStyleProperty(m,"transform","translateX(187.5px) translateX(-50%)"),c),(i=e.template('<div class=van-tab__pane><div class="chapterList van-grid"style=padding-left:0.24rem>')(),l=i.firstChild,e.insert(l,e.createComponent(t.For,{get each(){return r[n]},children:t=>{return n=e.template('<div class="chapterItem oneLines van-grid-item"style=flex-basis:25%;padding-right:0.24rem;margin-top:0.24rem><a class="van-grid-item__content van-grid-item__content--center"><span class=van-grid-item__text>')(),s=(r=n.firstChild).firstChild,e.insert(s,()=>t.name),e.effect(s=>{var i=!(a.last_chapter.uuid!==t.id),l=`/comic/${o}/chapter/${t.id}`;return i!==s.e&&n.classList.toggle("red",s.e=i),l!==s.t&&e.setAttribute(r,"href",s.t=l),s},{e:void 0,t:void 0}),n;var n,r,s}})),i)];var i,l,c,d,p,g,m}})})),h;case"web":return[(u=e.template("<span>")(),e.insert(u,()=>a.name),u),(i=e.template('<div class=table-default><div class=table-default-title><ul class="nav nav-tabs"role=tablist></ul><div class=table-default-right><span>更新內容：</span><a target=_blank></a><span>更新時間：</span><span></span></div></div><div class=table-default-box><div class=tab-content>')(),l=i.firstChild,d=l.firstChild,p=d.nextSibling.firstChild.nextSibling,g=p.nextSibling.nextSibling,m=l.nextSibling.firstChild,e.insert(d,e.createComponent(t.For,{each:c,children:({id:t,name:n})=>{return o=e.template("<li class=nav-item><a class=nav-link data-toggle=tab role=tab aria-selected=false>")(),s=o.firstChild,e.insert(s,n),e.effect(o=>{var i=!(0!==r[t].length),l=`#${a.path_word}${n}`;return i!==o.e&&s.classList.toggle("disabled",o.e=i),l!==o.t&&e.setAttribute(s,"href",o.t=l),o},{e:void 0,t:void 0}),o;var o,s}})),e.insert(p,()=>a.last_chapter.name),e.insert(g,()=>a.last_chapter.datetime_created),e.insert(m,e.createComponent(t.For,{each:c,children:({id:n,name:s})=>{return l=(i=e.template('<div role=tabpanel class="tab-pane fade"><ul>')()).firstChild,e.insert(l,e.createComponent(t.For,{get each(){return r[n]},children:t=>{return a=(n=e.template("<a target=_blank><li>")()).firstChild,e.setStyleProperty(n,"display","block"),e.insert(a,()=>t.name),e.effect(a=>{var r=`/comic/${o}/chapter/${t.id}`,s=t.name;return r!==a.e&&e.setAttribute(n,"href",a.e=r),s!==a.t&&e.setAttribute(n,"title",a.t=s),a},{e:void 0,t:void 0}),n;var n,a}})),e.effect(()=>e.setAttribute(i,"id",`${a.path_word}${s}`)),i;var i,l}})),e.effect(()=>e.setAttribute(p,"href",`/comic/${o}/chapter/${a.last_chapter.comic_id}`)),i)];default:return e.createComponent(t.For,{each:c,children:({id:n,name:s})=>e.createComponent(t.Show,{get when(){return r[n].length},get children(){var i=e.template("<div class=card style=max-width:100em><div class=card-body><h2 class=card-title></h2><ul>")(),l=i.firstChild.firstChild,c=l.nextSibling;return e.setStyleProperty(i,"margin","1em auto"),e.insert(l,s),e.insert(c,e.createComponent(t.For,{get each(){return r[n]},children:t=>{return n=e.template('<a class="btn btn-outline-primary">')(),e.insert(n,()=>t.name),e.effect(r=>{var s=!(a.last_chapter.uuid!==t.id),i=`/comic/${o}/chapter/${t.id}`;return s!==r.e&&n.classList.toggle("active",r.e=s),i!==r.t&&e.setAttribute(n,"href",r.t=i),r},{e:void 0,t:void 0}),n;var n}})),i}})})}var i,l,d,p,g,m,u,h};let g;switch(s){case"mobile":g=n.querySelector(".detailsTextContent");for(const e of n.querySelectorAll("button.van-dialog__confirm"))e.click();break;case"web":g=n.querySelector(".upLoop");break;default:g=n.querySelector("main"),g.textContent="",n.useStyle("ul .btn { height: fit-content; width: fit-content; margin: 1em; }")}e.render(()=>e.createComponent(t.For,{get each(){return Object.values(d)},children:p}),g);for(const e of n.querySelectorAll(".upLoop .table-default-title"))e.querySelector(".nav-link:not(.disabled)")?.click()};(async()=>{const e=document.cookie.split("; ").find(e=>e.startsWith("token="))?.replace("token=","");e&&(Reflect.set(r.headers,"Authorization",`Token ${e}`),Reflect.set(s.headers,"Authorization",`Token ${e}`));let t="",l="";if(location.href.includes("/chapter/")?[,,t,,l]=location.pathname.split("/"):location.href.includes("/comicContent/")&&([,,,t,l]=location.pathname.split("/")),t&&l){const{setState:e}=await o.useInit("copymanga"),r=n.querySelector("main .img+.title");r&&(r.textContent="ComicRead 提示您：你訪問的內容暫不存在，請點選右下角按鈕嘗試加載漫畫");const i=async()=>{const o=await s.get(`/api/v3/comic/${t}/chapter2/${l}?platform=3`,{noCheckCode:!0});if(200!==o.status){const e=`漫畫加載失敗：${o.response.message||o.status}`;throw r&&(r.textContent=e),new Error(e)}if(r){r.textContent="漫畫加載成功🥳";const{chapter:{name:e},comic:{name:t}}=o.response.results;document.title=`${t} - ${e} - 拷貝漫畫 拷贝漫画`}if(r??!n.querySelector(".comicContent-next")){const{chapter:{next:n,prev:a}}=o.response.results;e("manga",{onNext:n?()=>location.assign(`/comic/${t}/chapter/${n}`):void 0,onPrev:a?()=>location.assign(`/comic/${t}/chapter/${a}`):void 0})}const a=[],{words:i,contents:c}=o.response.results.chapter;for(let e=0;e<c.length;e++)a[i[e]]=c[e].url.replace(/(?<=(\/|\.))c800x/,"c1500x");return a};e("comicMap","",{async getImgList(){if(n.querySelector(".comicContent-next")&&e("manga",{onNext:n.querySelectorClick(".comicContent-next a:not(.prev-null)"),onPrev:n.querySelectorClick(".comicContent-prev:not(.index,.list) a:not(.prev-null)")}),r)return i();try{const e=await a.getImglistByHtml(`${location.origin}/comic/${t}/chapter/${l}`);if(0===e.length)throw new Error("解析网页变量失败");return e}catch(e){return n.log.error(e),i()}}});const c=async(e=[])=>{const t=location.pathname.split("/").at(-1),n=await s.get(`/api/v3/roasts?chapter_id=${t}&limit=100&offset=${e.length}&_update=true`,{errorText:"获取漫画评论失败",responseType:"blob"}),{list:o,total:a}=JSON.parse(await n.response.text()).results;for(const{comment:t}of o)e.push(t);return e.length<a?c(e):e};return void e("manga","commentList",await c())}if(!l&&location.href.includes("/comic/")){if([,t]=location.href.split("/comic/"),!t)return;let a;const r=location.href.includes("/h5/");if("404 - 拷貝漫畫"===document.title?a=r?"mobile":"404":r?(await n.wait(()=>"none"===n.querySelector(".van-toast__text")?.parentElement?.style.display),a=await n.wait(()=>{if(n.querySelector(".isBan")?.textContent?.includes("不提供閱覽"))return"mobile";const e=n.querySelector(".van-dialog__message");if(e?.textContent?.includes("漫畫未找到")){e.textContent="漫畫未找到!\n請坐和放寬，等待目錄生成";for(const e of n.querySelectorAll(".detailsTextContentTabs"))e.remove();return"mobile"}},1e3)):!Boolean(n.querySelector(".wargin")?.textContent?.includes("不提供閱覽"))&&await n.wait(()=>n.querySelector(".upLoop .table-default-title"),1e3)||(a=n.querySelector(".comicParticulars-title")?"web":"404"),a){const e=n.querySelector(".isBan, .wargin");e&&(e.style.textDecoration="line-through");const r=n.querySelector("main .img+.title");r&&(r.textContent="ComicRead 提示您：你訪問的內容暫不存在，請坐和放寬，等待目錄生成");try{await c(t,a)}catch(e){n.log.error(e),r&&(r.textContent="ComicRead 提示您：目錄生成失敗😢"),o.toast.error("目錄生成失敗😢",{duration:Number.POSITIVE_INFINITY})}}!r&&e&&i(t)}})();break}case"www.pixiv.net":{let e=[];h={name:"pixiv",getImgList:()=>e,SPA:{async isMangaPage(){const t=Number(location.pathname.split("/")[2]);if(!t||!location.pathname.startsWith("/artworks/"))return e.length=0,!1;const n=await g.request(`/ajax/illust/${t}/pages`,{responseType:"json"});return e=n.response.body.map(e=>e.urls.original),e.length>1}},initOptions:{autoShow:!1,defaultOption:{pageNum:1}}};break}case"www.zaimanhua.com":case"manhua.zaimanhua.com":{const e=()=>unsafeWindow.__NUXT__.data.getChapters?.data?.chapterInfo?.page_url;h={name:"zaiManHua",wait:()=>Boolean(d.querySelector(".scrollbar-demo-item")),getImgList:e,SPA:{isMangaPage:()=>location.pathname.startsWith("/view/"),getOnNext:()=>d.querySelectorClick("#next_chapter"),getOnPrev:()=>d.querySelectorClick("#prev_chapter")}};break}case"m.zaimanhua.com":{const e=async(e,t)=>{const n=await g.request(`https://v4api.zaimanhua.com/app/v1/comic/chapter/${e}/${t}?_v=15`,{responseType:"json"});return n.response.errno&&g.toast.error(`${d.t("alert.comic_load_error")}: ${n.response.errmsg}`,{throw:!0}),n.response.data.data},t=async e=>{const t=await g.request(`https://v4api.zaimanhua.com/app/v1/comic/detail/${e}?_v=15`,{responseType:"json"});return t.response.errno&&g.toast.error(`${d.t("alert.comic_load_error")}: ${t.response.errmsg}`,{throw:!0}),t.response.data.data};h={name:"zaiManHua",async getImgList({setState:n}){const o=new URLSearchParams(location.search),a=Number(o.get("comic_id")),r=Number(o.get("chapter_id"));if(!a||!r)throw new Error(d.t("site.changed_load_failed"));const s=await t(a),i=(1===s.chapters.length?s.chapters[0]:s.chapters.find(e=>e.data.find(e=>e.chapter_id===r))).data;i.sort((e,t)=>e.chapter_order-t.chapter_order);const l=i.findIndex(e=>e.chapter_id===r);return n("manga",{onPrev:l>0?()=>location.assign(`/pages/comic/page?comic_id=${a}&chapter_id=${i[l-1].chapter_id}`):void 0,onNext:l+1<i.length?()=>location.assign(`/pages/comic/page?comic_id=${a}&chapter_id=${i[l+1].chapter_id}`):void 0}),(await e(a,r)).page_url_hd},SPA:{isMangaPage:()=>"/pages/comic/page"===location.pathname}};break}case"terra-historicus.hypergryph.com":{const e=()=>`https://terra-historicus.hypergryph.com/api${location.pathname}`,t=t=>async()=>{const n=await g.request(`${e()}/page?pageNum=${t+1}`);return JSON.parse(n.responseText).data.url};h={name:"terraHistoricus",wait:()=>Boolean(d.querySelector(".HG_COMIC_READER_main")),async getImgList(){const n=(await g.request(e(),{responseType:"json"})).response.data.pageInfos;if(0===n.length&&location.pathname.includes("episode"))throw new Error("获取图片列表时出错");return d.plimit(d.range(n.length,t))},SPA:{isMangaPage:()=>location.href.includes("episode"),getOnPrev:()=>d.querySelectorClick("footer .HG_COMIC_READER_prev a"),getOnNext:()=>d.querySelectorClick("footer .HG_COMIC_READER_prev+.HG_COMIC_READER_buttonEp a")}};break}case"18comic.ink":case"jmcomic-zzz.one":case"jmcomic-zzz.org":case"18comic.org":case"18comic.vip":{const e=l("helper"),t=l("main");(async()=>{if(!location.pathname.includes("/photo/"))return;const{setState:n}=await t.useInit("jm");for(;!unsafeWindow?.onImageLoaded;){if("complete"===document.readyState)return void t.toast.error("无法获取图片",{duration:Number.POSITIVE_INFINITY});await e.sleep(100)}n("manga",{onPrev:e.querySelectorClick(()=>e.querySelector(".menu-bolock-ul .fa-angle-double-left")?.parentElement),onNext:e.querySelectorClick(()=>e.querySelector(".menu-bolock-ul .fa-angle-double-right")?.parentElement)});const o=e.querySelectorAll(".scramble-page:not(.thewayhome) > img");if(unsafeWindow.aid<unsafeWindow.scramble_id||"1"===unsafeWindow.speed)return n("comicMap","",{getImgList:()=>o.map(e=>e.dataset.original??"")});const a=async n=>{const a=o[n],r=a.dataset.original,s=e.getFileName(r);if(a.dataset.imgUrl)return{name:s,src:a.dataset.imgUrl};const i=await(async e=>{try{return await t.request(e,{responseType:"blob",fetch:!0,noTip:!0},3)}catch{return await t.request(e,{responseType:"blob",revalidate:!0,fetch:!1},3)}})(a.dataset.original);if(0===i.response.size)return t.toast.warn(`下载原图时出错: ${a.dataset.page}`),"";a.src=`${URL.createObjectURL(i.response)}#${a.src}`;try{await e.waitImgLoad(a,1e4)}catch{return URL.revokeObjectURL(a.src),a.src=r,t.toast.warn(`加载原图时出错: ${a.dataset.page}`),""}try{"CANVAS"===a.nextElementSibling?.tagName&&a.nextElementSibling.remove(),unsafeWindow.onImageLoaded(a);const t=await e.canvasToBlob(a.nextElementSibling,"image/webp",1);if(URL.revokeObjectURL(a.src),!t)throw new Error("转换图片时出错");const n=URL.createObjectURL(t);return a.dataset.imgUrl=n,{name:s,src:n}}catch(e){return a.src=r,t.toast.warn(`转换图片时出错: ${a.dataset.page}, ${e.message}`),""}};await e.wait(()=>{const t=e.querySelectorAll(".lazy-loaded").length;return t>0&&e.querySelectorAll("canvas").length-t<=1}),n("comicMap","",{getImgList:({dynamicLazyLoad:e})=>e({loadImg:a,length:o.length})})})().catch(t=>e.log.error(t));break}case"tw.manhuagui.com":case"m.manhuagui.com":case"www.mhgui.com":case"www.manhuagui.com":{if(!/\/comic\/\d+\/\d+\.html/.test(location.pathname))break;let e;try{const t=d.querySelectorAll("body > script:not([src])").find(e=>e.innerHTML.startsWith("window["));if(!t)throw new Error(d.t("site.changed_load_failed"));e=JSON.parse(eval(t.innerHTML.slice(26)).match(/(?<=\()\{.+\}/)[0])}catch{g.toast.error(d.t("site.changed_load_failed"));break}d.useStyle("#smh-msg-box { z-index: 2147483647 !important }");const t=e=>{if(0===e)return;const t=location.pathname.replace(/(?<=\/)\d+(?=\.html)/,`${e}`);return()=>location.assign(t)};h={name:"manhuagui",getImgList(){const t=Object.entries(e.sl).map(e=>`${e[0]}=${e[1]}`).join("&");if(e.files)return e.files.map(e=>`${unsafeWindow.pVars.manga.filePath}${e}?${t}`);if(e.images){const{origin:n}=new URL(d.querySelector("#manga img").src);return e.images.map(e=>`${n}${e}?${t}`)}return g.toast.error(d.t("site.changed_load_failed"),{throw:!0}),[]},onNext:t(e.nextId),onPrev:t(e.prevId)};break}case"www.manhuaren.com":case"m.1kkk.com":case"www.1kkk.com":case"tel.dm5.com":case"en.dm5.com":case"cnc.dm5.com":case"www.dm5.cn":case"www.dm5.com":{if(!Reflect.has(unsafeWindow,"DM5_CID"))break;const e=unsafeWindow.DM5_IMAGE_COUNT??unsafeWindow.imgsLen;if(!(Number.isSafeInteger(e)&&e>0)){g.toast.error(d.t("site.changed_load_failed"));break}const t=async e=>{const t=await unsafeWindow.$.ajax({type:"GET",url:"chapterfun.ashx",data:{cid:unsafeWindow.DM5_CID,page:e,key:unsafeWindow.$("#dm5_key").length>0?unsafeWindow.$("#dm5_key").val():"",language:1,gtk:6,_cid:unsafeWindow.DM5_CID,_mid:unsafeWindow.DM5_MID,_dt:unsafeWindow.DM5_VIEWSIGN_DT,_sign:unsafeWindow.DM5_VIEWSIGN}});return eval(t)},n=(e,t)=>d.querySelectorClick(()=>d.querySelector(e)??d.querySelectorAll(".view-bottom-bar a").find(e=>e.textContent?.includes(t)));h={name:"dm5",getImgList:({dynamicLoad:n})=>Array.isArray(unsafeWindow.newImgs)&&unsafeWindow.newImgs.every(d.isUrl)?unsafeWindow.newImgs:n(async n=>{const o=new Set;for(;o.size<e;)for(const e of await t(o.size+1))o.has(e)||(o.add(e),n(o.size-1,e))},e),onPrev:n(".logo_1","上一章"),onNext:n(".logo_2","下一章"),onExit:e=>e&&d.scrollIntoView(".postlist")};break}case"www.wn04.ru":case"www.wnacg05.cc":case"www.wnacg03.cc":case"www.wnacg.com":case"wnacg.com":{const e=d.querySelector("#bodywrap a.btn");if(e&&(e.style.setProperty("background-color","#607d8b"),e.style.setProperty("background-image","none")),!Reflect.has(unsafeWindow,"imglist"))break;h={name:"wnacg",getImgList:()=>unsafeWindow.imglist.filter(({caption:e})=>"喜歡紳士漫畫的同學請加入收藏哦！"!==e).map(({url:e})=>new URL(e,location.origin).href)};break}case"www.mangabz.com":case"mangabz.com":{if(!Reflect.has(unsafeWindow,"MANGABZ_CID"))break;const e=unsafeWindow.MANGABZ_IMAGE_COUNT??unsafeWindow.imgsLen;if(!(Number.isSafeInteger(e)&&e>0)){g.toast.error(d.t("site.changed_load_failed"));break}const t=async e=>{const t=await unsafeWindow.$.ajax({type:"GET",url:"chapterimage.ashx",data:{cid:unsafeWindow.MANGABZ_CID,page:e,key:"",_cid:unsafeWindow.MANGABZ_CID,_mid:unsafeWindow.MANGABZ_MID,_dt:unsafeWindow.MANGABZ_VIEWSIGN_DT,_sign:unsafeWindow.MANGABZ_VIEWSIGN}});return eval(t)},n=(e,t)=>d.querySelectorClick(()=>d.querySelector(e)??d.querySelectorAll(".bottom-bar-tool a").find(e=>e.textContent?.includes(t)));h={name:"mangabz",getImgList:({dynamicLoad:n})=>n(async n=>{const o=new Set;for(;o.size<e;)for(const e of await t(o.size+1))o.has(e)||(o.add(e),n(o.size-1,e))},e),onNext:n('body > .container a[href^="/"]:last-child',"下一"),onPrev:n('body > .container a[href^="/"]:first-child',"上一")};break}case"komiic.com":{const e="\n        query imagesByChapterId($chapterId: ID!) {\n          imagesByChapterId(chapterId: $chapterId) {\n            id\n            kid\n            height\n            width\n            __typename\n          }\n        }",t=async()=>{const t=/chapter\/(\d+)/.exec(location.pathname)?.[1];if(!t)throw new Error(d.t("site.changed_load_failed"));return(await g.request("/api/query",{method:"POST",responseType:"json",headers:{"content-type":"application/json"},data:JSON.stringify({operationName:"imagesByChapterId",variables:{chapterId:`${t}`},query:e})})).response.data.imagesByChapterId.map(({kid:e})=>`https://komiic.com/api/image/${e}`)},n=e=>async()=>(await d.waitDom(".v-bottom-navigation__content"),d.querySelectorClick(".v-bottom-navigation__content button:not([disabled])",e));h={name:"komiic",getImgList:t,SPA:{isMangaPage:()=>/comic\/\d+\/chapter\/\d+\/images\//.test(location.href),getOnPrev:n("上一"),getOnNext:n("下一"),handleUrl:e=>e.pathname}};break}case"mangadex.org":h={name:"mangadex",async getImgList(){const e=location.pathname.split("/").at(2),{response:{baseUrl:t,chapter:{data:n,hash:o}}}=await g.request(`https://api.mangadex.org/at-home/server/${e}?forcePort443=false`,{responseType:"json"});return n.map(e=>`${t}/data/${o}/${e}`)},SPA:{isMangaPage:()=>/^\/chapter\/.+/.test(location.pathname),getOnPrev:()=>d.querySelectorClick('#chapter-selector > a[href^="/chapter/"]:nth-of-type(1)'),getOnNext:()=>d.querySelectorClick('#chapter-selector > a[href^="/chapter/"]:nth-of-type(2)'),handleUrl:e=>e.href.replace(/(?<=\/chapter\/.+?)\/.*/,"")}};break;case"noy1.top":h={name:"NoyAcg",async getImgList(){const[,,e]=location.hash.split("/"),t=await d.wait(()=>d.querySelector(".lazy-load-image-background img")),[n]=t.src.split(e),o=await d.wait(()=>d.querySelectorAll(".lazy-load-image-background").length);return d.range(o,t=>`${n}${e}/${t+1}.webp`)},SPA:{isMangaPage:()=>location.hash.startsWith("#/read/")}};break;case"8.twobili.com":case"a.twobili.com":case"articles.onemoreplace.tw":case"www.8comic.com":{if(!/^\/(?:online|ReadComic|comic)\//.test(location.pathname))break;c.downloadImgHeaders.Referer="https://www.8comic.com/";const e=()=>[...unsafeWindow.xx.matchAll(/(?<= s=").+?(?=")/g)].map(([e])=>decodeURIComponent(e));h={name:"8comic",getImgList:e,onNext:d.querySelectorClick("#nextvol"),onPrev:d.querySelectorClick("#prevvol")};break}case"www.relamanhua.org":case"www.manga2024.com":case"www.2024manga.com":if(!location.pathname.includes("/chapter/"))break;if(!document.querySelector(".disData[contentkey]")){g.toast.error(d.t("site.changed_load_failed"));break}h={name:"relamanhua",getImgList:()=>m.getImglistByHtml(),onNext:d.querySelectorClick(".comicContent-next a:not(.prev-null)"),onPrev:d.querySelectorClick(".comicContent-prev:not(.index,.list) a:not(.prev-null)")};break;case"hitomi.la":h={name:"hitomi",wait:()=>unsafeWindow.galleryinfo&&Reflect.has(unsafeWindow.galleryinfo,"files")&&"anime"!==unsafeWindow.galleryinfo.type,getImgList:()=>unsafeWindow.galleryinfo.files.map(e=>unsafeWindow.url_from_url_from_hash(unsafeWindow.galleryinfo.id,e,"webp"))};break;case"shupogaki.moe":case"hoshino.one":case"niyaniya.moe":{const e=e=>new Promise(t=>{const n=new XMLHttpRequest;n.responseType="blob",n.open("GET",e),n.onload=()=>{t(URL.createObjectURL(n.response))},n.send()}),t=()=>location.href.includes("/g/"),n=localStorage.getItem("clearance");h={name:"schale",async getImgList({dynamicLazyLoad:t}){const[,,o,a]=location.pathname.split("/"),r=await g.request(`https://api.schale.network/books/detail/${o}/${a}?crt=${n}`,{fetch:!0,responseType:"json",method:"POST"}),[[s,{id:i,key:l}]]=Object.entries(r.response.data).filter(([,e])=>e.id&&e.key).toSorted(([,e],[,t])=>t.size-e.size),c=await g.request(`https://api.schale.network/books/data/${o}/${a}/${i}/${l}/${s}?crt=${n}`,{fetch:!0,responseType:"json"}),{base:p,entries:m}=c.response,{length:u}=m;return t({loadImg:async t=>{const{path:n,dimensions:o}=m[t],a=performance.now(),r=await e(`${p}${n}?w=${o[0]}`);return await d.sleep(500-(performance.now()-a)),r},length:u,concurrency:1})},SPA:{isMangaPage:t}};break}case"nude-moon.org":{const e=l("components/Manga"),t=l("helper"),n=l("main");(async()=>{const o=async()=>{const e=new URL(location.href),n=e.pathname.split("-");n.splice(1,0,"online"),e.pathname=n.join("-");const o=await fetch(e).then(e=>e.text()),a=[...t.domParse(o).querySelectorAll("script")].find(e=>e.textContent.includes("/manga/"));return a?Array.from(a.textContent.matchAll(/\/manga\/[^']+/g),e=>`https://nude-moon.org${e[0]}`):[]},{setState:a}=await n.useInit("nude-moon",{autoShow:!1,defaultOption:{pageNum:1}});a(e=>{null!==location.pathname.match(/^\/\d+-/)&&(e.comicMap[""].getImgList=o)}),e.listenHotkey({scroll_right:()=>unsafeWindow.nextImg(),scroll_left:()=>unsafeWindow.backImg()})})();break}case"kemono.cr":case"kemono.su":case"kemono.party":{const e=l("helper"),t=l("main");(async()=>{const n=()=>location.pathname.includes("/post/");await e.waitUrlChange(n);const{store:o,setState:a,showComic:r,init:s}=await t.useInit("kemono",{autoShow:!1,defaultOption:{pageNum:1},load_original_image:!0});e.createEffectOn(()=>o.options.load_original_image,(e,t)=>{a("nowComic",e?"original":"thumbnail"),t&&r()}),await e.waitDom(".post__thumbnail");const i=()=>e.querySelectorAll(".post__thumbnail a").map(e=>e.href),l=()=>e.querySelectorAll(".post__thumbnail img").map(e=>e.src);a(t=>{t.comicMap.original={getImgList:i,imgList:i()},t.comicMap.thumbnail={getImgList:l,imgList:l()},t.manga.onNext=e.querySelectorClick(".post__nav-link.next"),t.manga.onPrev=e.querySelectorClick(".post__nav-link.prev")}),s();const c=new Set(["zip","rar","7z","cbz","cbr","cb7"]);for(const t of e.querySelectorAll(".post__attachment a")){if(!c.has(t.href.split(".").pop()))continue;const e=document.createElement("a");e.href=`https://comic-read.pages.dev/?url=${encodeURIComponent(t.href)}`,e.textContent=t.textContent.replace("Download ","ComicReadPWA - "),e.className=t.className,e.style.opacity=".6",t.parentNode.insertBefore(e,t.nextElementSibling)}e.onUrlChange(async t=>{if(t){if(!n())return a(e=>{e.fab.show=!1,e.manga.show=!1});a(e=>{e.fab.show=void 0,e.manga.show=!1}),await e.wait(()=>l()[0]!==o.comicMap.thumbnail.imgList?.[0]),a(e=>{e.comicMap.original.imgList=i(),e.comicMap.thumbnail.imgList=l()}),o.options.autoShow&&await r()}})})();break}case"nekohouse.su":if(!location.pathname.includes("/post/"))break;h={name:"nekohouse",getImgList:()=>d.querySelectorAll(".fileThumb").map(e=>e.getAttribute("href")),initOptions:{autoShow:!1,defaultOption:{pageNum:1}}};break;case"nicomanga.com":case"weloma.art":case"welovemanga.one":{if(!d.querySelector("#listImgs, .chapter-content"))break;const e=async()=>{const t=d.querySelectorAll("img.chapter-img:not(.ls-is-cached)").map(e=>(e.dataset.src||e.dataset.srcset||e.dataset.original||e.src).trim()).filter(Boolean);return t.length>0&&t.every(e=>!/loading.*\.gif/.test(e))?t:(await d.sleep(500),e())};h={name:"welovemanga",getImgList:e,onNext:d.querySelectorClick(".rd_top-right.next:not(.disabled)"),onPrev:d.querySelectorClick(".rd_top-left.prev:not(.disabled)")};break}case"hentaizap.com":if(!location.pathname.startsWith("/g/"))break;h={name:"hentaizap",getImgList(){const e=Number(d.querySelector("#pages").value),t=d.querySelector("#fimg"),n=(t.dataset.src||t.src).split("/").slice(0,-1).join("/");return d.range(e,e=>`${n}/${e+1}.${d.fileType[unsafeWindow.g_th[e+1].slice(0,1)]}`)}};break;case"imhentai.xxx":if(!location.pathname.startsWith("/gallery/"))break;h={name:"IMHentai",getImgList(){const[e]=d.querySelector("#append_thumbs a img").dataset.src.match(/.+\//),t=[];for(const[n,o]of Object.entries(unsafeWindow.g_th)){const[a,r,s]=o.split(",");t[Number(n)-1]={src:`${e}${n}.${d.fileType[a]}`,width:Number(r),height:Number(s)}}return t}};break;case"sai-zen-sen.jp":switch(h={name:"sai-zen-sen",getImgList:()=>[]},location.pathname.match(/\/[^/]+\/[^/]+\//)?.[0]){case"/special/4pages-comics/":case"/works/comics/":h.getImgList=()=>Object.values(unsafeWindow.B.Package.Manifest.items).map(({href:e})=>e).filter(Boolean).map(e=>`${unsafeWindow.B.Path}/${e}`),h.onPrev=d.querySelectorClick("ul.volumes > li:nth-child(2) > a[href]"),h.onNext=d.querySelectorClick("ul.volumes > li:nth-child(3) > a[href]");break;case"/comics/twi4/":h.getImgList=()=>unsafeWindow.t4.Meta.Items.map(({ImageFileName:e})=>`${unsafeWindow.t4.GA.Gate.x_directory}works/${e}`);break;default:h=void 0}break;case"comic-read.pages.dev":unsafeWindow.GM_xmlhttpRequest=GM_xmlhttpRequest,unsafeWindow.toast=g.toast;break;default:{const e=l("components/Manga"),t=l("helper"),n=l("request");if(document.querySelector('head > meta[content="A manga reader that runs tachiyomi\'s extensions"]')){const e=(e,t)=>{location.pathname=`/manga/${e}/chapter/${t}`},o=async(e,a)=>{const r=await n.request("/api/graphql",{method:"POST",data:JSON.stringify({operationName:"GET_CHAPTERS",query:"query GET_CHAPTERS($mangaId: Int!, $chapterId: Int!) {\n                chapters(condition: {\n                  mangaId: $mangaId, sourceOrder: $chapterId}\n                ) { nodes { pageCount } }\n                manga(id: $mangaId) { chapters { totalCount } }\n              }",variables:{mangaId:e,chapterId:a}}),responseType:"json"});return r.response.data.chapters.nodes[0].pageCount<=0?(await t.sleep(200),o(e,a)):r.response.data};h={name:"Tachidesk",SPA:{isMangaPage:()=>/\/manga\/\d+\/chapter\/\d+/.test(location.pathname)},async getImgList({setState:n}){const[,,a,,r]=location.pathname.split("/").map(Number),s=await o(a,r),[{pageCount:i}]=s.chapters.nodes,l=s.manga.chapters.totalCount;return n("manga",{onPrev:r>0?()=>e(a,r-1):void 0,onNext:r<l?()=>e(a,r+1):void 0}),t.range(i,e=>`/api/v1/manga/${a}/chapter/${r}/page/${e}`)},onShowImgsChange:t.debounce((e,n)=>{const o=n[[...e].at(-1)].src;t.querySelector(`img[src$="${o}"]`)?.scrollIntoView({behavior:"instant",block:"end"})},500)}}if("/reader"===location.pathname&&"LANraragi."===document.querySelector('.ip > a[href="https://github.com/Difegue/LANraragi"]')?.textContent.trim()){let n=!0;h={name:"LANraragi",getImgList:()=>t.wait(()=>Reader?.pages),onShowImgsChange:t.debounce((o,a)=>{Reader&&(a.length>0&&n&&(n=!1,e.setState(e=>{e.activePageIndex=e.pageList.findIndex(e=>e.includes(Reader.currentPage))})),Reader.currentPage=t.clamp(0,[...o].at(-1),Reader.maxPage),Reader.updateProgress())},200)}}h||(async()=>{if(void 0!==await GM.getValue(location.hostname))return t.requestIdleCallback(u.otherSite);await GM.registerMenuCommand((e=>{switch(e){case"en":return"Enter simple reading mode";case"ru":return"Включить простой режим чтения";default:return"使用简易阅读模式"}})(await p.getInitLang()),()=>u.otherSite())})()}}h&&g.universal(h)}catch(e){d.log.error(e)}