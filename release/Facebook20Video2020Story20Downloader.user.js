// ==UserScript==
// @name          Facebook Video & Story Downloader
// @namespace     King1x32
// @icon          https://www.facebook.com/favicon.ico
// @match         https://www.facebook.com/*
// @exclude-match https://www.facebook.com/
// @version       2.1
// @license       MIT
// @grant         GM_registerMenuCommand
// @grant         GM_xmlhttpRequest
// @grant         GM_download
// @downloadURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/Facebook20Video2020Story20Downloader.user.js
// @updateURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/Facebook20Video2020Story20Downloader.meta.js
// ==/UserScript==
(()=>{function e(e){const t=e.getBoundingClientRect();return Math.min(t.bottom,window.innerHeight||document.documentElement.clientHeight)-Math.max(0,t.top)}function t(e){try{const t=e.src;if(t&&t.includes("blob:")){const t=e.closest("[data-instancekey]");if(t){const e=t.getAttribute("data-instancekey");if(e){const t=e.match(/id-vpuid-([a-f0-9-]+)/);if(t)return t[1]}}}}catch(e){}try{let t=e;for(let e=0;e<10&&t;e++){for(let e in t)if(e.startsWith("__reactProps")||e.startsWith("__reactInternalInstance"))try{const n=t[e];if(n&&n.children&&n.children.props){const e=n.children.props.videoFBID||n.children.props.videoId;if(e)return e}if(n&&n.videoFBID)return n.videoFBID;if(n&&n.videoId)return n.videoId}catch(e){}t=t.parentElement}}catch(e){}try{const e=window.location.href,t=e.match(/\/videos\/(\d+)/);if(t)return t[1];const n=e.match(/\/watch\/?\?.*[&?]v=(\d+)/);if(n)return n[1]}catch(e){}try{let t=e.parentElement;for(let e=0;e<20&&t;e++){const e=t.getAttribute("data-video-id")||t.getAttribute("data-video-fbid")||t.getAttribute("data-videoid");if(e)return e;t=t.parentElement}}catch(e){}try{const e=document.querySelectorAll("script");for(const t of e)if(t.textContent){const e=t.textContent.match(/"videoFBID":"(\d+)"/);if(e)return e[1];const n=t.textContent.match(/"video_id":"(\d+)"/);if(n)return n[1]}}catch(e){}return null}async function n(e){const t=await async function(){try{if(window.require)return require("DTSGInitialData").token}catch(e){}try{const e=document.documentElement.innerHTML.match(/"token":"([^"]+)"/);if(e)return e[1]}catch(e){}try{const e=document.querySelectorAll("script");for(const t of e)if(t.textContent&&t.textContent.includes("DTSGInitialData")){const e=t.textContent.match(/"token":"([^"]+)"/);if(e)return e[1]}}catch(e){}throw new Error("Could not find DTSG token")}();try{return await async function(e,t){const n=await fetch("https://www.facebook.com/video/video_data_async/?video_id="+e,{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded","x-requested-with":"XMLHttpRequest"},body:o({__a:"1",fb_dtsg:t})});let r=await n.text();r=r.replace("for (;;);","");const i=JSON.parse(r),{hd_src:a,hd_src_no_ratelimit:c,sd_src:d,sd_src_no_ratelimit:s}=i?.payload||{},l=c||a||s||d;if(!l)throw new Error("No video URL found in response");return l}(e,t)}catch(n){try{return await async function(e,t){const n=await function(e,t,n){return fetch("https://www.facebook.com/api/graphql/",{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded","x-requested-with":"XMLHttpRequest"},body:o({doc_id:"5279476072161634",variables:JSON.stringify(t),fb_dtsg:n,server_timestamps:!0})})}(0,{UFI2CommentsProvider_commentsKey:"CometTahoeSidePaneQuery",caller:"CHANNEL_VIEW_FROM_PAGE_TIMELINE",videoID:e},t),r=(await n.text()).split("\n");if(0===r.length)throw new Error("Empty response from GraphQL");const i=JSON.parse(r[0]);if(!i.data||!i.data.video)throw new Error("No video data in GraphQL response");const a=i.data.video.playable_url_quality_hd||i.data.video.playable_url;if(!a)throw new Error("No playable URL found in video data");return a}(e,t)}catch(t){throw new Error(`Both download methods failed for video ${e}`)}}}function o(e,t){const n=[];for(const r in e)if(e.hasOwnProperty(r)){const i=t?t+"["+r+"]":r,a=e[r];n.push(null!==a&&"object"==typeof a?o(a,i):encodeURIComponent(i)+"="+encodeURIComponent(a))}return n.join("&")}async function r(e,t){"undefined"==typeof GM_download?i(e,t):GM_download({url:e,name:t,saveAs:!1,onload:()=>console.log("Download completed: "+t),onerror:n=>{console.error("GM_download failed:",n),i(e,t)}})}async function i(e,t){try{if("undefined"!=typeof GM_xmlhttpRequest)GM_xmlhttpRequest({method:"GET",url:e,responseType:"blob",onload:function(e){const n=e.response,o=URL.createObjectURL(n),r=document.createElement("a");r.href=o,r.download=t,r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r),setTimeout(()=>URL.revokeObjectURL(o),100)},onerror:function(t){console.error("Download failed:",t),window.open(e,"_blank")}});else{const n=await fetch(e),o=await n.blob(),r=URL.createObjectURL(o),i=document.createElement("a");i.href=r,i.download=t,i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i),setTimeout(()=>URL.revokeObjectURL(r),100)}}catch(t){console.error("Download failed:",t),confirm("Direct download failed. Would you like to open the video in a new tab? You can right-click and save from there.")&&window.open(e,"_blank")}}async function a(){try{const o=await async function(){const n=Array.from(document.querySelectorAll("video")),o=[];for(const r of n){const n=t(r);n&&o.push({videoId:n,overlapScore:e(r),playing:r.currentTime>0&&!r.paused&&!r.ended&&r.readyState>2})}if(0===o.length){const e=function(){try{if(window.__initialData){const e=JSON.stringify(window.__initialData).match(/"videoFBID":"(\d+)"/);if(e)return[e[1]]}if(window.require&&"function"==typeof window.require.getData){const e=window.require.getData();if(e)return(JSON.stringify(e).match(/"videoFBID":"(\d+)"/g)||[]).map(e=>e.match(/"videoFBID":"(\d+)"/)[1])}const e=(document.documentElement.innerHTML.match(/"videoFBID":"(\d+)"/g)||[]).map(e=>e.match(/"videoFBID":"(\d+)"/)[1]);if(e.length>0)return[...new Set(e)]}catch(e){}return[]}();for(const t of e)o.push({videoId:t,overlapScore:100,playing:!1})}const r=o.find(e=>e.playing);return r?[r.videoId]:o.filter(e=>e.videoId&&(e.overlapScore>0||e.playing)).sort((e,t)=>t.overlapScore-e.overlapScore).map(e=>e.videoId)}();if(!o?.length)throw Error("No video found on the page.");let i=0;for(const e of o)try{const t=await n(e);t&&(await r(t,`fb_video_${e}.mp4`),i++)}catch(e){}if(0===i)throw new Error("Could not download any videos.")}catch(e){alert("ERROR: "+e.message)}}function c(e){if(!function(){const e=window.location.href;return!/\/watch\?v=/.test(e)&&!/facebook\.com\/stories\//.test(e)}())return;if(e.parentElement.querySelector(".fb-video-download-icon"))return;const t=e.closest("[data-instancekey]")||e.closest('[class*="x5yr21d"][class*="x1n2onr6"]')||e.parentElement;if(t){"static"===window.getComputedStyle(t).position&&(t.style.position="relative");const e=function(e=null){const t=document.createElement("div");return t.className="fb-video-download-icon",t.innerHTML='\n      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">\n        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>\n        <polyline points="7,10 12,15 17,10"></polyline>\n        <line x1="12" y1="15" x2="12" y2="3"></line>\n      </svg>\n    ',t.style.cssText="\n      position: absolute;\n      top: 8px;\n      right: 8px;\n      width: 32px;\n      height: 32px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      background: rgba(0, 0, 0, 0.6);\n      color: white;\n      border-radius: 50%;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      z-index: 1001;\n      backdrop-filter: blur(4px);\n      opacity: 0.8;\n    ",t.addEventListener("mouseenter",()=>{t.style.opacity="1",t.style.background="rgba(0, 0, 0, 0.8)",t.style.transform="scale(1.1)"}),t.addEventListener("mouseleave",()=>{t.classList.contains("downloading")||(t.style.opacity="0.8",t.style.background="rgba(0, 0, 0, 0.6)",t.style.transform="scale(1)")}),t.addEventListener("click",async n=>{if(n.preventDefault(),n.stopPropagation(),!t.classList.contains("downloading")){t.classList.add("downloading"),t.innerHTML='\n        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="animation: spin 1s linear infinite;">\n          <circle cx="12" cy="12" r="10"></circle>\n        </svg>\n      ',t.style.background="rgba(66, 165, 245, 0.9)",t.style.opacity="1";try{/\/stories\//.test(window.location.href)&&e?await e.handleDownload():await a(),t.innerHTML='\n          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">\n            <path d="M20 6L9 17l-5-5"></path>\n          </svg>\n        ',t.style.background="rgba(76, 175, 80, 0.9)",setTimeout(()=>{t.innerHTML='\n            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">\n              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>\n              <polyline points="7,10 12,15 17,10"></polyline>\n              <line x1="12" y1="15" x2="12" y2="3"></line>\n            </svg>\n          ',t.style.background="rgba(0, 0, 0, 0.6)",t.style.opacity="0.8",t.classList.remove("downloading")},2e3)}catch(e){t.innerHTML='\n          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">\n            <circle cx="12" cy="12" r="10"></circle>\n            <line x1="15" y1="9" x2="9" y2="15"></line>\n            <line x1="9" y1="9" x2="15" y2="15"></line>\n          </svg>\n        ',t.style.background="rgba(244, 67, 54, 0.9)",setTimeout(()=>{t.innerHTML='\n            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">\n              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>\n              <polyline points="7,10 12,15 17,10"></polyline>\n              <line x1="12" y1="15" x2="12" y2="3"></line>\n            </svg>\n          ',t.style.background="rgba(0, 0, 0, 0.6)",t.style.opacity="0.8",t.classList.remove("downloading")},3e3)}}}),t}();t.appendChild(e),t.addEventListener("mouseenter",()=>{e.style.opacity="0.8"}),t.addEventListener("mouseleave",()=>{e.classList.contains("downloading")||(e.style.opacity="0.6")}),e.style.opacity="0.6"}}const d=document.createElement("style");d.textContent="\n    @keyframes spin {\n      from { transform: rotate(0deg); }\n      to { transform: rotate(360deg); }\n    }\n  ",document.head.appendChild(d),setTimeout(()=>{document.querySelectorAll("video").forEach(e=>{c(e)})},1e3),new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE){const t=e.querySelectorAll?e.querySelectorAll("video"):[];"VIDEO"===e.tagName&&c(e),t.forEach(e=>{setTimeout(()=>c(e),300)})}})})}).observe(document.body,{childList:!0,subtree:!0}),/\/stories\//.test(window.location.href)&&new class{constructor(){this.mediaUrl=null,this.detectedVideo=null,this.init()}init(){this.setupMutationObserver()}setupMutationObserver(){new MutationObserver(()=>this.checkPageStructure()).observe(document.body,{childList:!0,subtree:!0})}get isFacebookPage(){return/(facebook)/.test(window.location.href)}checkPageStructure(){const e=document.getElementById("downloadBtn");/(\/stories\/)/.test(window.location.href)?this.createButtonWithPolling():e&&e.remove()}createButtonWithPolling(){let e=0;const t=setInterval(()=>{document.getElementById("downloadBtn")?clearInterval(t):((this.createButton()||e>=5)&&clearInterval(t),e++)},500)}createButton(){if(document.getElementById("downloadBtn"))return null;const e=(this.isFacebookPage?Array.from(document.querySelectorAll("div.xtotuo0")):Array.from(document.querySelectorAll("div.x1xmf6yo"))).find(e=>e instanceof HTMLElement&&e.offsetHeight>0);if(!e)return null;const t=document.createElement("button");return t.id="downloadBtn",t.textContent="⬇",t.style.fontSize="20px",t.style.background="transparent",t.style.border="none",t.style.color="white",t.style.cursor="pointer",t.style.zIndex="9999",t.addEventListener("click",()=>this.handleDownload()),e.appendChild(t),t}async handleDownload(){try{if(await this.detectMedia(),!this.mediaUrl)return;const e=this.generateFileName();await this.downloadMedia(this.mediaUrl,e)}catch{}}async detectMedia(){const e=this.findVideo(),t=this.findImage();e?(this.mediaUrl=e,this.detectedVideo=!0):t&&(this.mediaUrl=t.src,this.detectedVideo=!1)}findVideo(){const e=Array.from(document.querySelectorAll("video")).filter(e=>e.offsetHeight>0);for(const t of e){const e=this.searchVideoSource(t);if(e)return e}return null}searchVideoSource(e){const t=Object.keys(e).find(e=>e.startsWith("__reactFiber"));if(!t)return null;const n=t.replace("__reactFiber",""),o=e.parentElement?.parentElement?.parentElement?.parentElement,r=o?.[`__reactProps${n}`],i=r?.children?.[0]?.props?.children?.props?.implementations??r?.children?.props?.children?.props?.implementations;if(i)for(const e of[1,0,2]){const t=i[e]?.data,n=t?.hdSrc||t?.sdSrc||t?.hd_src||t?.sd_src;if(n)return n}const a=e[t]?.return?.stateNode?.props?.videoData?.$1;return a?.hd_src||a?.sd_src||null}findImage(){return Array.from(document.querySelectorAll("img")).filter(e=>e.offsetHeight>0&&e.src.includes("cdn")).find(e=>e.height>400)||null}generateFileName(){const e=(new Date).toISOString().split("T")[0];let t="unknown";if(this.isFacebookPage){const e=Array.from(document.querySelectorAll("span.xuxw1ft.xlyipyv")).find(e=>e instanceof HTMLElement&&e.offsetWidth>0);t=e?.innerText||t}else{const e=Array.from(document.querySelectorAll(".x1i10hfl")).find(e=>e instanceof HTMLAnchorElement&&e.offsetHeight>0&&e.offsetHeight<35);t=e?.pathname.replace(/\//g,"")||t}return`${t}-${e}.${this.detectedVideo?"mp4":"jpg"}`}async downloadMedia(e,t){try{await r(e,t)}catch(e){console.error("Story download failed:",e)}}},GM_registerMenuCommand("Download Video",a),document.addEventListener("keydown",function(e){e.ctrlKey&&e.shiftKey&&"D"===e.key&&(e.preventDefault(),a())})})();