// ==UserScript==
// @name            YouTube downloader
// @icon            https://raw.githubusercontent.com/madkarmaa/youtube-downloader/main/images/icon.png
// @namespace       aGkgdGhlcmUgOik=
// @source          https://github.com/madkarmaa/youtube-downloader
// @supportURL      https://github.com/madkarmaa/youtube-downloader
// @version         3.4.0
// @author          mk_
// @match           *://*.youtube.com/*
// @connect         api.cobalt.tools
// @connect         raw.githubusercontent.com
// @grant           GM_info
// @grant           GM_addStyle
// @grant           GM_xmlHttpRequest
// @grant           GM_xmlhttpRequest
// @run-at          document-start
// @downloadURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/YouTube20downloader.user.js
// @updateURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/YouTube20downloader.meta.js
// ==/UserScript==
(async()=>{"use strict";function e(e,...n){u&&"info"===e.toLowerCase()?y.apply(console,["%c[YTDL]","color: #f00;",...n]):u&&"warn"===e.toLowerCase()?m.apply(console,["%c[YTDL]","color: #f00;",...n]):"error"===e.toLowerCase()&&f.apply(console,["%c[YTDL]","color: #f00;",...n])}function n(e,n=!1){return new Promise((t,o)=>{GM_xmlhttpRequest({method:"POST",url:"https://api.cobalt.tools/api/json",headers:{"Cache-Control":"no-cache",Accept:"application/json","Content-Type":"application/json"},data:JSON.stringify({url:encodeURI(e),vQuality:localStorage.getItem("ytdl-quality")??"max",filenamePattern:"basic",isAudioOnly:n,disableMetadata:!0}),onload:e=>{const n=JSON.parse(e.responseText);n?.url?t(n.url):o(n)},onerror:e=>o(e)})})}function t(e){return new Promise(n=>{if(document.querySelector(e))return n(document.querySelector(e));const t=new MutationObserver(()=>{document.querySelector(e)&&(t.disconnect(),n(document.querySelector(e)))});t.observe(document.body,{childList:!0,subtree:!0})})}function o(e,n,t=!1){e.addEventListener("animationend",e=>{e.animationName===n&&(t?e.target.remove():e.target.style.display="none")})}function a(e){return e.replace(/{{\s*([^}\s]+)\s*}}/g,(e,n)=>b[n]||e)}function i(){return"www.youtube.com"===window.location.hostname&&window.location.pathname.startsWith("/shorts")?"SHORTS":"www.youtube.com"===window.location.hostname&&window.location.pathname.startsWith("/watch")?"WATCH":"music.youtube.com"===window.location.hostname?"MUSIC":"www.youtube.com"===window.location.hostname?"YOUTUBE":null}function d(e,n){return e.contains(n)}async function r(){const t="MUSIC"===i();if(!t&&!h)return e("warn","Video data not ready"),void new g("Wait!","The video data is not ready yet, try again in a few seconds.","popup",!1);if(t&&!window.location.pathname.startsWith("/watch"))return e("warn","Video URL not avaiable"),void new g("Wait!","Open the music player so the song link is visible, then try again.","popup",!1);try{e("info","Download started"),c.enabled?c.openUrl&&window.open(a(c.openUrl)):window.open(await n(t?window.location.href.replace("music.youtube.com","www.youtube.com"):b.video_url),"_blank"),e("info","Download completed")}catch(n){e("error",JSON.parse(JSON.stringify(n))),new g("Error",JSON.stringify(n),"error",!1)}}async function l(t){const o="MUSIC"===i();if(t.preventDefault(),!o&&!h)return e("warn","Video data not ready"),new g("Wait!","The video data is not ready yet, try again in a few seconds.","popup",!1),!1;if(o&&!window.location.pathname.startsWith("/watch"))return e("warn","Video URL not avaiable"),void new g("Wait!","Open the music player so the song link is visible, then try again.","popup",!1);try{e("info","Download started"),c.enabled?c.openUrl&&window.open(a(c.openUrl)):window.open(await n(o?window.location.href.replace("music.youtube.com","www.youtube.com"):b.video_url,!0),"_blank"),e("info","Download completed")}catch(n){e("error",JSON.parse(JSON.stringify(n))),new g("Error",JSON.stringify(n),"error",!1)}return!1}async function s(n){const o="#actions.style-scope.ytd-reel-player-overlay-renderer",a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.setAttribute("xmlns","http://www.w3.org/2000/svg"),a.setAttribute("fill","currentColor"),a.setAttribute("height","24"),a.setAttribute("viewBox","0 0 24 24"),a.setAttribute("width","24"),a.setAttribute("focusable","false"),a.style.pointerEvents="none",a.style.display="block",a.style.width="100%",a.style.height="100%";const s=document.createElementNS("http://www.w3.org/2000/svg","path");s.setAttribute("d","M17 18v1H6v-1h11zm-.5-6.6-.7-.7-3.8 3.7V4h-1v10.4l-3.8-3.8-.7.7 5 5 5-4.9z"),a.appendChild(s);const c=document.createElement("button");switch(c.id="ytdl-download-button",c.classList.add("ytp-button"),c.title="Left click to download as video, right click as audio only",c.appendChild(a),i()){case"WATCH":const a=await t("#movie_player > div.ytp-chrome-bottom > div.ytp-chrome-controls > div.ytp-right-controls");if(e("info","Download button container found\n\n",a),d(a,a.querySelector("#ytdl-download-button"))){e("warn","Download button already in container");break}const i=c.cloneNode(!0);i.classList.add("YT"),i.addEventListener("click",r),i.addEventListener("contextmenu",l),e("info","Download button created\n\n",i),a.insertBefore(i,a.firstChild),e("info","Download button inserted in container");break;case"MUSIC":const s=await t("#layout > ytmusic-player-bar > div.middle-controls.style-scope.ytmusic-player-bar > div.middle-controls-buttons.style-scope.ytmusic-player-bar");if(e("info","Download button container found\n\n",s),d(s,s.querySelector("#ytdl-download-button"))){e("warn","Download button already in container");break}const u=c.cloneNode(!0);u.classList.add("YTM"),u.addEventListener("click",r),u.addEventListener("contextmenu",l),e("info","Download button created\n\n",u),s.insertBefore(u,s.firstChild),e("info","Download button inserted in container");break;case"SHORTS":if("yt-navigate-finish"!==n.type)return;await t(o);const p=Array.from(document.querySelectorAll(o)).filter(e=>function(e,n=!1){const{top:t,left:o,bottom:a,right:i}=e.getBoundingClientRect(),{innerHeight:d,innerWidth:r}=window;return n?(t>0&&t<d||a>0&&a<d)&&(o>0&&o<r||i>0&&i<r):t>=0&&o>=0&&a<=d&&i<=r}(e));e("info","Download button containers found\n\n",p),p.forEach(n=>{if(d(n,n.querySelector("#ytdl-download-button")))return void e("warn","Download button already in container");const t=c.cloneNode(!0);t.classList.add("YTS","yt-spec-button-shape-next","yt-spec-button-shape-next--tonal","yt-spec-button-shape-next--mono","yt-spec-button-shape-next--size-l","yt-spec-button-shape-next--icon-button"),t.addEventListener("click",r),t.addEventListener("contextmenu",l),e("info","Download button created\n\n",t),n.insertBefore(t,n.firstChild),e("info","Download button inserted in container")});break;default:return}}if(!i()||window!==window.parent)return;let c=localStorage.getItem("ytdl-advanced-settings")?JSON.parse(localStorage.getItem("ytdl-advanced-settings")):{enabled:!1,openUrl:""};localStorage.setItem("ytdl-advanced-settings",JSON.stringify(c));let u="true"===String(localStorage.getItem("ytdl-dev-mode")).toLowerCase(),p=null===localStorage.getItem("ytdl-notif-enabled")||"true"===String(localStorage.getItem("ytdl-notif-enabled")).toLowerCase(),y=console.log,m=console.warn,f=console.error,b={video_duration:null,video_url:null,video_author:null,video_title:null,video_id:null},h=!1;const w={MAX:"max","2160p":"2160","1440p":"1440","1080p":"1080","720p":"720","480p":"480","360p":"360","240p":"240","144p":"144"};class g{constructor(n,t,a,i=!0){const d=document.createElement("div");d.classList.add("ytdl-notification","opened",a),o(d,"closeNotif",!0);const r=document.createElement("h2");r.textContent=n,d.appendChild(r);const l=document.createElement("div");t.split("\n").forEach(e=>{const n=document.createElement("p");n.textContent=e,l.appendChild(n)}),d.appendChild(l);const s=document.createElement("button");s.textContent="Dismiss",s.addEventListener("click",()=>{if(i){const n=JSON.parse(localStorage.getItem("ytdl-notifications")??"[]");n.push(a),localStorage.setItem("ytdl-notifications",JSON.stringify(n)),e("info",`Notification ${a} set as read`)}d.classList.remove("opened"),d.classList.add("closed")}),d.appendChild(s),document.body.appendChild(d),e("info","New notification displayed",d)}}GM_addStyle('\n#ytdl-sideMenu {\n    min-height: 100vh;\n    z-index: 9998;\n    position: absolute;\n    top: 0;\n    left: -100vw;\n    width: 50vw;\n    background-color: var(--yt-spec-base-background);\n    border-right: 2px solid var(--yt-spec-static-grey);\n    display: flex;\n    flex-direction: column;\n    gap: 2rem;\n    padding: 2rem 2.5rem;\n    font-family: "Roboto", "Arial", sans-serif;\n}\n\n#ytdl-sideMenu.opened {\n    animation: openMenu .3s linear forwards;\n}\n\n#ytdl-sideMenu.closed {\n    animation: closeMenu .3s linear forwards;\n}\n\n#ytdl-sideMenu a {\n    color: var(--yt-brand-youtube-red);\n    text-decoration: none;\n    font-weight: 600;\n}\n\n#ytdl-sideMenu a:hover {\n    text-decoration: underline;\n}\n\n#ytdl-sideMenu label {\n    display: flex;\n    flex-direction: column;\n    gap: 0.5rem;\n    font-size: 1.4rem;\n    color: var(--yt-spec-text-primary);\n}\n\n#ytdl-sideMenu .header {\n    text-align: center;\n    font-size: 2.5rem;\n    color: var(--yt-brand-youtube-red);\n}\n\n#ytdl-sideMenu .setting-row {\n    display: flex;\n    flex-direction: column;\n    gap: 1rem;\n    transition: all 0.2s ease-in-out;\n}\n\n#ytdl-sideMenu .setting-label {\n    font-size: 1.8rem;\n    color: var(--yt-brand-youtube-red);\n}\n\n#ytdl-sideMenu .setting-description {\n    font-size: 1.4rem;\n    color: var(--yt-spec-text-primary);\n}\n\n.ytdl-switch {\n    display: inline-block;\n}\n\n.ytdl-switch input {\n    display: none;\n}\n\n.ytdl-switch label {\n    display: block;\n    width: 50px;\n    height: 19.5px;\n    padding: 3px;\n    border-radius: 15px;\n    border: 2px solid var(--yt-brand-medium-red);\n    cursor: pointer;\n    transition: 0.3s;\n}\n\n.ytdl-switch label::after {\n    content: "";\n    display: inherit;\n    width: 20px;\n    height: 20px;\n    border-radius: 12px;\n    background: var(--yt-brand-medium-red);\n    transition: 0.3s;\n}\n\n.ytdl-switch input:checked ~ label {\n    border-color: var(--yt-spec-light-green);\n}\n\n.ytdl-switch input:checked ~ label::after {\n    translate: 30px 0;\n    background: var(--yt-spec-light-green);\n}\n\n.ytdl-switch input:disabled ~ label {\n    opacity: 0.5;\n    cursor: not-allowed;\n}\n\n#ytdl-sideMenu .advanced-options {\n    display: flex;\n    flex-direction: column;\n    gap: 0.7rem;\n    margin: 1rem 0;\n}\n\n#ytdl-sideMenu .advanced-options.opened {\n    animation: openNotif 0.3s linear forwards;\n}\n#ytdl-sideMenu .advanced-options.closed {\n    animation: closeNotif .3s linear forwards;\n}\n\n#ytdl-sideMenu input[type="url"] {\n    background: none;\n    padding: 0.7rem 1rem;\n    border: none;\n    outline: none;\n    border-bottom: 2px solid var(--yt-spec-red-70);\n    color: var(--yt-spec-text-primary);\n    font-family: monospace;\n    transition: border-bottom-color 0.2s ease-in-out;\n}\n\n#ytdl-sideMenu input[type="url"]:focus {\n    border-bottom-color: var(--yt-brand-youtube-red);\n}\n\n.ytdl-notification {\n    display: flex;\n    flex-direction: column;\n    gap: 2rem;\n    position: fixed;\n    top: 50vh;\n    left: 50vw;\n    transform: translate(-50%, -50%);\n    background-color: var(--yt-spec-base-background);\n    border: 2px solid var(--yt-spec-static-grey);\n    border-radius: 8px;\n    color: var(--yt-spec-text-primary);\n    z-index: 9999;\n    padding: 1.5rem 1.6rem;\n    font-family: "Roboto", "Arial", sans-serif;\n    font-size: 1.4rem;\n    width: fit-content;\n    height: fit-content;\n    max-width: 40vw;\n    max-height: 50vh;\n    word-wrap: break-word;\n    line-height: var(--yt-caption-line-height);\n}\n\n.ytdl-notification.opened {\n    animation: openNotif 0.3s linear forwards;\n}\n\n.ytdl-notification.closed {\n    animation: closeNotif 0.3s linear forwards;\n}\n\n.ytdl-notification h2 {\n    color: var(--yt-brand-youtube-red);\n}\n\n.ytdl-notification > div {\n    display: flex;\n    flex-direction: column;\n    gap: 1rem;\n}\n\n.ytdl-notification > button {\n    transition: all 0.2s ease-in-out;\n    cursor: pointer;\n    border: 2px solid var(--yt-spec-static-grey);\n    border-radius: 8px;\n    background-color: var(--yt-brand-medium-red);\n    padding: 0.7rem 0.8rem;\n    color: #fff;\n    font-weight: 600;\n}\n\n.ytdl-notification button:hover {\n    background-color: var(--yt-spec-red-70);\n}\n\n#ytdl-download-button {\n    background: none;\n    border: none;\n    outline: none;\n    color: var(--yt-spec-text-primary);\n    cursor: pointer;\n    transition: color 0.2s ease-in-out;\n    display: inline-flex;\n    justify-content: center;\n    align-items: center;\n}\n\n#ytdl-download-button:hover {\n    color: var(--yt-brand-youtube-red);\n}\n\n#ytdl-download-button.YTM {\n    transform: scale(1.5);\n    margin: 0 1rem;\n}\n\n#ytdl-download-button > svg {\n    transform: translateX(3.35%);\n}\n\n#ytdl-dl-quality-select {\n    background-color: var(--yt-spec-base-background);\n    color: var(--yt-spec-text-primary);\n    padding: 0.7rem 1rem;\n    border: none;\n    outline: none;\n    border-bottom: 2px solid var(--yt-spec-red-70);\n    border-left: 2px solid var(--yt-spec-red-70);\n    transition: all 0.2s ease-in-out;\n    font-family: "Roboto", "Arial", sans-serif;\n    font-size: 1.4rem;\n}\n\n#ytdl-dl-quality-select:focus {\n    border-bottom-color: var(--yt-brand-youtube-red);\n    border-left-color: var(--yt-brand-youtube-red);\n}\n\n#ytdl-sideMenu > div:has(> #ytdl-dl-quality-select:disabled) {\n    filter: grayscale(0.8);\n}\n\n#ytdl-dl-quality-select:disabled {\n    cursor: not-allowed;\n}\n\n@keyframes openMenu {\n    0% {\n        left: -100vw;\n    }\n\n    100% {\n        left: 0;\n    }\n}\n\n@keyframes closeMenu {\n    0% {\n        left: 0;\n    }\n\n    100% {\n        left: -100vw;\n    }\n}\n\n@keyframes openNotif {\n    0% {\n        opacity: 0;\n    }\n\n    100% {\n        opacity: 1;\n    }\n}\n\n@keyframes closeNotif {\n    0% {\n        opacity: 1;\n    }\n\n    100% {\n        opacity: 0;\n    }\n}\n'),e("info","Custom styles added"),async function(...n){document.addEventListener("yt-player-updated",e=>{for(let t=0;t<n.length;t++)n[t](e)}),e("info","Video player event hooked. Callbacks:\n\n",n.map(e=>e.name))}(async function(n){h=!1;const t=n.detail?.getVideoData();b.video_duration=n.detail?.getDuration(),b.video_url=n.detail?.getVideoUrl(),b.video_author=t?.author,b.video_title=t?.title,b.video_id=t?.video_id,h=!0,e("info","Video data updated\n\n",b)}),async function(...n){["yt-navigate","yt-navigate-finish","yt-navigate-finish","yt-page-data-updated"].forEach(e=>{document.addEventListener(e,e=>{for(let t=0;t<n.length;t++)n[t](e)})}),e("info","Navigation events hooked. Callbacks:\n\n",n.map(e=>e.name))}(s,async function(){u&&e("info","Current service is: "+i())}),window.addEventListener("DOMContentLoaded",()=>{(async function(){const n=document.createElement("div");n.id="ytdl-sideMenu",n.classList.add("closed"),n.style.display="none",o(n,"closeMenu");const t=document.createElement("h2");t.textContent="Youtube downloader settings",t.classList.add("header"),n.appendChild(t);const a=document.createElement("div");a.classList.add("setting-row");const i=document.createElement("h3");i.classList.add("setting-label");const d=document.createElement("p");d.classList.add("setting-description"),a.append(i,d);const r=document.createElement("span");r.classList.add("ytdl-switch");const l=document.createElement("input");l.type="checkbox";const s=document.createElement("label");r.append(l,s);const y=a.cloneNode(!0);y.querySelector(".setting-label").textContent="Notifications",y.querySelector(".setting-description").textContent="Disable if you don't want to receive notifications from the developer.";const m=r.cloneNode(!0);m.querySelector("input").checked=p,m.querySelector("input").id="ytdl-notif-switch",m.querySelector("label").setAttribute("for","ytdl-notif-switch"),m.querySelector("input").addEventListener("change",n=>{p=n.target.checked,localStorage.setItem("ytdl-notif-enabled",p),e("info","Notifications "+(p?"enabled":"disabled"))}),y.appendChild(m),n.appendChild(y);const f=a.cloneNode(!0);f.querySelector(".setting-label").textContent="Video download quality",f.querySelector(".setting-description").textContent="Control the resolution of the downloaded videos. Not all the resolutions are supported by some videos.";const b=document.createElement("select");b.name="dl-quality",b.id="ytdl-dl-quality-select",b.disabled=c.enabled,Object.entries(w).forEach(([e,n])=>{const t=document.createElement("option");t.textContent=e,t.value=n,b.appendChild(t)}),b.value=localStorage.getItem("ytdl-quality")??"max",b.addEventListener("change",n=>{localStorage.setItem("ytdl-quality",String(n.target.value)),e("info",`Download quality set to ${n.target.value}`)}),f.appendChild(b),n.appendChild(f);const h=a.cloneNode(!0);h.querySelector(".setting-label").textContent="Developer mode",h.querySelector(".setting-description").textContent="Show a detailed output of what's happening under the hood in the console.";const g=r.cloneNode(!0);g.querySelector("input").checked=u,g.querySelector("input").id="ytdl-dev-mode-switch",g.querySelector("label").setAttribute("for","ytdl-dev-mode-switch"),g.querySelector("input").addEventListener("change",e=>{u=e.target.checked,localStorage.setItem("ytdl-dev-mode",u),console.log("[31m[YTDL][0m Developer mode "+(u?"enabled":"disabled"))}),h.appendChild(g),n.appendChild(h);const v=a.cloneNode(!0);v.querySelector(".setting-label").textContent="Advanced settings",v.querySelector(".setting-description").textContent="FOR EXPERIENCED USERS ONLY. Modify the behaviour of the download button.";const S=document.createElement("div");S.classList.add("advanced-options",c.enabled?"opened":"closed"),S.style.display=c.enabled?"flex":"none",o(S,"closeNotif");const x=r.cloneNode(!0);x.querySelector("input").checked=c.enabled,x.querySelector("input").id="ytdl-advanced-switch",x.querySelector("label").setAttribute("for","ytdl-advanced-switch"),x.querySelector("input").addEventListener("change",n=>{c.enabled=n.target.checked,localStorage.setItem("ytdl-advanced-settings",JSON.stringify(c)),b.disabled=n.target.checked,n.target.checked?(S.style.display="flex",S.classList.remove("closed"),S.classList.add("opened")):(S.classList.remove("opened"),S.classList.add("closed")),e("info","Advanced settings "+(c.enabled?"enabled":"disabled"))}),v.appendChild(x);const L=document.createElement("label");L.setAttribute("for","advanced-settings-open-url"),L.textContent="Open the given URL in a new window. GET request only.";const C=document.createElement("a");C.href="https://github.com/madkarmaa/youtube-downloader/blob/main/docs/PLACEHOLDERS.md",C.target="_blank",C.textContent="Use placeholders to access video data. Click to know about placeholders",L.appendChild(C);const E=document.createElement("input");E.id="advanced-settings-open-url",E.type="url",E.placeholder="URL to open",E.value=c.openUrl??null,E.addEventListener("focusout",n=>{n.target.checkValidity()?(c.openUrl=n.target.value,localStorage.setItem("ytdl-advanced-settings",JSON.stringify(c)),e("info",`Advanced settings: URL to open set to "${n.target.value}"`)):(e("error",`Invalid URL to open: "${n.target.value}"`),alert(n.target.validationMessage),n.target.value="")}),S.append(L,E),v.appendChild(S),n.appendChild(v),document.addEventListener("mousedown",t=>{"none"===n.style.display||n.contains(t.target)||(n.classList.remove("opened"),n.classList.add("closed"),e("info","Side menu closed"))}),document.addEventListener("keydown",t=>{"p"===t.key&&(function(){const e=document.activeElement;return e&&("input"===e.tagName.toLowerCase()||"textarea"===e.tagName.toLowerCase()||"true"===String(e.getAttribute("contenteditable")).toLowerCase())}()||("none"===n.style.display?(n.style.top=window.scrollY+"px",n.style.display="flex",n.classList.remove("closed"),n.classList.add("opened"),e("info","Side menu opened")):(n.classList.remove("opened"),n.classList.add("closed"),e("info","Side menu closed"))))}),window.addEventListener("scroll",()=>{n.classList.contains("closed")||(n.classList.remove("opened"),n.classList.add("closed"),e("info","Side menu closed"))}),document.body.appendChild(n),e("info","Side menu created\n\n",n)})(),s(),async function(){if(!p)return void e("info","Notifications disabled by the user");const n=JSON.parse(localStorage.getItem("ytdl-notifications"))??[];e("info","Local read notifications hashes\n\n",n);const t=await new Promise((e,n)=>{GM_xmlhttpRequest({method:"GET",url:"https://raw.githubusercontent.com/madkarmaa/youtube-downloader/main/notifications.json",headers:{"Cache-Control":"no-cache",Accept:"application/json","Content-Type":"application/json"},onload:t=>{const o=JSON.parse(t.responseText);o?.length?e(o):n(o)},onerror:e=>n(e)})});e("info","Online notifications hashes\n\n",t.map(e=>e.uuid));const o=t.filter(e=>!n.includes(e.uuid));e("info","Unread notifications hashes\n\n",o.map(e=>e.uuid)),o.reverse().forEach(e=>{new g(e.title,e.body,e.uuid)})}()})})();