// ==UserScript==
// @name                YouTube CPU Tamer by AnimationFrame
// @namespace           http://tampermonkey.net/
// @version             2025.02.24.0
// @license             MIT License
// @author              CY Fung
// @match               https://www.youtube.com/*
// @match               https://www.youtube.com/embed/*
// @match               https://www.youtube-nocookie.com/embed/*
// @match               https://www.youtube.com/live_chat*
// @match               https://www.youtube.com/live_chat_replay*
// @match               https://music.youtube.com/*
// @exclude             /^https?://\S+\.(txt|png|jpg|jpeg|gif|xml|svg|manifest|log|ini)[^\/]*$/
// @icon                https://raw.githubusercontent.com/cyfung1031/userscript-supports/main/icons/youtube-cpu-tamper-by-animationframe.webp
// @supportURL          https://github.com/cyfung1031/userscript-supports
// @run-at              document-start
// @grant               none
// @unwrap
// @allFrames           true
// @inject-into         page


// @downloadURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/YouTube20CPU20Tamer20by20AnimationFrame.user.js
// @updateURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/YouTube20CPU20Tamer20by20AnimationFrame.meta.js
// ==/UserScript==
(()=>{"use strict";const t=this instanceof Window?this:window,e="nzsxclvflluv";if(t[e])throw new Error("Duplicated Userscript Calling");t[e]=!0;const n=(async()=>{})().constructor,o=((t,e)=>{const o=(n,o)=>{t=n,e=o};return class extends n{constructor(n=o){super(n),n===o&&(this.resolve=t,this.reject=e)}}})();if(!(()=>{try{const t=document.createElement("canvas");return!(!t.getContext("webgl")&&!t.getContext("experimental-webgl"))}catch(t){return!1}})())throw new Error("Your browser does not support GPU Acceleration. YouTube CPU Tamer by AnimationFrame is skipped.");const r=(()=>{window.__j6YiAc__=1,document.addEventListener("timeupdate",()=>{window.__j6YiAc__=Date.now()},!0);let t=-1;try{t=top.__j6YiAc__}catch(t){}return t>=1?()=>top.__j6YiAc__:()=>window.__j6YiAc__})();(async t=>{const e=requestAnimationFrame;try{let o=16;const r="vanillajs-iframe-v1";let i=document.getElementById(r),a=null;if(!i){i=document.createElement("iframe"),i.id=r;const l="function"==typeof webkitCancelAnimationFrame&&"undefined"==typeof kagi?i.src=URL.createObjectURL(new Blob([],{type:"text/html"})):null;i.sandbox="allow-same-origin";let c=document.createElement("noscript");for(c.appendChild(i);!document.documentElement&&o-- >0;)await new n(e);document.documentElement.appendChild(c),l&&n.resolve().then(()=>URL.revokeObjectURL(l)),a=e=>{const n=o=>{o&&t.removeEventListener("DOMContentLoaded",n,!1),o=c,c=t=a=0,e?e(()=>o.remove(),200):o.remove()};e&&"loading"===document.readyState?t.addEventListener("DOMContentLoaded",n,!1):n()}}for(;!i.contentWindow&&o-- >0;)await new n(e);const l=i.contentWindow;if(!l)throw"window is not found.";try{const{requestAnimationFrame:e,setInterval:o,setTimeout:r,clearInterval:i,clearTimeout:c}=l,s={requestAnimationFrame:e,setInterval:o,setTimeout:r,clearInterval:i,clearTimeout:c};for(let e in s)s[e]=s[e].bind(t);return a&&n.resolve(s.setTimeout).then(a),s}catch(t){return a&&a(),null}}catch(t){return console.warn(t),null}})(t).then(e=>{if(!e)return null;const{requestAnimationFrame:i,setTimeout:a,setInterval:l,clearTimeout:c,clearInterval:s}=e;let d=null;const m=(()=>{const t=document.createElement("a-f");if(!("onanimationiteration"in t))return t=>i(d=t);t.id="a-f";let e=null;if(t.onanimationiteration=function(){null!==e&&(e(),e=null)},!document.getElementById("afscript")){const t=document.createElement("style");t.id="afscript",t.textContent="\n          @keyFrames aF1 {\n            0% {\n              order: 0;\n            }\n            100% {\n              order: 1;\n            }\n          }\n          #a-f[id] {\n            visibility: collapse !important;\n            position: fixed !important;\n            display: block !important;\n            top: -100px !important;\n            left: -100px !important;\n            margin:0 !important;\n            padding:0 !important;\n            outline:0 !important;\n            border:0 !important;\n            z-index:-1 !important;\n            width: 0px !important;\n            height: 0px !important;\n            contain: strict !important;\n            pointer-events: none !important;\n            animation: 1ms steps(2, jump-none) 0ms infinite alternate forwards running aF1 !important;\n          }\n        ",(document.head||document.documentElement).appendChild(t)}return document.documentElement.insertBefore(t,document.documentElement.firstChild),t=>e=d=t})();(()=>{let e,i;e=i={resolved:!0};let d=0;const u=async t=>{await new n(m),t.resolved=!0;const e=d=1+(1073741823&d);return t.resolve(e),e},p=new Set,w=async(t,n)=>{try{const a=Date.now();if(a-r()<800&&a-n.dt<800){const t=n.cid;p.add(t);const r=await(async()=>{const t=e.resolved?null:e,n=i.resolved?null:i;let r=0;if(t&&n){const e=await t,o=await n;r=e-o&536870912?o:e}else{const a=t?null:e=new o,l=n?null:i=new o;n?await n:t&&await t,a&&(r=await u(a)),l&&(r=await u(l))}return r})();if(!p.delete(t)||r===n.lastExecution)return;n.lastExecution=r}n.dt=a,t()}catch(t){throw console.error(t),t}},f=t=>(e,n=0,...o)=>{if("function"==typeof e){const r={dt:Date.now()};return r.cid=t(w,n,o.length>0?e.bind(null,...o):e,r)}return t(e,n,...o)};t.setTimeout=f(a),t.setInterval=f(l);const v=t=>e=>{e&&(p.delete(e)||t(e))};t.clearTimeout=v(c),t.clearInterval=v(s);try{t.setTimeout.toString=a.toString.bind(a),t.setInterval.toString=l.toString.bind(l),t.clearTimeout.toString=c.toString.bind(c),t.clearInterval.toString=s.toString.bind(s)}catch(t){console.warn(t)}})();let u=null;l(()=>{u===d?null!==u&&(u(),d=u=null):u=d},125)})})();