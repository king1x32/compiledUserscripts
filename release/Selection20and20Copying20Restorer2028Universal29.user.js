// ==UserScript==
// @name                Selection and Copying Restorer (Universal)
// @version             1.21.0.2
// @namespace           https://greasyfork.org/users/371179
// @author              CY Fung
// @supportURL          https://github.com/cyfung1031/userscript-supports
// @run-at              document-start
// @match               http://*/*
// @match               https://*/*
// @exclude             /^https?://\S+\.(txt|png|jpg|jpeg|gif|xml|svg|manifest|log|ini)[^\/]*$/
// @exclude             https://github.dev/*
// @exclude             https://vscode.dev/*
// @exclude             https://www.photopea.com/*
// @exclude             https://www.google.com/maps/*
// @exclude             https://docs.google.com/*
// @exclude             https://drive.google.com/*
// @exclude             https://mail.google.com/*
// @exclude             https://www.dropbox.com/*
// @exclude             https://outlook.live.com/mail/*
// @exclude             https://www.terabox.com/*
// @exclude             https://leetcode.cn/*
// @icon                https://raw.githubusercontent.com/cyfung1031/userscript-supports/main/icons/selection-copier.png
// @grant               GM_registerMenuCommand
// @grant               GM_unregisterMenuCommand
// @grant               GM.setValue
// @grant               GM.getValue
// @grant               GM_addValueChangeListener
// @grant               unsafeWindow
// @inject-into         page

// @compatible          firefox Violentmonkey
// @compatible          firefox Tampermonkey
// @compatible          chrome Violentmonkey
// @compatible          chrome Tampermonkey
// @compatible          opera Violentmonkey
// @compatible          opera Tampermonkey
// @compatible          safari Stay
// @compatible          edge Violentmonkey
// @compatible          edge Tampermonkey
// @compatible          brave Violentmonkey
// @compatible          brave Tampermonkey


// @downloadURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/Selection20and20Copying20Restorer2028Universal29.user.js
// @updateURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/Selection20and20Copying20Restorer2028Universal29.meta.js
// ==/UserScript==
!async function(e){"use strict";function t(){if("_b1850"in C)return C._b1850;let e=0;return document.createAttribute("z").addEventListener("nil",y,{get passive(){e|=1},get once(){e|=2}}),C._b1850=e}function n(){return!(3&~t())}function o(){return!(1&~t())}function r(){const e=window.getSelection();return!!e.rangeCount&&e.getRangeAt(0).cloneRange()}const{console:s}=e,a=new Proxy({},{get:(e,t)=>e[t]||s[t],set:(e,t,n)=>(e[t]=n.bind(s),!0)});for(const e of["log","debug","dir"])a[e]=s[e];const l="undefined"!=typeof unsafeWindow?unsafeWindow:window;if(!(l instanceof Window))return;const i=(async()=>{})().constructor,u=l.getSelection.bind(l)||Error()(),c=l.requestAnimationFrame.bind(l)||Error()(),p=l.getComputedStyle.bind(l)||Error()(),m=new WeakMap,d=e=>{let t=m.get(e);return t||(t=p(e),m.set(e,t)),t},g=HTMLElement.prototype.focus;let h=16;for(;!document||!document.documentElement;)if(await new i(c),--h<0)return;const f="Selection and Copying Restorer (Universal)",y=()=>{},b=await(async()=>(await i.resolve(),{}))()||{},v={gm_remain_focus_on_mousedown:["https://codi.link"],gm_no_custom_context_menu:["https://www.youtube.com","https://m.youtube.com","https://accounts.youtube.com","https://github.dev","https://vscode.dev","https://www.photopea.com","https://www.google.com","https://docs.google.com","https://drive.google.com","https://www.dropbox.com","https://www.terabox.com","https://outlook.live.com","https://mail.yahoo.co.jp","https://gmail.com","https://www.gmail.com","https://chat.openai.com","https://openai.com","https://github.com","https://www.github.com"],gm_highlight_color_check:["https://www.youtube.com","https://m.youtube.com","https://accounts.youtube.com","https://github.dev","https://vscode.dev","https://www.photopea.com","https://www.google.com","https://docs.google.com","https://drive.google.com","https://www.dropbox.com","https://www.terabox.com","https://outlook.live.com","https://mail.yahoo.co.jp","https://gmail.com","https://www.gmail.com","https://chat.openai.com","https://openai.com","https://github.com","https://www.github.com","https://facebook.com","https://www.facebook.com","https://twitter.com","https://www.twitter.com","https://x.com"]},w=(()=>{const e={},t=function*(...e){for(let t of e)yield*t}(Object.keys(b),Object.keys(v));for(const n of t){if(e[n])continue;const t=e[n]=new Set,o=v[n];if(o&&o.length>=1)for(const e of o)t.add(e);const r=b[n];if(r&&r.length>=1)for(const e of r)"~"===e.charAt(0)?t.delete(e.substring(1)):t.add(e)}return new Proxy(e,{get(e,t){if(!C[t])return!1;const n=e[t];return!n||!n.has(location.origin)},set:()=>!1})})();let _=0;(function(){let e;try{let t={$nil:y};t?.$nil(),t=null,t?.$nil(),e=!0}catch(e){}return!!e})()||a.warn(`${f}: Browser version before 2020-01-01 is not recommended. Please update to the latest version.`);const k="function"==typeof WeakRef?e=>e?new WeakRef(e):null:e=>e||null,E=e=>e&&e.deref?e.deref():e;let x=null;const C={utSelectionColorHack:"msmtwejkzrqa",utTapHighlight:"xfcklblvkjsj",utLpSelection:"gykqyzwufxpz",utHoverBlock:"meefgeibrtqx",utNonEmptyElmPrevElm:"jttkfplemwzo",utHoverTextWrap:"oseksntfvucn",utAltPage:"vzhwnfgxnool",ksFuncReplacerCounter:"___dqzadwpujtct___",ksEventReturnValue:" ___ndjfujndrlsx___",ksSetData:"___rgqclrdllmhr___",ksNonEmptyPlainText:"___grpvyosdjhuk___",eh_capture_passive:()=>!o()||(C._eh_capture_passive=C._eh_capture_passive||{capture:!0,passive:!0}),eh_capture_active:()=>!o()||(C._eh_capture_passive=C._eh_capture_passive||{capture:!0,passive:!1}),mAlert_DOWN:y,mAlert_UP:y,gm_no_custom_context_menu:!0,gm_highlight_color_check:!0,lpKeyPressing:!1,lpKeyPressingPromise:i.resolve(),weakMapFuncReplaced:new WeakMap,ksFuncReplacerCounterId:0,isStackCheckForFuncReplacer:!1,isGlobalEventCheckForFuncReplacer:!1,enableReturnValueReplacment:!1,rangeOnKeyDown:null,eyEvts:["keydown","keyup","copy","contextmenu","select","selectstart","dragstart","beforecopy"],delayMouseUpTasks:0,isNum:e=>e>0||e<0||0===e,getNodeType:e=>e instanceof Node?e.nodeType:-1,isAnySelection:function(){const e=u();return e?"boolean"==typeof e.isCollapsed?!e.isCollapsed:e.toString().length>0:null},updateIsWindowEventSupported:function(){let e=document.createElement("noscript");e.onclick=function(e){C.isGlobalEventCheckForFuncReplacer=window.event===e},e.dispatchEvent(new Event("click")),e=null},createCSSElement:function(e,t){const n=document.createElement("style");return n.textContent=e,t&&t.appendChild(n),n},createFakeAlert:function(e){function t(n){t.__isDisabled__()?a.log("alert msg disabled: ",n):e.apply(this,arguments)}return"function"!=typeof e?null:(t.toString=e.toString.bind(e),t)},createFuncReplacer:function(e){const t=++C.ksFuncReplacerCounterId,n=function(n){const o=e.apply(this,arguments);if(!1===o){if(!this||!n)return!1;const e=this["on"+n.type];if("function"!=typeof e)return!1;if(e[C.ksFuncReplacerCounter]!==t)return!1;if(!1!==n.cancelable&&C.shouldDenyPreventDefault(n)){if(!0===C.isGlobalEventCheckForFuncReplacer&&window.event!==n)return!1;if(!0===C.isStackCheckForFuncReplacer){let e=(new Error).stack;if(0==(e.indexOf("\n")===e.lastIndexOf("\n")))return!1}return!0}}return o};return n[C.ksFuncReplacerCounter]=t,n.toString=e.toString.bind(e),C.weakMapFuncReplaced.set(e,n),n},onceCssHighlightSelection:async()=>{if(document.documentElement.hasAttribute(C.utLpSelection))return;C.onceCssHighlightSelection=null,await i.resolve();const e=[...document.querySelectorAll("a,p,div,span,b,i,strong,li")].filter(e=>0===e.childElementCount),t=e.length?e[e.length>>1]:document.body;await i.resolve();let n=p(t,"::selection").getPropertyValue("background-color")||"";(n.length>9&&/^rgba\(\d+,\s*\d+,\s*\d+,\s*0\)$/.test(n)||(d(document.body).getPropertyValue("background-color")||"")===n)&&document.documentElement.setAttribute(C.utSelectionColorHack,""),await i.resolve();let o=d(t).getPropertyValue("-webkit-tap-highlight-color")||"";o.length>9&&/^rgba\(\d+,\s*\d+,\s*\d+,\s*0\)$/.test(o)&&document.documentElement.setAttribute(C.utTapHighlight,""),document.documentElement.setAttribute(C.utTapHighlight,"")},clipDataProcess:function(e){if(!e)return;const t=E(e[C.ksSetData]);if(!t||t.clipboardData!==e)return;const n=e[C.ksNonEmptyPlainText];if(!n)return;if(!1===t.cancelable||!0===t.defaultPrevented)return;const o=C.rangeOnKeyDown||0;let s=!1;if("function"==typeof o.compareBoundaryPoints){const e=r();e&&0===o.compareBoundaryPoints(Range.START_TO_END,e)&&e.collapsed&&(s=!0)}let l=null,i=!0;if(s);else{let e=u();if(!e)return;let t=e.toString(),o=t.trim();if(t.length>0&&t.length<n.length){let t=o.replace(/[\r\n\t\b\x20\xA0\u200b\uFEFF\u3000]+/g,""),r=n.replace(/[\r\n\t\b\x20\xA0\u200b\uFEFF\u3000]+/g,"").indexOf(t),s=r>=0&&r<n.length/2+1;if(s){let t=C.getNodeType(e.anchorNode),n=C.getNodeType(e.focusNode),o=3===t&&3===n;o||(o=e.anchorNode===e.focusNode&&1===t),s=s&&o}s&&(i=!1,l={msg:"copy event - clipboardData replacement is NOT allowed as the text node(s) is/are selected.",oldText:o,newText:n},i=!1)}i&&(l=o?{msg:"copy event - clipboardData replacement is allowed and the selection is not empty",oldText:o,newText:n}:{msg:"copy event - clipboardData replacement is allowed and the selection is empty",oldText:o,newText:n})}i&&(C.bypass=!0,t.preventDefault(),C.bypass=!1),l&&a.log(l)},shouldDenyPreventDefault:function(e){if(!e||C.bypass)return!1;let t=C.eyEvts.indexOf(e.type);const n=e.target;switch(t){case 6:return null===x&&(x=!1),!(x||C.enableDragging||n instanceof Element&&n.hasAttribute("draggable")&&(C.enableDragging=!0,1));case 3:if(!w.gm_no_custom_context_menu)return!1;if(null===x&&(x=!1),x)return!1;if(n instanceof Element){switch(n.nodeName){case"IMG":case"SPAN":case"P":case"BODY":case"HTML":case"A":case"B":case"I":case"PRE":case"CODE":case"CENTER":case"SMALL":case"SUB":case"SAMP":return!0;case"VIDEO":case"AUDIO":return!!C.gm_native_video_audio_contextmenu}if(0===(n.textContent||"").trim().length&&n.querySelector("video, audio"))return!1}return!0;case-1:return!1;case 0:case 1:return null===x&&(x=!1),!x&&67===e.keyCode&&(e.ctrlKey||e.metaKey)&&!e.altKey&&!e.shiftKey&&!0===C.isAnySelection();case 2:if(null===x&&(x=!1),x)return!1;if(!(n instanceof Node||n instanceof Window||n instanceof Document))return!1;if(n instanceof HTMLTextAreaElement||n instanceof HTMLInputElement)return!1;if(n instanceof HTMLElement&&n.closest("[contenteditable]"))return!1;if(n.parentNode instanceof HTMLElement&&n.parentNode.closest("[contenteditable]"))return!1;if(!("clipboardData"in e)||!("setData"in DataTransfer.prototype))return!0;if(!1===e.cancelable||!0===e.defaultPrevented)return!0;const t=E(e.clipboardData[C.ksSetData]);return t&&t!==e||(e.clipboardData[C.ksSetData]=k(e),C.clipDataProcess(e.clipboardData)),!0;default:return!0}},enableSelectClickCopy:function(){var e;e=DataTransfer.prototype.setData,DataTransfer.prototype.setData=function(t,n){return"text/plain"===t&&"string"==typeof n&&(n.trim().length>0?this[C.ksNonEmptyPlainText]=n:this[C.ksNonEmptyPlainText]&&(n=this[C.ksNonEmptyPlainText])),C.clipDataProcess(this),e.apply(this,arguments)},Object.defineProperties(DataTransfer.prototype,{[C.ksSetData]:{value:null,writable:!0,enumerable:!1,configurable:!0},[C.ksNonEmptyPlainText]:{value:null,writable:!0,enumerable:!1,configurable:!0}}),Event.prototype.preventDefault=function(e){function t(){!1===this.cancelable||C.shouldDenyPreventDefault(this)||e.call(this)}return t.toString=e.toString.bind(e),t}(Event.prototype.preventDefault),(()=>{const e=Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(Event.prototype,"returnValue"):{},{get:t,set:n}=e;if(t&&n){const e=new Set(C.eyEvts);Object.defineProperty(Event.prototype,"returnValue",{get(){const n=this.type;return e.has(n)?!(C.ksEventReturnValue in this)||this[C.ksEventReturnValue]:t.call(this)},set(t){const o=this.type;if(!e.has(o))return n.call(this,t);const r=!!t;!1===r&&this.preventDefault(),!1!==this[C.ksEventReturnValue]&&(this[C.ksEventReturnValue]=r)},enumerable:!0,configurable:!0})}else Object.defineProperty(Event.prototype,"returnValue",{get(){return!(C.ksEventReturnValue in this)||this[C.ksEventReturnValue]},set(e){!1===e&&this.preventDefault(),this[C.ksEventReturnValue]=e},enumerable:!0,configurable:!0})})(),C.enableReturnValueReplacment=!0;let t=l;if(t){let e=t.alert;if("function"==typeof e){let n=C.createFakeAlert(e);if(n){let e=0;n.__isDisabled__=()=>e>+new Date,C.mAlert_DOWN=()=>e=+new Date+50,C.mAlert_UP=()=>e=+new Date+20,t.alert=n}n=null}e=null}t=null},lpCheckPointer:function(e){return!!(e instanceof Element&&e.matches("*:hover")&&"pointer"===d(e).getPropertyValue("cursor")&&e.textContent)},eventCancel:function(e,t){C.bypass=!0,!t||e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),C.bypass=!1},lpHoverBlocks:[],lpKeyAltLastPressAt:0,lpKeyAltPressInterval:0,noPlayingVideo:function(){let e=!0;for(const t of document.querySelectorAll("video[src]"))if(!1===t.paused){e=!1;break}return e},lpKeyDown:e=>{if(C.gm_lp_enable)if("Alt"!==e.key||!e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)!0===C.lpKeyPressing&&C.lpCancelKeyPressAlt();else{C.lpKeyAltLastPressAt=+new Date;let t=e.target;if(!1===C.lpKeyPressing&&t instanceof Node&&t.parentNode&&!e.repeat&&C.noPlayingVideo()){C.lpKeyPressing=!0,document.documentElement.setAttribute(C.utAltPage,"");const e=C.rootHTML(t);if(e){let t=null,n=new WeakMap;C.lpKeyPressingPromise=C.lpKeyPressingPromise.then(()=>{for(const e of C.lpHoverBlocks)e.removeAttribute(C.utNonEmptyElmPrevElm),e.removeAttribute(C.utHoverTextWrap);C.lpHoverBlocks.length=0}).then(()=>{t=new WeakMap;const n=[...e.querySelectorAll("*:not(button, textarea, input, script, noscript, style, link, img, br)")].filter(e=>0===e.childElementCount&&(e.textContent||"").trim().length>0);for(const e of n)t.set(e,1);return n}).then(o=>{let r=[],s=[],a=e=>{if(null!==n.get(e))return;const t=[...e.children].some(e=>{const t=d(e).getPropertyValue("z-index")||"";return t.length>0&&C.isNum(+t)});n.set(e,t),t&&(C.lpHoverBlocks.push(e),e.setAttribute(C.utHoverTextWrap,""))};for(const l of o){let o=l,u=1;for(;;){let l=o.previousElementSibling,c=!1;for(;l&&!(t.get(l)>0);)!l.matches("button, textarea, input, script, noscript, style, link, img, br")&&0===(l.textContent||"").length&&l.clientWidth*l.clientHeight>0&&(r.push(l),c=!0),l=l.previousElementSibling;if(c&&!n.has(o.parentNode)&&(n.set(o.parentNode,null),s.push(i.resolve(o.parentNode).then(a))),o=o.parentNode,!o||o===e)break;if(u++,t.get(o)>0)break;t.set(o,u)}}t=null,i.all(s).then(()=>{s.length=0,s=null,a=null;for(const e of r){let t=e.parentNode;!0===n.get(t)&&(C.lpHoverBlocks.push(e),e.setAttribute(C.utNonEmptyElmPrevElm,""))}r.length=0,r=null,n=null})})}}}},lpCancelKeyPressAlt:()=>{C.lpKeyPressing=!1,document.documentElement.removeAttribute(C.utAltPage),C.lpKeyPressingPromise=C.lpKeyPressingPromise.then(()=>{for(const e of C.lpHoverBlocks)e.removeAttribute(C.utNonEmptyElmPrevElm),e.removeAttribute(C.utHoverTextWrap);C.lpHoverBlocks.length=0}),setTimeout(function(){1===C.lpMouseActive&&(C.lpMouseUpClear(),C.lpMouseActive=0)},32)},lpKeyUp:()=>{C.gm_lp_enable&&!0===C.lpKeyPressing&&C.lpCancelKeyPressAlt()},lpAltRoots:[],lpMouseDown:e=>{if(C.gm_lp_enable&&(C.lpMouseActive=0,e.altKey&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey&&0===e.button&&e.target instanceof Node&&C.noPlayingVideo())){C.lpMouseActive=1,C.eventCancel(e,!1);const t=C.rootHTML(e.target);C.lpAltRoots.push(t),t.setAttribute(C.utLpSelection,"")}},lpMouseUpClear:function(){for(const e of C.lpAltRoots)e.removeAttribute(C.utLpSelection);C.lpAltRoots.length=0,"function"==typeof C.onceCssHighlightSelection&&w.gm_highlight_color_check&&c(C.onceCssHighlightSelection)},lpMouseUp:e=>{C.gm_lp_enable&&1===C.lpMouseActive&&(C.lpMouseActive=2,C.eventCancel(e,!1),C.lpMouseUpClear())},lpClick:e=>{C.gm_lp_enable&&2===C.lpMouseActive&&C.eventCancel(e,!1)},lpEnable:function(){const e=C.eh_capture_passive();document.addEventListener("keydown",C.lpKeyDown,e),document.addEventListener("keyup",C.lpKeyUp,e),document.addEventListener("mousedown",C.lpMouseDown,e),document.addEventListener("mouseup",C.lpMouseUp,e),document.addEventListener("click",C.lpClick,e)},rootHTML:e=>{if(!(e instanceof Node))return null;if(!e.ownerDocument)return e;let t=e.getRootNode?e.getRootNode():null;if(!t){let n=e;for(let e;e=n.parentNode;)n=e;t=n}return t=t.querySelector("html")||e.ownerDocument.documentElement||null,t},customCSSPerSite:{"https://www.suto.co.kr":"\n                #no_copy::after {\n                    pointer-events: none;\n                }\n            "},injectCSSRules:()=>{const e=`\n\n            html {\n                --sac-user-select: auto;\n            }\n            [role="slider"], input, textarea, video[src], :empty {\n                --sac-user-select: nil;\n            }\n            label:not(:empty) {\n                --sac-user-select: auto;\n            }\n\n            html, html *,\n            html *[style], html *[class] {\n                -webkit-touch-callout: default !important; -moz-user-select: var(--sac-user-select) !important; -webkit-user-select: var(--sac-user-select) !important; user-select: var(--sac-user-select) !important;\n            }\n\n            html *:hover, html *:link, html *:visited, html *:active {\n                -webkit-touch-callout: default !important; -moz-user-select: var(--sac-user-select) !important; -webkit-user-select: var(--sac-user-select) !important; user-select: var(--sac-user-select) !important;\n            }\n\n            html *::before, html *::after {\n                -webkit-touch-callout: default !important; -moz-user-select: auto !important; -webkit-user-select: auto !important; user-select: auto !important;\n            }\n\n            *:hover>img[src]{pointer-events:auto !important;}\n\n            [${C.utSelectionColorHack}] :not(input):not(textarea)::selection{ background-color: Highlight !important; color: HighlightText !important;}\n            [${C.utSelectionColorHack}] :not(input):not(textarea)::-moz-selection{ background-color: Highlight !important; color: HighlightText !important;}\n            [${C.utTapHighlight}] *{ -webkit-tap-highlight-color: rgba(0, 0, 0, 0.18) !important;}\n\n            [${C.utHoverTextWrap}]>[${C.utNonEmptyElmPrevElm}]{pointer-events:none !important;}\n            [${C.utHoverTextWrap}]>*{z-index:inherit !important;}\n\n            html[${C.utLpSelection}] *:hover, html[${C.utLpSelection}] *:hover * { cursor:text !important;}\n            html[${C.utLpSelection}] :not(input):not(textarea)::selection {background-color: rgba(255, 156, 179, 0.5) !important;}\n            html[${C.utLpSelection}] :not(input):not(textarea)::-moz-selection {background-color: rgba(255, 156, 179, 0.5) !important;}\n\n            img[${C.utHoverBlock}="4"]{display:none !important;}\n            [${C.utHoverBlock}="7"]{padding:0 !important;overflow:hidden !important;}\n            [${C.utHoverBlock}="7"]>img[${C.utHoverBlock}="4"]:first-child{\n                display:inline-block !important;\n                position: relative !important;\n                top: auto !important;\n                left: auto !important;\n                bottom: auto !important;\n                right: auto !important;\n                opacity: 0 !important;\n                padding: 0 !important;\n                margin: 0 !important;\n                width: 100% !important;\n                height: 100% !important;\n                outline: 0 !important;\n                border: 0 !important;\n                box-sizing: border-box !important;\n                transform: initial !important;\n                -moz-user-select: none !important;\n                -webkit-user-select: none !important;\n                user-select: none !important;\n                z-index:1 !important;\n                float: left !important;\n                cursor:inherit !important;\n                pointer-events:inherit !important;\n                border-radius: inherit !important;\n                background:none !important;\n            }\n\n            html[${C.utAltPage}] *::before, html[${C.utAltPage}] *::after {\n                pointer-events: none !important;\n            }\n\n            ${C.customCSSPerSite[location.origin]||""}\n\n            `.trim();C.createCSSElement(e,document.documentElement)},overrideComputedStyle:()=>{if("function"!=typeof l.getComputedStyle||"function"==typeof l.getComputedStyle591)return;const e=l.getComputedStyle591=l.getComputedStyle;l.getComputedStyle=function(t,n){return(this||0).getComputedStyle591?this.getComputedStyle591(t,n):e.call(l,t,n)};const t="function"==typeof l.CSSStyleDeclaration?l.CSSStyleDeclaration.prototype:null;t&&"function"==typeof t.getPropertyValue&&"function"!=typeof t.getPropertyValue591&&(t.getPropertyValue591=t.getPropertyValue,t.getPropertyValue=function(e){let t=this.getPropertyValue591(e);return"userSelect"!==e||"auto"!==t&&""!==t||(t="none"),t}),t&&Object.defineProperty(t,"userSelect",{get:()=>"none"})},disableHoverBlock:()=>{function e(e){let t=o.get(e);return t||o.set(e,t={}),t}function t(e,t){let n={x:e.left,y:e.top},o={x:e.right,y:e.bottom},r={x:t.left,y:t.top},s={x:t.right,y:t.bottom},a=Math.abs(n.x-o.x)*Math.abs(n.y-o.y),l=Math.abs(r.x-s.x)*Math.abs(r.y-s.y),i=Math.min(o.x,s.x)-Math.max(n.x,r.x),u=Math.min(o.y,s.y)-Math.max(n.y,r.y),c=0;return i>0&&u>0&&(c=i*u),{area1:a,area2:l,areaI:c}}function n(){for(const e of s)if(e.lastTime+800<+new Date)return e.lastTime=+new Date,e.elm;let e=document.createElement("img");e.setAttribute("title","　"),e.setAttribute("alt","　"),e.onerror=function(){this.parentNode instanceof Node&&this.parentNode.removeChild(this)},e.setAttribute(C.utHoverBlock,"4");const t=function(e){this===e.target&&(2!==e.button&&function(e,t){t.dispatchEvent(new e.constructor(e.type,e)),"wheel"!==e.type&&e.preventDefault(),e.stopPropagation()}(e,this.parentNode),(async e=>{await i.resolve();for(const t of s)t.elm===e&&(t.lastTime=+new Date)})(this))};e.addEventListener("click",t,!0),e.addEventListener("mousedown",t,!0),e.addEventListener("mouseup",t,!0),e.addEventListener("mousemove",t,!0),e.addEventListener("mouseover",t,!0),e.addEventListener("mouseout",t,!0),e.addEventListener("mouseenter",t,!0),e.addEventListener("mouseleave",t,!0);let n={elm:e,lastTime:+new Date,cid_fade:0};return s.push(n),e}const o=new WeakMap,r=new WeakMap;let s=[];const a=new WeakMap;let l=null,u=0,c=0;document.addEventListener("mouseenter",async o=>{if(!C.gm_disablehover_enable)return;if(l=o.target,u=+new Date,c)return;c=1;do{await new i(e=>setTimeout(e,82))}while(+new Date-u<30);c=0;const s=l;if(await i.resolve(),!s||!s.parentNode)return;if(r.get(s)){let e=null;if("7"===s.getAttribute(C.utHoverBlock)&&(e=a.get(s))&&null===s.querySelector(`[${C.utHoverBlock}]`)){let t=n();t.parentNode!==s&&(t.setAttribute("src",e),s.insertBefore(t,s.firstChild))}return}if(r.set(s,1),await i.resolve(),!(s instanceof Element))return;if("|SVG|IMG|HTML|BODY|VIDEO|AUDIO|BR|HEAD|NOSCRIPT|SCRIPT|STYLE|TEXTAREA|AREA|INPUT|FORM|BUTTON|".indexOf(`|${s.nodeName}|`)>=0)return;const p=s.clientWidth*s.clientHeight;if(!(p>0))return;let m=null;const g=d(s),h=g.getPropertyValue("background-image")||"";let f=null;if(h.length>8&&(f=/^\s*url\s*\("?([^"\)]+\b(\.gif|\.png|\.jpeg|\.jpg|\.webp)\b[^"\)]*)"?\)\s*$/i.exec(h))){if((s.textContent||"").trim().length>0)return;m=f[1]}else{if(!("absolute"===g.getPropertyValue("position")&&+g.getPropertyValue("z-index")>0))return;if((s.textContent||"").trim().length>0)return;let n=[];for(const t of document.querySelectorAll("img[src]")){const o=e(t);if(!o.area){const e=t.clientWidth*t.clientHeight;e>0&&(o.area=e)}o.area>0&&p>.9*o.area&&n.push(t)}let o=0,r=0;for(const e of n){const t=s.compareDocumentPosition(e);if(8&t||16&t)return;if(2&t)r++;else if(4&t)break;o++}let a=r-1,l=r;a<0&&(a=0),l>n.length-1&&(l=n.length-1);for(let e=a;e<=l;e++){const o=n[e],{area1:r,area2:a,areaI:l}=t(s.getBoundingClientRect(),o.getBoundingClientRect());if(l>.9*a){m=o.getAttribute("src");break}}}if("string"!=typeof m)return;let y=n();y.parentNode!==s&&(y.setAttribute("src",m),s.insertBefore(y,s.firstChild),a.set(s,m),s.setAttribute(C.utHoverBlock,"7"))},C.eh_capture_passive())},acrAuxDown:e=>{if(C.gm_prevent_aux_click_enable&&1===e.button){let t=C.dmmMouseUpLast>C.dmmMouseDownLast&&e.timeStamp-C.dmmMouseUpLast<40;C.dmmMouseDownLast=e.timeStamp,t&&C.eventCancel(e,!0)}},acrAuxUp:e=>{if(C.gm_prevent_aux_click_enable&&1===e.button){let t=C.dmmMouseDownLast>C.dmmMouseUpLast&&e.timeStamp-C.dmmMouseDownLast<40;C.dmmMouseUpLast=e.timeStamp,t&&(C.dmmMouseUpCancel=e.timeStamp,C.eventCancel(e,!0))}},acrAuxClick:e=>{C.gm_prevent_aux_click_enable&&1===e.button&&e.timeStamp-C.dmmMouseUpCancel<40&&C.eventCancel(e,!0)},mousedownFocus:()=>{_=Date.now()+4},mouseupFocus:()=>{_=0},MenuEnable:class{constructor(e,t,n,o){this.h=null,this.textToEnable=e,this.textToDisable=t,this.callback=n,this.gx=this.gx.bind(this)}unregister(){null!==this.h&&(GM_unregisterMenuCommand(this.h),this.h=null)}register(e){"string"==typeof e&&(this.showText=e),"string"==typeof(e=this.showText)&&(this.h=GM_registerMenuCommand(e,this.gx))}a(e){if(this.enabled===e.bEnable)return;this.enabled=e.bEnable,this.unregister();let t=0;if(C.gm_status_fn_store&&C.gm_status_fn_store.indexOf(this)>=0){let n=C.gm_status_fn_store,o=n.indexOf(this),r=n.length;if(o>=0&&o<=r-2){for(let e=o+1;e<r;e++)n[e].unregister();this.register(e.bText);for(let e=o+1;e<r;e++)n[e].register();t=1}}t||this.register(e.bText),this.callback(this.enabled,e.byUserInput)}enableNow(e){this.a({bEnable:!0,bText:this.textToDisable,byUserInput:e})}gx(){this.enabled?this.disableNow(!0):this.enableNow(!0)}disableNow(e){this.a({bEnable:!1,bText:this.textToEnable,byUserInput:e})}toggle(e,t){e?this.enableNow(t):this.disableNow(t)}},gm_status_fn:async function(e,t,n,o){function r(t){C[e]=t;const n=C[s];n&&n.toggle(t),o(t)}const s=e+"$menuEnable";if(r(!!await GM.getValue(e,!1)),GM_addValueChangeListener(e,function(t,n,o){n!==o&&o!==C[e]&&r(o)}),!function(){try{return window.self!==window.top}catch(e){return!0}}()){C.gm_status_fn_store=C.gm_status_fn_store||[],C[s]=new C.MenuEnable(t,n,t=>{GM.setValue(e,!!t)}),C.gm_status_fn_store.push(C[s]);const o=await GM.getValue(e,!1);C[s].toggle(!!o)}},copyRangeCheckKeyDown(e){if(!e.isTrusted||"Control"!==e.key&&"Meta"!==e.key)e.isTrusted&&("KeyC"===e.code&&!0===C.rangeOnKeyDown||"Copy"===e.key)&&(C.rangeOnKeyDown=r());else{if(!(u()+""))return void(C.rangeOnKeyDown=!1);C.rangeOnKeyDown=!0}},copyRangeCheckKeyUp(e){!e.isTrusted||"Control"!==e.key&&"Meta"!==e.key||(C.rangeOnKeyDown=!1)},genericEventHandlerLevel2:e=>{C.gm_absolute_mode&&(e.stopPropagation(),e.stopImmediatePropagation());const t=(e||0).type;if("keydown"===t?C.copyRangeCheckKeyDown(e):"keyup"===t&&C.copyRangeCheckKeyUp(e),t&&!0===C.enableReturnValueReplacment){let n=e.target;const o="on"+t;let r=99;for(;n instanceof Node&&!(--r<4);){const e=n[o];if("function"==typeof e){if(e[C.ksFuncReplacerCounter]>0)break;n[o]=C.weakMapFuncReplaced.get(e)||C.createFuncReplacer(e)}n=n.parentNode}}"contextmenu"===t&&!0!==e.defaultPrevented&&C.mainListenerPress(e)},genericEventHandlerLevel1:e=>{C.gm_absolute_mode&&(e.stopPropagation(),e.stopImmediatePropagation());const t=(e||0).type;"mousedown"===t?(C.mousedownFocus(e),C.acrAuxDown(e),!0!==e.defaultPrevented&&C.mainListenerPress(e)):"mouseup"===t&&(C.mouseupFocus(e),C.acrAuxUp(e),!0!==e.defaultPrevented&&C.mainListenerRelease(e))},eventsInjection:function(){for(const e of["keydown","keyup","copy","contextmenu","select","selectstart","dragstart","beforecopy"])document.addEventListener(e,C.genericEventHandlerLevel2,!0);for(const e of["cut","paste","mouseup","mousedown","drag","select"])document.addEventListener(e,C.genericEventHandlerLevel1,!0);document.addEventListener("auxclick",C.acrAuxClick,!0)},delayMouseUpTasksHandler:()=>{if(C.delayMouseUpTasks>0){const e=C.delayMouseUpTasks;C.delayMouseUpTasks=0,1&~e||C.mAlert_UP(),2&~e||!0!==C.enableDragging||(C.enableDragging=!1)}},mainListenerPress:e=>{C.onceCssHighlightSelection&&c(C.onceCssHighlightSelection);const t="contextmenu"===e.type;(2===e.button||t)&&C.mAlert_DOWN(),t&&0===C.delayMouseUpTasks&&(C.delayMouseUpTasks|=1,c(C.delayMouseUpTasksHandler))},mainListenerRelease:e=>{0===C.delayMouseUpTasks&&(2===e.button&&(C.delayMouseUpTasks|=1),!0===C.enableDragging&&(C.delayMouseUpTasks|=2),C.delayMouseUpTasks>0&&c(C.delayMouseUpTasksHandler))}};if(C.eventsInjection(),C.enableSelectClickCopy(),C.injectCSSRules(),"novelpia.com"===location.host&&C.overrideComputedStyle(),n()&&C.lpEnable(),C.disableHoverBlock(),a.log(`userscript running - ${f}`),C.updateIsWindowEventSupported(),"function"==typeof GM_registerMenuCommand&&"function"==typeof GM_unregisterMenuCommand&&(n()&&C.gm_status_fn("gm_lp_enable","To Enable `Enhanced build-in Alt Text Selection`","To Disable `Enhanced build-in Alt Text Selection`",()=>{}),C.gm_status_fn("gm_disablehover_enable","To Enable `Hover on Image`","To Disable `Hover on Image`",()=>{}),C.gm_status_fn("gm_prevent_aux_click_enable","To Enable `Repetitive AuxClick Prevention`","To Disable `Repetitive AuxClick Prevention`",()=>{}),C.gm_status_fn("gm_absolute_mode","To Enable `Absolute Mode`","To Disable `Absolute Mode`",()=>{}),C.gm_status_fn("gm_remain_focus_on_mousedown","To Enable `Remain Focus On MouseDown`","To Disable `Remain Focus On MouseDown`",()=>{}),C.gm_status_fn("gm_native_video_audio_contextmenu","To Enable Native Video Audio Context Menu","To Disable Native Video Audio Context Menu",()=>{})),"function"==typeof g&&HTMLElement.prototype.focus===g&&0===g.length){const e=HTMLElement.prototype.focus=function(){if(!(_&&w.gm_remain_focus_on_mousedown&&_>Date.now()))return g.apply(this,arguments)};e.toString=g.toString.bind(g)}}({console:console});