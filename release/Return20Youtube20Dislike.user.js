// ==UserScript==
// @name         Return YouTube Dislike
// @namespace    https://www.returnyoutubedislike.com/
// @homepage     https://www.returnyoutubedislike.com/
// @version      3.1.5
// @encoding     utf-8
// @icon         https://github.com/Anarios/return-youtube-dislike/raw/main/Icons/Return%20Youtube%20Dislike%20-%20Transparent.png
// @author       Anarios & JRWR
// @match        *://*.youtube.com/*
// @exclude      *://music.youtube.com/*
// @exclude      *://*.music.youtube.com/*
// @compatible   chrome
// @compatible   firefox
// @compatible   opera
// @compatible   safari
// @compatible   edge
// @downloadURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/Return20Youtube20Dislike.user.js
// @updateURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/Return20Youtube20Dislike.meta.js
// @grant        GM.xmlHttpRequest
// @connect      youtube.com
// @grant        GM_addStyle
// @run-at       document-end
// ==/UserScript==
function e(e,t=""){v||(t=""===t.trim()?"":`(${t})`,console.log(`[Return YouTube Dislikes] ${e} ${t}`))}function t(e){const t=e.getBoundingClientRect(),n=innerHeight||document.documentElement.clientHeight,r=innerWidth||document.documentElement.clientWidth;return!(0==t.top&&0==t.left&&0==t.bottom&&0==t.right)&&t.top>=0&&t.left>=0&&t.bottom<=n&&t.right<=r}function n(){if(N()){let e=document.querySelectorAll(A?"ytm-like-button-renderer":"#like-button > ytd-like-button-renderer");for(let n of e)if(t(n))return n}return A?document.querySelector(".slim-video-action-bar-actions .segmented-buttons")??document.querySelector(".slim-video-action-bar-actions"):null===document.getElementById("menu-container")?.offsetParent?document.querySelector("ytd-menu-renderer.ytd-watch-metadata > div")??document.querySelector("ytd-menu-renderer.ytd-video-primary-info-renderer > div"):document.getElementById("menu-container")?.querySelector("#top-level-buttons-computed")}function r(){if("YTD-SEGMENTED-LIKE-DISLIKE-BUTTON-RENDERER"===n().children[0].tagName)return void 0===n().children[0].children[1]?document.querySelector("#segmented-dislike-button"):n().children[0].children[1];if(n().querySelector("segmented-like-dislike-button-view-model")){const t=n().querySelector("dislike-button-view-model");return t||e("Dislike button wasn't added to DOM yet..."),t}return n().children[1]}function o(){return"YTD-SEGMENTED-LIKE-DISLIKE-BUTTON-RENDERER"===n().children[0].tagName?null!==document.querySelector("#segmented-like-button")?document.querySelector("#segmented-like-button"):n().children[0].children[0]:n().querySelector("like-button-view-model")??n().children[0]}function i(){const e=r();let t=e?.querySelector("#text")??e?.getElementsByTagName("yt-formatted-string")[0]??e?.querySelector("span[role='text']");if(null===t){let n=document.createElement("span");n.id="text",n.style.marginLeft="6px",e?.querySelector("button").appendChild(n),e&&(e.querySelector("button").style.width="auto"),t=n}return t}function l(e,t){const n=new Object;return n.options=e,n.observer=new MutationObserver(t),n.observe=function(e){this.observer.observe(e,this.options)},n.disconnect=function(){this.observer.disconnect()},n}function a(){if(!A)return!!document.querySelector("#avatar-btn")}function c(e){A?n().children[0].querySelector(".button-renderer-text").innerText=e:(o().querySelector("#text")??o().getElementsByTagName("yt-formatted-string")[0]??o().querySelector("span[role='text']")).innerText=e}function u(e){if(A)return void(R=e);const t=i();t?.removeAttribute("is-empty"),t?.innerText!==e&&(t.innerText=e)}function s(){try{if(N())return!1;let e=(o().querySelector("yt-formatted-string#text")??o().querySelector("button")).getAttribute("aria-label").replace(/\D/g,"");return e.length>0&&parseInt(e)}catch{return!1}}function d(e,t){var i,l;if(A||!I)return;let a=document.getElementById("return-youtube-dislike-bar-container");const c=o().clientWidth+(r()?.clientWidth??52),u=e+t>0?e/(e+t)*100:50,s=(100-(i=parseFloat(u.toFixed(1)))).toLocaleString();switch(i=i.toLocaleString(),w){case"dash_like":l=`${e.toLocaleString()}&nbsp;/&nbsp;${t.toLocaleString()}&nbsp;&nbsp;-&nbsp;&nbsp;${i}%`;break;case"dash_dislike":l=`${e.toLocaleString()}&nbsp;/&nbsp;${t.toLocaleString()}&nbsp;&nbsp;-&nbsp;&nbsp;${s}%`;break;case"both":l=`${i}%&nbsp;/&nbsp;${s}%`;break;case"only_like":l=`${i}%`;break;case"only_dislike":l=`${s}%`;break;default:l=`${e.toLocaleString()}&nbsp;/&nbsp;${t.toLocaleString()}`}if(a||A)document.querySelector(".ryd-tooltip").style.width=c+"px",document.getElementById("return-youtube-dislike-bar").style.width=u+"%",k&&(document.getElementById("return-youtube-dislike-bar-container").style.backgroundColor=f(!1),document.getElementById("return-youtube-dislike-bar").style.backgroundColor=f(!0));else{let e="",t="";k&&(e="; background-color: "+f(!0),t="; background-color: "+f(!1)),n().insertAdjacentHTML("beforeend",`\n        <div class="ryd-tooltip" style="width: ${c}px">\n        <div class="ryd-tooltip-bar-container">\n           <div\n              id="return-youtube-dislike-bar-container"\n              style="width: 100%; height: 2px;${t}"\n              >\n              <div\n                 id="return-youtube-dislike-bar"\n                 style="width: ${u}%; height: 100%${t}"\n                 ></div>\n           </div>\n        </div>\n        <tp-yt-paper-tooltip position="top" id="ryd-dislike-tooltip" class="style-scope ytd-sentiment-bar-renderer" role="tooltip" tabindex="-1">\n           \x3c!--css-build:shady--\x3e${l}\n        </tp-yt-paper-tooltip>\n        </div>\n`);let r=document.getElementById("top-row");r.style.borderBottom="1px solid var(--yt-spec-10-percent-layer)",r.style.paddingBottom="10px"}}function b(){u(h(B)),d(T,B)}function y(){if(1==a()&&(1==$?(T--,b(),$=3):2==$?(T++,B--,b(),$=1):3==$&&(T++,b(),$=1),!0===L)){const e=s();!1!==e&&c(h(e))}}function m(){if(1==a())if(3==$)B++,b(),$=2;else if(2==$)B--,b(),$=3;else if(1==$&&(T--,B++,b(),$=2,!0===L)){const e=s();!1!==e&&c(h(e))}}function p(){const e=new URL(window.location.href),t=e.pathname;return t.startsWith("/clip")?(document.querySelector("meta[itemprop='videoId']")||document.querySelector("meta[itemprop='identifier']")).content:t.startsWith("/shorts")?t.slice(8):e.searchParams.get("v")}function h(t){let n;return n=!1===q?t:function(e){if(e<1e3)return e;const t=Math.floor(Math.log10(e)-2),n=t+(t%3?1:0);return Math.floor(e/10**n)*10**n}(t),function(t){let n,r,o;if(document.documentElement.lang)n=document.documentElement.lang;else if(navigator.language)n=navigator.language;else try{n=new URL(Array.from(document.querySelectorAll("head > link[rel='search']"))?.find(e=>e?.getAttribute("href")?.includes("?locale="))?.getAttribute("href"))?.searchParams?.get("locale")}catch{e("Cannot find browser locale. Use en as default for number formatting."),n="en"}switch(t){case"compactLong":r="compact",o="long";break;case"standard":r="standard",o="short";break;default:r="compact",o="short"}return Intl.NumberFormat(n,{notation:r,compactDisplay:o})}(x).format(n)}function f(e){let t;switch(E){case"accessible":t=!0===e?"dodgerblue":"gold";break;case"neon":t=!0===e?"aqua":"magenta";break;default:t=!0===e?"lime":"red"}return t}function g(){let t;e("Setting up..."),t=setInterval(function(){if(N()||n()?.offsetParent&&function(){if(A)return"false"==document.getElementById("player").getAttribute("loading");const e=p();return null!==document.querySelector(`ytd-watch-grid[video-id='${e}']`)||null!==document.querySelector(`ytd-watch-flexy[video-id='${e}']`)||null!==document.querySelector('#player[loading="false"]:not([hidden])')}()){const i=n(),a=r();if(D!==o()&&a){e("Registering button listeners...");try{o().addEventListener("click",y),a?.addEventListener("click",m),o().addEventListener("touchstart",y),a?.addEventListener("touchstart",m),a?.addEventListener("focusin",b),a?.addEventListener("focusout",b),D=o(),P||(P=l({attributes:!0,subtree:!0,childList:!0},b),P.container=null);const t=i.querySelector("yt-smartimation");t&&P.container!=t&&(e("Initializing smartimation mutation observer"),P.disconnect(),P.observe(t),P.container=t)}catch{return}}a&&(e("Fetching votes..."),fetch(`https://returnyoutubedislikeapi.com/votes?videoId=${p()}`).then(t=>{t.json().then(n=>{if(n&&!("traceId"in t)){const{dislikes:t,likes:i}=n;if(e(`Received count: ${t}`),T=i,B=t,u(h(t)),!0===L){const e=s();!1!==e&&c(h(e))}if(d(i,t),!0===S){const e=r();if(N()){const t=o().querySelector("tp-yt-paper-button#button"),n=e?.querySelector("tp-yt-paper-button#button");"true"===t.getAttribute("aria-pressed")&&(t.style.color=f(!0)),n&&"true"===n.getAttribute("aria-pressed")&&(n.style.color=f(!1)),M.observe(t),M.observe(n)}else o().style.color=f(!0),e&&(e.style.color=f(!1))}}})}),clearInterval(t))}},111)}const v=!0,S=!1,k=!1,E="classic",x="compactShort",q=!0,w="none",L=!1,I=!1;let $=3,T=0,B=0,D=null,A="m.youtube.com"==location.hostname,N=()=>location.pathname.startsWith("/shorts"),R=0,M=null;N()&&!M&&(e("Initializing shorts mutation observer"),M=l({attributes:!0},t=>{t.forEach(t=>{if("attributes"===t.type&&"TP-YT-PAPER-BUTTON"===t.target.nodeName&&"button"===t.target.id)return e("Short thumb button status changed"),void("true"===t.target.getAttribute("aria-pressed")?t.target.style.color="like-button"===t.target.parentElement.parentElement.id?f(!0):f(!1):t.target.style.color="unset");e("Unexpected mutation observer event: "+t.target+t.type)})})),("undefined"!=typeof GM_addStyle?GM_addStyle:e=>{let t=document.createElement("style");t.type="text/css",t.innerText=e,document.head.appendChild(t)})("\n    #return-youtube-dislike-bar-container {\n      background: var(--yt-spec-icon-disabled);\n      border-radius: 2px;\n    }\n\n    #return-youtube-dislike-bar {\n      background: var(--yt-spec-text-primary);\n      border-radius: 2px;\n      transition: all 0.15s ease-in-out;\n    }\n\n    .ryd-tooltip {\n      position: absolute;\n      display: block;\n      height: 2px;\n      bottom: -10px;\n    }\n\n    .ryd-tooltip-bar-container {\n      width: 100%;\n      height: 2px;\n      position: absolute;\n      padding-top: 6px;\n      padding-bottom: 12px;\n      top: -6px;\n    }\n\n    ytd-menu-renderer.ytd-watch-metadata {\n      overflow-y: visible !important;\n    }\n    \n    #top-level-buttons-computed {\n      position: relative !important;\n    }\n  ");let P=null;if(function(){"use strict";window.addEventListener("yt-navigate-finish",g,!0),g()}(),A){let e=history.pushState;history.pushState=function(...t){return window.returnDislikeButtonlistenersSet=!1,g(t[2]),e.apply(history,t)},setInterval(()=>{const e=r();null===e?.querySelector(".button-renderer-text")?i().innerText=R:e&&(e.querySelector(".button-renderer-text").innerText=R)},1e3)}