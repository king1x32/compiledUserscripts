// ==UserScript==
// @name         Image Downloader
// @namespace       http://tampermonkey.net/
// @version         2.90
// @author          桃源隐叟-The hide oldman in taoyuan mountain
// @connect  *
// @connect  *://*/*
// @grant   GM_openInTab
// @grant   GM_registerMenuCommand
// @grant   GM_setValue
// @grant   GM_getValue
// @grant   GM_deleteValue
// @grant   GM_xmlhttpRequest
// @grant   GM_download
// @require https://unpkg.com/hotkeys-js@3.9.4/dist/hotkeys.min.js
// @require https://cdn.bootcdn.net/ajax/libs/jszip/3.7.1/jszip.min.js
// @require https://cdn.bootcdn.net/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js
// @run-at  document-end
// @match   *://*/*
// @include *
// @match   https://www.bilibili.com/
// @match   https://588ku.com/
// @homepageURL https://github.com/taoyuancun123/modifyText/blob/master/modifyText.js
// @supportURL  https://greasyfork.org/zh-CN/scripts/419894/feedback
// @run-at      document-start
// @license GPLv3
// @downloadURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/Image20Downloader.user.js
// @updateURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/Image20Downloader.meta.js
// ==/UserScript==
(function(){"use strict";function e(){Object.defineProperty(HTMLImageElement.prototype,"src",{get:function(){return d.get.call(this)},set:function(e){a.includes(e)||a.push(e),d.set.call(this,e)}})}function t(){if(null!=document.querySelector(".tyc-image-container"))try{document.querySelector(".tyc-image-container").remove()}catch{}else n()}function n(){function e(){k=y,k=u.getBigImageArray(k),null!=GM_getValue("width-check")&&(document.querySelector(".width-check").checked=GM_getValue("width-check")),null!=GM_getValue("height-check")&&(document.querySelector(".height-check").checked=GM_getValue("height-check")),null!=GM_getValue("extra-grab-check")&&(document.querySelector(".extra-grab-check").checked=GM_getValue("extra-grab-check")),GM_getValue("width-value-min")&&(document.querySelector(".width-value-min").value=GM_getValue("width-value-min")),GM_getValue("width-value-max")&&(document.querySelector(".width-value-max").value=GM_getValue("width-value-max")),GM_getValue("height-value-min")&&(document.querySelector(".height-value-min").value=GM_getValue("height-value-min")),GM_getValue("height-value-max")&&(document.querySelector(".height-value-max").value=GM_getValue("height-value-max")),GM_getValue("shortCutString")&&(document.querySelector(".shortCutString").value=GM_getValue("shortCutString")),document.querySelector(".width-check").checked&&(k=k.filter(h)),document.querySelector(".height-check").checked&&(k=k.filter(p)),(R=k).forEach((e,t)=>{if(!e.includes("data:image"))try{let n=window.location.origin+"/";GM_xmlhttpRequest({method:"get",url:e,headers:{referer:n},responseType:"blob",onload:function(e){var n=e.response;let l=new FileReader;l.onloadend=function(e){let n=e.target.result;n.startsWith("data:image")&&(R[t]=n)},l.readAsDataURL(n)}})}catch(e){}}),k.forEach((e,t)=>{window.location.href.includes("huaban.com")&&e.includes("/webp")&&(e=e.replace(/\/webp/g,"/png"));let n=`<div class="tyc-img-item-container-${t}" style="text-align:center;font-size:0px;\n    margin:5px;border:1px solid #99d;border-radius:3px;\n    ">\n    <img class="tyc-image-preview" src="${e}"/ style="width:auto;height:200px;" data-value="${t}"></div>`;document.querySelector(".tyc-image-wrapper").insertAdjacentHTML("beforeend",n);let l=document.querySelector(`.tyc-img-item-container-${t} .tyc-image-preview`).naturalWidth,a=document.querySelector(`.tyc-img-item-container-${t} .tyc-image-preview`).naturalHeight,i=document.querySelector(`.tyc-img-item-container-${t}`),c=(i.getBoundingClientRect().width,`\n            <span style="font-size:16px;position:absolute;left:calc(50% - 80px);top:7px;">${l}X${a}</span>\n            `),o=`\n    <span style="position:absolute;right:calc(50% - 30px);top:2px;border:1px solid #333;\n    width:26px;height:26px;border-radius:20px;" class="fullscreen-image" data-value="${t}">\n    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrows-fullscreen" viewBox="0 0 16 16"  style="position:absolute;top:4px;right:4px;width:18px;height:18px;" data-value="${t}">\n        <path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707zm0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707zm-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707z"/>\n    </svg>\n    </span>\n    <span style="position:absolute;right:calc(50% - 60px);top:2px;border:1px solid #333;\n    width:26px;height:26px;border-radius:20px;\n    " class="download-direct">\n    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16" style="position:absolute;top:5px;right:5px;">\n      <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>\n      <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>\n    </svg>\n    </span>\n\n    `;i.insertAdjacentHTML("beforeend",'\n            <div class="tyc-image-info-container" style="font-size:0px;background-color:rgba(100,100,100,0.6);height:30px;position:relative;">\n\n\n    </div>\n            ');let r=i.querySelector("div"),s=parseInt(i.getBoundingClientRect().width);s>120?(r.insertAdjacentHTML("beforeend",c),r.insertAdjacentHTML("beforeend",o)):s<=120&&s>=50?(r.insertAdjacentHTML("beforeend",o),r.getElementsByClassName("fullscreen-image")[0].style.right="50%",r.getElementsByClassName("download-direct")[0].style.right="calc(50% - 30px)"):r.insertAdjacentHTML("beforeend",'\n            <span style="position:absolute;right:calc(50% - 15px);top:2px;border:1px solid #333;\n    width:26px;height:26px;border-radius:20px;\n    " class="download-direct">\n    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16" style="position:absolute;top:5px;right:5px;">\n      <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>\n      <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>\n    </svg>\n    </span>\n            ')})}function t(){b=[],x=[],document.querySelector(".num-tip").innerText=`${l.fetchDoneTip1Type2}${x.length}/${y.length}${l.fetchDoneTip2}`,document.querySelector(".tyc-image-wrapper").innerHTML=""}function r(e){return"download-direct"==e.className}function s(e){return"fullscreen-image"==e.className}function d(e,t){let n=[];return t.forEach(t=>{n.push(e[t])}),n}function h(e){let t=new Image;if(t.src=e,t.width>=parseInt(document.querySelector(".width-value-min").value)&&t.width<=parseInt(document.querySelector(".width-value-max").value))return e}function p(e){let t=new Image;if(t.src=e,t.height>=parseInt(document.querySelector(".height-value-min").value)&&t.height<=parseInt(document.querySelector(".height-value-max").value))return e}function g(e){let t=[];return e.forEach(e=>{e.startsWith("data:image")&&e.includes("base64")&&t.push(e)}),t}var m,y,f,x,w,b,v,k,R,S,C,q;c=i[i.length-2],m=(new Date).getTime().toString(),c+=m.substring(7,m.length);try{document.querySelector(".tyc-image-container").remove()}catch{}y=[],f=document.body.innerHTML,x=[],w=[],b=[],v=[],k=[],R=[];try{S=new JSZip,C=S.folder("pics")}catch{}try{let $=document.getElementsByTagName("img"),T=document.getElementsByTagName("canvas");for(let _=0;_<$.length;_++)if(y.includes($[_].src)||y.push($[_].src),""!==$[_].srcset){let G=$[_].srcset.split(","),V=G[0].match(/\S+/gi)[0];for(let I=0;I<G.length-1;I++){if(parseInt(G[I].match(/\S+/gi)[1])>parseInt(G[I+1].match(/\S+/gi)[1])){V=G[I].match(/\S+/gi)[0];break}V=G[I+1].match(/\S+/gi)[0]}y.includes(V)||y.push(V)}for(let L=0;L<a.length;L++)y.includes(a[L])||y.push(a[L]);let z=f.match(/(?<=background-image:\s*url\()(\S+)(?=\))/g);try{for(let j=0;j<z.length;j++)z[j].includes("&quot;")?y.push(z[j].replace(/&quot;/g,"")):z[j].includes("'")&&y.push(z[j].replace(/'/g,""))}catch(B){console.log(B)}if(window.location.href.includes("hathitrust.org")){let D=document.querySelectorAll(".image img");if(D.length>0){let N=document.createElement("canvas");y=[];for(let E=0;E<D.length;E++)N.width=D[E].width,N.height=D[E].height,N.getContext("2d").drawImage(D[E],0,0),y.push(N.toDataURL("image/png"));document.querySelector(".select-all").style="position:relative;width:15px;height:15px;"}}if(window.location.href.toString().includes("manga.bilibili.com/")){let H='<iframe style="display:none;" id="tyc-insert-iframe"></iframe>';null==document.getElementById("tyc-insert-iframe")&&(document.body.insertAdjacentHTML("afterbegin",H),document.getElementById("tyc-insert-iframe").contentDocument.body.insertAdjacentHTML("afterbegin",'<canvas id="tyc-insert-canvas"></canvas>'),document.body.getElementsByTagName("canvas")[0].__proto__.toBlob=document.getElementById("tyc-insert-iframe").contentDocument.getElementById("tyc-insert-canvas").__proto__.toBlob)}let A=y.length;if(T.length>0){l.fetchTip,q=0;for(let P=0;P<T.length;P++){function O(n){let a=new FileReader;a.onloadend=function(n){let a=n.target.result;a.includes("data:image")&&(y.includes(a)||(y[A+P]=a),q++,document.querySelector(".num-tip").innerText=`${l.fetchCount1} ${q}/${T.length} ${l.fetchCount2}`,q===T.length&&(t(),e()))},a.readAsDataURL(n)}T[P].toBlob(O)}}else l.fetchDoneTip1,y.length,l.fetchDoneTip2}catch(U){console.log(U)}let M=`<style>\n        .tyc-image-container{\n            color:black;\n            position:fixed;\n            top:0px;\n            left:10%;\n            width:80vw;\n            z-index:2147483645;\n            background-color: #dedede;\n            border: 1px solid #aaa;\n            overflow:scroll;height:100%;\n        }\n\n        .tyc-image-container button{\n            border:1px solid #aaa;\n            border-radius:5px;\n            height:32px;line-height:32px;\n            margin:0px;padding:0 5px;\n        }\n\n        .tyc-image-container button:hover{\n            background-color: #f50;\n            color: #fff;\n        }\n\n        .control-section{\n            width:80vw;\n            z-index:2147483646;\n            position:fixed;\n            top:0px;\n            left:10%;\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            line-height:40px;\n            background:#eee;border:1px solid #aaa;border-radius:2px;\n        }\n\n        .control-section-sub{\n            display: flex;\n            margin-bottom: 5px;\n        }\n\n        .tyc-normal-section{\n            display: flex;\n            align-items: center;\n            flex-direction: row;\n            flex-wrap: wrap;\n            align-content: normal;\n            justify-content: flex-start;\n            font-size:10px;\n        }\n\n        .tyc-normal-section *{\n            padding-top:2px;\n        }\n\n        .btn-download{\n            border:1px solid #aaa;border-radius:5px;\n            height:32px;line-height:32px;\n            margin:0px;padding:0 5px;\n        }\n        .btn-zipDownload{\n            border:1px solid #aaa;border-radius:5px;\n            height:32px;line-height:32px;\n            margin:0px;padding:0 5px;\n        }\n        .btn-close{\n            font-size:20px;position:absolute;\n            right:30px;top:4px;\n            height:32px;line-height:32px;\n            margin:0px;\n            border-radius:10px;border:1px solid #aaa;\n            width:30px;\n        }\n\n        .tyc-image-wrapper{\n            margin-top:82px;display:flex;justify-content:center;\n            align-items:center;flex-wrap:wrap;\n        }\n\n        .tyc-input-checkbox{\n            background-color: initial;\n            cursor: default;\n            appearance: auto;\n            box-sizing: border-box;\n            margin: 3px 3px 3px 4px;\n            padding: initial;\n            border: initial;\n        }\n\n        .tyc-extend-set{\n            padding: 10px;\n            border-top: 1px solid rgba(100,100,100,0.1);\n        }\n\n        .tyc-extend-set{\n            display: none;\n            align-items: stretch;\n            flex-direction: column;\n            justify-content: flex-start;\n            flex-wrap: nowrap;\n            padding: 5px;\n            width: auto;\n        }\n\n        .tyc-extend-set-container{\n            display: flex;\n            align-items: flex-start;\n            flex-direction: column;\n            justify-content: flex-start;\n            flex-wrap: nowrap;\n            align-content: normal;\n            border: 1px solid rgba(100,100,100,0.5);\n            padding: 5px;\n            margin-bottom: 5px;\n        }\n\n        .tyc-autobigimg-set{\n            display: flex;\n            align-items: flex-start;\n            flex-direction: column;\n            justify-content: flex-start;\n            flex-wrap: nowrap;\n            align-content: normal;\n            border: 1px solid rgba(100,100,100,0.5);\n            padding: 5px;\n        }\n\n        .tyc-set-domain{\n            display: flex;\n            align-items: flex-start;\n            flex-direction: column;\n            justify-content: flex-start;\n            flex-wrap: nowrap;\n            align-content: normal;\n            margin: 5px;\n            padding: 5px;\n            border: 1px solid rgba(100,100,100,0.3);\n            width: 95%;\n            max-height: 150px;\n            overflow: scroll;\n        }\n\n        .tyc-abi-title{\n            display: flex;\n            flex-direction: row;\n            align-items: center;\n            justify-content: space-around;\n            width: 100%;\n        }\n\n        .tyc-abi-domain-title{\n            display: flex;\n            flex-direction: row;\n            align-items: center;\n            justify-content: space-between;\n            width: 95%;\n            border-bottom: 1px solid #ddd;\n        }\n        .tyc-set-replacerule{\n            display: flex;\n            flex-direction: row;\n            justify-content: flex-start;\n            align-items: center;\n            margin-bottom: 3px;\n            flex-wrap: wrap;\n        }\n\n        .tyc-set-replacerule *,.tyc-set-replacerule button{\n            margin-left: 5px;\n        }\n\n        .tyc-set-domain-default{\n            height: 200px;\n            overflow: scroll;\n            display: none;\n        }\n    </style>\n    <div class="tyc-image-container">\n        <div class="control-section">\n            <div class="control-section-sub tyc-normal-section">\n                <input class="select-all tyc-input-checkbox" type="checkbox" name="select-all" value="select-all">${l.selectAll}\n                <button class="btn-download" style="margin-left:5px;">${l.downloadBtn}</button>\n                <button class="btn-zipDownload" style="margin-left:5px;">${l.zipDownloadBtn}</button>\n                <span style="margin-left:10px;" class="num-tip">${l.fetchDoneTip1}${y.length}${l.fetchDoneTip2}</span>\n                <input type="text" class="tyc-file-name" style="height:15px;width:80px;margin-left:25px;font-size:10px;" value="${c}">\n                <input type="text" class="shortCutString" style="height:15px;width:80px;margin-left:25px;font-size:10px;" value="${o}">-ShortCut\n                <button cstyle="margin-left:10px;" class="btn-close" >X</button>\n            </div>\n\n\n            <div style="line-height:12px;" class="control-section-sub tyc-normal-section">\n                <div style="float:left;display:block;">\n                <input type="checkbox" class="width-check img-check tyc-input-checkbox" name="width-check" value="width-check">Width:\n                <input type="text" class="width-value-min" size="1" style="height:15px;width:50px;"\n                    min="0" max="9999" value="0">-\n                    <input type="text" class="width-value-max" size="1" style="height:15px;width:50px;"\n                    min="0" max="9999" value="3000">\n                </div>\n\n                <div style="float:left;margin-left:30px;display:block;">\n                    <input type="checkbox" class="height-check img-check tyc-input-checkbox" name="height-check" value="height-check">Height:\n                    <input type="text" class="height-value-min" size="1" style="height:15px;width:50px;"\n                        min="0" max="9999" value="0">-\n                        <input type="text" class="height-value-max" size="1" style="height:15px;width:50px;"\n                        min="0" max="9999" value="3000">\n                </div>\n\n                <div style="float:left;margin-left:30px;display:block;" class="tyc-extra-grab">\n                    <input type="checkbox" class="extra-grab-check img-check tyc-input-checkbox" name="extra-grab-check" value="extra-grab-check">\n                    <span>${l.extraGrab}</span>\n                </div>\n\n                <div style="float:left;margin-left:30px;display:block;" class="tyc-download-url">\n                    <button class="tyc-download-url-btn">${l.downloadUrlFile}</button>\n                </div>\n\n\n                <div style="float:left;margin-left:30px;display:block;" class="tyc-extend-btn">\n                    <span>${l.moreSetting} </span>\n                    <span style="top: 3px;position: relative;">\n                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-double-down" viewBox="0 0 16 16">\n                            <path fill-rule="evenodd" d="M1.646 6.646a.5.5 0 0 1 .708 0L8 12.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>\n                            <path fill-rule="evenodd" d="M1.646 2.646a.5.5 0 0 1 .708 0L8 8.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>\n                        </svg>\n                    </span>\n                </div>\n            </div>\n            <div class="tyc-extend-set control-section-sub">\n                <div class="tyc-autobigimg-set tyc-extend-set-container">\n                    <div class="tyc-abi-title">\n                        <div>\n                            ${l.autoBitImgModule}\n                        </div>\n                        <div>\n                            <button class="tyc-default-rule-show">${l.defaultSettingRule}</button>\n                        </div>\n\n                        <div>\n                        <button>${l.exportCustomRule}</button>\n                    </div>\n\n                        <div>\n                            <input type="file" id="tycfileElem" multiple accept="text/plain" style="display:none">\n                            <button id="tyc-file-select">${l.importCustomRule}</button>\n                        </div>\n\n                    </div>\n                    <div class="tyc-set-domain tyc-set-domain-custom">\n                    </div>\n                    <div class="tyc-set-domain tyc-set-domain-default">\n                    </div>\n                </div>\n\n            </div>\n        </div>\n        <div class="tyc-image-wrapper" >\n        </div>\n    </div>`;document.body.insertAdjacentHTML("afterbegin",M),u.showDefaultRules(),u.showRules("tyc-set-domain-custom","userRules","userRulesChecked","tyc-custom-active"),document.querySelector(".tyc-image-wrapper").style=`margin-top:${document.querySelector(".control-section").clientHeight}px`,document.body.onclick=e=>{let t=e.path||e.composedPath&&e.composedPath();if("IMG"==e.target.nodeName&&"tyc-image-preview"===e.target.className){let e=t.find(e=>"tyc-image-preview"===e.classList[0]),n=parseInt(e.dataset.value),a=t.find(e=>e.className===`tyc-img-item-container-${n}`),i=a.getElementsByClassName("tyc-image-info-container")[0];x.includes(n)?(x.splice(x.indexOf(n),1),a.style.border="1px solid #99d",i.style.backgroundColor="rgba(100,100,100,0.6)"):(x.push(n),a.style.border="1px solid #f50",i.style.backgroundColor="rgba(88, 158, 255, 0.8)"),w=x,document.querySelector(".num-tip").innerText=`${l.fetchDoneTip1Type2}${x.length}/${y.length}${l.fetchDoneTip2}`,b=d(k,x),v=g(v=d(R,w))}else if("show-big-image"===e.target.parentElement.className)try{document.querySelector(".show-big-image").remove()}catch{}else if("bi-download"==e.target.classList[1]||null!=t.find(r)){let e,n=t.find(e=>{try{return e.className.includes("tyc-img-item-container")}catch{}}).getElementsByTagName("img")[0].src;e=n.indexOf("/")>0?n.substring(n.lastIndexOf("/")+1,n.lastIndexOf(".")):n;let l=document.querySelector(".tyc-file-name").value||"pic";saveAs(n,l)}else if("bi-arrows-fullscreen"==e.target.classList[1]||null!=t.find(s)){let e=t.find(e=>{try{return e.className.includes("tyc-img-item-container")}catch{}}).getElementsByTagName("img")[0].src;try{let t=document.querySelector(".show-big-image");if(t.getElementsByTagName("img")[0].src===e)return void t.remove();t.remove()}catch{}document.body.insertAdjacentHTML("beforeend",'\n        <div class="show-big-image" style="position:fixed;left:30%;top:30%;z-index:2147483647;">\n        </div>\n    ');let n=`<img src="${e}"/>`;document.querySelector(".show-big-image").insertAdjacentHTML("beforeend",n);let l=document.querySelector(".show-big-image img"),a=(window.innerWidth-l.width)/2,i=(window.innerHeight-l.height)/2;document.querySelector(".show-big-image").style.left=a+"px",document.querySelector(".show-big-image").style.top=i+"px",(l.width>window.innerWidth||l.height>window.innerHeight)&&(document.querySelector(".show-big-image").style.overflow="scroll",l.width>window.innerWidth&&(document.querySelector(".show-big-image").style.left="0px",document.querySelector(".show-big-image").style.width=window.innerWidth+"px"),l.height>window.innerHeight&&(document.querySelector(".show-big-image").style.top="0px",document.querySelector(".show-big-image").style.height=window.innerHeight+"px"))}},document.querySelector(".btn-close").onclick=()=>{document.querySelector(".tyc-image-container").remove()},document.querySelector(".btn-download").onclick=async()=>{if(b.length>=1){function e(){return new Promise(e=>{setTimeout(()=>{e(1)},200)})}for(let t=0;t<b.length;t++){await e();let n=document.querySelector(".tyc-file-name").value||"pic";console.log(`${n}-${t}`),saveAs(b[t],`${n}-${t}`)}}else alert(`${l.selectAlert}`)},document.querySelector(".btn-zipDownload").onclick=()=>{try{v.length>=1?(v.forEach(async(e,t)=>{let n=e.substring(e.indexOf("image/")+6,e.indexOf(";"));n=n.includes("svg")?"svg":n;let l=`${document.querySelector(".tyc-file-name").value||"pic"}-${t}.${n}`;C.file(l,e.split(",")[1],{base64:!0})}),S.generateAsync({type:"blob"}).then(function(e){let t=document.querySelector(".tyc-file-name").value||"pic";saveAs(e,`${t}.zip`),S.remove("pics"),C=S.folder("pics")})):alert(`${l.selectAlert}`)}catch(e){}},document.body.onchange=l=>{l.target.className.includes("width-check")&&GM_setValue("width-check",l.target.checked),l.target.className.includes("height-check")&&GM_setValue("height-check",l.target.checked),l.target.className.includes("extra-grab-check")&&(GM_setValue("extra-grab-check",l.target.checked),document.querySelector(".extra-grab-check").checked),l.target.className.includes("tyc-default-active")&&u.oncheckChange(),l.target.className.includes("tyc-custom-active")&&u.oncheckChangeCustom(),"INPUT"===l.target.nodeName&&"text"===l.target.type&&l.target.className.includes("value")&&GM_setValue(l.target.className,l.target.value),"INPUT"===l.target.nodeName&&"text"===l.target.type&&l.target.className.includes("shortCutString")&&(GM_setValue(l.target.className,l.target.value),hotkeys(l.target.value,n)),(l.target.className.includes("width-check")||l.target.className.includes("height-check")||"INPUT"===l.target.nodeName&&"text"===l.target.type&&l.target.className.includes("value"))&&(t(),e())},document.querySelector(".select-all").onchange=()=>{document.querySelector(".select-all").checked?(b=k,v=g(R)):(b=d(k,x),v=d(R,w)),document.querySelector(".num-tip").innerText=`${l.fetchDoneTip1Type2}${b.length}/${k.length}${l.fetchDoneTip2}`},document.querySelector(".tyc-extend-btn").onclick=()=>{document.querySelector(".tyc-extend-btn").classList.contains("extend-open")?(document.querySelector(".tyc-extend-btn").classList.remove("extend-open"),document.querySelector(".tyc-extend-set").style.display="none",document.querySelector(".tyc-extend-btn").style.color="black",document.querySelector(".tyc-extend-btn").innerHTML=`<span>${l.moreSetting}</span>\n                <span style="top: 3px;position: relative;">\n                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-double-down" viewBox="0 0 16 16">\n                        <path fill-rule="evenodd" d="M1.646 6.646a.5.5 0 0 1 .708 0L8 12.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>\n                        <path fill-rule="evenodd" d="M1.646 2.646a.5.5 0 0 1 .708 0L8 8.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>\n                    </svg>\n                </span> `):(document.querySelector(".tyc-extend-btn").classList.add("extend-open"),document.querySelector(".tyc-extend-set").style.display="flex",document.querySelector(".tyc-extend-btn").style.color="#f50",document.querySelector(".tyc-extend-btn").innerHTML=`<span>${l.fold} </span>\n                <span style="top: 3px;position: relative;">\n                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-double-up" viewBox="0 0 16 16">\n                    <path fill-rule="evenodd" d="M7.646 2.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 3.707 2.354 9.354a.5.5 0 1 1-.708-.708l6-6z"/>\n                    <path fill-rule="evenodd" d="M7.646 6.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 7.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z"/>\n                    </svg>\n                </span> `)},document.querySelector(".tyc-default-rule-show").onclick=u.onclickShowDefaultBtn,document.querySelector("#tyc-file-select").onclick=()=>{document.querySelector("#tycfileElem").click()},document.querySelector("#tycfileElem").onchange=u.getCustomRules,document.querySelector(".tyc-download-url-btn").onclick=()=>{let e=new Blob([b.join("\n")],{type:"text/plain",endings:"native"});saveAs(e,"urls.txt")},e()}var l,a,i,c,o,r="Netscape"==navigator.appName?navigator.language:navigator.userLanguage,s={zh:{selectAll:"全选",downloadBtn:"下载",downloadMenuText:"打开脚本(Alt+w)",zipDownloadBtn:"zip下载",selectAlert:"请至少选中一张图片。",fetchTip:"准备抓取canvas图片",fetchCount1:"抓取canvas图片第",fetchCount2:"张",fetchDoneTip1:"已选(0/",fetchDoneTip1Type2:"已选(",fetchDoneTip2:")张图片",regRulePlace:"输入待替换正则",regReplacePlace:"输入替换它的字符串或者函数",zipOptionDesc:"勾选使用zip下载后，会请求跨域权限，否则zip下载基本下载不到图片。",zipCheckText:"使用zip下载",downloadUrlFile:"下载图片地址",moreSetting:"更多设置",autoBitImgModule:"自动大图设置模块",defaultSettingRule:"设置默认规则",exportCustomRule:"导出自定规则",importCustomRule:"导入自定规则",fold:"收起",inputFilenameTip:"输入文件名",extraGrab:"强力抓取"},en:{selectAll:"selectAll",downloadBtn:"download",downloadMenuText:"Open(Alt+w)",zipDownloadBtn:"zip Download",selectAlert:"Please at last select one image.",fetchTip:"Ready to fetch canvas image.",fetchCount1:"Fetch the",fetchCount2:" canvas image.",fetchDoneTip1:"(0/",fetchDoneTip1Type2:"(",fetchDoneTip2:") Images selected",regRulePlace:"enter reg express",regReplacePlace:"enter replace string or function",zipOptionDesc:"when zip option checked,will request cors right,otherwise zipDownload can not get pics",zipCheckText:"Use ZipDownload",downloadUrlFile:"Download Imgs Url",moreSetting:"More Setting",autoBitImgModule:"AutoBigImageModule",defaultSettingRule:"SetDefaultRule",exportCustomRule:"exportCustomRule",importCustomRule:"importCustomRule",fold:"fold",inputFilenameTip:"input filename",extraGrab:"Extra Grab"}};l=r.toLowerCase().includes("zh-")?s.zh:s.en;const u={bigImageArray:[],defaultRules:[{originReg:/(?<=(.+sinaimg\.(?:cn|com)\/))([\w\.]+)(?=(\/.+))/i,replacement:"large",tip:"for weib.com"},{originReg:/(?<=(.+alicdn\.(?:cn|com)\/.+\.(jpg|jpeg|gif|png|bmp|webp)))_.+/i,replacement:"",tip:"for alibaba web"},{originReg:/(.+alicdn\.(?:cn|com)\/.+)(\.\d+x\d+)(\.(jpg|jpeg|gif|png|bmp|webp)).*/i,replacement:(e,t,n,l)=>t+l,tip:"for 1688"},{originReg:/(?<=(.+360buyimg\.(?:cn|com)\/))(\w+\/)(?=(.+\.(jpg|jpeg|gif|png|bmp|webp)))/i,replacement:"n0/",tip:"for jd"},{originReg:/(?<=(.+hdslb\.(?:cn|com)\/.+\.(jpg|jpeg|gif|png|bmp|webp)))@.+/i,replacement:"",tip:"for bilibili"},{originReg:/th(\.wallhaven\.cc\/)(?!full).+\/(\w{2}\/)([\w\.]+)(\.jpg)/i,replacement:(e,t,n,l)=>"w"+t+"full/"+n+"wallhaven-"+l+".jpg",tip:"for wallhaven"},{originReg:/th(\.wallhaven\.cc\/)(?!full).+\/(\w{2}\/)([\w\.]+)(\.jpg)/i,replacement:(e,t,n,l)=>"w"+t+"full/"+n+"wallhaven-"+l+".png",tip:"for wallhaven"},{originReg:/(.*\.twimg\.\w+\/.+\&name=*)(.*)/i,replacement:(e,t)=>t+"orig",tip:"for twitter"},{originReg:/(shonenjump\.com\/.*\/)poster_thumb(\/.*)/,replacement:"$1poster$2",tip:"for www.shonenjump.com"},{originReg:/(qzone\.qq\.com.*!!\/.*)$/,replacement:"$1/0",tip:"for Qzone"},{originReg:/(.*wordpress\.com.*)(\?w=\d+)$/,replacement:"$1",tip:"for wordpress"}],defaultRulesChecked:[],userRules:[],userRulesChecked:[],replace(e){let t=this;t.bigImageArray=[];let n=Array.from(new Set(e)).filter(e=>e&&e);t.setRulesChecked(),n.forEach(function(e){e.includes("data:image/")?t.bigImageArray.push(e):(t.defaultRules.forEach((n,l)=>{if("checked"!==t.defaultRulesChecked[l])return void t.bigImageArray.push(e);let a=e.replace(n.originReg,n.replacement);a!==e?(t.bigImageArray.push(e),t.bigImageArray.push(a)):t.bigImageArray.push(e)}),t.userRules.forEach((n,l)=>{if("checked"!==t.userRulesChecked[l])return void t.bigImageArray.push(e);let a=e.replace(n.originReg,n.replacement);a!==e?(t.bigImageArray.push(e),t.bigImageArray.push(a)):t.bigImageArray.push(e)}))})},getBigImageArray(e){return this.replace(e),Array.from(new Set(this.bigImageArray))},showDefaultRules(){let e=this,t=document.body.querySelector(".tyc-set-domain-default");e.setRulesChecked(),this.defaultRules.forEach((n,a)=>{let i=`<div class="tyc-set-replacerule">\n                            <input type="checkbox" name="active" class="tyc-default-active" ${e.defaultRulesChecked[a]}>\n                            <input type="text" name="regrule" placeholder="${l.regRulePlace}" class="tyc-search-title" value="${n.originReg}">\n                            <input type="text" name="replace" placeholder="${l.regReplacePlace}" class="tyc-search-url" value="${n.replacement}">\n                            <span class="tyc-default-tip">${n.tip}</span>\n                    </div>\n                `;t.insertAdjacentHTML("beforeend",i)})},showRules(e,t,n,a){let i=this,c=document.body.querySelector("."+e);i.setRulesChecked(),i.setCustomRules(),i[t].forEach((e,t)=>{let o=`<div class="tyc-set-replacerule">\n                            <input type="checkbox" name="active" class="${a}" ${i[n][t]}>\n                            <input type="text" name="regrule" placeholder="${l.regRulePlace}" class="tyc-search-title" value="${e.originReg}">\n                            <input type="text" name="replace" placeholder="${l.regReplacePlace}" class="tyc-search-url" value="${e.replacement}">\n                            <span class="tyc-default-tip">${e.tip}</span>\n                    </div>\n                `;c.insertAdjacentHTML("beforeend",o)})},onclickShowDefaultBtn(){let e=document.body.querySelector(".tyc-set-domain-default");"none"===e.style.display||""===e.style.display?e.style.display="flex":e.style.display="none"},oncheckChange(){let e=document.body.querySelectorAll(".tyc-default-active");this.defaultRulesChecked=[],e.forEach(e=>{e.checked?this.defaultRulesChecked.push("checked"):this.defaultRulesChecked.push("")}),GM_setValue("defaultRulesChecked",this.defaultRulesChecked)},oncheckChangeCustom(){let e=document.body.querySelectorAll(".tyc-custom-active");this.userRulesChecked=[],e.forEach(e=>{e.checked?this.userRulesChecked.push("checked"):this.userRulesChecked.push("")}),GM_setValue("userRulesChecked",this.userRulesChecked)},setRulesChecked(){if(GM_getValue("defaultRulesChecked")){if(this.defaultRulesChecked=GM_getValue("defaultRulesChecked"),this.defaultRulesChecked.length<this.defaultRules.length){let e=this.defaultRules.length-this.defaultRulesChecked.length;for(let t=0;t<e;t++)this.defaultRulesChecked.push("checked")}}else this.defaultRules.forEach(()=>{this.defaultRulesChecked.push("checked")}),GM_setValue("defaultRulesChecked",this.defaultRulesChecked);GM_getValue("userRulesChecked")&&GM_getValue("userRulesChecked").length>0?this.userRulesChecked=GM_getValue("userRulesChecked"):(this.userRules.forEach(()=>{this.userRulesChecked.push("checked")}),GM_setValue("userRulesChecked",this.userRulesChecked))},getCustomRules(e){let t=u,n=document.querySelector("#tycfileElem").files[0],l=new FileReader;l.onload=e=>{let n=e.target.result;t.userRules=eval(n),GM_deleteValue("userRulesChecked"),t.setRulesChecked(),GM_setValue("userRules",n),document.body.querySelector(".tyc-set-domain-custom").innerHTML="",t.showRules("tyc-set-domain-custom","userRules","userRulesChecked","tyc-custom-active")},l.readAsText(n,"GB2312")},setCustomRules(){if(GM_getValue("userRules"))try{this.userRules=eval(GM_getValue("userRules"))}catch(e){GM_setValue("userRules","")}},exportCustomRules(){}};a=[];let d=Object.getOwnPropertyDescriptor(HTMLImageElement.prototype,"src");i=document.domain.split("."),o="alt+W",null!=GM_getValue("shortCutString")&&(o=GM_getValue("shortCutString")),GM_registerMenuCommand(l.downloadMenuText,n),hotkeys(o,t),GM_getValue("extra-grab-check")&&e()})();