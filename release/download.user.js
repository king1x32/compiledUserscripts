// ==UserScript==
// @name         Bilibili international subtitle downloader
// @version      0.7.5
// @author       AdvMaple
// @match        /\:\/\/.*.bilibili.*\/(\w\/|)(play|video)\/.*$/
// @include      /\:\/\/.*.bilibili.*\/(\w\/|)(play|video)\/.*$/
// @icon         https://www.google.com/s2/favicons?domain=biliintl.com
// @updateURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/download.meta.js
// @grant        GM_addStyle

// ==/UserScript==
!function(){function e({ep_url:e,ep_title:t}){const n=document.createElement("a");n.textContent=t,n.href=e,n.download=`${t}.mp4`,n.type="video/mp4",document.getElementById("videoList").appendChild(n)}function t({file_name:e,blob:t,file_format:n=r}){const i=document.createElement("a");i.download=`${e}.${s}.${n}`,i.textContent=`${e}`,i.href=URL.createObjectURL(t),document.getElementById("jsonSubtitleList").appendChild(i)}function n(){const e="play",t="video",n=(e=[],t="")=>{if(e.length>0)return e.findIndex(e=>e===t)},i=location.pathname.split("/"),o=location.pathname.includes(e),a=location.pathname.includes(t),l=n(i,o?e:t);let d,s,r;if(o?(d=i[l+2],r=i[l+1],d=Number.parseInt(d)||void 0,r=Number.parseInt(r)||void 0):a&&(s=i[l+1],s=Number.parseInt(s)||void 0),d>0||s>0);else if(o){const t=document.body.querySelector(".video-play .ep-section .ep-list .ep-item--active"),i=t?.href?.split("?")?.shift()?.split("/")||[];i&&i.length>0&&(d=i[n(i,e)+2],d=Number.parseInt(d)||void 0),d>0||alert("Can't identify episode ID, please contact dev")}else alert("Can't identify video ID, please contact dev");return{ep_id:d,video_id:s,season_id:r}}function i(){document.getElementById("jsonSubtitleList").innerHTML=`${d[p].subtitle}&nbsp;:&nbsp;`,document.getElementById("videoList").innerHTML=`${d[p].video}&nbsp;:&nbsp;`,document.getElementById("audioList").innerHTML=`${d[p].audio}&nbsp;:&nbsp;`,o(""),function(){const t=function(){const e=function(){const e=document.head.querySelector("[property='og:title'][content]")?.content?.replace(" HD | bilibili",""),t=document.body.querySelector(".video-play .video-play__meta .bstar-meta .bstar-meta__title")?.innerText,n=document.body.querySelector(".video-play .video-play__meta .bstar-meta .bstar-meta__extra .bstar-meta__origin-name .bstar-meta__origin-name-content")?.innerText,i=document.body.querySelector(".video-play .video-play__meta .bstar-meta .bstar-meta__extra .bstar-meta__alias .bstar-meta__alias-content")?.innerText;return e||t||i||n}(),t=document.title?.replace(" - BiliBili","")?.replace(`${e} `,""),n=document.body.querySelector(".video-play__breadcrumb .breadcrumb__item:last-child > .breadcrumb__item-text")?.innerText,i=n||t,o=i.split(" - ")[0],a=i.split(" - ")[1];let l,d=o?.replace(/[^0-9]/g,"");return"string"==typeof d&&(d=Number.parseInt(d)),l=d>=0?`E${d}${a?` - ${a}`:""}`:`${o||e} - ${a||i}`,l}(),{ep_id:i,video_id:a}=n();(i>0||a>0)&&(async function({ep_id:e,video_id:t,ep_title:n}){const i=`https://api.bilibili.tv/intl/gateway/web/v2/subtitle?s_locale=${s}&platform=web&${e>0?`episode_id=${e}`:`aid=${t}`}`,a=await fetch(i,{credentials:"include"}),l=await a.text();if(f(l)){const{data:e}=JSON.parse(l);null!==e.subtitles&&null!==e.video_subtitle||alert("There is no suitable subtitle data");const t=e.subtitles||e.video_subtitle||[];let i;for(let n=0;n<t.length;n++)if(t[n].lang_key===s&&!i){const t=e.subtitles[n].url,o=e.video_subtitle[n].srt?.url||t;i=["srt","ass"].includes(r)&&(e.video_subtitle[n][r]?.url||t)||o}i?v({ep_title:n,ep_sub_url:i}):o("The language you selected, does not have subtitle files!")}else alert("Can't get subtitles data, please contact DEV")}({ep_id:i,video_id:a,ep_title:`${t} [${i||a}]`}),function({ep_id:t,video_id:n,ep_title:i}){fetch(`https://api.bilibili.tv/intl/gateway/web/playurl?${t>0?`ep_id=${t}`:`aid=${n}`}&device=wap&platform=web&qn=64&tf=0&type=0`,{credentials:"include"}).then(e=>e.json()).then(({data:t})=>{var n=0,o=0;const a=t.playurl,l=Number(c),d=Number(u),s=a.video.findIndex(e=>e.video_resource.quality===l&&e.video_resource.codec_id===d);let r=!1;if(s>-1){const t=a.video[s].video_resource.url;t?e({ep_url:t,ep_title:i}):r=!0}else r=!0;if(r)for(let t=0;t<a.video.length;t++){const o=a.video[t].video_resource.url;""!==o&&n<a.video[t].video_resource.quality&&(n=a.video[t].video_resource.quality,e({ep_url:o,ep_title:i}))}for(let e=0;e<a.audio_resource.length;e++){const t=a.audio_resource[e].url;if(""!==t&&o<a.audio_resource[e].quality){o=a.audio_resource[e].quality;const n=document.createElement("a");n.textContent=`${i} `,n.href=t,n.download="audio_url",n.type="video/mp4",document.getElementById("audioList").appendChild(n)}}})}({ep_id:i,video_id:a,ep_title:`${t} [${i||a}]`}))}()}function o(e){document.getElementById("plugin_notice").innerText=e}const a=[{id:7,label:"AVC"},{id:12,label:"HEVC"}],l=[{id:120,label:"4K"},{id:112,label:"1080P(HD)"},{id:80,label:"1080P"},{id:64,label:"720P"},{id:32,label:"480P"},{id:16,label:"320P"},{id:6,label:"240P"},{id:5,label:"144P"}],d={en:{gen_this_link:"Generate Links for this EP",gen_links:"Generate Links",subtitle:"Subtitle",video:"Video",audio:"Audio"},th:{gen_this_link:"สร้างการดาวน์โหลดสำหรับ EP นี้",gen_links:"สร้างการดาวน์โหลด",subtitle:"คำบรรยาย",video:"วิดีโอ",audio:"เสียง"}};let s=localStorage.getItem("SUB_LANGUAGE");s||(localStorage.setItem("SUB_LANGUAGE","en"),s="en");let r=localStorage.getItem("SUB_FORMAT");r||(localStorage.setItem("SUB_FORMAT","srt"),r="srt");let c=localStorage.getItem("VIDEO_QUALITY");c||(localStorage.setItem("VIDEO_QUALITY",112),c=112);let u=localStorage.getItem("VIDEO_CODEC");u||(localStorage.setItem("VIDEO_CODEC",12),u=12);let p=location.pathname.split("/")[1];Object.keys(d).includes(p)||(p="en");const{ep_id:b,video_id:m,season_id:_}=n();(b>0||_>0||m>0)&&function e({ep_id:t,season_id:n,video_id:i}){const o=i>0,d=t>0;fetch(`https://api.bilibili.tv/intl/gateway/web/playurl?${d||n>0?d?`ep_id=${t}`:`season_id=${n}`:`aid=${i}`}&platform=web&device=wap&qn=64&tf=0&type=0`,{credentials:"include"}).then(e=>e.json()).then(({data:t})=>{if(d||o){const e=function(e){const t=(e="")=>(t,n)=>t[e]<n[e]?1:t[e]>n[e]?-1:0;let n="";return(e||l).sort(t("codec_id")).sort(t("id")).forEach(e=>{var t;n+=`<option value="${e.id};${e.codec_id}" ${c===`${e.id}`&&u===`${e.codec_id}`?"selected":""}>[${t=e.codec_id,(a.find(e=>e.id===t)||{}).label||"Unknown Codec"}] ${e.label} </option>`}),n}(t.playurl.video.filter(e=>!!e.video_resource.url).map(e=>({codec_id:e.video_resource.codec_id,id:e.video_resource.quality,label:e.stream_info.desc_words})));document.getElementById("changeQuality").innerHTML=e}else if(t?.sections?.length>0){const n=t?.sections[0].episodes;n.length>0&&e(n[0].episode_id)}})}({ep_id:b,season_id:_,video_id:m});let g=document.createElement("div");g.innerHTML=`\n    <button id="down-this" class="btn" type="button"> ${d[p].gen_this_link} </button>\n\n    <select id="changeLanguage" class="subtitleSelect" name="lang">\n      ${[{id:"en",label:"English"},{id:"th",label:"ภาษาไทย"},{id:"vi",label:"Tiếng Việt"},{id:"id",label:"Bahasa Indonesia"},{id:"ms",label:"Bahasa Melayu"},{id:"zh-Hans",label:"中文（简体）"},{id:"zh-Hant",label:"中文（繁体）"}].map(e=>`<option value="${e.id}" ${s===e.id?"selected":""}> ${e.label} </option>`)}\n    </select>\n\n    <select id="changeSubFormat" class="subtitleSelect" name="lang-format">\n      ${["ass","srt","vtt","json"].map(e=>`<option value="${e}" ${r===e?"selected":""}> ${e.toUpperCase()} </option>`)}\n    </select>\n\n    <select id="changeQuality" class="subtitleSelect" name="quality">\n\n    </select>\n\n    <div class="linkContainer" id="jsonSubtitleList">${d[p].subtitle}&nbsp;:&nbsp;</div>\n\n    <div class="linkContainer" id="videoList" >${d[p].video}&nbsp;:&nbsp;</div>\n\n    <div class="linkContainer" id="audioList" >${d[p].audio}&nbsp;:&nbsp;</div>\n\n    <div id="plugin_notice"></div>\n\n    <div id="snackbar"></div>\n  `,g.setAttribute("id","downloadBiliintScript"),document.body.appendChild(g),document.getElementById("down-this").addEventListener("click",i,!1),document.getElementById("changeLanguage").addEventListener("change",function(e){localStorage.setItem("SUB_LANGUAGE",e.target.value),s=e.target.value,i()},!1),document.getElementById("changeSubFormat").addEventListener("change",function(e){localStorage.setItem("SUB_FORMAT",e.target.value),r=e.target.value,i()},!1),document.getElementById("changeQuality").addEventListener("change",function(e){const t=e.target.value.split(";");localStorage.setItem("VIDEO_QUALITY",t[0]),c=e.target.value,localStorage.setItem("VIDEO_CODEC",t[1]),u=e.target.value,i()},!1);const f=e=>{try{JSON.parse(e)}catch(e){return!1}return!0},v=async({ep_title:e,ep_sub_url:n})=>{const i=await fetch(n),a=await i.text();let l="unknown format",d=r;if(f(a)){l="json";const n=JSON.parse(a);let i,c="";if("vtt"===r||"srt"===r||"ass"===r){const e=e=>{let t=new Date(0),n=new Date(1e3*e);return new Date(n.getTime()-t.getTime()).toISOString().split("T")[1].split("Z")[0]};"vtt"===r&&(c+=`WEBVTT\nKind: captions\nLanguage: ${s}\n\n`),n.body.forEach((t,n)=>{const i=e(void 0!==t.from?t.from:0),o=e(t.to);c+=n+1+"\n",c+=`${i.replace(".",",")} --\x3e ${o.replace(".",",")}\n`,c+=t.content+"\n\n"}),i=new Blob([c],{type:"text/"+("vtt"===r?"vtt":"plain")})}else i=new Blob([JSON.stringify(n)],{type:"application/json"});"ass"===r&&(d="srt",o(".ass format subtitles are not available, the plugin will automatically create subtitle links in .srt format!")),t({file_name:e,blob:i,file_format:d})}else a.includes("[V4+ Styles]")?(l="ass",t({file_name:e,blob:new Blob([a],{type:"text/plain"}),file_format:d})):alert("Format subtitles .ass problematic, please contact DEV");!function(e){const t=document.getElementById("snackbar");t.className="show",t.innerText=e,y&&(y=clearTimeout(y)),y=setTimeout(function(){t.className=t.className.replace("show","")},3e3)}(`The server is returning ${l} file. The generated link is .${d} file`)};let y;GM_addStyle("\n\n    #downloadBiliintScript {\n      position: fixed;\n      bottom: 2.2vw;\n      left: 2.2vw;\n      z-index: 9999;\n      opacity: 0.97;\n      background: black;\n      padding: 16px;\n    }\n\n    #down-this {\n      background: #4c93ff;\n      margin-bottom: 16px;\n\n      color: white;\n      font-weight: 700;\n    }\n\n    .linkContainer {\n      margin-top: 16px;\n\n      color: black;\n      background: white;\n      opacity: 0.97;\n      border-radius: 20px;\n      padding: 8px;\n      font-size: 15px\n    }\n\n    .btn {\n      cursor: pointer;\n      padding: 3px;\n      opacity:0.97;\n      border-radius: 20px;\n      padding: 8px;\n    }\n\n    .btn:hover {\n      background-color: #6b9f25;\n      color: white;\n    }\n\n    #BtnContainer{\n      margin-top: 3px;\n      margin-bottom: 6px;\n      opacity: 0.97;\n    }\n\n    #mySortBtn {\n      cursor: pointer;\n      padding: 3px;\n      border-radius:20px;\n      width: 100%;\n      background-color: #23427f;\n      color: white;\n      opacity: 0.99;\n    }\n    #mySortBtn:hover {\n      background-color: #38548b;\n      color: #d3d9e5;\n    }\n\n    #downloadBiliintScript a {\n      color: #4c93ff;\n      background: white;\n      opacity: 0.97;\n    }\n\n    #downloadBiliintScript a:hover {\n      color: #4078cb;\n      background: white;\n      opacity: 0.97;\n    }\n\n    .subtitleSelect {\n      margin-right: 8px;\n\n      border-radius: 20px;\n      padding: 8px;\n      background: white;\n      opacity: 0.97;\n    }\n\n    #plugin_notice {\n      margin-top: 16px;\n\n      color: red;\n      font-size: 13px;\n      font-style: italic;\n    }\n    #plugin_notice:empty {\n      display: none;\n    }\n\n    #snackbar {\n      visibility: hidden;\n      min-width: 250px;\n      margin-left: -125px;\n      background-color: #333;\n      color: #fff;\n      text-align: center;\n      border-radius: 2px;\n      padding: 16px;\n      position: fixed;\n      z-index: 1;\n      left: 50%;\n      bottom: 30px;\n      font-size: 17px;\n    }\n\n    #snackbar.show {\n      visibility: visible;\n      -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;\n      animation: fadein 0.5s, fadeout 0.5s 2.5s;\n    }\n\n    @-webkit-keyframes fadein {\n      from {bottom: 0; opacity: 0;}\n      to {bottom: 30px; opacity: 1;}\n    }\n\n    @keyframes fadein {\n      from {bottom: 0; opacity: 0;}\n      to {bottom: 30px; opacity: 1;}\n    }\n\n    @-webkit-keyframes fadeout {\n      from {bottom: 30px; opacity: 1;}\n      to {bottom: 0; opacity: 0;}\n    }\n\n    @keyframes fadeout {\n      from {bottom: 30px; opacity: 1;}\n      to {bottom: 0; opacity: 0;}\n    }\n")}();