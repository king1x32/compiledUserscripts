// ==UserScript==
// @name         Direct download from Google Play
// @namespace    StephenP
// @version      3.6.2
// @author       StephenP
// @icon      data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAM1BMVEV2ZXLgIkzxMUf6OkN9f5v7ZTAOpP8OxP4myPsU1LkU1P4k4oAr3vwk7H1U41v+ziz92jIMI6b6AAAAAXRSTlMAQObYZgAAAKtJREFUOMul0ssSgyAMQNGAtCgv/f+vLcVCSCLiTLPL3MPAAoAn4/0EbP6eWDsRaxEx3gG7xe+MAIo4ABPhiIjXoBeCOCEiB0IkDphI+3EwQETaM+iIYyL3AhpxVKT3OSgCEeaFACgowiyLBE241WgE7ZEBhdFaVwA9CNi1vgQB+wCE1kcg1A4DQO6n5uxKleMgO/x6nrKKDrXX/eINpstV9D+G9SLIruCP+QAbnhEp2bGFogAAAABJRU5ErkJggg==
// @match        https://play.google.com/*
// @match        http://play.google.com/*
// @match        http://apkfind.com/store/captcha?app=*
// @grant        GM.xmlHttpRequest
// @grant        GM.getValue
// @grant        GM.setValue
// @require      https://greasemonkey.github.io/gm4-polyfill/gm4-polyfill.js
// @connect      self
// @connect      apkpure.com
// @connect      apkfind.com
// @connect      apk-cloud.com
// @connect      winudf.com
// @connect      apkcombo.com
// @connect      down-apk.com
// @connect      play.googleapis.com
// @connect      gvt1.com
// @connect      apkpremier.com
// @connect      web-api.aptoide.com
// @connect      apk.support
// @contributionURL https://buymeacoffee.com/stephenp_greasyfork
// @downloadURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/Direct20download20from20Google20Play.user.js
// @updateURL https://raw.githubusercontent.com/king1x32/compiledUserscripts/release/release/Direct20download20from20Google20Play.meta.js
// ==/UserScript==
function e(){var e=document.body.children.length-1;parseInt(document.body.children[e].style.zIndex,10)>2&&(""==document.body.children[e].id?(document.body.children[e].style.zIndex="1",document.body.children[e-1].style.zIndex="-1000"):document.body.children[e].style.zIndex="-1000")}function t(){if(c!=location.href||!1===o()){if(document.getElementById("main-title").innerHTML,c=location.href,location.href.includes("details?id=")||location.href.includes("/store/search?q=")){if(s>0&&document.getElementsByClassName("ddlButton").length>0)try{p.parentNode.removeChild(p)}catch(e){console.log(e+"; I was probably just trying to remove buttons that weren't there...")}l()}}else setTimeout(t,1e3)}function n(){c==location.href&&!1!==o()||t()}function o(){var e,t=document.getElementsByClassName("ddlButton");if(t.length>0){for(e=0;e<t.length;e++)if(null!=t[e].offsetParent)return!0;return!1}return!document.location.href.includes("play.google.com/store/apps/details")||(console.log("apppage//"+!1),!1)}function l(){var e,t,n,o,l,i,a,d,c,u,f,h=-1,m=null;if(s>0){for(m=function(){var e=[];if(0==(e=document.querySelectorAll('[data-item-id^="%.@."]')).length){e=document.querySelectorAll('[data-p^="%.@.["]');for(let t of e)if(t.querySelector("[fill-rule=evenodd]")&&t.getAttribute("data-p").includes('",7]]'))return t}return console.log("Install buttons:"),console.log(e),e[0]}();"C-WIZ"!=m.tagName;)m=m.parentNode;try{h=m.querySelector("meta[itemprop=price]").content}catch(e){console.error("Price not found. Maybe the app is already installed or not officially available?"),h=0}e=m.parentNode;do{"C-WIZ"==e.tagName&&(p=e),e=e.parentNode}while("BODY"!=e.tagName)}else{document.getElementById("search-section").lastChild.remove();let e=document.getElementById("search-section"),t=document.createElement("SPAN");t.style="margin-top: 32px; float: left",t.textContent="or ",e.appendChild(t);let n=document.createElement("SPAN"),o=document.createElement("A");o.style="background-color: #FF8B14; font-weight: bold; text-decoration: none; padding: 1em; margin: 17px; float: left; color: white; cursor: pointer;",o.textContent="Search on APKMirror",o.className="rounded",o.id="apkMirrorBtn";let l="https://www.apkmirror.com/?post_type=app_release&searchtype=apk&s="+location.search.match(/id=(.*)/)[1].split("&",1);o.addEventListener("click",function(){window.open(l)}),n.appendChild(o),e.appendChild(n);let r=document.createElement("DIV");r.style="clear:both",e.appendChild(r),GM.xmlHttpRequest({method:"GET",url:"https://www.apkmirror.com/?post_type=app_release&searchtype=apk&s="+location.search.match(/id=(.*)/)[1].split("&",1),timeout:5e3,onload:function(e){if((new DOMParser).parseFromString(e.responseText,"text/html").getElementById("content").getElementsByClassName("appRow").length>0)o.textContent="Available on APKMirror";else{let e=o.cloneNode(!0);e.textContent="Not available on APKMirror",e.style.backgroundColor="#CCCCCC",e.style.cursor="not-allowed",o.parentNode.replaceChild(e,o)}}}),m=t,h=0}if(0==h){location.href.includes("details?id=")?n=location.search.match(/id=(.*)/)[1].split("&",1):location.href.includes("/store/search?q=")&&(n=m.querySelector('[data-item-id^="%.@."]').getAttribute("data-item-id").match(/%\.@\.".+"/)[0].replace('%.@."',"").replace('"',"")),o="https://d.apkpure.com/b/APK/"+n+"?version=latest",l="https://apps.evozi.com/apk-downloader/?id="+n,i="http://apkfind.com/store/download?id="+n,a="https://www.apkmirror.com/?post_type=app_release&searchtype=apk&s="+n,d="https://apkcombo.com/genericApp/"+n+"/download/apk",c="https://apkpremier.com/download/"+n.toString().replace(/[.]/g,"-"),u="https://web-api.aptoide.com/search?query="+n,f="https://apk.support/download-app/"+n,document.createDocumentFragment(),t=m.parentNode;let e=document.createElement("button");e.className="ddlButton",e.textContent="Download â–¼",e.style.backgroundColor="#F55",e.style.borderRadius="8px";let s=document.createElement("div");s.id="buttonDropdown",s.style.position="absolute",s.style.display="none",s.style.marginTop="5px",s.className="dropdown",s.appendChild(r("APK-DL",i,"#009688",n,!0,!1)),s.appendChild(r("APKPure",o,"#24cd77",n,!0,!1)),s.appendChild(r("APKCombo",d,"#00875f",n,!0,!0)),s.appendChild(r("APKPremier",c,"#3740ff",n,!0,!1)),s.appendChild(r("Evozi",l,"#286090",n,!1,!1)),s.appendChild(r("APKMirror",a,"#FF8B14",n,!1,!1)),s.appendChild(r("Aptoide",u,"#fe6446",n,!0,!1)),s.appendChild(r("APKSupport",f,"#3740ff",n,!0,!0)),e.onclick=function(){s.style.display="block"===s.style.display?"none":"block"},document.body.addEventListener("click",function(t){console.log(t.target.closest("#buttonDropdown")),t.target.closest("#buttonDropdown")||t.target===e||(s.style.display="none")}),t.appendChild(e),t.appendChild(s)}}function r(e,t,n,o,l,r){let s=document.createElement("button");if(s.className="ddlButton",s.style.backgroundColor=n,!l||r){let n=document.createElement("A");n.href=t,n.textContent=e,s.appendChild(n)}else{let t=document.createElement("SPAN");t.textContent=e,s.appendChild(t)}return s.onclick=l?function(){return function(e,t,n){var o;if(e.firstChild.textContent="Loading...",t.includes("apkfind"))try{GM.xmlHttpRequest({method:"GET",url:t,onload:function(t){var n,o;if(console.log(t),t.finalUrl.includes("/captcha?"))e.addEventListener("click",function(){window.open(t.finalUrl)}),e.firstChild.textContent="CAPTCHA",e.onclick=null;else if(t.finalUrl.includes("app/removed"))d(e,"Removed!");else try{n=(new DOMParser).parseFromString(t.response,"text/html"),o="http:"+n.getElementsByClassName("mdl-button")[0].getAttribute("href"),e.firstChild.textContent="Ready!",i(o),e.onclick=function(){i(o)}}catch(t){d(e,"Failed!"),console.log(t)}},onerror:function(){d(e,"Offline!")}})}catch(t){d(e,"Failed!"),console.log(t)}else if(t.includes("apkpure")){if(-1==a(t,e,0))try{GM.xmlHttpRequest({method:"GET",url:t,onload:function(n){switch(n.status){case 410:d(e,"Removed!");break;case 404:d(e,"Not found!");break;default:var o=n.responseText.substr(n.responseText.indexOf("https://download.apkpure.com/b/"),n.responseText.length-1);o=o.substr(0,o.indexOf('"')),console.log(t),e.firstChild.textContent="Wait...",a(o,e,0)}},onerror:function(){d(e,"Offline!")}})}catch(t){d(e,"Failed!"),console.log(t)}}else if(t.includes("apkcombo"))try{GM.xmlHttpRequest({method:"POST",url:"https://apkcombo.com/checkin",headers:{Referer:t,Origin:"https://apkcombo.com"},onload:function(n){o=n.responseText,GM.xmlHttpRequest({method:"GET",url:t,onload:function(n){var l,r,i,a,s,c,p;switch(n.status){case 410:d(e,"Removed!");break;case 404:d(e,"Not found!");break;default:try{if(r=(new DOMParser).parseFromString(n.responseText,"text/html"),void 0!==(i=r.getElementsByClassName("file-list")[0])){for(a=i.getElementsByTagName("a"),l=0;l<a.length;l++){let t=a[l].getAttribute("href");if(t.startsWith("/r2?u="))try{window.open(decodeURIComponent(t).split("?u=")[1])}catch(t){console.log(t),d(e,"Error!")}else window.open(t+"&"+o)}e.firstChild.textContent="APKCombo"}else s=n.responseText.indexOf("/dl?token=")+4,c=n.responseText.indexOf('"',s),p=n.responseText.substring(s,c),t=n.finalUrl,GM.xmlHttpRequest({method:"POST",url:t.replace("/download/apk","/dl")+"?"+p,onload:function(n){var r,a=(new DOMParser).parseFromString(n.responseText,"text/html");if(null!==(i=a.getElementsByClassName("file-list")[0])){for(r=i.getElementsByTagName("a"),l=0;l<r.length;l++)window.open(r[l].getAttribute("href")+"&"+o);e.firstChild.textContent="APKCombo"}else e.addEventListener("click",function(){window.open(t)}),e.firstChild.textContent="New tab >",e.onclick=null},onerror:function(){d(e,"Error!")}})}catch(e){console.log(e)}}},onerror:function(){d(e,"Offline!")}})}})}catch(t){d(e,"Failed!"),console.log(t)}else if(t.includes("apkpremier"))try{GM.xmlHttpRequest({method:"POST",url:t,data:"cmd=apk&gc=0",headers:{"Content-Type":"application/x-www-form-urlencoded"},onload:function(n){switch(n.status){case 410:d(e,"Removed!");break;case 404:d(e,"Not found!");break;default:let o=(new DOMParser).parseFromString(n.responseText,"text/html").getElementsByClassName("bdlinks");if("error capchar"==n.responseText)e.addEventListener("click",function(){window.open(t)}),e.firstChild.textContent="CAPTCHA",e.onclick=null;else if(o.length>0){for(let e of o)window.open(e.firstElementChild.getAttribute("href"),"_self");e.firstChild.textContent="Ready!"}else e.firstChild.textContent="Failed!"}},onerror:function(){d(e,"Offline!")}})}catch(t){d(e,"Failed!"),console.log(t)}else if(t.includes("aptoide"))try{GM.xmlHttpRequest({method:"GET",url:t,headers:{"Content-Type":"application/x-www-form-urlencoded"},onload:function(n){switch(n.status){case 410:d(e,"Removed!");break;case 404:d(e,"Not found!");break;default:let o=JSON.parse(n.responseXML);if(o.datalist.total>0){let n=t.split("?query=")[1];for(let t of o.datalist.list)if(t.package===n){if(t.aab)for(let e of t.aab.splits)window.open(e.path);t.obb&&window.open(t.obb.main.path),i(o.datalist.list[0].file.path),e.firstChild.textContent="Ready!"}"Ready!"!=e.firstChild.textContent&&d(e,"Not found!")}else e.firstChild.textContent="Failed!"}},onerror:function(){d(e,"Offline!")}})}catch(t){d(e,"Failed!"),console.log(t)}else if(t.includes("apk.support"))try{GM.xmlHttpRequest({method:"POST",url:t,data:"cmd=csapk&pkg="+n+"&arch=default&tbi=default&device_id=&model=default&language=en&dpi=480&av=default",headers:{Referer:t,Origin:"https://apk.support","Content-Type":"application/x-www-form-urlencoded"},onload:function(t){if(t.responseXML){let n=t.responseXML.querySelectorAll("[href*='.androidcontents.com/']");if(0==n.length&&(n=t.responseXML.querySelectorAll("[href*='.googleapis.com/download/']")),n.length>0){e.firstChild.textContent="Ready!";for(let e of n)window.open(e)}else d(e,"Not found!")}},onerror:function(){d(e,"Error!")}})}catch(e){console.log(e)}}(this,t,o),!1}:function(){return window.open(t),!1},s}function i(e){window.open(e.replace("http://","https://"),"_self")}function a(e,t,n){return""!=e?(u[n]=0,GM.xmlHttpRequest({method:"GET",url:e,timeout:5e3,ontimeout:function(){0==u[n]?t.firstChild.textContent="Retry":u[n]=0},onprogress:function(o){(o.finalUrl.includes("winudf.com")||o.finalUrl.includes("down-apk.com")||o.finalUrl.includes("/play-apps-download-default/"))&&0==u[n]&&(console.log("downloading file n."+n),u[n]=1,e.includes("apkpure")||e.includes("apkpremier")?(window.open(o.finalUrl,"_self"),t.onclick=function(){i(o.finalUrl)},t.firstChild.textContent="Ready!"):(window.open(o.finalUrl,n),t.firstChild.textContent="APKCombo"))},onload:function(){0==u[n]?t.firstChild.textContent="Retry":u[n]=0},onerror:function(){d(t,"Offline!")}}),0):(d(t,"Failed!"),-1)}function d(e,t){e.firstChild.textContent=t,e.style.backgroundColor="#CCCCCC",e.onclick=null}var s,c,p,u=[0];!async function(){await GM.getValue("useGS",!1),function(){var t;if(!0===document.location.href.includes("apkfind"))setInterval(e,100);else try{window.location.href.toString(),s=function(){var e=0;try{e=document.getElementsByTagName("header").length>0?5:0}catch(e){console.error('The user interface of Google Play Store was not recognized by "Direct Download from Google Play" script. This might result in unexpected behaviour of the page. Please report the error to the author on Greasyfork. Error: '+e)}return console.log("PLAY STORE INTERFACE: "+e),e}(),c=location.href,s>0&&(document.getElementById("main-title").innerHTML,(t=document.createElement("style")).textContent='.ddlButton: visited {\n                          color: white;\n                      }\n                      .ddlButton: hover {\n                          opacity: 0.8;\n                      }\n                      .ddlButton: active {\n                          opacity: 0.6;\n                      }\n                      .ddlButton {\n                          font-family: "Google Sans",Roboto,Arial,sans-serif;\n                          font-size: 1rem;\n                          font-weight: 500;\n                          padding: 0 10px;\n                          color: white;\n                          position: relative;\n                          z-index: 0;\n                          width: 100px;\n                          cursor: pointer;\n                      }\n                      .ddlButton>a {\n                          color: white;\n                      }\n                      .dropdown {\n                          background-color:  #fff;\n                          width: min-content;\n                          border-radius: 8px;\n                          box-shadow: 0 5px 20px rgba(0, 0, 0, 0.7);\n                          padding: 8px;\n                          z-index: 1000;\n                      }\n                      #buttonDropdown > .ddlButton:first-child{\n                          border-radius: 8px 8px 0 0;\n                      }\n                      #buttonDropdown > .ddlButton:last-child{\n                          border-radius: 0 0 8px 8px;\n                      }',document.body.appendChild(t)),(c.includes("details?id=")||c.includes("/store/search?q="))&&l(),setInterval(n,2e3)}catch(e){console.log("main(): "+e)}}()}();